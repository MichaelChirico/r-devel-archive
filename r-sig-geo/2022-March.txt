From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Thu Mar  3 09:43:51 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Thu, 3 Mar 2022 09:43:51 +0100
Subject: [R-sig-Geo] Mixing points and sf objects
Message-ID: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>

Dear listers,

Just for curiosity, using one sf object (depts) and one classical 
data.frame with two columns bearing coordinates, I wonder why this 
sequence works (points and department limits are correctly drawn):

plot(chbrut[,5:6],asp=1)
plot(st_geometry(depts),add=TRUE)

.. but not this one (points of chbrut are not projected - or projected 
somewhere else, and are not visible on the map)

plot(st_geometry(depts),reset=FALSE)
points(chbrut[,5:6],pch=19,col=cols)

Best,

Patrick

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Mar  3 10:32:11 2022
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 3 Mar 2022 10:32:11 +0100 (CET)
Subject: [R-sig-Geo] Mixing points and sf objects
In-Reply-To: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
Message-ID: <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>

On Thu, 3 Mar 2022, Patrick Giraudoux wrote:

> Dear listers,
>
> Just for curiosity, using one sf object (depts) and one classical
> data.frame with two columns bearing coordinates, I wonder why this
> sequence works (points and department limits are correctly drawn):
>
> plot(chbrut[,5:6],asp=1)
> plot(st_geometry(depts),add=TRUE)
>
> .. but not this one (points of chbrut are not projected - or projected
> somewhere else, and are not visible on the map)
>
> plot(st_geometry(depts),reset=FALSE)
> points(chbrut[,5:6],pch=19,col=cols)

Sorry, cannot reproduce:

library(sf)
nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
nc_xy <- st_transform(nc, "EPSG:32019")
set.seed(1)
pts <- as.data.frame(st_coordinates(st_sample(nc_xy, 100)))

plot(pts, asp=1)
plot(st_geometry(nc_xy), add=TRUE)

and

plot(st_geometry(nc_xy))
points(pts)

seem the same. reset= is irrelevant if the plot method for sfc objects is 
used, I think it applies to sf objects only, when multiple maps may be 
displayed with keys.

Hope this helps,

Roger


>
> Best,
>
> Patrick
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C5d59728741d046dc88ab08d9fcf204c5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637818938783874996%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=KxQmoTdwqh0IhlHnHeXmtX0DTIf2kGceX2INux47%2FHM%3D&amp;reserved=0
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Thu Mar  3 11:47:12 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Thu, 3 Mar 2022 11:47:12 +0100
Subject: [R-sig-Geo] Mixing points and sf objects
In-Reply-To: <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
Message-ID: <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>

After some trials off list with Roger, it appears that the underlying 
problem was that chbrut[,5:6] are character columns, which need to be 
converted to numeric first.
Ashes on my head, a looked for complicated things where the issue was at 
hand for a R early beginner...
Sorry to have polluted the list with such a trivial issue...


Le 03/03/2022 ? 10:32, Roger Bivand a ?crit?:
> On Thu, 3 Mar 2022, Patrick Giraudoux wrote:
>
>> Dear listers,
>>
>> Just for curiosity, using one sf object (depts) and one classical
>> data.frame with two columns bearing coordinates, I wonder why this
>> sequence works (points and department limits are correctly drawn):
>>
>> plot(chbrut[,5:6],asp=1)
>> plot(st_geometry(depts),add=TRUE)
>>
>> .. but not this one (points of chbrut are not projected - or projected
>> somewhere else, and are not visible on the map)
>>
>> plot(st_geometry(depts),reset=FALSE)
>> points(chbrut[,5:6],pch=19,col=cols)
>
> Sorry, cannot reproduce:
>
> library(sf)
> nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
> nc_xy <- st_transform(nc, "EPSG:32019")
> set.seed(1)
> pts <- as.data.frame(st_coordinates(st_sample(nc_xy, 100)))
>
> plot(pts, asp=1)
> plot(st_geometry(nc_xy), add=TRUE)
>
> and
>
> plot(st_geometry(nc_xy))
> points(pts)
>
> seem the same. reset= is irrelevant if the plot method for sfc objects 
> is used, I think it applies to sf objects only, when multiple maps may 
> be displayed with keys.
>
> Hope this helps,
>
> Roger
>
>
>>
>> Best,
>>
>> Patrick
>>
>> ????[[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C5d59728741d046dc88ab08d9fcf204c5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637818938783874996%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=KxQmoTdwqh0IhlHnHeXmtX0DTIf2kGceX2INux47%2FHM%3D&amp;reserved=0 
>>
>>
>

	[[alternative HTML version deleted]]


From Lo|c@DUTRIEUX @end|ng |rom ec@europ@@eu  Thu Mar  3 17:47:41 2022
From: Lo|c@DUTRIEUX @end|ng |rom ec@europ@@eu (DUTRIEUX Loic)
Date: Thu, 3 Mar 2022 16:47:41 +0000
Subject: [R-sig-Geo] Error reading spatialite table with sf::st_read
Message-ID: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>

Hi everyone,

When trying to read data contained in a sqlite table with the full spatialite options (see what FORMAT=SPATIALITE implies here --> https://gdal.org/drivers/vector/sqlite.html), I get a 
wkbType: 30078980 Error in inherits(sfc, "try-error") : object 'sfc' not found.

See the example below:

# In bash
ogr2ogr -F SQLITE -dsco SPATIALITE=YES /tmp/olinda1.sqlite ~/R/x86_64-pc-linux-gnu-library/4.0/sf/shape/olinda1.shp

# In R
library(sf)
library(DBI)

con <- dbConnect(RSQLite::SQLite(), '/tmp/olinda1.sqlite')
st_read(con, query='select * from olinda1;')


If I create the database without the SPATIALITE=YES creation option (geometries encoded as WKB), reading with sf partly works (no CRS) but then I lose the spatialite functionalities. Any suggestion?

Kind regards,
Lo?c


From b@row||ng@on @end|ng |rom gm@||@com  Thu Mar  3 19:19:53 2022
From: b@row||ng@on @end|ng |rom gm@||@com (Barry Rowlingson)
Date: Thu, 3 Mar 2022 18:19:53 +0000
Subject: [R-sig-Geo] Error reading spatialite table with sf::st_read
In-Reply-To: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>
References: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>
Message-ID: <CANVKczNnEs0KyU2nkYJh79maxpTo+0ko+nhCwti+FQ3GMVYCKw@mail.gmail.com>

Looks like that error might be generated about here:
https://github.com/r-spatial/sf/blob/5dde39c8261dc6b202e6cde9d41ad3bf0f46aa3a/R/db.R#L134

where the code does:

try(sfc <- st_as_sfc(tbl[[i]]), silent = TRUE)
if (!inherits(sfc, "try-error")) {
tbl[[i]] = sfc
success = TRUE
}

If the first "try" fails then `sfc` doesn't get created and so the error
happens on `if(!inherits(sfc,....)`.

The code is looping over columns trying to find a valid geometry column,
but not trapping this error properly. A bug, I think. Feel free to report
as an issue.

However I don't think that gets us out of the woods - that code only talks
about PostGIS databases, but it gets called for any object of class
DBIObject, which your SQLite connection object is:

 > inherits(con,"DBIObject")
 [1] TRUE

Perhaps that method should be something like st_read.PGConnection if it
only works on PostGIS databases? Experimenting with bits of that function
don't get me the geometry from my test spatialite DB anyway, and I think
its due to it being PostGIS-specific. I kept getting empty geometries.

But why not read the Spatialite directly without going through DBI?  Here's
a test I made of some points:

> d = st_read("/tmp/olinda1.sqlite","pts")
Reading layer `pts' from data source `/tmp/olinda1.sqlite' using driver
`SQLite'
Simple feature collection with 1000 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 234250 ymin: -198750 xmax: 909750 ymax: 502750
CRS:           unknown

THe CRS is printed as unknown but the WKT is there. Maybe this is a funny
CRS I was using for testing or something:

> st_crs(d)
Coordinate Reference System:
  User input: unknown
  wkt:
PROJCRS["unknown",
    BASEGEOGCRS["GCS_unknown",
        DATUM["D_Unknown_based_on_Australian_Natl_S_Amer_1969_ellipsoid",
            ELLIPSOID["Australian_Natl_S_Amer_1969",6378160,298.25,
                LENGTHUNIT["metre",1,

and you can add SQL queries to `st_read` if that;s part of your motivation
for using a spatial file database:

> d = st_read("/tmp/olinda1_no.sqlite", query="select * from pts where
pampa_srtm>300")
Reading query `select * from pts where pampa_srtm>300' from data source
`/tmp/olinda1_no.sqlite' using driver `SQLite'
Simple feature collection with 189 features and 1 field

Barry

On Thu, Mar 3, 2022 at 4:48 PM DUTRIEUX Loic <Loic.DUTRIEUX at ec.europa.eu>
wrote:

> Hi everyone,
>
> When trying to read data contained in a sqlite table with the full
> spatialite options (see what FORMAT=SPATIALITE implies here -->
> https://gdal.org/drivers/vector/sqlite.html), I get a
> wkbType: 30078980 Error in inherits(sfc, "try-error") : object 'sfc' not
> found.
>
> See the example below:
>
> # In bash
> ogr2ogr -F SQLITE -dsco SPATIALITE=YES /tmp/olinda1.sqlite
> ~/R/x86_64-pc-linux-gnu-library/4.0/sf/shape/olinda1.shp
>
> # In R
> library(sf)
> library(DBI)
>
> con <- dbConnect(RSQLite::SQLite(), '/tmp/olinda1.sqlite')
> st_read(con, query='select * from olinda1;')
>
>
> If I create the database without the SPATIALITE=YES creation option
> (geometries encoded as WKB), reading with sf partly works (no CRS) but then
> I lose the spatialite functionalities. Any suggestion?
>
> Kind regards,
> Lo?c
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Fri Mar  4 12:36:03 2022
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Fri, 4 Mar 2022 12:36:03 +0100
Subject: [R-sig-Geo] Error reading spatialite table with sf::st_read
In-Reply-To: <CANVKczNnEs0KyU2nkYJh79maxpTo+0ko+nhCwti+FQ3GMVYCKw@mail.gmail.com>
References: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>
 <CANVKczNnEs0KyU2nkYJh79maxpTo+0ko+nhCwti+FQ3GMVYCKw@mail.gmail.com>
Message-ID: <069dc9d7-02f2-f0e2-897f-ea9b2fff71e7@uni-muenster.de>

Loic,

I agree with Barry that there is a (logic) bug there, leading to a 
confusing error message. The problem seems the DBI driver failing to 
interpret a binary column ("blob") as wkb, which is needed when taking 
this path:


 > tb = dbReadTable(con, "olinda1")
 > head(tb)
   ogc_fid    id      cd_geocodi   tipo   cd_geocodb    nm_bair v014 
GEOMETRY
1       1 28801 260960005000001 URBANO 260960005020 Ouro Preto 1119 
blob[484 B]
2       2 28802 260960005000002 URBANO 260960005020 Ouro Preto 1267 
blob[532 B]
3       3 28803 260960005000003 URBANO 260960005020 Ouro Preto  557 
blob[276 B]
4       4 28804 260960005000004 URBANO 260960005020 Ouro Preto  709 
blob[468 B]
5       5 28805 260960005000005 URBANO 260960005020 Ouro Preto 1045 
blob[452 B]
6       6 28806 260960005000006 URBANO 260960005020 Ouro Preto  727 
blob[388 B]
 > st_as_sfc(tb$GEOMETRY)
wkbType: 30078980
Error in CPL_read_wkb(x, EWKB, spatialite) :
   unsupported wkbType dim in switch

so there seems to be something special with spatialite's WKB, which is 
not recognized by sf's WKB reader. Reading ?st_as_sfc:

 > st_as_sfc(tb$GEOMETRY, spatialite = TRUE)
Geometry set for 470 features
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -34.91692 ymin: -8.044467 xmax: -34.82779 ymax: 
-7.954672
CRS:           NA
First 5 geometries:
POLYGON ((-34.86406 -7.992488, -34.86397 -7.992...
POLYGON ((-34.86129 -7.989947, -34.86087 -7.989...
POLYGON ((-34.85856 -7.992407, -34.85899 -7.992...
POLYGON ((-34.85752 -7.994827, -34.85722 -7.994...
POLYGON ((-34.8582 -7.997543, -34.858 -7.996937...
Warning message:
In CPL_crs_from_input(x) :
   GDAL Error 1: PROJ: proj_create_from_database: crs not found

This can no doubt be made more automatic (e.g. by adding a spatialite 
argument to st_read.DBIObject), but the the question remains why, when

x = st_read('/tmp/olinda1.sqlite')

works OK, that couldn't be used instead?

Many regards,


On 03/03/2022 19:19, Barry Rowlingson wrote:
> Looks like that error might be generated about here:
> https://github.com/r-spatial/sf/blob/5dde39c8261dc6b202e6cde9d41ad3bf0f46aa3a/R/db.R#L134
> 
> where the code does:
> 
> try(sfc <- st_as_sfc(tbl[[i]]), silent = TRUE)
> if (!inherits(sfc, "try-error")) {
> tbl[[i]] = sfc
> success = TRUE
> }
> 
> If the first "try" fails then `sfc` doesn't get created and so the error
> happens on `if(!inherits(sfc,....)`.
> 
> The code is looping over columns trying to find a valid geometry column,
> but not trapping this error properly. A bug, I think. Feel free to report
> as an issue.
> 
> However I don't think that gets us out of the woods - that code only talks
> about PostGIS databases, but it gets called for any object of class
> DBIObject, which your SQLite connection object is:
> 
>   > inherits(con,"DBIObject")
>   [1] TRUE
> 
> Perhaps that method should be something like st_read.PGConnection if it
> only works on PostGIS databases? Experimenting with bits of that function
> don't get me the geometry from my test spatialite DB anyway, and I think
> its due to it being PostGIS-specific. I kept getting empty geometries.
> 
> But why not read the Spatialite directly without going through DBI?  Here's
> a test I made of some points:
> 
>> d = st_read("/tmp/olinda1.sqlite","pts")
> Reading layer `pts' from data source `/tmp/olinda1.sqlite' using driver
> `SQLite'
> Simple feature collection with 1000 features and 1 field
> Geometry type: POINT
> Dimension:     XY
> Bounding box:  xmin: 234250 ymin: -198750 xmax: 909750 ymax: 502750
> CRS:           unknown
> 
> THe CRS is printed as unknown but the WKT is there. Maybe this is a funny
> CRS I was using for testing or something:
> 
>> st_crs(d)
> Coordinate Reference System:
>    User input: unknown
>    wkt:
> PROJCRS["unknown",
>      BASEGEOGCRS["GCS_unknown",
>          DATUM["D_Unknown_based_on_Australian_Natl_S_Amer_1969_ellipsoid",
>              ELLIPSOID["Australian_Natl_S_Amer_1969",6378160,298.25,
>                  LENGTHUNIT["metre",1,
> 
> and you can add SQL queries to `st_read` if that;s part of your motivation
> for using a spatial file database:
> 
>> d = st_read("/tmp/olinda1_no.sqlite", query="select * from pts where
> pampa_srtm>300")
> Reading query `select * from pts where pampa_srtm>300' from data source
> `/tmp/olinda1_no.sqlite' using driver `SQLite'
> Simple feature collection with 189 features and 1 field
> 
> Barry
> 
> On Thu, Mar 3, 2022 at 4:48 PM DUTRIEUX Loic <Loic.DUTRIEUX at ec.europa.eu>
> wrote:
> 
>> Hi everyone,
>>
>> When trying to read data contained in a sqlite table with the full
>> spatialite options (see what FORMAT=SPATIALITE implies here -->
>> https://gdal.org/drivers/vector/sqlite.html), I get a
>> wkbType: 30078980 Error in inherits(sfc, "try-error") : object 'sfc' not
>> found.
>>
>> See the example below:
>>
>> # In bash
>> ogr2ogr -F SQLITE -dsco SPATIALITE=YES /tmp/olinda1.sqlite
>> ~/R/x86_64-pc-linux-gnu-library/4.0/sf/shape/olinda1.shp
>>
>> # In R
>> library(sf)
>> library(DBI)
>>
>> con <- dbConnect(RSQLite::SQLite(), '/tmp/olinda1.sqlite')
>> st_read(con, query='select * from olinda1;')
>>
>>
>> If I create the database without the SPATIALITE=YES creation option
>> (geometries encoded as WKB), reading with sf partly works (no CRS) but then
>> I lose the spatialite functionalities. Any suggestion?
>>
>> Kind regards,
>> Lo?c
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
> 
> 	[[alternative HTML version deleted]]
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081


From Lo|c@DUTRIEUX @end|ng |rom ec@europ@@eu  Fri Mar  4 13:13:50 2022
From: Lo|c@DUTRIEUX @end|ng |rom ec@europ@@eu (DUTRIEUX Loic)
Date: Fri, 4 Mar 2022 12:13:50 +0000
Subject: [R-sig-Geo] Error reading spatialite table with sf::st_read
In-Reply-To: <069dc9d7-02f2-f0e2-897f-ea9b2fff71e7@uni-muenster.de>
References: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>
 <CANVKczNnEs0KyU2nkYJh79maxpTo+0ko+nhCwti+FQ3GMVYCKw@mail.gmail.com>,
 <069dc9d7-02f2-f0e2-897f-ea9b2fff71e7@uni-muenster.de>
Message-ID: <dd6ed4c4c7e045478fd0a0d40bd911ee@ec.europa.eu>

Thanks Edzer and Barry, this helps a lot.
For some reason I wrongly assumed that dsn= had to be a database connection for the query= argument to be valid.

The route st_read('/tmp/olinda1.sqlite', query=...) works perfectly fine, also for more complex query involving joins and multiple tables, therefore I will use that.
Happy to help if you consider that these features (reading spatialite via database connection, recognizing/parsing spatialite binary format, ...) deserves some attention.

Kind regards,
Lo?c
________________________________________
From: R-sig-Geo <r-sig-geo-bounces at r-project.org> on behalf of Edzer Pebesma <edzer.pebesma at uni-muenster.de>
Sent: 04 March 2022 12:36
To: r-sig-geo at r-project.org
Subject: Re: [R-sig-Geo] Error reading spatialite table with sf::st_read

Loic,

I agree with Barry that there is a (logic) bug there, leading to a
confusing error message. The problem seems the DBI driver failing to
interpret a binary column ("blob") as wkb, which is needed when taking
this path:


 > tb = dbReadTable(con, "olinda1")
 > head(tb)
   ogc_fid    id      cd_geocodi   tipo   cd_geocodb    nm_bair v014
GEOMETRY
1       1 28801 260960005000001 URBANO 260960005020 Ouro Preto 1119
blob[484 B]
2       2 28802 260960005000002 URBANO 260960005020 Ouro Preto 1267
blob[532 B]
3       3 28803 260960005000003 URBANO 260960005020 Ouro Preto  557
blob[276 B]
4       4 28804 260960005000004 URBANO 260960005020 Ouro Preto  709
blob[468 B]
5       5 28805 260960005000005 URBANO 260960005020 Ouro Preto 1045
blob[452 B]
6       6 28806 260960005000006 URBANO 260960005020 Ouro Preto  727
blob[388 B]
 > st_as_sfc(tb$GEOMETRY)
wkbType: 30078980
Error in CPL_read_wkb(x, EWKB, spatialite) :
   unsupported wkbType dim in switch

so there seems to be something special with spatialite's WKB, which is
not recognized by sf's WKB reader. Reading ?st_as_sfc:

 > st_as_sfc(tb$GEOMETRY, spatialite = TRUE)
Geometry set for 470 features
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -34.91692 ymin: -8.044467 xmax: -34.82779 ymax:
-7.954672
CRS:           NA
First 5 geometries:
POLYGON ((-34.86406 -7.992488, -34.86397 -7.992...
POLYGON ((-34.86129 -7.989947, -34.86087 -7.989...
POLYGON ((-34.85856 -7.992407, -34.85899 -7.992...
POLYGON ((-34.85752 -7.994827, -34.85722 -7.994...
POLYGON ((-34.8582 -7.997543, -34.858 -7.996937...
Warning message:
In CPL_crs_from_input(x) :
   GDAL Error 1: PROJ: proj_create_from_database: crs not found

This can no doubt be made more automatic (e.g. by adding a spatialite
argument to st_read.DBIObject), but the the question remains why, when

x = st_read('/tmp/olinda1.sqlite')

works OK, that couldn't be used instead?

Many regards,


On 03/03/2022 19:19, Barry Rowlingson wrote:
> Looks like that error might be generated about here:
> https://urldefense.com/v3/__https://github.com/r-spatial/sf/blob/5dde39c8261dc6b202e6cde9d41ad3bf0f46aa3a/R/db.R*L134__;Iw!!DOxrgLBm!UziVBf_G2dc6TzzBAph_Chp0X8oSDIkLNwS6KCdSNNZOOjj65vqiG_SRaxPztyFqCuKrKfQ$
>
> where the code does:
>
> try(sfc <- st_as_sfc(tbl[[i]]), silent = TRUE)
> if (!inherits(sfc, "try-error")) {
> tbl[[i]] = sfc
> success = TRUE
> }
>
> If the first "try" fails then `sfc` doesn't get created and so the error
> happens on `if(!inherits(sfc,....)`.
>
> The code is looping over columns trying to find a valid geometry column,
> but not trapping this error properly. A bug, I think. Feel free to report
> as an issue.
>
> However I don't think that gets us out of the woods - that code only talks
> about PostGIS databases, but it gets called for any object of class
> DBIObject, which your SQLite connection object is:
>
>   > inherits(con,"DBIObject")
>   [1] TRUE
>
> Perhaps that method should be something like st_read.PGConnection if it
> only works on PostGIS databases? Experimenting with bits of that function
> don't get me the geometry from my test spatialite DB anyway, and I think
> its due to it being PostGIS-specific. I kept getting empty geometries.
>
> But why not read the Spatialite directly without going through DBI?  Here's
> a test I made of some points:
>
>> d = st_read("/tmp/olinda1.sqlite","pts")
> Reading layer `pts' from data source `/tmp/olinda1.sqlite' using driver
> `SQLite'
> Simple feature collection with 1000 features and 1 field
> Geometry type: POINT
> Dimension:     XY
> Bounding box:  xmin: 234250 ymin: -198750 xmax: 909750 ymax: 502750
> CRS:           unknown
>
> THe CRS is printed as unknown but the WKT is there. Maybe this is a funny
> CRS I was using for testing or something:
>
>> st_crs(d)
> Coordinate Reference System:
>    User input: unknown
>    wkt:
> PROJCRS["unknown",
>      BASEGEOGCRS["GCS_unknown",
>          DATUM["D_Unknown_based_on_Australian_Natl_S_Amer_1969_ellipsoid",
>              ELLIPSOID["Australian_Natl_S_Amer_1969",6378160,298.25,
>                  LENGTHUNIT["metre",1,
>
> and you can add SQL queries to `st_read` if that;s part of your motivation
> for using a spatial file database:
>
>> d = st_read("/tmp/olinda1_no.sqlite", query="select * from pts where
> pampa_srtm>300")
> Reading query `select * from pts where pampa_srtm>300' from data source
> `/tmp/olinda1_no.sqlite' using driver `SQLite'
> Simple feature collection with 189 features and 1 field
>
> Barry
>
> On Thu, Mar 3, 2022 at 4:48 PM DUTRIEUX Loic <Loic.DUTRIEUX at ec.europa.eu>
> wrote:
>
>> Hi everyone,
>>
>> When trying to read data contained in a sqlite table with the full
>> spatialite options (see what FORMAT=SPATIALITE implies here -->
>> https://urldefense.com/v3/__https://gdal.org/drivers/vector/sqlite.html__;!!DOxrgLBm!UziVBf_G2dc6TzzBAph_Chp0X8oSDIkLNwS6KCdSNNZOOjj65vqiG_SRaxPztyFq1ixAQg8$ ), I get a
>> wkbType: 30078980 Error in inherits(sfc, "try-error") : object 'sfc' not
>> found.
>>
>> See the example below:
>>
>> # In bash
>> ogr2ogr -F SQLITE -dsco SPATIALITE=YES /tmp/olinda1.sqlite
>> ~/R/x86_64-pc-linux-gnu-library/4.0/sf/shape/olinda1.shp
>>
>> # In R
>> library(sf)
>> library(DBI)
>>
>> con <- dbConnect(RSQLite::SQLite(), '/tmp/olinda1.sqlite')
>> st_read(con, query='select * from olinda1;')
>>
>>
>> If I create the database without the SPATIALITE=YES creation option
>> (geometries encoded as WKB), reading with sf partly works (no CRS) but then
>> I lose the spatialite functionalities. Any suggestion?
>>
>> Kind regards,
>> Lo?c
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-sig-geo__;!!DOxrgLBm!UziVBf_G2dc6TzzBAph_Chp0X8oSDIkLNwS6KCdSNNZOOjj65vqiG_SRaxPztyFqp6XITJk$
>>
>
>       [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-sig-geo__;!!DOxrgLBm!UziVBf_G2dc6TzzBAph_Chp0X8oSDIkLNwS6KCdSNNZOOjj65vqiG_SRaxPztyFqp6XITJk$

--
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-sig-geo__;!!DOxrgLBm!UziVBf_G2dc6TzzBAph_Chp0X8oSDIkLNwS6KCdSNNZOOjj65vqiG_SRaxPztyFqp6XITJk$


From t@v|b@r @end|ng |rom gm@||@com  Sat Mar  5 16:29:46 2022
From: t@v|b@r @end|ng |rom gm@||@com (Micha Silver)
Date: Sat, 5 Mar 2022 17:29:46 +0200
Subject: [R-sig-Geo] Error reading spatialite table with sf::st_read
In-Reply-To: <069dc9d7-02f2-f0e2-897f-ea9b2fff71e7@uni-muenster.de>
References: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>
 <CANVKczNnEs0KyU2nkYJh79maxpTo+0ko+nhCwti+FQ3GMVYCKw@mail.gmail.com>
 <069dc9d7-02f2-f0e2-897f-ea9b2fff71e7@uni-muenster.de>
Message-ID: <4d6efa29-9a2d-34b1-ae47-4691d2cfffe7@gmail.com>


On 04/03/2022 13:36, Edzer Pebesma wrote:
> Loic,
>
> I agree with Barry that there is a (logic) bug there, leading to a 
> confusing error message. The problem seems the DBI driver failing to 
> interpret a binary column ("blob") as wkb, which is needed when taking 
> this path:
>
>
> > tb = dbReadTable(con, "olinda1")
> > head(tb)
> ? ogc_fid??? id????? cd_geocodi?? tipo?? cd_geocodb??? nm_bair v014 
> GEOMETRY
> 1?????? 1 28801 260960005000001 URBANO 260960005020 Ouro Preto 1119 
> blob[484 B]
> 2?????? 2 28802 260960005000002 URBANO 260960005020 Ouro Preto 1267 
> blob[532 B]
> 3?????? 3 28803 260960005000003 URBANO 260960005020 Ouro Preto 557 
> blob[276 B]
> 4?????? 4 28804 260960005000004 URBANO 260960005020 Ouro Preto 709 
> blob[468 B]
> 5?????? 5 28805 260960005000005 URBANO 260960005020 Ouro Preto 1045 
> blob[452 B]
> 6?????? 6 28806 260960005000006 URBANO 260960005020 Ouro Preto 727 
> blob[388 B]
> > st_as_sfc(tb$GEOMETRY)
> wkbType: 30078980
> Error in CPL_read_wkb(x, EWKB, spatialite) :
> ? unsupported wkbType dim in switch
>
> so there seems to be something special with spatialite's WKB, which is 
> not recognized by sf's WKB reader. Reading ?st_as_sfc:


I'm certainly no expert in WKB, but I did notice on the spatialite group 
list the following thread:

https://groups.google.com/g/spatialite-users/c/fJSlg6qGUfc

where Sandro explains that the spatialite "geom" column is NOT in 
standard WKB...


>
> > st_as_sfc(tb$GEOMETRY, spatialite = TRUE)
> Geometry set for 470 features
> Geometry type: POLYGON
> Dimension:???? XY
> Bounding box:? xmin: -34.91692 ymin: -8.044467 xmax: -34.82779 ymax: 
> -7.954672
> CRS:?????????? NA
> First 5 geometries:
> POLYGON ((-34.86406 -7.992488, -34.86397 -7.992...
> POLYGON ((-34.86129 -7.989947, -34.86087 -7.989...
> POLYGON ((-34.85856 -7.992407, -34.85899 -7.992...
> POLYGON ((-34.85752 -7.994827, -34.85722 -7.994...
> POLYGON ((-34.8582 -7.997543, -34.858 -7.996937...
> Warning message:
> In CPL_crs_from_input(x) :
> ? GDAL Error 1: PROJ: proj_create_from_database: crs not found
>
> This can no doubt be made more automatic (e.g. by adding a spatialite 
> argument to st_read.DBIObject), but the the question remains why, when
>
> x = st_read('/tmp/olinda1.sqlite')
>
> works OK, that couldn't be used instead?
>
> Many regards,
>
>
> On 03/03/2022 19:19, Barry Rowlingson wrote:
>> Looks like that error might be generated about here:
>> https://github.com/r-spatial/sf/blob/5dde39c8261dc6b202e6cde9d41ad3bf0f46aa3a/R/db.R#L134 
>>
>>
>> where the code does:
>>
>> try(sfc <- st_as_sfc(tbl[[i]]), silent = TRUE)
>> if (!inherits(sfc, "try-error")) {
>> tbl[[i]] = sfc
>> success = TRUE
>> }
>>
>> If the first "try" fails then `sfc` doesn't get created and so the error
>> happens on `if(!inherits(sfc,....)`.
>>
>> The code is looping over columns trying to find a valid geometry column,
>> but not trapping this error properly. A bug, I think. Feel free to 
>> report
>> as an issue.
>>
>> However I don't think that gets us out of the woods - that code only 
>> talks
>> about PostGIS databases, but it gets called for any object of class
>> DBIObject, which your SQLite connection object is:
>>
>> ? > inherits(con,"DBIObject")
>> ? [1] TRUE
>>
>> Perhaps that method should be something like st_read.PGConnection if it
>> only works on PostGIS databases? Experimenting with bits of that 
>> function
>> don't get me the geometry from my test spatialite DB anyway, and I think
>> its due to it being PostGIS-specific. I kept getting empty geometries.
>>
>> But why not read the Spatialite directly without going through DBI?? 
>> Here's
>> a test I made of some points:
>>
>>> d = st_read("/tmp/olinda1.sqlite","pts")
>> Reading layer `pts' from data source `/tmp/olinda1.sqlite' using driver
>> `SQLite'
>> Simple feature collection with 1000 features and 1 field
>> Geometry type: POINT
>> Dimension:???? XY
>> Bounding box:? xmin: 234250 ymin: -198750 xmax: 909750 ymax: 502750
>> CRS:?????????? unknown
>>
>> THe CRS is printed as unknown but the WKT is there. Maybe this is a 
>> funny
>> CRS I was using for testing or something:
>>
>>> st_crs(d)
>> Coordinate Reference System:
>> ?? User input: unknown
>> ?? wkt:
>> PROJCRS["unknown",
>> ???? BASEGEOGCRS["GCS_unknown",
>> DATUM["D_Unknown_based_on_Australian_Natl_S_Amer_1969_ellipsoid",
>> ELLIPSOID["Australian_Natl_S_Amer_1969",6378160,298.25,
>> ???????????????? LENGTHUNIT["metre",1,
>>
>> and you can add SQL queries to `st_read` if that;s part of your 
>> motivation
>> for using a spatial file database:
>>
>>> d = st_read("/tmp/olinda1_no.sqlite", query="select * from pts where
>> pampa_srtm>300")
>> Reading query `select * from pts where pampa_srtm>300' from data source
>> `/tmp/olinda1_no.sqlite' using driver `SQLite'
>> Simple feature collection with 189 features and 1 field
>>
>> Barry
>>
>> On Thu, Mar 3, 2022 at 4:48 PM DUTRIEUX Loic 
>> <Loic.DUTRIEUX at ec.europa.eu>
>> wrote:
>>
>>> Hi everyone,
>>>
>>> When trying to read data contained in a sqlite table with the full
>>> spatialite options (see what FORMAT=SPATIALITE implies here -->
>>> https://gdal.org/drivers/vector/sqlite.html), I get a
>>> wkbType: 30078980 Error in inherits(sfc, "try-error") : object 'sfc' 
>>> not
>>> found.
>>>
>>> See the example below:
>>>
>>> # In bash
>>> ogr2ogr -F SQLITE -dsco SPATIALITE=YES /tmp/olinda1.sqlite
>>> ~/R/x86_64-pc-linux-gnu-library/4.0/sf/shape/olinda1.shp
>>>
>>> # In R
>>> library(sf)
>>> library(DBI)
>>>
>>> con <- dbConnect(RSQLite::SQLite(), '/tmp/olinda1.sqlite')
>>> st_read(con, query='select * from olinda1;')
>>>
>>>
>>> If I create the database without the SPATIALITE=YES creation option
>>> (geometries encoded as WKB), reading with sf partly works (no CRS) 
>>> but then
>>> I lose the spatialite functionalities. Any suggestion?
>>>
>>> Kind regards,
>>> Lo?c
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>
>>
>> ????[[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
-- 
Micha Silver
Ben Gurion Univ.
Sde Boker, Remote Sensing Lab
cell: +972-523-665918


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Sat Mar  5 16:52:45 2022
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Sat, 5 Mar 2022 16:52:45 +0100
Subject: [R-sig-Geo] Error reading spatialite table with sf::st_read
In-Reply-To: <4d6efa29-9a2d-34b1-ae47-4691d2cfffe7@gmail.com>
References: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>
 <CANVKczNnEs0KyU2nkYJh79maxpTo+0ko+nhCwti+FQ3GMVYCKw@mail.gmail.com>
 <069dc9d7-02f2-f0e2-897f-ea9b2fff71e7@uni-muenster.de>
 <4d6efa29-9a2d-34b1-ae47-4691d2cfffe7@gmail.com>
Message-ID: <b673f159-d385-30d9-5314-797590ed69f9@uni-muenster.de>



On 05/03/2022 16:29, Micha Silver wrote:
> 
> On 04/03/2022 13:36, Edzer Pebesma wrote:
>> Loic,
>>
>> I agree with Barry that there is a (logic) bug there, leading to a 
>> confusing error message. The problem seems the DBI driver failing to 
>> interpret a binary column ("blob") as wkb, which is needed when taking 
>> this path:
>>
>>
>> > tb = dbReadTable(con, "olinda1")
>> > head(tb)
>> ? ogc_fid??? id????? cd_geocodi?? tipo?? cd_geocodb??? nm_bair v014 
>> GEOMETRY
>> 1?????? 1 28801 260960005000001 URBANO 260960005020 Ouro Preto 1119 
>> blob[484 B]
>> 2?????? 2 28802 260960005000002 URBANO 260960005020 Ouro Preto 1267 
>> blob[532 B]
>> 3?????? 3 28803 260960005000003 URBANO 260960005020 Ouro Preto 557 
>> blob[276 B]
>> 4?????? 4 28804 260960005000004 URBANO 260960005020 Ouro Preto 709 
>> blob[468 B]
>> 5?????? 5 28805 260960005000005 URBANO 260960005020 Ouro Preto 1045 
>> blob[452 B]
>> 6?????? 6 28806 260960005000006 URBANO 260960005020 Ouro Preto 727 
>> blob[388 B]
>> > st_as_sfc(tb$GEOMETRY)
>> wkbType: 30078980
>> Error in CPL_read_wkb(x, EWKB, spatialite) :
>> ? unsupported wkbType dim in switch
>>
>> so there seems to be something special with spatialite's WKB, which is 
>> not recognized by sf's WKB reader. Reading ?st_as_sfc:
> 
> 
> I'm certainly no expert in WKB, but I did notice on the spatialite group 
> list the following thread:
> 
> https://groups.google.com/g/spatialite-users/c/fJSlg6qGUfc
> 
> where Sandro explains that the spatialite "geom" column is NOT in 
> standard WKB...

thanks - that's what sf takes care of when setting spatialite = TRUE in 
st_as_sfc():

>>
>> > st_as_sfc(tb$GEOMETRY, spatialite = TRUE)
>> Geometry set for 470 features
>> Geometry type: POLYGON
>> Dimension:???? XY
>> Bounding box:? xmin: -34.91692 ymin: -8.044467 xmax: -34.82779 ymax: 
>> -7.954672
>> CRS:?????????? NA
>> First 5 geometries:
>> POLYGON ((-34.86406 -7.992488, -34.86397 -7.992...
>> POLYGON ((-34.86129 -7.989947, -34.86087 -7.989...
>> POLYGON ((-34.85856 -7.992407, -34.85899 -7.992...
>> POLYGON ((-34.85752 -7.994827, -34.85722 -7.994...
>> POLYGON ((-34.8582 -7.997543, -34.858 -7.996937...
>> Warning message:
>> In CPL_crs_from_input(x) :
>> ? GDAL Error 1: PROJ: proj_create_from_database: crs not found
>>
>> This can no doubt be made more automatic (e.g. by adding a spatialite 
>> argument to st_read.DBIObject), but the the question remains why, when
>>
>> x = st_read('/tmp/olinda1.sqlite')
>>
>> works OK, that couldn't be used instead?
>>
>> Many regards,
>>
>>
>> On 03/03/2022 19:19, Barry Rowlingson wrote:
>>> Looks like that error might be generated about here:
>>> https://github.com/r-spatial/sf/blob/5dde39c8261dc6b202e6cde9d41ad3bf0f46aa3a/R/db.R#L134 
>>>
>>>
>>> where the code does:
>>>
>>> try(sfc <- st_as_sfc(tbl[[i]]), silent = TRUE)
>>> if (!inherits(sfc, "try-error")) {
>>> tbl[[i]] = sfc
>>> success = TRUE
>>> }
>>>
>>> If the first "try" fails then `sfc` doesn't get created and so the error
>>> happens on `if(!inherits(sfc,....)`.
>>>
>>> The code is looping over columns trying to find a valid geometry column,
>>> but not trapping this error properly. A bug, I think. Feel free to 
>>> report
>>> as an issue.
>>>
>>> However I don't think that gets us out of the woods - that code only 
>>> talks
>>> about PostGIS databases, but it gets called for any object of class
>>> DBIObject, which your SQLite connection object is:
>>>
>>> ? > inherits(con,"DBIObject")
>>> ? [1] TRUE
>>>
>>> Perhaps that method should be something like st_read.PGConnection if it
>>> only works on PostGIS databases? Experimenting with bits of that 
>>> function
>>> don't get me the geometry from my test spatialite DB anyway, and I think
>>> its due to it being PostGIS-specific. I kept getting empty geometries.
>>>
>>> But why not read the Spatialite directly without going through DBI? 
>>> Here's
>>> a test I made of some points:
>>>
>>>> d = st_read("/tmp/olinda1.sqlite","pts")
>>> Reading layer `pts' from data source `/tmp/olinda1.sqlite' using driver
>>> `SQLite'
>>> Simple feature collection with 1000 features and 1 field
>>> Geometry type: POINT
>>> Dimension:???? XY
>>> Bounding box:? xmin: 234250 ymin: -198750 xmax: 909750 ymax: 502750
>>> CRS:?????????? unknown
>>>
>>> THe CRS is printed as unknown but the WKT is there. Maybe this is a 
>>> funny
>>> CRS I was using for testing or something:
>>>
>>>> st_crs(d)
>>> Coordinate Reference System:
>>> ?? User input: unknown
>>> ?? wkt:
>>> PROJCRS["unknown",
>>> ???? BASEGEOGCRS["GCS_unknown",
>>> DATUM["D_Unknown_based_on_Australian_Natl_S_Amer_1969_ellipsoid",
>>> ELLIPSOID["Australian_Natl_S_Amer_1969",6378160,298.25,
>>> ???????????????? LENGTHUNIT["metre",1,
>>>
>>> and you can add SQL queries to `st_read` if that;s part of your 
>>> motivation
>>> for using a spatial file database:
>>>
>>>> d = st_read("/tmp/olinda1_no.sqlite", query="select * from pts where
>>> pampa_srtm>300")
>>> Reading query `select * from pts where pampa_srtm>300' from data source
>>> `/tmp/olinda1_no.sqlite' using driver `SQLite'
>>> Simple feature collection with 189 features and 1 field
>>>
>>> Barry
>>>
>>> On Thu, Mar 3, 2022 at 4:48 PM DUTRIEUX Loic 
>>> <Loic.DUTRIEUX at ec.europa.eu>
>>> wrote:
>>>
>>>> Hi everyone,
>>>>
>>>> When trying to read data contained in a sqlite table with the full
>>>> spatialite options (see what FORMAT=SPATIALITE implies here -->
>>>> https://gdal.org/drivers/vector/sqlite.html), I get a
>>>> wkbType: 30078980 Error in inherits(sfc, "try-error") : object 'sfc' 
>>>> not
>>>> found.
>>>>
>>>> See the example below:
>>>>
>>>> # In bash
>>>> ogr2ogr -F SQLITE -dsco SPATIALITE=YES /tmp/olinda1.sqlite
>>>> ~/R/x86_64-pc-linux-gnu-library/4.0/sf/shape/olinda1.shp
>>>>
>>>> # In R
>>>> library(sf)
>>>> library(DBI)
>>>>
>>>> con <- dbConnect(RSQLite::SQLite(), '/tmp/olinda1.sqlite')
>>>> st_read(con, query='select * from olinda1;')
>>>>
>>>>
>>>> If I create the database without the SPATIALITE=YES creation option
>>>> (geometries encoded as WKB), reading with sf partly works (no CRS) 
>>>> but then
>>>> I lose the spatialite functionalities. Any suggestion?
>>>>
>>>> Kind regards,
>>>> Lo?c
>>>>
>>>> _______________________________________________
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org
>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>
>>>
>>> ????[[alternative HTML version deleted]]
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sat Mar  5 19:52:52 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sat, 5 Mar 2022 19:52:52 +0100
Subject: [R-sig-Geo] st_write and gpx file
In-Reply-To: <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
Message-ID: <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>

Dear listers,

I am making trials with the sf package trying to write point geometries 
into afile. Here is the sf object:

> walk  Simple feature collection with 2095 features and 2 fields Geometry 
type: POINT Dimension: XY Bounding box: xmin: 5.951268 ymin: 47.29238 
xmax: 5.974512 ymax: 47.3015 Geodetic CRS: WGS 84 First 10 features: 
track_seg_point_id ele geometry 1 0 243 POINT (5.95348 47.29709) 2 1 243 
POINT (5.953438 47.29704) 3 2 244 POINT (5.953219 47.29702) 4 3 243 
POINT (5.952884 47.29713) 5 4 243 POINT (5.952492 47.2972) 6 5 243 POINT 
(5.952335 47.29743) 7 6 242 POINT (5.951881 47.29732) 8 7 242 POINT 
(5.951495 47.29724) 9 8 293 POINT (5.951333 47.29719) 10 9 294 POINT 
(5.951388 47.29706)

Writing a shapefile as well as a kml is no problem:

st_write(walk,"walk.shp")

st_write(walk,"walk.kml")

But I cannot go through writing a gpx file, e.g.

> st_write(walk,dsn="walk.gpx",layer="track_points")  Error: Could not guess driver for walk.gpx

I have tried several other combinations all unsuccessful.

Have someone an idea about what goes wrong ?

Best,

Patrick





	[[alternative HTML version deleted]]


From d|cko@@hm@dou @end|ng |rom gm@||@com  Sat Mar  5 20:24:44 2022
From: d|cko@@hm@dou @end|ng |rom gm@||@com (Ahmadou Dicko)
Date: Sat, 5 Mar 2022 19:24:44 +0000
Subject: [R-sig-Geo] st_write and gpx file
In-Reply-To: <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
Message-ID: <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>

Hi Patrick,

You can add the driver manually.

st_write(walk, dsn = "walk.gpx", layer = "track_points", driver = "GPX")

Hope it helps,
Ahmadou


On Sat, Mar 5, 2022 at 6:53 PM Patrick Giraudoux <
patrick.giraudoux at univ-fcomte.fr> wrote:

> Dear listers,
>
> I am making trials with the sf package trying to write point geometries
> into afile. Here is the sf object:
>
> > walk  Simple feature collection with 2095 features and 2 fields Geometry
> type: POINT Dimension: XY Bounding box: xmin: 5.951268 ymin: 47.29238
> xmax: 5.974512 ymax: 47.3015 Geodetic CRS: WGS 84 First 10 features:
> track_seg_point_id ele geometry 1 0 243 POINT (5.95348 47.29709) 2 1 243
> POINT (5.953438 47.29704) 3 2 244 POINT (5.953219 47.29702) 4 3 243
> POINT (5.952884 47.29713) 5 4 243 POINT (5.952492 47.2972) 6 5 243 POINT
> (5.952335 47.29743) 7 6 242 POINT (5.951881 47.29732) 8 7 242 POINT
> (5.951495 47.29724) 9 8 293 POINT (5.951333 47.29719) 10 9 294 POINT
> (5.951388 47.29706)
>
> Writing a shapefile as well as a kml is no problem:
>
> st_write(walk,"walk.shp")
>
> st_write(walk,"walk.kml")
>
> But I cannot go through writing a gpx file, e.g.
>
> > st_write(walk,dsn="walk.gpx",layer="track_points")  Error: Could not
> guess driver for walk.gpx
>
> I have tried several other combinations all unsuccessful.
>
> Have someone an idea about what goes wrong ?
>
> Best,
>
> Patrick
>
>
>
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
Ahmadou H. DICKO, PhD

Statistical consultant
Mobile: (+221) 77 123 81 69
Skype: dicko.ahmadou.h
Twitter : @dickoah
Gitlab: gitlab/dickoa
Github: github/dickoa

	[[alternative HTML version deleted]]


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sat Mar  5 20:46:09 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sat, 05 Mar 2022 20:46:09 +0100
Subject: [R-sig-Geo] st_write and gpx file
In-Reply-To: <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
Message-ID: <20220305194609.96BCB4038FA4@ufcpriv204.univ-fcomte.fr>

I tried already... it did not work either ?Message envoy? de mon t?l?phone mobile. Merci d'excuser les ?ventuelles erreurs de frappe.
-------- Message d'origine --------De : Ahmadou Dicko <dicko.ahmadou at gmail.com> Date : 05/03/2022  20:24  (GMT+01:00) ? : Patrick Giraudoux <patrick.giraudoux at univ-fcomte.fr> Cc : r-sig-geo at r-project.org Objet : Re: [R-sig-Geo] st_write and gpx file Hi Patrick,You can add the driver manually.st_write(walk, dsn = "walk.gpx", layer = "track_points", driver = "GPX")Hope it helps,AhmadouOn Sat, Mar 5, 2022 at 6:53 PM Patrick Giraudoux <patrick.giraudoux at univ-fcomte.fr> wrote:Dear listers,

I am making trials with the sf package trying to write point geometries 
into afile. Here is the sf object:

> walk? Simple feature collection with 2095 features and 2 fields Geometry 
type: POINT Dimension: XY Bounding box: xmin: 5.951268 ymin: 47.29238 
xmax: 5.974512 ymax: 47.3015 Geodetic CRS: WGS 84 First 10 features: 
track_seg_point_id ele geometry 1 0 243 POINT (5.95348 47.29709) 2 1 243 
POINT (5.953438 47.29704) 3 2 244 POINT (5.953219 47.29702) 4 3 243 
POINT (5.952884 47.29713) 5 4 243 POINT (5.952492 47.2972) 6 5 243 POINT 
(5.952335 47.29743) 7 6 242 POINT (5.951881 47.29732) 8 7 242 POINT 
(5.951495 47.29724) 9 8 293 POINT (5.951333 47.29719) 10 9 294 POINT 
(5.951388 47.29706)

Writing a shapefile as well as a kml is no problem:

st_write(walk,"walk.shp")

st_write(walk,"walk.kml")

But I cannot go through writing a gpx file, e.g.

> st_write(walk,dsn="walk.gpx",layer="track_points")? Error: Could not guess driver for walk.gpx

I have tried several other combinations all unsuccessful.

Have someone an idea about what goes wrong ?

Best,

Patrick





? ? ? ? [[alternative HTML version deleted]]

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://stat.ethz.ch/mailman/listinfo/r-sig-geo
-- Ahmadou H. DICKO, PhDStatistical consultantMobile: (+221) 77 123 81 69Skype: dicko.ahmadou.hTwitter : @dickoahGitlab: gitlab/dickoaGithub: github/dickoa

	[[alternative HTML version deleted]]


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Mar  6 07:44:11 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 6 Mar 2022 07:44:11 +0100
Subject: [R-sig-Geo] st_write and gpx file
In-Reply-To: <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
Message-ID: <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>

I have made some additionnal trials, with the argument 'driver' 
explicit. It appears that the sf object 'walk' must compulsory have two 
fields names "track_fid" and "track_seg_id" respectively. Once created :

> walk  Simple feature collection with 2095 features and 3 fields Geometry 
type: POINT Dimension: XY Bounding box: xmin: 5.951268 ymin: 47.29238 
xmax: 5.974512 ymax: 47.3015 Geodetic CRS: WGS 84 First 10 features: 
track_fid ele geometry track_seg_id 1 1 243 POINT (5.95348 47.29709) 1 2 
1 243 POINT (5.953438 47.29704) 1 3 1 244 POINT (5.953219 47.29702) 1 4 
1 243 POINT (5.952884 47.29713) 1 5 1 243 POINT (5.952492 47.2972) 1 6 1 
243 POINT (5.952335 47.29743) 1 7 1 242 POINT (5.951881 47.29732) 1 8 1 
242 POINT (5.951495 47.29724) 1 9 1 293 POINT (5.951333 47.29719) 1 10 1 
294 POINT (5.951388 47.29706) 1


Then,

st_write(walk,dsn="walk.gpx",layer="track_points",driver="GPX")

is written with no error

However, st_write(walk,dsn="walk.gpx",layer="track_points") still gets 
'Error: Could not guess driver for walk.gpx'




Le 05/03/2022 ? 20:24, Ahmadou Dicko a ?crit?:
> Hi Patrick,
>
> You can add the driver manually.
>
> st_write(walk, dsn = "walk.gpx", layer = "track_points", driver = "GPX")
>
> Hope it helps,
> Ahmadou
>
>
> On Sat, Mar 5, 2022 at 6:53 PM Patrick Giraudoux 
> <patrick.giraudoux at univ-fcomte.fr> wrote:
>
>     Dear listers,
>
>     I am making trials with the sf package trying to write point
>     geometries
>     into afile. Here is the sf object:
>
>     > walk? Simple feature collection with 2095 features and 2 fields
>     Geometry
>     type: POINT Dimension: XY Bounding box: xmin: 5.951268 ymin: 47.29238
>     xmax: 5.974512 ymax: 47.3015 Geodetic CRS: WGS 84 First 10 features:
>     track_seg_point_id ele geometry 1 0 243 POINT (5.95348 47.29709) 2
>     1 243
>     POINT (5.953438 47.29704) 3 2 244 POINT (5.953219 47.29702) 4 3 243
>     POINT (5.952884 47.29713) 5 4 243 POINT (5.952492 47.2972) 6 5 243
>     POINT
>     (5.952335 47.29743) 7 6 242 POINT (5.951881 47.29732) 8 7 242 POINT
>     (5.951495 47.29724) 9 8 293 POINT (5.951333 47.29719) 10 9 294 POINT
>     (5.951388 47.29706)
>
>     Writing a shapefile as well as a kml is no problem:
>
>     st_write(walk,"walk.shp")
>
>     st_write(walk,"walk.kml")
>
>     But I cannot go through writing a gpx file, e.g.
>
>     > st_write(walk,dsn="walk.gpx",layer="track_points") Error: Could
>     not guess driver for walk.gpx
>
>     I have tried several other combinations all unsuccessful.
>
>     Have someone an idea about what goes wrong ?
>
>     Best,
>
>     Patrick
>
>
>
>
>
>     ? ? ? ? [[alternative HTML version deleted]]
>
>     _______________________________________________
>     R-sig-Geo mailing list
>     R-sig-Geo at r-project.org
>     https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
>
>
> -- 
> Ahmadou H. DICKO, PhD
>
> Statistical consultant
> Mobile: (+221) 77 123 81 69
> Skype: dicko.ahmadou.h
> Twitter : @dickoah
> Gitlab: gitlab/dickoa
> Github: github/dickoa


	[[alternative HTML version deleted]]


From d|cko@@hm@dou @end|ng |rom gm@||@com  Sun Mar  6 12:38:52 2022
From: d|cko@@hm@dou @end|ng |rom gm@||@com (Ahmadou Dicko)
Date: Sun, 6 Mar 2022 11:38:52 +0000
Subject: [R-sig-Geo] st_write and gpx file
In-Reply-To: <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
Message-ID: <CAP8THHWtrVrpPHfJD3ySzZDW-RnMGmRx8Ja5qRhJ-oPaV4GTZQ@mail.gmail.com>

I'm glad you found a solution, and indeed GPX need a track_fid and
track_seg_id for track points.
Regarding the driver issue, it's just because it was not added to the
list of extension automatically recognized by sf::st_write.
You can look at it here:
https://github.com/r-spatial/sf/blob/ddc79d0e9b7f7500a6d6020964b180cd4064bc83/R/read.R#L670-L695

You can raise an issue on the repository and make a case for it to be added.

Best,
Ahmadou


On Sun, Mar 6, 2022 at 6:44 AM Patrick Giraudoux <
patrick.giraudoux at univ-fcomte.fr> wrote:

> I have made some additionnal trials, with the argument 'driver'
> explicit. It appears that the sf object 'walk' must compulsory have two
> fields names "track_fid" and "track_seg_id" respectively. Once created :
>
> > walk  Simple feature collection with 2095 features and 3 fields Geometry
> type: POINT Dimension: XY Bounding box: xmin: 5.951268 ymin: 47.29238
> xmax: 5.974512 ymax: 47.3015 Geodetic CRS: WGS 84 First 10 features:
> track_fid ele geometry track_seg_id 1 1 243 POINT (5.95348 47.29709) 1 2
> 1 243 POINT (5.953438 47.29704) 1 3 1 244 POINT (5.953219 47.29702) 1 4
> 1 243 POINT (5.952884 47.29713) 1 5 1 243 POINT (5.952492 47.2972) 1 6 1
> 243 POINT (5.952335 47.29743) 1 7 1 242 POINT (5.951881 47.29732) 1 8 1
> 242 POINT (5.951495 47.29724) 1 9 1 293 POINT (5.951333 47.29719) 1 10 1
> 294 POINT (5.951388 47.29706) 1
>
>
> Then,
>
> st_write(walk,dsn="walk.gpx",layer="track_points",driver="GPX")
>
> is written with no error
>
> However, st_write(walk,dsn="walk.gpx",layer="track_points") still gets
> 'Error: Could not guess driver for walk.gpx'
>
>
>
>
> Le 05/03/2022 ? 20:24, Ahmadou Dicko a ?crit :
> > Hi Patrick,
> >
> > You can add the driver manually.
> >
> > st_write(walk, dsn = "walk.gpx", layer = "track_points", driver = "GPX")
> >
> > Hope it helps,
> > Ahmadou
> >
> >
> > On Sat, Mar 5, 2022 at 6:53 PM Patrick Giraudoux
> > <patrick.giraudoux at univ-fcomte.fr> wrote:
> >
> >     Dear listers,
> >
> >     I am making trials with the sf package trying to write point
> >     geometries
> >     into afile. Here is the sf object:
> >
> >     > walk  Simple feature collection with 2095 features and 2 fields
> >     Geometry
> >     type: POINT Dimension: XY Bounding box: xmin: 5.951268 ymin: 47.29238
> >     xmax: 5.974512 ymax: 47.3015 Geodetic CRS: WGS 84 First 10 features:
> >     track_seg_point_id ele geometry 1 0 243 POINT (5.95348 47.29709) 2
> >     1 243
> >     POINT (5.953438 47.29704) 3 2 244 POINT (5.953219 47.29702) 4 3 243
> >     POINT (5.952884 47.29713) 5 4 243 POINT (5.952492 47.2972) 6 5 243
> >     POINT
> >     (5.952335 47.29743) 7 6 242 POINT (5.951881 47.29732) 8 7 242 POINT
> >     (5.951495 47.29724) 9 8 293 POINT (5.951333 47.29719) 10 9 294 POINT
> >     (5.951388 47.29706)
> >
> >     Writing a shapefile as well as a kml is no problem:
> >
> >     st_write(walk,"walk.shp")
> >
> >     st_write(walk,"walk.kml")
> >
> >     But I cannot go through writing a gpx file, e.g.
> >
> >     > st_write(walk,dsn="walk.gpx",layer="track_points") Error: Could
> >     not guess driver for walk.gpx
> >
> >     I have tried several other combinations all unsuccessful.
> >
> >     Have someone an idea about what goes wrong ?
> >
> >     Best,
> >
> >     Patrick
> >
> >
> >
> >
> >
> >             [[alternative HTML version deleted]]
> >
> >     _______________________________________________
> >     R-sig-Geo mailing list
> >     R-sig-Geo at r-project.org
> >     https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >
> >
> >
> > --
> > Ahmadou H. DICKO, PhD
> >
> > Statistical consultant
> > Mobile: (+221) 77 123 81 69
> > Skype: dicko.ahmadou.h
> > Twitter : @dickoah
> > Gitlab: gitlab/dickoa
> > Github: github/dickoa
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
Ahmadou H. DICKO, PhD

Statistical consultant
Mobile: (+221) 77 123 81 69
Skype: dicko.ahmadou.h
Twitter : @dickoah
Gitlab: gitlab/dickoa
Github: github/dickoa

	[[alternative HTML version deleted]]


From t@v|b@r @end|ng |rom gm@||@com  Sun Mar  6 14:13:24 2022
From: t@v|b@r @end|ng |rom gm@||@com (Micha Silver)
Date: Sun, 6 Mar 2022 15:13:24 +0200
Subject: [R-sig-Geo] Error reading spatialite table with sf::st_read
In-Reply-To: <b673f159-d385-30d9-5314-797590ed69f9@uni-muenster.de>
References: <30bfe6d0393d4c869ca02d84c4ae25d1@ec.europa.eu>
 <CANVKczNnEs0KyU2nkYJh79maxpTo+0ko+nhCwti+FQ3GMVYCKw@mail.gmail.com>
 <069dc9d7-02f2-f0e2-897f-ea9b2fff71e7@uni-muenster.de>
 <4d6efa29-9a2d-34b1-ae47-4691d2cfffe7@gmail.com>
 <b673f159-d385-30d9-5314-797590ed69f9@uni-muenster.de>
Message-ID: <3e99c256-b00c-a00f-4a6c-27533d20edc6@gmail.com>


On 05/03/2022 17:52, Edzer Pebesma wrote:
>
>
> On 05/03/2022 16:29, Micha Silver wrote:
>>
>>
>>
>> I'm certainly no expert in WKB, but I did notice on the spatialite 
>> group list the following thread:
>>
>> https://groups.google.com/g/spatialite-users/c/fJSlg6qGUfc
>>
>> where Sandro explains that the spatialite "geom" column is NOT in 
>> standard WKB...
>
> thanks - that's what sf takes care of when setting spatialite = TRUE 
> in st_as_sfc():
>
Ah, got it. Thanks for clarifying


>
-- 
Micha Silver
Ben Gurion Univ.
Sde Boker, Remote Sensing Lab
cell: +972-523-665918


From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Sun Mar 13 00:41:35 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Sun, 13 Mar 2022 11:41:35 +1200
Subject: [R-sig-Geo] Mapping Pacific centered map for Spatial analysis
Message-ID: <CAH5tCz1xoz4LYi7N-VBap3Ud1ZgXHvJpocT5r3-szO4bQdsQ5w@mail.gmail.com>

Hello Sir/Madam,

I am Sownal Chand, from Fiji Islands and am currently working on a project
which involves spatial analysis of climate data (Temperature, rainfall,
etc). I have been able to write codes in R for Point interpolations of
these parameters but I require some assistance in mapping these raster
files on the southwest pacific maps. For example, a map of Fiji Islands  (
https://www.pinterest.com/pin/740982944911004875 ) and I am facing some
difficulties in making these plots.

I hope that some expert would be willing to help me with this and the map's
CRS setting is a bit confusing and I am a beginner in this area ( i. e,
spatial analysis using R). I have been looking at tutorials and codes to
crop country boundaries and shapefiles and still found lots of errors in my
codes.

Hoping to find solutions to my problems and learn from this.

yours sincerely
sownalc
Contact: sownalchand at gmail.com
PH +679 2960779

	[[alternative HTML version deleted]]


From t@v|b@r @end|ng |rom gm@||@com  Sun Mar 13 09:45:35 2022
From: t@v|b@r @end|ng |rom gm@||@com (Micha Silver)
Date: Sun, 13 Mar 2022 10:45:35 +0200
Subject: [R-sig-Geo] Mapping Pacific centered map for Spatial analysis
In-Reply-To: <CAH5tCz1xoz4LYi7N-VBap3Ud1ZgXHvJpocT5r3-szO4bQdsQ5w@mail.gmail.com>
References: <CAH5tCz1xoz4LYi7N-VBap3Ud1ZgXHvJpocT5r3-szO4bQdsQ5w@mail.gmail.com>
Message-ID: <d98f5de9-561a-4bd8-a173-f4f551ce93ad@gmail.com>


On 13/03/2022 01:41, sownal chand wrote:
> Hello Sir/Madam,
>
> I am Sownal Chand, from Fiji Islands and am currently working on a project
> which involves spatial analysis of climate data (Temperature, rainfall,
> etc). I have been able to write codes in R for Point interpolations of
> these parameters but I require some assistance in mapping these raster
> files on the southwest pacific maps. For example, a map of Fiji Islands  (
> https://www.pinterest.com/pin/740982944911004875 ) and I am facing some
> difficulties in making these plots.
>
> I hope that some expert would be willing to help me with this and the map's
> CRS setting is a bit confusing and I am a beginner in this area ( i. e,
> spatial analysis using R). I have been looking at tutorials and codes to


There are tons of online resources. You could, for example, refer to:

https://geocompr.robinlovelace.net/


> crop country boundaries and shapefiles and still found lots of errors in my
> codes.


You have raised a few different questions. Would you mind to post what 
you have done so far, and point out the errors and difficulties?


> Hoping to find solutions to my problems and learn from this.
>
> yours sincerely
> sownalc
> Contact: sownalchand at gmail.com
> PH +679 2960779
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Micha Silver
Ben Gurion Univ.
Sde Boker, Remote Sensing Lab
cell: +972-523-665918


From Roger@B|v@nd @end|ng |rom nhh@no  Sun Mar 13 15:07:38 2022
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Sun, 13 Mar 2022 15:07:38 +0100 (CET)
Subject: [R-sig-Geo] Mapping Pacific centered map for Spatial analysis
In-Reply-To: <d98f5de9-561a-4bd8-a173-f4f551ce93ad@gmail.com>
References: <CAH5tCz1xoz4LYi7N-VBap3Ud1ZgXHvJpocT5r3-szO4bQdsQ5w@mail.gmail.com>
 <d98f5de9-561a-4bd8-a173-f4f551ce93ad@gmail.com>
Message-ID: <3182dda5-e65e-5629-873-1d209dbb3a2c@reclus2.nhh.no>

On Sun, 13 Mar 2022, Micha Silver wrote:

>
> On 13/03/2022 01:41, sownal chand wrote:
>>  Hello Sir/Madam,
>>
>>  I am Sownal Chand, from Fiji Islands and am currently working on a project
>>  which involves spatial analysis of climate data (Temperature, rainfall,
>>  etc). I have been able to write codes in R for Point interpolations of
>>  these parameters but I require some assistance in mapping these raster
>>  files on the southwest pacific maps. For example, a map of Fiji Islands  (
>>  https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.pinterest.com%2Fpin%2F740982944911004875&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C3d492fafcd7247d2090e08da04cde59b%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637827580063300234%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=5xNJDee6Glb%2FW7MCkO8biDzHl1%2Bv5hc%2FBsU%2FmO9neLE%3D&amp;reserved=0
>>  ) and I am facing some
>>  difficulties in making these plots.
>>
>>  I hope that some expert would be willing to help me with this and the
>>  map's
>>  CRS setting is a bit confusing and I am a beginner in this area ( i. e,
>>  spatial analysis using R). I have been looking at tutorials and codes to
>
>
> There are tons of online resources. You could, for example, refer to:
>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgeocompr.robinlovelace.net%2F&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C3d492fafcd7247d2090e08da04cde59b%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637827580063300234%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=08BU9QbKjLNh5TkKeu38etqzU%2FOysx7fqsGoVq3kImw%3D&amp;reserved=0
>
>
>>  crop country boundaries and shapefiles and still found lots of errors in
>>  my
>>  codes.
>
>
> You have raised a few different questions. Would you mind to post what you 
> have done so far, and point out the errors and difficulties?
>

It does also seem possible that the problems are initially caused by using 
geographical (spherical) coordinates rather than projected coordinates. 
Projection of the input points to say EPSG:3460, or for the broader 
Pacific Basin EPSG:3832, may be helpful. See 
https://www.asprs.org/wp-content/uploads/2012/05/10-2000-fiji.pdf for the 
then (publication 2000) valid description of why EPSG only seems to record 
Fiji with 1956 (international ellipsoid) and 1986 (WGS1972 ellipsoid).

EPSG:4326 can be transformed to EPSG:3460 with 2m accuracy. Using then a 
projected planar extent in the local grid, the problem of crossing 180 
degrees is removed. In addition, the interpolation will use metres not 
degrees as the metric of the positions of the points and grid cells. The 
planar representation should also remove plotting problems.

Hope this helps,

Roger

>
>>  Hoping to find solutions to my problems and learn from this.
>>
>>  yours sincerely
>>  sownalc
>>  Contact: sownalchand at gmail.com
>>  PH +679 2960779
>>
>>   [[alternative HTML version deleted]]
>>
>>  _______________________________________________
>>  R-sig-Geo mailing list
>>  R-sig-Geo at r-project.org
>>  https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C3d492fafcd7247d2090e08da04cde59b%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637827580063300234%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=BbbD%2BNIDVs82yx2JHiO3PTxUD%2BBUH%2FXdpirZCFGAmn0%3D&amp;reserved=0
>
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From t@v|b@r @end|ng |rom gm@||@com  Sun Mar 13 16:37:59 2022
From: t@v|b@r @end|ng |rom gm@||@com (Micha Silver)
Date: Sun, 13 Mar 2022 17:37:59 +0200
Subject: [R-sig-Geo] Mapping Pacific centered map for Spatial analysis
In-Reply-To: <CAH5tCz0YT-8WfVQKxUUO_Zma-4CrgKMazzYM+ML22p7ArvRAdg@mail.gmail.com>
References: <CAH5tCz1xoz4LYi7N-VBap3Ud1ZgXHvJpocT5r3-szO4bQdsQ5w@mail.gmail.com>
 <d98f5de9-561a-4bd8-a173-f4f551ce93ad@gmail.com>
 <CAH5tCz0YT-8WfVQKxUUO_Zma-4CrgKMazzYM+ML22p7ArvRAdg@mail.gmail.com>
Message-ID: <70f711d6-5964-52bb-3ec1-77c382a577db@gmail.com>

Hi:


I've prepared an alternative to your code, with some ideas that might 
help. Following Roger's comment, I transformed the spatial layers to 
EPSG:3460. The code is attached.


I also have a few comments. Inline, below:


On 13/03/2022 11:26, sownal chand wrote:
> Hello Micha,
>
> Thank you for your prompt response. I am attaching my codes and sample 
> data for?your reference.
> As I mentioned earlier, I am trying to interpolate climate data using 
> IDW and visualize the Climate change that is happening?in My country 
> from the past 55years till date (2021).
> Moving?forward, I am new to spatial interpolation using R and would 
> like to write codes in R so that it is easy to notice the changes in 
> the average temperature, Max, Min temperature, rainfall and 
> other?climate variables.
>

First, you're using some older packages (rgdal and rgeos). Today it 
makes sense to switch to the newer sf without those dependencies.


>
> # import libraries
> library(raster)
> library(ggmap)
> library(RgoogleMaps)
> library(rgdal)
> library(ggplot2)
> library(rnaturalearth)
> library(dplyr)
> library(tidyr)
> library(gstat)
> library(rgeos)
> library(scales)
> options(stringsAsFactors = FALSE)
>
> # Fiji geo data & study Area
> # download
> #Draft map of Fiji
> Fiji_studyarea <- readOGR("../input/fijishp/FJI_adm2.shp")
> extent(Fiji_studyarea)
>
> # import climate data - netcdf format
> Temp <- read.csv("../input/TempData/53YearsTemper.csv")
> Temp
> str(Temp)
>

This data file is in "wide" format. In the example I show how to make it 
"tidy" for further plotting and analysis.


> # check out our one years data
> Temp$Year.3
>
> # remove NA values
> Temp <- Temp %>%
> ? drop_na()
> Temp
>
> # create spatial points object
> Temp_sp <- Temp
> class(Temp_sp)
>
> # convert the data into spatial coordinates
> coordinates(Temp_sp) <- ~long + lat
> class(Temp_sp)
>
> # view spatial points
> plot(Temp_sp$Year,
> ? ? ?main = "Average Temperature for year 1965")
>

Next, you have data from only a few, widely spaced stations, and IDW 
might not be the best interpolation method. But that's for you to decide.



> ##### IDW interpolation ##### From here the code gives errors as the 
> interpolation area is very small.
> # establish an extent within which you want to interpolate
> x_range <- as.numeric(c(290.00, 360.00)) ?# min/max longitude of the 
> interpolation area
> y_range <- as.numeric(c(-23.00, -17.00)) ?# min/max latitude of the 
> interpolation area
>

With gstat you can now use a stars object as target grid. See my example.


> # create an empty grid of values ranging from the xmin-xmax, ymin-ymax
> grd <- expand.grid(x = seq(from = x_range[1],
> ? ? ? ? ? ? ? ? ? ?to = x_range[2],
> ? ? ? ? ? ? ? ? ? ?by = 0.1),
> ? ? ? ? ? ? ? ? ? ?y = seq(from = y_range[1], to = y_range[2],
> ? ? ? ? ? ? ? ? ? ? ? ?by = 0.1)) ?# expand points to grid
> class(grd)
>
> # crs = 3832, # https://epsg.io/3832 Pacific centered CRS
>
> # interpolate the data
> idwTemp_pow1 <- idw(formula = Temp$Year ~ 1,
> ? ? ? ? ? ?locations = Temp_sp,
> ? ? ? ? ? ?newdata = grd,
> ? ? ? ? ? ?idp = 1)
>
> # plot the data
> plot(idw_pow1,
> ? ? ?col = terrain.colors(55))
>
>
> Please can you assist in correcting these errors. and the shapefile 
> does not show on the map. OR you can give a better option of codes to 
> follow doing this.
>
> Really appreciate your assistance and thanking you in advance
>
>

Final comment. You mentioned a time series analysis to follow climate 
change. You'll have to decide how you want to go about this. Are you 
going to prepare interpolations for each year, then do a pixel by pixel 
change detection? In my example I show a simple time series plot of 
temperature data, by station.


HTH

Regards, Micha


>
>
>
>
> On Sun, 13 Mar 2022 at 20:45, Micha Silver <tsvibar at gmail.com> wrote:
>
>
>     On 13/03/2022 01:41, sownal chand wrote:
>     > Hello Sir/Madam,
>     >
>     > I am Sownal Chand, from Fiji Islands and am currently working on
>     a project
>     > which involves spatial analysis of climate data (Temperature,
>     rainfall,
>     > etc). I have been able to write codes in R for Point
>     interpolations of
>     > these parameters but I require some assistance in mapping these
>     raster
>     > files on the southwest pacific maps. For example, a map of Fiji
>     Islands? (
>     > https://www.pinterest.com/pin/740982944911004875 ) and I am
>     facing some
>     > difficulties in making these plots.
>     >
>     > I hope that some expert would be willing to help me with this
>     and the map's
>     > CRS setting is a bit confusing and I am a beginner in this area
>     ( i. e,
>     > spatial analysis using R). I have been looking at tutorials and
>     codes to
>
>
>     There are tons of online resources. You could, for example, refer to:
>
>     https://geocompr.robinlovelace.net/
>
>
>     > crop country boundaries and shapefiles and still found lots of
>     errors in my
>     > codes.
>
>
>     You have raised a few different questions. Would you mind to post
>     what
>     you have done so far, and point out the errors and difficulties?
>
>
>     > Hoping to find solutions to my problems and learn from this.
>     >
>     > yours sincerely
>     > sownalc
>     > Contact: sownalchand at gmail.com
>     > PH +679 2960779
>     >
>     >? ? ? ?[[alternative HTML version deleted]]
>     >
>     > _______________________________________________
>     > R-sig-Geo mailing list
>     > R-sig-Geo at r-project.org
>     > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
>     -- 
>     Micha Silver
>     Ben Gurion Univ.
>     Sde Boker, Remote Sensing Lab
>     cell: +972-523-665918
>
-- 
Micha Silver
Ben Gurion Univ.
Sde Boker, Remote Sensing Lab
cell: +972-523-665918

-------------- next part --------------
A non-text attachment was scrubbed...
Name: fiji_temp.R
Type: text/x-r-source
Size: 2572 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220313/a0d67759/attachment.bin>

From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Sun Mar 13 17:31:07 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Mon, 14 Mar 2022 04:31:07 +1200
Subject: [R-sig-Geo] Mapping Pacific centered map for Spatial analysis
In-Reply-To: <3182dda5-e65e-5629-873-1d209dbb3a2c@reclus2.nhh.no>
References: <CAH5tCz1xoz4LYi7N-VBap3Ud1ZgXHvJpocT5r3-szO4bQdsQ5w@mail.gmail.com>
 <d98f5de9-561a-4bd8-a173-f4f551ce93ad@gmail.com>
 <3182dda5-e65e-5629-873-1d209dbb3a2c@reclus2.nhh.no>
Message-ID: <CAH5tCz1RbtPD5Kmu1o66Z=eb4SvJ25zD-kb4KuhaDY8iFEdGjg@mail.gmail.com>

Hello sir(s),

Firstly I would like to thank both of you for your input in assistance me
with my problems that I am facing using R aa a spatial analysis tool.

I have been trying to do this for past 6 months and have found it really
challenging but quite interesting as well.

I will look at the codes and try to complete my project.

Sir all credits goes to both of you since you have provided timely response
to my questions.

If I do face any issues will try to consult again.

Yours sincerely
Sownal

On Mon, Mar 14, 2022, 02:07 Roger Bivand <Roger.Bivand at nhh.no> wrote:

> On Sun, 13 Mar 2022, Micha Silver wrote:
>
> >
> > On 13/03/2022 01:41, sownal chand wrote:
> >>  Hello Sir/Madam,
> >>
> >>  I am Sownal Chand, from Fiji Islands and am currently working on a
> project
> >>  which involves spatial analysis of climate data (Temperature, rainfall,
> >>  etc). I have been able to write codes in R for Point interpolations of
> >>  these parameters but I require some assistance in mapping these raster
> >>  files on the southwest pacific maps. For example, a map of Fiji
> Islands  (
> >>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.pinterest.com%2Fpin%2F740982944911004875&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C3d492fafcd7247d2090e08da04cde59b%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637827580063300234%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=5xNJDee6Glb%2FW7MCkO8biDzHl1%2Bv5hc%2FBsU%2FmO9neLE%3D&amp;reserved=0
> >>  ) and I am facing some
> >>  difficulties in making these plots.
> >>
> >>  I hope that some expert would be willing to help me with this and the
> >>  map's
> >>  CRS setting is a bit confusing and I am a beginner in this area ( i. e,
> >>  spatial analysis using R). I have been looking at tutorials and codes
> to
> >
> >
> > There are tons of online resources. You could, for example, refer to:
> >
> >
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgeocompr.robinlovelace.net%2F&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C3d492fafcd7247d2090e08da04cde59b%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637827580063300234%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=08BU9QbKjLNh5TkKeu38etqzU%2FOysx7fqsGoVq3kImw%3D&amp;reserved=0
> >
> >
> >>  crop country boundaries and shapefiles and still found lots of errors
> in
> >>  my
> >>  codes.
> >
> >
> > You have raised a few different questions. Would you mind to post what
> you
> > have done so far, and point out the errors and difficulties?
> >
>
> It does also seem possible that the problems are initially caused by using
> geographical (spherical) coordinates rather than projected coordinates.
> Projection of the input points to say EPSG:3460, or for the broader
> Pacific Basin EPSG:3832, may be helpful. See
> https://www.asprs.org/wp-content/uploads/2012/05/10-2000-fiji.pdf for the
> then (publication 2000) valid description of why EPSG only seems to record
> Fiji with 1956 (international ellipsoid) and 1986 (WGS1972 ellipsoid).
>
> EPSG:4326 can be transformed to EPSG:3460 with 2m accuracy. Using then a
> projected planar extent in the local grid, the problem of crossing 180
> degrees is removed. In addition, the interpolation will use metres not
> degrees as the metric of the positions of the points and grid cells. The
> planar representation should also remove plotting problems.
>
> Hope this helps,
>
> Roger
>
> >
> >>  Hoping to find solutions to my problems and learn from this.
> >>
> >>  yours sincerely
> >>  sownalc
> >>  Contact: sownalchand at gmail.com
> >>  PH +679 2960779
> >>
> >>   [[alternative HTML version deleted]]
> >>
> >>  _______________________________________________
> >>  R-sig-Geo mailing list
> >>  R-sig-Geo at r-project.org
> >>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7C3d492fafcd7247d2090e08da04cde59b%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637827580063300234%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=BbbD%2BNIDVs82yx2JHiO3PTxUD%2BBUH%2FXdpirZCFGAmn0%3D&amp;reserved=0
> >
> >
>
> --
> Roger Bivand
> Emeritus Professor
> Department of Economics, Norwegian School of Economics,
> Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
> e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>

	[[alternative HTML version deleted]]


From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Sun Mar 13 17:39:30 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Mon, 14 Mar 2022 04:39:30 +1200
Subject: [R-sig-Geo] Mapping Pacific centered map for Spatial analysis
In-Reply-To: <70f711d6-5964-52bb-3ec1-77c382a577db@gmail.com>
References: <CAH5tCz1xoz4LYi7N-VBap3Ud1ZgXHvJpocT5r3-szO4bQdsQ5w@mail.gmail.com>
 <d98f5de9-561a-4bd8-a173-f4f551ce93ad@gmail.com>
 <CAH5tCz0YT-8WfVQKxUUO_Zma-4CrgKMazzYM+ML22p7ArvRAdg@mail.gmail.com>
 <70f711d6-5964-52bb-3ec1-77c382a577db@gmail.com>
Message-ID: <CAH5tCz3S_ViY-=80tKcNcrY3T4DV-TT7G2zZidnrX2LTcQNTpQ@mail.gmail.com>

Hi Micha

Firstly thank you very very much. I have been trying to do this for quite
some time.

I will follow your codes and if I have any questions will let you know.

For the times series analysis for temperature, I am still thinking for the
best solutions to go about doing it.

If you have a better technique do let me know so that I can be as
accurate as possible.

Requesting if you can show some light in time series data analysis would
really help.

Yours sincerely
Sownal



On Mon, Mar 14, 2022, 03:38 Micha Silver <tsvibar at gmail.com> wrote:

> Hi:
>
>
> I've prepared an alternative to your code, with some ideas that might
> help. Following Roger's comment, I transformed the spatial layers to
> EPSG:3460. The code is attached.
>
>
> I also have a few comments. Inline, below:
>
>
> On 13/03/2022 11:26, sownal chand wrote:
> > Hello Micha,
> >
> > Thank you for your prompt response. I am attaching my codes and sample
> > data for your reference.
> > As I mentioned earlier, I am trying to interpolate climate data using
> > IDW and visualize the Climate change that is happening in My country
> > from the past 55years till date (2021).
> > Moving forward, I am new to spatial interpolation using R and would
> > like to write codes in R so that it is easy to notice the changes in
> > the average temperature, Max, Min temperature, rainfall and
> > other climate variables.
> >
>
> First, you're using some older packages (rgdal and rgeos). Today it
> makes sense to switch to the newer sf without those dependencies.
>
>
> >
> > # import libraries
> > library(raster)
> > library(ggmap)
> > library(RgoogleMaps)
> > library(rgdal)
> > library(ggplot2)
> > library(rnaturalearth)
> > library(dplyr)
> > library(tidyr)
> > library(gstat)
> > library(rgeos)
> > library(scales)
> > options(stringsAsFactors = FALSE)
> >
> > # Fiji geo data & study Area
> > # download
> > #Draft map of Fiji
> > Fiji_studyarea <- readOGR("../input/fijishp/FJI_adm2.shp")
> > extent(Fiji_studyarea)
> >
> > # import climate data - netcdf format
> > Temp <- read.csv("../input/TempData/53YearsTemper.csv")
> > Temp
> > str(Temp)
> >
>
> This data file is in "wide" format. In the example I show how to make it
> "tidy" for further plotting and analysis.
>
>
> > # check out our one years data
> > Temp$Year.3
> >
> > # remove NA values
> > Temp <- Temp %>%
> >   drop_na()
> > Temp
> >
> > # create spatial points object
> > Temp_sp <- Temp
> > class(Temp_sp)
> >
> > # convert the data into spatial coordinates
> > coordinates(Temp_sp) <- ~long + lat
> > class(Temp_sp)
> >
> > # view spatial points
> > plot(Temp_sp$Year,
> >      main = "Average Temperature for year 1965")
> >
>
> Next, you have data from only a few, widely spaced stations, and IDW
> might not be the best interpolation method. But that's for you to decide.
>
>
>
> > ##### IDW interpolation ##### From here the code gives errors as the
> > interpolation area is very small.
> > # establish an extent within which you want to interpolate
> > x_range <- as.numeric(c(290.00, 360.00))  # min/max longitude of the
> > interpolation area
> > y_range <- as.numeric(c(-23.00, -17.00))  # min/max latitude of the
> > interpolation area
> >
>
> With gstat you can now use a stars object as target grid. See my example.
>
>
> > # create an empty grid of values ranging from the xmin-xmax, ymin-ymax
> > grd <- expand.grid(x = seq(from = x_range[1],
> >                    to = x_range[2],
> >                    by = 0.1),
> >                    y = seq(from = y_range[1], to = y_range[2],
> >                        by = 0.1))  # expand points to grid
> > class(grd)
> >
> > # crs = 3832, # https://epsg.io/3832 Pacific centered CRS
> >
> > # interpolate the data
> > idwTemp_pow1 <- idw(formula = Temp$Year ~ 1,
> >            locations = Temp_sp,
> >            newdata = grd,
> >            idp = 1)
> >
> > # plot the data
> > plot(idw_pow1,
> >      col = terrain.colors(55))
> >
> >
> > Please can you assist in correcting these errors. and the shapefile
> > does not show on the map. OR you can give a better option of codes to
> > follow doing this.
> >
> > Really appreciate your assistance and thanking you in advance
> >
> >
>
> Final comment. You mentioned a time series analysis to follow climate
> change. You'll have to decide how you want to go about this. Are you
> going to prepare interpolations for each year, then do a pixel by pixel
> change detection? In my example I show a simple time series plot of
> temperature data, by station.
>
>
> HTH
>
> Regards, Micha
>
>
> >
> >
> >
> >
> > On Sun, 13 Mar 2022 at 20:45, Micha Silver <tsvibar at gmail.com> wrote:
> >
> >
> >     On 13/03/2022 01:41, sownal chand wrote:
> >     > Hello Sir/Madam,
> >     >
> >     > I am Sownal Chand, from Fiji Islands and am currently working on
> >     a project
> >     > which involves spatial analysis of climate data (Temperature,
> >     rainfall,
> >     > etc). I have been able to write codes in R for Point
> >     interpolations of
> >     > these parameters but I require some assistance in mapping these
> >     raster
> >     > files on the southwest pacific maps. For example, a map of Fiji
> >     Islands  (
> >     > https://www.pinterest.com/pin/740982944911004875 ) and I am
> >     facing some
> >     > difficulties in making these plots.
> >     >
> >     > I hope that some expert would be willing to help me with this
> >     and the map's
> >     > CRS setting is a bit confusing and I am a beginner in this area
> >     ( i. e,
> >     > spatial analysis using R). I have been looking at tutorials and
> >     codes to
> >
> >
> >     There are tons of online resources. You could, for example, refer to:
> >
> >     https://geocompr.robinlovelace.net/
> >
> >
> >     > crop country boundaries and shapefiles and still found lots of
> >     errors in my
> >     > codes.
> >
> >
> >     You have raised a few different questions. Would you mind to post
> >     what
> >     you have done so far, and point out the errors and difficulties?
> >
> >
> >     > Hoping to find solutions to my problems and learn from this.
> >     >
> >     > yours sincerely
> >     > sownalc
> >     > Contact: sownalchand at gmail.com
> >     > PH +679 2960779
> >     >
> >     >       [[alternative HTML version deleted]]
> >     >
> >     > _______________________________________________
> >     > R-sig-Geo mailing list
> >     > R-sig-Geo at r-project.org
> >     > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >
> >     --
> >     Micha Silver
> >     Ben Gurion Univ.
> >     Sde Boker, Remote Sensing Lab
> >     cell: +972-523-665918
> >
> --
> Micha Silver
> Ben Gurion Univ.
> Sde Boker, Remote Sensing Lab
> cell: +972-523-665918
>

	[[alternative HTML version deleted]]


From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Tue Mar 15 06:37:52 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Tue, 15 Mar 2022 17:37:52 +1200
Subject: [R-sig-Geo] Point Interpolation and Analysis
Message-ID: <CAH5tCz34LYOq3KPUKEy=6-1ndcAg_eX-2OMjCuf1tTAPuaF5fA@mail.gmail.com>

Hello Sir/madam,

I have been trying to interpolate this data and make an animation by
following the codes given by Devan using Dr Timo's Dialect analysis in
Germany,
https://github.com/devanmcg/IntroRangeR/blob/master/12_RasGIS/Interpolation.R
.
Is there a way in which these code could be used for Mapping in
Pacific Region. Below is the edited version with errors

#packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, sf, kknn)
#
# Create a shorthand reference to Fiji Islands CRS
crs_etrs = "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m
+no_defs"
#
# Fiji geo data
# download
#Draft map of Fiji
world <- rnaturalearth::ne_countries(scale = "Large", returnclass = "sf")

Fiji <- ggplot(data=world) +
  geom_sf() +
  coord_sf(
    crs = 3832, # https://epsg.io/3832
   xlim = c(2984265.06, 3539584.72), # limits are taken from projected
bounds
   ylim = c(-2224162.41, -1811688.88)  # of EPSG:3832
  )+ theme_bw()

#Extract Fiji Boundary data
Fiji <- FJI %>%
  filter(iso_a3 == "FJI")
plot(Fiji)



Fiji <- Fiji %>%
  group_by(iso_a3) %>%
  summarize()
# simplify
Fiji %>%
  st_simplify(preserveTopology = T, dTolerance = 0.01)

#load point data from the data file stored
data_53YearTemp <- read.csv("C://Users/Sownal/Documents/53YearsTemp.csv")
View(data_53YearTemp)

data$long <- as.numeric(data$Longitude)
data$lat <- as.numeric(data$Latitude)

#remove NA valuues in the spatial Data Frame
data_53YearTemp <- na.omit(data_53YearTemp)

#convert 53YearTemp to a Dataframe
#spatial points dataframe
data.sp1 <- SpatialPointsDataFrame(data_53YearTemp[,c(3,4)],
data_53YearTemp[,-c(3,4)])
View(data.sp1)
#point data to sf
data.sp1 %>%
  st_as_sf(coords = c("lng", "lat"),
           crs = "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84
+units=m +no_defs ")


#reproject data to the specificed crs or epsg country code
# CRS: ETRS
etrs <- "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m
+no_defs "
Fiji %>%
  st_transform(etrs)
data.sp_train %>%
  st_transform(etrs)

#remove NA valuues in the spatial Data Frame
data_53YearTemp <- na.omit(data_53YearTemp)

#cliping dataframe to buffer Fiji
Fiji_buffered <- Fiji %>%
  st_buffer(dist = 10000) # in meters, 10km buffer
data.sp1 <- data.sp1[Fiji_buffered, ]

# specify grid width in pixels
width_in_pixels <- 300
# dx is the width of a grid cell in meters
dx <- ceiling( (st_bbox(Fiji_buffered)["xmax"] -
                  st_bbox(Fiji_buffered)["xmin"]) / width_in_pixels)
# dy is the height of a grid cell in meters
# because we use quadratic grid cells, dx == dy
dy <- dx
# calculate the height in pixels of the resulting grid
height_in_pixels <- floor( (st_bbox(Fiji_buffered)["ymax"] -
                              st_bbox(Fiji_buffered)["ymin"]) / dy)

grid <- st_make_grid(Fiji_buffered,
                     cellsize = dx,
                     n = c(width_in_pixels, height_in_pixels),
                     what = "centers"
)

rm(dx, dy, height_in_pixels, Fiji_buffered)

plot(grid)
# View grid
ggplot() +
  geom_sf(data=grid) +
  geom_sf(data=Fiji, fill=NA, color="blue", lwd=2)
# Prepare data for interpolation
#
# Create tibble of the TempData sf object
TEmp_input <- data_53YearTemp %>%
  tibble::as.tibble(data_53YearTemp = .$pronunciation_id,
         lon = st_coordinates(.)[, 4],
         lat = st_coordinates(.)[, 3]) %>%
  select(Year, lon, lat)
#training data set for the interpolations
data.sp_train <- SpatialPointsDataFrame(data_53YearTemp[,c(3,4)],
data_53YearTemp[,-c(3,4)])
View(data.sp_train)



# config
k <- 1000 # "k" for k-nearest-neighbour-interpolation

# specify function which is executed for each tile of the grid
computeGrid <- function(grid, data.sp1, knn) {
  # create empty result data frame
  Temp_result <- data.frame(Temp = as.factor(NA),
                                lon = st_coordinates(grid)[, 1],
                                lat = st_coordinates(grid)[, 2])
  # run KKNN
  Temp_kknn <- kknn::kknn(data.sp1_train ~ .,
                              train = data.sp1_train,
                              test = Temp_result,
                              kernel = "gaussian",
                              k = knn)
  # bring back to result data frame
  # only retain the probability of the dominant dialect at that grid cell
  Temp_result %>%
    # extract the interpolated dialect at each grid cell with the
    # kknn::fitted function
    mutate(Temp = fitted(Temp_kknn),
           # only retain the probability of the interpolated dialect,
           # discard the other 7
           prob = apply(Temp_kknn$prob,
                        1,
                        function(x) max(x)))
  return(Temp_result)
}

# specify the number of cores below (adapt if you have fewer cores or
# want to reserve some computation power to other stuff)
#registerDoParallel(cores = 5)

# specify number of batches and resulting size of each batch (in grid cells)
no_batches <- 60 # increase this number if you run into memory problems

batch_size <- ceiling(length(grid) / no_batches)

# PARALLEL COMPUTATION
start.time <- Sys.time()
Temp_result <- foreach(
  batch_no = 1:no_batches,
  # after each grid section is computed, rbind the resulting df into
  # one big dialects_result df
  .combine = rbind,
  # the order of grid computation doesn't matter: this speeds it up even
more
  .inorder = FALSE) %dopar% {
    # compute indices for each grid section, depending on batch_size and
current
    # batch
    start_idx <- (batch_no - 1) * batch_size + 1
    end_idx <- batch_no * batch_size
    # specify which section of the grid to interpolate, using regular
    # subsetting
    grid_batch <- grid[start_idx:ifelse(end_idx > length(grid),
                                        length(grid),
                                        end_idx)]
    # apply the actual computation to each grid section
    df <- computeGrid(grid_batch, data.sp1_train, k)
  }
end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken


# convert resulting df back to sf object, but do not remove raw geometry
cols
Temp_raster <- st_as_sf(data.sp_train,
                            coords = c("lon", "lat"),
                            crs = etrs,
                            remove = F)
# clip raster to Fiji again
Temp_raster <- Temp_raster[Fiji, ]
rm(Temp_result, k)

Sample data is also provided. Any assistance would be greatly appreciated.

Yours sincerely
sownalc

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220315/856f8f3b/attachment.html>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: DataTemp.csv
Type: application/vnd.ms-excel
Size: 5203 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220315/856f8f3b/attachment.xlb>

From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Tue Mar 15 08:12:49 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Tue, 15 Mar 2022 08:12:49 +0100
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
Message-ID: <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>

Hi,

I have a trouble with the combination of layout and plot.stars. e.g.

nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
layout.show(nf)

plot(st_geometry(mydept),col="grey",border="grey90")
plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)

plot(mypoly,col=mypal(12),border=mypal(12))

I expect that the first two plots display in region #1, the second added 
to the first, and the third plot in region #2. However, this is not what 
happens: actually, the third plot displays in region 1 erasing the 
others. I understand that plot.stars when not "added" does not respect 
the layout definition (and displays its own regions), and that my 
problem comes from the way plot.stars deals with that.

Has anyone an idea about a workaround ?


From Roger@B|v@nd @end|ng |rom nhh@no  Tue Mar 15 11:27:10 2022
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Tue, 15 Mar 2022 11:27:10 +0100 (CET)
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
 <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
Message-ID: <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>

On Tue, 15 Mar 2022, Patrick Giraudoux wrote:

> Hi,
>
> I have a trouble with the combination of layout and plot.stars. e.g.
>
> nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
> layout.show(nf)
>
> plot(st_geometry(mydept),col="grey",border="grey90")
> plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)

You have already noticed that sf and stars, like raster and terra, modify 
the assumptions of base plot methods, as graphics::filled.contour(), 
unless some ordering and argument conditions are met, crucially the 
non-base reset= argument. I do not think that you can use layout() at all.

library(stars)
nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
bir74_rast <- st_rasterize(nc["BIR74"])
plot(bir74_rast, reset=FALSE)
plot(st_geometry(nc),border="grey90", add=TRUE)
gridGraphics::grid.echo()
library(grid)
g <- grid.grab()
plot(nc["BIR74"])
gridGraphics::grid.echo()
gv <- grid.grab()
grid.newpage()
gridExtra::grid.arrange(g, gv, ncol=2)

Grabbing the base graphics device state lets you use 
gridExtra::grid.arrange() to place multiple graphics objects; here I 
haven't tried to constrain aspect or relative sizes. I don't think that 
the plot methods in sf and stars play well with layout, because they use 
it themselves internally.

Hope this helps,

Roger

>
> plot(mypoly,col=mypal(12),border=mypal(12))
>
> I expect that the first two plots display in region #1, the second added 
> to the first, and the third plot in region #2. However, this is not what 
> happens: actually, the third plot displays in region 1 erasing the 
> others. I understand that plot.stars when not "added" does not respect 
> the layout definition (and displays its own regions), and that my 
> problem comes from the way plot.stars deals with that.
>
> Has anyone an idea about a workaround ?
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7Cc67e7b9e4d6b43cb453c08da065345c7%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637829252131764014%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=IDZZmUAOMmrU8cwbsARqkHTry%2BA5v%2FWpB2JzEmEcc7U%3D&amp;reserved=0
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Tue Mar 15 11:29:30 2022
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Tue, 15 Mar 2022 11:29:30 +0100 (CET)
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
 <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
 <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
Message-ID: <e75060a0-3aa4-e0f9-8c71-91af6fd9fc56@reclus2.nhh.no>

On Tue, 15 Mar 2022, Roger Bivand wrote:

> On Tue, 15 Mar 2022, Patrick Giraudoux wrote:
>
>>  Hi,
>>
>>  I have a trouble with the combination of layout and plot.stars. e.g.
>>
>>  nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
>>  layout.show(nf)
>>
>>  plot(st_geometry(mydept),col="grey",border="grey90")
>>  plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)
>
> You have already noticed that sf and stars, like raster and terra, modify the 
> assumptions of base plot methods, as graphics::filled.contour(), unless some 
> ordering and argument conditions are met, crucially the non-base reset= 
> argument. I do not think that you can use layout() at all.
>
> library(stars)
> nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
> bir74_rast <- st_rasterize(nc["BIR74"])
> plot(bir74_rast, reset=FALSE)
> plot(st_geometry(nc),border="grey90", add=TRUE)
> gridGraphics::grid.echo()
> library(grid)
> g <- grid.grab()
> plot(nc["BIR74"])
> gridGraphics::grid.echo()
> gv <- grid.grab()
> grid.newpage()
> gridExtra::grid.arrange(g, gv, ncol=2)
>
> Grabbing the base graphics device state lets you use 
> gridExtra::grid.arrange() to place multiple graphics objects; here I haven't 
> tried to constrain aspect or relative sizes. I don't think that the plot 
> methods in sf and stars play well with layout, because they use it themselves 
> internally.

The integration of base graphics in grid graphics is mention in the 
Wednesday talk in https://rsbivand.github.io/BAN422_V20/.

>
> Hope this helps,
>
> Roger
>
>>
>>  plot(mypoly,col=mypal(12),border=mypal(12))
>>
>>  I expect that the first two plots display in region #1, the second added
>>  to the first, and the third plot in region #2. However, this is not what
>>  happens: actually, the third plot displays in region 1 erasing the others.
>>  I understand that plot.stars when not "added" does not respect the layout
>>  definition (and displays its own regions), and that my problem comes from
>>  the way plot.stars deals with that.
>>
>>  Has anyone an idea about a workaround ?
>>
>>  _______________________________________________
>>  R-sig-Geo mailing list
>>  R-sig-Geo at r-project.org
>>  https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7Cc67e7b9e4d6b43cb453c08da065345c7%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637829252131764014%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=IDZZmUAOMmrU8cwbsARqkHTry%2BA5v%2FWpB2JzEmEcc7U%3D&amp;reserved=0
>> 
>
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Tue Mar 15 11:45:44 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Tue, 15 Mar 2022 11:45:44 +0100
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
 <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
 <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
Message-ID: <15d6b9d7-b319-a612-2b30-b0bd5db782cf@univ-fcomte.fr>

Great ! Thanks Roger.? On this basis, I have a way to explore the issue 
now. Will give a feed-back on the list once done.
Best,
Patrick

Le 15/03/2022 ? 11:27, Roger Bivand a ?crit?:
> On Tue, 15 Mar 2022, Patrick Giraudoux wrote:
>
>> Hi,
>>
>> I have a trouble with the combination of layout and plot.stars. e.g.
>>
>> nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
>> layout.show(nf)
>>
>> plot(st_geometry(mydept),col="grey",border="grey90")
>> plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)
>
> You have already noticed that sf and stars, like raster and terra, 
> modify the assumptions of base plot methods, as 
> graphics::filled.contour(), unless some ordering and argument 
> conditions are met, crucially the non-base reset= argument. I do not 
> think that you can use layout() at all.
>
> library(stars)
> nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
> bir74_rast <- st_rasterize(nc["BIR74"])
> plot(bir74_rast, reset=FALSE)
> plot(st_geometry(nc),border="grey90", add=TRUE)
> gridGraphics::grid.echo()
> library(grid)
> g <- grid.grab()
> plot(nc["BIR74"])
> gridGraphics::grid.echo()
> gv <- grid.grab()
> grid.newpage()
> gridExtra::grid.arrange(g, gv, ncol=2)
>
> Grabbing the base graphics device state lets you use 
> gridExtra::grid.arrange() to place multiple graphics objects; here I 
> haven't tried to constrain aspect or relative sizes. I don't think 
> that the plot methods in sf and stars play well with layout, because 
> they use it themselves internally.
>
> Hope this helps,
>
> Roger
>
>>
>> plot(mypoly,col=mypal(12),border=mypal(12))
>>
>> I expect that the first two plots display in region #1, the second 
>> added to the first, and the third plot in region #2. However, this is 
>> not what happens: actually, the third plot displays in region 1 
>> erasing the others. I understand that plot.stars when not "added" 
>> does not respect the layout definition (and displays its own 
>> regions), and that my problem comes from the way plot.stars deals 
>> with that.
>>
>> Has anyone an idea about a workaround ?
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7Cc67e7b9e4d6b43cb453c08da065345c7%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637829252131764014%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=IDZZmUAOMmrU8cwbsARqkHTry%2BA5v%2FWpB2JzEmEcc7U%3D&amp;reserved=0 
>>
>>
>

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Tue Mar 15 12:14:56 2022
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Tue, 15 Mar 2022 12:14:56 +0100 (CET)
Subject: [R-sig-Geo] Point Interpolation and Analysis
In-Reply-To: <CAH5tCz34LYOq3KPUKEy=6-1ndcAg_eX-2OMjCuf1tTAPuaF5fA@mail.gmail.com>
References: <CAH5tCz34LYOq3KPUKEy=6-1ndcAg_eX-2OMjCuf1tTAPuaF5fA@mail.gmail.com>
Message-ID: <4983c663-51e4-4736-df34-81ff636df98c@reclus2.nhh.no>

On Tue, 15 Mar 2022, sownal chand wrote:

> Hello Sir/madam,
>
> I have been trying to interpolate this data and make an animation by
> following the codes given by Devan using Dr Timo's Dialect analysis in
> Germany,
> https://github.com/devanmcg/IntroRangeR/blob/master/12_RasGIS/Interpolation.R
> .
> Is there a way in which these code could be used for Mapping in
> Pacific Region. Below is the edited version with errors

Please never use any code just "found" on the internet. This code seems to 
be part of a course written partly in 2018, here from 2020. Lots of 
packages have changed in the years that have passed, especially with 
regard to coordinate reference systems and their representation. Never use 
a package (pacman) that does things you do not control (here it will 
install lots of tidyverse packages that are not needed for the essential 
sf package to run).

Do not use pipes %>% unless you are sure that all of the steps are 
correct; take everything in the smallest possible steps and check the 
intermediate output after each step. Build from simple steps, steps that 
you know how to explain to yourself and (if you also teach) to students or 
to your research collaborators. In that way you base your work not on 
possibly outdated code found somewhere, but on your own understanding. Try 
to avoid overwriting objects - if you use pipes and overwrite the input 
object, it is really hard to find out where things went wrong.

One remark - if the code you are looking at is tested often, like the 
examples on the help pages of functions, methods and datasets in CRAN 
packages, you are on safer ground. If the code has never been re-run even 
on its own data, new versions of R and the packages used may change the 
results - this applies in particular to tidyverse packages, which are 
often updated.

For coordinate reference systems, avoid all beginning with "+proj= ...", 
because these Proj.4 strings are no longer reliable if you need accuracy 
better than about 120m. You will see that the course materials you refer 
to have not been updated to reflect the need (in most cases) to use 
coordinate reference systems with known authority. Your use of "EPSG:3832" 
uses the authority of EPSG to assert the specification of the CRS; it also 
means that the datum transformation (say from or to the common 
geographical CRS - WGS84 - EPSG:4326) giving 2m accuracy is also asserted 
by an authority. Using "+proj= ..." leaves the user unsure about the 
accuracy of any transformation (typically known as ballpark accuracy).

For visualisation, please avoid using ggplot2 unless you use this package 
often (daily). For thematic mapping, tmap and mapsf are to be preferred, 
because they are written for making maps. Do not simplify/generalise 
coastlines unless you really need to do so. You can use tmap and mapview 
to view thematic maps interactively - as you zoom in, you see artefacts 
created by line generalization.

My guess is that your aim is to visualise 13 meteorological station annual 
average temperatures 1965-2018 after interpolation by year across the 
study area. I'm unsure whether you should be interpolating between islands 
across the ocean, and 13 stations (I assume that annual temperatures are 
transformed to sea level) is a very small number for interpolation. I'm 
also uncertain whether the input data are reliable (the values for 
Koronivia and Labasa seem to be identical for all years). If the data set 
is just to learn from, OK, but probably drawing conclusions from any 
results is not very secure.

Hope this clarifies,

Roger

>
> #packages
> if (!require("pacman")) install.packages("pacman")
> pacman::p_load(tidyverse, sf, kknn)
> #
> # Create a shorthand reference to Fiji Islands CRS
> crs_etrs = "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m
> +no_defs"
> #
> # Fiji geo data
> # download
> #Draft map of Fiji
> world <- rnaturalearth::ne_countries(scale = "Large", returnclass = "sf")
>
> Fiji <- ggplot(data=world) +
>  geom_sf() +
>  coord_sf(
>    crs = 3832, # https://epsg.io/3832
>   xlim = c(2984265.06, 3539584.72), # limits are taken from projected
> bounds
>   ylim = c(-2224162.41, -1811688.88)  # of EPSG:3832
>  )+ theme_bw()
>
> #Extract Fiji Boundary data
> Fiji <- FJI %>%
>  filter(iso_a3 == "FJI")
> plot(Fiji)
>
>
>
> Fiji <- Fiji %>%
>  group_by(iso_a3) %>%
>  summarize()
> # simplify
> Fiji %>%
>  st_simplify(preserveTopology = T, dTolerance = 0.01)
>
> #load point data from the data file stored
> data_53YearTemp <- read.csv("C://Users/Sownal/Documents/53YearsTemp.csv")
> View(data_53YearTemp)
>
> data$long <- as.numeric(data$Longitude)
> data$lat <- as.numeric(data$Latitude)
>
> #remove NA valuues in the spatial Data Frame
> data_53YearTemp <- na.omit(data_53YearTemp)
>
> #convert 53YearTemp to a Dataframe
> #spatial points dataframe
> data.sp1 <- SpatialPointsDataFrame(data_53YearTemp[,c(3,4)],
> data_53YearTemp[,-c(3,4)])
> View(data.sp1)
> #point data to sf
> data.sp1 %>%
>  st_as_sf(coords = c("lng", "lat"),
>           crs = "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84
> +units=m +no_defs ")
>
>
> #reproject data to the specificed crs or epsg country code
> # CRS: ETRS
> etrs <- "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m
> +no_defs "
> Fiji %>%
>  st_transform(etrs)
> data.sp_train %>%
>  st_transform(etrs)
>
> #remove NA valuues in the spatial Data Frame
> data_53YearTemp <- na.omit(data_53YearTemp)
>
> #cliping dataframe to buffer Fiji
> Fiji_buffered <- Fiji %>%
>  st_buffer(dist = 10000) # in meters, 10km buffer
> data.sp1 <- data.sp1[Fiji_buffered, ]
>
> # specify grid width in pixels
> width_in_pixels <- 300
> # dx is the width of a grid cell in meters
> dx <- ceiling( (st_bbox(Fiji_buffered)["xmax"] -
>                  st_bbox(Fiji_buffered)["xmin"]) / width_in_pixels)
> # dy is the height of a grid cell in meters
> # because we use quadratic grid cells, dx == dy
> dy <- dx
> # calculate the height in pixels of the resulting grid
> height_in_pixels <- floor( (st_bbox(Fiji_buffered)["ymax"] -
>                              st_bbox(Fiji_buffered)["ymin"]) / dy)
>
> grid <- st_make_grid(Fiji_buffered,
>                     cellsize = dx,
>                     n = c(width_in_pixels, height_in_pixels),
>                     what = "centers"
> )
>
> rm(dx, dy, height_in_pixels, Fiji_buffered)
>
> plot(grid)
> # View grid
> ggplot() +
>  geom_sf(data=grid) +
>  geom_sf(data=Fiji, fill=NA, color="blue", lwd=2)
> # Prepare data for interpolation
> #
> # Create tibble of the TempData sf object
> TEmp_input <- data_53YearTemp %>%
>  tibble::as.tibble(data_53YearTemp = .$pronunciation_id,
>         lon = st_coordinates(.)[, 4],
>         lat = st_coordinates(.)[, 3]) %>%
>  select(Year, lon, lat)
> #training data set for the interpolations
> data.sp_train <- SpatialPointsDataFrame(data_53YearTemp[,c(3,4)],
> data_53YearTemp[,-c(3,4)])
> View(data.sp_train)
>
>
>
> # config
> k <- 1000 # "k" for k-nearest-neighbour-interpolation
>
> # specify function which is executed for each tile of the grid
> computeGrid <- function(grid, data.sp1, knn) {
>  # create empty result data frame
>  Temp_result <- data.frame(Temp = as.factor(NA),
>                                lon = st_coordinates(grid)[, 1],
>                                lat = st_coordinates(grid)[, 2])
>  # run KKNN
>  Temp_kknn <- kknn::kknn(data.sp1_train ~ .,
>                              train = data.sp1_train,
>                              test = Temp_result,
>                              kernel = "gaussian",
>                              k = knn)
>  # bring back to result data frame
>  # only retain the probability of the dominant dialect at that grid cell
>  Temp_result %>%
>    # extract the interpolated dialect at each grid cell with the
>    # kknn::fitted function
>    mutate(Temp = fitted(Temp_kknn),
>           # only retain the probability of the interpolated dialect,
>           # discard the other 7
>           prob = apply(Temp_kknn$prob,
>                        1,
>                        function(x) max(x)))
>  return(Temp_result)
> }
>
> # specify the number of cores below (adapt if you have fewer cores or
> # want to reserve some computation power to other stuff)
> #registerDoParallel(cores = 5)
>
> # specify number of batches and resulting size of each batch (in grid cells)
> no_batches <- 60 # increase this number if you run into memory problems
>
> batch_size <- ceiling(length(grid) / no_batches)
>
> # PARALLEL COMPUTATION
> start.time <- Sys.time()
> Temp_result <- foreach(
>  batch_no = 1:no_batches,
>  # after each grid section is computed, rbind the resulting df into
>  # one big dialects_result df
>  .combine = rbind,
>  # the order of grid computation doesn't matter: this speeds it up even
> more
>  .inorder = FALSE) %dopar% {
>    # compute indices for each grid section, depending on batch_size and
> current
>    # batch
>    start_idx <- (batch_no - 1) * batch_size + 1
>    end_idx <- batch_no * batch_size
>    # specify which section of the grid to interpolate, using regular
>    # subsetting
>    grid_batch <- grid[start_idx:ifelse(end_idx > length(grid),
>                                        length(grid),
>                                        end_idx)]
>    # apply the actual computation to each grid section
>    df <- computeGrid(grid_batch, data.sp1_train, k)
>  }
> end.time <- Sys.time()
> time.taken <- end.time - start.time
> time.taken
>
>
> # convert resulting df back to sf object, but do not remove raw geometry
> cols
> Temp_raster <- st_as_sf(data.sp_train,
>                            coords = c("lon", "lat"),
>                            crs = etrs,
>                            remove = F)
> # clip raster to Fiji again
> Temp_raster <- Temp_raster[Fiji, ]
> rm(Temp_result, k)
>
> Sample data is also provided. Any assistance would be greatly appreciated.
>
> Yours sincerely
> sownalc
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Tue Mar 15 16:18:59 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Wed, 16 Mar 2022 03:18:59 +1200
Subject: [R-sig-Geo] Point Interpolation and Analysis
In-Reply-To: <4983c663-51e4-4736-df34-81ff636df98c@reclus2.nhh.no>
References: <CAH5tCz34LYOq3KPUKEy=6-1ndcAg_eX-2OMjCuf1tTAPuaF5fA@mail.gmail.com>
 <4983c663-51e4-4736-df34-81ff636df98c@reclus2.nhh.no>
Message-ID: <CAH5tCz3XUzMk8nN58WgiNZcPG5GzzrQtbmyDDSQv8Xc4t1zhXA@mail.gmail.com>

Hello sir

Thank you for your detailed email and yes this clarifies alot of things. I
hope to learn by building slowly but accurately.

I will try to write new code following the latest information provide by R
&Cran documentation and if I get stuck would request for assistance.

Thanks for the comments and hope to improve from there.

Yours faithfully
Sownalc

On Tue, Mar 15, 2022, 23:14 Roger Bivand <Roger.Bivand at nhh.no> wrote:

> On Tue, 15 Mar 2022, sownal chand wrote:
>
> > Hello Sir/madam,
> >
> > I have been trying to interpolate this data and make an animation by
> > following the codes given by Devan using Dr Timo's Dialect analysis in
> > Germany,
> >
> https://github.com/devanmcg/IntroRangeR/blob/master/12_RasGIS/Interpolation.R
> > .
> > Is there a way in which these code could be used for Mapping in
> > Pacific Region. Below is the edited version with errors
>
> Please never use any code just "found" on the internet. This code seems to
> be part of a course written partly in 2018, here from 2020. Lots of
> packages have changed in the years that have passed, especially with
> regard to coordinate reference systems and their representation. Never use
> a package (pacman) that does things you do not control (here it will
> install lots of tidyverse packages that are not needed for the essential
> sf package to run).
>
> Do not use pipes %>% unless you are sure that all of the steps are
> correct; take everything in the smallest possible steps and check the
> intermediate output after each step. Build from simple steps, steps that
> you know how to explain to yourself and (if you also teach) to students or
> to your research collaborators. In that way you base your work not on
> possibly outdated code found somewhere, but on your own understanding. Try
> to avoid overwriting objects - if you use pipes and overwrite the input
> object, it is really hard to find out where things went wrong.
>
> One remark - if the code you are looking at is tested often, like the
> examples on the help pages of functions, methods and datasets in CRAN
> packages, you are on safer ground. If the code has never been re-run even
> on its own data, new versions of R and the packages used may change the
> results - this applies in particular to tidyverse packages, which are
> often updated.
>
> For coordinate reference systems, avoid all beginning with "+proj= ...",
> because these Proj.4 strings are no longer reliable if you need accuracy
> better than about 120m. You will see that the course materials you refer
> to have not been updated to reflect the need (in most cases) to use
> coordinate reference systems with known authority. Your use of "EPSG:3832"
> uses the authority of EPSG to assert the specification of the CRS; it also
> means that the datum transformation (say from or to the common
> geographical CRS - WGS84 - EPSG:4326) giving 2m accuracy is also asserted
> by an authority. Using "+proj= ..." leaves the user unsure about the
> accuracy of any transformation (typically known as ballpark accuracy).
>
> For visualisation, please avoid using ggplot2 unless you use this package
> often (daily). For thematic mapping, tmap and mapsf are to be preferred,
> because they are written for making maps. Do not simplify/generalise
> coastlines unless you really need to do so. You can use tmap and mapview
> to view thematic maps interactively - as you zoom in, you see artefacts
> created by line generalization.
>
> My guess is that your aim is to visualise 13 meteorological station annual
> average temperatures 1965-2018 after interpolation by year across the
> study area. I'm unsure whether you should be interpolating between islands
> across the ocean, and 13 stations (I assume that annual temperatures are
> transformed to sea level) is a very small number for interpolation. I'm
> also uncertain whether the input data are reliable (the values for
> Koronivia and Labasa seem to be identical for all years). If the data set
> is just to learn from, OK, but probably drawing conclusions from any
> results is not very secure.
>
> Hope this clarifies,
>
> Roger
>
> >
> > #packages
> > if (!require("pacman")) install.packages("pacman")
> > pacman::p_load(tidyverse, sf, kknn)
> > #
> > # Create a shorthand reference to Fiji Islands CRS
> > crs_etrs = "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84
> +units=m
> > +no_defs"
> > #
> > # Fiji geo data
> > # download
> > #Draft map of Fiji
> > world <- rnaturalearth::ne_countries(scale = "Large", returnclass = "sf")
> >
> > Fiji <- ggplot(data=world) +
> >  geom_sf() +
> >  coord_sf(
> >    crs = 3832, # https://epsg.io/3832
> >   xlim = c(2984265.06, 3539584.72), # limits are taken from projected
> > bounds
> >   ylim = c(-2224162.41, -1811688.88)  # of EPSG:3832
> >  )+ theme_bw()
> >
> > #Extract Fiji Boundary data
> > Fiji <- FJI %>%
> >  filter(iso_a3 == "FJI")
> > plot(Fiji)
> >
> >
> >
> > Fiji <- Fiji %>%
> >  group_by(iso_a3) %>%
> >  summarize()
> > # simplify
> > Fiji %>%
> >  st_simplify(preserveTopology = T, dTolerance = 0.01)
> >
> > #load point data from the data file stored
> > data_53YearTemp <- read.csv("C://Users/Sownal/Documents/53YearsTemp.csv")
> > View(data_53YearTemp)
> >
> > data$long <- as.numeric(data$Longitude)
> > data$lat <- as.numeric(data$Latitude)
> >
> > #remove NA valuues in the spatial Data Frame
> > data_53YearTemp <- na.omit(data_53YearTemp)
> >
> > #convert 53YearTemp to a Dataframe
> > #spatial points dataframe
> > data.sp1 <- SpatialPointsDataFrame(data_53YearTemp[,c(3,4)],
> > data_53YearTemp[,-c(3,4)])
> > View(data.sp1)
> > #point data to sf
> > data.sp1 %>%
> >  st_as_sf(coords = c("lng", "lat"),
> >           crs = "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84
> > +units=m +no_defs ")
> >
> >
> > #reproject data to the specificed crs or epsg country code
> > # CRS: ETRS
> > etrs <- "+proj=merc +lon_0=150 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m
> > +no_defs "
> > Fiji %>%
> >  st_transform(etrs)
> > data.sp_train %>%
> >  st_transform(etrs)
> >
> > #remove NA valuues in the spatial Data Frame
> > data_53YearTemp <- na.omit(data_53YearTemp)
> >
> > #cliping dataframe to buffer Fiji
> > Fiji_buffered <- Fiji %>%
> >  st_buffer(dist = 10000) # in meters, 10km buffer
> > data.sp1 <- data.sp1[Fiji_buffered, ]
> >
> > # specify grid width in pixels
> > width_in_pixels <- 300
> > # dx is the width of a grid cell in meters
> > dx <- ceiling( (st_bbox(Fiji_buffered)["xmax"] -
> >                  st_bbox(Fiji_buffered)["xmin"]) / width_in_pixels)
> > # dy is the height of a grid cell in meters
> > # because we use quadratic grid cells, dx == dy
> > dy <- dx
> > # calculate the height in pixels of the resulting grid
> > height_in_pixels <- floor( (st_bbox(Fiji_buffered)["ymax"] -
> >                              st_bbox(Fiji_buffered)["ymin"]) / dy)
> >
> > grid <- st_make_grid(Fiji_buffered,
> >                     cellsize = dx,
> >                     n = c(width_in_pixels, height_in_pixels),
> >                     what = "centers"
> > )
> >
> > rm(dx, dy, height_in_pixels, Fiji_buffered)
> >
> > plot(grid)
> > # View grid
> > ggplot() +
> >  geom_sf(data=grid) +
> >  geom_sf(data=Fiji, fill=NA, color="blue", lwd=2)
> > # Prepare data for interpolation
> > #
> > # Create tibble of the TempData sf object
> > TEmp_input <- data_53YearTemp %>%
> >  tibble::as.tibble(data_53YearTemp = .$pronunciation_id,
> >         lon = st_coordinates(.)[, 4],
> >         lat = st_coordinates(.)[, 3]) %>%
> >  select(Year, lon, lat)
> > #training data set for the interpolations
> > data.sp_train <- SpatialPointsDataFrame(data_53YearTemp[,c(3,4)],
> > data_53YearTemp[,-c(3,4)])
> > View(data.sp_train)
> >
> >
> >
> > # config
> > k <- 1000 # "k" for k-nearest-neighbour-interpolation
> >
> > # specify function which is executed for each tile of the grid
> > computeGrid <- function(grid, data.sp1, knn) {
> >  # create empty result data frame
> >  Temp_result <- data.frame(Temp = as.factor(NA),
> >                                lon = st_coordinates(grid)[, 1],
> >                                lat = st_coordinates(grid)[, 2])
> >  # run KKNN
> >  Temp_kknn <- kknn::kknn(data.sp1_train ~ .,
> >                              train = data.sp1_train,
> >                              test = Temp_result,
> >                              kernel = "gaussian",
> >                              k = knn)
> >  # bring back to result data frame
> >  # only retain the probability of the dominant dialect at that grid cell
> >  Temp_result %>%
> >    # extract the interpolated dialect at each grid cell with the
> >    # kknn::fitted function
> >    mutate(Temp = fitted(Temp_kknn),
> >           # only retain the probability of the interpolated dialect,
> >           # discard the other 7
> >           prob = apply(Temp_kknn$prob,
> >                        1,
> >                        function(x) max(x)))
> >  return(Temp_result)
> > }
> >
> > # specify the number of cores below (adapt if you have fewer cores or
> > # want to reserve some computation power to other stuff)
> > #registerDoParallel(cores = 5)
> >
> > # specify number of batches and resulting size of each batch (in grid
> cells)
> > no_batches <- 60 # increase this number if you run into memory problems
> >
> > batch_size <- ceiling(length(grid) / no_batches)
> >
> > # PARALLEL COMPUTATION
> > start.time <- Sys.time()
> > Temp_result <- foreach(
> >  batch_no = 1:no_batches,
> >  # after each grid section is computed, rbind the resulting df into
> >  # one big dialects_result df
> >  .combine = rbind,
> >  # the order of grid computation doesn't matter: this speeds it up even
> > more
> >  .inorder = FALSE) %dopar% {
> >    # compute indices for each grid section, depending on batch_size and
> > current
> >    # batch
> >    start_idx <- (batch_no - 1) * batch_size + 1
> >    end_idx <- batch_no * batch_size
> >    # specify which section of the grid to interpolate, using regular
> >    # subsetting
> >    grid_batch <- grid[start_idx:ifelse(end_idx > length(grid),
> >                                        length(grid),
> >                                        end_idx)]
> >    # apply the actual computation to each grid section
> >    df <- computeGrid(grid_batch, data.sp1_train, k)
> >  }
> > end.time <- Sys.time()
> > time.taken <- end.time - start.time
> > time.taken
> >
> >
> > # convert resulting df back to sf object, but do not remove raw geometry
> > cols
> > Temp_raster <- st_as_sf(data.sp_train,
> >                            coords = c("lon", "lat"),
> >                            crs = etrs,
> >                            remove = F)
> > # clip raster to Fiji again
> > Temp_raster <- Temp_raster[Fiji, ]
> > rm(Temp_result, k)
> >
> > Sample data is also provided. Any assistance would be greatly
> appreciated.
> >
> > Yours sincerely
> > sownalc
> >
>
> --
> Roger Bivand
> Emeritus Professor
> Department of Economics, Norwegian School of Economics,
> Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
> e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>

	[[alternative HTML version deleted]]


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Tue Mar 15 16:02:07 2022
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Tue, 15 Mar 2022 16:02:07 +0100
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <15d6b9d7-b319-a612-2b30-b0bd5db782cf@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
 <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
 <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
 <15d6b9d7-b319-a612-2b30-b0bd5db782cf@univ-fcomte.fr>
Message-ID: <9c9fe669-845e-b5d1-e473-58ac82a6c379@uni-muenster.de>

In addition to what Roger wrote, you can use e.g.

layout(matrix(1:4,2))
library(stars)
s = st_as_stars(L7_ETMs)
image(s[,,,1])
plot(s[,,,1], key.pos = NULL, reset = FALSE)
plot(s[,,,1], key.pos = NULL, reset = FALSE, main = NULL)

to fill the sub-plots of layout() incrementally. Note the key.pos and 
reset arguments to plot.stars(): they make sure plot.stars doesn't mess 
with the layout settings.

On 15/03/2022 11:45, Patrick Giraudoux wrote:
> Great ! Thanks Roger.? On this basis, I have a way to explore the issue
> now. Will give a feed-back on the list once done.
> Best,
> Patrick
> 
> Le 15/03/2022 ? 11:27, Roger Bivand a ?crit?:
>> On Tue, 15 Mar 2022, Patrick Giraudoux wrote:
>>
>>> Hi,
>>>
>>> I have a trouble with the combination of layout and plot.stars. e.g.
>>>
>>> nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
>>> layout.show(nf)
>>>
>>> plot(st_geometry(mydept),col="grey",border="grey90")
>>> plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)
>>
>> You have already noticed that sf and stars, like raster and terra,
>> modify the assumptions of base plot methods, as
>> graphics::filled.contour(), unless some ordering and argument
>> conditions are met, crucially the non-base reset= argument. I do not
>> think that you can use layout() at all.
>>
>> library(stars)
>> nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
>> bir74_rast <- st_rasterize(nc["BIR74"])
>> plot(bir74_rast, reset=FALSE)
>> plot(st_geometry(nc),border="grey90", add=TRUE)
>> gridGraphics::grid.echo()
>> library(grid)
>> g <- grid.grab()
>> plot(nc["BIR74"])
>> gridGraphics::grid.echo()
>> gv <- grid.grab()
>> grid.newpage()
>> gridExtra::grid.arrange(g, gv, ncol=2)
>>
>> Grabbing the base graphics device state lets you use
>> gridExtra::grid.arrange() to place multiple graphics objects; here I
>> haven't tried to constrain aspect or relative sizes. I don't think
>> that the plot methods in sf and stars play well with layout, because
>> they use it themselves internally.
>>
>> Hope this helps,
>>
>> Roger
>>
>>>
>>> plot(mypoly,col=mypal(12),border=mypal(12))
>>>
>>> I expect that the first two plots display in region #1, the second
>>> added to the first, and the third plot in region #2. However, this is
>>> not what happens: actually, the third plot displays in region 1
>>> erasing the others. I understand that plot.stars when not "added"
>>> does not respect the layout definition (and displays its own
>>> regions), and that my problem comes from the way plot.stars deals
>>> with that.
>>>
>>> Has anyone an idea about a workaround ?
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7Cc67e7b9e4d6b43cb453c08da065345c7%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637829252131764014%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=IDZZmUAOMmrU8cwbsARqkHTry%2BA5v%2FWpB2JzEmEcc7U%3D&amp;reserved=0
>>>
>>>
>>
> 
> 	[[alternative HTML version deleted]]
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Tue Mar 15 16:23:20 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Tue, 15 Mar 2022 16:23:20 +0100
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <9c9fe669-845e-b5d1-e473-58ac82a6c379@uni-muenster.de>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
 <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
 <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
 <15d6b9d7-b319-a612-2b30-b0bd5db782cf@univ-fcomte.fr>
 <9c9fe669-845e-b5d1-e473-58ac82a6c379@uni-muenster.de>
Message-ID: <eb48bb9c-651d-be33-b854-691851920e79@univ-fcomte.fr>

Many thanks Edzer, I was fiddling in that direction... The ultimate aim 
is to draw a home-made legend in a separate area for a complex figure 
(several "add") without the key in the main figure...
Best,
Patrick

Le 15/03/2022 ? 16:02, Edzer Pebesma a ?crit?:
> In addition to what Roger wrote, you can use e.g.
>
> layout(matrix(1:4,2))
> library(stars)
> s = st_as_stars(L7_ETMs)
> image(s[,,,1])
> plot(s[,,,1], key.pos = NULL, reset = FALSE)
> plot(s[,,,1], key.pos = NULL, reset = FALSE, main = NULL)
>
> to fill the sub-plots of layout() incrementally. Note the key.pos and 
> reset arguments to plot.stars(): they make sure plot.stars doesn't 
> mess with the layout settings.
>
> On 15/03/2022 11:45, Patrick Giraudoux wrote:
>> Great ! Thanks Roger.? On this basis, I have a way to explore the issue
>> now. Will give a feed-back on the list once done.
>> Best,
>> Patrick
>>
>> Le 15/03/2022 ? 11:27, Roger Bivand a ?crit?:
>>> On Tue, 15 Mar 2022, Patrick Giraudoux wrote:
>>>
>>>> Hi,
>>>>
>>>> I have a trouble with the combination of layout and plot.stars. e.g.
>>>>
>>>> nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
>>>> layout.show(nf)
>>>>
>>>> plot(st_geometry(mydept),col="grey",border="grey90")
>>>> plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)
>>>
>>> You have already noticed that sf and stars, like raster and terra,
>>> modify the assumptions of base plot methods, as
>>> graphics::filled.contour(), unless some ordering and argument
>>> conditions are met, crucially the non-base reset= argument. I do not
>>> think that you can use layout() at all.
>>>
>>> library(stars)
>>> nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
>>> bir74_rast <- st_rasterize(nc["BIR74"])
>>> plot(bir74_rast, reset=FALSE)
>>> plot(st_geometry(nc),border="grey90", add=TRUE)
>>> gridGraphics::grid.echo()
>>> library(grid)
>>> g <- grid.grab()
>>> plot(nc["BIR74"])
>>> gridGraphics::grid.echo()
>>> gv <- grid.grab()
>>> grid.newpage()
>>> gridExtra::grid.arrange(g, gv, ncol=2)
>>>
>>> Grabbing the base graphics device state lets you use
>>> gridExtra::grid.arrange() to place multiple graphics objects; here I
>>> haven't tried to constrain aspect or relative sizes. I don't think
>>> that the plot methods in sf and stars play well with layout, because
>>> they use it themselves internally.
>>>
>>> Hope this helps,
>>>
>>> Roger
>>>
>>>>
>>>> plot(mypoly,col=mypal(12),border=mypal(12))
>>>>
>>>> I expect that the first two plots display in region #1, the second
>>>> added to the first, and the third plot in region #2. However, this is
>>>> not what happens: actually, the third plot displays in region 1
>>>> erasing the others. I understand that plot.stars when not "added"
>>>> does not respect the layout definition (and displays its own
>>>> regions), and that my problem comes from the way plot.stars deals
>>>> with that.
>>>>
>>>> Has anyone an idea about a workaround ?
>>>>
>>>> _______________________________________________
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org
>>>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7Cc67e7b9e4d6b43cb453c08da065345c7%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637829252131764014%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=IDZZmUAOMmrU8cwbsARqkHTry%2BA5v%2FWpB2JzEmEcc7U%3D&amp;reserved=0 
>>>>
>>>>
>>>>
>>>
>>
>> ????[[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Tue Mar 15 20:02:31 2022
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Tue, 15 Mar 2022 20:02:31 +0100
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <9c9fe669-845e-b5d1-e473-58ac82a6c379@uni-muenster.de>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
 <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
 <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
 <15d6b9d7-b319-a612-2b30-b0bd5db782cf@univ-fcomte.fr>
 <9c9fe669-845e-b5d1-e473-58ac82a6c379@uni-muenster.de>
Message-ID: <1748eda4-28f8-54bf-9aad-205fe4cfbb57@univ-fcomte.fr>

Coming back to the example which initiated the issue, I have found the 
trick following your hints Edzer, but it makes a strange rational. Here 
we go:

nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
layout.show(nf)

plot(st_geometry(mydept),col="grey",border="grey90")
plot(st_geometry(fzone1),col=mypal(12)[1],border=NA,add=TRUE)
plot(st_geometry(fzone2),col=mypal(12)[2],border=NA,add=TRUE)
plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",key.pos=NULL,reset=FALSE,add=TRUE)
plot(st_geometry(mydept),col=NA,border="grey90",add=TRUE)

mybox<-bbox2sf(n=0.5,s=0,w=0,e=10,crs=2154) # crs is just crap here, I 
do not need it thenafter
mypoly<-st_make_grid(mybox,n=c(12,1),what="polygons")
plot(mypoly,col=mypal(12),border=mypal(12))
plot(mybox,add=TRUE)

Makes exactly what I was intending to make. The critical point was to 
explicitely keep reset=FALSE in the 4th plot (actually a plot.stars). If 
not, the 6th plot is plotted in region #1 erasing the previous plots...

Some personal remarks:
- in the first plot, I ommited the argument reset=FALSE, however this 
does not make a problem (maybe because I just plot a geometry ?)
- the 4th plot is definitely strange with reset=FALSE and add=TRUE 
together, isn't it ?

Thanks Roger and Ezder for bailing me out once again... :-)
Patrick



Le 15/03/2022 ? 16:02, Edzer Pebesma a ?crit?:
> In addition to what Roger wrote, you can use e.g.
>
> layout(matrix(1:4,2))
> library(stars)
> s = st_as_stars(L7_ETMs)
> image(s[,,,1])
> plot(s[,,,1], key.pos = NULL, reset = FALSE)
> plot(s[,,,1], key.pos = NULL, reset = FALSE, main = NULL)
>
> to fill the sub-plots of layout() incrementally. Note the key.pos and 
> reset arguments to plot.stars(): they make sure plot.stars doesn't 
> mess with the layout settings.
>
> On 15/03/2022 11:45, Patrick Giraudoux wrote:
>> Great ! Thanks Roger.? On this basis, I have a way to explore the issue
>> now. Will give a feed-back on the list once done.
>> Best,
>> Patrick
>>
>> Le 15/03/2022 ? 11:27, Roger Bivand a ?crit?:
>>> On Tue, 15 Mar 2022, Patrick Giraudoux wrote:
>>>
>>>> Hi,
>>>>
>>>> I have a trouble with the combination of layout and plot.stars. e.g.
>>>>
>>>> nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
>>>> layout.show(nf)
>>>>
>>>> plot(st_geometry(mydept),col="grey",border="grey90")
>>>> plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)
>>>
>>> You have already noticed that sf and stars, like raster and terra,
>>> modify the assumptions of base plot methods, as
>>> graphics::filled.contour(), unless some ordering and argument
>>> conditions are met, crucially the non-base reset= argument. I do not
>>> think that you can use layout() at all.
>>>
>>> library(stars)
>>> nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
>>> bir74_rast <- st_rasterize(nc["BIR74"])
>>> plot(bir74_rast, reset=FALSE)
>>> plot(st_geometry(nc),border="grey90", add=TRUE)
>>> gridGraphics::grid.echo()
>>> library(grid)
>>> g <- grid.grab()
>>> plot(nc["BIR74"])
>>> gridGraphics::grid.echo()
>>> gv <- grid.grab()
>>> grid.newpage()
>>> gridExtra::grid.arrange(g, gv, ncol=2)
>>>
>>> Grabbing the base graphics device state lets you use
>>> gridExtra::grid.arrange() to place multiple graphics objects; here I
>>> haven't tried to constrain aspect or relative sizes. I don't think
>>> that the plot methods in sf and stars play well with layout, because
>>> they use it themselves internally.
>>>
>>> Hope this helps,
>>>
>>> Roger
>>>
>>>>
>>>> plot(mypoly,col=mypal(12),border=mypal(12))
>>>>
>>>> I expect that the first two plots display in region #1, the second
>>>> added to the first, and the third plot in region #2. However, this is
>>>> not what happens: actually, the third plot displays in region 1
>>>> erasing the others. I understand that plot.stars when not "added"
>>>> does not respect the layout definition (and displays its own
>>>> regions), and that my problem comes from the way plot.stars deals
>>>> with that.
>>>>
>>>> Has anyone an idea about a workaround ?
>>>>
>>>> _______________________________________________
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org
>>>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7Cc67e7b9e4d6b43cb453c08da065345c7%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637829252131764014%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=IDZZmUAOMmrU8cwbsARqkHTry%2BA5v%2FWpB2JzEmEcc7U%3D&amp;reserved=0 
>>>>
>>>>
>>>>
>>>
>>
>> ????[[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Tue Mar 15 21:06:57 2022
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Tue, 15 Mar 2022 21:06:57 +0100
Subject: [R-sig-Geo] layout and plot.stars
In-Reply-To: <1748eda4-28f8-54bf-9aad-205fe4cfbb57@univ-fcomte.fr>
References: <f8de7248-fe45-d0bd-7637-995cb8acc5b6@univ-fcomte.fr>
 <59e97236-5d94-e52-4769-206a7362b2ec@reclus2.nhh.no>
 <e37e29ab-4c13-ee3a-1c76-23a1dc38426f@univ-fcomte.fr>
 <fe4ca013-5717-55c9-0138-6469c72eb2b6@univ-fcomte.fr>
 <CAP8THHW9sV3TixouhOdAoXPE7aK0OOz=jrEMc1CQN8HAucCe5Q@mail.gmail.com>
 <64e419dc-7c10-3b85-2b19-414686473f6d@univ-fcomte.fr>
 <6dfcef59-8edd-6164-4c9d-5803ae2ed11e@univ-fcomte.fr>
 <3e504939-3ab3-b8ce-73ed-e013b9ea4440@reclus2.nhh.no>
 <15d6b9d7-b319-a612-2b30-b0bd5db782cf@univ-fcomte.fr>
 <9c9fe669-845e-b5d1-e473-58ac82a6c379@uni-muenster.de>
 <1748eda4-28f8-54bf-9aad-205fe4cfbb57@univ-fcomte.fr>
Message-ID: <409a0d3c-fd95-dc28-1ced-31eea28d9faf@uni-muenster.de>



On 15/03/2022 20:02, Patrick Giraudoux wrote:
> Coming back to the example which initiated the issue, I have found the 
> trick following your hints Edzer, but it makes a strange rational. Here 
> we go:
> 
> nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
> layout.show(nf)
> 
> plot(st_geometry(mydept),col="grey",border="grey90")
> plot(st_geometry(fzone1),col=mypal(12)[1],border=NA,add=TRUE)
> plot(st_geometry(fzone2),col=mypal(12)[2],border=NA,add=TRUE)
> plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",key.pos=NULL,reset=FALSE,add=TRUE)
> plot(st_geometry(mydept),col=NA,border="grey90",add=TRUE)
> 
> mybox<-bbox2sf(n=0.5,s=0,w=0,e=10,crs=2154) # crs is just crap here, I 
> do not need it thenafter
> mypoly<-st_make_grid(mybox,n=c(12,1),what="polygons")
> plot(mypoly,col=mypal(12),border=mypal(12))
> plot(mybox,add=TRUE)
> 
> Makes exactly what I was intending to make. The critical point was to 
> explicitely keep reset=FALSE in the 4th plot (actually a plot.stars). If 
> not, the 6th plot is plotted in region #1 erasing the previous plots...
> 
> Some personal remarks:
> - in the first plot, I ommited the argument reset=FALSE, however this 
> does not make a problem (maybe because I just plot a geometry ?)

Yes, see ?plot.sf : reset is only an argument for plot.sf, not plot.sfc_XXXX

> - the 4th plot is definitely strange with reset=FALSE and add=TRUE 
> together, isn't it ?

Can't see it - if you want me to look at it, please provide a reprex.

> 
> Thanks Roger and Ezder for bailing me out once again... :-)
> Patrick
> 
> 
> 
> Le 15/03/2022 ? 16:02, Edzer Pebesma a ?crit?:
>> In addition to what Roger wrote, you can use e.g.
>>
>> layout(matrix(1:4,2))
>> library(stars)
>> s = st_as_stars(L7_ETMs)
>> image(s[,,,1])
>> plot(s[,,,1], key.pos = NULL, reset = FALSE)
>> plot(s[,,,1], key.pos = NULL, reset = FALSE, main = NULL)
>>
>> to fill the sub-plots of layout() incrementally. Note the key.pos and 
>> reset arguments to plot.stars(): they make sure plot.stars doesn't 
>> mess with the layout settings.
>>
>> On 15/03/2022 11:45, Patrick Giraudoux wrote:
>>> Great ! Thanks Roger.? On this basis, I have a way to explore the issue
>>> now. Will give a feed-back on the list once done.
>>> Best,
>>> Patrick
>>>
>>> Le 15/03/2022 ? 11:27, Roger Bivand a ?crit?:
>>>> On Tue, 15 Mar 2022, Patrick Giraudoux wrote:
>>>>
>>>>> Hi,
>>>>>
>>>>> I have a trouble with the combination of layout and plot.stars. e.g.
>>>>>
>>>>> nf <- layout(matrix(c(1,2),2,1,byrow = TRUE), c(3,3), c(3,1), TRUE)
>>>>> layout.show(nf)
>>>>>
>>>>> plot(st_geometry(mydept),col="grey",border="grey90")
>>>>> plot(st_rasterize(ztot),col=mypal(12),main="",breaks="equal",add=TRUE)
>>>>
>>>> You have already noticed that sf and stars, like raster and terra,
>>>> modify the assumptions of base plot methods, as
>>>> graphics::filled.contour(), unless some ordering and argument
>>>> conditions are met, crucially the non-base reset= argument. I do not
>>>> think that you can use layout() at all.
>>>>
>>>> library(stars)
>>>> nc <- st_read(system.file("gpkg/nc.gpkg", package="sf"))
>>>> bir74_rast <- st_rasterize(nc["BIR74"])
>>>> plot(bir74_rast, reset=FALSE)
>>>> plot(st_geometry(nc),border="grey90", add=TRUE)
>>>> gridGraphics::grid.echo()
>>>> library(grid)
>>>> g <- grid.grab()
>>>> plot(nc["BIR74"])
>>>> gridGraphics::grid.echo()
>>>> gv <- grid.grab()
>>>> grid.newpage()
>>>> gridExtra::grid.arrange(g, gv, ncol=2)
>>>>
>>>> Grabbing the base graphics device state lets you use
>>>> gridExtra::grid.arrange() to place multiple graphics objects; here I
>>>> haven't tried to constrain aspect or relative sizes. I don't think
>>>> that the plot methods in sf and stars play well with layout, because
>>>> they use it themselves internally.
>>>>
>>>> Hope this helps,
>>>>
>>>> Roger
>>>>
>>>>>
>>>>> plot(mypoly,col=mypal(12),border=mypal(12))
>>>>>
>>>>> I expect that the first two plots display in region #1, the second
>>>>> added to the first, and the third plot in region #2. However, this is
>>>>> not what happens: actually, the third plot displays in region 1
>>>>> erasing the others. I understand that plot.stars when not "added"
>>>>> does not respect the layout definition (and displays its own
>>>>> regions), and that my problem comes from the way plot.stars deals
>>>>> with that.
>>>>>
>>>>> Has anyone an idea about a workaround ?
>>>>>
>>>>> _______________________________________________
>>>>> R-sig-Geo mailing list
>>>>> R-sig-Geo at r-project.org
>>>>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&amp;data=04%7C01%7CRoger.Bivand%40nhh.no%7Cc67e7b9e4d6b43cb453c08da065345c7%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C637829252131764014%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&amp;sdata=IDZZmUAOMmrU8cwbsARqkHTry%2BA5v%2FWpB2JzEmEcc7U%3D&amp;reserved=0 
>>>>>
>>>>>
>>>>>
>>>>
>>>
>>> ????[[alternative HTML version deleted]]
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
> 

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081


From prmonk @end|ng |rom gm@||@com  Wed Mar 16 11:20:36 2022
From: prmonk @end|ng |rom gm@||@com (Philip Monk)
Date: Wed, 16 Mar 2022 10:20:36 +0000
Subject: [R-sig-Geo] Iterating through raster stack to map values +/- 1/2/3
 standard deviations from mean
Message-ID: <CAMVDa_7uC98Qs93-Z=W=m1_PXBK+CFdD9-Lu=dBcedeyAr65zg@mail.gmail.com>

I would like to create two stacks of raster images, each containing 12
images in total (one for each month over a one-year time period), then
process each image to:

*) display pixels which are 1/2/3 standard deviations from the mean (I
would amend and run the code several times to plot different values -
not all in one go)
*) add a mask to indicate the aoi
*) crop the image to the aoi
*) save each raster as an individual file.

The images are geoTIFFs created in and exported from Google Earth
Engine (GEE).  Each pixel is a calculated value of Land Surface
Temperature derived from Landsat 8 (Collection 2) scenes.  They are
identical in extent et al.

The mask is a shapefile exported from GEE.  it has the same extent but
a different crs.  The code below addresses that, but I have also used
QGIS to dissolve its geometry to create an outline (for the purposes
of indicating the aoi on the mapped data as its structure is not
relevant for this analysis).

At present I can process an individual image:

####

library(raster)
library(rgdal)

LST   <- raster("temperature.tif")
Mask  <- readOGR("mask.shp")

# For mask not modified in QGIS
crs(LST)
crs(Mask)
lst = projectRaster(LST, crs=crs(Mask))

plot(lst)
plot(Mask, add=TRUE)

masked <- mask(x = lst, mask = Mask, inverse=FALSE)
plot(masked)

cropped <- crop(masked, Mask)
plot(cropped)

# Calculate mean and sd
sdVal <- cellStats(cropped, "sd")
meanVal <- cellStats(cropped, "mean")

s <- cropped
s[which(s[] > (meanVal-sdVal)] <- NA # for example
plot(s)
plot(Mask, add=TRUE)

####

I can also create a stack:

####

#Load libraries
library(raster)

# List files
files <- list.files("...", pattern = "tif", full.names = TRUE)

# Create stack
siteStack <- raster::stack(files)

####

I cannot, however, work out how to iterate through the stack, and save
individual tifs.

One suggestion I've come across is to use a for loop:

####

# List all the files you want to work on
raster.files = dir(?/myfolder/my.raster.folder?)

for (i in 1:length(raster.files)){
                map = raster(raster.files[i]

# do some other stuff ?

# Save results as csv or write.raster() to save maps
}

####

I've seen elsewhere that you should avoid for loops and use lapply().

Either way, though I can find plenty of examples that process the
stack using raster::calc() to create a single output file, I can't get
anything to work that sequentially processes each image in isolation.
Stackoverflow, R4DS, the usual websites and blogs, even my
University's internal R help Slack group have all drawn a blank.
(Which I find a bit surprising - this doesn't feel like that
complicated or an unusual thing to do).

I've never written anything like this in R, so any help would be very welcome.

Thanks for your time,

Philip
Part-time PhD student, Lancaster Environment Centre, Lancaster University.


From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Thu Mar 17 01:58:24 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Thu, 17 Mar 2022 12:58:24 +1200
Subject: [R-sig-Geo] Importing xlsm & blinking circilemarkers
Message-ID: <CAH5tCz34XUQO7rOy_LWEAxdsuWQjC53w3yuF4wfBvWYiig6W7Q@mail.gmail.com>

 Hello sir/madam,

I have a macro-enabled excel file and wanted to import the data that this
file automatically grabs everytime the macro is run. Are there any packages
for macro-enabled excel?

I have written some codes using a leaflet package and was trying to set
criteria for circle markers that if the Rainfall value is in the ranges the
color of the markers would change and start blinking. Given for green
0-20mm, yellow - 20-30mm, orange- 30-50mm, red- >= 50mm.

Given below is the code and sample data
library(sf)
library(leaflet)

#Make Leaflet map with markers
leaflet() %>%
  addTiles() %>%
  addCircleMarkers(lat = rainfall$Latitude,
                   lng = rainfall$Longitude)

# Add Data for rainfall
col_pal <- colorNumeric(palette = "viridis",
                        domain = rainfall$rainfall)

#adding content to the popups
#Make map with colors with markers
Map<- leaflet() %>%
  addTiles() %>%
  addCircles(lat = Rainfall$Latitude,
           lng = Rainfall$Longitude,
           color = col_pal(Rainfall_plots$Rainfall),
           radius = 2000,
          fillOpacity = 0.8,
          label =  Rainfall_plots$rainfall) %>%
 addLegend(position = "bottomleft", pal = col_pal, values =
Rainfall_plots$rainfall, title = "Rainfall Indicator")

Map
********************************************************************************************************

The code is correct, some ideas to set up criterias for the rainfall amount
would really be appreciated. And possibly the codes as well would be really
wonderful. Also attached is the sample data in csv format

Thanking you in advance
Sownalc

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220317/42348da3/attachment.html>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: RainfalSample.csv
Type: application/vnd.ms-excel
Size: 859 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220317/42348da3/attachment.xlb>

From Roger@B|v@nd @end|ng |rom nhh@no  Fri Mar 18 14:47:25 2022
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Fri, 18 Mar 2022 14:47:25 +0100 (CET)
Subject: [R-sig-Geo] Importing xlsm & blinking circilemarkers
In-Reply-To: <CAH5tCz34XUQO7rOy_LWEAxdsuWQjC53w3yuF4wfBvWYiig6W7Q@mail.gmail.com>
References: <CAH5tCz34XUQO7rOy_LWEAxdsuWQjC53w3yuF4wfBvWYiig6W7Q@mail.gmail.com>
Message-ID: <be7a4156-5af3-5bc0-f7dc-d7df8b2c2c14@reclus2.nhh.no>

On Thu, 17 Mar 2022, sownal chand wrote:

> Hello sir/madam,
>
> I have a macro-enabled excel file and wanted to import the data that this
> file automatically grabs everytime the macro is run. Are there any packages
> for macro-enabled excel?

No idea, sounds like something for shiny, which I avoid. Interactive 
graphics are very hard to do right at the best of times.

>
> I have written some codes using a leaflet package and was trying to set
> criteria for circle markers that if the Rainfall value is in the ranges the
> color of the markers would change and start blinking. Given for green
> 0-20mm, yellow - 20-30mm, orange- 30-50mm, red- >= 50mm.
>

library(sf)
rainfall <- st_as_sf(read.csv("RainfalSample.csv"), coords=c("Long",
  "Lat"), crs="OGC:CRS84")
library(tmap)
tmap_mode("view")
tm_shape(rainfall) + tm_symbols(size=0.0025, col="Rainfall.mm.",
  style="fixed", breaks=c(0, 20, 30, 50, Inf), pal=c("green", "yellow",
  "orange", "red"))

may be fairly close. tmap is a package using leaflet internally, mapview 
is another such package. Many of the symbols overlap, so are not very 
legible.

Hope this helps,

Roger

> Given below is the code and sample data
> library(sf)
> library(leaflet)
>
> #Make Leaflet map with markers
> leaflet() %>%
>  addTiles() %>%
>  addCircleMarkers(lat = rainfall$Latitude,
>                   lng = rainfall$Longitude)
>
> # Add Data for rainfall
> col_pal <- colorNumeric(palette = "viridis",
>                        domain = rainfall$rainfall)
>
> #adding content to the popups
> #Make map with colors with markers
> Map<- leaflet() %>%
>  addTiles() %>%
>  addCircles(lat = Rainfall$Latitude,
>           lng = Rainfall$Longitude,
>           color = col_pal(Rainfall_plots$Rainfall),
>           radius = 2000,
>          fillOpacity = 0.8,
>          label =  Rainfall_plots$rainfall) %>%
> addLegend(position = "bottomleft", pal = col_pal, values =
> Rainfall_plots$rainfall, title = "Rainfall Indicator")
>
> Map
> ********************************************************************************************************
>
> The code is correct, some ideas to set up criterias for the rainfall amount
> would really be appreciated. And possibly the codes as well would be really
> wonderful. Also attached is the sample data in csv format
>
> Thanking you in advance
> Sownalc
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Fri Mar 18 23:23:50 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Sat, 19 Mar 2022 10:23:50 +1200
Subject: [R-sig-Geo] Importing xlsm & blinking circilemarkers
In-Reply-To: <be7a4156-5af3-5bc0-f7dc-d7df8b2c2c14@reclus2.nhh.no>
References: <CAH5tCz34XUQO7rOy_LWEAxdsuWQjC53w3yuF4wfBvWYiig6W7Q@mail.gmail.com>
 <be7a4156-5af3-5bc0-f7dc-d7df8b2c2c14@reclus2.nhh.no>
Message-ID: <CAH5tCz2Xxt=g3Sz2p0cA6F31fYb1sckHK-rtkrFjt3+TmVSLKg@mail.gmail.com>

Hi Roger

Thanks for your help and support.

Have a blessed weekend
Sownalc

On Sat, Mar 19, 2022, 01:47 Roger Bivand <Roger.Bivand at nhh.no> wrote:

> On Thu, 17 Mar 2022, sownal chand wrote:
>
> > Hello sir/madam,
> >
> > I have a macro-enabled excel file and wanted to import the data that this
> > file automatically grabs everytime the macro is run. Are there any
> packages
> > for macro-enabled excel?
>
> No idea, sounds like something for shiny, which I avoid. Interactive
> graphics are very hard to do right at the best of times.
>
> >
> > I have written some codes using a leaflet package and was trying to set
> > criteria for circle markers that if the Rainfall value is in the ranges
> the
> > color of the markers would change and start blinking. Given for green
> > 0-20mm, yellow - 20-30mm, orange- 30-50mm, red- >= 50mm.
> >
>
> library(sf)
> rainfall <- st_as_sf(read.csv("RainfalSample.csv"), coords=c("Long",
>   "Lat"), crs="OGC:CRS84")
> library(tmap)
> tmap_mode("view")
> tm_shape(rainfall) + tm_symbols(size=0.0025, col="Rainfall.mm.",
>   style="fixed", breaks=c(0, 20, 30, 50, Inf), pal=c("green", "yellow",
>   "orange", "red"))
>
> may be fairly close. tmap is a package using leaflet internally, mapview
> is another such package. Many of the symbols overlap, so are not very
> legible.
>
> Hope this helps,
>
> Roger
>
> > Given below is the code and sample data
> > library(sf)
> > library(leaflet)
> >
> > #Make Leaflet map with markers
> > leaflet() %>%
> >  addTiles() %>%
> >  addCircleMarkers(lat = rainfall$Latitude,
> >                   lng = rainfall$Longitude)
> >
> > # Add Data for rainfall
> > col_pal <- colorNumeric(palette = "viridis",
> >                        domain = rainfall$rainfall)
> >
> > #adding content to the popups
> > #Make map with colors with markers
> > Map<- leaflet() %>%
> >  addTiles() %>%
> >  addCircles(lat = Rainfall$Latitude,
> >           lng = Rainfall$Longitude,
> >           color = col_pal(Rainfall_plots$Rainfall),
> >           radius = 2000,
> >          fillOpacity = 0.8,
> >          label =  Rainfall_plots$rainfall) %>%
> > addLegend(position = "bottomleft", pal = col_pal, values =
> > Rainfall_plots$rainfall, title = "Rainfall Indicator")
> >
> > Map
> >
> ********************************************************************************************************
> >
> > The code is correct, some ideas to set up criterias for the rainfall
> amount
> > would really be appreciated. And possibly the codes as well would be
> really
> > wonderful. Also attached is the sample data in csv format
> >
> > Thanking you in advance
> > Sownalc
> >
>
> --
> Roger Bivand
> Emeritus Professor
> Department of Economics, Norwegian School of Economics,
> Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
> e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>

	[[alternative HTML version deleted]]


From t@v|b@r @end|ng |rom gm@||@com  Sun Mar 20 16:50:55 2022
From: t@v|b@r @end|ng |rom gm@||@com (Micha Silver)
Date: Sun, 20 Mar 2022 17:50:55 +0200
Subject: [R-sig-Geo] 
 Iterating through raster stack to map values +/- 1/2/3
 standard deviations from mean
In-Reply-To: <CAMVDa_7uC98Qs93-Z=W=m1_PXBK+CFdD9-Lu=dBcedeyAr65zg@mail.gmail.com>
References: <CAMVDa_7uC98Qs93-Z=W=m1_PXBK+CFdD9-Lu=dBcedeyAr65zg@mail.gmail.com>
Message-ID: <e270ec06-dc0b-d3d4-e295-03ada7527fb6@gmail.com>

An HTML attachment was scrubbed...
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220320/4620015d/attachment.html>

From mguzm@nn89 @end|ng |rom gm@||@com  Wed Mar 23 21:32:28 2022
From: mguzm@nn89 @end|ng |rom gm@||@com (=?UTF-8?Q?Mat=C3=ADas_Guzm=C3=A1n_Naranjo?=)
Date: Wed, 23 Mar 2022 21:32:28 +0100
Subject: [R-sig-Geo] Question about gdistance
Message-ID: <CAEXSTaVLWfC23-_pDi-YhQXc9QTHyawCuX2a7kDtJ0DL1NnZhg@mail.gmail.com>

Dear all,

I am trying to build topographic distances with gdistance (following the
method used in the topoDistance package). I am struggling with one issue
though.
I want to get topo distances between points in a raster but forcing the
paths taken to prefer waterways when possible.

Getting the actual paths is relatively straightforward, I create a surface
with the same approach as here
<https://github.com/ianjwang/topoDistance/blob/master/R/topoSurface.R> but
changing:

h.dist <- gdistance::transition(DEM, transitionFunction = function(x){1},
directions = directions, symm = TRUE)

To:

h.dist <- gdistance::transition(DEM, transitionFunction = function(x){
                          if((x[1]==0) & (x[2]==0)) 2
                          else 1
                      }, directions = 8, symm = TRUE)

(assuming 0 represents waterways in the DEM). I can then use the surface to
compute the paths and the distances.

That way, the path taken tries to take a waterway whenever possible.
However, this affects the actual distance that is computed. If I change the
'2' to, say, '3', the paths are identical but the distances become smaller.

Is there a way to solve this issue?

Thanks a lot!

	[[alternative HTML version deleted]]


From @own@|ch@nd|m@ @end|ng |rom gm@||@com  Wed Mar 30 02:09:44 2022
From: @own@|ch@nd|m@ @end|ng |rom gm@||@com (sownal chand)
Date: Wed, 30 Mar 2022 12:09:44 +1200
Subject: [R-sig-Geo] Contour plot
Message-ID: <CAH5tCz28gDZycXe1WUUQwbkgZVjinKOB+uPru=CZVkLAHw8tpg@mail.gmail.com>

Hello sir/madam,

I have been writing codes using R and was trying to overlay contour lines
on the map using the data set provided in the attachment. The code which I
am working on is attached below. The problem is the overlay of the contours
is not showing in the final map. If someone can assist in correcting the
codes would be really appreciated .

 # Packages
#if (!require("rspatial")) remotes::install_github('rspatial/rspatial')
library(rspatial)
library(sp)
library(rgdal)
library(rgoes)
library(raster)
library(ggplot2)

# Fiji geo data
# download
#Draft map of Fiji
world <- rnaturalearth::ne_countries(scale = "Large", returnclass = "sf")

# map of Fiji Islands
Fiji <- ggplot(data=world) +
  geom_sf() +
  coord_sf(
    crs = 3832, # https://epsg.io/3832
    xlim = c(2984265.06, 3539584.72), # limits are taken from projected
bounds
    ylim = c(-2224162.41, -1811688.88)  # of EPSG:3832
  )+ theme_bw()

#Plot map of Fiji
Fiji

#read csv data from excel file for contoure analysis
data.Fdf <- read.csv("C://Users/Sownal/Documents/data.csv")
View(data.Fdf)
class(data.Fdf)

#remove NA values in the spatial Data Frame
data.dfclean <- na.omit(data.Fdf)
data.dfclean

data.dfclean$long <- as.numeric(data$Longitude)
data.dfclean$lat <- as.numeric(data$Latitude)

# convert data to spatial data fame for spatial analysis and raster analysis
data.FSP <- SpatialPointsDataFrame(data= data.dfclean, coords =
data.dfclean$lat, data.dfclean$long)
data.FSP
#select one years data and overlay contours on the Map of Fiji

Fiji <- ggplot(data=world) +
  geom_sf() +
  coord_sf(
    crs = 3832, # https://epsg.io/3832
    xlim = c(2984265.06, 3539584.72), # limits are taken from projected
bounds
    ylim = c(-2224162.41, -1811688.88)  # of EPSG:3832
  )+ theme_bw() + filled.contour(data.dfclean$Year)


# plot the map of Fiji with the contours lines
Fiji

******************************************************************************************************

Thanking you in advance
sownalc

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220330/63116f04/attachment.html>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: DataR.csv
Type: application/vnd.ms-excel
Size: 628 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20220330/63116f04/attachment.xlb>

