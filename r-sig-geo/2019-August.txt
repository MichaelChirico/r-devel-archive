From m||uj|@b @end|ng |rom gm@||@com  Thu Aug  1 10:12:02 2019
From: m||uj|@b @end|ng |rom gm@||@com (Miluji Sb)
Date: Thu, 1 Aug 2019 10:12:02 +0200
Subject: [R-sig-Geo] Convert data.frame/SpatialPointsDataFrame to raster
In-Reply-To: <CAMLwc7P7qzu+Cgx8FL6OHemfT6XawHo=QAAozL24T5w-6-sFYA@mail.gmail.com>
References: <CAMLwc7N9FGwF0rVB1eL1CGWpyUFU73B9tU7nQ2vE0_OamHrMZw@mail.gmail.com>
 <CAKkiGbs6D6ah3oGVWJWff9ihf3sr4zXbV263JBYBv_GcdjJzJw@mail.gmail.com>
 <CAMLwc7Nqer4HUBK_AoiFHvAsx=d+Md0EMhODBcrFDePVe6WRcA@mail.gmail.com>
 <CAKkiGbtOK6A80P7azAQMdt-aNdjXgJQDpnsP2jO76jx=TnOmCQ@mail.gmail.com>
 <CAMLwc7P7qzu+Cgx8FL6OHemfT6XawHo=QAAozL24T5w-6-sFYA@mail.gmail.com>
Message-ID: <CAMLwc7Oz2Orv+Uoix67Vh6K-gvJtjVC_pgbtp3Ato328ArVLjA@mail.gmail.com>

Dear Vijay,

Thank you again for your reply. I tried attaching my data for two years and
two variables but the message was rejected. I have saved the data on a
Google Drive folder here
<https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing>.
Hope this will work. Thanks again!

Sincerely,

Milu

On Thu, Aug 1, 2019 at 9:52 AM Miluji Sb <milujisb at gmail.com> wrote:

> Dear Vijay,
>
> Thank you again for your reply. I have attached my data for two years and
> two variables. Hope they will go through, otherwise the files are also
> available here
> <https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing>.
> Thanks again!
>
> Sincerely,
>
> Milu
>
> On Wed, Jul 31, 2019 at 10:46 PM Vijay Lulla <vijaylulla at gmail.com> wrote:
>
>> Hmm...I had seen your data and thought that it was just some sample that
>> you'd shared.  If this is your whole data then I don't know how to create a
>> raster from just one row that is returned from subsetting the dataframe.
>>
>> Sorry for the noise.
>>
>> On Wed, Jul 31, 2019 at 4:16 PM Miluji Sb <milujisb at gmail.com> wrote:
>>
>>> Hello,
>>>
>>> Thank you for your kind reply.  Here is a snapshot of the original data.
>>> I had pasted it at the bottom of my first email but forgot to mention it.
>>> Thanks again!
>>>
>>> df <- structure(list(lon = c(180, 179.762810919291, 179.523658017568,
>>> 179.311342656601, 179.067616041778, 178.851382109362, 178.648816406322,
>>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
>>> c(-16.1529296875,
>>> -16.21659020822, -16.266117894201, -16.393550535614, -16.4457378034442,
>>> -16.561653799838, -16.6533087696649, -16.7741069281329,
>>> -16.914110607613,
>>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
>>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
>>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
>>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
>>> 2.16767864033646,
>>> 2.16881240361846, 2.20727073247015, 2.27771608519709, 2.3649601141941,
>>> 2.44210984856767, 2.52466349543977, 2.63982954290745, 2.71828906773926
>>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
>>> 2.53057109758284, 2.61391337469939, 2.71040967066483, 2.82546443373866,
>>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
>>> c(2.63753852023063,
>>> 2.7080249053612, 2.75483681166049, 2.86893038433795, 2.97758282474101,
>>> 3.14541928966618, 3.3986143008625, 3.68043269045659, 4.09571655859075,
>>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
>>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class = "data.frame")
>>>
>>> Sincerely,
>>>
>>> Milu
>>>
>>> On Wed, Jul 31, 2019 at 9:20 PM Vijay Lulla <vijaylulla at gmail.com>
>>> wrote:
>>>
>>>> ?`rasterFromXYZ` states that "x and y represent spatial coordinates and
>>>> must be on a regular grid."  And, it appears to me that you might be losing
>>>> values by rounding lon/lat values.  The help file further suggests that
>>>> `rasterize` might be the function you're looking for.  List members will
>>>> (certainly I will) find it more helpful to propose other solutions if you
>>>> post a small reproducible example of your original georeferenced dataset so
>>>> that we get an idea of what data you're using.
>>>>
>>>> Sorry, I cannot be of more help.
>>>>
>>>> On Wed, Jul 31, 2019 at 10:45 AM Miluji Sb <milujisb at gmail.com> wrote:
>>>>
>>>>> Dear all,
>>>>>
>>>>> I have georeferenced dataset with multiple variables and years. The
>>>>> data is
>>>>> at ~100 km (1? ? 1?) spatial resolution. I would like to convert this
>>>>> into
>>>>> a raster.
>>>>>
>>>>> I have filtered the data for one year and one variable and did the
>>>>> following;
>>>>>
>>>>> try <- subset(df, year==2010)
>>>>> try <- try[,c(1,2,4)]
>>>>> try$lon <- round(try$lon)
>>>>> try$lat <- round(try$lat)
>>>>> r_imp <- rasterFromXYZ(try)
>>>>>
>>>>> Two issues; is it possible to convert the original dataset with the
>>>>> multiple variables and years to a raster? If not, how can I avoid
>>>>> rounding
>>>>> the coordinates? Currently, I get this error "Error in
>>>>> rasterFromXYZ(try) :
>>>>> x cell sizes are not regular" without rounding.
>>>>>
>>>>> Any help will be greatly appreciated. Thank you!
>>>>>
>>>>> Sincerely,
>>>>>
>>>>> Shouro
>>>>>
>>>>> ## Data
>>>>> df <- structure(list(lon = c(180, 179.762810919291, 179.523658017568,
>>>>> 179.311342656601, 179.067616041778, 178.851382109362, 178.648816406322,
>>>>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
>>>>> c(-16.1529296875,
>>>>> -16.21659020822, -16.266117894201, -16.393550535614, -16.4457378034442,
>>>>> -16.561653799838, -16.6533087696649, -16.7741069281329,
>>>>> -16.914110607613,
>>>>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
>>>>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
>>>>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
>>>>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
>>>>> 2.16767864033646,
>>>>> 2.16881240361846, 2.20727073247015, 2.27771608519709, 2.3649601141941,
>>>>> 2.44210984856767, 2.52466349543977, 2.63982954290745, 2.71828906773926
>>>>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
>>>>> 2.53057109758284, 2.61391337469939, 2.71040967066483, 2.82546443373866,
>>>>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
>>>>> c(2.63753852023063,
>>>>> 2.7080249053612, 2.75483681166049, 2.86893038433795, 2.97758282474101,
>>>>> 3.14541928966618, 3.3986143008625, 3.68043269045659, 4.09571655859075,
>>>>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
>>>>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class = "data.frame")
>>>>>
>>>>>         [[alternative HTML version deleted]]
>>>>>
>>>>> _______________________________________________
>>>>> R-sig-Geo mailing list
>>>>> R-sig-Geo at r-project.org
>>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>>
>>>>
>>>>
>>>>
>>

	[[alternative HTML version deleted]]


From hugo@gco@t@ @end|ng |rom gm@||@com  Thu Aug  1 10:43:52 2019
From: hugo@gco@t@ @end|ng |rom gm@||@com (Hugo Costa)
Date: Thu, 1 Aug 2019 09:43:52 +0100
Subject: [R-sig-Geo] Convert data.frame/SpatialPointsDataFrame to raster
In-Reply-To: <CAMLwc7Oz2Orv+Uoix67Vh6K-gvJtjVC_pgbtp3Ato328ArVLjA@mail.gmail.com>
References: <CAMLwc7N9FGwF0rVB1eL1CGWpyUFU73B9tU7nQ2vE0_OamHrMZw@mail.gmail.com>
 <CAKkiGbs6D6ah3oGVWJWff9ihf3sr4zXbV263JBYBv_GcdjJzJw@mail.gmail.com>
 <CAMLwc7Nqer4HUBK_AoiFHvAsx=d+Md0EMhODBcrFDePVe6WRcA@mail.gmail.com>
 <CAKkiGbtOK6A80P7azAQMdt-aNdjXgJQDpnsP2jO76jx=TnOmCQ@mail.gmail.com>
 <CAMLwc7P7qzu+Cgx8FL6OHemfT6XawHo=QAAozL24T5w-6-sFYA@mail.gmail.com>
 <CAMLwc7Oz2Orv+Uoix67Vh6K-gvJtjVC_pgbtp3Ato328ArVLjA@mail.gmail.com>
Message-ID: <CADvFi5pgJmCc_PGVVDH7Q4R8NgZTPREeirJo1tQCKOgtG0C0TA@mail.gmail.com>

Dear Milu,

the best I can suggest is something like this.

library(raster)
df<-read.csv("path/to/data/downloaded/from/GoogleDrive")
try <- subset(df, year==2010)

sp<-SpatialPointsDataFrame(try[,1:2],data=try, proj4string =
CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))

r<-rasterize(sp, y=raster(), field=try$TWL_5, fun=mean, background=NA)
plot(r)

Hope this helps somehow
Good luck
Hugo

Miluji Sb <milujisb at gmail.com> escreveu no dia quinta, 1/08/2019 ?(s) 09:13:

> Dear Vijay,
>
> Thank you again for your reply. I tried attaching my data for two years and
> two variables but the message was rejected. I have saved the data on a
> Google Drive folder here
> <
> https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing
> >.
> Hope this will work. Thanks again!
>
> Sincerely,
>
> Milu
>
> On Thu, Aug 1, 2019 at 9:52 AM Miluji Sb <milujisb at gmail.com> wrote:
>
> > Dear Vijay,
> >
> > Thank you again for your reply. I have attached my data for two years and
> > two variables. Hope they will go through, otherwise the files are also
> > available here
> > <
> https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing
> >.
> > Thanks again!
> >
> > Sincerely,
> >
> > Milu
> >
> > On Wed, Jul 31, 2019 at 10:46 PM Vijay Lulla <vijaylulla at gmail.com>
> wrote:
> >
> >> Hmm...I had seen your data and thought that it was just some sample that
> >> you'd shared.  If this is your whole data then I don't know how to
> create a
> >> raster from just one row that is returned from subsetting the dataframe.
> >>
> >> Sorry for the noise.
> >>
> >> On Wed, Jul 31, 2019 at 4:16 PM Miluji Sb <milujisb at gmail.com> wrote:
> >>
> >>> Hello,
> >>>
> >>> Thank you for your kind reply.  Here is a snapshot of the original
> data.
> >>> I had pasted it at the bottom of my first email but forgot to mention
> it.
> >>> Thanks again!
> >>>
> >>> df <- structure(list(lon = c(180, 179.762810919291, 179.523658017568,
> >>> 179.311342656601, 179.067616041778, 178.851382109362, 178.648816406322,
> >>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
> >>> c(-16.1529296875,
> >>> -16.21659020822, -16.266117894201, -16.393550535614, -16.4457378034442,
> >>> -16.561653799838, -16.6533087696649, -16.7741069281329,
> >>> -16.914110607613,
> >>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
> >>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
> >>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
> >>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
> >>> 2.16767864033646,
> >>> 2.16881240361846, 2.20727073247015, 2.27771608519709, 2.3649601141941,
> >>> 2.44210984856767, 2.52466349543977, 2.63982954290745, 2.71828906773926
> >>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
> >>> 2.53057109758284, 2.61391337469939, 2.71040967066483, 2.82546443373866,
> >>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
> >>> c(2.63753852023063,
> >>> 2.7080249053612, 2.75483681166049, 2.86893038433795, 2.97758282474101,
> >>> 3.14541928966618, 3.3986143008625, 3.68043269045659, 4.09571655859075,
> >>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
> >>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class = "data.frame")
> >>>
> >>> Sincerely,
> >>>
> >>> Milu
> >>>
> >>> On Wed, Jul 31, 2019 at 9:20 PM Vijay Lulla <vijaylulla at gmail.com>
> >>> wrote:
> >>>
> >>>> ?`rasterFromXYZ` states that "x and y represent spatial coordinates
> and
> >>>> must be on a regular grid."  And, it appears to me that you might be
> losing
> >>>> values by rounding lon/lat values.  The help file further suggests
> that
> >>>> `rasterize` might be the function you're looking for.  List members
> will
> >>>> (certainly I will) find it more helpful to propose other solutions if
> you
> >>>> post a small reproducible example of your original georeferenced
> dataset so
> >>>> that we get an idea of what data you're using.
> >>>>
> >>>> Sorry, I cannot be of more help.
> >>>>
> >>>> On Wed, Jul 31, 2019 at 10:45 AM Miluji Sb <milujisb at gmail.com>
> wrote:
> >>>>
> >>>>> Dear all,
> >>>>>
> >>>>> I have georeferenced dataset with multiple variables and years. The
> >>>>> data is
> >>>>> at ~100 km (1? ? 1?) spatial resolution. I would like to convert this
> >>>>> into
> >>>>> a raster.
> >>>>>
> >>>>> I have filtered the data for one year and one variable and did the
> >>>>> following;
> >>>>>
> >>>>> try <- subset(df, year==2010)
> >>>>> try <- try[,c(1,2,4)]
> >>>>> try$lon <- round(try$lon)
> >>>>> try$lat <- round(try$lat)
> >>>>> r_imp <- rasterFromXYZ(try)
> >>>>>
> >>>>> Two issues; is it possible to convert the original dataset with the
> >>>>> multiple variables and years to a raster? If not, how can I avoid
> >>>>> rounding
> >>>>> the coordinates? Currently, I get this error "Error in
> >>>>> rasterFromXYZ(try) :
> >>>>> x cell sizes are not regular" without rounding.
> >>>>>
> >>>>> Any help will be greatly appreciated. Thank you!
> >>>>>
> >>>>> Sincerely,
> >>>>>
> >>>>> Shouro
> >>>>>
> >>>>> ## Data
> >>>>> df <- structure(list(lon = c(180, 179.762810919291, 179.523658017568,
> >>>>> 179.311342656601, 179.067616041778, 178.851382109362,
> 178.648816406322,
> >>>>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
> >>>>> c(-16.1529296875,
> >>>>> -16.21659020822, -16.266117894201, -16.393550535614,
> -16.4457378034442,
> >>>>> -16.561653799838, -16.6533087696649, -16.7741069281329,
> >>>>> -16.914110607613,
> >>>>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
> >>>>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
> >>>>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
> >>>>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
> >>>>> 2.16767864033646,
> >>>>> 2.16881240361846, 2.20727073247015, 2.27771608519709,
> 2.3649601141941,
> >>>>> 2.44210984856767, 2.52466349543977, 2.63982954290745,
> 2.71828906773926
> >>>>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
> >>>>> 2.53057109758284, 2.61391337469939, 2.71040967066483,
> 2.82546443373866,
> >>>>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
> >>>>> c(2.63753852023063,
> >>>>> 2.7080249053612, 2.75483681166049, 2.86893038433795,
> 2.97758282474101,
> >>>>> 3.14541928966618, 3.3986143008625, 3.68043269045659,
> 4.09571655859075,
> >>>>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
> >>>>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class =
> "data.frame")
> >>>>>
> >>>>>         [[alternative HTML version deleted]]
> >>>>>
> >>>>> _______________________________________________
> >>>>> R-sig-Geo mailing list
> >>>>> R-sig-Geo at r-project.org
> >>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>>>>
> >>>>
> >>>>
> >>>>
> >>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From v|j@y|u||@ @end|ng |rom gm@||@com  Thu Aug  1 17:12:24 2019
From: v|j@y|u||@ @end|ng |rom gm@||@com (Vijay Lulla)
Date: Thu, 1 Aug 2019 11:12:24 -0400
Subject: [R-sig-Geo] Convert data.frame/SpatialPointsDataFrame to raster
In-Reply-To: <CADvFi5pgJmCc_PGVVDH7Q4R8NgZTPREeirJo1tQCKOgtG0C0TA@mail.gmail.com>
References: <CAMLwc7N9FGwF0rVB1eL1CGWpyUFU73B9tU7nQ2vE0_OamHrMZw@mail.gmail.com>
 <CAKkiGbs6D6ah3oGVWJWff9ihf3sr4zXbV263JBYBv_GcdjJzJw@mail.gmail.com>
 <CAMLwc7Nqer4HUBK_AoiFHvAsx=d+Md0EMhODBcrFDePVe6WRcA@mail.gmail.com>
 <CAKkiGbtOK6A80P7azAQMdt-aNdjXgJQDpnsP2jO76jx=TnOmCQ@mail.gmail.com>
 <CAMLwc7P7qzu+Cgx8FL6OHemfT6XawHo=QAAozL24T5w-6-sFYA@mail.gmail.com>
 <CAMLwc7Oz2Orv+Uoix67Vh6K-gvJtjVC_pgbtp3Ato328ArVLjA@mail.gmail.com>
 <CADvFi5pgJmCc_PGVVDH7Q4R8NgZTPREeirJo1tQCKOgtG0C0TA@mail.gmail.com>
Message-ID: <CAKkiGbuS2cqenEVhf1+CM42-swQUUo4qpW=Z_50s3qKskGtugg@mail.gmail.com>

I second Hugo's suggestion.  IMO, since your points are not a regular grid
you will be unable to use `rasterXYZ`.  The only thing I would add to
Hugo's answers is that you can set the number of rows/cols that you wish in
your final raster by setting various args in the raster function.
example(rasterize) has some good examples.
HTH,
Vijay.

On Thu, Aug 1, 2019 at 4:44 AM Hugo Costa <hugoagcosta at gmail.com> wrote:

> Dear Milu,
>
> the best I can suggest is something like this.
>
> library(raster)
> df<-read.csv("path/to/data/downloaded/from/GoogleDrive")
> try <- subset(df, year==2010)
>
> sp<-SpatialPointsDataFrame(try[,1:2],data=try, proj4string =
> CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
>
> r<-rasterize(sp, y=raster(), field=try$TWL_5, fun=mean, background=NA)
> plot(r)
>
> Hope this helps somehow
> Good luck
> Hugo
>
> Miluji Sb <milujisb at gmail.com> escreveu no dia quinta, 1/08/2019 ?(s)
> 09:13:
>
>> Dear Vijay,
>>
>> Thank you again for your reply. I tried attaching my data for two years
>> and
>> two variables but the message was rejected. I have saved the data on a
>> Google Drive folder here
>> <
>> https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing
>> >.
>> Hope this will work. Thanks again!
>>
>> Sincerely,
>>
>> Milu
>>
>> On Thu, Aug 1, 2019 at 9:52 AM Miluji Sb <milujisb at gmail.com> wrote:
>>
>> > Dear Vijay,
>> >
>> > Thank you again for your reply. I have attached my data for two years
>> and
>> > two variables. Hope they will go through, otherwise the files are also
>> > available here
>> > <
>> https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing
>> >.
>> > Thanks again!
>> >
>> > Sincerely,
>> >
>> > Milu
>> >
>> > On Wed, Jul 31, 2019 at 10:46 PM Vijay Lulla <vijaylulla at gmail.com>
>> wrote:
>> >
>> >> Hmm...I had seen your data and thought that it was just some sample
>> that
>> >> you'd shared.  If this is your whole data then I don't know how to
>> create a
>> >> raster from just one row that is returned from subsetting the
>> dataframe.
>> >>
>> >> Sorry for the noise.
>> >>
>> >> On Wed, Jul 31, 2019 at 4:16 PM Miluji Sb <milujisb at gmail.com> wrote:
>> >>
>> >>> Hello,
>> >>>
>> >>> Thank you for your kind reply.  Here is a snapshot of the original
>> data.
>> >>> I had pasted it at the bottom of my first email but forgot to mention
>> it.
>> >>> Thanks again!
>> >>>
>> >>> df <- structure(list(lon = c(180, 179.762810919291, 179.523658017568,
>> >>> 179.311342656601, 179.067616041778, 178.851382109362,
>> 178.648816406322,
>> >>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
>> >>> c(-16.1529296875,
>> >>> -16.21659020822, -16.266117894201, -16.393550535614,
>> -16.4457378034442,
>> >>> -16.561653799838, -16.6533087696649, -16.7741069281329,
>> >>> -16.914110607613,
>> >>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
>> >>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
>> >>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
>> >>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
>> >>> 2.16767864033646,
>> >>> 2.16881240361846, 2.20727073247015, 2.27771608519709, 2.3649601141941,
>> >>> 2.44210984856767, 2.52466349543977, 2.63982954290745, 2.71828906773926
>> >>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
>> >>> 2.53057109758284, 2.61391337469939, 2.71040967066483,
>> 2.82546443373866,
>> >>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
>> >>> c(2.63753852023063,
>> >>> 2.7080249053612, 2.75483681166049, 2.86893038433795, 2.97758282474101,
>> >>> 3.14541928966618, 3.3986143008625, 3.68043269045659, 4.09571655859075,
>> >>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
>> >>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class =
>> "data.frame")
>> >>>
>> >>> Sincerely,
>> >>>
>> >>> Milu
>> >>>
>> >>> On Wed, Jul 31, 2019 at 9:20 PM Vijay Lulla <vijaylulla at gmail.com>
>> >>> wrote:
>> >>>
>> >>>> ?`rasterFromXYZ` states that "x and y represent spatial coordinates
>> and
>> >>>> must be on a regular grid."  And, it appears to me that you might be
>> losing
>> >>>> values by rounding lon/lat values.  The help file further suggests
>> that
>> >>>> `rasterize` might be the function you're looking for.  List members
>> will
>> >>>> (certainly I will) find it more helpful to propose other solutions
>> if you
>> >>>> post a small reproducible example of your original georeferenced
>> dataset so
>> >>>> that we get an idea of what data you're using.
>> >>>>
>> >>>> Sorry, I cannot be of more help.
>> >>>>
>> >>>> On Wed, Jul 31, 2019 at 10:45 AM Miluji Sb <milujisb at gmail.com>
>> wrote:
>> >>>>
>> >>>>> Dear all,
>> >>>>>
>> >>>>> I have georeferenced dataset with multiple variables and years. The
>> >>>>> data is
>> >>>>> at ~100 km (1? ? 1?) spatial resolution. I would like to convert
>> this
>> >>>>> into
>> >>>>> a raster.
>> >>>>>
>> >>>>> I have filtered the data for one year and one variable and did the
>> >>>>> following;
>> >>>>>
>> >>>>> try <- subset(df, year==2010)
>> >>>>> try <- try[,c(1,2,4)]
>> >>>>> try$lon <- round(try$lon)
>> >>>>> try$lat <- round(try$lat)
>> >>>>> r_imp <- rasterFromXYZ(try)
>> >>>>>
>> >>>>> Two issues; is it possible to convert the original dataset with the
>> >>>>> multiple variables and years to a raster? If not, how can I avoid
>> >>>>> rounding
>> >>>>> the coordinates? Currently, I get this error "Error in
>> >>>>> rasterFromXYZ(try) :
>> >>>>> x cell sizes are not regular" without rounding.
>> >>>>>
>> >>>>> Any help will be greatly appreciated. Thank you!
>> >>>>>
>> >>>>> Sincerely,
>> >>>>>
>> >>>>> Shouro
>> >>>>>
>> >>>>> ## Data
>> >>>>> df <- structure(list(lon = c(180, 179.762810919291,
>> 179.523658017568,
>> >>>>> 179.311342656601, 179.067616041778, 178.851382109362,
>> 178.648816406322,
>> >>>>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
>> >>>>> c(-16.1529296875,
>> >>>>> -16.21659020822, -16.266117894201, -16.393550535614,
>> -16.4457378034442,
>> >>>>> -16.561653799838, -16.6533087696649, -16.7741069281329,
>> >>>>> -16.914110607613,
>> >>>>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
>> >>>>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
>> >>>>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
>> >>>>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
>> >>>>> 2.16767864033646,
>> >>>>> 2.16881240361846, 2.20727073247015, 2.27771608519709,
>> 2.3649601141941,
>> >>>>> 2.44210984856767, 2.52466349543977, 2.63982954290745,
>> 2.71828906773926
>> >>>>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
>> >>>>> 2.53057109758284, 2.61391337469939, 2.71040967066483,
>> 2.82546443373866,
>> >>>>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
>> >>>>> c(2.63753852023063,
>> >>>>> 2.7080249053612, 2.75483681166049, 2.86893038433795,
>> 2.97758282474101,
>> >>>>> 3.14541928966618, 3.3986143008625, 3.68043269045659,
>> 4.09571655859075,
>> >>>>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
>> >>>>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class =
>> "data.frame")
>> >>>>>
>> >>>>>         [[alternative HTML version deleted]]
>> >>>>>
>> >>>>> _______________________________________________
>> >>>>> R-sig-Geo mailing list
>> >>>>> R-sig-Geo at r-project.org
>> >>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>> >>>>>
>> >>>>
>> >>>>
>> >>>>
>> >>
>>
>>         [[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>

	[[alternative HTML version deleted]]


From m||uj|@b @end|ng |rom gm@||@com  Thu Aug  1 19:54:50 2019
From: m||uj|@b @end|ng |rom gm@||@com (Miluji Sb)
Date: Thu, 1 Aug 2019 19:54:50 +0200
Subject: [R-sig-Geo] Convert data.frame/SpatialPointsDataFrame to raster
In-Reply-To: <CAKkiGbuS2cqenEVhf1+CM42-swQUUo4qpW=Z_50s3qKskGtugg@mail.gmail.com>
References: <CAMLwc7N9FGwF0rVB1eL1CGWpyUFU73B9tU7nQ2vE0_OamHrMZw@mail.gmail.com>
 <CAKkiGbs6D6ah3oGVWJWff9ihf3sr4zXbV263JBYBv_GcdjJzJw@mail.gmail.com>
 <CAMLwc7Nqer4HUBK_AoiFHvAsx=d+Md0EMhODBcrFDePVe6WRcA@mail.gmail.com>
 <CAKkiGbtOK6A80P7azAQMdt-aNdjXgJQDpnsP2jO76jx=TnOmCQ@mail.gmail.com>
 <CAMLwc7P7qzu+Cgx8FL6OHemfT6XawHo=QAAozL24T5w-6-sFYA@mail.gmail.com>
 <CAMLwc7Oz2Orv+Uoix67Vh6K-gvJtjVC_pgbtp3Ato328ArVLjA@mail.gmail.com>
 <CADvFi5pgJmCc_PGVVDH7Q4R8NgZTPREeirJo1tQCKOgtG0C0TA@mail.gmail.com>
 <CAKkiGbuS2cqenEVhf1+CM42-swQUUo4qpW=Z_50s3qKskGtugg@mail.gmail.com>
Message-ID: <CAMLwc7PvRdr6SyFBwQfEx0nEVot03v_iiMGo9QV-fm8xRF-diQ@mail.gmail.com>

Dear Vijay and Hugo,

Thank you very much for your help. I will look into setting the number
row/cols!

Sincerely,

Milu

On Thu, Aug 1, 2019 at 5:12 PM Vijay Lulla <vijaylulla at gmail.com> wrote:

> I second Hugo's suggestion.  IMO, since your points are not a regular grid
> you will be unable to use `rasterXYZ`.  The only thing I would add to
> Hugo's answers is that you can set the number of rows/cols that you wish in
> your final raster by setting various args in the raster function.
> example(rasterize) has some good examples.
> HTH,
> Vijay.
>
> On Thu, Aug 1, 2019 at 4:44 AM Hugo Costa <hugoagcosta at gmail.com> wrote:
>
>> Dear Milu,
>>
>> the best I can suggest is something like this.
>>
>> library(raster)
>> df<-read.csv("path/to/data/downloaded/from/GoogleDrive")
>> try <- subset(df, year==2010)
>>
>> sp<-SpatialPointsDataFrame(try[,1:2],data=try, proj4string =
>> CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
>>
>> r<-rasterize(sp, y=raster(), field=try$TWL_5, fun=mean, background=NA)
>> plot(r)
>>
>> Hope this helps somehow
>> Good luck
>> Hugo
>>
>> Miluji Sb <milujisb at gmail.com> escreveu no dia quinta, 1/08/2019 ?(s)
>> 09:13:
>>
>>> Dear Vijay,
>>>
>>> Thank you again for your reply. I tried attaching my data for two years
>>> and
>>> two variables but the message was rejected. I have saved the data on a
>>> Google Drive folder here
>>> <
>>> https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing
>>> >.
>>> Hope this will work. Thanks again!
>>>
>>> Sincerely,
>>>
>>> Milu
>>>
>>> On Thu, Aug 1, 2019 at 9:52 AM Miluji Sb <milujisb at gmail.com> wrote:
>>>
>>> > Dear Vijay,
>>> >
>>> > Thank you again for your reply. I have attached my data for two years
>>> and
>>> > two variables. Hope they will go through, otherwise the files are also
>>> > available here
>>> > <
>>> https://drive.google.com/drive/folders/15LvLysXqIIua8ukkp8UNEnlJMSK6mA1K?usp=sharing
>>> >.
>>> > Thanks again!
>>> >
>>> > Sincerely,
>>> >
>>> > Milu
>>> >
>>> > On Wed, Jul 31, 2019 at 10:46 PM Vijay Lulla <vijaylulla at gmail.com>
>>> wrote:
>>> >
>>> >> Hmm...I had seen your data and thought that it was just some sample
>>> that
>>> >> you'd shared.  If this is your whole data then I don't know how to
>>> create a
>>> >> raster from just one row that is returned from subsetting the
>>> dataframe.
>>> >>
>>> >> Sorry for the noise.
>>> >>
>>> >> On Wed, Jul 31, 2019 at 4:16 PM Miluji Sb <milujisb at gmail.com> wrote:
>>> >>
>>> >>> Hello,
>>> >>>
>>> >>> Thank you for your kind reply.  Here is a snapshot of the original
>>> data.
>>> >>> I had pasted it at the bottom of my first email but forgot to
>>> mention it.
>>> >>> Thanks again!
>>> >>>
>>> >>> df <- structure(list(lon = c(180, 179.762810919291, 179.523658017568,
>>> >>> 179.311342656601, 179.067616041778, 178.851382109362,
>>> 178.648816406322,
>>> >>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
>>> >>> c(-16.1529296875,
>>> >>> -16.21659020822, -16.266117894201, -16.393550535614,
>>> -16.4457378034442,
>>> >>> -16.561653799838, -16.6533087696649, -16.7741069281329,
>>> >>> -16.914110607613,
>>> >>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
>>> >>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
>>> >>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
>>> >>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
>>> >>> 2.16767864033646,
>>> >>> 2.16881240361846, 2.20727073247015, 2.27771608519709,
>>> 2.3649601141941,
>>> >>> 2.44210984856767, 2.52466349543977, 2.63982954290745,
>>> 2.71828906773926
>>> >>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
>>> >>> 2.53057109758284, 2.61391337469939, 2.71040967066483,
>>> 2.82546443373866,
>>> >>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
>>> >>> c(2.63753852023063,
>>> >>> 2.7080249053612, 2.75483681166049, 2.86893038433795,
>>> 2.97758282474101,
>>> >>> 3.14541928966618, 3.3986143008625, 3.68043269045659,
>>> 4.09571655859075,
>>> >>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
>>> >>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class =
>>> "data.frame")
>>> >>>
>>> >>> Sincerely,
>>> >>>
>>> >>> Milu
>>> >>>
>>> >>> On Wed, Jul 31, 2019 at 9:20 PM Vijay Lulla <vijaylulla at gmail.com>
>>> >>> wrote:
>>> >>>
>>> >>>> ?`rasterFromXYZ` states that "x and y represent spatial coordinates
>>> and
>>> >>>> must be on a regular grid."  And, it appears to me that you might
>>> be losing
>>> >>>> values by rounding lon/lat values.  The help file further suggests
>>> that
>>> >>>> `rasterize` might be the function you're looking for.  List members
>>> will
>>> >>>> (certainly I will) find it more helpful to propose other solutions
>>> if you
>>> >>>> post a small reproducible example of your original georeferenced
>>> dataset so
>>> >>>> that we get an idea of what data you're using.
>>> >>>>
>>> >>>> Sorry, I cannot be of more help.
>>> >>>>
>>> >>>> On Wed, Jul 31, 2019 at 10:45 AM Miluji Sb <milujisb at gmail.com>
>>> wrote:
>>> >>>>
>>> >>>>> Dear all,
>>> >>>>>
>>> >>>>> I have georeferenced dataset with multiple variables and years. The
>>> >>>>> data is
>>> >>>>> at ~100 km (1? ? 1?) spatial resolution. I would like to convert
>>> this
>>> >>>>> into
>>> >>>>> a raster.
>>> >>>>>
>>> >>>>> I have filtered the data for one year and one variable and did the
>>> >>>>> following;
>>> >>>>>
>>> >>>>> try <- subset(df, year==2010)
>>> >>>>> try <- try[,c(1,2,4)]
>>> >>>>> try$lon <- round(try$lon)
>>> >>>>> try$lat <- round(try$lat)
>>> >>>>> r_imp <- rasterFromXYZ(try)
>>> >>>>>
>>> >>>>> Two issues; is it possible to convert the original dataset with the
>>> >>>>> multiple variables and years to a raster? If not, how can I avoid
>>> >>>>> rounding
>>> >>>>> the coordinates? Currently, I get this error "Error in
>>> >>>>> rasterFromXYZ(try) :
>>> >>>>> x cell sizes are not regular" without rounding.
>>> >>>>>
>>> >>>>> Any help will be greatly appreciated. Thank you!
>>> >>>>>
>>> >>>>> Sincerely,
>>> >>>>>
>>> >>>>> Shouro
>>> >>>>>
>>> >>>>> ## Data
>>> >>>>> df <- structure(list(lon = c(180, 179.762810919291,
>>> 179.523658017568,
>>> >>>>> 179.311342656601, 179.067616041778, 178.851382109362,
>>> 178.648816406322,
>>> >>>>> 178.501097394651, 178.662722495847, 178.860599151485), lat =
>>> >>>>> c(-16.1529296875,
>>> >>>>> -16.21659020822, -16.266117894201, -16.393550535614,
>>> -16.4457378034442,
>>> >>>>> -16.561653799838, -16.6533087696649, -16.7741069281329,
>>> >>>>> -16.914110607613,
>>> >>>>> -16.9049389730284), nsdec = structure(c(1L, 3L, 4L, 5L, 6L, 7L,
>>> >>>>> 8L, 9L, 10L, 2L), .Label = c("1 of 10", "10 of 10", "2 of 10",
>>> >>>>> "3 of 10", "4 of 10", "5 of 10", "6 of 10", "7 of 10", "8 of 10",
>>> >>>>> "9 of 10"), class = "factor"), TWL_5 = c(2.13810426616849,
>>> >>>>> 2.16767864033646,
>>> >>>>> 2.16881240361846, 2.20727073247015, 2.27771608519709,
>>> 2.3649601141941,
>>> >>>>> 2.44210984856767, 2.52466349543977, 2.63982954290745,
>>> 2.71828906773926
>>> >>>>> ), TWL_50 = c(2.38302354555823, 2.43142793944275, 2.45733044901087,
>>> >>>>> 2.53057109758284, 2.61391337469939, 2.71040967066483,
>>> 2.82546443373866,
>>> >>>>> 2.9709907727849, 3.1785797371187, 3.33227647990861), TWL_95 =
>>> >>>>> c(2.63753852023063,
>>> >>>>> 2.7080249053612, 2.75483681166049, 2.86893038433795,
>>> 2.97758282474101,
>>> >>>>> 3.14541928966618, 3.3986143008625, 3.68043269045659,
>>> 4.09571655859075,
>>> >>>>> 4.57299670034984), year = c(2010, 2020, 2030, 2040, 2050, 2060,
>>> >>>>> 2070, 2080, 2090, 2100)), row.names = c(NA, 10L), class =
>>> "data.frame")
>>> >>>>>
>>> >>>>>         [[alternative HTML version deleted]]
>>> >>>>>
>>> >>>>> _______________________________________________
>>> >>>>> R-sig-Geo mailing list
>>> >>>>> R-sig-Geo at r-project.org
>>> >>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>> >>>>>
>>> >>>>
>>> >>>>
>>> >>>>
>>> >>
>>>
>>>         [[alternative HTML version deleted]]
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>
>>
>
>

	[[alternative HTML version deleted]]


From hugo@gco@t@ @end|ng |rom gm@||@com  Mon Aug  5 23:49:07 2019
From: hugo@gco@t@ @end|ng |rom gm@||@com (Hugo Costa)
Date: Mon, 5 Aug 2019 22:49:07 +0100
Subject: [R-sig-Geo] raster::stack fails with "missing value where
 TRUE/FALSE needed"
Message-ID: <CADvFi5q9UMw_+ZyNrNPpozU8L3XXTuAmHsRMDp3ZHL5Xd+Qp9Q@mail.gmail.com>

Dear list,

is there any reason for raster::stack retrieve and error (see below) for
the raster provided in dropbox
<https://www.dropbox.com/s/tdfxezlieka1ofd/gsw.tif?dl=0>?
Thanks

# this may read the raster from dropbox directly, but is slow
# r<-raster("https://www.dropbox.com/s/tdfxezlieka1ofd/gsw.tif?dl=1")

# download raster from
https://www.dropbox.com/s/tdfxezlieka1ofd/gsw.tif?dl=0
r<-raster("path/to/downloaded/raster")
stack(r,r)

Error in if (common.len == 1L) unlist(x, recursive = FALSE) else if
> (common.len >  :
>   missing value where TRUE/FALSE needed
>

# reduce extent (no error)
r2<-crop(r, extent(r)/2)
stack(r2,r2)

R version 3.5.2 (2018-12-20)
> Platform: i386-w64-mingw32/i386 (32-bit)
> Running under: Windows >= 8 x64 (build 9200)
>
> Matrix products: default
> locale:
> [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
> Kingdom.1252    LC_MONETARY=English_United Kingdom.1252
> [4] LC_NUMERIC=C                            LC_TIME=English_United
> Kingdom.1252
>
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
>
> other attached packages:
> [1] raster_2.9-23 sp_1.3-1
>
> loaded via a namespace (and not attached):
> [1] compiler_3.5.2   rgdal_1.4-4      tools_3.5.2      Rcpp_1.0.0
> codetools_0.2-15 grid_3.5.2       lattice_0.20-38
>

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Tue Aug  6 12:24:48 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Tue, 6 Aug 2019 12:24:48 +0200
Subject: [R-sig-Geo] rgrass7 0.2-1 on CRAN
Message-ID: <alpine.LFD.2.21.1908061218220.2938@reclus.nhh.no>

As use of sf and stars classes increases, the rgrass7 interface package 
between R and GRASS has been changed to drop the assumption that sp (and 
rgdal) will be loaded and attached. Users should now declare explicitly 
with the new functions use_sp() and use_sf() which representation is 
preferred for objects being moved between R and GRASS. At present, 
use_sf() only supports vector objects.

The package is now on https://github.com/rsbivand/rgrass7 with 
documentation on https://rsbivand.github.io/rgrass7/.

Please raise issues on https://github.com/rsbivand/rgrass7/issues, here, 
or on grass-stats at lists.osgeo.org.

Roger

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From em@nue|e@b@rc@ @end|ng |rom b@@|r@@@cnr@|t  Tue Aug  6 13:07:22 2019
From: em@nue|e@b@rc@ @end|ng |rom b@@|r@@@cnr@|t (Emanuele Barca)
Date: Tue, 06 Aug 2019 13:07:22 +0200
Subject: [R-sig-Geo] regression-kriging and co-kriging
Message-ID: <20190806110642.8A75583CB0CA@srv00.area.ba.cnr.it>

Dear  r-sig-geo friends,

I produced two maps garnered in the following way:

# for regression-kriging
Piezo.map <-autoKrige(LivStat ~  Z, input_data = mydata.sp, new_data
= covariates,  model = "Ste")

Piezork.pred <- Piezo.map$krige_output$var1.pred
Piezork.coords <- Piezo.map$krige_output at coords
Piezork.out <- as.data.frame(cbind(Piezork.coords, Piezork.pred))
colnames(Piezork.out)[1:2] <- c("X", "Y")
coordinates(Piezork.out) = ~ X + Y
gridded(Piezork.out) <- TRUE

spplot(Piezork.out, main = list(label = "R-k Hydraulic head", cex = 1.5))

#for co-kriging
g <- gstat(id = "Piezo", formula = LivStat ~ 1, data = mydata.sp, set
= list(nocheck = 1))
g <- gstat(g, id = "Z", formula = Z ~ 1, data = mydata.sp, set =
list(nocheck = 1))

v.g <- variogram(g)

#g <- gstat(g, id = "Piezo", model = vgm(150, "Mat", 1350, 0.0, kappa
= 1.9), fill.all = T)#
g <- gstat(g, id = "Piezo", model = vgm(0.7, "Ste", 1300, 18, kappa =
1.9), fill.all = T)#
g.fit <- fit.lmc(v.g, g, fit.lmc = TRUE, correct.diagonal = 1.01) #
fit multivariable variogram model , fit.lmc = TRUE, correct.diagonal = 1.01
g.fit
plot(v.g, model = g.fit, main = "Fitted Variogram Models - Raw Data")#
#gridded(covariates) <- TRUE
g.cok <- predict(g.fit, newdata = covariates)#grid

g.cok.pred <- g.cok at data$Piezo.pred
aaaa <- na.omit(g.cok.pred)
g.cok.coords <- g.cok at coords
g.cok.out <- as.data.frame(cbind(g.cok.coords, g.cok.pred))
colnames(g.cok.out)[1:2] <- c("X", "Y")
coordinates(g.cok.out) = ~ X + Y
gridded(g.cok.out) <- TRUE
spplot(g.cok.out, main = list(label = "Hydraulic head with
Co-kriging", cex = 1.5))

###########################################################################################################################

I am unable to understand why the first map appears as a raster and
the second not, notwithstanding the fact that they are both computed
on the same "covariates" DEM???

where is the mistake???

regards

emanuele

________________________________________________________
Emanuele Barca                               Researcher
Water Research Institute                       (IRSA-CNR)
Via De Blasio, 5                       70123 Bari (Italy)
Phone +39 080 5820535               Fax  +39 080 5313365
Mobile +39 340 3420689
_________________________________________________________



---
Questa e-mail ? stata controllata per individuare virus con Avast antivirus.
https://www.avast.com/antivirus

	[[alternative HTML version deleted]]


From hugo@gco@t@ @end|ng |rom gm@||@com  Tue Aug  6 22:36:59 2019
From: hugo@gco@t@ @end|ng |rom gm@||@com (Hugo Costa)
Date: Tue, 6 Aug 2019 21:36:59 +0100
Subject: [R-sig-Geo] raster::stack fails with "missing value where
 TRUE/FALSE needed"
In-Reply-To: <CADvFi5q9UMw_+ZyNrNPpozU8L3XXTuAmHsRMDp3ZHL5Xd+Qp9Q@mail.gmail.com>
References: <CADvFi5q9UMw_+ZyNrNPpozU8L3XXTuAmHsRMDp3ZHL5Xd+Qp9Q@mail.gmail.com>
Message-ID: <CADvFi5o+6cvDtuiVt_qrABcj5NZfV_x+vSoNhtyr23Mn-GeL2w@mail.gmail.com>

For some reason, RStudio was linked to the R 32-bits version. I manually
defined the link to the 64-bits (in RStudio's global options) and the
problem went away.
Hugo

Hugo Costa <hugoagcosta at gmail.com> escreveu no dia segunda, 5/08/2019 ?(s)
22:49:

> Dear list,
>
> is there any reason for raster::stack retrieve and error (see below) for
> the raster provided in dropbox
> <https://www.dropbox.com/s/tdfxezlieka1ofd/gsw.tif?dl=0>?
> Thanks
>
> # this may read the raster from dropbox directly, but is slow
> # r<-raster("https://www.dropbox.com/s/tdfxezlieka1ofd/gsw.tif?dl=1")
>
> # download raster from
> https://www.dropbox.com/s/tdfxezlieka1ofd/gsw.tif?dl=0
> r<-raster("path/to/downloaded/raster")
> stack(r,r)
>
> Error in if (common.len == 1L) unlist(x, recursive = FALSE) else if
>> (common.len >  :
>>   missing value where TRUE/FALSE needed
>>
>
> # reduce extent (no error)
> r2<-crop(r, extent(r)/2)
> stack(r2,r2)
>
> R version 3.5.2 (2018-12-20)
>> Platform: i386-w64-mingw32/i386 (32-bit)
>> Running under: Windows >= 8 x64 (build 9200)
>>
>> Matrix products: default
>> locale:
>> [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
>> Kingdom.1252    LC_MONETARY=English_United Kingdom.1252
>> [4] LC_NUMERIC=C                            LC_TIME=English_United
>> Kingdom.1252
>>
>> attached base packages:
>> [1] stats     graphics  grDevices utils     datasets  methods   base
>>
>> other attached packages:
>> [1] raster_2.9-23 sp_1.3-1
>>
>> loaded via a namespace (and not attached):
>> [1] compiler_3.5.2   rgdal_1.4-4      tools_3.5.2      Rcpp_1.0.0
>> codetools_0.2-15 grid_3.5.2       lattice_0.20-38
>>
>

	[[alternative HTML version deleted]]


From @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br  Wed Aug  7 02:32:17 2019
From: @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br (ASANTOS)
Date: Tue, 6 Aug 2019 20:32:17 -0400
Subject: [R-sig-Geo] ENFA in R: crossprod(Ze, DpZ) error
In-Reply-To: <1385387413.2099612.1565135388623@mail.yahoo.com>
References: <1385387413.2099612.1565135388623@mail.yahoo.com>
Message-ID: <a585d7fa-b6cb-1b18-ddb6-59569ace7718@yahoo.com.br>

Dear Members,

I've like to use ENFA approach with my data set, but I have an *Error in 
crossprod(Ze, DpZ) : non-conformable arguments* as output when I try to 
use this function. I check my input objects and my coordinates are 
in??'SpatialPointsDataFrame' and??the environmental attributes as 
SpatialPixelsDataFrame" like in the help of the enfa() function. But, in 
my example:

#Packages
library(dismo)
library(raster)
library(adehabitatMA)
library(adehabitatHS)

#Bradypus presence data set
file <- paste(system.file(package="dismo"), "/ex/bradypus.csv", sep="")
bradypus <- read.table(file, header=TRUE, sep="," )
# I don't need the first column
bradypus <- bradypus[,-1]
id=1:length(bradypus[,1])
bradypus.data <- as.data.frame(cbind(bradypus,id))
coordinates(bradypus.data) <- ~lon+lat
bradypus.data<-as(bradypus.data, 'SpatialPointsDataFrame')
proj4string(bradypus.data) <- CRS("+proj=longlat +datum=WGS84 +no_defs 
+ellps=WGS84 +towgs84=0,0,0")


#Environmental variables
clim=getData('worldclim', var='bio', res=10)
clim.bradypus<-raster::crop(clim,c(-85.9333, -40.0667, -23.45, 13.95)) # 
trim to a smaller region
plot(clim.bradypus[[1]])
plot(bradypus.data,add=T)
bradypus.map<-as(clim.bradypus, "SpatialPixelsDataFrame")
proj4string(bradypus.map) <- CRS("+proj=longlat +datum=WGS84 +no_defs 
+ellps=WGS84 +towgs84=0,0,0")

## We prepare the data for the ENFA
tab <-bradypus.map
pr <- slot(count.points(bradypus.data, bradypus.map), "data")[,1]

# Run ENFA and make predictions of habitat suitability index
#First I create and removed NA (my original data set has NA)
idx = sample(1:nrow(tab),100)
tab[idx,] = NA
f1 <- function(vec) {
m <- mean(vec, na.rm = TRUE)
vec[is.na(vec)] <- m
return(vec)
}
tab2 = apply(tab,2,f1)
enfa.pink<- enfa(dudi.pca(tab2, scannf=FALSE), pr, scannf=FALSE, nf=2)## 
Applied ENFA


*Error in crossprod(Ze, DpZ) : non-conformable arguments*

1: In x * pr : longer object length is not a multiple of shorter object 
length ...


Any ideas about I can fix it?

Thanks in advanced

-- 
======================================================================
Alexandre dos Santos
Prote????o Florestal
IFMT - Instituto Federal de Educa????o, Ci??ncia e Tecnologia de Mato Grosso
Campus C??ceres
Caixa Postal 244
Avenida dos Ramires, s/n
Bairro: Distrito Industrial
C??ceres - MT?????????????????????????????????????????? CEP: 78.200-000
Fone: (+55) 65 99686-6970 (VIVO) (+55) 65 3221-2674 (FIXO)

alexandre.santos at cas.ifmt.edu.br
Lattes: http://lattes.cnpq.br/1360403201088680
OrcID: orcid.org/0000-0001-8232-6722
Researchgate: www.researchgate.net/profile/Alexandre_Santos10
LinkedIn: br.linkedin.com/in/alexandre-dos-santos-87961635
Mendeley:www.mendeley.com/profiles/alexandre-dos-santos6/
======================================================================





	[[alternative HTML version deleted]]


From @tu@rt@reece @end|ng |rom b|gpond@com  Wed Aug  7 16:43:51 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 8 Aug 2019 00:43:51 +1000
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
Message-ID: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>

Dear R-Sig-Geo list,

 

I was wondering if it might be possible please to request assistance with
adding some nb relationships to a .nb.gal list composed either by GeoDa or
poly2nb in R????

 

The shapefile at this URL
<https://www.samhsa.gov/data/report/2014-2016-nsduh-substate-region-shapefil
e>  divides USA into 395 substate regions.  For health and demographical
reasons it is important to include both Hawaii and Alaska in the
spatiotemporal analysis so I want to introduce these into the Southeast
coast of California and the Pacific northwest respectively.

 

This is just as Giovanni Millo added in spatial relationships for Sicily
across the Strait of Messina for splm on page 7 of the splm pdf.

 

I found edit.nb in spdep and operated it just as described in the
instructions and here
<https://github.com/r-spatial/spdep/blob/master/man/edit.nb.Rd> .  It
crashed RStudio many times but ran well in R3.6.1.  However even though I
assigned it to a new object it did not save well.  Although when I plotted
the dxxx file as the difference between the old and modified files it
plotted the changes beautifully in red and black respectively when plotted
by themselves it introduced many long distance extraneous relationships.  To
get the edited nb list file out of R 3.6.1 and into RStudio I saved it as an
RDS file.  However when opened in RStudio it was grossly erroneous and
included extraneous links from Hawaii to Boston and New York.  When I opened
the file in RStudio it again introduced these extraneous links.

 

Saving it as a further new object in R 3.6.1 did not remedy these
difficulties.

 

The other problem I have is that the spdep poly2nb function excludes
Richmond, an island off the southern tip of Long Island near New York as it
is an island.  Also one of the areas - Region 10 in Washington DC - is also
excluded for reasons of which I am unsure.

 

I found some code here to just patch single areas
<https://stat.ethz.ch/pipermail/r-sig-geo/2006-June/001073.html>  like this
but when I run it, it throws an integer error 

"  INTEGER() can only be applied to a 'integer', not a 'double'  

 

No combination of bracketing around subscripts helps or works at all.  The
link mentioned has these statements in it

 

nb[[ij[1]]] <- sort(unique(c(nb[[ij[1]]], ij[2])))
nb[[ij[2]]] <- sort(unique(c(nb[[ij[2]]], ij[1])))

 

which makes me think that I should insert a vector "  c(i,j) "  where
indicated.  Even using "c(as.integer(i),as.integer(j)) " 

or " as.integer(c(I,j)) "   doesn't work and still gives rise to the same
error.

 

I am sure I am not the only one to have encountered such difficulties but I
have really tried everything I can think of.

 

The other thing I would really like is some clear instructions as to the
true underlying structure of the nb list.  If I could clearly understand
this then I could just go into the affected lines of the list of lists and
edit them directly.

 

However I am quite unable to find any clear description of its structure on
line.

 

Similarly I cannot find the source code for drop.links online to try to
translate this code into add.links directly, as was also suggested.

 

But such a function would I think be enormously helpful and of invaluable
assistance for final editing.

 

Thankyou ever so much in advance for your kind and gracious assistance. 

 

Yours sincerely,

 

Stuart Reece.


	[[alternative HTML version deleted]]


From @tu@rt@reece @end|ng |rom b|gpond@com  Wed Aug  7 17:07:21 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 8 Aug 2019 01:07:21 +1000
Subject: [R-sig-Geo] Weight which work in Map Drawing but Fail in spml and
 spgm Regressions
Message-ID: <00c001d54d31$d1a0cbd0$74e26370$@bigpond.com>

Dear R-Sig-Geo List,

The other issue I have is weight which work beautifully in drawing maps, but
fail in regressions.

The usual error I get about this is that the subscript is out of bounds..
Which I can hardly understand...????

Thanks so much for any assistance,

Yours sincerely,

Stuart Reece.


	[[alternative HTML version deleted]]


From v|j@y|u||@ @end|ng |rom gm@||@com  Wed Aug  7 17:53:12 2019
From: v|j@y|u||@ @end|ng |rom gm@||@com (Vijay Lulla)
Date: Wed, 7 Aug 2019 11:53:12 -0400
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
Message-ID: <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>

Maybe https://cran.r-project.org/web/packages/spdep/vignettes/nb_igraph.html
can help with all your questions.
https://cran.r-project.org/web/packages/spdep/vignettes/nb_sf.html contains
a little more detail about nb structure.  Finally, I encourage you to use
`str` to study the structure of R objects.
HTH,
Vijay.

On Wed, Aug 7, 2019 at 10:44 AM Stuart Reece <stuart.reece at bigpond.com>
wrote:

> Dear R-Sig-Geo list,
>
>
>
> I was wondering if it might be possible please to request assistance with
> adding some nb relationships to a .nb.gal list composed either by GeoDa or
> poly2nb in R????
>
>
>
> The shapefile at this URL
> <
> https://www.samhsa.gov/data/report/2014-2016-nsduh-substate-region-shapefil
> e>  divides USA into 395 substate regions.  For health and demographical
> reasons it is important to include both Hawaii and Alaska in the
> spatiotemporal analysis so I want to introduce these into the Southeast
> coast of California and the Pacific northwest respectively.
>
>
>
> This is just as Giovanni Millo added in spatial relationships for Sicily
> across the Strait of Messina for splm on page 7 of the splm pdf.
>
>
>
> I found edit.nb in spdep and operated it just as described in the
> instructions and here
> <https://github.com/r-spatial/spdep/blob/master/man/edit.nb.Rd> .  It
> crashed RStudio many times but ran well in R3.6.1.  However even though I
> assigned it to a new object it did not save well.  Although when I plotted
> the dxxx file as the difference between the old and modified files it
> plotted the changes beautifully in red and black respectively when plotted
> by themselves it introduced many long distance extraneous relationships.
> To
> get the edited nb list file out of R 3.6.1 and into RStudio I saved it as
> an
> RDS file.  However when opened in RStudio it was grossly erroneous and
> included extraneous links from Hawaii to Boston and New York.  When I
> opened
> the file in RStudio it again introduced these extraneous links.
>
>
>
> Saving it as a further new object in R 3.6.1 did not remedy these
> difficulties.
>
>
>
> The other problem I have is that the spdep poly2nb function excludes
> Richmond, an island off the southern tip of Long Island near New York as it
> is an island.  Also one of the areas - Region 10 in Washington DC - is also
> excluded for reasons of which I am unsure.
>
>
>
> I found some code here to just patch single areas
> <https://stat.ethz.ch/pipermail/r-sig-geo/2006-June/001073.html>  like
> this
> but when I run it, it throws an integer error
>
> "  INTEGER() can only be applied to a 'integer', not a 'double'
>
>
>
> No combination of bracketing around subscripts helps or works at all.  The
> link mentioned has these statements in it
>
>
>
> nb[[ij[1]]] <- sort(unique(c(nb[[ij[1]]], ij[2])))
> nb[[ij[2]]] <- sort(unique(c(nb[[ij[2]]], ij[1])))
>
>
>
> which makes me think that I should insert a vector "  c(i,j) "  where
> indicated.  Even using "c(as.integer(i),as.integer(j)) "
>
> or " as.integer(c(I,j)) "   doesn't work and still gives rise to the same
> error.
>
>
>
> I am sure I am not the only one to have encountered such difficulties but I
> have really tried everything I can think of.
>
>
>
> The other thing I would really like is some clear instructions as to the
> true underlying structure of the nb list.  If I could clearly understand
> this then I could just go into the affected lines of the list of lists and
> edit them directly.
>
>
>
> However I am quite unable to find any clear description of its structure on
> line.
>
>
>
> Similarly I cannot find the source code for drop.links online to try to
> translate this code into add.links directly, as was also suggested.
>
>
>
> But such a function would I think be enormously helpful and of invaluable
> assistance for final editing.
>
>
>
> Thankyou ever so much in advance for your kind and gracious assistance.
>
>
>
> Yours sincerely,
>
>
>
> Stuart Reece.
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From @tu@rt@reece @end|ng |rom b|gpond@com  Wed Aug  7 23:24:56 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 8 Aug 2019 07:24:56 +1000
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>

Thanks Vijay.

Big help.

I will go through the recommended chapter in detail.

Normally for a list I can just use single square brackets like this [] to access the elements and change them by assignment.

But I cannot quite figure out how to do this with the nb lists.

 

Doing this with [[]] works really well to create nicely corrected graphs.

 

But fails due it ?out of bounds index errors? with regression equations????

 

I find this ever so confusing?.???

 

Thankyou so much again,

 

Stuart Reece.

 

 

 

 

 

 

 

 

 

 

From: Vijay Lulla <vijaylulla at gmail.com> 
Sent: Thursday, 8 August, 2019 1:53 AM
To: Stuart Reece <stuart.reece at bigpond.com>
Cc: Roger Bivand <Roger.Bivand at nhh.no>; R-sig-geo Mailing List <r-sig-geo at r-project.org>
Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List

 

Maybe https://cran.r-project.org/web/packages/spdep/vignettes/nb_igraph.html can help with all your questions. https://cran.r-project.org/web/packages/spdep/vignettes/nb_sf.html contains a little more detail about nb structure.  Finally, I encourage you to use `str` to study the structure of R objects.

HTH,

Vijay.

 

On Wed, Aug 7, 2019 at 10:44 AM Stuart Reece <stuart.reece at bigpond.com <mailto:stuart.reece at bigpond.com> > wrote:

Dear R-Sig-Geo list,



I was wondering if it might be possible please to request assistance with
adding some nb relationships to a .nb.gal list composed either by GeoDa or
poly2nb in R????



The shapefile at this URL
<https://www.samhsa.gov/data/report/2014-2016-nsduh-substate-region-shapefil
e>  divides USA into 395 substate regions.  For health and demographical
reasons it is important to include both Hawaii and Alaska in the
spatiotemporal analysis so I want to introduce these into the Southeast
coast of California and the Pacific northwest respectively.



This is just as Giovanni Millo added in spatial relationships for Sicily
across the Strait of Messina for splm on page 7 of the splm pdf.



I found edit.nb in spdep and operated it just as described in the
instructions and here
<https://github.com/r-spatial/spdep/blob/master/man/edit.nb.Rd> .  It
crashed RStudio many times but ran well in R3.6.1.  However even though I
assigned it to a new object it did not save well.  Although when I plotted
the dxxx file as the difference between the old and modified files it
plotted the changes beautifully in red and black respectively when plotted
by themselves it introduced many long distance extraneous relationships.  To
get the edited nb list file out of R 3.6.1 and into RStudio I saved it as an
RDS file.  However when opened in RStudio it was grossly erroneous and
included extraneous links from Hawaii to Boston and New York.  When I opened
the file in RStudio it again introduced these extraneous links.



Saving it as a further new object in R 3.6.1 did not remedy these
difficulties.



The other problem I have is that the spdep poly2nb function excludes
Richmond, an island off the southern tip of Long Island near New York as it
is an island.  Also one of the areas - Region 10 in Washington DC - is also
excluded for reasons of which I am unsure.



I found some code here to just patch single areas
<https://stat.ethz.ch/pipermail/r-sig-geo/2006-June/001073.html>  like this
but when I run it, it throws an integer error 

"  INTEGER() can only be applied to a 'integer', not a 'double'  



No combination of bracketing around subscripts helps or works at all.  The
link mentioned has these statements in it



nb[[ij[1]]] <- sort(unique(c(nb[[ij[1]]], ij[2])))
nb[[ij[2]]] <- sort(unique(c(nb[[ij[2]]], ij[1])))



which makes me think that I should insert a vector "  c(i,j) "  where
indicated.  Even using "c(as.integer(i),as.integer(j)) " 

or " as.integer(c(I,j)) "   doesn't work and still gives rise to the same
error.



I am sure I am not the only one to have encountered such difficulties but I
have really tried everything I can think of.



The other thing I would really like is some clear instructions as to the
true underlying structure of the nb list.  If I could clearly understand
this then I could just go into the affected lines of the list of lists and
edit them directly.



However I am quite unable to find any clear description of its structure on
line.



Similarly I cannot find the source code for drop.links online to try to
translate this code into add.links directly, as was also suggested.



But such a function would I think be enormously helpful and of invaluable
assistance for final editing.



Thankyou ever so much in advance for your kind and gracious assistance. 



Yours sincerely,



Stuart Reece.


        [[alternative HTML version deleted]]

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org> 
https://stat.ethz.ch/mailman/listinfo/r-sig-geo




	[[alternative HTML version deleted]]


From b@row||ng@on @end|ng |rom gm@||@com  Thu Aug  8 00:50:32 2019
From: b@row||ng@on @end|ng |rom gm@||@com (Barry Rowlingson)
Date: Wed, 7 Aug 2019 23:50:32 +0100
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
Message-ID: <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>

I recently answered a similar question on Stack Overflow where someone
needed to add detached polygons to their connected network by connecting
them to their nearest neighbour:

https://stackoverflow.com/questions/57269254/how-to-impute-missing-neighbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredirect=1#comment101246065_57378930

in short, you can treat a `nb` object like a list of vectors: nb[[i]] is a
vector of indexes of objects connected to object `i`

BUT you have to make sure you store integers:

Here's a `nb` object from that question which in summary has this
manyneighbours for each region:

> card(nb)
[1] 2 3 4 3 2 0 0

lets set the 6th feature to be a neighbour of the first:

> nb[[6]] = 1

then uh-oh...

> card(nb)
Error in card(nb) :
  INTEGER() can only be applied to a 'integer', not a 'double'

same again only `as.integer`:

> nb[[6]] = as.integer(1)

and its happy:

> card(nb)
[1] 2 3 4 3 2 1 0

if you want to set the nighbours of 6 to several features:

> nb[[6]] = as.integer(c(1,2,3))
> card(nb)
[1] 2 3 4 3 2 3 0

Barry



On Wed, Aug 7, 2019 at 10:25 PM Stuart Reece <stuart.reece at bigpond.com>
wrote:

> Thanks Vijay.
>
> Big help.
>
> I will go through the recommended chapter in detail.
>
> Normally for a list I can just use single square brackets like this [] to
> access the elements and change them by assignment.
>
> But I cannot quite figure out how to do this with the nb lists.
>
>
>
> Doing this with [[]] works really well to create nicely corrected graphs.
>
>
>
> But fails due it ?out of bounds index errors? with regression equations????
>
>
>
> I find this ever so confusing?.???
>
>
>
> Thankyou so much again,
>
>
>
> Stuart Reece.
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
> From: Vijay Lulla <vijaylulla at gmail.com>
> Sent: Thursday, 8 August, 2019 1:53 AM
> To: Stuart Reece <stuart.reece at bigpond.com>
> Cc: Roger Bivand <Roger.Bivand at nhh.no>; R-sig-geo Mailing List <
> r-sig-geo at r-project.org>
> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
>
>
>
> Maybe
> https://cran.r-project.org/web/packages/spdep/vignettes/nb_igraph.html
> can help with all your questions.
> https://cran.r-project.org/web/packages/spdep/vignettes/nb_sf.html
> contains a little more detail about nb structure.  Finally, I encourage you
> to use `str` to study the structure of R objects.
>
> HTH,
>
> Vijay.
>
>
>
> On Wed, Aug 7, 2019 at 10:44 AM Stuart Reece <stuart.reece at bigpond.com
> <mailto:stuart.reece at bigpond.com> > wrote:
>
> Dear R-Sig-Geo list,
>
>
>
> I was wondering if it might be possible please to request assistance with
> adding some nb relationships to a .nb.gal list composed either by GeoDa or
> poly2nb in R????
>
>
>
> The shapefile at this URL
> <
> https://www.samhsa.gov/data/report/2014-2016-nsduh-substate-region-shapefil
> e>  divides USA into 395 substate regions.  For health and demographical
> reasons it is important to include both Hawaii and Alaska in the
> spatiotemporal analysis so I want to introduce these into the Southeast
> coast of California and the Pacific northwest respectively.
>
>
>
> This is just as Giovanni Millo added in spatial relationships for Sicily
> across the Strait of Messina for splm on page 7 of the splm pdf.
>
>
>
> I found edit.nb in spdep and operated it just as described in the
> instructions and here
> <https://github.com/r-spatial/spdep/blob/master/man/edit.nb.Rd> .  It
> crashed RStudio many times but ran well in R3.6.1.  However even though I
> assigned it to a new object it did not save well.  Although when I plotted
> the dxxx file as the difference between the old and modified files it
> plotted the changes beautifully in red and black respectively when plotted
> by themselves it introduced many long distance extraneous relationships.
> To
> get the edited nb list file out of R 3.6.1 and into RStudio I saved it as
> an
> RDS file.  However when opened in RStudio it was grossly erroneous and
> included extraneous links from Hawaii to Boston and New York.  When I
> opened
> the file in RStudio it again introduced these extraneous links.
>
>
>
> Saving it as a further new object in R 3.6.1 did not remedy these
> difficulties.
>
>
>
> The other problem I have is that the spdep poly2nb function excludes
> Richmond, an island off the southern tip of Long Island near New York as it
> is an island.  Also one of the areas - Region 10 in Washington DC - is also
> excluded for reasons of which I am unsure.
>
>
>
> I found some code here to just patch single areas
> <https://stat.ethz.ch/pipermail/r-sig-geo/2006-June/001073.html>  like
> this
> but when I run it, it throws an integer error
>
> "  INTEGER() can only be applied to a 'integer', not a 'double'
>
>
>
> No combination of bracketing around subscripts helps or works at all.  The
> link mentioned has these statements in it
>
>
>
> nb[[ij[1]]] <- sort(unique(c(nb[[ij[1]]], ij[2])))
> nb[[ij[2]]] <- sort(unique(c(nb[[ij[2]]], ij[1])))
>
>
>
> which makes me think that I should insert a vector "  c(i,j) "  where
> indicated.  Even using "c(as.integer(i),as.integer(j)) "
>
> or " as.integer(c(I,j)) "   doesn't work and still gives rise to the same
> error.
>
>
>
> I am sure I am not the only one to have encountered such difficulties but I
> have really tried everything I can think of.
>
>
>
> The other thing I would really like is some clear instructions as to the
> true underlying structure of the nb list.  If I could clearly understand
> this then I could just go into the affected lines of the list of lists and
> edit them directly.
>
>
>
> However I am quite unable to find any clear description of its structure on
> line.
>
>
>
> Similarly I cannot find the source code for drop.links online to try to
> translate this code into add.links directly, as was also suggested.
>
>
>
> But such a function would I think be enormously helpful and of invaluable
> assistance for final editing.
>
>
>
> Thankyou ever so much in advance for your kind and gracious assistance.
>
>
>
> Yours sincerely,
>
>
>
> Stuart Reece.
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
>
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From v|j@y|u||@ @end|ng |rom gm@||@com  Thu Aug  8 01:11:36 2019
From: v|j@y|u||@ @end|ng |rom gm@||@com (Vijay Lulla)
Date: Wed, 7 Aug 2019 19:11:36 -0400
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
Message-ID: <CAKkiGbuh2cY30nN22kkoQrAw-5hZ-6PciAaPRcCwqWnjSZYKfg@mail.gmail.com>

In addition to Barry's recommendation/suggestion I will just add that I
always use the suffix L to numbers so that I have integers whenever I need
them.  Here's an example:
> str(1)
 num 1
> str(1L)
 int 1
> str(c(1,2,3))
 num [1:3] 1 2 3
> str(c(1L,2L,3L))
 int [1:3] 1 2 3
>

This isn't possible when you're indexing based on values extracted from
other lists/vectors in which case you have to use `as.integer` to force
integers.  Again, I find `str` to be invaluable in figuring all this out.
HTH,
Vijay.

On Wed, Aug 7, 2019 at 6:50 PM Barry Rowlingson <b.rowlingson at gmail.com>
wrote:

> I recently answered a similar question on Stack Overflow where someone
> needed to add detached polygons to their connected network by connecting
> them to their nearest neighbour:
>
>
> https://stackoverflow.com/questions/57269254/how-to-impute-missing-neighbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredirect=1#comment101246065_57378930
>
> in short, you can treat a `nb` object like a list of vectors: nb[[i]] is a
> vector of indexes of objects connected to object `i`
>
> BUT you have to make sure you store integers:
>
> Here's a `nb` object from that question which in summary has this
> manyneighbours for each region:
>
> > card(nb)
> [1] 2 3 4 3 2 0 0
>
> lets set the 6th feature to be a neighbour of the first:
>
> > nb[[6]] = 1
>
> then uh-oh...
>
> > card(nb)
> Error in card(nb) :
>   INTEGER() can only be applied to a 'integer', not a 'double'
>
> same again only `as.integer`:
>
> > nb[[6]] = as.integer(1)
>
> and its happy:
>
> > card(nb)
> [1] 2 3 4 3 2 1 0
>
> if you want to set the nighbours of 6 to several features:
>
> > nb[[6]] = as.integer(c(1,2,3))
> > card(nb)
> [1] 2 3 4 3 2 3 0
>
> Barry
>
>
>
> On Wed, Aug 7, 2019 at 10:25 PM Stuart Reece <stuart.reece at bigpond.com>
> wrote:
>
>> Thanks Vijay.
>>
>> Big help.
>>
>> I will go through the recommended chapter in detail.
>>
>> Normally for a list I can just use single square brackets like this [] to
>> access the elements and change them by assignment.
>>
>> But I cannot quite figure out how to do this with the nb lists.
>>
>>
>>
>> Doing this with [[]] works really well to create nicely corrected graphs.
>>
>>
>>
>> But fails due it ?out of bounds index errors? with regression
>> equations????
>>
>>
>>
>> I find this ever so confusing?.???
>>
>>
>>
>> Thankyou so much again,
>>
>>
>>
>> Stuart Reece.
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>> From: Vijay Lulla <vijaylulla at gmail.com>
>> Sent: Thursday, 8 August, 2019 1:53 AM
>> To: Stuart Reece <stuart.reece at bigpond.com>
>> Cc: Roger Bivand <Roger.Bivand at nhh.no>; R-sig-geo Mailing List <
>> r-sig-geo at r-project.org>
>> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
>>
>>
>>
>> Maybe
>> https://cran.r-project.org/web/packages/spdep/vignettes/nb_igraph.html
>> can help with all your questions.
>> https://cran.r-project.org/web/packages/spdep/vignettes/nb_sf.html
>> contains a little more detail about nb structure.  Finally, I encourage you
>> to use `str` to study the structure of R objects.
>>
>> HTH,
>>
>> Vijay.
>>
>>
>>
>> On Wed, Aug 7, 2019 at 10:44 AM Stuart Reece <stuart.reece at bigpond.com
>> <mailto:stuart.reece at bigpond.com> > wrote:
>>
>> Dear R-Sig-Geo list,
>>
>>
>>
>> I was wondering if it might be possible please to request assistance with
>> adding some nb relationships to a .nb.gal list composed either by GeoDa or
>> poly2nb in R????
>>
>>
>>
>> The shapefile at this URL
>> <
>> https://www.samhsa.gov/data/report/2014-2016-nsduh-substate-region-shapefil
>> e>  divides USA into 395 substate regions.  For health and demographical
>> reasons it is important to include both Hawaii and Alaska in the
>> spatiotemporal analysis so I want to introduce these into the Southeast
>> coast of California and the Pacific northwest respectively.
>>
>>
>>
>> This is just as Giovanni Millo added in spatial relationships for Sicily
>> across the Strait of Messina for splm on page 7 of the splm pdf.
>>
>>
>>
>> I found edit.nb in spdep and operated it just as described in the
>> instructions and here
>> <https://github.com/r-spatial/spdep/blob/master/man/edit.nb.Rd> .  It
>> crashed RStudio many times but ran well in R3.6.1.  However even though I
>> assigned it to a new object it did not save well.  Although when I plotted
>> the dxxx file as the difference between the old and modified files it
>> plotted the changes beautifully in red and black respectively when plotted
>> by themselves it introduced many long distance extraneous relationships.
>> To
>> get the edited nb list file out of R 3.6.1 and into RStudio I saved it as
>> an
>> RDS file.  However when opened in RStudio it was grossly erroneous and
>> included extraneous links from Hawaii to Boston and New York.  When I
>> opened
>> the file in RStudio it again introduced these extraneous links.
>>
>>
>>
>> Saving it as a further new object in R 3.6.1 did not remedy these
>> difficulties.
>>
>>
>>
>> The other problem I have is that the spdep poly2nb function excludes
>> Richmond, an island off the southern tip of Long Island near New York as
>> it
>> is an island.  Also one of the areas - Region 10 in Washington DC - is
>> also
>> excluded for reasons of which I am unsure.
>>
>>
>>
>> I found some code here to just patch single areas
>> <https://stat.ethz.ch/pipermail/r-sig-geo/2006-June/001073.html>  like
>> this
>> but when I run it, it throws an integer error
>>
>> "  INTEGER() can only be applied to a 'integer', not a 'double'
>>
>>
>>
>> No combination of bracketing around subscripts helps or works at all.  The
>> link mentioned has these statements in it
>>
>>
>>
>> nb[[ij[1]]] <- sort(unique(c(nb[[ij[1]]], ij[2])))
>> nb[[ij[2]]] <- sort(unique(c(nb[[ij[2]]], ij[1])))
>>
>>
>>
>> which makes me think that I should insert a vector "  c(i,j) "  where
>> indicated.  Even using "c(as.integer(i),as.integer(j)) "
>>
>> or " as.integer(c(I,j)) "   doesn't work and still gives rise to the same
>> error.
>>
>>
>>
>> I am sure I am not the only one to have encountered such difficulties but
>> I
>> have really tried everything I can think of.
>>
>>
>>
>> The other thing I would really like is some clear instructions as to the
>> true underlying structure of the nb list.  If I could clearly understand
>> this then I could just go into the affected lines of the list of lists and
>> edit them directly.
>>
>>
>>
>> However I am quite unable to find any clear description of its structure
>> on
>> line.
>>
>>
>>
>> Similarly I cannot find the source code for drop.links online to try to
>> translate this code into add.links directly, as was also suggested.
>>
>>
>>
>> But such a function would I think be enormously helpful and of invaluable
>> assistance for final editing.
>>
>>
>>
>> Thankyou ever so much in advance for your kind and gracious assistance.
>>
>>
>>
>> Yours sincerely,
>>
>>
>>
>> Stuart Reece.
>>
>>
>>         [[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>>
>>
>>
>>         [[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>

	[[alternative HTML version deleted]]


From b@row||ng@on @end|ng |rom gm@||@com  Thu Aug  8 12:02:00 2019
From: b@row||ng@on @end|ng |rom gm@||@com (Barry Rowlingson)
Date: Thu, 8 Aug 2019 11:02:00 +0100
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
 <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
Message-ID: <CANVKczMTH8QWRp2Tfb+euF=Q-m_LahAemO=jUenMA91ZZad40A@mail.gmail.com>

Wrap the assigned vector in `as.integer`:

Works:
> col.gal.nb[[1]] = as.integer(c(4,5))
> card(col.gal.nb)
 [1]  2  3  4  4  7  2  4  6  8  4  5  6  4  6  6  7  3  4  3 10  3  6  3
 7  7
[26]  6  4  9  7  4  2  4  4  4  7  5  6  6  2  5  3  2  6  5  4  2  2  4  3


Fails:

> col.gal.nb[[1]] = c(4,5)
> card(col.gal.nb)
Error in card(col.gal.nb) :
  INTEGER() can only be applied to a 'integer', not a 'double'

Barry


On Thu, Aug 8, 2019 at 5:01 AM Dr Stuart Reece <asreece at bigpond.net.au>
wrote:

> Thanks Barry.
>
> That is so perfect and so super helpful!!!
>
> And if I want to add three areas to an area ? say I want to add 6,7 and 8
> to the area 10??
>
> Please may I have the syntax for that to avoid the integer error??
>
> Is this also the root of the error about not being the correct index??
>
> Many thanks again,
>
> Stuart.
>
>
>
> *From:* Barry Rowlingson [mailto:b.rowlingson at gmail.com]
> *Sent:* Thursday, 8 August 2019 8:51 AM
> *To:* Stuart Reece
> *Cc:* Vijay Lulla; R-sig-geo Mailing List; Stuart Reece
> *Subject:* Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb
> List
>
>
>
> I recently answered a similar question on Stack Overflow where someone
> needed to add detached polygons to their connected network by connecting
> them to their nearest neighbour:
>
>
>
>
> https://stackoverflow.com/questions/57269254/how-to-impute-missing-neighbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredirect=1#comment101246065_57378930
>
>
>
> in short, you can treat a `nb` object like a list of vectors: nb[[i]] is a
> vector of indexes of objects connected to object `i`
>
>
>
> BUT you have to make sure you store integers:
>
>
>
> Here's a `nb` object from that question which in summary has this
> manyneighbours for each region:
>
>
>
> > card(nb)
> [1] 2 3 4 3 2 0 0
>
>
>
> lets set the 6th feature to be a neighbour of the first:
>
>
>
> > nb[[6]] = 1
>
>
>
> then uh-oh...
>
>
>
> > card(nb)
> Error in card(nb) :
>   INTEGER() can only be applied to a 'integer', not a 'double'
>
>
>
> same again only `as.integer`:
>
>
>
> > nb[[6]] = as.integer(1)
>
>
>
> and its happy:
>
>
>
> > card(nb)
> [1] 2 3 4 3 2 1 0
>
>
>
> if you want to set the nighbours of 6 to several features:
>
>
>
> > nb[[6]] = as.integer(c(1,2,3))
> > card(nb)
> [1] 2 3 4 3 2 3 0
>
>
>
> Barry
>
>
>
>
>
>
>
> On Wed, Aug 7, 2019 at 10:25 PM Stuart Reece <stuart.reece at bigpond.com>
> wrote:
>
> Thanks Vijay.
>
> Big help.
>
> I will go through the recommended chapter in detail.
>
> Normally for a list I can just use single square brackets like this [] to
> access the elements and change them by assignment.
>
> But I cannot quite figure out how to do this with the nb lists.
>
>
>
> Doing this with [[]] works really well to create nicely corrected graphs.
>
>
>
> But fails due it ?out of bounds index errors? with regression equations????
>
>
>
> I find this ever so confusing?.???
>
>
>
> Thankyou so much again,
>
>
>
> Stuart Reece.
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
> From: Vijay Lulla <vijaylulla at gmail.com>
> Sent: Thursday, 8 August, 2019 1:53 AM
> To: Stuart Reece <stuart.reece at bigpond.com>
> Cc: Roger Bivand <Roger.Bivand at nhh.no>; R-sig-geo Mailing List <
> r-sig-geo at r-project.org>
> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
>
>
>
> Maybe
> https://cran.r-project.org/web/packages/spdep/vignettes/nb_igraph.html
> can help with all your questions.
> https://cran.r-project.org/web/packages/spdep/vignettes/nb_sf.html
> contains a little more detail about nb structure.  Finally, I encourage you
> to use `str` to study the structure of R objects.
>
> HTH,
>
> Vijay.
>
>
>
> On Wed, Aug 7, 2019 at 10:44 AM Stuart Reece <stuart.reece at bigpond.com
> <mailto:stuart.reece at bigpond.com> > wrote:
>
> Dear R-Sig-Geo list,
>
>
>
> I was wondering if it might be possible please to request assistance with
> adding some nb relationships to a .nb.gal list composed either by GeoDa or
> poly2nb in R????
>
>
>
> The shapefile at this URL
> <
> https://www.samhsa.gov/data/report/2014-2016-nsduh-substate-region-shapefil
> e>  divides USA into 395 substate regions.  For health and demographical
> reasons it is important to include both Hawaii and Alaska in the
> spatiotemporal analysis so I want to introduce these into the Southeast
> coast of California and the Pacific northwest respectively.
>
>
>
> This is just as Giovanni Millo added in spatial relationships for Sicily
> across the Strait of Messina for splm on page 7 of the splm pdf.
>
>
>
> I found edit.nb in spdep and operated it just as described in the
> instructions and here
> <https://github.com/r-spatial/spdep/blob/master/man/edit.nb.Rd> .  It
> crashed RStudio many times but ran well in R3.6.1.  However even though I
> assigned it to a new object it did not save well.  Although when I plotted
> the dxxx file as the difference between the old and modified files it
> plotted the changes beautifully in red and black respectively when plotted
> by themselves it introduced many long distance extraneous relationships.
> To
> get the edited nb list file out of R 3.6.1 and into RStudio I saved it as
> an
> RDS file.  However when opened in RStudio it was grossly erroneous and
> included extraneous links from Hawaii to Boston and New York.  When I
> opened
> the file in RStudio it again introduced these extraneous links.
>
>
>
> Saving it as a further new object in R 3.6.1 did not remedy these
> difficulties.
>
>
>
> The other problem I have is that the spdep poly2nb function excludes
> Richmond, an island off the southern tip of Long Island near New York as it
> is an island.  Also one of the areas - Region 10 in Washington DC - is also
> excluded for reasons of which I am unsure.
>
>
>
> I found some code here to just patch single areas
> <https://stat.ethz.ch/pipermail/r-sig-geo/2006-June/001073.html>  like
> this
> but when I run it, it throws an integer error
>
> "  INTEGER() can only be applied to a 'integer', not a 'double'
>
>
>
> No combination of bracketing around subscripts helps or works at all.  The
> link mentioned has these statements in it
>
>
>
> nb[[ij[1]]] <- sort(unique(c(nb[[ij[1]]], ij[2])))
> nb[[ij[2]]] <- sort(unique(c(nb[[ij[2]]], ij[1])))
>
>
>
> which makes me think that I should insert a vector "  c(i,j) "  where
> indicated.  Even using "c(as.integer(i),as.integer(j)) "
>
> or " as.integer(c(I,j)) "   doesn't work and still gives rise to the same
> error.
>
>
>
> I am sure I am not the only one to have encountered such difficulties but I
> have really tried everything I can think of.
>
>
>
> The other thing I would really like is some clear instructions as to the
> true underlying structure of the nb list.  If I could clearly understand
> this then I could just go into the affected lines of the list of lists and
> edit them directly.
>
>
>
> However I am quite unable to find any clear description of its structure on
> line.
>
>
>
> Similarly I cannot find the source code for drop.links online to try to
> translate this code into add.links directly, as was also suggested.
>
>
>
> But such a function would I think be enormously helpful and of invaluable
> assistance for final editing.
>
>
>
> Thankyou ever so much in advance for your kind and gracious assistance.
>
>
>
> Yours sincerely,
>
>
>
> Stuart Reece.
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
>
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
>

	[[alternative HTML version deleted]]


From @tu@rt@reece @end|ng |rom b|gpond@com  Thu Aug  8 12:48:37 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 8 Aug 2019 20:48:37 +1000
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
 <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
Message-ID: <002001d54dd6$d6668240$833386c0$@bigpond.com>

Thankyou so much Vijay and Barry.

Yes I have found that using these techniques I can add nb relationships nicely.

And they card() nicely too.

And when I nb2listw they transform well and when I test them can.be.simmed(x) they pass this test also.

 

When I draw maps with them Like Roger Bivand showed in his examples for poly2nb ? the maps draw just perfectly.

 

However when I use them in the spml or spgm regressions in package splm they fail with an error message usually about indexes being out of bounds.

 

Running this code ?.

 

summary(spgm(PC1MI ~ PC1Rx * log(mrjmon), 

+              data=MIdf9dfF2, listw=MIdf9sflww,

+              lag=TRUE, moments="fullweights", method="g2sls",

+              model="random", spatial.error=TRUE))

 

Generates this error:

Error in x[, ii] : subscript out of bounds

 

I feel that I must be missing something here but am not able to put my finger on what it is???

Thanks so much again,

Stuart.

 

 

 

 

From: Dr Stuart Reece <asreece at bigpond.net.au> 
Sent: Thursday, 8 August, 2019 2:01 PM
To: 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'Stuart Reece' <stuart.reece at bigpond.com>
Cc: 'Vijay Lulla' <vijaylulla at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
Importance: High

 

Thanks Barry.

That is so perfect and so super helpful!!!

And if I want to add three areas to an area ? say I want to add 6,7 and 8 to the area 10??

Please may I have the syntax for that to avoid the integer error??

Is this also the root of the error about not being the correct index??

Many thanks again,

Stuart.

 

From: Barry Rowlingson [mailto:b.rowlingson at gmail.com] 
Sent: Thursday, 8 August 2019 8:51 AM
To: Stuart Reece
Cc: Vijay Lulla; R-sig-geo Mailing List; Stuart Reece
Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List

 

I recently answered a similar question on Stack Overflow where someone needed to add detached polygons to their connected network by connecting them to their nearest neighbour:

 

https://stackoverflow.com/questions/57269254/how-to-impute-missing-neighbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredirect=1#comment101246065_57378930

 

in short, you can treat a `nb` object like a list of vectors: nb[[i]] is a vector of indexes of objects connected to object `i`

 

BUT you have to make sure you store integers:

 

Here's a `nb` object from that question which in summary has this manyneighbours for each region:

 

> card(nb)
[1] 2 3 4 3 2 0 0

 

lets set the 6th feature to be a neighbour of the first:

 

> nb[[6]] = 1

 

then uh-oh...

 

> card(nb)
Error in card(nb) : 
  INTEGER() can only be applied to a 'integer', not a 'double'

 

same again only `as.integer`:

 

> nb[[6]] = as.integer(1)

 

and its happy:

 

> card(nb)
[1] 2 3 4 3 2 1 0

 

if you want to set the nighbours of 6 to several features:

 

> nb[[6]] = as.integer(c(1,2,3))
> card(nb)
[1] 2 3 4 3 2 3 0

 

Barry

 

 


	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Aug  8 13:10:16 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 8 Aug 2019 13:10:16 +0200
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <002001d54dd6$d6668240$833386c0$@bigpond.com>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
 <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
 <002001d54dd6$d6668240$833386c0$@bigpond.com>
Message-ID: <alpine.LFD.2.21.1908081305351.7329@reclus.nhh.no>

On Thu, 8 Aug 2019, Stuart Reece wrote:

> Thankyou so much Vijay and Barry.

Yes, thanks!

>
> Yes I have found that using these techniques I can add nb relationships 
> nicely.
>
> And they card() nicely too.
>
> And when I nb2listw they transform well and when I test them 
> can.be.simmed(x) they pass this test also.
>
> When I draw maps with them Like Roger Bivand showed in his examples for 
> poly2nb ? the maps draw just perfectly.

This is flying on hope not knowledge. If the assigned values are not 
within the 1:n set, there will be trouble - this is an S3 class with no 
validity check. Further, there may be trouble if the length of attr(., 
"region.id") is incorrect, but this cannot be checked unless you run 
traceback() after the error in spgm(). We still need a fully reproducible 
example ...

Roger

> However when I use them in the spml or spgm regressions in package splm 
> they fail with an error message usually about indexes being out of 
> bounds.
>
> Running this code ?.
>
> summary(spgm(PC1MI ~ PC1Rx * log(mrjmon),
> +              data=MIdf9dfF2, listw=MIdf9sflww,
> +              lag=TRUE, moments="fullweights", method="g2sls",
> +              model="random", spatial.error=TRUE))
>
> Generates this error:
>
> Error in x[, ii] : subscript out of bounds
>
> I feel that I must be missing something here but am not able to put my 
> finger on what it is???
>
> Thanks so much again,
>
> Stuart.
>
>
>
>
>
>
>
>
>
> From: Dr Stuart Reece <asreece at bigpond.net.au>
> Sent: Thursday, 8 August, 2019 2:01 PM
> To: 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'Stuart Reece' <stuart.reece at bigpond.com>
> Cc: 'Vijay Lulla' <vijaylulla at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
> Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
> Importance: High
>
>
>
> Thanks Barry.
>
> That is so perfect and so super helpful!!!
>
> And if I want to add three areas to an area ? say I want to add 6,7 and 8 to the area 10??
>
> Please may I have the syntax for that to avoid the integer error??
>
> Is this also the root of the error about not being the correct index??
>
> Many thanks again,
>
> Stuart.
>
>
>
> From: Barry Rowlingson [mailto:b.rowlingson at gmail.com]
> Sent: Thursday, 8 August 2019 8:51 AM
> To: Stuart Reece
> Cc: Vijay Lulla; R-sig-geo Mailing List; Stuart Reece
> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
>
>
>
> I recently answered a similar question on Stack Overflow where someone needed to add detached polygons to their connected network by connecting them to their nearest neighbour:
>
>
>
> https://stackoverflow.com/questions/57269254/how-to-impute-missing-neighbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredirect=1#comment101246065_57378930
>
>
>
> in short, you can treat a `nb` object like a list of vectors: nb[[i]] is a vector of indexes of objects connected to object `i`
>
>
>
> BUT you have to make sure you store integers:
>
>
>
> Here's a `nb` object from that question which in summary has this manyneighbours for each region:
>
>
>
>> card(nb)
> [1] 2 3 4 3 2 0 0
>
>
>
> lets set the 6th feature to be a neighbour of the first:
>
>
>
>> nb[[6]] = 1
>
>
>
> then uh-oh...
>
>
>
>> card(nb)
> Error in card(nb) :
>  INTEGER() can only be applied to a 'integer', not a 'double'
>
>
>
> same again only `as.integer`:
>
>
>
>> nb[[6]] = as.integer(1)
>
>
>
> and its happy:
>
>
>
>> card(nb)
> [1] 2 3 4 3 2 1 0
>
>
>
> if you want to set the nighbours of 6 to several features:
>
>
>
>> nb[[6]] = as.integer(c(1,2,3))
>> card(nb)
> [1] 2 3 4 3 2 3 0
>
>
>
> Barry
>
>
>
>
>
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From @tu@rt@reece @end|ng |rom b|gpond@com  Thu Aug  8 13:23:21 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 8 Aug 2019 21:23:21 +1000
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <alpine.LFD.2.21.1908081305351.7329@reclus.nhh.no>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
 <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
 <002001d54dd6$d6668240$833386c0$@bigpond.com>
 <alpine.LFD.2.21.1908081305351.7329@reclus.nhh.no>
Message-ID: <003201d54ddb$b2716490$17542db0$@bigpond.com>

Thankyou for this advice Roger.
Happy to provide my work for your review but I am not sure how.
This list server has a limit of 50KB and these files are about 100MB....
Love to assist but I would need advice on how best to proceed....???
Many thanks again,
Stuart.

-----Original Message-----
From: Roger Bivand <Roger.Bivand at nhh.no> 
Sent: Thursday, 8 August, 2019 9:10 PM
To: Stuart Reece <stuart.reece at bigpond.com>
Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List

On Thu, 8 Aug 2019, Stuart Reece wrote:

> Thankyou so much Vijay and Barry.

Yes, thanks!

>
> Yes I have found that using these techniques I can add nb 
> relationships nicely.
>
> And they card() nicely too.
>
> And when I nb2listw they transform well and when I test them
> can.be.simmed(x) they pass this test also.
>
> When I draw maps with them Like Roger Bivand showed in his examples 
> for poly2nb ? the maps draw just perfectly.

This is flying on hope not knowledge. If the assigned values are not within the 1:n set, there will be trouble - this is an S3 class with no validity check. Further, there may be trouble if the length of attr(.,
"region.id") is incorrect, but this cannot be checked unless you run
traceback() after the error in spgm(). We still need a fully reproducible example ...

Roger

> However when I use them in the spml or spgm regressions in package 
> splm they fail with an error message usually about indexes being out 
> of bounds.
>
> Running this code ?.
>
> summary(spgm(PC1MI ~ PC1Rx * log(mrjmon),
> +              data=MIdf9dfF2, listw=MIdf9sflww,
> +              lag=TRUE, moments="fullweights", method="g2sls",
> +              model="random", spatial.error=TRUE))
>
> Generates this error:
>
> Error in x[, ii] : subscript out of bounds
>
> I feel that I must be missing something here but am not able to put my 
> finger on what it is???
>
> Thanks so much again,
>
> Stuart.
>
>
>
>
>
>
>
>
>
> From: Dr Stuart Reece <asreece at bigpond.net.au>
> Sent: Thursday, 8 August, 2019 2:01 PM
> To: 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'Stuart Reece' 
> <stuart.reece at bigpond.com>
> Cc: 'Vijay Lulla' <vijaylulla at gmail.com>; 'R-sig-geo Mailing List' 
> <r-sig-geo at r-project.org>
> Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb 
> List
> Importance: High
>
>
>
> Thanks Barry.
>
> That is so perfect and so super helpful!!!
>
> And if I want to add three areas to an area ? say I want to add 6,7 and 8 to the area 10??
>
> Please may I have the syntax for that to avoid the integer error??
>
> Is this also the root of the error about not being the correct index??
>
> Many thanks again,
>
> Stuart.
>
>
>
> From: Barry Rowlingson [mailto:b.rowlingson at gmail.com]
> Sent: Thursday, 8 August 2019 8:51 AM
> To: Stuart Reece
> Cc: Vijay Lulla; R-sig-geo Mailing List; Stuart Reece
> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb 
> List
>
>
>
> I recently answered a similar question on Stack Overflow where someone needed to add detached polygons to their connected network by connecting them to their nearest neighbour:
>
>
>
> https://stackoverflow.com/questions/57269254/how-to-impute-missing-nei
> ghbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredirec
> t=1#comment101246065_57378930
>
>
>
> in short, you can treat a `nb` object like a list of vectors: nb[[i]] 
> is a vector of indexes of objects connected to object `i`
>
>
>
> BUT you have to make sure you store integers:
>
>
>
> Here's a `nb` object from that question which in summary has this manyneighbours for each region:
>
>
>
>> card(nb)
> [1] 2 3 4 3 2 0 0
>
>
>
> lets set the 6th feature to be a neighbour of the first:
>
>
>
>> nb[[6]] = 1
>
>
>
> then uh-oh...
>
>
>
>> card(nb)
> Error in card(nb) :
>  INTEGER() can only be applied to a 'integer', not a 'double'
>
>
>
> same again only `as.integer`:
>
>
>
>> nb[[6]] = as.integer(1)
>
>
>
> and its happy:
>
>
>
>> card(nb)
> [1] 2 3 4 3 2 1 0
>
>
>
> if you want to set the nighbours of 6 to several features:
>
>
>
>> nb[[6]] = as.integer(c(1,2,3))
>> card(nb)
> [1] 2 3 4 3 2 3 0
>
>
>
> Barry
>
>
>
>
>
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

--
Roger Bivand
Department of Economics, Norwegian School of Economics, Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Aug  8 13:34:52 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 8 Aug 2019 13:34:52 +0200
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <003201d54ddb$b2716490$17542db0$@bigpond.com>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
 <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
 <002001d54dd6$d6668240$833386c0$@bigpond.com>
 <alpine.LFD.2.21.1908081305351.7329@reclus.nhh.no>
 <003201d54ddb$b2716490$17542db0$@bigpond.com>
Message-ID: <alpine.LFD.2.21.1908081327390.7329@reclus.nhh.no>

On Thu, 8 Aug 2019, Stuart Reece wrote:

> Thankyou for this advice Roger.
> Happy to provide my work for your review but I am not sure how.
> This list server has a limit of 50KB and these files are about 100MB....
> Love to assist but I would need advice on how best to proceed....???

Choose a built-in data set, such as Produc, change two states to ALASKA 
and HAWAII, drop the ones you chose from the map and any other states not 
on your map, and use that data set, putting the script needed at the head 
of your example. Then create the weights, initially with no links to 
ALASKA and HAWAII, and run the model. Next, edit the neighbour object in 
script form, and try again. Then anyone with your map object (you gave a 
link), your script, and the plm and splm packages can reproduce your 
problem.

Do also run traceback() after errors, and post what you see.

Roger

> Many thanks again,
> Stuart.
>
> -----Original Message-----
> From: Roger Bivand <Roger.Bivand at nhh.no>
> Sent: Thursday, 8 August, 2019 9:10 PM
> To: Stuart Reece <stuart.reece at bigpond.com>
> Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
>
> On Thu, 8 Aug 2019, Stuart Reece wrote:
>
>> Thankyou so much Vijay and Barry.
>
> Yes, thanks!
>
>>
>> Yes I have found that using these techniques I can add nb
>> relationships nicely.
>>
>> And they card() nicely too.
>>
>> And when I nb2listw they transform well and when I test them
>> can.be.simmed(x) they pass this test also.
>>
>> When I draw maps with them Like Roger Bivand showed in his examples
>> for poly2nb ? the maps draw just perfectly.
>
> This is flying on hope not knowledge. If the assigned values are not within the 1:n set, there will be trouble - this is an S3 class with no validity check. Further, there may be trouble if the length of attr(.,
> "region.id") is incorrect, but this cannot be checked unless you run
> traceback() after the error in spgm(). We still need a fully reproducible example ...
>
> Roger
>
>> However when I use them in the spml or spgm regressions in package
>> splm they fail with an error message usually about indexes being out
>> of bounds.
>>
>> Running this code ?.
>>
>> summary(spgm(PC1MI ~ PC1Rx * log(mrjmon),
>> +              data=MIdf9dfF2, listw=MIdf9sflww,
>> +              lag=TRUE, moments="fullweights", method="g2sls",
>> +              model="random", spatial.error=TRUE))
>>
>> Generates this error:
>>
>> Error in x[, ii] : subscript out of bounds
>>
>> I feel that I must be missing something here but am not able to put my
>> finger on what it is???
>>
>> Thanks so much again,
>>
>> Stuart.
>>
>>
>>
>>
>>
>>
>>
>>
>>
>> From: Dr Stuart Reece <asreece at bigpond.net.au>
>> Sent: Thursday, 8 August, 2019 2:01 PM
>> To: 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'Stuart Reece'
>> <stuart.reece at bigpond.com>
>> Cc: 'Vijay Lulla' <vijaylulla at gmail.com>; 'R-sig-geo Mailing List'
>> <r-sig-geo at r-project.org>
>> Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb
>> List
>> Importance: High
>>
>>
>>
>> Thanks Barry.
>>
>> That is so perfect and so super helpful!!!
>>
>> And if I want to add three areas to an area ? say I want to add 6,7 and 8 to the area 10??
>>
>> Please may I have the syntax for that to avoid the integer error??
>>
>> Is this also the root of the error about not being the correct index??
>>
>> Many thanks again,
>>
>> Stuart.
>>
>>
>>
>> From: Barry Rowlingson [mailto:b.rowlingson at gmail.com]
>> Sent: Thursday, 8 August 2019 8:51 AM
>> To: Stuart Reece
>> Cc: Vijay Lulla; R-sig-geo Mailing List; Stuart Reece
>> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb
>> List
>>
>>
>>
>> I recently answered a similar question on Stack Overflow where someone needed to add detached polygons to their connected network by connecting them to their nearest neighbour:
>>
>>
>>
>> https://stackoverflow.com/questions/57269254/how-to-impute-missing-nei
>> ghbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredirec
>> t=1#comment101246065_57378930
>>
>>
>>
>> in short, you can treat a `nb` object like a list of vectors: nb[[i]]
>> is a vector of indexes of objects connected to object `i`
>>
>>
>>
>> BUT you have to make sure you store integers:
>>
>>
>>
>> Here's a `nb` object from that question which in summary has this manyneighbours for each region:
>>
>>
>>
>>> card(nb)
>> [1] 2 3 4 3 2 0 0
>>
>>
>>
>> lets set the 6th feature to be a neighbour of the first:
>>
>>
>>
>>> nb[[6]] = 1
>>
>>
>>
>> then uh-oh...
>>
>>
>>
>>> card(nb)
>> Error in card(nb) :
>>  INTEGER() can only be applied to a 'integer', not a 'double'
>>
>>
>>
>> same again only `as.integer`:
>>
>>
>>
>>> nb[[6]] = as.integer(1)
>>
>>
>>
>> and its happy:
>>
>>
>>
>>> card(nb)
>> [1] 2 3 4 3 2 1 0
>>
>>
>>
>> if you want to set the nighbours of 6 to several features:
>>
>>
>>
>>> nb[[6]] = as.integer(c(1,2,3))
>>> card(nb)
>> [1] 2 3 4 3 2 3 0
>>
>>
>>
>> Barry
>>
>>
>>
>>
>>
>>
>> 	[[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics, Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From @tu@rt@reece @end|ng |rom b|gpond@com  Thu Aug  8 13:42:52 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 8 Aug 2019 21:42:52 +1000
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <alpine.LFD.2.21.1908081327390.7329@reclus.nhh.no>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
 <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
 <002001d54dd6$d6668240$833386c0$@bigpond.com>
 <alpine.LFD.2.21.1908081305351.7329@reclus.nhh.no>
 <003201d54ddb$b2716490$17542db0$@bigpond.com>
 <alpine.LFD.2.21.1908081327390.7329@reclus.nhh.no>
Message-ID: <003d01d54dde$6add63b0$40982b10$@bigpond.com>

Thanks Roger.
Happy to do as you have requested.
Which server do you suggest??
Thanks again,
Stuart.

-----Original Message-----
From: Roger Bivand <Roger.Bivand at nhh.no> 
Sent: Thursday, 8 August, 2019 9:35 PM
To: Stuart Reece <stuart.reece at bigpond.com>
Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List

On Thu, 8 Aug 2019, Stuart Reece wrote:

> Thankyou for this advice Roger.
> Happy to provide my work for your review but I am not sure how.
> This list server has a limit of 50KB and these files are about 100MB....
> Love to assist but I would need advice on how best to proceed....???

Choose a built-in data set, such as Produc, change two states to ALASKA and HAWAII, drop the ones you chose from the map and any other states not on your map, and use that data set, putting the script needed at the head of your example. Then create the weights, initially with no links to ALASKA and HAWAII, and run the model. Next, edit the neighbour object in script form, and try again. Then anyone with your map object (you gave a link), your script, and the plm and splm packages can reproduce your problem.

Do also run traceback() after errors, and post what you see.

Roger

> Many thanks again,
> Stuart.
>
> -----Original Message-----
> From: Roger Bivand <Roger.Bivand at nhh.no>
> Sent: Thursday, 8 August, 2019 9:10 PM
> To: Stuart Reece <stuart.reece at bigpond.com>
> Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson' 
> <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List' 
> <r-sig-geo at r-project.org>
> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb 
> List
>
> On Thu, 8 Aug 2019, Stuart Reece wrote:
>
>> Thankyou so much Vijay and Barry.
>
> Yes, thanks!
>
>>
>> Yes I have found that using these techniques I can add nb 
>> relationships nicely.
>>
>> And they card() nicely too.
>>
>> And when I nb2listw they transform well and when I test them
>> can.be.simmed(x) they pass this test also.
>>
>> When I draw maps with them Like Roger Bivand showed in his examples 
>> for poly2nb ? the maps draw just perfectly.
>
> This is flying on hope not knowledge. If the assigned values are not 
> within the 1:n set, there will be trouble - this is an S3 class with 
> no validity check. Further, there may be trouble if the length of 
> attr(.,
> "region.id") is incorrect, but this cannot be checked unless you run
> traceback() after the error in spgm(). We still need a fully reproducible example ...
>
> Roger
>
>> However when I use them in the spml or spgm regressions in package 
>> splm they fail with an error message usually about indexes being out 
>> of bounds.
>>
>> Running this code ?.
>>
>> summary(spgm(PC1MI ~ PC1Rx * log(mrjmon),
>> +              data=MIdf9dfF2, listw=MIdf9sflww,
>> +              lag=TRUE, moments="fullweights", method="g2sls",
>> +              model="random", spatial.error=TRUE))
>>
>> Generates this error:
>>
>> Error in x[, ii] : subscript out of bounds
>>
>> I feel that I must be missing something here but am not able to put 
>> my finger on what it is???
>>
>> Thanks so much again,
>>
>> Stuart.
>>
>>
>>
>>
>>
>>
>>
>>
>>
>> From: Dr Stuart Reece <asreece at bigpond.net.au>
>> Sent: Thursday, 8 August, 2019 2:01 PM
>> To: 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'Stuart Reece'
>> <stuart.reece at bigpond.com>
>> Cc: 'Vijay Lulla' <vijaylulla at gmail.com>; 'R-sig-geo Mailing List'
>> <r-sig-geo at r-project.org>
>> Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb 
>> List
>> Importance: High
>>
>>
>>
>> Thanks Barry.
>>
>> That is so perfect and so super helpful!!!
>>
>> And if I want to add three areas to an area ? say I want to add 6,7 and 8 to the area 10??
>>
>> Please may I have the syntax for that to avoid the integer error??
>>
>> Is this also the root of the error about not being the correct index??
>>
>> Many thanks again,
>>
>> Stuart.
>>
>>
>>
>> From: Barry Rowlingson [mailto:b.rowlingson at gmail.com]
>> Sent: Thursday, 8 August 2019 8:51 AM
>> To: Stuart Reece
>> Cc: Vijay Lulla; R-sig-geo Mailing List; Stuart Reece
>> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb 
>> List
>>
>>
>>
>> I recently answered a similar question on Stack Overflow where someone needed to add detached polygons to their connected network by connecting them to their nearest neighbour:
>>
>>
>>
>> https://stackoverflow.com/questions/57269254/how-to-impute-missing-ne
>> i 
>> ghbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredire
>> c
>> t=1#comment101246065_57378930
>>
>>
>>
>> in short, you can treat a `nb` object like a list of vectors: nb[[i]] 
>> is a vector of indexes of objects connected to object `i`
>>
>>
>>
>> BUT you have to make sure you store integers:
>>
>>
>>
>> Here's a `nb` object from that question which in summary has this manyneighbours for each region:
>>
>>
>>
>>> card(nb)
>> [1] 2 3 4 3 2 0 0
>>
>>
>>
>> lets set the 6th feature to be a neighbour of the first:
>>
>>
>>
>>> nb[[6]] = 1
>>
>>
>>
>> then uh-oh...
>>
>>
>>
>>> card(nb)
>> Error in card(nb) :
>>  INTEGER() can only be applied to a 'integer', not a 'double'
>>
>>
>>
>> same again only `as.integer`:
>>
>>
>>
>>> nb[[6]] = as.integer(1)
>>
>>
>>
>> and its happy:
>>
>>
>>
>>> card(nb)
>> [1] 2 3 4 3 2 1 0
>>
>>
>>
>> if you want to set the nighbours of 6 to several features:
>>
>>
>>
>>> nb[[6]] = as.integer(c(1,2,3))
>>> card(nb)
>> [1] 2 3 4 3 2 3 0
>>
>>
>>
>> Barry
>>
>>
>>
>>
>>
>>
>> 	[[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics, Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>
>

--
Roger Bivand
Department of Economics, Norwegian School of Economics, Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Aug  8 13:52:25 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 8 Aug 2019 13:52:25 +0200
Subject: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
In-Reply-To: <003d01d54dde$6add63b0$40982b10$@bigpond.com>
References: <009c01d54d2e$8fcfc3d0$af6f4b70$@bigpond.com>
 <CAKkiGbsQ-_o4Xat8Kvk0T96qp+up2WWd8uj43qAC9yZrejJ8Vg@mail.gmail.com>
 <!&!AAAAAAAAAAAuAAAAAAAAACvIFxYXnARFpK90t5CVwycBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABAchGki5biRbVTthfUccItAQAAAAA=@bigpond.com>
 <CANVKczNCDXNNf+asX2Ck9vZS8AuQXzOcOk-hTdX3_E8rR4t13w@mail.gmail.com>
 <!&!AAAAAAAAAAAYAAAAAAAAAC2XKVZxHHFMoG7r07Dfp3zCgAAAEAAAAF5yKFIuGCVCrhhMDmnBynUBAAAAAA==@bigpond.net.au>
 <002001d54dd6$d6668240$833386c0$@bigpond.com>
 <alpine.LFD.2.21.1908081305351.7329@reclus.nhh.no>
 <003201d54ddb$b2716490$17542db0$@bigpond.com>
 <alpine.LFD.2.21.1908081327390.7329@reclus.nhh.no>
 <003d01d54dde$6add63b0$40982b10$@bigpond.com>
Message-ID: <alpine.LFD.2.21.1908081345590.7329@reclus.nhh.no>

On Thu, 8 Aug 2019, Stuart Reece wrote:

> Thanks Roger.
> Happy to do as you have requested.
> Which server do you suggest??

You gave the link to the map as:

https://www.samhsa.gov/data/report/2014-2016-nsduh-substate-region-shapefile 
leading to 
https://www.samhsa.gov/data/sites/default/files/cbhsq-reports/NSDUHsubstateShapeFile2016/ShapeFile2016.zip

I guess that is the input map. Produc is built into the plm package. So 
all we need is a script. Your data are no help; creating a reproducible 
example very often guides the person with the problem to a resolution even 
without external help. I see that your map has 300+ entities - in that 
case find another map that matches the setting (US with Alaska and Hawaii 
states, drop to 48 to match Produc).

Roger

> Thanks again,
> Stuart.
>
> -----Original Message-----
> From: Roger Bivand <Roger.Bivand at nhh.no>
> Sent: Thursday, 8 August, 2019 9:35 PM
> To: Stuart Reece <stuart.reece at bigpond.com>
> Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
> Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
>
> On Thu, 8 Aug 2019, Stuart Reece wrote:
>
>> Thankyou for this advice Roger.
>> Happy to provide my work for your review but I am not sure how.
>> This list server has a limit of 50KB and these files are about 100MB....
>> Love to assist but I would need advice on how best to proceed....???
>
> Choose a built-in data set, such as Produc, change two states to ALASKA and HAWAII, drop the ones you chose from the map and any other states not on your map, and use that data set, putting the script needed at the head of your example. Then create the weights, initially with no links to ALASKA and HAWAII, and run the model. Next, edit the neighbour object in script form, and try again. Then anyone with your map object (you gave a link), your script, and the plm and splm packages can reproduce your problem.
>
> Do also run traceback() after errors, and post what you see.
>
> Roger
>
>> Many thanks again,
>> Stuart.
>>
>> -----Original Message-----
>> From: Roger Bivand <Roger.Bivand at nhh.no>
>> Sent: Thursday, 8 August, 2019 9:10 PM
>> To: Stuart Reece <stuart.reece at bigpond.com>
>> Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson'
>> <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List'
>> <r-sig-geo at r-project.org>
>> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb
>> List
>>
>> On Thu, 8 Aug 2019, Stuart Reece wrote:
>>
>>> Thankyou so much Vijay and Barry.
>>
>> Yes, thanks!
>>
>>>
>>> Yes I have found that using these techniques I can add nb
>>> relationships nicely.
>>>
>>> And they card() nicely too.
>>>
>>> And when I nb2listw they transform well and when I test them
>>> can.be.simmed(x) they pass this test also.
>>>
>>> When I draw maps with them Like Roger Bivand showed in his examples
>>> for poly2nb ? the maps draw just perfectly.
>>
>> This is flying on hope not knowledge. If the assigned values are not
>> within the 1:n set, there will be trouble - this is an S3 class with
>> no validity check. Further, there may be trouble if the length of
>> attr(.,
>> "region.id") is incorrect, but this cannot be checked unless you run
>> traceback() after the error in spgm(). We still need a fully reproducible example ...
>>
>> Roger
>>
>>> However when I use them in the spml or spgm regressions in package
>>> splm they fail with an error message usually about indexes being out
>>> of bounds.
>>>
>>> Running this code ?.
>>>
>>> summary(spgm(PC1MI ~ PC1Rx * log(mrjmon),
>>> +              data=MIdf9dfF2, listw=MIdf9sflww,
>>> +              lag=TRUE, moments="fullweights", method="g2sls",
>>> +              model="random", spatial.error=TRUE))
>>>
>>> Generates this error:
>>>
>>> Error in x[, ii] : subscript out of bounds
>>>
>>> I feel that I must be missing something here but am not able to put
>>> my finger on what it is???
>>>
>>> Thanks so much again,
>>>
>>> Stuart.
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>> From: Dr Stuart Reece <asreece at bigpond.net.au>
>>> Sent: Thursday, 8 August, 2019 2:01 PM
>>> To: 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'Stuart Reece'
>>> <stuart.reece at bigpond.com>
>>> Cc: 'Vijay Lulla' <vijaylulla at gmail.com>; 'R-sig-geo Mailing List'
>>> <r-sig-geo at r-project.org>
>>> Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb
>>> List
>>> Importance: High
>>>
>>>
>>>
>>> Thanks Barry.
>>>
>>> That is so perfect and so super helpful!!!
>>>
>>> And if I want to add three areas to an area ? say I want to add 6,7 and 8 to the area 10??
>>>
>>> Please may I have the syntax for that to avoid the integer error??
>>>
>>> Is this also the root of the error about not being the correct index??
>>>
>>> Many thanks again,
>>>
>>> Stuart.
>>>
>>>
>>>
>>> From: Barry Rowlingson [mailto:b.rowlingson at gmail.com]
>>> Sent: Thursday, 8 August 2019 8:51 AM
>>> To: Stuart Reece
>>> Cc: Vijay Lulla; R-sig-geo Mailing List; Stuart Reece
>>> Subject: Re: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb
>>> List
>>>
>>>
>>>
>>> I recently answered a similar question on Stack Overflow where someone needed to add detached polygons to their connected network by connecting them to their nearest neighbour:
>>>
>>>
>>>
>>> https://stackoverflow.com/questions/57269254/how-to-impute-missing-ne
>>> i
>>> ghbours-of-a-spatial-weight-matrix-queen-contiguity/57378930?noredire
>>> c
>>> t=1#comment101246065_57378930
>>>
>>>
>>>
>>> in short, you can treat a `nb` object like a list of vectors: nb[[i]]
>>> is a vector of indexes of objects connected to object `i`
>>>
>>>
>>>
>>> BUT you have to make sure you store integers:
>>>
>>>
>>>
>>> Here's a `nb` object from that question which in summary has this manyneighbours for each region:
>>>
>>>
>>>
>>>> card(nb)
>>> [1] 2 3 4 3 2 0 0
>>>
>>>
>>>
>>> lets set the 6th feature to be a neighbour of the first:
>>>
>>>
>>>
>>>> nb[[6]] = 1
>>>
>>>
>>>
>>> then uh-oh...
>>>
>>>
>>>
>>>> card(nb)
>>> Error in card(nb) :
>>>  INTEGER() can only be applied to a 'integer', not a 'double'
>>>
>>>
>>>
>>> same again only `as.integer`:
>>>
>>>
>>>
>>>> nb[[6]] = as.integer(1)
>>>
>>>
>>>
>>> and its happy:
>>>
>>>
>>>
>>>> card(nb)
>>> [1] 2 3 4 3 2 1 0
>>>
>>>
>>>
>>> if you want to set the nighbours of 6 to several features:
>>>
>>>
>>>
>>>> nb[[6]] = as.integer(c(1,2,3))
>>>> card(nb)
>>> [1] 2 3 4 3 2 3 0
>>>
>>>
>>>
>>> Barry
>>>
>>>
>>>
>>>
>>>
>>>
>>> 	[[alternative HTML version deleted]]
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>
>>
>> --
>> Roger Bivand
>> Department of Economics, Norwegian School of Economics, Helleveien 30, N-5045 Bergen, Norway.
>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>> https://orcid.org/0000-0003-2392-6140
>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>>
>>
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics, Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From @tu@rt@reece @end|ng |rom b|gpond@com  Thu Aug  8 15:41:12 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 8 Aug 2019 23:41:12 +1000
Subject: [R-sig-Geo] 
 Getting spgm Models to work at Substate Levels - SAMHSA
 NSDUH Data - with Added nb Links
Message-ID: <006d01d54dee$f791a450$e6b4ecf0$@bigpond.com>

Thankyou so much again Roger.

 

Both the connectivity maps and regressions work fine with the state data so I hope you will not mind if I use the substate data from the link mentioned earlier at :

https://www.samhsa.gov/data/sites/default/files/cbhsq-reports/NSDUHsubstateShapeFile2016/ShapeFile2016.zip 

 

and then just subset for one state.  New York would be good to choose as it has Richmond Island off the southern tip of Long Island which is not connected to any other area.  So it naturally forms a major point of interest.

 

I have done my level best to follow your instructions very carefully.

 

My code follows - obviously including the path to the file on my machine.

The connectivity map - closely following your own model script of course -  is perfect.  The inserted link works just exactly correctly as you will see.

The spml model also works OK albeit with some mysterious error which I do not well understand, but I do not think it matters much either.

 

However the spgm model does not run at all.

Of course this is also the most important model.

This throws the usual error "Error in x[, ii] : subscript out of bounds".

I have included the traceback notes, but I do not understand them at all.

 

Thankyou again for all of your kind and gracious advice.

 

Yours sincerely,

Stuart.

 

 

################################################################################################################################################################################################

################## Using NYC as a Reproducible Example

# Substate Shapefile - Single Year



USC <- st_read(dsn=" [path to file]  /NSDUH/SubstateRegionData141516.shp")

dim(USC)

names(USC)



USCReduced <- USC[,c(1:6,10,14,18,22,26,30,34,38,42,46,50,66)]

dim(USCReduced)

names(USCReduced)



NYsf <- subset(USCReduced, ST_NAME=="New York")

NYsf$Ix <- 0:14

NYsf$YearDt <- as.POSIXct(as.Date("01/01/2015", format="%d/%m/%Y"), tz="GMT")

class(NYsf$YearDt)

dim(NYsf)

names(NYsf)

NYsf <- NYsf[,c(19,20,1:5,9,6,7,10,14,15,12,8,13,16,17,18)]

dim(NYsf)

names(NYsf)

glimpse(NYsf)

print(NYsf, n=15)



NYsfnb <- poly2nb(NYsf)

str(NYsfnb, max.level=0)

str(NYsfnb, max.level=1)

summary(NYsfnb)



attr(NYsfnb, "region.id")[1:8]



NYsfnbb <- NYsfnb



attr(NYsfnbb, "region.id")

NYsfnbb[[8]]                           # == Region 322 on the Original map

NYsfnbb[[8]] <- as.integer(5)

NYsfnbb[[8]]                           # == Region 322 on the Original map

NYsfnbb[[5]]                           # == Region 319 on the Original map

NYsfnbb[[5]] <- as.integer(c(6,7,8))

NYsfnbb[[5]]

card(NYsfnbb)

summary(NYsfnbb)



NYsflw  <- nb2listw(NYsfnb, zero.policy=TRUE)

NYsflww <- nb2listw(NYsfnbb)

str(NYsfnbb, max.level = 0)

str(NYsflww, max.level = 0)



can.be.simmed(NYsflww)



############### US Substate Test Mapping::

coordsSubstateNY <- st_coordinates(st_centroid(st_geometry(NYsf), of_largest_polygon = TRUE))



## SubState_q1

dxxx <- diffnb(NYsfnb, NYsfnbb)

plot(st_geometry(NYsf), border = "grey50")

plot(NYsfnb, coordsSubstateNY, add = TRUE, lwd=0.5)

plot(dxxx, coordsSubstateNY, add = TRUE, col = "red", lwd=2)

title(main=paste("Differences (red) in New York Sub-State GAL Queen Weights (Black) First Order - USA", cex.main=1))



### Checking w Regressions

summary(spml(asinh(smiyr) ~ cigmon * asinh(mrjmon), 

             data=NYsf, listw=NYsflww,

             lag=TRUE, effect="individual", 

             model="random", spatial.error="b"))



summary(spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), 

             data=NYsf, listw=NYsflww,

             lag=TRUE, moments="fullweights", method="g2sls",

             model="random", spatial.error=TRUE))



#    Error in x[, ii] : subscript out of bounds

# 

# > traceback()

# 13: na.omit.data.frame(list(`yend[, i]` = c(0, 0, 0, 0, 0, 0, 0, 

#                                             0, 0, 0, 0, 0, 0, 0, 0), H = numeric(0)))

# 12: na.omit(list(`yend[, i]` = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 

#                                  0, 0, 0, 0), H = numeric(0)))

# 11: model.frame.default(formula = yend[, i] ~ H - 1, drop.unused.levels = TRUE)

# 10: stats::model.frame(formula = yend[, i] ~ H - 1, drop.unused.levels = TRUE)

# 9: eval(mf, parent.frame())

# 8: eval(mf, parent.frame())

# 7: lm(yend[, i] ~ H - 1)

# 6: fitted.values(lm(yend[, i] ~ H - 1))

# 5: spgm.tsls(ywithin, wywithin, Xwithin, Hwithin)

# 4: ivplm.w2sls(Y = y, X = x, lag = TRUE, listw = Ws, listw2 = Ws2, 

#                twow = twow, lag.instruments = lag.instruments, T = T, N = N, 

#                NT = NT)

# 3: spsarargm(formula = formula, data = data, index = index, listw = listw, 

#              listw2 = listw2, moments = moments, lag = lag, endog = endog, 

#              instruments = instruments, verbose = verbose, effects = effects, 

#              control = control, lag.instruments = lag.instruments, optim.method = optim.method, 

#              pars = pars, twow = twow)

# 2: spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data = NYsf, listw = NYsflww, 

#         lag = TRUE, moments = "fullweights", model = "random", spatial.error = TRUE)

# 1: summary(spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data = NYsf, 

#                 listw = NYsflww, lag = TRUE, moments = "fullweights", model = "random", 

#                 spatial.error = TRUE))





-----Original Message-----
From: Roger Bivand <Roger.Bivand at nhh.no> 
Sent: Thursday, 8 August, 2019 9:35 PM
To: Stuart Reece <stuart.reece at bigpond.com>
Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List



On Thu, 8 Aug 2019, Stuart Reece wrote:



> Thankyou for this advice Roger.

> Happy to provide my work for your review but I am not sure how.

> This list server has a limit of 50KB and these files are about 100MB....

> Love to assist but I would need advice on how best to proceed....???



Choose a built-in data set, such as Produc, change two states to ALASKA and HAWAII, drop the ones you chose from the map and any other states not on your map, and use that data set, putting the script needed at the head of your example. Then create the weights, initially with no links to ALASKA and HAWAII, and run the model. Next, edit the neighbour object in script form, and try again. Then anyone with your map object (you gave a link), your script, and the plm and splm packages can reproduce your problem.



Do also run traceback() after errors, and post what you see.



Roger



> Many thanks again,

> Stuart.

> 


	[[alternative HTML version deleted]]


From j@ck@onmrodr|gue@ @end|ng |rom gm@||@com  Thu Aug  8 21:18:34 2019
From: j@ck@onmrodr|gue@ @end|ng |rom gm@||@com (Jackson Rodrigues)
Date: Thu, 8 Aug 2019 16:18:34 -0300
Subject: [R-sig-Geo] Trying to reproduce rLandsat8 package codes
Message-ID: <CAPL76w_idoNFE+2OL+eSitcvmC9AtVqVaixNEU2Au1A9NzawbQ@mail.gmail.com>

Dear folks,

Could anyone give a support in downloading LandSat images ?

I am trying to reproduce codes from rLandSat8 package.
However I could not move to the next step due to a problem with the file
downloaded.

*#First step: Download a file for a reproducible example like suggested*
#####################
DownloadLandsat <- function(url, output.name) {
  # todo: use RCurl instead of the system call

command.args <- paste0("-c cookies.txt -d 'username=",
usgs.username="myusername", "&password=", usgs.password="mypassword","'
https://earthexplorer.usgs.gov/login")

  # invoke the system call to curl.
  # I'd rather have done this with RCurl but couldn't get it working ;-(
  ret <- system2("curl", command.args, stdout=TRUE, stderr=TRUE)

  command.args <- paste0("-b cookies.txt -L ", url," -o ", output.name)
  ret <- system2("curl", command.args, stdout=TRUE, stderr=TRUE)
  #file.remove(cookies.txt)
  return(ret)
}
setwd("my folder")
curl_download(DownloadLandsat("
http://earthexplorer.usgs.gov/download/4923/LC82040322013219LGN00/STANDARD/INVSVC",
"LC82040322013219LGN00"))

*#Second Step: Use the file downloaded to reproduce the code.  *
####################
setwd("my folder")
product  <- "LC82040322013219LGN00"
l <- ReadLandsat8(product)
Error in file(con, "r") : cannot open the connection
In addition: Warning message:
In file(con, "r") :
  cannot open file 'LC82040322013219LGN00/LC82040322013219LGN00_MTL.txt':
No such file or directory

The file is in my folder and it seems to be downloaded properly.
However, this file has no extension in other words, it is
LC82040322013219LGN00 and not  LC82040322013219LGN00_MTL.txt.

What is wrong?
Is there any other easier way to download LandSat images using R? Long
series for example?

Best regards,

Jackson

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Aug  8 21:41:39 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 8 Aug 2019 21:41:39 +0200
Subject: [R-sig-Geo] 
 Getting spgm Models to work at Substate Levels - SAMHSA
 NSDUH Data - with Added nb Links
In-Reply-To: <006d01d54dee$f791a450$e6b4ecf0$@bigpond.com>
References: <006d01d54dee$f791a450$e6b4ecf0$@bigpond.com>
Message-ID: <alpine.LFD.2.21.1908082121350.15100@reclus.nhh.no>

On Thu, 8 Aug 2019, Stuart Reece wrote:

> Thankyou so much again Roger.
>
> Both the connectivity maps and regressions work fine with the state data 
> so I hope you will not mind if I use the substate data from the link 
> mentioned earlier at :
>
> https://www.samhsa.gov/data/sites/default/files/cbhsq-reports/NSDUHsubstateShapeFile2016/ShapeFile2016.zip
>
> and then just subset for one state.  New York would be good to choose as 
> it has Richmond Island off the southern tip of Long Island which is not 
> connected to any other area.  So it naturally forms a major point of 
> interest.
>
> I have done my level best to follow your instructions very carefully.

Thanks for your patience - now there is something to work on. It is easier 
to extract the code if you post plain text only, so my abbreviation is:

library(sf)
USC <- st_read(dsn="SubstateRegionData141516.shp")
USCReduced <- USC[,c(1:6,10,14,18,22,26,30,34,38,42,46,50,66)]
NYsf <- subset(USCReduced, ST_NAME=="New York")
NYsf$Ix <- 0:14
NYsf$YearDt <- as.POSIXct(as.Date("01/01/2015", format="%d/%m/%Y"),
tz="GMT")
NYsf <- NYsf[,c(19,20,1:5,9,6,7,10,14,15,12,8,13,16,17,18)]
library(spdep)
NYsfnb <- poly2nb(NYsf)
NYsfnb
NYsfnb[[8]] <- as.integer(5)
NYsfnb[[5]] <- as.integer(unique(sort(c(NYsfnb[[5]], 8))))
NYsflw  <- nb2listw(NYsfnb)
library(splm)
ml_obj <- spml(asinh(smiyr) ~ cigmon * asinh(mrjmon), data=NYsf,
  listw=NYsflw, lag=TRUE, effect="individual", model="random",
  spatial.error="b"))
gm_obj <- spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data=NYsf,
  listw=NYsflw, lag=TRUE, moments="fullweights", method="g2sls",
  model="random", spatial.error=TRUE)
# Error in x[, ii] : subscript out of bounds
gm_obj <- spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data=NYsf,
  listw=NYsflw, lag=TRUE, moments="weights", method="g2sls",
  model="random", spatial.error=TRUE)
# Error in x[, ii] : subscript out of bounds
gm_obj <- spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data=NYsf,
  listw=NYsflw, lag=TRUE, moments="initial", method="g2sls",
  model="random", spatial.error=TRUE)
# Error in x[, ii] : subscript out of bounds
gm_obj <- spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data=NYsf,
  listw=NYsflw, moments="fullweights", spatial.error=TRUE)
# Error in x[, ii] : subscript out of bounds

Could you please try to run the model through plm - this subset seems only 
to have one time period? Perhaps plm is more forgiving than splm? Maybe 
that is confusing the internals?

summary(lm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data=NYsf))
library(spatialreg)
summary(lagsarlm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data=NYsf,
  listw=NYsflw))

both complete without trouble?

Roger

>
> My code follows - obviously including the path to the file on my machine.
>
> The connectivity map - closely following your own model script of course -  is perfect.  The inserted link works just exactly correctly as you will see.
>
> The spml model also works OK albeit with some mysterious error which I do not well understand, but I do not think it matters much either.
>
>
>
> However the spgm model does not run at all.
>
> Of course this is also the most important model.
>
> This throws the usual error "Error in x[, ii] : subscript out of bounds".
>
> I have included the traceback notes, but I do not understand them at all.
>
>
>
> Thankyou again for all of your kind and gracious advice.
>
>
>
> Yours sincerely,
>
> Stuart.
>
>
>
>
>
> ################################################################################################################################################################################################
>
> ################## Using NYC as a Reproducible Example
>
> # Substate Shapefile - Single Year
>
>
>
> USC <- st_read(dsn=" [path to file]  /NSDUH/SubstateRegionData141516.shp")
>
> dim(USC)
>
> names(USC)
>
>
>
> USCReduced <- USC[,c(1:6,10,14,18,22,26,30,34,38,42,46,50,66)]
>
> dim(USCReduced)
>
> names(USCReduced)
>
>
>
> NYsf <- subset(USCReduced, ST_NAME=="New York")
>
> NYsf$Ix <- 0:14
>
> NYsf$YearDt <- as.POSIXct(as.Date("01/01/2015", format="%d/%m/%Y"), tz="GMT")
>
> class(NYsf$YearDt)
>
> dim(NYsf)
>
> names(NYsf)
>
> NYsf <- NYsf[,c(19,20,1:5,9,6,7,10,14,15,12,8,13,16,17,18)]
>
> dim(NYsf)
>
> names(NYsf)
>
> glimpse(NYsf)
>
> print(NYsf, n=15)
>
>
>
> NYsfnb <- poly2nb(NYsf)
>
> str(NYsfnb, max.level=0)
>
> str(NYsfnb, max.level=1)
>
> summary(NYsfnb)
>
>
>
> attr(NYsfnb, "region.id")[1:8]
>
>
>
> NYsfnbb <- NYsfnb
>
>
>
> attr(NYsfnbb, "region.id")
>
> NYsfnbb[[8]]                           # == Region 322 on the Original map
>
> NYsfnbb[[8]] <- as.integer(5)
>
> NYsfnbb[[8]]                           # == Region 322 on the Original map
>
> NYsfnbb[[5]]                           # == Region 319 on the Original map
>
> NYsfnbb[[5]] <- as.integer(c(6,7,8))
>
> NYsfnbb[[5]]
>
> card(NYsfnbb)
>
> summary(NYsfnbb)
>
>
>
> NYsflw  <- nb2listw(NYsfnb, zero.policy=TRUE)
>
> NYsflww <- nb2listw(NYsfnbb)
>
> str(NYsfnbb, max.level = 0)
>
> str(NYsflww, max.level = 0)
>
>
>
> can.be.simmed(NYsflww)
>
>
>
> ############### US Substate Test Mapping::
>
> coordsSubstateNY <- st_coordinates(st_centroid(st_geometry(NYsf), of_largest_polygon = TRUE))
>
>
>
> ## SubState_q1
>
> dxxx <- diffnb(NYsfnb, NYsfnbb)
>
> plot(st_geometry(NYsf), border = "grey50")
>
> plot(NYsfnb, coordsSubstateNY, add = TRUE, lwd=0.5)
>
> plot(dxxx, coordsSubstateNY, add = TRUE, col = "red", lwd=2)
>
> title(main=paste("Differences (red) in New York Sub-State GAL Queen Weights (Black) First Order - USA", cex.main=1))
>
>
>
> ### Checking w Regressions
>
> summary(spml(asinh(smiyr) ~ cigmon * asinh(mrjmon),
>
>             data=NYsf, listw=NYsflww,
>
>             lag=TRUE, effect="individual",
>
>             model="random", spatial.error="b"))
>
>
>
> summary(spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon),
>
>             data=NYsf, listw=NYsflww,
>
>             lag=TRUE, moments="fullweights", method="g2sls",
>
>             model="random", spatial.error=TRUE))
>
>
>
> #    Error in x[, ii] : subscript out of bounds
>
> #
>
> # > traceback()
>
> # 13: na.omit.data.frame(list(`yend[, i]` = c(0, 0, 0, 0, 0, 0, 0,
>
> #                                             0, 0, 0, 0, 0, 0, 0, 0), H = numeric(0)))
>
> # 12: na.omit(list(`yend[, i]` = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
>
> #                                  0, 0, 0, 0), H = numeric(0)))
>
> # 11: model.frame.default(formula = yend[, i] ~ H - 1, drop.unused.levels = TRUE)
>
> # 10: stats::model.frame(formula = yend[, i] ~ H - 1, drop.unused.levels = TRUE)
>
> # 9: eval(mf, parent.frame())
>
> # 8: eval(mf, parent.frame())
>
> # 7: lm(yend[, i] ~ H - 1)
>
> # 6: fitted.values(lm(yend[, i] ~ H - 1))
>
> # 5: spgm.tsls(ywithin, wywithin, Xwithin, Hwithin)
>
> # 4: ivplm.w2sls(Y = y, X = x, lag = TRUE, listw = Ws, listw2 = Ws2,
>
> #                twow = twow, lag.instruments = lag.instruments, T = T, N = N,
>
> #                NT = NT)
>
> # 3: spsarargm(formula = formula, data = data, index = index, listw = listw,
>
> #              listw2 = listw2, moments = moments, lag = lag, endog = endog,
>
> #              instruments = instruments, verbose = verbose, effects = effects,
>
> #              control = control, lag.instruments = lag.instruments, optim.method = optim.method,
>
> #              pars = pars, twow = twow)
>
> # 2: spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data = NYsf, listw = NYsflww,
>
> #         lag = TRUE, moments = "fullweights", model = "random", spatial.error = TRUE)
>
> # 1: summary(spgm(asinh(smiyr) ~ cigmon * asinh(mrjmon), data = NYsf,
>
> #                 listw = NYsflww, lag = TRUE, moments = "fullweights", model = "random",
>
> #                 spatial.error = TRUE))
>
>
>
>
>
> -----Original Message-----
> From: Roger Bivand <Roger.Bivand at nhh.no>
> Sent: Thursday, 8 August, 2019 9:35 PM
> To: Stuart Reece <stuart.reece at bigpond.com>
> Cc: 'Dr Stuart Reece' <asreece at bigpond.net.au>; 'Barry Rowlingson' <b.rowlingson at gmail.com>; 'R-sig-geo Mailing List' <r-sig-geo at r-project.org>
> Subject: RE: [R-sig-Geo] Adding a Few Neighbour Relationships to a nb List
>
>
>
> On Thu, 8 Aug 2019, Stuart Reece wrote:
>
>
>
>> Thankyou for this advice Roger.
>
>> Happy to provide my work for your review but I am not sure how.
>
>> This list server has a limit of 50KB and these files are about 100MB....
>
>> Love to assist but I would need advice on how best to proceed....???
>
>
>
> Choose a built-in data set, such as Produc, change two states to ALASKA and HAWAII, drop the ones you chose from the map and any other states not on your map, and use that data set, putting the script needed at the head of your example. Then create the weights, initially with no links to ALASKA and HAWAII, and run the model. Next, edit the neighbour object in script form, and try again. Then anyone with your map object (you gave a link), your script, and the plm and splm packages can reproduce your problem.
>
>
>
> Do also run traceback() after errors, and post what you see.
>
>
>
> Roger
>
>
>
>> Many thanks again,
>
>> Stuart.
>
>>
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Sat Aug 10 10:38:24 2019
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Sat, 10 Aug 2019 10:38:24 +0200
Subject: [R-sig-Geo] st_sample with raster
In-Reply-To: <E697FE84-B258-4A29-A068-A73FB52DAC88@icloud.com>
References: <E697FE84-B258-4A29-A068-A73FB52DAC88@icloud.com>
Message-ID: <f575da64-9887-6a21-7f6c-abffc69eff3d@uni-muenster.de>

sf::st_sample has a size argument, which can be specified as a vector to
operate per feature. If you give that a value equal to

st_area(obj) * obj$required_density

and maybe set exact = FALSE, you should get the densities you want.

On 7/30/19 12:25 AM, Tyler Frazier via R-sig-Geo wrote:
> Hi All,
> 
> Spatstat::rpoint has an argument f that accepts a pixel image object (class .im) to generate points based on the proportionate probability density of that raster.  Just wondering, does sf::st_sample or perhaps another function have a similar available method?
> 
> Thanks so much!
> Ty
> 
> Tyler Frazier, Ph.D.
> Lecturer of Interdisciplinary Studies
> Data Science Program
> College of William and Mary
> Webpage: http://tjfrazier.people.wm.edu
> Phone: +01 (757) 386-1269
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

-------------- next part --------------
A non-text attachment was scrubbed...
Name: pEpkey.asc
Type: application/pgp-keys
Size: 2472 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190810/bbbfb641/attachment.bin>

From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Sat Aug 10 10:41:38 2019
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Sat, 10 Aug 2019 10:41:38 +0200
Subject: [R-sig-Geo] regression-kriging and co-kriging
In-Reply-To: <20190806110642.8A75583CB0CA@srv00.area.ba.cnr.it>
References: <20190806110642.8A75583CB0CA@srv00.area.ba.cnr.it>
Message-ID: <da76da51-e46b-8a8d-4952-7c3b85c19687@uni-muenster.de>

Hard to tell from your script. Maybe give a reproducible example?

On 8/6/19 1:07 PM, Emanuele Barca wrote:
> Dear  r-sig-geo friends,
> 
> I produced two maps garnered in the following way:
> 
> # for regression-kriging
> Piezo.map <-autoKrige(LivStat ~  Z, input_data = mydata.sp, new_data
> = covariates,  model = "Ste")
> 
> Piezork.pred <- Piezo.map$krige_output$var1.pred
> Piezork.coords <- Piezo.map$krige_output at coords
> Piezork.out <- as.data.frame(cbind(Piezork.coords, Piezork.pred))
> colnames(Piezork.out)[1:2] <- c("X", "Y")
> coordinates(Piezork.out) = ~ X + Y
> gridded(Piezork.out) <- TRUE
> 
> spplot(Piezork.out, main = list(label = "R-k Hydraulic head", cex = 1.5))
> 
> #for co-kriging
> g <- gstat(id = "Piezo", formula = LivStat ~ 1, data = mydata.sp, set
> = list(nocheck = 1))
> g <- gstat(g, id = "Z", formula = Z ~ 1, data = mydata.sp, set =
> list(nocheck = 1))
> 
> v.g <- variogram(g)
> 
> #g <- gstat(g, id = "Piezo", model = vgm(150, "Mat", 1350, 0.0, kappa
> = 1.9), fill.all = T)#
> g <- gstat(g, id = "Piezo", model = vgm(0.7, "Ste", 1300, 18, kappa =
> 1.9), fill.all = T)#
> g.fit <- fit.lmc(v.g, g, fit.lmc = TRUE, correct.diagonal = 1.01) #
> fit multivariable variogram model , fit.lmc = TRUE, correct.diagonal = 1.01
> g.fit
> plot(v.g, model = g.fit, main = "Fitted Variogram Models - Raw Data")#
> #gridded(covariates) <- TRUE
> g.cok <- predict(g.fit, newdata = covariates)#grid
> 
> g.cok.pred <- g.cok at data$Piezo.pred
> aaaa <- na.omit(g.cok.pred)
> g.cok.coords <- g.cok at coords
> g.cok.out <- as.data.frame(cbind(g.cok.coords, g.cok.pred))
> colnames(g.cok.out)[1:2] <- c("X", "Y")
> coordinates(g.cok.out) = ~ X + Y
> gridded(g.cok.out) <- TRUE
> spplot(g.cok.out, main = list(label = "Hydraulic head with
> Co-kriging", cex = 1.5))
> 
> ###########################################################################################################################
> 
> I am unable to understand why the first map appears as a raster and
> the second not, notwithstanding the fact that they are both computed
> on the same "covariates" DEM???
> 
> where is the mistake???
> 
> regards
> 
> emanuele
> 
> ________________________________________________________
> Emanuele Barca                               Researcher
> Water Research Institute                       (IRSA-CNR)
> Via De Blasio, 5                       70123 Bari (Italy)
> Phone +39 080 5820535               Fax  +39 080 5313365
> Mobile +39 340 3420689
> _________________________________________________________
> 
> 
> 
> ---
> Questa e-mail ? stata controllata per individuare virus con Avast antivirus.
> https://www.avast.com/antivirus
> 
> 	[[alternative HTML version deleted]]
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

-------------- next part --------------
A non-text attachment was scrubbed...
Name: pEpkey.asc
Type: application/pgp-keys
Size: 2472 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190810/b5cb9d77/attachment.bin>

From rv@|dezr @end|ng |rom gm@||@com  Fri Aug  9 23:16:13 2019
From: rv@|dezr @end|ng |rom gm@||@com (Rolando Valdez)
Date: Fri, 9 Aug 2019 16:16:13 -0500
Subject: [R-sig-Geo] Error when running a Spatial Durbin Error Model without
 intercept
Message-ID: <CAFvJtoHh35Q-fZXwU1L5PJh-hO_P9Xhg3388M8NNjqUkkWsTXQ-5163@mail.gmail.com>

Dear list,

I am trying to run a Spatial Durbin Error Model without intercept, however,
I do get an error:

 In spatialreg::errorsarlm(formula = formula, data = data, listw = listw,  :
  model configuration issue: no total impacts

This is what I am doing:

library(spatialreg)
library(spdep)
data(oldcol, package = "spdep")
W <- spdep::nb2listw(COL.nb, style = "W")
eq <- CRIME ~ 0 + INC + HOVAL
sdem <- errorsarlm(eq, data = COL.OLD, listw = W, etype = "emixed",
                   method = "eigen")

Thanks for any advice.
-- 
Rol~

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Sat Aug 10 14:05:45 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Sat, 10 Aug 2019 14:05:45 +0200
Subject: [R-sig-Geo] 
 Error when running a Spatial Durbin Error Model without intercept
In-Reply-To: <CAFvJtoHh35Q-fZXwU1L5PJh-hO_P9Xhg3388M8NNjqUkkWsTXQ-5163@mail.gmail.com>
References: <CAFvJtoHh35Q-fZXwU1L5PJh-hO_P9Xhg3388M8NNjqUkkWsTXQ-5163@mail.gmail.com>
Message-ID: <alpine.LFD.2.21.1908101402260.18903@reclus.nhh.no>

On Fri, 9 Aug 2019, Rolando Valdez wrote:

> Dear list,
>
> I am trying to run a Spatial Durbin Error Model without intercept, however,
> I do get an error:
>
> In spatialreg::errorsarlm(formula = formula, data = data, listw = listw,  :
>  model configuration issue: no total impacts

I can reproduce the problem, with error messages:

> sdem <- errorsarlm(eq, data = COL.OLD, listw = W, etype = "emixed",
+                    method = "eigen")
Error in estimable.default(lm.target, cm) :
   `cm' argument must be of type vector, list, or matrix.
In addition: Warning messages:
1: Function errorsarlm moved to the spatialreg package
2: In spatialreg::errorsarlm(formula = formula, data = data, listw = 
listw,  :
   model configuration issue: no total impacts
> traceback()
6: stop("`cm' argument must be of type vector, list, or matrix.")
5: estimable.default(lm.target, cm)
4: estimable(lm.target, cm)
3: as.matrix(estimable(lm.target, cm)[, 1:2, drop = FALSE])
2: spatialreg::errorsarlm(formula = formula, data = data, listw = listw,
        na.action = na.action, Durbin = Durbin, etype = etype, method = 
method,
        quiet = quiet, zero.policy = zero.policy, interval = interval,
        tol.solve = tol.solve, trs = trs, control = control)
1: errorsarlm(eq, data = COL.OLD, listw = W, etype = "emixed", method = 
"eigen")

I think that the construction of the specification matrix for 
gmodels::estimable() is faulty; will explore whether no-intercept is 
supportable.

Roger

>
> This is what I am doing:
>
> library(spatialreg)
> library(spdep)
> data(oldcol, package = "spdep")
> W <- spdep::nb2listw(COL.nb, style = "W")
> eq <- CRIME ~ 0 + INC + HOVAL
> sdem <- errorsarlm(eq, data = COL.OLD, listw = W, etype = "emixed",
>                   method = "eigen")
>
> Thanks for any advice.
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Sat Aug 10 16:34:27 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Sat, 10 Aug 2019 14:34:27 +0000
Subject: [R-sig-Geo] 
 Error when running a Spatial Durbin Error Model without intercept
In-Reply-To: <alpine.LFD.2.21.1908101402260.18903@reclus.nhh.no>
References: <CAFvJtoHh35Q-fZXwU1L5PJh-hO_P9Xhg3388M8NNjqUkkWsTXQ-5163@mail.gmail.com>,
 <alpine.LFD.2.21.1908101402260.18903@reclus.nhh.no>
Message-ID: <1b9ed967bbc941a2986e11569e14b88a@nhh.no>

And for completeness (https://github.com/r-spatial/spatialreg/issues/7):

> dem <- lmSLX(eq, data = COL.OLD, listw = W)
Error in lmSLX(eq, data = COL.OLD, listw = W) : 
  object 'dirImps' not found
In addition: Warning message:
In lmSLX(eq, data = COL.OLD, listw = W) :
  model configuration issue: no total impacts
> traceback()
1: lmSLX(eq, data = COL.OLD, listw = W)

Please follow up on github if you are present there.

Roger



--
Roger Bivand
Norwegian School of Economics
Helleveien 30, 5045 Bergen, Norway
Roger.Bivand at nhh.no


________________________________________
Fra: R-sig-Geo <r-sig-geo-bounces at r-project.org> p? vegne av Roger Bivand <Roger.Bivand at nhh.no>
Sendt: l?rdag 10. august 2019 14.05
Til: Rolando Valdez
Kopi: r-sig-geo at r-project.org
Emne: Re: [R-sig-Geo]  Error when running a Spatial Durbin Error Model without intercept

On Fri, 9 Aug 2019, Rolando Valdez wrote:

> Dear list,
>
> I am trying to run a Spatial Durbin Error Model without intercept, however,
> I do get an error:
>
> In spatialreg::errorsarlm(formula = formula, data = data, listw = listw,  :
>  model configuration issue: no total impacts

I can reproduce the problem, with error messages:

> sdem <- errorsarlm(eq, data = COL.OLD, listw = W, etype = "emixed",
+                    method = "eigen")
Error in estimable.default(lm.target, cm) :
   `cm' argument must be of type vector, list, or matrix.
In addition: Warning messages:
1: Function errorsarlm moved to the spatialreg package
2: In spatialreg::errorsarlm(formula = formula, data = data, listw =
listw,  :
   model configuration issue: no total impacts
> traceback()
6: stop("`cm' argument must be of type vector, list, or matrix.")
5: estimable.default(lm.target, cm)
4: estimable(lm.target, cm)
3: as.matrix(estimable(lm.target, cm)[, 1:2, drop = FALSE])
2: spatialreg::errorsarlm(formula = formula, data = data, listw = listw,
        na.action = na.action, Durbin = Durbin, etype = etype, method =
method,
        quiet = quiet, zero.policy = zero.policy, interval = interval,
        tol.solve = tol.solve, trs = trs, control = control)
1: errorsarlm(eq, data = COL.OLD, listw = W, etype = "emixed", method =
"eigen")

I think that the construction of the specification matrix for
gmodels::estimable() is faulty; will explore whether no-intercept is
supportable.

Roger

>
> This is what I am doing:
>
> library(spatialreg)
> library(spdep)
> data(oldcol, package = "spdep")
> W <- spdep::nb2listw(COL.nb, style = "W")
> eq <- CRIME ~ 0 + INC + HOVAL
> sdem <- errorsarlm(eq, data = COL.OLD, listw = W, etype = "emixed",
>                   method = "eigen")
>
> Thanks for any advice.
>

--
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://stat.ethz.ch/mailman/listinfo/r-sig-geo


From jo@eph|ew|@1992 @end|ng |rom gm@||@com  Sun Aug 11 22:51:29 2019
From: jo@eph|ew|@1992 @end|ng |rom gm@||@com (Joe Lewis)
Date: Sun, 11 Aug 2019 21:51:29 +0100
Subject: [R-sig-Geo] spatstat - user-supplied list of point patterns in
 envelope() error
Message-ID: <CAM0xMQ_5tq-bPrkUETB1bND_CWVAEX2+HXVTAM+DbxXj7PsSuQ@mail.gmail.com>

Dear list,

I'm trying to use a user-supplied list of point patterns in envelope()
rather than test against the CSR. Page 400 of Spatial Point Patterns:
Methodology and Applications in R states that "the argument simulate
can be a list of point patterns". However, I get the following error
when I try  to supply a list of ppp:

 ekls <- envelope.lpp(Y =  xx, fun = linearK, nsim=5, simulate = pp_list)
Error in envelopeEngine(X = X, fun = fun, simul = simrecipe, nsim = nsim,  :
  ?simulate? should be an expression, or a list of point patterns

for reference,

xx
Point pattern on linear network
680 points
Linear network with 22 vertices and 21 lines
Enclosing window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres

class(xx)
[1] "lpp" "ppx"

pp_list
List of point patterns

Component 1:
Planar point pattern: 513 points
window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres

Component 2:
Planar point pattern: 422 points
window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres

Component 3:
Planar point pattern: 495 points
window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres

Component 4:
Planar point pattern: 557 points
window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres

Component 5:
Planar point pattern: 576 points
window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres

class(pp_list)
[1] "ppplist" "solist"  "anylist" "listof"  "list"

Any ideas why the error is occurring? Thanks.


From r@turner @end|ng |rom @uck|@nd@@c@nz  Mon Aug 12 00:59:30 2019
From: r@turner @end|ng |rom @uck|@nd@@c@nz (Rolf Turner)
Date: Mon, 12 Aug 2019 10:59:30 +1200
Subject: [R-sig-Geo] [FORGED] spatstat - user-supplied list of point
 patterns in envelope() error
In-Reply-To: <CAM0xMQ_5tq-bPrkUETB1bND_CWVAEX2+HXVTAM+DbxXj7PsSuQ@mail.gmail.com>
References: <CAM0xMQ_5tq-bPrkUETB1bND_CWVAEX2+HXVTAM+DbxXj7PsSuQ@mail.gmail.com>
Message-ID: <99829299-bff2-2bdb-cd3c-d7d23864166d@auckland.ac.nz>


On 12/08/19 8:51 AM, Joe Lewis wrote:

> Dear list,
> 
> I'm trying to use a user-supplied list of point patterns in envelope()
> rather than test against the CSR. Page 400 of Spatial Point Patterns:
> Methodology and Applications in R states that "the argument simulate
> can be a list of point patterns". However, I get the following error
> when I try  to supply a list of ppp:
> 
>   ekls <- envelope.lpp(Y =  xx, fun = linearK, nsim=5, simulate = pp_list)
> Error in envelopeEngine(X = X, fun = fun, simul = simrecipe, nsim = nsim,  :
>    ?simulate? should be an expression, or a list of point patterns
> 
> for reference,
> 
> xx
> Point pattern on linear network
> 680 points
> Linear network with 22 vertices and 21 lines
> Enclosing window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> 
> class(xx)
> [1] "lpp" "ppx"
> 
> pp_list
> List of point patterns
> 
> Component 1:
> Planar point pattern: 513 points
> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> 
> Component 2:
> Planar point pattern: 422 points
> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> 
> Component 3:
> Planar point pattern: 495 points
> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> 
> Component 4:
> Planar point pattern: 557 points
> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> 
> Component 5:
> Planar point pattern: 576 points
> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> 
> class(pp_list)
> [1] "ppplist" "solist"  "anylist" "listof"  "list"
> 
> Any ideas why the error is occurring? Thanks.

It's hard to say without having a *reproducible* example.  Since we 
don't have access to "xx" or to "pp.list" we cannot experiment to see 
what's going on.

One problem that leaps out at me --- although it doesn't seem that this 
should trigger the error message that you received --- is that the 
entries of pp_list appear to be *planar point patterns* (of class "ppp") 
whereas "xx" is a pattern on a linear network (of class "lpp"). 
Consequently there is a fundamental incompatibility here.

However I don't see why you would get the error message that you did.  I 
am CC-ing this email to Adrian Baddeley who has more insight than I, and 
may be able to point you in the right direction.  Adrian is kind of 
overwhelmed with work at the moment, so it may be a while till you hear 
from him.

If you provide a reproducible example I *may* be able to help.

cheers,

Rolf Turner

-- 
Honorary Research Fellow
Department of Statistics
University of Auckland
Phone: +64-9-373-7599 ext. 88276


From r@turner @end|ng |rom @uck|@nd@@c@nz  Mon Aug 12 04:31:45 2019
From: r@turner @end|ng |rom @uck|@nd@@c@nz (Rolf Turner)
Date: Mon, 12 Aug 2019 14:31:45 +1200
Subject: [R-sig-Geo] [FORGED] spatstat - user-supplied list of point
 patterns in envelope() error
In-Reply-To: <99829299-bff2-2bdb-cd3c-d7d23864166d@auckland.ac.nz>
References: <CAM0xMQ_5tq-bPrkUETB1bND_CWVAEX2+HXVTAM+DbxXj7PsSuQ@mail.gmail.com>
 <99829299-bff2-2bdb-cd3c-d7d23864166d@auckland.ac.nz>
Message-ID: <188f64b4-2d64-7783-dd8c-262a28bb6c80@auckland.ac.nz>


Dear Joe,

Further to my previous response to your post:  I have now been in touch 
with Adrian Baddeley and he has confirmed that the problem is as I 
conjectured:   The patterns in "pp_list" need to be compatible with 
"xx".  The error message was a bit misleading.  (Adrian has now adjusted 
the error message so as to make it more clear what the problem actually is.)

However there was also a genuine bug (that was revealed by your 
question; thank you!!!) in the software, so even if pp_list had been a 
list of patterns of the appropriate type, you would still have got an 
error.  (A spurious error, caused by the bug; different message of course.)

The bug has been been fixed in the development version of spatstat 
(1.60-1.022).  You will need to install that from github:

library(remotes)
install_github('spatstat/spatstat')

or wait for the next "official release" of spatstat on CRAN.  Such 
releases happen about every three months; the last one was on
23/June/2019.

cheers,

Rolf

> On 12/08/19 8:51 AM, Joe Lewis wrote:
> 
>> Dear list,
>>
>> I'm trying to use a user-supplied list of point patterns in envelope()
>> rather than test against the CSR. Page 400 of Spatial Point Patterns:
>> Methodology and Applications in R states that "the argument simulate
>> can be a list of point patterns". However, I get the following error
>> when I try? to supply a list of ppp:
>>
>> ? ekls <- envelope.lpp(Y =? xx, fun = linearK, nsim=5, simulate = 
>> pp_list)
>> Error in envelopeEngine(X = X, fun = fun, simul = simrecipe, nsim = 
>> nsim,? :
>> ?? ?simulate? should be an expression, or a list of point patterns
>>
>> for reference,
>>
>> xx
>> Point pattern on linear network
>> 680 points
>> Linear network with 22 vertices and 21 lines
>> Enclosing window: rectangle = [284086.69, 309740] x [709900, 726547.7] 
>> metres
>>
>> class(xx)
>> [1] "lpp" "ppx"
>>
>> pp_list
>> List of point patterns
>>
>> Component 1:
>> Planar point pattern: 513 points
>> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
>>
>> Component 2:
>> Planar point pattern: 422 points
>> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
>>
>> Component 3:
>> Planar point pattern: 495 points
>> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
>>
>> Component 4:
>> Planar point pattern: 557 points
>> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
>>
>> Component 5:
>> Planar point pattern: 576 points
>> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
>>
>> class(pp_list)
>> [1] "ppplist" "solist"? "anylist" "listof"? "list"
>>
>> Any ideas why the error is occurring? Thanks.
> 
> It's hard to say without having a *reproducible* example.? Since we 
> don't have access to "xx" or to "pp.list" we cannot experiment to see 
> what's going on.
> 
> One problem that leaps out at me --- although it doesn't seem that this 
> should trigger the error message that you received --- is that the 
> entries of pp_list appear to be *planar point patterns* (of class "ppp") 
> whereas "xx" is a pattern on a linear network (of class "lpp"). 
> Consequently there is a fundamental incompatibility here.
> 
> However I don't see why you would get the error message that you did.? I 
> am CC-ing this email to Adrian Baddeley who has more insight than I, and 
> may be able to point you in the right direction.? Adrian is kind of 
> overwhelmed with work at the moment, so it may be a while till you hear 
> from him.
> 
> If you provide a reproducible example I *may* be able to help.


From jo@eph|ew|@1992 @end|ng |rom gm@||@com  Mon Aug 12 14:01:25 2019
From: jo@eph|ew|@1992 @end|ng |rom gm@||@com (Joe Lewis)
Date: Mon, 12 Aug 2019 13:01:25 +0100
Subject: [R-sig-Geo] [FORGED] spatstat - user-supplied list of point
 patterns in envelope() error
In-Reply-To: <188f64b4-2d64-7783-dd8c-262a28bb6c80@auckland.ac.nz>
References: <CAM0xMQ_5tq-bPrkUETB1bND_CWVAEX2+HXVTAM+DbxXj7PsSuQ@mail.gmail.com>
 <99829299-bff2-2bdb-cd3c-d7d23864166d@auckland.ac.nz>
 <188f64b4-2d64-7783-dd8c-262a28bb6c80@auckland.ac.nz>
Message-ID: <CAM0xMQ-ZwqyHv_JpQ3kos2wVg8_N3A6DDqneZ=G+ELeH7opO+w@mail.gmail.com>

Hi Rolf,

Thank you for the prompt reply.

Now that you mentioned it, it seems such a silly mistake for me to make!

I appreciate the help.

Kind regards,
Joe

On Mon, Aug 12, 2019 at 3:31 AM Rolf Turner <r.turner at auckland.ac.nz> wrote:
>
>
> Dear Joe,
>
> Further to my previous response to your post:  I have now been in touch
> with Adrian Baddeley and he has confirmed that the problem is as I
> conjectured:   The patterns in "pp_list" need to be compatible with
> "xx".  The error message was a bit misleading.  (Adrian has now adjusted
> the error message so as to make it more clear what the problem actually is.)
>
> However there was also a genuine bug (that was revealed by your
> question; thank you!!!) in the software, so even if pp_list had been a
> list of patterns of the appropriate type, you would still have got an
> error.  (A spurious error, caused by the bug; different message of course.)
>
> The bug has been been fixed in the development version of spatstat
> (1.60-1.022).  You will need to install that from github:
>
> library(remotes)
> install_github('spatstat/spatstat')
>
> or wait for the next "official release" of spatstat on CRAN.  Such
> releases happen about every three months; the last one was on
> 23/June/2019.
>
> cheers,
>
> Rolf
>
> > On 12/08/19 8:51 AM, Joe Lewis wrote:
> >
> >> Dear list,
> >>
> >> I'm trying to use a user-supplied list of point patterns in envelope()
> >> rather than test against the CSR. Page 400 of Spatial Point Patterns:
> >> Methodology and Applications in R states that "the argument simulate
> >> can be a list of point patterns". However, I get the following error
> >> when I try  to supply a list of ppp:
> >>
> >>   ekls <- envelope.lpp(Y =  xx, fun = linearK, nsim=5, simulate =
> >> pp_list)
> >> Error in envelopeEngine(X = X, fun = fun, simul = simrecipe, nsim =
> >> nsim,  :
> >>    ?simulate? should be an expression, or a list of point patterns
> >>
> >> for reference,
> >>
> >> xx
> >> Point pattern on linear network
> >> 680 points
> >> Linear network with 22 vertices and 21 lines
> >> Enclosing window: rectangle = [284086.69, 309740] x [709900, 726547.7]
> >> metres
> >>
> >> class(xx)
> >> [1] "lpp" "ppx"
> >>
> >> pp_list
> >> List of point patterns
> >>
> >> Component 1:
> >> Planar point pattern: 513 points
> >> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> >>
> >> Component 2:
> >> Planar point pattern: 422 points
> >> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> >>
> >> Component 3:
> >> Planar point pattern: 495 points
> >> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> >>
> >> Component 4:
> >> Planar point pattern: 557 points
> >> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> >>
> >> Component 5:
> >> Planar point pattern: 576 points
> >> window: rectangle = [284086.69, 309740] x [709900, 726547.7] metres
> >>
> >> class(pp_list)
> >> [1] "ppplist" "solist"  "anylist" "listof"  "list"
> >>
> >> Any ideas why the error is occurring? Thanks.
> >
> > It's hard to say without having a *reproducible* example.  Since we
> > don't have access to "xx" or to "pp.list" we cannot experiment to see
> > what's going on.
> >
> > One problem that leaps out at me --- although it doesn't seem that this
> > should trigger the error message that you received --- is that the
> > entries of pp_list appear to be *planar point patterns* (of class "ppp")
> > whereas "xx" is a pattern on a linear network (of class "lpp").
> > Consequently there is a fundamental incompatibility here.
> >
> > However I don't see why you would get the error message that you did.  I
> > am CC-ing this email to Adrian Baddeley who has more insight than I, and
> > may be able to point you in the right direction.  Adrian is kind of
> > overwhelmed with work at the moment, so it may be a while till you hear
> > from him.
> >
> > If you provide a reproducible example I *may* be able to help.


From r@|@@pere|r@@br @end|ng |rom gm@||@com  Mon Aug 12 18:29:39 2019
From: r@|@@pere|r@@br @end|ng |rom gm@||@com (Rafael Pereira)
Date: Mon, 12 Aug 2019 13:29:39 -0300
Subject: [R-sig-Geo] geobr: easy access to official spatial data sets of
 Brazil
Message-ID: <CAA42DGn71TyiEOJnGaMHxWbs0o-_eixQ+9nSb9MCt15Z-Cc7KA@mail.gmail.com>

Dear all,

I'm glad to annouce geobr <https://github.com/ipeaGIT/geobr>, an R package
that provides easy and quick access to official spatia data sets of Brazil.
The package currently includes several data sets for various years such as
states, regions, municipalities, census tracts, statistical grid and
others.  geobr is available on CRAN, and the github repository is here:
https://github.com/ipeaGIT/geobr. I hope this can be useful to some of you
in the group.

The package was developed by my team and I at the Institute for Applied
Economic Research (Ipea). We are constantly working to expand and improve
the package, so if you have any suggestions/contributions, please feel free
to open an issue on Github.

best,

Rafael H. M. Pereira
Institute for Applied Economic Research (Ipea) - Brazil

Department of Urban, Regional and Environmental studies and policies (DIRUR)



Twitter - @UrbanDemog  <https://twitter.com/UrbanDemog>

Blog - urbandemographics.blogspot.com
<https://urbandemographics.blogspot.com.br/>

	[[alternative HTML version deleted]]


From em@nue|e@b@rc@ @end|ng |rom b@@|r@@@cnr@|t  Mon Aug 12 20:21:55 2019
From: em@nue|e@b@rc@ @end|ng |rom b@@|r@@@cnr@|t (Emanuele Barca)
Date: Mon, 12 Aug 2019 20:21:55 +0200
Subject: [R-sig-Geo] regression-kriging and co-kriging
In-Reply-To: <mailman.27542.3.1565431202.23300.r-sig-geo@r-project.org>
References: <mailman.27542.3.1565431202.23300.r-sig-geo@r-project.org>
Message-ID: <0d0927e55aa92860e37a21de64074df1@ba.irsa.cnr.it>

Dear Edzer,

maybe I found the solution. I found this in the predict function help: 
"When a non-stationary (i.e., non-constant) mean is used, both for 
simulation and prediction purposes the variogram model defined should be 
that of the residual process, and not that of the raw observations"
Since my data were, actually, non-stationary, I applied the universal 
co-kriging instead usual co-kriging.
now the maps of regression-kring and co-kriging are actually similar s 
expected.
did I understand correctly the quoted sentence?

regards

emanuele barca
------------------------------
> 
> Message: 2
> Date: Sat, 10 Aug 2019 10:41:38 +0200
> From: Edzer Pebesma <edzer.pebesma at uni-muenster.de>
> To: r-sig-geo at r-project.org
> Subject: Re: [R-sig-Geo] regression-kriging and co-kriging
> Message-ID: <da76da51-e46b-8a8d-4952-7c3b85c19687 at uni-muenster.de>
> Content-Type: text/plain; charset="utf-8"
> 
> Hard to tell from your script. Maybe give a reproducible example?
> 
> On 8/6/19 1:07 PM, Emanuele Barca wrote:
>> Dear  r-sig-geo friends,
>> 
>> I produced two maps garnered in the following way:
>> 
>> # for regression-kriging
>> Piezo.map <-autoKrige(LivStat ~  Z, input_data = mydata.sp, new_data
>> = covariates,  model = "Ste")
>> 
>> Piezork.pred <- Piezo.map$krige_output$var1.pred
>> Piezork.coords <- Piezo.map$krige_output at coords
>> Piezork.out <- as.data.frame(cbind(Piezork.coords, Piezork.pred))
>> colnames(Piezork.out)[1:2] <- c("X", "Y")
>> coordinates(Piezork.out) = ~ X + Y
>> gridded(Piezork.out) <- TRUE
>> 
>> spplot(Piezork.out, main = list(label = "R-k Hydraulic head", cex = 
>> 1.5))
>> 
>> #for co-kriging
>> g <- gstat(id = "Piezo", formula = LivStat ~ 1, data = mydata.sp, set
>> = list(nocheck = 1))
>> g <- gstat(g, id = "Z", formula = Z ~ 1, data = mydata.sp, set =
>> list(nocheck = 1))
>> 
>> v.g <- variogram(g)
>> 
>> #g <- gstat(g, id = "Piezo", model = vgm(150, "Mat", 1350, 0.0, kappa
>> = 1.9), fill.all = T)#
>> g <- gstat(g, id = "Piezo", model = vgm(0.7, "Ste", 1300, 18, kappa =
>> 1.9), fill.all = T)#
>> g.fit <- fit.lmc(v.g, g, fit.lmc = TRUE, correct.diagonal = 1.01) #
>> fit multivariable variogram model , fit.lmc = TRUE, correct.diagonal = 
>> 1.01
>> g.fit
>> plot(v.g, model = g.fit, main = "Fitted Variogram Models - Raw Data")#
>> #gridded(covariates) <- TRUE
>> g.cok <- predict(g.fit, newdata = covariates)#grid
>> 
>> g.cok.pred <- g.cok at data$Piezo.pred
>> aaaa <- na.omit(g.cok.pred)
>> g.cok.coords <- g.cok at coords
>> g.cok.out <- as.data.frame(cbind(g.cok.coords, g.cok.pred))
>> colnames(g.cok.out)[1:2] <- c("X", "Y")
>> coordinates(g.cok.out) = ~ X + Y
>> gridded(g.cok.out) <- TRUE
>> spplot(g.cok.out, main = list(label = "Hydraulic head with
>> Co-kriging", cex = 1.5))
>> 
>> ###########################################################################################################################
>> 
>> I am unable to understand why the first map appears as a raster and
>> the second not, notwithstanding the fact that they are both computed
>> on the same "covariates" DEM???
>> 
>> where is the mistake???
>> 
>> regards
>> 
>> emanuele
>> 
>> ________________________________________________________
>> Emanuele Barca                               Researcher
>> Water Research Institute                       (IRSA-CNR)
>> Via De Blasio, 5                       70123 Bari (Italy)
>> Phone +39 080 5820535               Fax  +39 080 5313365
>> Mobile +39 340 3420689
>> _________________________________________________________
>> 
>> 
>> 
>> ---
>> Questa e-mail ? stata controllata per individuare virus con Avast 
>> antivirus.
>> https://www.avast.com/antivirus
>> 
>> 	[[alternative HTML version deleted]]
>> 
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>> 
> 
> --
> Edzer Pebesma
> Institute for Geoinformatics
> Heisenbergstrasse 2, 48151 Muenster, Germany
> Phone: +49 251 8333081
> 
> -------------- next part --------------
> A non-text attachment was scrubbed...
> Name: pEpkey.asc
> Type: application/pgp-keys
> Size: 2472 bytes
> Desc: not available
> URL:
> <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190810/b5cb9d77/attachment-0001.bin>
> 
> 
> ------------------------------
> 
> Subject: Digest Footer
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 
> 
> ------------------------------
> 
> End of R-sig-Geo Digest, Vol 192, Issue 7
> *****************************************


From eg@mp@du @end|ng |rom gm@||@com  Tue Aug 13 10:49:42 2019
From: eg@mp@du @end|ng |rom gm@||@com (Enoch Gyamfi Ampadu)
Date: Tue, 13 Aug 2019 10:49:42 +0200
Subject: [R-sig-Geo] Random forest for forest cover classification
Message-ID: <CAC4+n+zRKH1aiBcRfvdQj0B2F8v0_oDHmTpieCjEOPaJOYMrXw@mail.gmail.com>

Dear List,

Please I am now learning R to apply to my analysis. I am doing a forest
cover classification using Random forest. So far I have stacked the image,
done atmospheric correction, and clipped out my study area. I have created
some training sites of the cover classes in ArcMap and imported into R as
well as the clipped image of my study sites. I have been doing try and
error with some online codes. I will be glad if you could provide me with
some codes to apply.

Thank you.

Best regards,

Enoch

-- 
*Enoch Gyamfi - Ampadu*

*Geography & Environmental Sciences*

*College of Agriculture, Engineering & Science*

*University of KwaZulu-Natal, Westville Campus*

*Private Bag X54001*
*Durban, South Africa **? 4000**.*
*Phone: +27 835 828255*

*email: egampadu at gmail.com <egampadu at gmail.com>*


*skype: enoch.ampadu*
*The highest evidence of nobility is self-control*.

*A simple act of kindness creates an endless ripple*.

	[[alternative HTML version deleted]]


From c@rr@nz@ju@np @end|ng |rom gm@||@com  Tue Aug 13 14:41:20 2019
From: c@rr@nz@ju@np @end|ng |rom gm@||@com (Juan Pablo Carranza)
Date: Tue, 13 Aug 2019 09:41:20 -0300
Subject: [R-sig-Geo] Random forest for forest cover classification
In-Reply-To: <CAC4+n+zRKH1aiBcRfvdQj0B2F8v0_oDHmTpieCjEOPaJOYMrXw@mail.gmail.com>
References: <CAC4+n+zRKH1aiBcRfvdQj0B2F8v0_oDHmTpieCjEOPaJOYMrXw@mail.gmail.com>
Message-ID: <CAFSWaCMt4_SRjbwKxe=15tGK9QED8HGhCaM73vFgX66Fi4yJaA@mail.gmail.com>

Dear Enoch, I strongly recomend to try an segmentation approach instead a
classification. However, here's some code you can use:

library(rgdal)
library(raster)
library(caret)
library(kerndwd)
library(sp)
library(RColorBrewer)
library(dplyr)
library(leaflet)
library(sf)
img <- brick("******.tiff")
names(img) <- paste0("B", c(1:*))
plot(img)
library(sf)
sample <- st_read("******gpkg")
sample  = as(sample, 'Spatial')
sample$class = as.factor(sample$class) ; responseCol <- "class"
pixels = data.frame(matrix(vector(), nrow = 0, ncol = length(names(img)) +
1))

# A function to overlap de sample polygons on the image.
for (i in 1:length(unique(sample[[responseCol]]))){
  category <- unique(sample[[responseCol]])[i]
  categorymap <- sample[sample[[responseCol]] == category,]
  dataSet <- extract(img, categorymap)
  dataSet <- dataSet[!unlist(lapply(dataSet, is.null))]
  if(is(sample, "SpatialPointsDataFrame")){
    dataSet <- cbind(dataSet, class = as.numeric(category))
    pixeles <- rbind(pixeles, dataSet)
  }
  if(is(sample, "SpatialPolygonsDataFrame")){
    dataSet <- lapply(dataSet, function(x){cbind(x, class =
as.numeric(rep(category, nrow(x))))})
    df <- do.call("rbind", dataSet)
    pixels <- rbind(pixeles, df)
  }
}

# Define a number of pixels to use in the training of the model. More
pixels, more accuracy but more computational time.
n <- 1000

# Take a subsample in order to reduce computational times.
spixeles <- pixeles[sample(1:nrow(pixeles), n ), ]

# Train model.
modFit_rf <- train(as.factor(class) ~ ., method = "nnet", data = spixeles)
modFit_rf

# Predict.
beginCluster()
preds_rf <- clusterR(img, raster::predict, args = list(model = modFit_rf))
endCluster()

# Mapping results
maxpixels =  1e+06
m <- leaflet() %>%
  addProviderTiles('Esri.WorldImagery') %>%
  addRasterImage(preds_rf , opacity = 0.6) %>%
  addScaleBar(position = "topright") %>%
  addMiniMap( position = "bottomleft")
m

# Export raster
writeRaster(preds_rf, "estimacion.tif")



*Juan Pablo Carranza*
Mgter. en Administraci?n P?blica
Lic. en Econom?a




El mar., 13 ago. 2019 a las 5:50, Enoch Gyamfi Ampadu (<egampadu at gmail.com>)
escribi?:

> Dear List,
>
> Please I am now learning R to apply to my analysis. I am doing a forest
> cover classification using Random forest. So far I have stacked the image,
> done atmospheric correction, and clipped out my study area. I have created
> some training sites of the cover classes in ArcMap and imported into R as
> well as the clipped image of my study sites. I have been doing try and
> error with some online codes. I will be glad if you could provide me with
> some codes to apply.
>
> Thank you.
>
> Best regards,
>
> Enoch
>
> --
> *Enoch Gyamfi - Ampadu*
>
> *Geography & Environmental Sciences*
>
> *College of Agriculture, Engineering & Science*
>
> *University of KwaZulu-Natal, Westville Campus*
>
> *Private Bag X54001*
> *Durban, South Africa **? 4000**.*
> *Phone: +27 835 828255*
>
> *email: egampadu at gmail.com <egampadu at gmail.com>*
>
>
> *skype: enoch.ampadu*
> *The highest evidence of nobility is self-control*.
>
> *A simple act of kindness creates an endless ripple*.
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From c@r|o@@|berto@@rn|||@@ @end|ng |rom gm@||@com  Tue Aug 13 17:30:35 2019
From: c@r|o@@|berto@@rn|||@@ @end|ng |rom gm@||@com (Carlos Alberto Arnillas)
Date: Tue, 13 Aug 2019 11:30:35 -0400
Subject: [R-sig-Geo] Random forest for forest cover classification
In-Reply-To: <CAFSWaCMt4_SRjbwKxe=15tGK9QED8HGhCaM73vFgX66Fi4yJaA@mail.gmail.com>
References: <CAC4+n+zRKH1aiBcRfvdQj0B2F8v0_oDHmTpieCjEOPaJOYMrXw@mail.gmail.com>
 <CAFSWaCMt4_SRjbwKxe=15tGK9QED8HGhCaM73vFgX66Fi4yJaA@mail.gmail.com>
Message-ID: <CALpNJaTUXktrNy4dSCOb74PqQq+VVe94+fxfpP919AHJ-X7sMA@mail.gmail.com>

Hello Enoch
I think segmentation is a good idea, it will group pixels by similar
characteristics, creating polygons (don't forget to validate the
generated polygons!).
then you can do classification on those polygons using polygons properties
(including shape indices, but also the values obtained from the colours of
the image) using random forest.

Carlos Alberto

On Tue, Aug 13, 2019 at 8:41 AM Juan Pablo Carranza <carranzajuanp at gmail.com>
wrote:

> Dear Enoch, I strongly recomend to try an segmentation approach instead a
> classification. However, here's some code you can use:
>
> library(rgdal)
> library(raster)
> library(caret)
> library(kerndwd)
> library(sp)
> library(RColorBrewer)
> library(dplyr)
> library(leaflet)
> library(sf)
> img <- brick("******.tiff")
> names(img) <- paste0("B", c(1:*))
> plot(img)
> library(sf)
> sample <- st_read("******gpkg")
> sample  = as(sample, 'Spatial')
> sample$class = as.factor(sample$class) ; responseCol <- "class"
> pixels = data.frame(matrix(vector(), nrow = 0, ncol = length(names(img)) +
> 1))
>
> # A function to overlap de sample polygons on the image.
> for (i in 1:length(unique(sample[[responseCol]]))){
>   category <- unique(sample[[responseCol]])[i]
>   categorymap <- sample[sample[[responseCol]] == category,]
>   dataSet <- extract(img, categorymap)
>   dataSet <- dataSet[!unlist(lapply(dataSet, is.null))]
>   if(is(sample, "SpatialPointsDataFrame")){
>     dataSet <- cbind(dataSet, class = as.numeric(category))
>     pixeles <- rbind(pixeles, dataSet)
>   }
>   if(is(sample, "SpatialPolygonsDataFrame")){
>     dataSet <- lapply(dataSet, function(x){cbind(x, class =
> as.numeric(rep(category, nrow(x))))})
>     df <- do.call("rbind", dataSet)
>     pixels <- rbind(pixeles, df)
>   }
> }
>
> # Define a number of pixels to use in the training of the model. More
> pixels, more accuracy but more computational time.
> n <- 1000
>
> # Take a subsample in order to reduce computational times.
> spixeles <- pixeles[sample(1:nrow(pixeles), n ), ]
>
> # Train model.
> modFit_rf <- train(as.factor(class) ~ ., method = "nnet", data = spixeles)
> modFit_rf
>
> # Predict.
> beginCluster()
> preds_rf <- clusterR(img, raster::predict, args = list(model = modFit_rf))
> endCluster()
>
> # Mapping results
> maxpixels =  1e+06
> m <- leaflet() %>%
>   addProviderTiles('Esri.WorldImagery') %>%
>   addRasterImage(preds_rf , opacity = 0.6) %>%
>   addScaleBar(position = "topright") %>%
>   addMiniMap( position = "bottomleft")
> m
>
> # Export raster
> writeRaster(preds_rf, "estimacion.tif")
>
>
>
> *Juan Pablo Carranza*
> Mgter. en Administraci?n P?blica
> Lic. en Econom?a
>
>
>
>
> El mar., 13 ago. 2019 a las 5:50, Enoch Gyamfi Ampadu (<egampadu at gmail.com
> >)
> escribi?:
>
> > Dear List,
> >
> > Please I am now learning R to apply to my analysis. I am doing a forest
> > cover classification using Random forest. So far I have stacked the
> image,
> > done atmospheric correction, and clipped out my study area. I have
> created
> > some training sites of the cover classes in ArcMap and imported into R as
> > well as the clipped image of my study sites. I have been doing try and
> > error with some online codes. I will be glad if you could provide me with
> > some codes to apply.
> >
> > Thank you.
> >
> > Best regards,
> >
> > Enoch
> >
> > --
> > *Enoch Gyamfi - Ampadu*
> >
> > *Geography & Environmental Sciences*
> >
> > *College of Agriculture, Engineering & Science*
> >
> > *University of KwaZulu-Natal, Westville Campus*
> >
> > *Private Bag X54001*
> > *Durban, South Africa **? 4000**.*
> > *Phone: +27 835 828255*
> >
> > *email: egampadu at gmail.com <egampadu at gmail.com>*
> >
> >
> > *skype: enoch.ampadu*
> > *The highest evidence of nobility is self-control*.
> >
> > *A simple act of kindness creates an endless ripple*.
> >
> >         [[alternative HTML version deleted]]
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From ph||@h@|ne@82 @end|ng |rom gm@||@com  Tue Aug 13 19:50:50 2019
From: ph||@h@|ne@82 @end|ng |rom gm@||@com (Phil Haines)
Date: Tue, 13 Aug 2019 18:50:50 +0100
Subject: [R-sig-Geo] rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
Message-ID: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>

Dear list,

I have a single Polygons object containing multiple Polygon objects
that share a common border. When I output this using writeOGR() one of
the Polygon objects becomes a hole, as the following example shows.

Create a Polygons object containing two adjoining Polygon objects
> library(rgdal)
> r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
> r2 <- r1; r2[,1] <- r2[,1]+1
> Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
> SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)), data.frame(Example=c("Minimal")))

Perform a write/readOGR() cycle
> fn <- tempfile()
> writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
> SPDF2 <- readOGR(dsn=fn,layer='test')

Second Polygon object is now a hole
> sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
[1] FALSE  TRUE

I see from the sp documentation that "Polygon objects belonging to a
Polygons object should either not overlap one-other, or should be
fully included" but I am not sure how this relates to bordering
Polygon objects. I would welcome any advice as to whether what I am
asking of writeOGR is reasonable?

Thanks in advance for your time,
Phil

> sessionInfo()
R version 3.5.1 (2018-07-02)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows >= 8 x64 (build 9200)

Matrix products: default

locale:
[1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
                         LC_TIME=English_United Kingdom.1252

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base

other attached packages:
[1] rgdal_1.4-4 sp_1.3-1

loaded via a namespace (and not attached):
[1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
lattice_0.20-35


From j|n||68 @end|ng |rom gm@||@com  Wed Aug 14 02:56:29 2019
From: j|n||68 @end|ng |rom gm@||@com (Jin Li)
Date: Wed, 14 Aug 2019 10:56:29 +1000
Subject: [R-sig-Geo] Random forest for forest cover classification
In-Reply-To: <CAC4+n+zRKH1aiBcRfvdQj0B2F8v0_oDHmTpieCjEOPaJOYMrXw@mail.gmail.com>
References: <CAC4+n+zRKH1aiBcRfvdQj0B2F8v0_oDHmTpieCjEOPaJOYMrXw@mail.gmail.com>
Message-ID: <CAGu_3ZKY-2TnK3chtRXZugM-vH0KBAbD4d_Wvax+EvdYjBRPEA@mail.gmail.com>

Hi Enoch,
Here is a book chapter that provides R scripts for using random forest to
classify categorical data: 'Predicting seabed hardness using random forest
in R' 2013.

   - DOI:
   - 10.1016/B978-0-12-411511-8.00011-6.
   - In book: Data Mining Applications with R.
   -
   - Publisher: Elsevier.
   - Editors: Y. Zhao and Y. Cen

If you are looking for further materials, the R package, spm, provides more
advanced functions, including RFcv with an example for categorical data.

Hope this helps.
Kind regards,
Jin


On Tue, 13 Aug. 2019, 18:50 Enoch Gyamfi Ampadu, <egampadu at gmail.com> wrote:

> Dear List,
>
> Please I am now learning R to apply to my analysis. I am doing a forest
> cover classification using Random forest. So far I have stacked the image,
> done atmospheric correction, and clipped out my study area. I have created
> some training sites of the cover classes in ArcMap and imported into R as
> well as the clipped image of my study sites. I have been doing try and
> error with some online codes. I will be glad if you could provide me with
> some codes to apply.
>
> Thank you.
>
> Best regards,
>
> Enoch
>
> --
> *Enoch Gyamfi - Ampadu*
>
> *Geography & Environmental Sciences*
>
> *College of Agriculture, Engineering & Science*
>
> *University of KwaZulu-Natal, Westville Campus*
>
> *Private Bag X54001*
> *Durban, South Africa **? 4000**.*
> *Phone: +27 835 828255*
>
> *email: egampadu at gmail.com <egampadu at gmail.com>*
>
>
> *skype: enoch.ampadu*
> *The highest evidence of nobility is self-control*.
>
> *A simple act of kindness creates an endless ripple*.
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From eg@mp@du @end|ng |rom gm@||@com  Thu Aug 15 06:51:49 2019
From: eg@mp@du @end|ng |rom gm@||@com (Enoch Gyamfi Ampadu)
Date: Thu, 15 Aug 2019 06:51:49 +0200
Subject: [R-sig-Geo] Error running codes
Message-ID: <CAC4+n+yRavRHc_MCoAtV-ao_-SH7QyO8ZukZaoJqBNaBgJXmPQ@mail.gmail.com>

Dear List,

Please I have been running a certain the codes below to read my image,
shapeffile to enable me classify for cover with Random forest. I have
gotten to the point of extracting the raster values and the raster
information. However I keep getting errors. though I have tried different
combination and other codes like readOGR for importing the training
polygon. I will be glad if you could be of help as I am new to using R.

#import clip image of study area

TestImg3 <- brick("C:\\Users\\hp\\Desktop\\Data collection\\Nkandla
Images\\Landsat\\2019\\08052019\\Corrected\\New
Folder\\Image08052019_Clip.tif")

#Assign name of bands
names(TestImg3) <- c(paste0("B", 1:7, coll=""), "B9")
plotRGB(TestImg3, r=4, g=3, b=2, stretch ="lin")

#Import training shapefile
sample <- shapefile("C:/Users/hp/Desktop/Data collection/Nkandla
Images/Landsat/2019/08052019/Corrected/Train08052019_2.shp")

responseCol <- "class"

#(I have tried options of changing "class" to "classname" as reflect actaul
name assigned in ArcMap)

# Overlap the sample polygons on the image (combine the class information
with extracted values).

pixels = data.frame(matrix(vector(), nrow = 0, ncol = length(names(img)) +
1))
for (i in 1:length(unique(sample[[responseCol]]))){
  category <- unique(sample[[responseCol]])[i]
  categorymap <- sample[sample[[responseCol]] == category,]
  dataSet <- extract(img, categorymap)
  dataSet <- dataSet[!unlist(lapply(dataSet, is.null))]
  if(is(sample, "SpatialPointsDataFrame")){
    dataSet <- cbind(dataSet, class = as.numeric(category))
    pixeles <- rbind(pixeles, dataSet)
  }
  if(is(sample, "SpatialPolygonsDataFrame")){
    dataSet <- lapply(dataSet, function(x){cbind(x, class =
as.numeric(rep(category,

 nrow(x))))})
    df <- do.call("rbind", dataSet)
    pixels <- rbind(pixeles, df)
  }

}

THIS IS THE ERROR I GET FROM RUNNING THE ABOVE CODES

> for (i in 1:length(unique(samples[[responseCol]]))){
+   category <- unique(samples[[responseCol]])[i]
+   categorymap <- samples[samples[[responseCol]] == category,]
+   dataSet <- extract(img, categorymap)
+
+   if(is(sample, "SpatialPointsDataFrame")){
+     dataSet <- cbind(dataSet, class = as.numeric(category))
+     pixeles <- rbind(pixeles, dataSet)
+   }
+   if(is(sample, "SpatialPolygonsDataFrame")){
+     dataSet <- lapply(dataSet, function(x){cbind(x, class =
as.numeric(rep(category,
+
  nrow(x))))})
+     df <- do.call("rbind", dataSet)
+     pixels <- rbind(pixeles, df)
+   }
+
+ }
Error in y[i, ] :
  cannot get a slot ("Polygons") from an object of type "NULL"


Please help me out.
Thank you.

Best regards,

Enoch

-- 
*Enoch Gyamfi - Ampadu*

*Geography & Environmental Sciences*

*College of Agriculture, Engineering & Science*

*University of KwaZulu-Natal, Westville Campus*

*Private Bag X54001*
*Durban, South Africa **? 4000**.*
*Phone: +27 835 828255*

*email: egampadu at gmail.com <egampadu at gmail.com>*


*skype: enoch.ampadu*
*The highest evidence of nobility is self-control*.

*A simple act of kindness creates an endless ripple*.

	[[alternative HTML version deleted]]


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Thu Aug 15 08:33:59 2019
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Thu, 15 Aug 2019 08:33:59 +0200
Subject: [R-sig-Geo] regression-kriging and co-kriging
In-Reply-To: <0d0927e55aa92860e37a21de64074df1@ba.irsa.cnr.it>
References: <mailman.27542.3.1565431202.23300.r-sig-geo@r-project.org>
 <0d0927e55aa92860e37a21de64074df1@ba.irsa.cnr.it>
Message-ID: <bdae5226-7023-7e30-1927-5fb66ff413d1@uni-muenster.de>



On 8/12/19 8:21 PM, Emanuele Barca wrote:
> Dear Edzer,
> 
> maybe I found the solution. I found this in the predict function help:
> "When a non-stationary (i.e., non-constant) mean is used, both for
> simulation and prediction purposes the variogram model defined should be
> that of the residual process, and not that of the raw observations"
> Since my data were, actually, non-stationary, I applied the universal
> co-kriging instead usual co-kriging.
> now the maps of regression-kring and co-kriging are actually similar s
> expected.
> did I understand correctly the quoted sentence?

I think so, but hard to be sure given the information you provide.

> 
> regards
> 
> emanuele barca
> ------------------------------
>>
>> Message: 2
>> Date: Sat, 10 Aug 2019 10:41:38 +0200
>> From: Edzer Pebesma <edzer.pebesma at uni-muenster.de>
>> To: r-sig-geo at r-project.org
>> Subject: Re: [R-sig-Geo] regression-kriging and co-kriging
>> Message-ID: <da76da51-e46b-8a8d-4952-7c3b85c19687 at uni-muenster.de>
>> Content-Type: text/plain; charset="utf-8"
>>
>> Hard to tell from your script. Maybe give a reproducible example?
>>
>> On 8/6/19 1:07 PM, Emanuele Barca wrote:
>>> Dear? r-sig-geo friends,
>>>
>>> I produced two maps garnered in the following way:
>>>
>>> # for regression-kriging
>>> Piezo.map <-autoKrige(LivStat ~? Z, input_data = mydata.sp, new_data
>>> = covariates,? model = "Ste")
>>>
>>> Piezork.pred <- Piezo.map$krige_output$var1.pred
>>> Piezork.coords <- Piezo.map$krige_output at coords
>>> Piezork.out <- as.data.frame(cbind(Piezork.coords, Piezork.pred))
>>> colnames(Piezork.out)[1:2] <- c("X", "Y")
>>> coordinates(Piezork.out) = ~ X + Y
>>> gridded(Piezork.out) <- TRUE
>>>
>>> spplot(Piezork.out, main = list(label = "R-k Hydraulic head", cex =
>>> 1.5))
>>>
>>> #for co-kriging
>>> g <- gstat(id = "Piezo", formula = LivStat ~ 1, data = mydata.sp, set
>>> = list(nocheck = 1))
>>> g <- gstat(g, id = "Z", formula = Z ~ 1, data = mydata.sp, set =
>>> list(nocheck = 1))
>>>
>>> v.g <- variogram(g)
>>>
>>> #g <- gstat(g, id = "Piezo", model = vgm(150, "Mat", 1350, 0.0, kappa
>>> = 1.9), fill.all = T)#
>>> g <- gstat(g, id = "Piezo", model = vgm(0.7, "Ste", 1300, 18, kappa =
>>> 1.9), fill.all = T)#
>>> g.fit <- fit.lmc(v.g, g, fit.lmc = TRUE, correct.diagonal = 1.01) #
>>> fit multivariable variogram model , fit.lmc = TRUE, correct.diagonal
>>> = 1.01
>>> g.fit
>>> plot(v.g, model = g.fit, main = "Fitted Variogram Models - Raw Data")#
>>> #gridded(covariates) <- TRUE
>>> g.cok <- predict(g.fit, newdata = covariates)#grid
>>>
>>> g.cok.pred <- g.cok at data$Piezo.pred
>>> aaaa <- na.omit(g.cok.pred)
>>> g.cok.coords <- g.cok at coords
>>> g.cok.out <- as.data.frame(cbind(g.cok.coords, g.cok.pred))
>>> colnames(g.cok.out)[1:2] <- c("X", "Y")
>>> coordinates(g.cok.out) = ~ X + Y
>>> gridded(g.cok.out) <- TRUE
>>> spplot(g.cok.out, main = list(label = "Hydraulic head with
>>> Co-kriging", cex = 1.5))
>>>
>>> ###########################################################################################################################
>>>
>>>
>>> I am unable to understand why the first map appears as a raster and
>>> the second not, notwithstanding the fact that they are both computed
>>> on the same "covariates" DEM???
>>>
>>> where is the mistake???
>>>
>>> regards
>>>
>>> emanuele
>>>
>>> ________________________________________________________
>>> Emanuele Barca?????????????????????????????? Researcher
>>> Water Research Institute?????????????????????? (IRSA-CNR)
>>> Via De Blasio, 5?????????????????????? 70123 Bari (Italy)
>>> Phone +39 080 5820535?????????????? Fax? +39 080 5313365
>>> Mobile +39 340 3420689
>>> _________________________________________________________
>>>
>>>
>>>
>>> ---
>>> Questa e-mail ? stata controllata per individuare virus con Avast
>>> antivirus.
>>> https://www.avast.com/antivirus
>>>
>>> ????[[alternative HTML version deleted]]
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>
>>
>> -- 
>> Edzer Pebesma
>> Institute for Geoinformatics
>> Heisenbergstrasse 2, 48151 Muenster, Germany
>> Phone: +49 251 8333081
>>
>> -------------- next part --------------
>> A non-text attachment was scrubbed...
>> Name: pEpkey.asc
>> Type: application/pgp-keys
>> Size: 2472 bytes
>> Desc: not available
>> URL:
>> <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190810/b5cb9d77/attachment-0001.bin>
>>
>>
>>
>> ------------------------------
>>
>> Subject: Digest Footer
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>>
>> ------------------------------
>>
>> End of R-sig-Geo Digest, Vol 192, Issue 7
>> *****************************************
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

-------------- next part --------------
A non-text attachment was scrubbed...
Name: pEpkey.asc
Type: application/pgp-keys
Size: 2472 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190815/7a4eef09/attachment.bin>

From em@nue|e@b@rc@ @end|ng |rom b@@|r@@@cnr@|t  Thu Aug 15 12:31:04 2019
From: em@nue|e@b@rc@ @end|ng |rom b@@|r@@@cnr@|t (Emanuele Barca)
Date: Thu, 15 Aug 2019 12:31:04 +0200
Subject: [R-sig-Geo] regression-kriging and co-kriging (Edzer Pebesma)
In-Reply-To: <mailman.27558.3.1565863201.48360.r-sig-geo@r-project.org>
References: <mailman.27558.3.1565863201.48360.r-sig-geo@r-project.org>
Message-ID: <0135ffed6a9cc42175db45aadca4b610@ba.irsa.cnr.it>

Dear Edzer,

sorry for bothering you once more but I need to be sure about my R 
script.

In summary, i'm comparing the performance of regression-kriging and 
collocated co-kriging.

Regression-kriging was based on an unique covariate, the elevation Z.

I use Z as unique ancillary variable in the Co-kriging.

As first attempt, the final raster maps were completely different. It 
appeared that it was due

to the fact that the dataset was non-stationary and only 
regression-kriging overcomes this issue, while co-kriging not.

But if I pass to universal co-kriging introducing Z as covariate, it 
bacomes useless as ancillary variable!

What is my mistake?

emanuele




Il 2019-08-15 12:00 r-sig-geo-request at r-project.org ha scritto:
> Send R-sig-Geo mailing list submissions to
> 	r-sig-geo at r-project.org
> 
> To subscribe or unsubscribe via the World Wide Web, visit
> 	https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> or, via email, send a message with subject or body 'help' to
> 	r-sig-geo-request at r-project.org
> 
> You can reach the person managing the list at
> 	r-sig-geo-owner at r-project.org
> 
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of R-sig-Geo digest..."
> 
> 
> Today's Topics:
> 
>    1. Error running codes (Enoch Gyamfi Ampadu)
>    2. Re: regression-kriging and co-kriging (Edzer Pebesma)
> 
> ----------------------------------------------------------------------
> 
> Message: 1
> Date: Thu, 15 Aug 2019 06:51:49 +0200
> From: Enoch Gyamfi Ampadu <egampadu at gmail.com>
> To: r-sig-geo at r-project.org
> Subject: [R-sig-Geo] Error running codes
> Message-ID:
> 	<CAC4+n+yRavRHc_MCoAtV-ao_-SH7QyO8ZukZaoJqBNaBgJXmPQ at mail.gmail.com>
> Content-Type: text/plain; charset="utf-8"
> 
> Dear List,
> 
> Please I have been running a certain the codes below to read my image,
> shapeffile to enable me classify for cover with Random forest. I have
> gotten to the point of extracting the raster values and the raster
> information. However I keep getting errors. though I have tried 
> different
> combination and other codes like readOGR for importing the training
> polygon. I will be glad if you could be of help as I am new to using R.
> 
> #import clip image of study area
> 
> TestImg3 <- brick("C:\\Users\\hp\\Desktop\\Data collection\\Nkandla
> Images\\Landsat\\2019\\08052019\\Corrected\\New
> Folder\\Image08052019_Clip.tif")
> 
> #Assign name of bands
> names(TestImg3) <- c(paste0("B", 1:7, coll=""), "B9")
> plotRGB(TestImg3, r=4, g=3, b=2, stretch ="lin")
> 
> #Import training shapefile
> sample <- shapefile("C:/Users/hp/Desktop/Data collection/Nkandla
> Images/Landsat/2019/08052019/Corrected/Train08052019_2.shp")
> 
> responseCol <- "class"
> 
> #(I have tried options of changing "class" to "classname" as reflect 
> actaul
> name assigned in ArcMap)
> 
> # Overlap the sample polygons on the image (combine the class 
> information
> with extracted values).
> 
> pixels = data.frame(matrix(vector(), nrow = 0, ncol = 
> length(names(img)) +
> 1))
> for (i in 1:length(unique(sample[[responseCol]]))){
>   category <- unique(sample[[responseCol]])[i]
>   categorymap <- sample[sample[[responseCol]] == category,]
>   dataSet <- extract(img, categorymap)
>   dataSet <- dataSet[!unlist(lapply(dataSet, is.null))]
>   if(is(sample, "SpatialPointsDataFrame")){
>     dataSet <- cbind(dataSet, class = as.numeric(category))
>     pixeles <- rbind(pixeles, dataSet)
>   }
>   if(is(sample, "SpatialPolygonsDataFrame")){
>     dataSet <- lapply(dataSet, function(x){cbind(x, class =
> as.numeric(rep(category,
> 
>  nrow(x))))})
>     df <- do.call("rbind", dataSet)
>     pixels <- rbind(pixeles, df)
>   }
> 
> }
> 
> THIS IS THE ERROR I GET FROM RUNNING THE ABOVE CODES
> 
>> for (i in 1:length(unique(samples[[responseCol]]))){
> +   category <- unique(samples[[responseCol]])[i]
> +   categorymap <- samples[samples[[responseCol]] == category,]
> +   dataSet <- extract(img, categorymap)
> +
> +   if(is(sample, "SpatialPointsDataFrame")){
> +     dataSet <- cbind(dataSet, class = as.numeric(category))
> +     pixeles <- rbind(pixeles, dataSet)
> +   }
> +   if(is(sample, "SpatialPolygonsDataFrame")){
> +     dataSet <- lapply(dataSet, function(x){cbind(x, class =
> as.numeric(rep(category,
> +
>   nrow(x))))})
> +     df <- do.call("rbind", dataSet)
> +     pixels <- rbind(pixeles, df)
> +   }
> +
> + }
> Error in y[i, ] :
>   cannot get a slot ("Polygons") from an object of type "NULL"
> 
> 
> Please help me out.
> Thank you.
> 
> Best regards,
> 
> Enoch
> 
> --
> *Enoch Gyamfi - Ampadu*
> 
> *Geography & Environmental Sciences*
> 
> *College of Agriculture, Engineering & Science*
> 
> *University of KwaZulu-Natal, Westville Campus*
> 
> *Private Bag X54001*
> *Durban, South Africa **? 4000**.*
> *Phone: +27 835 828255*
> 
> *email: egampadu at gmail.com <egampadu at gmail.com>*
> 
> 
> *skype: enoch.ampadu*
> *The highest evidence of nobility is self-control*.
> 
> *A simple act of kindness creates an endless ripple*.
> 
> 	[[alternative HTML version deleted]]
> 
> 
> 
> 
> ------------------------------
> 
> Message: 2
> Date: Thu, 15 Aug 2019 08:33:59 +0200
> From: Edzer Pebesma <edzer.pebesma at uni-muenster.de>
> To: r-sig-geo at r-project.org
> Subject: Re: [R-sig-Geo] regression-kriging and co-kriging
> Message-ID: <bdae5226-7023-7e30-1927-5fb66ff413d1 at uni-muenster.de>
> Content-Type: text/plain; charset="utf-8"
> 
> 
> 
> On 8/12/19 8:21 PM, Emanuele Barca wrote:
>> Dear Edzer,
>> 
>> maybe I found the solution. I found this in the predict function help:
>> "When a non-stationary (i.e., non-constant) mean is used, both for
>> simulation and prediction purposes the variogram model defined should 
>> be
>> that of the residual process, and not that of the raw observations"
>> Since my data were, actually, non-stationary, I applied the universal
>> co-kriging instead usual co-kriging.
>> now the maps of regression-kring and co-kriging are actually similar s
>> expected.
>> did I understand correctly the quoted sentence?
> 
> I think so, but hard to be sure given the information you provide.
> 
>> 
>> regards
>> 
>> emanuele barca
>> ------------------------------
>>> 
>>> Message: 2
>>> Date: Sat, 10 Aug 2019 10:41:38 +0200
>>> From: Edzer Pebesma <edzer.pebesma at uni-muenster.de>
>>> To: r-sig-geo at r-project.org
>>> Subject: Re: [R-sig-Geo] regression-kriging and co-kriging
>>> Message-ID: <da76da51-e46b-8a8d-4952-7c3b85c19687 at uni-muenster.de>
>>> Content-Type: text/plain; charset="utf-8"
>>> 
>>> Hard to tell from your script. Maybe give a reproducible example?
>>> 
>>> On 8/6/19 1:07 PM, Emanuele Barca wrote:
>>>> Dear? r-sig-geo friends,
>>>> 
>>>> I produced two maps garnered in the following way:
>>>> 
>>>> # for regression-kriging
>>>> Piezo.map <-autoKrige(LivStat ~? Z, input_data = mydata.sp, new_data
>>>> = covariates,? model = "Ste")
>>>> 
>>>> Piezork.pred <- Piezo.map$krige_output$var1.pred
>>>> Piezork.coords <- Piezo.map$krige_output at coords
>>>> Piezork.out <- as.data.frame(cbind(Piezork.coords, Piezork.pred))
>>>> colnames(Piezork.out)[1:2] <- c("X", "Y")
>>>> coordinates(Piezork.out) = ~ X + Y
>>>> gridded(Piezork.out) <- TRUE
>>>> 
>>>> spplot(Piezork.out, main = list(label = "R-k Hydraulic head", cex =
>>>> 1.5))
>>>> 
>>>> #for co-kriging
>>>> g <- gstat(id = "Piezo", formula = LivStat ~ 1, data = mydata.sp, 
>>>> set
>>>> = list(nocheck = 1))
>>>> g <- gstat(g, id = "Z", formula = Z ~ 1, data = mydata.sp, set =
>>>> list(nocheck = 1))
>>>> 
>>>> v.g <- variogram(g)
>>>> 
>>>> #g <- gstat(g, id = "Piezo", model = vgm(150, "Mat", 1350, 0.0, 
>>>> kappa
>>>> = 1.9), fill.all = T)#
>>>> g <- gstat(g, id = "Piezo", model = vgm(0.7, "Ste", 1300, 18, kappa 
>>>> =
>>>> 1.9), fill.all = T)#
>>>> g.fit <- fit.lmc(v.g, g, fit.lmc = TRUE, correct.diagonal = 1.01) #
>>>> fit multivariable variogram model , fit.lmc = TRUE, correct.diagonal
>>>> = 1.01
>>>> g.fit
>>>> plot(v.g, model = g.fit, main = "Fitted Variogram Models - Raw 
>>>> Data")#
>>>> #gridded(covariates) <- TRUE
>>>> g.cok <- predict(g.fit, newdata = covariates)#grid
>>>> 
>>>> g.cok.pred <- g.cok at data$Piezo.pred
>>>> aaaa <- na.omit(g.cok.pred)
>>>> g.cok.coords <- g.cok at coords
>>>> g.cok.out <- as.data.frame(cbind(g.cok.coords, g.cok.pred))
>>>> colnames(g.cok.out)[1:2] <- c("X", "Y")
>>>> coordinates(g.cok.out) = ~ X + Y
>>>> gridded(g.cok.out) <- TRUE
>>>> spplot(g.cok.out, main = list(label = "Hydraulic head with
>>>> Co-kriging", cex = 1.5))
>>>> 
>>>> ###########################################################################################################################
>>>> 
>>>> 
>>>> I am unable to understand why the first map appears as a raster and
>>>> the second not, notwithstanding the fact that they are both computed
>>>> on the same "covariates" DEM???
>>>> 
>>>> where is the mistake???
>>>> 
>>>> regards
>>>> 
>>>> emanuele
>>>> 
>>>> ________________________________________________________
>>>> Emanuele Barca?????????????????????????????? Researcher
>>>> Water Research Institute?????????????????????? (IRSA-CNR)
>>>> Via De Blasio, 5?????????????????????? 70123 Bari (Italy)
>>>> Phone +39 080 5820535?????????????? Fax? +39 080 5313365
>>>> Mobile +39 340 3420689
>>>> _________________________________________________________
>>>> 
>>>> 
>>>> 
>>>> ---
>>>> Questa e-mail ? stata controllata per individuare virus con Avast
>>>> antivirus.
>>>> https://www.avast.com/antivirus
>>>> 
>>>> ????[[alternative HTML version deleted]]
>>>> 
>>>> _______________________________________________
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org
>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>> 
>>> 
>>> --
>>> Edzer Pebesma
>>> Institute for Geoinformatics
>>> Heisenbergstrasse 2, 48151 Muenster, Germany
>>> Phone: +49 251 8333081
>>> 
>>> -------------- next part --------------
>>> A non-text attachment was scrubbed...
>>> Name: pEpkey.asc
>>> Type: application/pgp-keys
>>> Size: 2472 bytes
>>> Desc: not available
>>> URL:
>>> <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190810/b5cb9d77/attachment-0001.bin>
>>> 
>>> 
>>> 
>>> ------------------------------
>>> 
>>> Subject: Digest Footer
>>> 
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>> 
>>> 
>>> ------------------------------
>>> 
>>> End of R-sig-Geo Digest, Vol 192, Issue 7
>>> *****************************************
>> 
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 
> --
> Edzer Pebesma
> Institute for Geoinformatics
> Heisenbergstrasse 2, 48151 Muenster, Germany
> Phone: +49 251 8333081
> 
> -------------- next part --------------
> A non-text attachment was scrubbed...
> Name: pEpkey.asc
> Type: application/pgp-keys
> Size: 2472 bytes
> Desc: not available
> URL:
> <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190815/7a4eef09/attachment-0001.bin>
> 
> 
> ------------------------------
> 
> Subject: Digest Footer
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 
> 
> ------------------------------
> 
> End of R-sig-Geo Digest, Vol 192, Issue 12
> ******************************************


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Thu Aug 15 12:50:12 2019
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Thu, 15 Aug 2019 12:50:12 +0200
Subject: [R-sig-Geo] regression-kriging and co-kriging (Edzer Pebesma)
In-Reply-To: <0135ffed6a9cc42175db45aadca4b610@ba.irsa.cnr.it>
References: <mailman.27558.3.1565863201.48360.r-sig-geo@r-project.org>
 <0135ffed6a9cc42175db45aadca4b610@ba.irsa.cnr.it>
Message-ID: <613a60c3-e241-392d-e5b0-ae6417d7ef94@uni-muenster.de>



On 8/15/19 12:31 PM, Emanuele Barca wrote:
> Dear Edzer,
> 
> sorry for bothering you once more but I need to be sure about my R script.
> 
> In summary, i'm comparing the performance of regression-kriging and
> collocated co-kriging.
> 
> Regression-kriging was based on an unique covariate, the elevation Z.
> 
> I use Z as unique ancillary variable in the Co-kriging.
> 
> As first attempt, the final raster maps were completely different. It
> appeared that it was due
> 
> to the fact that the dataset was non-stationary and only
> regression-kriging overcomes this issue, while co-kriging not.
> 
> But if I pass to universal co-kriging introducing Z as covariate, it
> bacomes useless as ancillary variable!
> 
> What is my mistake?

You assume that someone else can be sure about your analysis by looking
at your R script without having access to your data.

And you are starting a personal dialogue on a list, essentially
uninviting everyone else to get involved.

> 
> emanuele
> 
> 
> 
> 
> Il 2019-08-15 12:00 r-sig-geo-request at r-project.org ha scritto:
>> Send R-sig-Geo mailing list submissions to
>> ????r-sig-geo at r-project.org
>>
>> To subscribe or unsubscribe via the World Wide Web, visit
>> ????https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>> or, via email, send a message with subject or body 'help' to
>> ????r-sig-geo-request at r-project.org
>>
>> You can reach the person managing the list at
>> ????r-sig-geo-owner at r-project.org
>>
>> When replying, please edit your Subject line so it is more specific
>> than "Re: Contents of R-sig-Geo digest..."
>>
>>
>> Today's Topics:
>>
>> ?? 1. Error running codes (Enoch Gyamfi Ampadu)
>> ?? 2. Re: regression-kriging and co-kriging (Edzer Pebesma)
>>
>> ----------------------------------------------------------------------
>>
>> Message: 1
>> Date: Thu, 15 Aug 2019 06:51:49 +0200
>> From: Enoch Gyamfi Ampadu <egampadu at gmail.com>
>> To: r-sig-geo at r-project.org
>> Subject: [R-sig-Geo] Error running codes
>> Message-ID:
>> ????<CAC4+n+yRavRHc_MCoAtV-ao_-SH7QyO8ZukZaoJqBNaBgJXmPQ at mail.gmail.com>
>> Content-Type: text/plain; charset="utf-8"
>>
>> Dear List,
>>
>> Please I have been running a certain the codes below to read my image,
>> shapeffile to enable me classify for cover with Random forest. I have
>> gotten to the point of extracting the raster values and the raster
>> information. However I keep getting errors. though I have tried different
>> combination and other codes like readOGR for importing the training
>> polygon. I will be glad if you could be of help as I am new to using R.
>>
>> #import clip image of study area
>>
>> TestImg3 <- brick("C:\\Users\\hp\\Desktop\\Data collection\\Nkandla
>> Images\\Landsat\\2019\\08052019\\Corrected\\New
>> Folder\\Image08052019_Clip.tif")
>>
>> #Assign name of bands
>> names(TestImg3) <- c(paste0("B", 1:7, coll=""), "B9")
>> plotRGB(TestImg3, r=4, g=3, b=2, stretch ="lin")
>>
>> #Import training shapefile
>> sample <- shapefile("C:/Users/hp/Desktop/Data collection/Nkandla
>> Images/Landsat/2019/08052019/Corrected/Train08052019_2.shp")
>>
>> responseCol <- "class"
>>
>> #(I have tried options of changing "class" to "classname" as reflect
>> actaul
>> name assigned in ArcMap)
>>
>> # Overlap the sample polygons on the image (combine the class information
>> with extracted values).
>>
>> pixels = data.frame(matrix(vector(), nrow = 0, ncol =
>> length(names(img)) +
>> 1))
>> for (i in 1:length(unique(sample[[responseCol]]))){
>> ? category <- unique(sample[[responseCol]])[i]
>> ? categorymap <- sample[sample[[responseCol]] == category,]
>> ? dataSet <- extract(img, categorymap)
>> ? dataSet <- dataSet[!unlist(lapply(dataSet, is.null))]
>> ? if(is(sample, "SpatialPointsDataFrame")){
>> ??? dataSet <- cbind(dataSet, class = as.numeric(category))
>> ??? pixeles <- rbind(pixeles, dataSet)
>> ? }
>> ? if(is(sample, "SpatialPolygonsDataFrame")){
>> ??? dataSet <- lapply(dataSet, function(x){cbind(x, class =
>> as.numeric(rep(category,
>>
>> ?nrow(x))))})
>> ??? df <- do.call("rbind", dataSet)
>> ??? pixels <- rbind(pixeles, df)
>> ? }
>>
>> }
>>
>> THIS IS THE ERROR I GET FROM RUNNING THE ABOVE CODES
>>
>>> for (i in 1:length(unique(samples[[responseCol]]))){
>> +?? category <- unique(samples[[responseCol]])[i]
>> +?? categorymap <- samples[samples[[responseCol]] == category,]
>> +?? dataSet <- extract(img, categorymap)
>> +
>> +?? if(is(sample, "SpatialPointsDataFrame")){
>> +???? dataSet <- cbind(dataSet, class = as.numeric(category))
>> +???? pixeles <- rbind(pixeles, dataSet)
>> +?? }
>> +?? if(is(sample, "SpatialPolygonsDataFrame")){
>> +???? dataSet <- lapply(dataSet, function(x){cbind(x, class =
>> as.numeric(rep(category,
>> +
>> ? nrow(x))))})
>> +???? df <- do.call("rbind", dataSet)
>> +???? pixels <- rbind(pixeles, df)
>> +?? }
>> +
>> + }
>> Error in y[i, ] :
>> ? cannot get a slot ("Polygons") from an object of type "NULL"
>>
>>
>> Please help me out.
>> Thank you.
>>
>> Best regards,
>>
>> Enoch
>>
>> -- 
>> *Enoch Gyamfi - Ampadu*
>>
>> *Geography & Environmental Sciences*
>>
>> *College of Agriculture, Engineering & Science*
>>
>> *University of KwaZulu-Natal, Westville Campus*
>>
>> *Private Bag X54001*
>> *Durban, South Africa **? 4000**.*
>> *Phone: +27 835 828255*
>>
>> *email: egampadu at gmail.com <egampadu at gmail.com>*
>>
>>
>> *skype: enoch.ampadu*
>> *The highest evidence of nobility is self-control*.
>>
>> *A simple act of kindness creates an endless ripple*.
>>
>> ????[[alternative HTML version deleted]]
>>
>>
>>
>>
>> ------------------------------
>>
>> Message: 2
>> Date: Thu, 15 Aug 2019 08:33:59 +0200
>> From: Edzer Pebesma <edzer.pebesma at uni-muenster.de>
>> To: r-sig-geo at r-project.org
>> Subject: Re: [R-sig-Geo] regression-kriging and co-kriging
>> Message-ID: <bdae5226-7023-7e30-1927-5fb66ff413d1 at uni-muenster.de>
>> Content-Type: text/plain; charset="utf-8"
>>
>>
>>
>> On 8/12/19 8:21 PM, Emanuele Barca wrote:
>>> Dear Edzer,
>>>
>>> maybe I found the solution. I found this in the predict function help:
>>> "When a non-stationary (i.e., non-constant) mean is used, both for
>>> simulation and prediction purposes the variogram model defined should be
>>> that of the residual process, and not that of the raw observations"
>>> Since my data were, actually, non-stationary, I applied the universal
>>> co-kriging instead usual co-kriging.
>>> now the maps of regression-kring and co-kriging are actually similar s
>>> expected.
>>> did I understand correctly the quoted sentence?
>>
>> I think so, but hard to be sure given the information you provide.
>>
>>>
>>> regards
>>>
>>> emanuele barca
>>> ------------------------------
>>>>
>>>> Message: 2
>>>> Date: Sat, 10 Aug 2019 10:41:38 +0200
>>>> From: Edzer Pebesma <edzer.pebesma at uni-muenster.de>
>>>> To: r-sig-geo at r-project.org
>>>> Subject: Re: [R-sig-Geo] regression-kriging and co-kriging
>>>> Message-ID: <da76da51-e46b-8a8d-4952-7c3b85c19687 at uni-muenster.de>
>>>> Content-Type: text/plain; charset="utf-8"
>>>>
>>>> Hard to tell from your script. Maybe give a reproducible example?
>>>>
>>>> On 8/6/19 1:07 PM, Emanuele Barca wrote:
>>>>> Dear? r-sig-geo friends,
>>>>>
>>>>> I produced two maps garnered in the following way:
>>>>>
>>>>> # for regression-kriging
>>>>> Piezo.map <-autoKrige(LivStat ~? Z, input_data = mydata.sp, new_data
>>>>> = covariates,? model = "Ste")
>>>>>
>>>>> Piezork.pred <- Piezo.map$krige_output$var1.pred
>>>>> Piezork.coords <- Piezo.map$krige_output at coords
>>>>> Piezork.out <- as.data.frame(cbind(Piezork.coords, Piezork.pred))
>>>>> colnames(Piezork.out)[1:2] <- c("X", "Y")
>>>>> coordinates(Piezork.out) = ~ X + Y
>>>>> gridded(Piezork.out) <- TRUE
>>>>>
>>>>> spplot(Piezork.out, main = list(label = "R-k Hydraulic head", cex =
>>>>> 1.5))
>>>>>
>>>>> #for co-kriging
>>>>> g <- gstat(id = "Piezo", formula = LivStat ~ 1, data = mydata.sp, set
>>>>> = list(nocheck = 1))
>>>>> g <- gstat(g, id = "Z", formula = Z ~ 1, data = mydata.sp, set =
>>>>> list(nocheck = 1))
>>>>>
>>>>> v.g <- variogram(g)
>>>>>
>>>>> #g <- gstat(g, id = "Piezo", model = vgm(150, "Mat", 1350, 0.0, kappa
>>>>> = 1.9), fill.all = T)#
>>>>> g <- gstat(g, id = "Piezo", model = vgm(0.7, "Ste", 1300, 18, kappa =
>>>>> 1.9), fill.all = T)#
>>>>> g.fit <- fit.lmc(v.g, g, fit.lmc = TRUE, correct.diagonal = 1.01) #
>>>>> fit multivariable variogram model , fit.lmc = TRUE, correct.diagonal
>>>>> = 1.01
>>>>> g.fit
>>>>> plot(v.g, model = g.fit, main = "Fitted Variogram Models - Raw Data")#
>>>>> #gridded(covariates) <- TRUE
>>>>> g.cok <- predict(g.fit, newdata = covariates)#grid
>>>>>
>>>>> g.cok.pred <- g.cok at data$Piezo.pred
>>>>> aaaa <- na.omit(g.cok.pred)
>>>>> g.cok.coords <- g.cok at coords
>>>>> g.cok.out <- as.data.frame(cbind(g.cok.coords, g.cok.pred))
>>>>> colnames(g.cok.out)[1:2] <- c("X", "Y")
>>>>> coordinates(g.cok.out) = ~ X + Y
>>>>> gridded(g.cok.out) <- TRUE
>>>>> spplot(g.cok.out, main = list(label = "Hydraulic head with
>>>>> Co-kriging", cex = 1.5))
>>>>>
>>>>> ###########################################################################################################################
>>>>>
>>>>>
>>>>>
>>>>> I am unable to understand why the first map appears as a raster and
>>>>> the second not, notwithstanding the fact that they are both computed
>>>>> on the same "covariates" DEM???
>>>>>
>>>>> where is the mistake???
>>>>>
>>>>> regards
>>>>>
>>>>> emanuele
>>>>>
>>>>> ________________________________________________________
>>>>> Emanuele Barca?????????????????????????????? Researcher
>>>>> Water Research Institute?????????????????????? (IRSA-CNR)
>>>>> Via De Blasio, 5?????????????????????? 70123 Bari (Italy)
>>>>> Phone +39 080 5820535?????????????? Fax? +39 080 5313365
>>>>> Mobile +39 340 3420689
>>>>> _________________________________________________________
>>>>>
>>>>>
>>>>>
>>>>> ---
>>>>> Questa e-mail ? stata controllata per individuare virus con Avast
>>>>> antivirus.
>>>>> https://www.avast.com/antivirus
>>>>>
>>>>> ????[[alternative HTML version deleted]]
>>>>>
>>>>> _______________________________________________
>>>>> R-sig-Geo mailing list
>>>>> R-sig-Geo at r-project.org
>>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>>
>>>>
>>>> -- 
>>>> Edzer Pebesma
>>>> Institute for Geoinformatics
>>>> Heisenbergstrasse 2, 48151 Muenster, Germany
>>>> Phone: +49 251 8333081
>>>>
>>>> -------------- next part --------------
>>>> A non-text attachment was scrubbed...
>>>> Name: pEpkey.asc
>>>> Type: application/pgp-keys
>>>> Size: 2472 bytes
>>>> Desc: not available
>>>> URL:
>>>> <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190810/b5cb9d77/attachment-0001.bin>
>>>>
>>>>
>>>>
>>>>
>>>> ------------------------------
>>>>
>>>> Subject: Digest Footer
>>>>
>>>> _______________________________________________
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org
>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>
>>>>
>>>> ------------------------------
>>>>
>>>> End of R-sig-Geo Digest, Vol 192, Issue 7
>>>> *****************************************
>>>
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>> -- 
>> Edzer Pebesma
>> Institute for Geoinformatics
>> Heisenbergstrasse 2, 48151 Muenster, Germany
>> Phone: +49 251 8333081
>>
>> -------------- next part --------------
>> A non-text attachment was scrubbed...
>> Name: pEpkey.asc
>> Type: application/pgp-keys
>> Size: 2472 bytes
>> Desc: not available
>> URL:
>> <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190815/7a4eef09/attachment-0001.bin>
>>
>>
>>
>> ------------------------------
>>
>> Subject: Digest Footer
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>>
>> ------------------------------
>>
>> End of R-sig-Geo Digest, Vol 192, Issue 12
>> ******************************************
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

-------------- next part --------------
A non-text attachment was scrubbed...
Name: pEpkey.asc
Type: application/pgp-keys
Size: 2472 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190815/78eaf340/attachment.bin>

From Roger@B|v@nd @end|ng |rom nhh@no  Fri Aug 16 14:22:11 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Fri, 16 Aug 2019 14:22:11 +0200
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
Message-ID: <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>

On Tue, 13 Aug 2019, Phil Haines wrote:

> Dear list,
>
> I have a single Polygons object containing multiple Polygon objects
> that share a common border. When I output this using writeOGR() one of
> the Polygon objects becomes a hole, as the following example shows.
>
> Create a Polygons object containing two adjoining Polygon objects
>> library(rgdal)
>> r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>> r2 <- r1; r2[,1] <- r2[,1]+1
>> Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>> SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)), data.frame(Example=c("Minimal")))
>
> Perform a write/readOGR() cycle
>> fn <- tempfile()
>> writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>> SPDF2 <- readOGR(dsn=fn,layer='test')
>
> Second Polygon object is now a hole
>> sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
> [1] FALSE  TRUE
>
> I see from the sp documentation that "Polygon objects belonging to a
> Polygons object should either not overlap one-other, or should be
> fully included" but I am not sure how this relates to bordering
> Polygon objects. I would welcome any advice as to whether what I am
> asking of writeOGR is reasonable?

The problem is with the 'ESRI Shapefile' representation and driver:

library(rgdal)
r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
r2 <- r1; r2[,1] <- r2[,1]+1
Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
  data.frame(Example=c("Minimal")))
sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")

# which constructs a MULTIPOLYGON object:

rgeos::writeWKT(SPDF)
library(sf)
st_as_text(st_geometry(st_as_sf(SPDF)))

# The 'ESRI Shapefile' driver is not Simple-Feature compliant (it 
# pre-dates it), so the failure occurs by seeing the second exterior ring
# as an interior ring

fn <- tempfile()
writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
SPDF2 <- readOGR(dsn=fn, layer='test')
sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
rgeos::writeWKT(SPDF2)
st_as_text(st_geometry(st_as_sf(SPDF2)))

# This happens with sf too, using the same GDAL driver:

sf2 <- st_read(dsn=fn, layer='test')
st_geometry(sf2)
library(sf)
st_as_text(st_geometry(st_as_sf(sf2)))
rgeos::writeWKT(as(sf2, "Spatial"))

# Adding the comment fix doesn't help:

comment(slot(SPDF, "polygons")[[1]])
SPDF_c <- rgeos::createSPComment(SPDF)
comment(slot(SPDF_c, "polygons")[[1]])
writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
   verbose=TRUE)

# reports
# Object initially classed as: wkbPolygon
# SFS comments in Polygons objects
# Object reclassed as: wkbMultiPolygon

SPDF2_c <- readOGR(dsn=fn, layer='test_c')
sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "ringDir")
rgeos::writeWKT(SPDF2_c)
st_as_text(st_geometry(st_as_sf(SPDF2_c)))



# If the input object is written out with the GeoPackage driver:

fn1 <- tempfile(fileext=".gpkg")
writeOGR(SPDF, fn1, layer="test", driver='GPKG')
sf2a <- st_read(dsn=fn1,layer='test')
st_coordinates(st_geometry(sf2a))
SPDF2a <- readOGR(dsn=fn1)
sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
rgeos::writeWKT(SPDF2a)
st_as_text(st_geometry(st_as_sf(SPDF2a)))

# the issue is resolved. If we separate the exterior rings:

r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
   data.frame(Example=c("Minimal")))
fna <- tempfile()
writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
SPDF2_a <- readOGR(dsn=fna, layer='test')
sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "ringDir")
rgeos::writeWKT(SPDF2_a)
st_as_text(st_geometry(st_as_sf(SPDF2_a)))

# we are OK as the two exterior rings do not touch.

# does using sf make a difference?

fn_s <- tempfile(fileext=".shp")
st_write(st_as_sf(SPDF), dsn=fn_s)
sf_in <- st_read(fn_s)
st_as_text(st_geometry(st_as_sf(sf_in)))

# No

fn_s <- tempfile(fileext=".shp")
st_write(st_as_sf(SPDF_c), dsn=fn_s)
sf_in_c <- st_read(fn_s)
st_as_text(st_geometry(st_as_sf(sf_in_c)))

# nor with the pretend-SF-compliant comment set either.

So the weakness is in the "ESRI Shapefile" write driver, or possibly in 
the OGRGeometryFactory::organizePolygons() function in GDAL used in 
OGR_write() (a C++ function) called by writeOGR(). If sf::st_write() also 
calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that it 
has a weakness for the "ESRI Shapefile" driver, but which does not affect 
SF-compliant drivers.

This is probably related to a similar but inverse problem with the 
SF-compliant GeoJSON driver in 2015:

https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html

continued the next month in:

https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html

The details are in this SVN diff

https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571

up to the end og the list thread, and this one from then until now:

https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733

Summary: could you change drivers, or is it really necessary to fix an EOL 
problem? What is your use case?

>
> Thanks in advance for your time,

Thanks for a complete example,

Roger

> Phil
>
>> sessionInfo()
> R version 3.5.1 (2018-07-02)
> Platform: x86_64-w64-mingw32/x64 (64-bit)
> Running under: Windows >= 8 x64 (build 9200)
>
> Matrix products: default
>
> locale:
> [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
> Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
>                         LC_TIME=English_United Kingdom.1252
>
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
>
> other attached packages:
> [1] rgdal_1.4-4 sp_1.3-1
>
> loaded via a namespace (and not attached):
> [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
> lattice_0.20-35
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From open @end|ng |rom tobyw||k|n@on@co@uk  Thu Aug 15 16:43:16 2019
From: open @end|ng |rom tobyw||k|n@on@co@uk (T C Wilkinson)
Date: Thu, 15 Aug 2019 15:43:16 +0100
Subject: [R-sig-Geo] Forcing use of alpha-band in RGBA,
 as alpha for other bands in plotRGB
Message-ID: <etPan.5d56d961.4a7f59e3.5a1f@tobywilkinson.co.uk>

Can one ensure that the alpha-band (i.e. band 4) of an RGBA RasterBrick is applied as a mask when using plotRGB(my_brick)??

I have a GeoTIFF with an alpha-band marking an irregularly-shaped mask, which displays correctly in QGIS (using band 4 as transparency, values either simply 0 for mask or 255 for visible), but I cannot get plotRGB to display the masked area as anything other than black (which simply means that RGB bands 1,2,3 all =0, and that the alpha mask is being ignored).?

summary(my_brick) acknowledges the presence of the 4th band, and plot(my_brick[[4]]) shows the correctly-shaped mask.?

I hope there is a blindingly obvious solution to this, but have singularly failed to find anything to help me via normal web searches or from the manual.?

(Reclassification is not ideal given that this particular raster is very large and eats memory).?

Thank you in advance,?
Toby


	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Fri Aug 16 21:27:11 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Fri, 16 Aug 2019 21:27:11 +0200
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
 <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
Message-ID: <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>

On Fri, 16 Aug 2019, Roger Bivand wrote:

> On Tue, 13 Aug 2019, Phil Haines wrote:
>
>>  Dear list,
>>
>>  I have a single Polygons object containing multiple Polygon objects
>>  that share a common border. When I output this using writeOGR() one of
>>  the Polygon objects becomes a hole, as the following example shows.
>>
>>  Create a Polygons object containing two adjoining Polygon objects
>>>  library(rgdal)
>>>  r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>  r2 <- r1; r2[,1] <- r2[,1]+1
>>>  Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>  SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>  data.frame(Example=c("Minimal")))
>>
>>  Perform a write/readOGR() cycle
>>>  fn <- tempfile()
>>>  writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>  SPDF2 <- readOGR(dsn=fn,layer='test')
>>
>>  Second Polygon object is now a hole
>>>  sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
>>  [1] FALSE  TRUE
>>
>>  I see from the sp documentation that "Polygon objects belonging to a
>>  Polygons object should either not overlap one-other, or should be
>>  fully included" but I am not sure how this relates to bordering
>>  Polygon objects. I would welcome any advice as to whether what I am
>>  asking of writeOGR is reasonable?
>
> The problem is with the 'ESRI Shapefile' representation and driver:
>
> library(rgdal)
> r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
> r2 <- r1; r2[,1] <- r2[,1]+1
> Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
> SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
> data.frame(Example=c("Minimal")))
> sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
> sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
>
> # which constructs a MULTIPOLYGON object:
>
> rgeos::writeWKT(SPDF)
> library(sf)
> st_as_text(st_geometry(st_as_sf(SPDF)))
>
> #  The 'ESRI Shapefile' driver is not Simple-Feature compliant (it pre-dates 
> #  it), so the failure occurs by seeing the second exterior ring
> #  as an interior ring
>
> fn <- tempfile()
> writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
> SPDF2 <- readOGR(dsn=fn, layer='test')
> sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
> sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
> rgeos::writeWKT(SPDF2)
> st_as_text(st_geometry(st_as_sf(SPDF2)))
>
> # This happens with sf too, using the same GDAL driver:
>
> sf2 <- st_read(dsn=fn, layer='test')
> st_geometry(sf2)
> library(sf)
> st_as_text(st_geometry(st_as_sf(sf2)))
> rgeos::writeWKT(as(sf2, "Spatial"))
>
> # Adding the comment fix doesn't help:
>
> comment(slot(SPDF, "polygons")[[1]])
> SPDF_c <- rgeos::createSPComment(SPDF)
> comment(slot(SPDF_c, "polygons")[[1]])
> writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
>   verbose=TRUE)
>
> #  reports
> #  Object initially classed as: wkbPolygon
> #  SFS comments in Polygons objects
> #  Object reclassed as: wkbMultiPolygon
>
> SPDF2_c <- readOGR(dsn=fn, layer='test_c')
> sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
> sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "ringDir")
> rgeos::writeWKT(SPDF2_c)
> st_as_text(st_geometry(st_as_sf(SPDF2_c)))
>
>
>
> # If the input object is written out with the GeoPackage driver:
>
> fn1 <- tempfile(fileext=".gpkg")
> writeOGR(SPDF, fn1, layer="test", driver='GPKG')
> sf2a <- st_read(dsn=fn1,layer='test')
> st_coordinates(st_geometry(sf2a))
> SPDF2a <- readOGR(dsn=fn1)
> sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
> sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
> rgeos::writeWKT(SPDF2a)
> st_as_text(st_geometry(st_as_sf(SPDF2a)))
>
> # the issue is resolved. If we separate the exterior rings:
>
> r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
> Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
> SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
>  data.frame(Example=c("Minimal")))
> fna <- tempfile()
> writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
> SPDF2_a <- readOGR(dsn=fna, layer='test')
> sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
> sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "ringDir")
> rgeos::writeWKT(SPDF2_a)
> st_as_text(st_geometry(st_as_sf(SPDF2_a)))
>
> # we are OK as the two exterior rings do not touch.
>
> # does using sf make a difference?
>
> fn_s <- tempfile(fileext=".shp")
> st_write(st_as_sf(SPDF), dsn=fn_s)
> sf_in <- st_read(fn_s)
> st_as_text(st_geometry(st_as_sf(sf_in)))
>
> # No
>
> fn_s <- tempfile(fileext=".shp")
> st_write(st_as_sf(SPDF_c), dsn=fn_s)
> sf_in_c <- st_read(fn_s)
> st_as_text(st_geometry(st_as_sf(sf_in_c)))
>
> # nor with the pretend-SF-compliant comment set either.
>
> So the weakness is in the "ESRI Shapefile" write driver, or possibly in the 
> OGRGeometryFactory::organizePolygons() function in GDAL used in OGR_write() 
> (a C++ function) called by writeOGR(). If sf::st_write() also calls 
> OGRGeometryFactory::organizePolygons(), we'd maybe consider that it has a 
> weakness for the "ESRI Shapefile" driver, but which does not affect 
> SF-compliant drivers.

Without the comment set, OGRGeometryFactory::organizePolygons() is used; 
with it set, OGRGeometryFactory::organizePolygons() is not used, because 
the object is declared as two exterior rings. In both cases, we have the 
output object written out and read back in incorrectly with the ESRI 
shapefile driver, but SF-compliant drivers round-trip (in the test 
GeoJSON), correctly.

It is likely that the changes made in 2015 to accommodate GeoJSON led to 
this possible regression for the ESRI Shapefile driver. I'm adding this 
geometry to tests/tripup.R and data files; without code changes the hole 
slot is wrong and the ring direction is changes to match, so the 
coordinates change too.

Reading using the deprecated maptools::readShapeSpatial() also gets a hole 
in the second external ring. However, writing with deprecated 
maptools::writeSpatialShape() yields a shapefile that when read with 
maptools::readShapeSpatial() gives the correct two exterior ring, no hole 
object. When read with sf::st_read() and rgdal::readOGR(), the object is 
also correct. So the problem definitely lies in rgdal::writeOGR(), and 
sf::st_write() - roundtripping with sf::st_write() and sf::st_read() 
degrades from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.

Roger

>
> This is probably related to a similar but inverse problem with the 
> SF-compliant GeoJSON driver in 2015:
>
> https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
>
> continued the next month in:
>
> https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
>
> The details are in this SVN diff
>
> https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
>
> up to the end og the list thread, and this one from then until now:
>
> https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
>
> Summary: could you change drivers, or is it really necessary to fix an EOL 
> problem? What is your use case?
>
>>
>>  Thanks in advance for your time,
>
> Thanks for a complete example,
>
> Roger
>
>>  Phil
>>
>>>  sessionInfo()
>>  R version 3.5.1 (2018-07-02)
>>  Platform: x86_64-w64-mingw32/x64 (64-bit)
>>  Running under: Windows >= 8 x64 (build 9200)
>>
>>  Matrix products: default
>>
>>  locale:
>>  [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
>>  Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
>>                          LC_TIME=English_United Kingdom.1252
>>
>>  attached base packages:
>>  [1] stats     graphics  grDevices utils     datasets  methods   base
>>
>>  other attached packages:
>>  [1] rgdal_1.4-4 sp_1.3-1
>>
>>  loaded via a namespace (and not attached):
>>  [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
>>  lattice_0.20-35
>>
>>  _______________________________________________
>>  R-sig-Geo mailing list
>>  R-sig-Geo at r-project.org
>>  https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>> 
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Sat Aug 17 11:06:02 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Sat, 17 Aug 2019 11:06:02 +0200
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
 <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
 <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>
Message-ID: <alpine.LFD.2.21.1908171104350.9677@reclus.nhh.no>

Please follow up both here and on:

https://github.com/r-spatial/sf/issues/1130

as the problem is also seen in the sf package using the same GDAL ESRI 
Shapefile driver.

Roger

On Fri, 16 Aug 2019, Roger Bivand wrote:

> On Fri, 16 Aug 2019, Roger Bivand wrote:
>
>>  On Tue, 13 Aug 2019, Phil Haines wrote:
>>
>>>   Dear list,
>>>
>>>   I have a single Polygons object containing multiple Polygon objects
>>>   that share a common border. When I output this using writeOGR() one of
>>>   the Polygon objects becomes a hole, as the following example shows.
>>>
>>>   Create a Polygons object containing two adjoining Polygon objects
>>>>   library(rgdal)
>>>>   r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>   r2 <- r1; r2[,1] <- r2[,1]+1
>>>>   Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>   SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>   data.frame(Example=c("Minimal")))
>>>
>>>   Perform a write/readOGR() cycle
>>>>   fn <- tempfile()
>>>>   writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>   SPDF2 <- readOGR(dsn=fn,layer='test')
>>>
>>>   Second Polygon object is now a hole
>>>>   sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
>>>   [1] FALSE  TRUE
>>>
>>>   I see from the sp documentation that "Polygon objects belonging to a
>>>   Polygons object should either not overlap one-other, or should be
>>>   fully included" but I am not sure how this relates to bordering
>>>   Polygon objects. I would welcome any advice as to whether what I am
>>>   asking of writeOGR is reasonable?
>>
>>  The problem is with the 'ESRI Shapefile' representation and driver:
>>
>>  library(rgdal)
>>  r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>  r2 <- r1; r2[,1] <- r2[,1]+1
>>  Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>  SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>  data.frame(Example=c("Minimal")))
>>  sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
>>  sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>
>>  # which constructs a MULTIPOLYGON object:
>>
>>  rgeos::writeWKT(SPDF)
>>  library(sf)
>>  st_as_text(st_geometry(st_as_sf(SPDF)))
>> 
>> #   The 'ESRI Shapefile' driver is not Simple-Feature compliant (it 
>> #   pre-dates it), so the failure occurs by seeing the second exterior ring
>> #   as an interior ring
>>
>>  fn <- tempfile()
>>  writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>  SPDF2 <- readOGR(dsn=fn, layer='test')
>>  sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
>>  sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>  rgeos::writeWKT(SPDF2)
>>  st_as_text(st_geometry(st_as_sf(SPDF2)))
>>
>>  # This happens with sf too, using the same GDAL driver:
>>
>>  sf2 <- st_read(dsn=fn, layer='test')
>>  st_geometry(sf2)
>>  library(sf)
>>  st_as_text(st_geometry(st_as_sf(sf2)))
>>  rgeos::writeWKT(as(sf2, "Spatial"))
>>
>>  # Adding the comment fix doesn't help:
>>
>>  comment(slot(SPDF, "polygons")[[1]])
>>  SPDF_c <- rgeos::createSPComment(SPDF)
>>  comment(slot(SPDF_c, "polygons")[[1]])
>>  writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
>>    verbose=TRUE)
>> 
>> #   reports
>> #   Object initially classed as: wkbPolygon
>> #   SFS comments in Polygons objects
>> #   Object reclassed as: wkbMultiPolygon
>>
>>  SPDF2_c <- readOGR(dsn=fn, layer='test_c')
>>  sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
>>  sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>  rgeos::writeWKT(SPDF2_c)
>>  st_as_text(st_geometry(st_as_sf(SPDF2_c)))
>> 
>> 
>>
>>  # If the input object is written out with the GeoPackage driver:
>>
>>  fn1 <- tempfile(fileext=".gpkg")
>>  writeOGR(SPDF, fn1, layer="test", driver='GPKG')
>>  sf2a <- st_read(dsn=fn1,layer='test')
>>  st_coordinates(st_geometry(sf2a))
>>  SPDF2a <- readOGR(dsn=fn1)
>>  sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
>>  sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>  rgeos::writeWKT(SPDF2a)
>>  st_as_text(st_geometry(st_as_sf(SPDF2a)))
>>
>>  # the issue is resolved. If we separate the exterior rings:
>>
>>  r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
>>  Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
>>  SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
>>  data.frame(Example=c("Minimal")))
>>  fna <- tempfile()
>>  writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
>>  SPDF2_a <- readOGR(dsn=fna, layer='test')
>>  sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
>>  sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>  rgeos::writeWKT(SPDF2_a)
>>  st_as_text(st_geometry(st_as_sf(SPDF2_a)))
>>
>>  # we are OK as the two exterior rings do not touch.
>>
>>  # does using sf make a difference?
>>
>>  fn_s <- tempfile(fileext=".shp")
>>  st_write(st_as_sf(SPDF), dsn=fn_s)
>>  sf_in <- st_read(fn_s)
>>  st_as_text(st_geometry(st_as_sf(sf_in)))
>>
>>  # No
>>
>>  fn_s <- tempfile(fileext=".shp")
>>  st_write(st_as_sf(SPDF_c), dsn=fn_s)
>>  sf_in_c <- st_read(fn_s)
>>  st_as_text(st_geometry(st_as_sf(sf_in_c)))
>>
>>  # nor with the pretend-SF-compliant comment set either.
>>
>>  So the weakness is in the "ESRI Shapefile" write driver, or possibly in
>>  the OGRGeometryFactory::organizePolygons() function in GDAL used in
>>  OGR_write() (a C++ function) called by writeOGR(). If sf::st_write() also
>>  calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that it
>>  has a weakness for the "ESRI Shapefile" driver, but which does not affect
>>  SF-compliant drivers.
>
> Without the comment set, OGRGeometryFactory::organizePolygons() is used; with 
> it set, OGRGeometryFactory::organizePolygons() is not used, because the 
> object is declared as two exterior rings. In both cases, we have the output 
> object written out and read back in incorrectly with the ESRI shapefile 
> driver, but SF-compliant drivers round-trip (in the test GeoJSON), correctly.
>
> It is likely that the changes made in 2015 to accommodate GeoJSON led to this 
> possible regression for the ESRI Shapefile driver. I'm adding this geometry 
> to tests/tripup.R and data files; without code changes the hole slot is wrong 
> and the ring direction is changes to match, so the coordinates change too.
>
> Reading using the deprecated maptools::readShapeSpatial() also gets a hole in 
> the second external ring. However, writing with deprecated 
> maptools:: writeSpatialShape() yields a shapefile that when read with 
> maptools:: readShapeSpatial() gives the correct two exterior ring, no hole 
> object. When read with sf::st_read() and rgdal::readOGR(), the object is also 
> correct. So the problem definitely lies in rgdal::writeOGR(), and 
> sf::st_write() - roundtripping with sf::st_write() and sf::st_read() degrades 
> from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.
>
> Roger
>
>>
>>  This is probably related to a similar but inverse problem with the
>>  SF-compliant GeoJSON driver in 2015:
>>
>>  https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
>>
>>  continued the next month in:
>>
>>  https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
>>
>>  The details are in this SVN diff
>>
>>  https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
>>
>>  up to the end og the list thread, and this one from then until now:
>>
>>  https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
>>
>>  Summary: could you change drivers, or is it really necessary to fix an EOL
>>  problem? What is your use case?
>> 
>>>
>>>   Thanks in advance for your time,
>>
>>  Thanks for a complete example,
>>
>>  Roger
>>
>>>   Phil
>>>
>>>>   sessionInfo()
>>>   R version 3.5.1 (2018-07-02)
>>>   Platform: x86_64-w64-mingw32/x64 (64-bit)
>>>   Running under: Windows >= 8 x64 (build 9200)
>>>
>>>   Matrix products: default
>>>
>>>   locale:
>>>   [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
>>>   Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
>>>                           LC_TIME=English_United Kingdom.1252
>>>
>>>   attached base packages:
>>>   [1] stats     graphics  grDevices utils     datasets  methods   base
>>>
>>>   other attached packages:
>>>   [1] rgdal_1.4-4 sp_1.3-1
>>>
>>>   loaded via a namespace (and not attached):
>>>   [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
>>>   lattice_0.20-35
>>>
>>>   _______________________________________________
>>>   R-sig-Geo mailing list
>>>   R-sig-Geo at r-project.org
>>>   https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>> 
>> 
>> 
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Sun Aug 18 14:59:10 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Sun, 18 Aug 2019 14:59:10 +0200
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <alpine.LFD.2.21.1908171104350.9677@reclus.nhh.no>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
 <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
 <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>
 <alpine.LFD.2.21.1908171104350.9677@reclus.nhh.no>
Message-ID: <alpine.LFD.2.21.1908181432250.29427@reclus.nhh.no>

The reason that the problem occurred is that a MULTIPOLYGON with two 
exterior rings becomes invalid if the exterior rings touch along an edge 
(this case). It is important to know the use case, to see whether:

library(rgeos)
writeWKT(Ps1)
gIsValid(Ps1, reason=TRUE)
Ps1a <- gUnaryUnion(gBuffer(Ps1, width=0))
gIsValid(Ps1a, reason=TRUE)
writeWKT(Ps1a)

or equivalently in sf for sf objects, should be applied before trying to 
write the object out to file with this driver.

However, because drivers that are compliant with the simple features 
standard (which bans exterior rings sharing edges) have been permissive 
and do round-trip this invalid object, a relaxation in the OGR ESRI 
shapefile driver has been provided and may be included in a future 
release.

We need to know (see these issues):

https://github.com/r-spatial/sf/issues/1130
https://github.com/OSGeo/gdal/issues/1787

why it was desirable to write out this object using this driver? Could an 
alternative driver have been used, or is ESRI shapefile the only format 
used in the workflow?

If it has to be this driver, could the workflow be changed to repair 
degenerate cases before writing? If using sp classes, rgeos may be used to 
test for and probably repair such geometries before they reach 
rgdal::writeOGR() for this driver. Adding code to sf and rgdal to trap 
degenerate cases does encumber all users with valid geometries with 
the time wasted on extra checking, so building checks into sf and rgdal is 
not desirable.

I hope it is possible to find out more about the use case quickly, to pass 
on to GDAL developers to help motivate a relaxation in their current 
policy with regard to this driver, and to encourage them to include the 
fix branch in a future release of GDAL.

Roger

On Sat, 17 Aug 2019, Roger Bivand wrote:

> Please follow up both here and on:
>
> https://github.com/r-spatial/sf/issues/1130
>
> as the problem is also seen in the sf package using the same GDAL ESRI 
> Shapefile driver.
>
> Roger
>
> On Fri, 16 Aug 2019, Roger Bivand wrote:
>
>>  On Fri, 16 Aug 2019, Roger Bivand wrote:
>>
>>>   On Tue, 13 Aug 2019, Phil Haines wrote:
>>>
>>>>    Dear list,
>>>>
>>>>    I have a single Polygons object containing multiple Polygon objects
>>>>    that share a common border. When I output this using writeOGR() one of
>>>>    the Polygon objects becomes a hole, as the following example shows.
>>>>
>>>>    Create a Polygons object containing two adjoining Polygon objects
>>>>>    library(rgdal)
>>>>>    r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>>    r2 <- r1; r2[,1] <- r2[,1]+1
>>>>>    Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>>    SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>>    data.frame(Example=c("Minimal")))
>>>>
>>>>    Perform a write/readOGR() cycle
>>>>>    fn <- tempfile()
>>>>>    writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>>    SPDF2 <- readOGR(dsn=fn,layer='test')
>>>>
>>>>    Second Polygon object is now a hole
>>>>>    sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
>>>>    [1] FALSE  TRUE
>>>>
>>>>    I see from the sp documentation that "Polygon objects belonging to a
>>>>    Polygons object should either not overlap one-other, or should be
>>>>    fully included" but I am not sure how this relates to bordering
>>>>    Polygon objects. I would welcome any advice as to whether what I am
>>>>    asking of writeOGR is reasonable?
>>>
>>>   The problem is with the 'ESRI Shapefile' representation and driver:
>>>
>>>   library(rgdal)
>>>   r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>   r2 <- r1; r2[,1] <- r2[,1]+1
>>>   Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>   SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>   data.frame(Example=c("Minimal")))
>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>
>>>   # which constructs a MULTIPOLYGON object:
>>>
>>>   rgeos::writeWKT(SPDF)
>>>   library(sf)
>>>   st_as_text(st_geometry(st_as_sf(SPDF)))
>>> 
>>> #    The 'ESRI Shapefile' driver is not Simple-Feature compliant (it 
>>> #    pre-dates it), so the failure occurs by seeing the second exterior 
>>> #    ring
>>> #    as an interior ring
>>>
>>>   fn <- tempfile()
>>>   writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>   SPDF2 <- readOGR(dsn=fn, layer='test')
>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>   rgeos::writeWKT(SPDF2)
>>>   st_as_text(st_geometry(st_as_sf(SPDF2)))
>>>
>>>   # This happens with sf too, using the same GDAL driver:
>>>
>>>   sf2 <- st_read(dsn=fn, layer='test')
>>>   st_geometry(sf2)
>>>   library(sf)
>>>   st_as_text(st_geometry(st_as_sf(sf2)))
>>>   rgeos::writeWKT(as(sf2, "Spatial"))
>>>
>>>   # Adding the comment fix doesn't help:
>>>
>>>   comment(slot(SPDF, "polygons")[[1]])
>>>   SPDF_c <- rgeos::createSPComment(SPDF)
>>>   comment(slot(SPDF_c, "polygons")[[1]])
>>>   writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
>>>     verbose=TRUE)
>>> 
>>> #    reports
>>> #    Object initially classed as: wkbPolygon
>>> #    SFS comments in Polygons objects
>>> #    Object reclassed as: wkbMultiPolygon
>>>
>>>   SPDF2_c <- readOGR(dsn=fn, layer='test_c')
>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot,
>>>   "ringDir")
>>>   rgeos::writeWKT(SPDF2_c)
>>>   st_as_text(st_geometry(st_as_sf(SPDF2_c)))
>>>
>>> 
>>>
>>>   # If the input object is written out with the GeoPackage driver:
>>>
>>>   fn1 <- tempfile(fileext=".gpkg")
>>>   writeOGR(SPDF, fn1, layer="test", driver='GPKG')
>>>   sf2a <- st_read(dsn=fn1,layer='test')
>>>   st_coordinates(st_geometry(sf2a))
>>>   SPDF2a <- readOGR(dsn=fn1)
>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>   rgeos::writeWKT(SPDF2a)
>>>   st_as_text(st_geometry(st_as_sf(SPDF2a)))
>>>
>>>   # the issue is resolved. If we separate the exterior rings:
>>>
>>>   r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
>>>   Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
>>>   SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
>>>   data.frame(Example=c("Minimal")))
>>>   fna <- tempfile()
>>>   writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
>>>   SPDF2_a <- readOGR(dsn=fna, layer='test')
>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot,
>>>   "ringDir")
>>>   rgeos::writeWKT(SPDF2_a)
>>>   st_as_text(st_geometry(st_as_sf(SPDF2_a)))
>>>
>>>   # we are OK as the two exterior rings do not touch.
>>>
>>>   # does using sf make a difference?
>>>
>>>   fn_s <- tempfile(fileext=".shp")
>>>   st_write(st_as_sf(SPDF), dsn=fn_s)
>>>   sf_in <- st_read(fn_s)
>>>   st_as_text(st_geometry(st_as_sf(sf_in)))
>>>
>>>   # No
>>>
>>>   fn_s <- tempfile(fileext=".shp")
>>>   st_write(st_as_sf(SPDF_c), dsn=fn_s)
>>>   sf_in_c <- st_read(fn_s)
>>>   st_as_text(st_geometry(st_as_sf(sf_in_c)))
>>>
>>>   # nor with the pretend-SF-compliant comment set either.
>>>
>>>   So the weakness is in the "ESRI Shapefile" write driver, or possibly in
>>>   the OGRGeometryFactory::organizePolygons() function in GDAL used in
>>>   OGR_write() (a C++ function) called by writeOGR(). If sf::st_write()
>>>   also
>>>   calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that
>>>   it
>>>   has a weakness for the "ESRI Shapefile" driver, but which does not
>>>   affect
>>>   SF-compliant drivers.
>>
>>  Without the comment set, OGRGeometryFactory::organizePolygons() is used;
>>  with it set, OGRGeometryFactory::organizePolygons() is not used, because
>>  the object is declared as two exterior rings. In both cases, we have the
>>  output object written out and read back in incorrectly with the ESRI
>>  shapefile driver, but SF-compliant drivers round-trip (in the test
>>  GeoJSON), correctly.
>>
>>  It is likely that the changes made in 2015 to accommodate GeoJSON led to
>>  this possible regression for the ESRI Shapefile driver. I'm adding this
>>  geometry to tests/tripup.R and data files; without code changes the hole
>>  slot is wrong and the ring direction is changes to match, so the
>>  coordinates change too.
>>
>>  Reading using the deprecated maptools::readShapeSpatial() also gets a hole
>>  in the second external ring. However, writing with deprecated 
>> maptools::  writeSpatialShape() yields a shapefile that when read with 
>> maptools::  readShapeSpatial() gives the correct two exterior ring, no hole
>>  object. When read with sf::st_read() and rgdal::readOGR(), the object is
>>  also correct. So the problem definitely lies in rgdal::writeOGR(), and
>>  sf::st_write() - roundtripping with sf::st_write() and sf::st_read()
>>  degrades from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.
>>
>>  Roger
>> 
>>>
>>>   This is probably related to a similar but inverse problem with the
>>>   SF-compliant GeoJSON driver in 2015:
>>>
>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
>>>
>>>   continued the next month in:
>>>
>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
>>>
>>>   The details are in this SVN diff
>>>
>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
>>>
>>>   up to the end og the list thread, and this one from then until now:
>>>
>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
>>>
>>>   Summary: could you change drivers, or is it really necessary to fix an
>>>   EOL
>>>   problem? What is your use case?
>>> 
>>>>
>>>>    Thanks in advance for your time,
>>>
>>>   Thanks for a complete example,
>>>
>>>   Roger
>>>
>>>>    Phil
>>>>
>>>>>    sessionInfo()
>>>>    R version 3.5.1 (2018-07-02)
>>>>    Platform: x86_64-w64-mingw32/x64 (64-bit)
>>>>    Running under: Windows >= 8 x64 (build 9200)
>>>>
>>>>    Matrix products: default
>>>>
>>>>    locale:
>>>>    [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
>>>>    Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
>>>>                            LC_TIME=English_United Kingdom.1252
>>>>
>>>>    attached base packages:
>>>>    [1] stats     graphics  grDevices utils     datasets  methods   base
>>>>
>>>>    other attached packages:
>>>>    [1] rgdal_1.4-4 sp_1.3-1
>>>>
>>>>    loaded via a namespace (and not attached):
>>>>    [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
>>>>    lattice_0.20-35
>>>>
>>>>    _______________________________________________
>>>>    R-sig-Geo mailing list
>>>>    R-sig-Geo at r-project.org
>>>>    https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>
>>>
>>> 
>> 
>> 
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From ph||@h@|ne@82 @end|ng |rom gm@||@com  Sun Aug 18 22:33:46 2019
From: ph||@h@|ne@82 @end|ng |rom gm@||@com (Phil Haines)
Date: Sun, 18 Aug 2019 21:33:46 +0100
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <alpine.LFD.2.21.1908181432250.29427@reclus.nhh.no>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
 <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
 <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>
 <alpine.LFD.2.21.1908171104350.9677@reclus.nhh.no>
 <alpine.LFD.2.21.1908181432250.29427@reclus.nhh.no>
Message-ID: <CACPnO4drr=d==6X0=OUfNSW69-JVXs73Ew7_3_sf-uL6muqs8g@mail.gmail.com>

Hi Roger,

I originally encountered this issue while trying to reduce the size of
German postal code boundaries. I used rmapshaper::ms_simplify() which
introduced the polygons sharing a common edge. I definitely didn't
need them to be separate polygons, and would happily have merged them
had I been more familiar with gUnaryUnion().

I apologise if my question has resulted in unnecessary effort on your
part. I reported the behaviour because I found it surprising. However,
I now understand that this example is not a valid simple feature
geometry and that the solution is to take steps to ensure I have valid
geometries, and to repair if not.

Additionally I must confess that I only use the ESRI Shapefile driver
because I don't know any better... My use cases are reading and
writing from R (usually to produce maps) and occasionally opening in
QGIS. I can happily switch to any format that supports this workflow.

Thank you very much for your time,
Phil

On Sun, 18 Aug 2019 at 13:59, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>
> The reason that the problem occurred is that a MULTIPOLYGON with two
> exterior rings becomes invalid if the exterior rings touch along an edge
> (this case). It is important to know the use case, to see whether:
>
> library(rgeos)
> writeWKT(Ps1)
> gIsValid(Ps1, reason=TRUE)
> Ps1a <- gUnaryUnion(gBuffer(Ps1, width=0))
> gIsValid(Ps1a, reason=TRUE)
> writeWKT(Ps1a)
>
> or equivalently in sf for sf objects, should be applied before trying to
> write the object out to file with this driver.
>
> However, because drivers that are compliant with the simple features
> standard (which bans exterior rings sharing edges) have been permissive
> and do round-trip this invalid object, a relaxation in the OGR ESRI
> shapefile driver has been provided and may be included in a future
> release.
>
> We need to know (see these issues):
>
> https://github.com/r-spatial/sf/issues/1130
> https://github.com/OSGeo/gdal/issues/1787
>
> why it was desirable to write out this object using this driver? Could an
> alternative driver have been used, or is ESRI shapefile the only format
> used in the workflow?
>
> If it has to be this driver, could the workflow be changed to repair
> degenerate cases before writing? If using sp classes, rgeos may be used to
> test for and probably repair such geometries before they reach
> rgdal::writeOGR() for this driver. Adding code to sf and rgdal to trap
> degenerate cases does encumber all users with valid geometries with
> the time wasted on extra checking, so building checks into sf and rgdal is
> not desirable.
>
> I hope it is possible to find out more about the use case quickly, to pass
> on to GDAL developers to help motivate a relaxation in their current
> policy with regard to this driver, and to encourage them to include the
> fix branch in a future release of GDAL.
>
> Roger
>
> On Sat, 17 Aug 2019, Roger Bivand wrote:
>
> > Please follow up both here and on:
> >
> > https://github.com/r-spatial/sf/issues/1130
> >
> > as the problem is also seen in the sf package using the same GDAL ESRI
> > Shapefile driver.
> >
> > Roger
> >
> > On Fri, 16 Aug 2019, Roger Bivand wrote:
> >
> >>  On Fri, 16 Aug 2019, Roger Bivand wrote:
> >>
> >>>   On Tue, 13 Aug 2019, Phil Haines wrote:
> >>>
> >>>>    Dear list,
> >>>>
> >>>>    I have a single Polygons object containing multiple Polygon objects
> >>>>    that share a common border. When I output this using writeOGR() one of
> >>>>    the Polygon objects becomes a hole, as the following example shows.
> >>>>
> >>>>    Create a Polygons object containing two adjoining Polygon objects
> >>>>>    library(rgdal)
> >>>>>    r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
> >>>>>    r2 <- r1; r2[,1] <- r2[,1]+1
> >>>>>    Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
> >>>>>    SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
> >>>>>    data.frame(Example=c("Minimal")))
> >>>>
> >>>>    Perform a write/readOGR() cycle
> >>>>>    fn <- tempfile()
> >>>>>    writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
> >>>>>    SPDF2 <- readOGR(dsn=fn,layer='test')
> >>>>
> >>>>    Second Polygon object is now a hole
> >>>>>    sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
> >>>>    [1] FALSE  TRUE
> >>>>
> >>>>    I see from the sp documentation that "Polygon objects belonging to a
> >>>>    Polygons object should either not overlap one-other, or should be
> >>>>    fully included" but I am not sure how this relates to bordering
> >>>>    Polygon objects. I would welcome any advice as to whether what I am
> >>>>    asking of writeOGR is reasonable?
> >>>
> >>>   The problem is with the 'ESRI Shapefile' representation and driver:
> >>>
> >>>   library(rgdal)
> >>>   r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
> >>>   r2 <- r1; r2[,1] <- r2[,1]+1
> >>>   Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
> >>>   SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
> >>>   data.frame(Example=c("Minimal")))
> >>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
> >>>
> >>>   # which constructs a MULTIPOLYGON object:
> >>>
> >>>   rgeos::writeWKT(SPDF)
> >>>   library(sf)
> >>>   st_as_text(st_geometry(st_as_sf(SPDF)))
> >>>
> >>> #    The 'ESRI Shapefile' driver is not Simple-Feature compliant (it
> >>> #    pre-dates it), so the failure occurs by seeing the second exterior
> >>> #    ring
> >>> #    as an interior ring
> >>>
> >>>   fn <- tempfile()
> >>>   writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
> >>>   SPDF2 <- readOGR(dsn=fn, layer='test')
> >>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
> >>>   rgeos::writeWKT(SPDF2)
> >>>   st_as_text(st_geometry(st_as_sf(SPDF2)))
> >>>
> >>>   # This happens with sf too, using the same GDAL driver:
> >>>
> >>>   sf2 <- st_read(dsn=fn, layer='test')
> >>>   st_geometry(sf2)
> >>>   library(sf)
> >>>   st_as_text(st_geometry(st_as_sf(sf2)))
> >>>   rgeos::writeWKT(as(sf2, "Spatial"))
> >>>
> >>>   # Adding the comment fix doesn't help:
> >>>
> >>>   comment(slot(SPDF, "polygons")[[1]])
> >>>   SPDF_c <- rgeos::createSPComment(SPDF)
> >>>   comment(slot(SPDF_c, "polygons")[[1]])
> >>>   writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
> >>>     verbose=TRUE)
> >>>
> >>> #    reports
> >>> #    Object initially classed as: wkbPolygon
> >>> #    SFS comments in Polygons objects
> >>> #    Object reclassed as: wkbMultiPolygon
> >>>
> >>>   SPDF2_c <- readOGR(dsn=fn, layer='test_c')
> >>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot,
> >>>   "ringDir")
> >>>   rgeos::writeWKT(SPDF2_c)
> >>>   st_as_text(st_geometry(st_as_sf(SPDF2_c)))
> >>>
> >>>
> >>>
> >>>   # If the input object is written out with the GeoPackage driver:
> >>>
> >>>   fn1 <- tempfile(fileext=".gpkg")
> >>>   writeOGR(SPDF, fn1, layer="test", driver='GPKG')
> >>>   sf2a <- st_read(dsn=fn1,layer='test')
> >>>   st_coordinates(st_geometry(sf2a))
> >>>   SPDF2a <- readOGR(dsn=fn1)
> >>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
> >>>   rgeos::writeWKT(SPDF2a)
> >>>   st_as_text(st_geometry(st_as_sf(SPDF2a)))
> >>>
> >>>   # the issue is resolved. If we separate the exterior rings:
> >>>
> >>>   r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
> >>>   Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
> >>>   SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
> >>>   data.frame(Example=c("Minimal")))
> >>>   fna <- tempfile()
> >>>   writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
> >>>   SPDF2_a <- readOGR(dsn=fna, layer='test')
> >>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot,
> >>>   "ringDir")
> >>>   rgeos::writeWKT(SPDF2_a)
> >>>   st_as_text(st_geometry(st_as_sf(SPDF2_a)))
> >>>
> >>>   # we are OK as the two exterior rings do not touch.
> >>>
> >>>   # does using sf make a difference?
> >>>
> >>>   fn_s <- tempfile(fileext=".shp")
> >>>   st_write(st_as_sf(SPDF), dsn=fn_s)
> >>>   sf_in <- st_read(fn_s)
> >>>   st_as_text(st_geometry(st_as_sf(sf_in)))
> >>>
> >>>   # No
> >>>
> >>>   fn_s <- tempfile(fileext=".shp")
> >>>   st_write(st_as_sf(SPDF_c), dsn=fn_s)
> >>>   sf_in_c <- st_read(fn_s)
> >>>   st_as_text(st_geometry(st_as_sf(sf_in_c)))
> >>>
> >>>   # nor with the pretend-SF-compliant comment set either.
> >>>
> >>>   So the weakness is in the "ESRI Shapefile" write driver, or possibly in
> >>>   the OGRGeometryFactory::organizePolygons() function in GDAL used in
> >>>   OGR_write() (a C++ function) called by writeOGR(). If sf::st_write()
> >>>   also
> >>>   calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that
> >>>   it
> >>>   has a weakness for the "ESRI Shapefile" driver, but which does not
> >>>   affect
> >>>   SF-compliant drivers.
> >>
> >>  Without the comment set, OGRGeometryFactory::organizePolygons() is used;
> >>  with it set, OGRGeometryFactory::organizePolygons() is not used, because
> >>  the object is declared as two exterior rings. In both cases, we have the
> >>  output object written out and read back in incorrectly with the ESRI
> >>  shapefile driver, but SF-compliant drivers round-trip (in the test
> >>  GeoJSON), correctly.
> >>
> >>  It is likely that the changes made in 2015 to accommodate GeoJSON led to
> >>  this possible regression for the ESRI Shapefile driver. I'm adding this
> >>  geometry to tests/tripup.R and data files; without code changes the hole
> >>  slot is wrong and the ring direction is changes to match, so the
> >>  coordinates change too.
> >>
> >>  Reading using the deprecated maptools::readShapeSpatial() also gets a hole
> >>  in the second external ring. However, writing with deprecated
> >> maptools::  writeSpatialShape() yields a shapefile that when read with
> >> maptools::  readShapeSpatial() gives the correct two exterior ring, no hole
> >>  object. When read with sf::st_read() and rgdal::readOGR(), the object is
> >>  also correct. So the problem definitely lies in rgdal::writeOGR(), and
> >>  sf::st_write() - roundtripping with sf::st_write() and sf::st_read()
> >>  degrades from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.
> >>
> >>  Roger
> >>
> >>>
> >>>   This is probably related to a similar but inverse problem with the
> >>>   SF-compliant GeoJSON driver in 2015:
> >>>
> >>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
> >>>
> >>>   continued the next month in:
> >>>
> >>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
> >>>
> >>>   The details are in this SVN diff
> >>>
> >>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
> >>>
> >>>   up to the end og the list thread, and this one from then until now:
> >>>
> >>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
> >>>
> >>>   Summary: could you change drivers, or is it really necessary to fix an
> >>>   EOL
> >>>   problem? What is your use case?
> >>>
> >>>>
> >>>>    Thanks in advance for your time,
> >>>
> >>>   Thanks for a complete example,
> >>>
> >>>   Roger
> >>>
> >>>>    Phil
> >>>>
> >>>>>    sessionInfo()
> >>>>    R version 3.5.1 (2018-07-02)
> >>>>    Platform: x86_64-w64-mingw32/x64 (64-bit)
> >>>>    Running under: Windows >= 8 x64 (build 9200)
> >>>>
> >>>>    Matrix products: default
> >>>>
> >>>>    locale:
> >>>>    [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
> >>>>    Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
> >>>>                            LC_TIME=English_United Kingdom.1252
> >>>>
> >>>>    attached base packages:
> >>>>    [1] stats     graphics  grDevices utils     datasets  methods   base
> >>>>
> >>>>    other attached packages:
> >>>>    [1] rgdal_1.4-4 sp_1.3-1
> >>>>
> >>>>    loaded via a namespace (and not attached):
> >>>>    [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
> >>>>    lattice_0.20-35
> >>>>
> >>>>    _______________________________________________
> >>>>    R-sig-Geo mailing list
> >>>>    R-sig-Geo at r-project.org
> >>>>    https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>>>
> >>>
> >>>
> >>
> >>
> >
> >
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Mon Aug 19 16:48:08 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Mon, 19 Aug 2019 16:48:08 +0200
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <CACPnO4drr=d==6X0=OUfNSW69-JVXs73Ew7_3_sf-uL6muqs8g@mail.gmail.com>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
 <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
 <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>
 <alpine.LFD.2.21.1908171104350.9677@reclus.nhh.no>
 <alpine.LFD.2.21.1908181432250.29427@reclus.nhh.no>
 <CACPnO4drr=d==6X0=OUfNSW69-JVXs73Ew7_3_sf-uL6muqs8g@mail.gmail.com>
Message-ID: <alpine.LFD.2.21.1908191626330.2757@reclus.nhh.no>

Hi Phil,

On Sun, 18 Aug 2019, Phil Haines wrote:

> Hi Roger,
>
> I originally encountered this issue while trying to reduce the size of
> German postal code boundaries. I used rmapshaper::ms_simplify() which
> introduced the polygons sharing a common edge. I definitely didn't
> need them to be separate polygons, and would happily have merged them
> had I been more familiar with gUnaryUnion().

If the German postal code boundaries are open, could you please put (an 
affected subset) on an URL, and provide a short script to replicate the 
workflow. Then we can engage with the rmapshaper maintainer, and see 
whether the underlying problem in the workflow is in the js library or its 
R wrapper. I've opened: https://github.com/ateucher/rmapshaper/issues/89.

>
> I apologise if my question has resulted in unnecessary effort on your
> part. I reported the behaviour because I found it surprising. However,
> I now understand that this example is not a valid simple feature
> geometry and that the solution is to take steps to ensure I have valid
> geometries, and to repair if not.
>

No need to apologise!! Your reproducible example was excellent, without it 
you wouldn't have contributed to getting the internal shapelib code 
changed to make it less restrictive in future releases of GDAL, 
potentially benefitting lots of users (who really should drop ESRI 
shapefiles, and/or should check geometries for validity, but ... whose 
work you've helped save). By the way, ESRI would be very happy if 
shapefiles stopped being produced in current workflows, and that new files 
should rather be GPKG.

> Additionally I must confess that I only use the ESRI Shapefile driver
> because I don't know any better... My use cases are reading and
> writing from R (usually to produce maps) and occasionally opening in
> QGIS. I can happily switch to any format that supports this workflow.
>

GPKG is now very broadly supported, is SF-compliant, and has the big 
user-facing benefits of not having field name length restrictions, and 
many fewer encoding issues for field names and string values.

Best wishes,

Roger

> Thank you very much for your time,
> Phil
>
> On Sun, 18 Aug 2019 at 13:59, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>
>> The reason that the problem occurred is that a MULTIPOLYGON with two
>> exterior rings becomes invalid if the exterior rings touch along an edge
>> (this case). It is important to know the use case, to see whether:
>>
>> library(rgeos)
>> writeWKT(Ps1)
>> gIsValid(Ps1, reason=TRUE)
>> Ps1a <- gUnaryUnion(gBuffer(Ps1, width=0))
>> gIsValid(Ps1a, reason=TRUE)
>> writeWKT(Ps1a)
>>
>> or equivalently in sf for sf objects, should be applied before trying to
>> write the object out to file with this driver.
>>
>> However, because drivers that are compliant with the simple features
>> standard (which bans exterior rings sharing edges) have been permissive
>> and do round-trip this invalid object, a relaxation in the OGR ESRI
>> shapefile driver has been provided and may be included in a future
>> release.
>>
>> We need to know (see these issues):
>>
>> https://github.com/r-spatial/sf/issues/1130
>> https://github.com/OSGeo/gdal/issues/1787
>>
>> why it was desirable to write out this object using this driver? Could an
>> alternative driver have been used, or is ESRI shapefile the only format
>> used in the workflow?
>>
>> If it has to be this driver, could the workflow be changed to repair
>> degenerate cases before writing? If using sp classes, rgeos may be used to
>> test for and probably repair such geometries before they reach
>> rgdal::writeOGR() for this driver. Adding code to sf and rgdal to trap
>> degenerate cases does encumber all users with valid geometries with
>> the time wasted on extra checking, so building checks into sf and rgdal is
>> not desirable.
>>
>> I hope it is possible to find out more about the use case quickly, to pass
>> on to GDAL developers to help motivate a relaxation in their current
>> policy with regard to this driver, and to encourage them to include the
>> fix branch in a future release of GDAL.
>>
>> Roger
>>
>> On Sat, 17 Aug 2019, Roger Bivand wrote:
>>
>>> Please follow up both here and on:
>>>
>>> https://github.com/r-spatial/sf/issues/1130
>>>
>>> as the problem is also seen in the sf package using the same GDAL ESRI
>>> Shapefile driver.
>>>
>>> Roger
>>>
>>> On Fri, 16 Aug 2019, Roger Bivand wrote:
>>>
>>>>  On Fri, 16 Aug 2019, Roger Bivand wrote:
>>>>
>>>>>   On Tue, 13 Aug 2019, Phil Haines wrote:
>>>>>
>>>>>>    Dear list,
>>>>>>
>>>>>>    I have a single Polygons object containing multiple Polygon objects
>>>>>>    that share a common border. When I output this using writeOGR() one of
>>>>>>    the Polygon objects becomes a hole, as the following example shows.
>>>>>>
>>>>>>    Create a Polygons object containing two adjoining Polygon objects
>>>>>>>    library(rgdal)
>>>>>>>    r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>>>>    r2 <- r1; r2[,1] <- r2[,1]+1
>>>>>>>    Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>>>>    SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>>>>    data.frame(Example=c("Minimal")))
>>>>>>
>>>>>>    Perform a write/readOGR() cycle
>>>>>>>    fn <- tempfile()
>>>>>>>    writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>>>>    SPDF2 <- readOGR(dsn=fn,layer='test')
>>>>>>
>>>>>>    Second Polygon object is now a hole
>>>>>>>    sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
>>>>>>    [1] FALSE  TRUE
>>>>>>
>>>>>>    I see from the sp documentation that "Polygon objects belonging to a
>>>>>>    Polygons object should either not overlap one-other, or should be
>>>>>>    fully included" but I am not sure how this relates to bordering
>>>>>>    Polygon objects. I would welcome any advice as to whether what I am
>>>>>>    asking of writeOGR is reasonable?
>>>>>
>>>>>   The problem is with the 'ESRI Shapefile' representation and driver:
>>>>>
>>>>>   library(rgdal)
>>>>>   r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>>   r2 <- r1; r2[,1] <- r2[,1]+1
>>>>>   Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>>   SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>>   data.frame(Example=c("Minimal")))
>>>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>
>>>>>   # which constructs a MULTIPOLYGON object:
>>>>>
>>>>>   rgeos::writeWKT(SPDF)
>>>>>   library(sf)
>>>>>   st_as_text(st_geometry(st_as_sf(SPDF)))
>>>>>
>>>>> #    The 'ESRI Shapefile' driver is not Simple-Feature compliant (it
>>>>> #    pre-dates it), so the failure occurs by seeing the second exterior
>>>>> #    ring
>>>>> #    as an interior ring
>>>>>
>>>>>   fn <- tempfile()
>>>>>   writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>>   SPDF2 <- readOGR(dsn=fn, layer='test')
>>>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>   rgeos::writeWKT(SPDF2)
>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2)))
>>>>>
>>>>>   # This happens with sf too, using the same GDAL driver:
>>>>>
>>>>>   sf2 <- st_read(dsn=fn, layer='test')
>>>>>   st_geometry(sf2)
>>>>>   library(sf)
>>>>>   st_as_text(st_geometry(st_as_sf(sf2)))
>>>>>   rgeos::writeWKT(as(sf2, "Spatial"))
>>>>>
>>>>>   # Adding the comment fix doesn't help:
>>>>>
>>>>>   comment(slot(SPDF, "polygons")[[1]])
>>>>>   SPDF_c <- rgeos::createSPComment(SPDF)
>>>>>   comment(slot(SPDF_c, "polygons")[[1]])
>>>>>   writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
>>>>>     verbose=TRUE)
>>>>>
>>>>> #    reports
>>>>> #    Object initially classed as: wkbPolygon
>>>>> #    SFS comments in Polygons objects
>>>>> #    Object reclassed as: wkbMultiPolygon
>>>>>
>>>>>   SPDF2_c <- readOGR(dsn=fn, layer='test_c')
>>>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot,
>>>>>   "ringDir")
>>>>>   rgeos::writeWKT(SPDF2_c)
>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2_c)))
>>>>>
>>>>>
>>>>>
>>>>>   # If the input object is written out with the GeoPackage driver:
>>>>>
>>>>>   fn1 <- tempfile(fileext=".gpkg")
>>>>>   writeOGR(SPDF, fn1, layer="test", driver='GPKG')
>>>>>   sf2a <- st_read(dsn=fn1,layer='test')
>>>>>   st_coordinates(st_geometry(sf2a))
>>>>>   SPDF2a <- readOGR(dsn=fn1)
>>>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>   rgeos::writeWKT(SPDF2a)
>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2a)))
>>>>>
>>>>>   # the issue is resolved. If we separate the exterior rings:
>>>>>
>>>>>   r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
>>>>>   Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
>>>>>   SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
>>>>>   data.frame(Example=c("Minimal")))
>>>>>   fna <- tempfile()
>>>>>   writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
>>>>>   SPDF2_a <- readOGR(dsn=fna, layer='test')
>>>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot,
>>>>>   "ringDir")
>>>>>   rgeos::writeWKT(SPDF2_a)
>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2_a)))
>>>>>
>>>>>   # we are OK as the two exterior rings do not touch.
>>>>>
>>>>>   # does using sf make a difference?
>>>>>
>>>>>   fn_s <- tempfile(fileext=".shp")
>>>>>   st_write(st_as_sf(SPDF), dsn=fn_s)
>>>>>   sf_in <- st_read(fn_s)
>>>>>   st_as_text(st_geometry(st_as_sf(sf_in)))
>>>>>
>>>>>   # No
>>>>>
>>>>>   fn_s <- tempfile(fileext=".shp")
>>>>>   st_write(st_as_sf(SPDF_c), dsn=fn_s)
>>>>>   sf_in_c <- st_read(fn_s)
>>>>>   st_as_text(st_geometry(st_as_sf(sf_in_c)))
>>>>>
>>>>>   # nor with the pretend-SF-compliant comment set either.
>>>>>
>>>>>   So the weakness is in the "ESRI Shapefile" write driver, or possibly in
>>>>>   the OGRGeometryFactory::organizePolygons() function in GDAL used in
>>>>>   OGR_write() (a C++ function) called by writeOGR(). If sf::st_write()
>>>>>   also
>>>>>   calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that
>>>>>   it
>>>>>   has a weakness for the "ESRI Shapefile" driver, but which does not
>>>>>   affect
>>>>>   SF-compliant drivers.
>>>>
>>>>  Without the comment set, OGRGeometryFactory::organizePolygons() is used;
>>>>  with it set, OGRGeometryFactory::organizePolygons() is not used, because
>>>>  the object is declared as two exterior rings. In both cases, we have the
>>>>  output object written out and read back in incorrectly with the ESRI
>>>>  shapefile driver, but SF-compliant drivers round-trip (in the test
>>>>  GeoJSON), correctly.
>>>>
>>>>  It is likely that the changes made in 2015 to accommodate GeoJSON led to
>>>>  this possible regression for the ESRI Shapefile driver. I'm adding this
>>>>  geometry to tests/tripup.R and data files; without code changes the hole
>>>>  slot is wrong and the ring direction is changes to match, so the
>>>>  coordinates change too.
>>>>
>>>>  Reading using the deprecated maptools::readShapeSpatial() also gets a hole
>>>>  in the second external ring. However, writing with deprecated
>>>> maptools::  writeSpatialShape() yields a shapefile that when read with
>>>> maptools::  readShapeSpatial() gives the correct two exterior ring, no hole
>>>>  object. When read with sf::st_read() and rgdal::readOGR(), the object is
>>>>  also correct. So the problem definitely lies in rgdal::writeOGR(), and
>>>>  sf::st_write() - roundtripping with sf::st_write() and sf::st_read()
>>>>  degrades from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.
>>>>
>>>>  Roger
>>>>
>>>>>
>>>>>   This is probably related to a similar but inverse problem with the
>>>>>   SF-compliant GeoJSON driver in 2015:
>>>>>
>>>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
>>>>>
>>>>>   continued the next month in:
>>>>>
>>>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
>>>>>
>>>>>   The details are in this SVN diff
>>>>>
>>>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
>>>>>
>>>>>   up to the end og the list thread, and this one from then until now:
>>>>>
>>>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
>>>>>
>>>>>   Summary: could you change drivers, or is it really necessary to fix an
>>>>>   EOL
>>>>>   problem? What is your use case?
>>>>>
>>>>>>
>>>>>>    Thanks in advance for your time,
>>>>>
>>>>>   Thanks for a complete example,
>>>>>
>>>>>   Roger
>>>>>
>>>>>>    Phil
>>>>>>
>>>>>>>    sessionInfo()
>>>>>>    R version 3.5.1 (2018-07-02)
>>>>>>    Platform: x86_64-w64-mingw32/x64 (64-bit)
>>>>>>    Running under: Windows >= 8 x64 (build 9200)
>>>>>>
>>>>>>    Matrix products: default
>>>>>>
>>>>>>    locale:
>>>>>>    [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
>>>>>>    Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
>>>>>>                            LC_TIME=English_United Kingdom.1252
>>>>>>
>>>>>>    attached base packages:
>>>>>>    [1] stats     graphics  grDevices utils     datasets  methods   base
>>>>>>
>>>>>>    other attached packages:
>>>>>>    [1] rgdal_1.4-4 sp_1.3-1
>>>>>>
>>>>>>    loaded via a namespace (and not attached):
>>>>>>    [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
>>>>>>    lattice_0.20-35
>>>>>>
>>>>>>    _______________________________________________
>>>>>>    R-sig-Geo mailing list
>>>>>>    R-sig-Geo at r-project.org
>>>>>>    https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>>>
>>>>>
>>>>>
>>>>
>>>>
>>>
>>>
>>
>> --
>> Roger Bivand
>> Department of Economics, Norwegian School of Economics,
>> Helleveien 30, N-5045 Bergen, Norway.
>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>> https://orcid.org/0000-0003-2392-6140
>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From ph||@h@|ne@82 @end|ng |rom gm@||@com  Mon Aug 19 18:50:49 2019
From: ph||@h@|ne@82 @end|ng |rom gm@||@com (Phil Haines)
Date: Mon, 19 Aug 2019 17:50:49 +0100
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <alpine.LFD.2.21.1908191626330.2757@reclus.nhh.no>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
 <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
 <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>
 <alpine.LFD.2.21.1908171104350.9677@reclus.nhh.no>
 <alpine.LFD.2.21.1908181432250.29427@reclus.nhh.no>
 <CACPnO4drr=d==6X0=OUfNSW69-JVXs73Ew7_3_sf-uL6muqs8g@mail.gmail.com>
 <alpine.LFD.2.21.1908191626330.2757@reclus.nhh.no>
Message-ID: <CACPnO4cfFKo_zrXO+5AZyA+A7tnJCr2vAZMzJ1uE=PpAG7ZzuQ@mail.gmail.com>

Hi Roger,

I have added an example to https://github.com/ateucher/rmapshaper/issues/89

Hopefully it illustrates the behaviour I was seeing from
rmapshaper::ms_simplify() but please let me know if not.

And thanks for the nudge towards GPKG, I will investigate.
Phil

On Mon, 19 Aug 2019 at 15:48, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>
> Hi Phil,
>
> On Sun, 18 Aug 2019, Phil Haines wrote:
>
> > Hi Roger,
> >
> > I originally encountered this issue while trying to reduce the size of
> > German postal code boundaries. I used rmapshaper::ms_simplify() which
> > introduced the polygons sharing a common edge. I definitely didn't
> > need them to be separate polygons, and would happily have merged them
> > had I been more familiar with gUnaryUnion().
>
> If the German postal code boundaries are open, could you please put (an
> affected subset) on an URL, and provide a short script to replicate the
> workflow. Then we can engage with the rmapshaper maintainer, and see
> whether the underlying problem in the workflow is in the js library or its
> R wrapper. I've opened: https://github.com/ateucher/rmapshaper/issues/89.
>
> >
> > I apologise if my question has resulted in unnecessary effort on your
> > part. I reported the behaviour because I found it surprising. However,
> > I now understand that this example is not a valid simple feature
> > geometry and that the solution is to take steps to ensure I have valid
> > geometries, and to repair if not.
> >
>
> No need to apologise!! Your reproducible example was excellent, without it
> you wouldn't have contributed to getting the internal shapelib code
> changed to make it less restrictive in future releases of GDAL,
> potentially benefitting lots of users (who really should drop ESRI
> shapefiles, and/or should check geometries for validity, but ... whose
> work you've helped save). By the way, ESRI would be very happy if
> shapefiles stopped being produced in current workflows, and that new files
> should rather be GPKG.
>
> > Additionally I must confess that I only use the ESRI Shapefile driver
> > because I don't know any better... My use cases are reading and
> > writing from R (usually to produce maps) and occasionally opening in
> > QGIS. I can happily switch to any format that supports this workflow.
> >
>
> GPKG is now very broadly supported, is SF-compliant, and has the big
> user-facing benefits of not having field name length restrictions, and
> many fewer encoding issues for field names and string values.
>
> Best wishes,
>
> Roger
>
> > Thank you very much for your time,
> > Phil
> >
> > On Sun, 18 Aug 2019 at 13:59, Roger Bivand <Roger.Bivand at nhh.no> wrote:
> >>
> >> The reason that the problem occurred is that a MULTIPOLYGON with two
> >> exterior rings becomes invalid if the exterior rings touch along an edge
> >> (this case). It is important to know the use case, to see whether:
> >>
> >> library(rgeos)
> >> writeWKT(Ps1)
> >> gIsValid(Ps1, reason=TRUE)
> >> Ps1a <- gUnaryUnion(gBuffer(Ps1, width=0))
> >> gIsValid(Ps1a, reason=TRUE)
> >> writeWKT(Ps1a)
> >>
> >> or equivalently in sf for sf objects, should be applied before trying to
> >> write the object out to file with this driver.
> >>
> >> However, because drivers that are compliant with the simple features
> >> standard (which bans exterior rings sharing edges) have been permissive
> >> and do round-trip this invalid object, a relaxation in the OGR ESRI
> >> shapefile driver has been provided and may be included in a future
> >> release.
> >>
> >> We need to know (see these issues):
> >>
> >> https://github.com/r-spatial/sf/issues/1130
> >> https://github.com/OSGeo/gdal/issues/1787
> >>
> >> why it was desirable to write out this object using this driver? Could an
> >> alternative driver have been used, or is ESRI shapefile the only format
> >> used in the workflow?
> >>
> >> If it has to be this driver, could the workflow be changed to repair
> >> degenerate cases before writing? If using sp classes, rgeos may be used to
> >> test for and probably repair such geometries before they reach
> >> rgdal::writeOGR() for this driver. Adding code to sf and rgdal to trap
> >> degenerate cases does encumber all users with valid geometries with
> >> the time wasted on extra checking, so building checks into sf and rgdal is
> >> not desirable.
> >>
> >> I hope it is possible to find out more about the use case quickly, to pass
> >> on to GDAL developers to help motivate a relaxation in their current
> >> policy with regard to this driver, and to encourage them to include the
> >> fix branch in a future release of GDAL.
> >>
> >> Roger
> >>
> >> On Sat, 17 Aug 2019, Roger Bivand wrote:
> >>
> >>> Please follow up both here and on:
> >>>
> >>> https://github.com/r-spatial/sf/issues/1130
> >>>
> >>> as the problem is also seen in the sf package using the same GDAL ESRI
> >>> Shapefile driver.
> >>>
> >>> Roger
> >>>
> >>> On Fri, 16 Aug 2019, Roger Bivand wrote:
> >>>
> >>>>  On Fri, 16 Aug 2019, Roger Bivand wrote:
> >>>>
> >>>>>   On Tue, 13 Aug 2019, Phil Haines wrote:
> >>>>>
> >>>>>>    Dear list,
> >>>>>>
> >>>>>>    I have a single Polygons object containing multiple Polygon objects
> >>>>>>    that share a common border. When I output this using writeOGR() one of
> >>>>>>    the Polygon objects becomes a hole, as the following example shows.
> >>>>>>
> >>>>>>    Create a Polygons object containing two adjoining Polygon objects
> >>>>>>>    library(rgdal)
> >>>>>>>    r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
> >>>>>>>    r2 <- r1; r2[,1] <- r2[,1]+1
> >>>>>>>    Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
> >>>>>>>    SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
> >>>>>>>    data.frame(Example=c("Minimal")))
> >>>>>>
> >>>>>>    Perform a write/readOGR() cycle
> >>>>>>>    fn <- tempfile()
> >>>>>>>    writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
> >>>>>>>    SPDF2 <- readOGR(dsn=fn,layer='test')
> >>>>>>
> >>>>>>    Second Polygon object is now a hole
> >>>>>>>    sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
> >>>>>>    [1] FALSE  TRUE
> >>>>>>
> >>>>>>    I see from the sp documentation that "Polygon objects belonging to a
> >>>>>>    Polygons object should either not overlap one-other, or should be
> >>>>>>    fully included" but I am not sure how this relates to bordering
> >>>>>>    Polygon objects. I would welcome any advice as to whether what I am
> >>>>>>    asking of writeOGR is reasonable?
> >>>>>
> >>>>>   The problem is with the 'ESRI Shapefile' representation and driver:
> >>>>>
> >>>>>   library(rgdal)
> >>>>>   r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
> >>>>>   r2 <- r1; r2[,1] <- r2[,1]+1
> >>>>>   Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
> >>>>>   SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
> >>>>>   data.frame(Example=c("Minimal")))
> >>>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
> >>>>>
> >>>>>   # which constructs a MULTIPOLYGON object:
> >>>>>
> >>>>>   rgeos::writeWKT(SPDF)
> >>>>>   library(sf)
> >>>>>   st_as_text(st_geometry(st_as_sf(SPDF)))
> >>>>>
> >>>>> #    The 'ESRI Shapefile' driver is not Simple-Feature compliant (it
> >>>>> #    pre-dates it), so the failure occurs by seeing the second exterior
> >>>>> #    ring
> >>>>> #    as an interior ring
> >>>>>
> >>>>>   fn <- tempfile()
> >>>>>   writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
> >>>>>   SPDF2 <- readOGR(dsn=fn, layer='test')
> >>>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
> >>>>>   rgeos::writeWKT(SPDF2)
> >>>>>   st_as_text(st_geometry(st_as_sf(SPDF2)))
> >>>>>
> >>>>>   # This happens with sf too, using the same GDAL driver:
> >>>>>
> >>>>>   sf2 <- st_read(dsn=fn, layer='test')
> >>>>>   st_geometry(sf2)
> >>>>>   library(sf)
> >>>>>   st_as_text(st_geometry(st_as_sf(sf2)))
> >>>>>   rgeos::writeWKT(as(sf2, "Spatial"))
> >>>>>
> >>>>>   # Adding the comment fix doesn't help:
> >>>>>
> >>>>>   comment(slot(SPDF, "polygons")[[1]])
> >>>>>   SPDF_c <- rgeos::createSPComment(SPDF)
> >>>>>   comment(slot(SPDF_c, "polygons")[[1]])
> >>>>>   writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
> >>>>>     verbose=TRUE)
> >>>>>
> >>>>> #    reports
> >>>>> #    Object initially classed as: wkbPolygon
> >>>>> #    SFS comments in Polygons objects
> >>>>> #    Object reclassed as: wkbMultiPolygon
> >>>>>
> >>>>>   SPDF2_c <- readOGR(dsn=fn, layer='test_c')
> >>>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot,
> >>>>>   "ringDir")
> >>>>>   rgeos::writeWKT(SPDF2_c)
> >>>>>   st_as_text(st_geometry(st_as_sf(SPDF2_c)))
> >>>>>
> >>>>>
> >>>>>
> >>>>>   # If the input object is written out with the GeoPackage driver:
> >>>>>
> >>>>>   fn1 <- tempfile(fileext=".gpkg")
> >>>>>   writeOGR(SPDF, fn1, layer="test", driver='GPKG')
> >>>>>   sf2a <- st_read(dsn=fn1,layer='test')
> >>>>>   st_coordinates(st_geometry(sf2a))
> >>>>>   SPDF2a <- readOGR(dsn=fn1)
> >>>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
> >>>>>   rgeos::writeWKT(SPDF2a)
> >>>>>   st_as_text(st_geometry(st_as_sf(SPDF2a)))
> >>>>>
> >>>>>   # the issue is resolved. If we separate the exterior rings:
> >>>>>
> >>>>>   r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
> >>>>>   Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
> >>>>>   SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
> >>>>>   data.frame(Example=c("Minimal")))
> >>>>>   fna <- tempfile()
> >>>>>   writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
> >>>>>   SPDF2_a <- readOGR(dsn=fna, layer='test')
> >>>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
> >>>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot,
> >>>>>   "ringDir")
> >>>>>   rgeos::writeWKT(SPDF2_a)
> >>>>>   st_as_text(st_geometry(st_as_sf(SPDF2_a)))
> >>>>>
> >>>>>   # we are OK as the two exterior rings do not touch.
> >>>>>
> >>>>>   # does using sf make a difference?
> >>>>>
> >>>>>   fn_s <- tempfile(fileext=".shp")
> >>>>>   st_write(st_as_sf(SPDF), dsn=fn_s)
> >>>>>   sf_in <- st_read(fn_s)
> >>>>>   st_as_text(st_geometry(st_as_sf(sf_in)))
> >>>>>
> >>>>>   # No
> >>>>>
> >>>>>   fn_s <- tempfile(fileext=".shp")
> >>>>>   st_write(st_as_sf(SPDF_c), dsn=fn_s)
> >>>>>   sf_in_c <- st_read(fn_s)
> >>>>>   st_as_text(st_geometry(st_as_sf(sf_in_c)))
> >>>>>
> >>>>>   # nor with the pretend-SF-compliant comment set either.
> >>>>>
> >>>>>   So the weakness is in the "ESRI Shapefile" write driver, or possibly in
> >>>>>   the OGRGeometryFactory::organizePolygons() function in GDAL used in
> >>>>>   OGR_write() (a C++ function) called by writeOGR(). If sf::st_write()
> >>>>>   also
> >>>>>   calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that
> >>>>>   it
> >>>>>   has a weakness for the "ESRI Shapefile" driver, but which does not
> >>>>>   affect
> >>>>>   SF-compliant drivers.
> >>>>
> >>>>  Without the comment set, OGRGeometryFactory::organizePolygons() is used;
> >>>>  with it set, OGRGeometryFactory::organizePolygons() is not used, because
> >>>>  the object is declared as two exterior rings. In both cases, we have the
> >>>>  output object written out and read back in incorrectly with the ESRI
> >>>>  shapefile driver, but SF-compliant drivers round-trip (in the test
> >>>>  GeoJSON), correctly.
> >>>>
> >>>>  It is likely that the changes made in 2015 to accommodate GeoJSON led to
> >>>>  this possible regression for the ESRI Shapefile driver. I'm adding this
> >>>>  geometry to tests/tripup.R and data files; without code changes the hole
> >>>>  slot is wrong and the ring direction is changes to match, so the
> >>>>  coordinates change too.
> >>>>
> >>>>  Reading using the deprecated maptools::readShapeSpatial() also gets a hole
> >>>>  in the second external ring. However, writing with deprecated
> >>>> maptools::  writeSpatialShape() yields a shapefile that when read with
> >>>> maptools::  readShapeSpatial() gives the correct two exterior ring, no hole
> >>>>  object. When read with sf::st_read() and rgdal::readOGR(), the object is
> >>>>  also correct. So the problem definitely lies in rgdal::writeOGR(), and
> >>>>  sf::st_write() - roundtripping with sf::st_write() and sf::st_read()
> >>>>  degrades from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.
> >>>>
> >>>>  Roger
> >>>>
> >>>>>
> >>>>>   This is probably related to a similar but inverse problem with the
> >>>>>   SF-compliant GeoJSON driver in 2015:
> >>>>>
> >>>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
> >>>>>
> >>>>>   continued the next month in:
> >>>>>
> >>>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
> >>>>>
> >>>>>   The details are in this SVN diff
> >>>>>
> >>>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
> >>>>>
> >>>>>   up to the end og the list thread, and this one from then until now:
> >>>>>
> >>>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
> >>>>>
> >>>>>   Summary: could you change drivers, or is it really necessary to fix an
> >>>>>   EOL
> >>>>>   problem? What is your use case?
> >>>>>
> >>>>>>
> >>>>>>    Thanks in advance for your time,
> >>>>>
> >>>>>   Thanks for a complete example,
> >>>>>
> >>>>>   Roger
> >>>>>
> >>>>>>    Phil
> >>>>>>
> >>>>>>>    sessionInfo()
> >>>>>>    R version 3.5.1 (2018-07-02)
> >>>>>>    Platform: x86_64-w64-mingw32/x64 (64-bit)
> >>>>>>    Running under: Windows >= 8 x64 (build 9200)
> >>>>>>
> >>>>>>    Matrix products: default
> >>>>>>
> >>>>>>    locale:
> >>>>>>    [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
> >>>>>>    Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
> >>>>>>                            LC_TIME=English_United Kingdom.1252
> >>>>>>
> >>>>>>    attached base packages:
> >>>>>>    [1] stats     graphics  grDevices utils     datasets  methods   base
> >>>>>>
> >>>>>>    other attached packages:
> >>>>>>    [1] rgdal_1.4-4 sp_1.3-1
> >>>>>>
> >>>>>>    loaded via a namespace (and not attached):
> >>>>>>    [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
> >>>>>>    lattice_0.20-35
> >>>>>>
> >>>>>>    _______________________________________________
> >>>>>>    R-sig-Geo mailing list
> >>>>>>    R-sig-Geo at r-project.org
> >>>>>>    https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>>>>>
> >>>>>
> >>>>>
> >>>>
> >>>>
> >>>
> >>>
> >>
> >> --
> >> Roger Bivand
> >> Department of Economics, Norwegian School of Economics,
> >> Helleveien 30, N-5045 Bergen, Norway.
> >> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> >> https://orcid.org/0000-0003-2392-6140
> >> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
> >
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From Roger@B|v@nd @end|ng |rom nhh@no  Tue Aug 20 11:55:00 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Tue, 20 Aug 2019 11:55:00 +0200
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <CACPnO4cfFKo_zrXO+5AZyA+A7tnJCr2vAZMzJ1uE=PpAG7ZzuQ@mail.gmail.com>
References: <CACPnO4fPfsSr2SVUdF1NgO5OzWj5P0X5_v2LakqhQpp-m-u_Uw@mail.gmail.com>
 <alpine.LFD.2.21.1908161245540.3526@reclus.nhh.no>
 <alpine.LFD.2.21.1908162055280.25375@reclus.nhh.no>
 <alpine.LFD.2.21.1908171104350.9677@reclus.nhh.no>
 <alpine.LFD.2.21.1908181432250.29427@reclus.nhh.no>
 <CACPnO4drr=d==6X0=OUfNSW69-JVXs73Ew7_3_sf-uL6muqs8g@mail.gmail.com>
 <alpine.LFD.2.21.1908191626330.2757@reclus.nhh.no>
 <CACPnO4cfFKo_zrXO+5AZyA+A7tnJCr2vAZMzJ1uE=PpAG7ZzuQ@mail.gmail.com>
Message-ID: <alpine.LFD.2.21.1908201154410.12186@reclus.nhh.no>

Good, thanks very much!

Roger

On Mon, 19 Aug 2019, Phil Haines wrote:

> Hi Roger,
>
> I have added an example to https://github.com/ateucher/rmapshaper/issues/89
>
> Hopefully it illustrates the behaviour I was seeing from
> rmapshaper::ms_simplify() but please let me know if not.
>
> And thanks for the nudge towards GPKG, I will investigate.
> Phil
>
> On Mon, 19 Aug 2019 at 15:48, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>
>> Hi Phil,
>>
>> On Sun, 18 Aug 2019, Phil Haines wrote:
>>
>>> Hi Roger,
>>>
>>> I originally encountered this issue while trying to reduce the size of
>>> German postal code boundaries. I used rmapshaper::ms_simplify() which
>>> introduced the polygons sharing a common edge. I definitely didn't
>>> need them to be separate polygons, and would happily have merged them
>>> had I been more familiar with gUnaryUnion().
>>
>> If the German postal code boundaries are open, could you please put (an
>> affected subset) on an URL, and provide a short script to replicate the
>> workflow. Then we can engage with the rmapshaper maintainer, and see
>> whether the underlying problem in the workflow is in the js library or its
>> R wrapper. I've opened: https://github.com/ateucher/rmapshaper/issues/89.
>>
>>>
>>> I apologise if my question has resulted in unnecessary effort on your
>>> part. I reported the behaviour because I found it surprising. However,
>>> I now understand that this example is not a valid simple feature
>>> geometry and that the solution is to take steps to ensure I have valid
>>> geometries, and to repair if not.
>>>
>>
>> No need to apologise!! Your reproducible example was excellent, without it
>> you wouldn't have contributed to getting the internal shapelib code
>> changed to make it less restrictive in future releases of GDAL,
>> potentially benefitting lots of users (who really should drop ESRI
>> shapefiles, and/or should check geometries for validity, but ... whose
>> work you've helped save). By the way, ESRI would be very happy if
>> shapefiles stopped being produced in current workflows, and that new files
>> should rather be GPKG.
>>
>>> Additionally I must confess that I only use the ESRI Shapefile driver
>>> because I don't know any better... My use cases are reading and
>>> writing from R (usually to produce maps) and occasionally opening in
>>> QGIS. I can happily switch to any format that supports this workflow.
>>>
>>
>> GPKG is now very broadly supported, is SF-compliant, and has the big
>> user-facing benefits of not having field name length restrictions, and
>> many fewer encoding issues for field names and string values.
>>
>> Best wishes,
>>
>> Roger
>>
>>> Thank you very much for your time,
>>> Phil
>>>
>>> On Sun, 18 Aug 2019 at 13:59, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>>>
>>>> The reason that the problem occurred is that a MULTIPOLYGON with two
>>>> exterior rings becomes invalid if the exterior rings touch along an edge
>>>> (this case). It is important to know the use case, to see whether:
>>>>
>>>> library(rgeos)
>>>> writeWKT(Ps1)
>>>> gIsValid(Ps1, reason=TRUE)
>>>> Ps1a <- gUnaryUnion(gBuffer(Ps1, width=0))
>>>> gIsValid(Ps1a, reason=TRUE)
>>>> writeWKT(Ps1a)
>>>>
>>>> or equivalently in sf for sf objects, should be applied before trying to
>>>> write the object out to file with this driver.
>>>>
>>>> However, because drivers that are compliant with the simple features
>>>> standard (which bans exterior rings sharing edges) have been permissive
>>>> and do round-trip this invalid object, a relaxation in the OGR ESRI
>>>> shapefile driver has been provided and may be included in a future
>>>> release.
>>>>
>>>> We need to know (see these issues):
>>>>
>>>> https://github.com/r-spatial/sf/issues/1130
>>>> https://github.com/OSGeo/gdal/issues/1787
>>>>
>>>> why it was desirable to write out this object using this driver? Could an
>>>> alternative driver have been used, or is ESRI shapefile the only format
>>>> used in the workflow?
>>>>
>>>> If it has to be this driver, could the workflow be changed to repair
>>>> degenerate cases before writing? If using sp classes, rgeos may be used to
>>>> test for and probably repair such geometries before they reach
>>>> rgdal::writeOGR() for this driver. Adding code to sf and rgdal to trap
>>>> degenerate cases does encumber all users with valid geometries with
>>>> the time wasted on extra checking, so building checks into sf and rgdal is
>>>> not desirable.
>>>>
>>>> I hope it is possible to find out more about the use case quickly, to pass
>>>> on to GDAL developers to help motivate a relaxation in their current
>>>> policy with regard to this driver, and to encourage them to include the
>>>> fix branch in a future release of GDAL.
>>>>
>>>> Roger
>>>>
>>>> On Sat, 17 Aug 2019, Roger Bivand wrote:
>>>>
>>>>> Please follow up both here and on:
>>>>>
>>>>> https://github.com/r-spatial/sf/issues/1130
>>>>>
>>>>> as the problem is also seen in the sf package using the same GDAL ESRI
>>>>> Shapefile driver.
>>>>>
>>>>> Roger
>>>>>
>>>>> On Fri, 16 Aug 2019, Roger Bivand wrote:
>>>>>
>>>>>>  On Fri, 16 Aug 2019, Roger Bivand wrote:
>>>>>>
>>>>>>>   On Tue, 13 Aug 2019, Phil Haines wrote:
>>>>>>>
>>>>>>>>    Dear list,
>>>>>>>>
>>>>>>>>    I have a single Polygons object containing multiple Polygon objects
>>>>>>>>    that share a common border. When I output this using writeOGR() one of
>>>>>>>>    the Polygon objects becomes a hole, as the following example shows.
>>>>>>>>
>>>>>>>>    Create a Polygons object containing two adjoining Polygon objects
>>>>>>>>>    library(rgdal)
>>>>>>>>>    r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>>>>>>    r2 <- r1; r2[,1] <- r2[,1]+1
>>>>>>>>>    Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>>>>>>    SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>>>>>>    data.frame(Example=c("Minimal")))
>>>>>>>>
>>>>>>>>    Perform a write/readOGR() cycle
>>>>>>>>>    fn <- tempfile()
>>>>>>>>>    writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>>>>>>    SPDF2 <- readOGR(dsn=fn,layer='test')
>>>>>>>>
>>>>>>>>    Second Polygon object is now a hole
>>>>>>>>>    sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
>>>>>>>>    [1] FALSE  TRUE
>>>>>>>>
>>>>>>>>    I see from the sp documentation that "Polygon objects belonging to a
>>>>>>>>    Polygons object should either not overlap one-other, or should be
>>>>>>>>    fully included" but I am not sure how this relates to bordering
>>>>>>>>    Polygon objects. I would welcome any advice as to whether what I am
>>>>>>>>    asking of writeOGR is reasonable?
>>>>>>>
>>>>>>>   The problem is with the 'ESRI Shapefile' representation and driver:
>>>>>>>
>>>>>>>   library(rgdal)
>>>>>>>   r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>>>>   r2 <- r1; r2[,1] <- r2[,1]+1
>>>>>>>   Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>>>>   SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>>>>   data.frame(Example=c("Minimal")))
>>>>>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>   sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>>>
>>>>>>>   # which constructs a MULTIPOLYGON object:
>>>>>>>
>>>>>>>   rgeos::writeWKT(SPDF)
>>>>>>>   library(sf)
>>>>>>>   st_as_text(st_geometry(st_as_sf(SPDF)))
>>>>>>>
>>>>>>> #    The 'ESRI Shapefile' driver is not Simple-Feature compliant (it
>>>>>>> #    pre-dates it), so the failure occurs by seeing the second exterior
>>>>>>> #    ring
>>>>>>> #    as an interior ring
>>>>>>>
>>>>>>>   fn <- tempfile()
>>>>>>>   writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>>>>   SPDF2 <- readOGR(dsn=fn, layer='test')
>>>>>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>   sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>>>   rgeos::writeWKT(SPDF2)
>>>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2)))
>>>>>>>
>>>>>>>   # This happens with sf too, using the same GDAL driver:
>>>>>>>
>>>>>>>   sf2 <- st_read(dsn=fn, layer='test')
>>>>>>>   st_geometry(sf2)
>>>>>>>   library(sf)
>>>>>>>   st_as_text(st_geometry(st_as_sf(sf2)))
>>>>>>>   rgeos::writeWKT(as(sf2, "Spatial"))
>>>>>>>
>>>>>>>   # Adding the comment fix doesn't help:
>>>>>>>
>>>>>>>   comment(slot(SPDF, "polygons")[[1]])
>>>>>>>   SPDF_c <- rgeos::createSPComment(SPDF)
>>>>>>>   comment(slot(SPDF_c, "polygons")[[1]])
>>>>>>>   writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
>>>>>>>     verbose=TRUE)
>>>>>>>
>>>>>>> #    reports
>>>>>>> #    Object initially classed as: wkbPolygon
>>>>>>> #    SFS comments in Polygons objects
>>>>>>> #    Object reclassed as: wkbMultiPolygon
>>>>>>>
>>>>>>>   SPDF2_c <- readOGR(dsn=fn, layer='test_c')
>>>>>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>   sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot,
>>>>>>>   "ringDir")
>>>>>>>   rgeos::writeWKT(SPDF2_c)
>>>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2_c)))
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>   # If the input object is written out with the GeoPackage driver:
>>>>>>>
>>>>>>>   fn1 <- tempfile(fileext=".gpkg")
>>>>>>>   writeOGR(SPDF, fn1, layer="test", driver='GPKG')
>>>>>>>   sf2a <- st_read(dsn=fn1,layer='test')
>>>>>>>   st_coordinates(st_geometry(sf2a))
>>>>>>>   SPDF2a <- readOGR(dsn=fn1)
>>>>>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>   sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>>>   rgeos::writeWKT(SPDF2a)
>>>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2a)))
>>>>>>>
>>>>>>>   # the issue is resolved. If we separate the exterior rings:
>>>>>>>
>>>>>>>   r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
>>>>>>>   Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
>>>>>>>   SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
>>>>>>>   data.frame(Example=c("Minimal")))
>>>>>>>   fna <- tempfile()
>>>>>>>   writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
>>>>>>>   SPDF2_a <- readOGR(dsn=fna, layer='test')
>>>>>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>   sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot,
>>>>>>>   "ringDir")
>>>>>>>   rgeos::writeWKT(SPDF2_a)
>>>>>>>   st_as_text(st_geometry(st_as_sf(SPDF2_a)))
>>>>>>>
>>>>>>>   # we are OK as the two exterior rings do not touch.
>>>>>>>
>>>>>>>   # does using sf make a difference?
>>>>>>>
>>>>>>>   fn_s <- tempfile(fileext=".shp")
>>>>>>>   st_write(st_as_sf(SPDF), dsn=fn_s)
>>>>>>>   sf_in <- st_read(fn_s)
>>>>>>>   st_as_text(st_geometry(st_as_sf(sf_in)))
>>>>>>>
>>>>>>>   # No
>>>>>>>
>>>>>>>   fn_s <- tempfile(fileext=".shp")
>>>>>>>   st_write(st_as_sf(SPDF_c), dsn=fn_s)
>>>>>>>   sf_in_c <- st_read(fn_s)
>>>>>>>   st_as_text(st_geometry(st_as_sf(sf_in_c)))
>>>>>>>
>>>>>>>   # nor with the pretend-SF-compliant comment set either.
>>>>>>>
>>>>>>>   So the weakness is in the "ESRI Shapefile" write driver, or possibly in
>>>>>>>   the OGRGeometryFactory::organizePolygons() function in GDAL used in
>>>>>>>   OGR_write() (a C++ function) called by writeOGR(). If sf::st_write()
>>>>>>>   also
>>>>>>>   calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that
>>>>>>>   it
>>>>>>>   has a weakness for the "ESRI Shapefile" driver, but which does not
>>>>>>>   affect
>>>>>>>   SF-compliant drivers.
>>>>>>
>>>>>>  Without the comment set, OGRGeometryFactory::organizePolygons() is used;
>>>>>>  with it set, OGRGeometryFactory::organizePolygons() is not used, because
>>>>>>  the object is declared as two exterior rings. In both cases, we have the
>>>>>>  output object written out and read back in incorrectly with the ESRI
>>>>>>  shapefile driver, but SF-compliant drivers round-trip (in the test
>>>>>>  GeoJSON), correctly.
>>>>>>
>>>>>>  It is likely that the changes made in 2015 to accommodate GeoJSON led to
>>>>>>  this possible regression for the ESRI Shapefile driver. I'm adding this
>>>>>>  geometry to tests/tripup.R and data files; without code changes the hole
>>>>>>  slot is wrong and the ring direction is changes to match, so the
>>>>>>  coordinates change too.
>>>>>>
>>>>>>  Reading using the deprecated maptools::readShapeSpatial() also gets a hole
>>>>>>  in the second external ring. However, writing with deprecated
>>>>>> maptools::  writeSpatialShape() yields a shapefile that when read with
>>>>>> maptools::  readShapeSpatial() gives the correct two exterior ring, no hole
>>>>>>  object. When read with sf::st_read() and rgdal::readOGR(), the object is
>>>>>>  also correct. So the problem definitely lies in rgdal::writeOGR(), and
>>>>>>  sf::st_write() - roundtripping with sf::st_write() and sf::st_read()
>>>>>>  degrades from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.
>>>>>>
>>>>>>  Roger
>>>>>>
>>>>>>>
>>>>>>>   This is probably related to a similar but inverse problem with the
>>>>>>>   SF-compliant GeoJSON driver in 2015:
>>>>>>>
>>>>>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
>>>>>>>
>>>>>>>   continued the next month in:
>>>>>>>
>>>>>>>   https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
>>>>>>>
>>>>>>>   The details are in this SVN diff
>>>>>>>
>>>>>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
>>>>>>>
>>>>>>>   up to the end og the list thread, and this one from then until now:
>>>>>>>
>>>>>>>   https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
>>>>>>>
>>>>>>>   Summary: could you change drivers, or is it really necessary to fix an
>>>>>>>   EOL
>>>>>>>   problem? What is your use case?
>>>>>>>
>>>>>>>>
>>>>>>>>    Thanks in advance for your time,
>>>>>>>
>>>>>>>   Thanks for a complete example,
>>>>>>>
>>>>>>>   Roger
>>>>>>>
>>>>>>>>    Phil
>>>>>>>>
>>>>>>>>>    sessionInfo()
>>>>>>>>    R version 3.5.1 (2018-07-02)
>>>>>>>>    Platform: x86_64-w64-mingw32/x64 (64-bit)
>>>>>>>>    Running under: Windows >= 8 x64 (build 9200)
>>>>>>>>
>>>>>>>>    Matrix products: default
>>>>>>>>
>>>>>>>>    locale:
>>>>>>>>    [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
>>>>>>>>    Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
>>>>>>>>                            LC_TIME=English_United Kingdom.1252
>>>>>>>>
>>>>>>>>    attached base packages:
>>>>>>>>    [1] stats     graphics  grDevices utils     datasets  methods   base
>>>>>>>>
>>>>>>>>    other attached packages:
>>>>>>>>    [1] rgdal_1.4-4 sp_1.3-1
>>>>>>>>
>>>>>>>>    loaded via a namespace (and not attached):
>>>>>>>>    [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
>>>>>>>>    lattice_0.20-35
>>>>>>>>
>>>>>>>>    _______________________________________________
>>>>>>>>    R-sig-Geo mailing list
>>>>>>>>    R-sig-Geo at r-project.org
>>>>>>>>    https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>
>>>>>>
>>>>>
>>>>>
>>>>
>>>> --
>>>> Roger Bivand
>>>> Department of Economics, Norwegian School of Economics,
>>>> Helleveien 30, N-5045 Bergen, Norway.
>>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>>>> https://orcid.org/0000-0003-2392-6140
>>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>>>
>>
>> --
>> Roger Bivand
>> Department of Economics, Norwegian School of Economics,
>> Helleveien 30, N-5045 Bergen, Norway.
>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>> https://orcid.org/0000-0003-2392-6140
>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br  Tue Aug 20 15:12:51 2019
From: @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br (ASANTOS)
Date: Tue, 20 Aug 2019 09:12:51 -0400
Subject: [R-sig-Geo] Rasterize point process using specific rule
Message-ID: <12a6aab0-13e6-53d5-83c8-3cf9ab95fe51@yahoo.com.br>

Dear members,

I've like to create a raster using my event coordinates and information 
about the size in this coordinates as a rule for my raster creation. 
First, I make:

library(raster)
library(spatstat)

#Points coordinates in UTM
xp<-c(371278.588,371250.722,371272.618,371328.421,371349.974,
371311.95,371296.265,371406.46,371411.551,371329.041,371338.081,
371334.182,371333.756,371299.818,371254.374,371193.673,371172.836,
371173.803,371153.73,371165.051,371140.417,371168.279,371166.367,
371180.575,371132.664,371129.791,371232.919,371208.502,371289.462,
371207.595,371219.008,371139.921,371133.215,371061.467,371053.69,
371099.897,371108.782,371112.52,371114.241,371176.236,371159.185,
371159.291,371158.552,370978.252,371120.03,371116.993)

yp<-c(8246507.94,8246493.176,8246465.974,8246464.413,8246403.465,
8246386.098,8246432.144,8246394.827,8246366.201,8246337.626,
8246311.125,8246300.039,8246299.594,8246298.072,8246379.351,
8246431.998,8246423.913,8246423.476,8246431.658,8246418.226,
8246400.161,8246396.891,8246394.225,8246400.391,8246370.244,
8246367.019,8246311.075,8246255.174,8246255.085,8246226.514,
8246215.847,8246337.316,8246330.197,8246311.197,8246304.183,
8246239.282,8246239.887,8246241.678,8246240.361,8246167.364,
8246171.581,8246171.803,8246169.807,8246293.57,8246183.194,8246189.926)

#Now I have the size of each nest in meters (marked process)

area<-c(117,30,4,341,15,160,35,280,108,168,63,143,2,48,182,42,
88,56,27,156,288,45,49,234,72,270,91,40,304,56,35,4,56.7,9,4.6,
105,133,135,23.92,190,12.9,15.2,192.78,104,255,24)

# Make a contour for the window creation
W <- convexhull.xy(xp,yp)

#Create ppm object
syn.ppp <- ppp(x=xp,y=yp,window=W, marks=area)

# Plot the point process
plot(syn.ppp)

#Definition of raster resolution - 1 meter square
ext <- as(extent(c(W$xrange,W$yrange)), "SpatialPolygons")
syn.ras.res<-rasterToPoints(raster(ext, resolution = 1), spatial = TRUE)

#Now Rasterize
syn.ras<- rasterize(syn.ras.res at coords, raster(syn.ras.res), *?????*)

I' ve like to create some kind of rule in *?????*, where pixel values in 
my final raster was 1 when inside de area (marks=area) and zero for 
outside de circular area given by points coordinates 
(syn.ras.res at coords) using 1 meter as resolution?

Any ideas, please

Thanks,

-- 
======================================================================
Alexandre dos Santos
Prote??o Florestal
IFMT - Instituto Federal de Educa??o, Ci?ncia e Tecnologia de Mato Grosso
Campus C?ceres
Caixa Postal 244
Avenida dos Ramires, s/n
Bairro: Distrito Industrial
C?ceres - MT                      CEP: 78.200-000
Fone: (+55) 65 99686-6970 (VIVO) (+55) 65 3221-2674 (FIXO)

         alexandre.santos at cas.ifmt.edu.br
Lattes: http://lattes.cnpq.br/1360403201088680
OrcID: orcid.org/0000-0001-8232-6722
Researchgate: www.researchgate.net/profile/Alexandre_Santos10
LinkedIn: br.linkedin.com/in/alexandre-dos-santos-87961635
Mendeley:www.mendeley.com/profiles/alexandre-dos-santos6/
======================================================================


	[[alternative HTML version deleted]]


From webbe @end|ng |rom u||@edu  Tue Aug 20 15:46:01 2019
From: webbe @end|ng |rom u||@edu (Elizabeth Webb)
Date: Tue, 20 Aug 2019 13:46:01 +0000
Subject: [R-sig-Geo] spatial autocorrelation in GAM residuals for large data
 set
Message-ID: <1566308761662.30499@ufl.edu>

Hello,

I have a large data set (~100k rows) containing observations at points (MODIS?pixels) across the northern hemisphere. ?I have created a GAM using the bam command in mgcv and I would like to check the model residuals for spatial autocorrelation. ?

One idea is to use the DHARMa package (https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#spatial-autocorrelation). ?The code looks something like this:

????simulationOutput ?<- ? simulateResiduals(fittedModel = mymodel) # point at which R runs into memory problems
????testSpatialAutocorrelation(simulationOutput = simulationOutput, x =  data$latitude, y= data$longitude)

However, this runs into memory problems.? 

Another idea is to use the following code, after this tutorial (http://www.flutterbys.com.au/stats/tut/tut8.4a.html):
????library(ape)
?? ?library(fields)
????coords = cbind(data$longitude, data$latitude) ????
    w = rdist(coords)  # point at which R runs into memory problems
????Moran.I(x = residuals(mymodel), w = w)

But this also runs into memory problems. ?I have tried increasing the amount of memory allotted to R, but that just means R works for longer before timing out. ?

So, two questions: (1) Is there a memory efficient way to check for spatial autocorrelation using Moran's I in large data sets? or (2) Is there another way to check for spatial autocorrelation (besides Moran's I) that won't have such memory problems?

Thanks in advance,

Elizabeth







   

From b|@|ev||@t @end|ng |rom gm@||@com  Tue Aug 20 17:26:39 2019
From: b|@|ev||@t @end|ng |rom gm@||@com (=?UTF-8?Q?Bede-Fazekas_=c3=81kos?=)
Date: Tue, 20 Aug 2019 17:26:39 +0200
Subject: [R-sig-Geo] Rasterize point process using specific rule
In-Reply-To: <12a6aab0-13e6-53d5-83c8-3cf9ab95fe51@yahoo.com.br>
References: <12a6aab0-13e6-53d5-83c8-3cf9ab95fe51@yahoo.com.br>
Message-ID: <0d673761-0998-a18d-baa7-2d5978fbb541@gmail.com>

Dear Alexandre,
I'm not familiar with point processes, but as far as I understand the 
task well, it can be easily solved using sp+raster or sf+raster.

library(sf)
library(raster)
points_sf <- st_as_sf(data.frame(xp, yp, area), coords = c("xp", "yp"), 
crs = 32629)
circles_sf <- st_buffer(x = points, dist = sqrt(points_sf$area / pi)) # 
if it is really the area, or dist = points_sf$area if it is the radius
empty_raster <- raster(points_sf, resolution = 1)
filled_raster <- rasterize(x = circles_sf, y = empty_raster, field = 1, 
fun = function(x, na.rm) 1, background = 0)
plot(filled_raster)

HTH,
?kos Bede-Fazekas
Hungarian Academy of Sciences


2019.08.20. 15:12 keltez?ssel, ASANTOS via R-sig-Geo ?rta:
> Dear members,
>
> I've like to create a raster using my event coordinates and information
> about the size in this coordinates as a rule for my raster creation.
> First, I make:
>
> library(raster)
> library(spatstat)
>
> #Points coordinates in UTM
> xp<-c(371278.588,371250.722,371272.618,371328.421,371349.974,
> 371311.95,371296.265,371406.46,371411.551,371329.041,371338.081,
> 371334.182,371333.756,371299.818,371254.374,371193.673,371172.836,
> 371173.803,371153.73,371165.051,371140.417,371168.279,371166.367,
> 371180.575,371132.664,371129.791,371232.919,371208.502,371289.462,
> 371207.595,371219.008,371139.921,371133.215,371061.467,371053.69,
> 371099.897,371108.782,371112.52,371114.241,371176.236,371159.185,
> 371159.291,371158.552,370978.252,371120.03,371116.993)
>
> yp<-c(8246507.94,8246493.176,8246465.974,8246464.413,8246403.465,
> 8246386.098,8246432.144,8246394.827,8246366.201,8246337.626,
> 8246311.125,8246300.039,8246299.594,8246298.072,8246379.351,
> 8246431.998,8246423.913,8246423.476,8246431.658,8246418.226,
> 8246400.161,8246396.891,8246394.225,8246400.391,8246370.244,
> 8246367.019,8246311.075,8246255.174,8246255.085,8246226.514,
> 8246215.847,8246337.316,8246330.197,8246311.197,8246304.183,
> 8246239.282,8246239.887,8246241.678,8246240.361,8246167.364,
> 8246171.581,8246171.803,8246169.807,8246293.57,8246183.194,8246189.926)
>
> #Now I have the size of each nest in meters (marked process)
>
> area<-c(117,30,4,341,15,160,35,280,108,168,63,143,2,48,182,42,
> 88,56,27,156,288,45,49,234,72,270,91,40,304,56,35,4,56.7,9,4.6,
> 105,133,135,23.92,190,12.9,15.2,192.78,104,255,24)
>
> # Make a contour for the window creation
> W <- convexhull.xy(xp,yp)
>
> #Create ppm object
> syn.ppp <- ppp(x=xp,y=yp,window=W, marks=area)
>
> # Plot the point process
> plot(syn.ppp)
>
> #Definition of raster resolution - 1 meter square
> ext <- as(extent(c(W$xrange,W$yrange)), "SpatialPolygons")
> syn.ras.res<-rasterToPoints(raster(ext, resolution = 1), spatial = TRUE)
>
> #Now Rasterize
> syn.ras<- rasterize(syn.ras.res at coords, raster(syn.ras.res), *?????*)
>
> I' ve like to create some kind of rule in *?????*, where pixel values in
> my final raster was 1 when inside de area (marks=area) and zero for
> outside de circular area given by points coordinates
> (syn.ras.res at coords) using 1 meter as resolution?
>
> Any ideas, please
>
> Thanks,
>


From Roger@B|v@nd @end|ng |rom nhh@no  Tue Aug 20 22:43:08 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Tue, 20 Aug 2019 22:43:08 +0200
Subject: [R-sig-Geo] 
 spatial autocorrelation in GAM residuals for large data set
In-Reply-To: <1566308761662.30499@ufl.edu>
References: <1566308761662.30499@ufl.edu>
Message-ID: <alpine.LFD.2.21.1908202222170.16978@reclus.nhh.no>

On Tue, 20 Aug 2019, Elizabeth Webb wrote:

> Hello,
>
> I have a large data set (~100k rows) containing observations at points 
> (MODIS pixels) across the northern hemisphere.  I have created a GAM 
> using the bam command in mgcv and I would like to check the model 
> residuals for spatial autocorrelation.
>
> One idea is to use the DHARMa package 
> (https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#spatial-autocorrelation). 
> The code looks something like this:
>
> ????simulationOutput ?<- ? simulateResiduals(fittedModel = mymodel) # point at which R runs into memory problems
> ????testSpatialAutocorrelation(simulationOutput = simulationOutput, x =  data$latitude, y= data$longitude)
>
> However, this runs into memory problems.
>
> Another idea is to use the following code, after this tutorial 
> (http://www.flutterbys.com.au/stats/tut/tut8.4a.html):
> ????library(ape)
> ?? ?library(fields)
> ????coords = cbind(data$longitude, data$latitude) ????
>    w = rdist(coords)  # point at which R runs into memory problems
> ????Moran.I(x = residuals(mymodel), w = w)
>
> But this also runs into memory problems.  I have tried increasing the 
> amount of memory allotted to R, but that just means R works for longer 
> before timing out.

I do hope that you read

https://cran.r-project.org/web/packages/ape/vignettes/MoranI.pdf

first, because the approach used in ape has been revised.

The main problem is that ape uses by default a square matrix, and it is 
uncertain whether sparse matrices are accepted. This means that completely 
unneeded computations are carried out - dense matrices should never be 
used unless there is a convincing scientific argument (see 
https://edzer.github.io/UseR2019/part2.html#exercise-review-1 for a 
development on why distances are wasteful when edge counts on a graph do 
the same thing sparsely).

Use one of the approaches described in the tutorial and you may be OK, but 
you should not trust the outcome of Moran's I on residuals without using 
an appropriate variant. Say you can represent your GAM with a linear model 
with say spline terms, you can use Moran's I for regression residuals. 
Take care that the average number of neighbours is very small (6-10), and 
large numbers of observations should not be a problem.

A larger problem is that Moran's I (also for residuals) also responds to 
other mis-specifications than spatial autocorrelation, in particular 
missing variables and spatial processes with a different scale from the 
units of observation chosen.


>
> So, two questions: (1) Is there a memory efficient way to check for 
> spatial autocorrelation using Moran's I in large data sets? or (2) Is 
> there another way to check for spatial autocorrelation (besides Moran's 
> I) that won't have such memory problems?

1) Yes, see above, do not use dense matrices

2) Consider a higher level MRF term in your GAM for aggregates of your 
observations if such aggregation makes sense for your data.

Hope this clarifies,

Roger

>
> Thanks in advance,
>
> Elizabeth
>
>
>
>
>
>
>
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From @ndy@teucher @end|ng |rom gm@||@com  Wed Aug 21 01:06:12 2019
From: @ndy@teucher @end|ng |rom gm@||@com (Andy Teucher)
Date: Tue, 20 Aug 2019 16:06:12 -0700
Subject: [R-sig-Geo] 
 rgdal::writeOGR with driver='ESRI Shapefile' converts
 Polygon object into a hole
In-Reply-To: <mailman.27569.5.1566295521.14767.r-sig-geo@r-project.org>
References: <mailman.27569.5.1566295521.14767.r-sig-geo@r-project.org>
Message-ID: <D7F8EAB3-B8AC-44FA-8A56-9D239CAFEC2F@gmail.com>

Hi Phil and Roger,

To close the loop on this issue, I have confirmed that the mapshaper javascript library (which rmapshaper wraps) can produce invalid polygons (https://github.com/ateucher/rmapshaper/issues/89), and I will address this in a future release of rmapshaper (https://github.com/ateucher/rmapshaper/issues/90). I have also alerted the maintainer of mapshaper and he is going to add functionality to address this as well (https://github.com/mbloch/mapshaper/issues/352).

Thanks for the thorough investigation and bringing this to my attention!

Cheers,
Andy Teucher (rmapshaper package maintainer)

> Date: Tue, 20 Aug 2019 11:55:00 +0200
> From: Roger Bivand <Roger.Bivand at nhh.no>
> To: Phil Haines <phil.haines82 at gmail.com>
> Cc: <r-sig-geo at r-project.org>
> Subject: Re: [R-sig-Geo]  rgdal::writeOGR with driver='ESRI Shapefile'
> 	converts Polygon object into a hole
> Message-ID: <alpine.LFD.2.21.1908201154410.12186 at reclus.nhh.no>
> Content-Type: text/plain; charset="us-ascii"; Format="flowed"
> 
> Good, thanks very much!
> 
> Roger
> 
> On Mon, 19 Aug 2019, Phil Haines wrote:
> 
>> Hi Roger,
>> 
>> I have added an example to https://github.com/ateucher/rmapshaper/issues/89
>> 
>> Hopefully it illustrates the behaviour I was seeing from
>> rmapshaper::ms_simplify() but please let me know if not.
>> 
>> And thanks for the nudge towards GPKG, I will investigate.
>> Phil
>> 
>> On Mon, 19 Aug 2019 at 15:48, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>> 
>>> Hi Phil,
>>> 
>>> On Sun, 18 Aug 2019, Phil Haines wrote:
>>> 
>>>> Hi Roger,
>>>> 
>>>> I originally encountered this issue while trying to reduce the size of
>>>> German postal code boundaries. I used rmapshaper::ms_simplify() which
>>>> introduced the polygons sharing a common edge. I definitely didn't
>>>> need them to be separate polygons, and would happily have merged them
>>>> had I been more familiar with gUnaryUnion().
>>> 
>>> If the German postal code boundaries are open, could you please put (an
>>> affected subset) on an URL, and provide a short script to replicate the
>>> workflow. Then we can engage with the rmapshaper maintainer, and see
>>> whether the underlying problem in the workflow is in the js library or its
>>> R wrapper. I've opened: https://github.com/ateucher/rmapshaper/issues/89.
>>> 
>>>> 
>>>> I apologise if my question has resulted in unnecessary effort on your
>>>> part. I reported the behaviour because I found it surprising. However,
>>>> I now understand that this example is not a valid simple feature
>>>> geometry and that the solution is to take steps to ensure I have valid
>>>> geometries, and to repair if not.
>>>> 
>>> 
>>> No need to apologise!! Your reproducible example was excellent, without it
>>> you wouldn't have contributed to getting the internal shapelib code
>>> changed to make it less restrictive in future releases of GDAL,
>>> potentially benefitting lots of users (who really should drop ESRI
>>> shapefiles, and/or should check geometries for validity, but ... whose
>>> work you've helped save). By the way, ESRI would be very happy if
>>> shapefiles stopped being produced in current workflows, and that new files
>>> should rather be GPKG.
>>> 
>>>> Additionally I must confess that I only use the ESRI Shapefile driver
>>>> because I don't know any better... My use cases are reading and
>>>> writing from R (usually to produce maps) and occasionally opening in
>>>> QGIS. I can happily switch to any format that supports this workflow.
>>>> 
>>> 
>>> GPKG is now very broadly supported, is SF-compliant, and has the big
>>> user-facing benefits of not having field name length restrictions, and
>>> many fewer encoding issues for field names and string values.
>>> 
>>> Best wishes,
>>> 
>>> Roger
>>> 
>>>> Thank you very much for your time,
>>>> Phil
>>>> 
>>>> On Sun, 18 Aug 2019 at 13:59, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>>>> 
>>>>> The reason that the problem occurred is that a MULTIPOLYGON with two
>>>>> exterior rings becomes invalid if the exterior rings touch along an edge
>>>>> (this case). It is important to know the use case, to see whether:
>>>>> 
>>>>> library(rgeos)
>>>>> writeWKT(Ps1)
>>>>> gIsValid(Ps1, reason=TRUE)
>>>>> Ps1a <- gUnaryUnion(gBuffer(Ps1, width=0))
>>>>> gIsValid(Ps1a, reason=TRUE)
>>>>> writeWKT(Ps1a)
>>>>> 
>>>>> or equivalently in sf for sf objects, should be applied before trying to
>>>>> write the object out to file with this driver.
>>>>> 
>>>>> However, because drivers that are compliant with the simple features
>>>>> standard (which bans exterior rings sharing edges) have been permissive
>>>>> and do round-trip this invalid object, a relaxation in the OGR ESRI
>>>>> shapefile driver has been provided and may be included in a future
>>>>> release.
>>>>> 
>>>>> We need to know (see these issues):
>>>>> 
>>>>> https://github.com/r-spatial/sf/issues/1130
>>>>> https://github.com/OSGeo/gdal/issues/1787
>>>>> 
>>>>> why it was desirable to write out this object using this driver? Could an
>>>>> alternative driver have been used, or is ESRI shapefile the only format
>>>>> used in the workflow?
>>>>> 
>>>>> If it has to be this driver, could the workflow be changed to repair
>>>>> degenerate cases before writing? If using sp classes, rgeos may be used to
>>>>> test for and probably repair such geometries before they reach
>>>>> rgdal::writeOGR() for this driver. Adding code to sf and rgdal to trap
>>>>> degenerate cases does encumber all users with valid geometries with
>>>>> the time wasted on extra checking, so building checks into sf and rgdal is
>>>>> not desirable.
>>>>> 
>>>>> I hope it is possible to find out more about the use case quickly, to pass
>>>>> on to GDAL developers to help motivate a relaxation in their current
>>>>> policy with regard to this driver, and to encourage them to include the
>>>>> fix branch in a future release of GDAL.
>>>>> 
>>>>> Roger
>>>>> 
>>>>> On Sat, 17 Aug 2019, Roger Bivand wrote:
>>>>> 
>>>>>> Please follow up both here and on:
>>>>>> 
>>>>>> https://github.com/r-spatial/sf/issues/1130
>>>>>> 
>>>>>> as the problem is also seen in the sf package using the same GDAL ESRI
>>>>>> Shapefile driver.
>>>>>> 
>>>>>> Roger
>>>>>> 
>>>>>> On Fri, 16 Aug 2019, Roger Bivand wrote:
>>>>>> 
>>>>>>> On Fri, 16 Aug 2019, Roger Bivand wrote:
>>>>>>> 
>>>>>>>>  On Tue, 13 Aug 2019, Phil Haines wrote:
>>>>>>>> 
>>>>>>>>>   Dear list,
>>>>>>>>> 
>>>>>>>>>   I have a single Polygons object containing multiple Polygon objects
>>>>>>>>>   that share a common border. When I output this using writeOGR() one of
>>>>>>>>>   the Polygon objects becomes a hole, as the following example shows.
>>>>>>>>> 
>>>>>>>>>   Create a Polygons object containing two adjoining Polygon objects
>>>>>>>>>>   library(rgdal)
>>>>>>>>>>   r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>>>>>>>   r2 <- r1; r2[,1] <- r2[,1]+1
>>>>>>>>>>   Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>>>>>>>   SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>>>>>>>   data.frame(Example=c("Minimal")))
>>>>>>>>> 
>>>>>>>>>   Perform a write/readOGR() cycle
>>>>>>>>>>   fn <- tempfile()
>>>>>>>>>>   writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>>>>>>>   SPDF2 <- readOGR(dsn=fn,layer='test')
>>>>>>>>> 
>>>>>>>>>   Second Polygon object is now a hole
>>>>>>>>>>   sapply(SPDF2 at polygons[[1]]@Polygons,slot,"hole")
>>>>>>>>>   [1] FALSE  TRUE
>>>>>>>>> 
>>>>>>>>>   I see from the sp documentation that "Polygon objects belonging to a
>>>>>>>>>   Polygons object should either not overlap one-other, or should be
>>>>>>>>>   fully included" but I am not sure how this relates to bordering
>>>>>>>>>   Polygon objects. I would welcome any advice as to whether what I am
>>>>>>>>>   asking of writeOGR is reasonable?
>>>>>>>> 
>>>>>>>>  The problem is with the 'ESRI Shapefile' representation and driver:
>>>>>>>> 
>>>>>>>>  library(rgdal)
>>>>>>>>  r1 <- rbind(c(1,1),c(1,2),c(2,2),c(2,1),c(1,1))
>>>>>>>>  r2 <- r1; r2[,1] <- r2[,1]+1
>>>>>>>>  Ps1 = Polygons(list(Polygon(r1),Polygon(r2)),ID=1)
>>>>>>>>  SPDF = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1)),
>>>>>>>>  data.frame(Example=c("Minimal")))
>>>>>>>>  sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>>  sapply(slot(slot(SPDF, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>>>> 
>>>>>>>>  # which constructs a MULTIPOLYGON object:
>>>>>>>> 
>>>>>>>>  rgeos::writeWKT(SPDF)
>>>>>>>>  library(sf)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(SPDF)))
>>>>>>>> 
>>>>>>>> #    The 'ESRI Shapefile' driver is not Simple-Feature compliant (it
>>>>>>>> #    pre-dates it), so the failure occurs by seeing the second exterior
>>>>>>>> #    ring
>>>>>>>> #    as an interior ring
>>>>>>>> 
>>>>>>>>  fn <- tempfile()
>>>>>>>>  writeOGR(SPDF, fn, layer='test', driver='ESRI Shapefile')
>>>>>>>>  SPDF2 <- readOGR(dsn=fn, layer='test')
>>>>>>>>  sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>>  sapply(slot(slot(SPDF2, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>>>>  rgeos::writeWKT(SPDF2)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(SPDF2)))
>>>>>>>> 
>>>>>>>>  # This happens with sf too, using the same GDAL driver:
>>>>>>>> 
>>>>>>>>  sf2 <- st_read(dsn=fn, layer='test')
>>>>>>>>  st_geometry(sf2)
>>>>>>>>  library(sf)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(sf2)))
>>>>>>>>  rgeos::writeWKT(as(sf2, "Spatial"))
>>>>>>>> 
>>>>>>>>  # Adding the comment fix doesn't help:
>>>>>>>> 
>>>>>>>>  comment(slot(SPDF, "polygons")[[1]])
>>>>>>>>  SPDF_c <- rgeos::createSPComment(SPDF)
>>>>>>>>  comment(slot(SPDF_c, "polygons")[[1]])
>>>>>>>>  writeOGR(SPDF_c, fn, layer='test_c', driver='ESRI Shapefile',
>>>>>>>>    verbose=TRUE)
>>>>>>>> 
>>>>>>>> #    reports
>>>>>>>> #    Object initially classed as: wkbPolygon
>>>>>>>> #    SFS comments in Polygons objects
>>>>>>>> #    Object reclassed as: wkbMultiPolygon
>>>>>>>> 
>>>>>>>>  SPDF2_c <- readOGR(dsn=fn, layer='test_c')
>>>>>>>>  sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>>  sapply(slot(slot(SPDF2_c, "polygons")[[1]], "Polygons"), slot,
>>>>>>>>  "ringDir")
>>>>>>>>  rgeos::writeWKT(SPDF2_c)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(SPDF2_c)))
>>>>>>>> 
>>>>>>>> 
>>>>>>>> 
>>>>>>>>  # If the input object is written out with the GeoPackage driver:
>>>>>>>> 
>>>>>>>>  fn1 <- tempfile(fileext=".gpkg")
>>>>>>>>  writeOGR(SPDF, fn1, layer="test", driver='GPKG')
>>>>>>>>  sf2a <- st_read(dsn=fn1,layer='test')
>>>>>>>>  st_coordinates(st_geometry(sf2a))
>>>>>>>>  SPDF2a <- readOGR(dsn=fn1)
>>>>>>>>  sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>>  sapply(slot(slot(SPDF2a, "polygons")[[1]], "Polygons"), slot, "ringDir")
>>>>>>>>  rgeos::writeWKT(SPDF2a)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(SPDF2a)))
>>>>>>>> 
>>>>>>>>  # the issue is resolved. If we separate the exterior rings:
>>>>>>>> 
>>>>>>>>  r2a <- r1; r2a[,1] <- r2a[,1]+1.00001
>>>>>>>>  Ps1a = Polygons(list(Polygon(r1),Polygon(r2a)),ID=1)
>>>>>>>>  SPDFa = SpatialPolygonsDataFrame( SpatialPolygons(list(Ps1a)),
>>>>>>>>  data.frame(Example=c("Minimal")))
>>>>>>>>  fna <- tempfile()
>>>>>>>>  writeOGR(SPDFa, fna, layer='test', driver='ESRI Shapefile')
>>>>>>>>  SPDF2_a <- readOGR(dsn=fna, layer='test')
>>>>>>>>  sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot, "hole")
>>>>>>>>  sapply(slot(slot(SPDF2_a, "polygons")[[1]], "Polygons"), slot,
>>>>>>>>  "ringDir")
>>>>>>>>  rgeos::writeWKT(SPDF2_a)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(SPDF2_a)))
>>>>>>>> 
>>>>>>>>  # we are OK as the two exterior rings do not touch.
>>>>>>>> 
>>>>>>>>  # does using sf make a difference?
>>>>>>>> 
>>>>>>>>  fn_s <- tempfile(fileext=".shp")
>>>>>>>>  st_write(st_as_sf(SPDF), dsn=fn_s)
>>>>>>>>  sf_in <- st_read(fn_s)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(sf_in)))
>>>>>>>> 
>>>>>>>>  # No
>>>>>>>> 
>>>>>>>>  fn_s <- tempfile(fileext=".shp")
>>>>>>>>  st_write(st_as_sf(SPDF_c), dsn=fn_s)
>>>>>>>>  sf_in_c <- st_read(fn_s)
>>>>>>>>  st_as_text(st_geometry(st_as_sf(sf_in_c)))
>>>>>>>> 
>>>>>>>>  # nor with the pretend-SF-compliant comment set either.
>>>>>>>> 
>>>>>>>>  So the weakness is in the "ESRI Shapefile" write driver, or possibly in
>>>>>>>>  the OGRGeometryFactory::organizePolygons() function in GDAL used in
>>>>>>>>  OGR_write() (a C++ function) called by writeOGR(). If sf::st_write()
>>>>>>>>  also
>>>>>>>>  calls OGRGeometryFactory::organizePolygons(), we'd maybe consider that
>>>>>>>>  it
>>>>>>>>  has a weakness for the "ESRI Shapefile" driver, but which does not
>>>>>>>>  affect
>>>>>>>>  SF-compliant drivers.
>>>>>>> 
>>>>>>> Without the comment set, OGRGeometryFactory::organizePolygons() is used;
>>>>>>> with it set, OGRGeometryFactory::organizePolygons() is not used, because
>>>>>>> the object is declared as two exterior rings. In both cases, we have the
>>>>>>> output object written out and read back in incorrectly with the ESRI
>>>>>>> shapefile driver, but SF-compliant drivers round-trip (in the test
>>>>>>> GeoJSON), correctly.
>>>>>>> 
>>>>>>> It is likely that the changes made in 2015 to accommodate GeoJSON led to
>>>>>>> this possible regression for the ESRI Shapefile driver. I'm adding this
>>>>>>> geometry to tests/tripup.R and data files; without code changes the hole
>>>>>>> slot is wrong and the ring direction is changes to match, so the
>>>>>>> coordinates change too.
>>>>>>> 
>>>>>>> Reading using the deprecated maptools::readShapeSpatial() also gets a hole
>>>>>>> in the second external ring. However, writing with deprecated
>>>>>>> maptools::  writeSpatialShape() yields a shapefile that when read with
>>>>>>> maptools::  readShapeSpatial() gives the correct two exterior ring, no hole
>>>>>>> object. When read with sf::st_read() and rgdal::readOGR(), the object is
>>>>>>> also correct. So the problem definitely lies in rgdal::writeOGR(), and
>>>>>>> sf::st_write() - roundtripping with sf::st_write() and sf::st_read()
>>>>>>> degrades from MULTIPOLYGON to POLYGON with the ESRI Shapefile driver.
>>>>>>> 
>>>>>>> Roger
>>>>>>> 
>>>>>>>> 
>>>>>>>>  This is probably related to a similar but inverse problem with the
>>>>>>>>  SF-compliant GeoJSON driver in 2015:
>>>>>>>> 
>>>>>>>>  https://stat.ethz.ch/pipermail/r-sig-geo/2015-October/023609.html
>>>>>>>> 
>>>>>>>>  continued the next month in:
>>>>>>>> 
>>>>>>>>  https://stat.ethz.ch/pipermail/r-sig-geo/2015-November/023656.html
>>>>>>>> 
>>>>>>>>  The details are in this SVN diff
>>>>>>>> 
>>>>>>>>  https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=555&r2=571
>>>>>>>> 
>>>>>>>>  up to the end og the list thread, and this one from then until now:
>>>>>>>> 
>>>>>>>>  https://r-forge.r-project.org/scm/viewvc.php/pkg/src/OGR_write.cpp?root=rgdal&r1=571&r2=733
>>>>>>>> 
>>>>>>>>  Summary: could you change drivers, or is it really necessary to fix an
>>>>>>>>  EOL
>>>>>>>>  problem? What is your use case?
>>>>>>>> 
>>>>>>>>> 
>>>>>>>>>   Thanks in advance for your time,
>>>>>>>> 
>>>>>>>>  Thanks for a complete example,
>>>>>>>> 
>>>>>>>>  Roger
>>>>>>>> 
>>>>>>>>>   Phil
>>>>>>>>> 
>>>>>>>>>>   sessionInfo()
>>>>>>>>>   R version 3.5.1 (2018-07-02)
>>>>>>>>>   Platform: x86_64-w64-mingw32/x64 (64-bit)
>>>>>>>>>   Running under: Windows >= 8 x64 (build 9200)
>>>>>>>>> 
>>>>>>>>>   Matrix products: default
>>>>>>>>> 
>>>>>>>>>   locale:
>>>>>>>>>   [1] LC_COLLATE=English_United Kingdom.1252  LC_CTYPE=English_United
>>>>>>>>>   Kingdom.1252    LC_MONETARY=English_United Kingdom.1252 LC_NUMERIC=C
>>>>>>>>>                           LC_TIME=English_United Kingdom.1252
>>>>>>>>> 
>>>>>>>>>   attached base packages:
>>>>>>>>>   [1] stats     graphics  grDevices utils     datasets  methods   base
>>>>>>>>> 
>>>>>>>>>   other attached packages:
>>>>>>>>>   [1] rgdal_1.4-4 sp_1.3-1
>>>>>>>>> 
>>>>>>>>>   loaded via a namespace (and not attached):
>>>>>>>>>   [1] compiler_3.5.1  tools_3.5.1     yaml_2.2.0      grid_3.5.1
>>>>>>>>>   lattice_0.20-35
>>>>>>>>> 
>>>>>>>>>   _______________________________________________
>>>>>>>>>   R-sig-Geo mailing list
>>>>>>>>>   R-sig-Geo at r-project.org
>>>>>>>>>   https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>>>>>> 
>>>>>>>> 
>>>>>>>> 
>>>>>>> 
>>>>>>> 
>>>>>> 
>>>>>> 
>>>>> 
>>>>> --
>>>>> Roger Bivand
>>>>> Department of Economics, Norwegian School of Economics,
>>>>> Helleveien 30, N-5045 Bergen, Norway.
>>>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>>>>> https://orcid.org/0000-0003-2392-6140
>>>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>>>> 
>>> 
>>> --
>>> Roger Bivand
>>> Department of Economics, Norwegian School of Economics,
>>> Helleveien 30, N-5045 Bergen, Norway.
>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>>> https://orcid.org/0000-0003-2392-6140
>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>> 
> 
> -- 
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From webbe @end|ng |rom u||@edu  Wed Aug 21 03:21:07 2019
From: webbe @end|ng |rom u||@edu (Elizabeth Webb)
Date: Wed, 21 Aug 2019 01:21:07 +0000
Subject: [R-sig-Geo] 
 spatial autocorrelation in GAM residuals for large data set
In-Reply-To: <alpine.LFD.2.21.1908202222170.16978@reclus.nhh.no>
References: <1566308761662.30499@ufl.edu>,
 <alpine.LFD.2.21.1908202222170.16978@reclus.nhh.no>
Message-ID: <1566350468002.13465@ufl.edu>

Thank you, Roger for your help.   A quick follow-up:

What do you mean when you say "Use one of the approaches described in the tutorial and you may be OK, but you should not trust the outcome of Moran's I on residuals without using an appropriate variant." ?  Or in other words, what is an appropriate variant in this context?

Elizabeth

_______________________________________From: Roger Bivand <Roger.Bivand at nhh.no>
Sent: Tuesday, August 20, 2019 4:43 PM
To: Elizabeth Webb
Cc: r-sig-geo at r-project.org
Subject: Re: [R-sig-Geo] spatial autocorrelation in GAM residuals for large data set

On Tue, 20 Aug 2019, Elizabeth Webb wrote:

> Hello,
>
> I have a large data set (~100k rows) containing observations at points
> (MODIS pixels) across the northern hemisphere.  I have created a GAM
> using the bam command in mgcv and I would like to check the model
> residuals for spatial autocorrelation.
>
> One idea is to use the DHARMa package
> (https://urldefense.proofpoint.com/v2/url?u=https-3A__cran.r-2Dproject.org_web_packages_DHARMa_vignettes_DHARMa.html-23spatial-2Dautocorrelation&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=lD9g96_TN9t-znQvV1M9V8CH2tgKAYHWKcTS8osjBSc&e= ).
> The code looks something like this:
>
>     simulationOutput  <-   simulateResiduals(fittedModel = mymodel) # point at which R runs into memory problems
>     testSpatialAutocorrelation(simulationOutput = simulationOutput, x =  data$latitude, y= data$longitude)
>
> However, this runs into memory problems.
>
> Another idea is to use the following code, after this tutorial
> (https://urldefense.proofpoint.com/v2/url?u=http-3A__www.flutterbys.com.au_stats_tut_tut8.4a.html&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=v9Op69bwvOVRi1ujar_P8-LHsJFDAN_aE25i1_m22U4&e= ):
>     library(ape)
>     library(fields)
>     coords = cbind(data$longitude, data$latitude)
>    w = rdist(coords)  # point at which R runs into memory problems
>     Moran.I(x = residuals(mymodel), w = w)
>
> But this also runs into memory problems.  I have tried increasing the
> amount of memory allotted to R, but that just means R works for longer
> before timing out.

I do hope that you read

https://urldefense.proofpoint.com/v2/url?u=https-3A__cran.r-2Dproject.org_web_packages_ape_vignettes_MoranI.pdf&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=tp6IoNz-8y-MBnLZldMpb3wUT_faHdoGMFszkZQxYBU&e=

first, because the approach used in ape has been revised.

The main problem is that ape uses by default a square matrix, and it is
uncertain whether sparse matrices are accepted. This means that completely
unneeded computations are carried out - dense matrices should never be
used unless there is a convincing scientific argument (see
https://urldefense.proofpoint.com/v2/url?u=https-3A__edzer.github.io_UseR2019_part2.html-23exercise-2Dreview-2D1&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=PIyJQgsz9qD81VCZsyfJQGdO-Gh6iJNgF2xH9jATbhI&e=  for a
development on why distances are wasteful when edge counts on a graph do
the same thing sparsely).

Use one of the approaches described in the tutorial and you may be OK, but
you should not trust the outcome of Moran's I on residuals without using
an appropriate variant. Say you can represent your GAM with a linear model
with say spline terms, you can use Moran's I for regression residuals.
Take care that the average number of neighbours is very small (6-10), and
large numbers of observations should not be a problem.

A larger problem is that Moran's I (also for residuals) also responds to
other mis-specifications than spatial autocorrelation, in particular
missing variables and spatial processes with a different scale from the
units of observation chosen.


>
> So, two questions: (1) Is there a memory efficient way to check for
> spatial autocorrelation using Moran's I in large data sets? or (2) Is
> there another way to check for spatial autocorrelation (besides Moran's
> I) that won't have such memory problems?

1) Yes, see above, do not use dense matrices

2) Consider a higher level MRF term in your GAM for aggregates of your
observations if such aggregation makes sense for your data.

Hope this clarifies,

Roger

>
> Thanks in advance,
>
> Elizabeth
>
>
>
>
>
>
>
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://urldefense.proofpoint.com/v2/url?u=https-3A__stat.ethz.ch_mailman_listinfo_r-2Dsig-2Dgeo&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=qq-Vo4xAxTCARWawQQYjCYvxm_Hg_iYYW1_n-Xphyg4&e=
>

--
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://urldefense.proofpoint.com/v2/url?u=https-3A__orcid.org_0000-2D0003-2D2392-2D6140&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=nyvB8TRse_NA-lALeTG3k_KOIVVzaNLMuDAqPo3dyGI&e=
https://urldefense.proofpoint.com/v2/url?u=https-3A__scholar.google.no_citations-3Fuser-3DAWeghB0AAAAJ-26hl-3Den&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=UBVoMNMtGxwGxOGDcIJHGAuFm8gqb8X3kqNkGpPVKS4&e=

	[[alternative HTML version deleted]]


From pur@n|k@@m|th@ @end|ng |rom gm@||@com  Wed Aug 21 08:52:37 2019
From: pur@n|k@@m|th@ @end|ng |rom gm@||@com (Amitha Puranik)
Date: Wed, 21 Aug 2019 12:22:37 +0530
Subject: [R-sig-Geo] Simulating variables with predefined correlation and
 autocorrelation
Message-ID: <CANcbSEhKycGCc3niqkW2nUffL9P=b_KkMW5Ui48ajXPYsaQrEg@mail.gmail.com>

Hello everyone,

I'm trying to simulate a set of variables by specifying correlations. For
the simulated data, I also want to specify autocorrelations. Basically I am
trying to simulate data assuming spatial durbin model (a model which
accounts for autocorrelation in both Y and X). I came across the post
on ?*Simulating
spatially autocorrelated data*? in R-sig-geo (
https://stat.ethz.ch/pipermail/r-sig-geo/2011-September/012728.html) where
similar query was discussed, however the focus there was on generating
autocorrelated dependent variable.

Can anyone assist me on this? Thanks in advance.

	[[alternative HTML version deleted]]


From rub@k @end|ng |rom m@th@@@u@dk  Wed Aug 21 11:06:34 2019
From: rub@k @end|ng |rom m@th@@@u@dk (Ege Rubak)
Date: Wed, 21 Aug 2019 11:06:34 +0200
Subject: [R-sig-Geo] Rasterize point process using specific rule
In-Reply-To: <12a6aab0-13e6-53d5-83c8-3cf9ab95fe51@yahoo.com.br>
References: <12a6aab0-13e6-53d5-83c8-3cf9ab95fe51@yahoo.com.br>
Message-ID: <62e6126e-00dc-7da5-a458-d137594db80c@math.aau.dk>

If I understand your question correctly you can simply use the spatstat 
function `discs()`. Given `syn.ppp` created from your code the call is 
something like:

     D <- discs(syn.ppp, radii = marks(syn.ppp)/2, mask = TRUE, eps = 1)

For your dataset this covers almost the entire window if both the 
coordinates and the marks are in meters as I assume, but that is up to 
you to investigate.

/Ege

On 20/08/2019 15.12, ASANTOS via R-sig-Geo wrote:
> Dear members,
> 
> I've like to create a raster using my event coordinates and information
> about the size in this coordinates as a rule for my raster creation.
> First, I make:
> 
> library(raster)
> library(spatstat)
> 
> #Points coordinates in UTM
> xp<-c(371278.588,371250.722,371272.618,371328.421,371349.974,
> 371311.95,371296.265,371406.46,371411.551,371329.041,371338.081,
> 371334.182,371333.756,371299.818,371254.374,371193.673,371172.836,
> 371173.803,371153.73,371165.051,371140.417,371168.279,371166.367,
> 371180.575,371132.664,371129.791,371232.919,371208.502,371289.462,
> 371207.595,371219.008,371139.921,371133.215,371061.467,371053.69,
> 371099.897,371108.782,371112.52,371114.241,371176.236,371159.185,
> 371159.291,371158.552,370978.252,371120.03,371116.993)
> 
> yp<-c(8246507.94,8246493.176,8246465.974,8246464.413,8246403.465,
> 8246386.098,8246432.144,8246394.827,8246366.201,8246337.626,
> 8246311.125,8246300.039,8246299.594,8246298.072,8246379.351,
> 8246431.998,8246423.913,8246423.476,8246431.658,8246418.226,
> 8246400.161,8246396.891,8246394.225,8246400.391,8246370.244,
> 8246367.019,8246311.075,8246255.174,8246255.085,8246226.514,
> 8246215.847,8246337.316,8246330.197,8246311.197,8246304.183,
> 8246239.282,8246239.887,8246241.678,8246240.361,8246167.364,
> 8246171.581,8246171.803,8246169.807,8246293.57,8246183.194,8246189.926)
> 
> #Now I have the size of each nest in meters (marked process)
> 
> area<-c(117,30,4,341,15,160,35,280,108,168,63,143,2,48,182,42,
> 88,56,27,156,288,45,49,234,72,270,91,40,304,56,35,4,56.7,9,4.6,
> 105,133,135,23.92,190,12.9,15.2,192.78,104,255,24)
> 
> # Make a contour for the window creation
> W <- convexhull.xy(xp,yp)
> 
> #Create ppm object
> syn.ppp <- ppp(x=xp,y=yp,window=W, marks=area)
> 
> # Plot the point process
> plot(syn.ppp)
> 
> #Definition of raster resolution - 1 meter square
> ext <- as(extent(c(W$xrange,W$yrange)), "SpatialPolygons")
> syn.ras.res<-rasterToPoints(raster(ext, resolution = 1), spatial = TRUE)
> 
> #Now Rasterize
> syn.ras<- rasterize(syn.ras.res at coords, raster(syn.ras.res), *?????*)
> 
> I' ve like to create some kind of rule in *?????*, where pixel values in
> my final raster was 1 when inside de area (marks=area) and zero for
> outside de circular area given by points coordinates
> (syn.ras.res at coords) using 1 meter as resolution?
> 
> Any ideas, please
> 
> Thanks,
>


From |@cundo@munoz @end|ng |rom c|r@d@|r  Wed Aug 21 12:12:31 2019
From: |@cundo@munoz @end|ng |rom c|r@d@|r (=?UTF-8?Q?Facundo_Mu=c3=b1oz?=)
Date: Wed, 21 Aug 2019 12:12:31 +0200
Subject: [R-sig-Geo] 
 Simulating variables with predefined correlation and autocorrelation
In-Reply-To: <CANcbSEhKycGCc3niqkW2nUffL9P=b_KkMW5Ui48ajXPYsaQrEg@mail.gmail.com>
References: <CANcbSEhKycGCc3niqkW2nUffL9P=b_KkMW5Ui48ajXPYsaQrEg@mail.gmail.com>
Message-ID: <c8a2375d-efb5-2ebe-7b3b-ac966d188f53@cirad.fr>

Dear Amitha,

I'm not sure I understand well your question (but then, I don't know
this Durbin model). From what I quickly looked up it follows this
formulation:

y = \rho W y + \alpha 1_n + X \beta + W X \theta + \varepsilon

where y are the observations (thus, what you are trying to simulate if I
understood correctly), W, X and 1_n are fixed and known matrices, and
the greek letters are the unknown parameters.

For simulating y from this model, you should assign values to the greek
letters and compute:

y = (I_n - \rho W)^{-1} [\alpha 1_n + X \beta + W X \theta + \varepsilon]

Does this help?

?acu.-


On 8/21/19 8:52 AM, Amitha Puranik wrote:
> Hello everyone,
>
> I'm trying to simulate a set of variables by specifying correlations. For
> the simulated data, I also want to specify autocorrelations. Basically I am
> trying to simulate data assuming spatial durbin model (a model which
> accounts for autocorrelation in both Y and X). I came across the post
> on ?*Simulating
> spatially autocorrelated data*? in R-sig-geo (
> https://stat.ethz.ch/pipermail/r-sig-geo/2011-September/012728.html) where
> similar query was discussed, however the focus there was on generating
> autocorrelated dependent variable.
>
> Can anyone assist me on this? Thanks in advance.
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

	[[alternative HTML version deleted]]


From hugo@gco@t@ @end|ng |rom gm@||@com  Wed Aug 21 16:16:59 2019
From: hugo@gco@t@ @end|ng |rom gm@||@com (Hugo Costa)
Date: Wed, 21 Aug 2019 15:16:59 +0100
Subject: [R-sig-Geo] Parallel overlay of undefined multi-layer rasters
Message-ID: <CADvFi5r4CQUbXbLY2SJwkC-Fr-tzThSs32-rmvzHLX=rjWG0Jw@mail.gmail.com>

Dear list

I have an undefined number of multi-layer rasters (TIFF files with 10
bands), and I need to find the maximum (or median, etc.) among the rasters.
The calculations should operate band by band, so the expected output is one
stack also with 10 bands.

I thought of overlay, like this:


library(raster)
r <- raster(ncol=10, nrow=10)
r1 <- init(r, fun=runif)
r2 <- init(r, fun=runif)
r3 <- init(r, fun=runif)
r4 <- init(r, fun=runif)
s1<-stack(r1,r2)
s2<-stack(r3,r4)
s3<-stack(r1,r4)
f<-function(...){max(...,na.rm = TRUE)}

# do.call works for undefined stacks, but not in parallel
list1<-list(s1,s2,fun=f)
list2<-list(s1,s2,s3,fun=f)
do.call(overlay, list1)
do.call(overlay, list2)


As for parallel processing, I thought of clusteR, but it accepts only one
Raster* object.
The problem is that for running overlay with multi-layer rasters, they
cannot be stacked, because if stacked, the function will apply to all bands
and hence output a single band, while in this case the function should
apply band by band.

An alternative to this, is to split the bands of all images, process the
bands individually in parallel inside a loop (i.e. band 1 of all images,
band 2 of all images, etc.),
and then combine the outputs in a multi-layer raster. However, this is
inefficient, specially with large rasters not hold in memory.

Is there an elegant way to do this?

Thanks
Hugo

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Wed Aug 21 17:15:54 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Wed, 21 Aug 2019 17:15:54 +0200
Subject: [R-sig-Geo] 
 spatial autocorrelation in GAM residuals for large data set
In-Reply-To: <1566350468002.13465@ufl.edu>
References: <1566308761662.30499@ufl.edu>,
 <alpine.LFD.2.21.1908202222170.16978@reclus.nhh.no>
 <1566350468002.13465@ufl.edu>
Message-ID: <alpine.LFD.2.21.1908211702310.27532@reclus.nhh.no>

On Wed, 21 Aug 2019, Elizabeth Webb wrote:

> Thank you, Roger for your help.   A quick follow-up:
>
> What do you mean when you say "Use one of the approaches described in 
> the tutorial and you may be OK, but you should not trust the outcome of 
> Moran's I on residuals without using an appropriate variant." ?  Or in 
> other words, what is an appropriate variant in this context?

From Cliff & Ord (1973), we know that using the standard version of 
Moran's I on OLS residuals is flawed, and they therefore proposed an 
alternative taking into account the fact that the fitted values - needed 
to calculate the residuals - depend on the fitted model, see the 
differences that appear between running spdep::moran.test(..., 
randomisation=FALSE) and lm.morantest(mod, ...) as one adds in covariates 
in addition to the intercept. With just the intercept, they are identical, 
as covariates are added, they diverge.

As of now, appropriate tests are not available for models other than OLS, 
so one cannot take results as more than indicative. There has been work 
moving from just lm() to glm() because the RHS may be seen as linear in 
the covariates, but we don't have control?of the distribution of the 
residuals.

The problem is not widely discussed because it is intractable.

Had your pixels formed a rectangle, it might have been possible to use a 
Moran eigenvector approach, as such approaches may use analytical 
eigenvectors, but I am not aware of such work; proponents of Moran 
eigenvectors claim that their use with larger data sets is possible; I 
don't know what size data works in the spmoran package using ME.

Hope this helps,

Roger

>
> Elizabeth
>
> _______________________________________From: Roger Bivand <Roger.Bivand at nhh.no>
> Sent: Tuesday, August 20, 2019 4:43 PM
> To: Elizabeth Webb
> Cc: r-sig-geo at r-project.org
> Subject: Re: [R-sig-Geo] spatial autocorrelation in GAM residuals for large data set
>
> On Tue, 20 Aug 2019, Elizabeth Webb wrote:
>
>> Hello,
>>
>> I have a large data set (~100k rows) containing observations at points
>> (MODIS pixels) across the northern hemisphere.  I have created a GAM
>> using the bam command in mgcv and I would like to check the model
>> residuals for spatial autocorrelation.
>>
>> One idea is to use the DHARMa package
>> (https://urldefense.proofpoint.com/v2/url?u=https-3A__cran.r-2Dproject.org_web_packages_DHARMa_vignettes_DHARMa.html-23spatial-2Dautocorrelation&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=lD9g96_TN9t-znQvV1M9V8CH2tgKAYHWKcTS8osjBSc&e= ).
>> The code looks something like this:
>>
>>     simulationOutput  <-   simulateResiduals(fittedModel = mymodel) # point at which R runs into memory problems
>>     testSpatialAutocorrelation(simulationOutput = simulationOutput, x =  data$latitude, y= data$longitude)
>>
>> However, this runs into memory problems.
>>
>> Another idea is to use the following code, after this tutorial
>> (https://urldefense.proofpoint.com/v2/url?u=http-3A__www.flutterbys.com.au_stats_tut_tut8.4a.html&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=v9Op69bwvOVRi1ujar_P8-LHsJFDAN_aE25i1_m22U4&e= ):
>>     library(ape)
>>     library(fields)
>>     coords = cbind(data$longitude, data$latitude)
>>    w = rdist(coords)  # point at which R runs into memory problems
>>     Moran.I(x = residuals(mymodel), w = w)
>>
>> But this also runs into memory problems.  I have tried increasing the
>> amount of memory allotted to R, but that just means R works for longer
>> before timing out.
>
> I do hope that you read
>
> https://urldefense.proofpoint.com/v2/url?u=https-3A__cran.r-2Dproject.org_web_packages_ape_vignettes_MoranI.pdf&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=tp6IoNz-8y-MBnLZldMpb3wUT_faHdoGMFszkZQxYBU&e=
>
> first, because the approach used in ape has been revised.
>
> The main problem is that ape uses by default a square matrix, and it is
> uncertain whether sparse matrices are accepted. This means that completely
> unneeded computations are carried out - dense matrices should never be
> used unless there is a convincing scientific argument (see
> https://urldefense.proofpoint.com/v2/url?u=https-3A__edzer.github.io_UseR2019_part2.html-23exercise-2Dreview-2D1&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=PIyJQgsz9qD81VCZsyfJQGdO-Gh6iJNgF2xH9jATbhI&e=  for a
> development on why distances are wasteful when edge counts on a graph do
> the same thing sparsely).
>
> Use one of the approaches described in the tutorial and you may be OK, but
> you should not trust the outcome of Moran's I on residuals without using
> an appropriate variant. Say you can represent your GAM with a linear model
> with say spline terms, you can use Moran's I for regression residuals.
> Take care that the average number of neighbours is very small (6-10), and
> large numbers of observations should not be a problem.
>
> A larger problem is that Moran's I (also for residuals) also responds to
> other mis-specifications than spatial autocorrelation, in particular
> missing variables and spatial processes with a different scale from the
> units of observation chosen.
>
>
>>
>> So, two questions: (1) Is there a memory efficient way to check for
>> spatial autocorrelation using Moran's I in large data sets? or (2) Is
>> there another way to check for spatial autocorrelation (besides Moran's
>> I) that won't have such memory problems?
>
> 1) Yes, see above, do not use dense matrices
>
> 2) Consider a higher level MRF term in your GAM for aggregates of your
> observations if such aggregation makes sense for your data.
>
> Hope this clarifies,
>
> Roger
>
>>
>> Thanks in advance,
>>
>> Elizabeth
>>
>>
>>
>>
>>
>>
>>
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://urldefense.proofpoint.com/v2/url?u=https-3A__stat.ethz.ch_mailman_listinfo_r-2Dsig-2Dgeo&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=qq-Vo4xAxTCARWawQQYjCYvxm_Hg_iYYW1_n-Xphyg4&e=
>>
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://urldefense.proofpoint.com/v2/url?u=https-3A__orcid.org_0000-2D0003-2D2392-2D6140&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=nyvB8TRse_NA-lALeTG3k_KOIVVzaNLMuDAqPo3dyGI&e=
> https://urldefense.proofpoint.com/v2/url?u=https-3A__scholar.google.no_citations-3Fuser-3DAWeghB0AAAAJ-26hl-3Den&d=DwIFAw&c=sJ6xIWYx-zLMB3EPkvcnVg&r=fIXSZTeOvV9o221vPRYLSw&m=IMILOSwwjZJkpsYiuj66ywrnluSI19Bn8ozD5p-NZks&s=UBVoMNMtGxwGxOGDcIJHGAuFm8gqb8X3kqNkGpPVKS4&e=
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From |v|@|e|ro @end|ng |rom gm@||@com  Thu Aug 22 05:52:37 2019
From: |v|@|e|ro @end|ng |rom gm@||@com (Frederico Faleiro)
Date: Thu, 22 Aug 2019 00:52:37 -0300
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
Message-ID: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>

Dear list,

I am using some  netCDF files from the CMIP5 climate models in raster
package, but I am having some issues with one model.
The netCDF file from the GFDL-ESM2G model (e.g.
http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
)
have the error message as in bellow example.

#Example
library(raster)
s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...) :
  cells are not equally spaced; you should extract values as points

# I check some solutions that recomend force read the file with the
argument "stopIfNotEqualSpaced = F" as bellow.
sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
*stopIfNotEqualSpaced
= F*)
bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
*stopIfNotEqualSpaced
= F*)

I performed some tests and only "works" with brick. However I did not find
any solution to check where is the problem and fix it in the file.

How can I check if it is really an issue and fix it?

sessionInfo()
R version 3.5.1 (2018-07-02)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 18362)

Matrix products: default

locale:
[1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
[3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
[5] LC_TIME=Portuguese_Brazil.1252

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base

other attached packages:
[1] raster_2.8-19 sp_1.3-1

loaded via a namespace (and not attached):
[1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1       codetools_0.2-15
ncdf4_1.16.1
[6] grid_3.5.1       lattice_0.20-35

Best regards,

Frederico

	[[alternative HTML version deleted]]


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Thu Aug 22 07:04:04 2019
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Thu, 22 Aug 2019 07:04:04 +0200
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
Message-ID: <2638f3a2-925f-9d6b-9945-ce03a5f93ced@uni-muenster.de>

I would be happy to look into this, but the file you point to requires
authentification.

On 8/22/19 5:52 AM, Frederico Faleiro wrote:
> Dear list,
> 
> I am using some  netCDF files from the CMIP5 climate models in raster
> package, but I am having some issues with one model.
> The netCDF file from the GFDL-ESM2G model (e.g.
> http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
> )
> have the error message as in bellow example.
> 
> #Example
> library(raster)
> s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
> Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...) :
>   cells are not equally spaced; you should extract values as points
> 
> # I check some solutions that recomend force read the file with the
> argument "stopIfNotEqualSpaced = F" as bellow.
> sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> *stopIfNotEqualSpaced
> = F*)
> bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> *stopIfNotEqualSpaced
> = F*)
> 
> I performed some tests and only "works" with brick. However I did not find
> any solution to check where is the problem and fix it in the file.
> 
> How can I check if it is really an issue and fix it?
> 
> sessionInfo()
> R version 3.5.1 (2018-07-02)
> Platform: x86_64-w64-mingw32/x64 (64-bit)
> Running under: Windows 10 x64 (build 18362)
> 
> Matrix products: default
> 
> locale:
> [1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
> [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
> [5] LC_TIME=Portuguese_Brazil.1252
> 
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
> 
> other attached packages:
> [1] raster_2.8-19 sp_1.3-1
> 
> loaded via a namespace (and not attached):
> [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1       codetools_0.2-15
> ncdf4_1.16.1
> [6] grid_3.5.1       lattice_0.20-35
> 
> Best regards,
> 
> Frederico
> 
> 	[[alternative HTML version deleted]]
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

-------------- next part --------------
A non-text attachment was scrubbed...
Name: pEpkey.asc
Type: application/pgp-keys
Size: 2472 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190822/edc56792/attachment.bin>

From md@umner @end|ng |rom gm@||@com  Thu Aug 22 10:03:19 2019
From: md@umner @end|ng |rom gm@||@com (Michael Sumner)
Date: Thu, 22 Aug 2019 18:03:19 +1000
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
Message-ID: <CAAcGz9-tG_FZE3Jm3-0in3oW4R6Y=ijy6ni4puSqwe0qrf3kFA@mail.gmail.com>

raster does the wrong thing here in my opinion, the right outcome is to
give a grid in index-extent (0, ncol, 0, nrow) and with no projection
metadata (crs). There will be coordinate arrays in this file, and they need
to be handled as though they are data (with local, x*y dependent values in
every cell).

With brick() you can proceed to process the data with no problem (using
stopIfNotEqualSpaced = FALSE), but you can't rely on the extent being
relevant, or any function that works in geographic space to do the right
thing. To map a layer of these data you might try

grd <- raster(yourfile, stopIfNotEqualSpaced = FALSE)
coords <- brick(raster(yourfile, varname = "lon"),
                         raster(yourfile, varname = "lat"))   ## but only
you will know the names of these variables values "lon", "lat" (might be
"TLON", "TLAT" ? )

In quadmesh there is a way to plot in geographic space that's not
impossibly slow (possibly the coords will need a re-orientation transpose
...):

quadmesh::mesh_plot(grd, coords = coords)

It's likely that will "map" it properly, but CMIP is likely to wrap around
an odd longitude (or something), and so cropping to your area and/or
choosing a good project for the crs argument to mesh_plot is probably
needed.  You can investigate with plot(coords[[1]]) and plot(coords[[2]])
to get a sense of their layout.

In the stars package this is all internalized, with
stars::read_stars(yourfile) catching all the information required as much
as possible, and with plotting methods - but variable choice and actual
results vary widely, and depend a lot on very specific details.  (angstroms
package has similar helpers for the approach but is unlikely to help here
without access to the file to try)

To help us guess further you can use the "ncdump" output, raster will print
this with

print(raster("yourfile"))

and from that we could provide better guesses at variable names and
subsetting etc.

But, as Edzer asked, nothing is as good as having the file - any chance you
can share it?  (Personally I think the world rather needs more R attention
on climate model output.)

Cheers, Mike.

On Thu, Aug 22, 2019 at 1:53 PM Frederico Faleiro <fvfaleiro at gmail.com>
wrote:
>
> Dear list,
>
> I am using some  netCDF files from the CMIP5 climate models in raster
> package, but I am having some issues with one model.
> The netCDF file from the GFDL-ESM2G model (e.g.
>
http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
> )
> have the error message as in bellow example.
>
> #Example
> library(raster)
> s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
> Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...) :
>   cells are not equally spaced; you should extract values as points
>
> # I check some solutions that recomend force read the file with the
> argument "stopIfNotEqualSpaced = F" as bellow.
> sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> *stopIfNotEqualSpaced
> = F*)
> bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> *stopIfNotEqualSpaced
> = F*)
>
> I performed some tests and only "works" with brick. However I did not find
> any solution to check where is the problem and fix it in the file.
>
> How can I check if it is really an issue and fix it?
>
> sessionInfo()
> R version 3.5.1 (2018-07-02)
> Platform: x86_64-w64-mingw32/x64 (64-bit)
> Running under: Windows 10 x64 (build 18362)
>
> Matrix products: default
>
> locale:
> [1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
> [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
> [5] LC_TIME=Portuguese_Brazil.1252
>
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
>
> other attached packages:
> [1] raster_2.8-19 sp_1.3-1
>
> loaded via a namespace (and not attached):
> [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1       codetools_0.2-15
> ncdf4_1.16.1
> [6] grid_3.5.1       lattice_0.20-35
>
> Best regards,
>
> Frederico
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo



--
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com

	[[alternative HTML version deleted]]


From du||yk @end|ng |rom tcd@|e  Thu Aug 22 10:38:27 2019
From: du||yk @end|ng |rom tcd@|e (Karl Duffy)
Date: Thu, 22 Aug 2019 10:38:27 +0200
Subject: [R-sig-Geo] Rasterize point process using specific rule
In-Reply-To: <12a6aab0-13e6-53d5-83c8-3cf9ab95fe51@yahoo.com.br>
References: <12a6aab0-13e6-53d5-83c8-3cf9ab95fe51@yahoo.com.br>
Message-ID: <4B2A96FB-2C90-473E-92F0-BB44DE7385B9@tcd.ie>

I will be out of office from August 10th to August 23rd and will have limited access to email. I will respond to your message when I return

On 20 Aug 2019, at 15:12, ASANTOS via R-sig-Geo <r-sig-geo at r-project.org> wrote:

> Dear members,
> 
> I've like to create a raster using my event coordinates and information 
> about the size in this coordinates as a rule for my raster creation. 
> First, I make:
> 
> library(raster)
> library(spatstat)
> 
> #Points coordinates in UTM
> xp<-c(371278.588,371250.722,371272.618,371328.421,371349.974,
> 371311.95,371296.265,371406.46,371411.551,371329.041,371338.081,
> 371334.182,371333.756,371299.818,371254.374,371193.673,371172.836,
> 371173.803,371153.73,371165.051,371140.417,371168.279,371166.367,
> 371180.575,371132.664,371129.791,371232.919,371208.502,371289.462,
> 371207.595,371219.008,371139.921,371133.215,371061.467,371053.69,
> 371099.897,371108.782,371112.52,371114.241,371176.236,371159.185,
> 371159.291,371158.552,370978.252,371120.03,371116.993)
> 
> yp<-c(8246507.94,8246493.176,8246465.974,8246464.413,8246403.465,
> 8246386.098,8246432.144,8246394.827,8246366.201,8246337.626,
> 8246311.125,8246300.039,8246299.594,8246298.072,8246379.351,
> 8246431.998,8246423.913,8246423.476,8246431.658,8246418.226,
> 8246400.161,8246396.891,8246394.225,8246400.391,8246370.244,
> 8246367.019,8246311.075,8246255.174,8246255.085,8246226.514,
> 8246215.847,8246337.316,8246330.197,8246311.197,8246304.183,
> 8246239.282,8246239.887,8246241.678,8246240.361,8246167.364,
> 8246171.581,8246171.803,8246169.807,8246293.57,8246183.194,8246189.926)
> 
> #Now I have the size of each nest in meters (marked process)
> 
> area<-c(117,30,4,341,15,160,35,280,108,168,63,143,2,48,182,42,
> 88,56,27,156,288,45,49,234,72,270,91,40,304,56,35,4,56.7,9,4.6,
> 105,133,135,23.92,190,12.9,15.2,192.78,104,255,24)
> 
> # Make a contour for the window creation
> W <- convexhull.xy(xp,yp)
> 
> #Create ppm object
> syn.ppp <- ppp(x=xp,y=yp,window=W, marks=area)
> 
> # Plot the point process
> plot(syn.ppp)
> 
> #Definition of raster resolution - 1 meter square
> ext <- as(extent(c(W$xrange,W$yrange)), "SpatialPolygons")
> syn.ras.res<-rasterToPoints(raster(ext, resolution = 1), spatial = TRUE)
> 
> #Now Rasterize
> syn.ras<- rasterize(syn.ras.res at coords, raster(syn.ras.res), *?????*)
> 
> I' ve like to create some kind of rule in *?????*, where pixel values in 
> my final raster was 1 when inside de area (marks=area) and zero for 
> outside de circular area given by points coordinates 
> (syn.ras.res at coords) using 1 meter as resolution?
> 
> Any ideas, please
> 
> Thanks,
> 
> -- 
> ======================================================================
> Alexandre dos Santos
> Prote??o Florestal
> IFMT - Instituto Federal de Educa??o, Ci?ncia e Tecnologia de Mato Grosso
> Campus C?ceres
> Caixa Postal 244
> Avenida dos Ramires, s/n
> Bairro: Distrito Industrial
> C?ceres - MT ?????????????????????CEP: 78.200-000
> Fone: (+55) 65 99686-6970 (VIVO) (+55) 65 3221-2674 (FIXO)
> 
> ????????alexandre.santos at cas.ifmt.edu.br
> Lattes: http://lattes.cnpq.br/1360403201088680
> OrcID: orcid.org/0000-0001-8232-6722
> Researchgate: www.researchgate.net/profile/Alexandre_Santos10
> LinkedIn: br.linkedin.com/in/alexandre-dos-santos-87961635
> Mendeley:www.mendeley.com/profiles/alexandre-dos-santos6/
> ======================================================================
> 
> 
> 	[[alternative HTML version deleted]]
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

	[[alternative text/enriched version deleted]]


From @tu@rt@reece @end|ng |rom b|gpond@com  Thu Aug 22 11:42:30 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 22 Aug 2019 19:42:30 +1000
Subject: [R-sig-Geo] Which Model is Superior in the splm::sphtest??
Message-ID: <008901d558cd$eba9c750$c2fd55f0$@bigpond.com>

Dear Folks,

 

Can you please advise how you tell which model is superior in the
splm::sphtest??

 

You cannot calculate an AIC mostly.

 

So how can you tell??

 

Sorry - I am confused on this point.

 

And - is there a similar test for splm::spgm models??

 

With many thanks indeed,

 

Stuart Reece.

 


	[[alternative HTML version deleted]]


From @tu@rt@reece @end|ng |rom b|gpond@com  Thu Aug 22 11:42:36 2019
From: @tu@rt@reece @end|ng |rom b|gpond@com (Stuart Reece)
Date: Thu, 22 Aug 2019 19:42:36 +1000
Subject: [R-sig-Geo] Does splm::spgm Accept Factors Amongst the Regressors??
Message-ID: <009601d558cd$eee8c5b0$ccba5110$@bigpond.com>

Dear Folks,

I was wondering please if splm::spgm accepts factors amongst the regressors or is it that all the independent variables have to be numeric??

splm::spml seems to accept them just fine - but they appear to be a problem with spgm...

With many thanks as always,

Stuart Reece.


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Aug 22 13:09:39 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 22 Aug 2019 11:09:39 +0000
Subject: [R-sig-Geo] 
 Does splm::spgm Accept Factors Amongst the Regressors??
In-Reply-To: <009601d558cd$eee8c5b0$ccba5110$@bigpond.com>
References: <009601d558cd$eee8c5b0$ccba5110$@bigpond.com>
Message-ID: <8242C5E1DAAE5BEC.45d29828-27c9-4a07-879f-56064c244cb3@mail.outlook.com>

Repoducible example, please, suggest cutting a continuous variable in Produc to create a factor. Output of traceback() useful too.

Roger Bivand
Norwegian School of Economics
Bergen, Norway



Fra: Stuart Reece
Sendt: torsdag 22. august, 10.53
Emne: [R-sig-Geo] Does splm::spgm Accept Factors Amongst the Regressors??
Til: r-sig-geo at r-project.org
Kopi: Stuart Reece


Dear Folks, I was wondering please if splm::spgm accepts factors amongst the regressors or is it that all the independent variables have to be numeric?? splm::spml seems to accept them just fine - but they appear to be a problem with spgm... With many thanks as always, Stuart Reece. _______________________________________________ R-sig-Geo mailing list R-sig-Geo at r-project.org https://stat.ethz.ch/mailman/listinfo/r-sig-geo


	[[alternative HTML version deleted]]


From pur@n|k@@m|th@ @end|ng |rom gm@||@com  Thu Aug 22 13:40:27 2019
From: pur@n|k@@m|th@ @end|ng |rom gm@||@com (Amitha Puranik)
Date: Thu, 22 Aug 2019 17:10:27 +0530
Subject: [R-sig-Geo] 
 Simulating variables with predefined correlation and autocorrelation
Message-ID: <CANcbSEi5GWbp=u88Jb+FHBKrKi4FQ-C=Q48kZ9ONkRFQm0fEDg@mail.gmail.com>

Dear Prof Facundo Mu?oz,



Thank you for a quick response. I am sorry for not phrasing my query
clearly.

I am interested to simulate 2 variables Y and X in such a way that the
resultant variables should possess the correlation coefficient of 0.6
between Y and X and autocorrelation of 0.7 in Y and 0.4 in X. The query
posted in the link (
https://stat.ethz.ch/pipermail/r-sig-geo/2011-September/012728.html)
focussed on only the autocorrelation of Y (spatial lag model) whereas I
would like to introduce some autocorrelation in X too (spatial durbin
model).

Is there a way to do this? Should a covariance structure defining both
correlation and autocorrelation be specified while simulating variables? If
so, how to define such covariance structure? I will be grateful for your
assistance.

Thanks in advance.

Amitha Puranik

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Aug 22 15:36:03 2019
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 22 Aug 2019 13:36:03 +0000
Subject: [R-sig-Geo] 
 Simulating variables with predefined correlation and autocorrelation
In-Reply-To: <CANcbSEi5GWbp=u88Jb+FHBKrKi4FQ-C=Q48kZ9ONkRFQm0fEDg@mail.gmail.com>
References: <CANcbSEi5GWbp=u88Jb+FHBKrKi4FQ-C=Q48kZ9ONkRFQm0fEDg@mail.gmail.com>
Message-ID: <8242C5E1DAAE5BEC.8ac4318a-d335-44d4-b592-f1df9cbf85ee@mail.outlook.com>

Could you please explain why you want to do this and whether you want to use the same weights for y and x? Maybe refer to https://doi.org/10.1111/j.1538-4632.1991.tb00235.x and work referred to there; I'll try to find other references later.

Roger Bivand
Norwegian School of Economics
Bergen, Norway



Fra: Amitha Puranik
Sendt: torsdag 22. august, 12.41
Emne: Re: [R-sig-Geo]  Simulating variables with predefined correlation and autocorrelation
Til: c8a2375d-efb5-2ebe-7b3b-ac966d188f53 at cirad.fr
Kopi: r-sig-geo at r-project.org


Dear Prof Facundo Mu?oz, Thank you for a quick response. I am sorry for not phrasing my query clearly. I am interested to simulate 2 variables Y and X in such a way that the resultant variables should possess the correlation coefficient of 0.6 between Y and X and autocorrelation of 0.7 in Y and 0.4 in X. The query posted in the link ( https://stat.ethz.ch/pipermail/r-sig-geo/2011-September/012728.html) focussed on only the autocorrelation of Y (spatial lag model) whereas I would like to introduce some autocorrelation in X too (spatial durbin model). Is there a way to do this? Should a covariance structure defining both correlation and autocorrelation be specified while simulating variables? If so, how to define such covariance structure? I will be grateful for your assistance. Thanks in advance. Amitha Puranik [[alternative HTML version deleted]] _______________________________________________ R-sig-Geo mailing list R-sig-Geo at r-project.org https://stat.ethz.ch/mailman/listinfo/r-sig-geo


	[[alternative HTML version deleted]]


From |v|@|e|ro @end|ng |rom gm@||@com  Thu Aug 22 20:55:26 2019
From: |v|@|e|ro @end|ng |rom gm@||@com (Frederico Faleiro)
Date: Thu, 22 Aug 2019 15:55:26 -0300
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <CAL+ycW=+OFiAfgS8sR0EwfN1f05qgkJz8NXewR-4mSK3JeUSzg@mail.gmail.com>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
 <CAAcGz9-tG_FZE3Jm3-0in3oW4R6Y=ijy6ni4puSqwe0qrf3kFA@mail.gmail.com>
 <CAL+ycW=+OFiAfgS8sR0EwfN1f05qgkJz8NXewR-4mSK3JeUSzg@mail.gmail.com>
Message-ID: <CAL+ycWn7jvHrmuih3y7-EGkDB9kPxBQQYLj-B1Ez-W69o-DofQ@mail.gmail.com>

Dear list,
sorry about the file. The files from the CMIP5 are public, but need a
registration first.
You can access the same file in any of these links:
https://www.sendspace.com/file/famgz3 and
https://drive.google.com/file/d/1L1T03iQ6LU1yYRYeRypxwMB3E7fLjkJI/view?usp=sharing
.

In this meantime I will try the Mike' advices.

Best regards,

Frederico <https://www.sendspace.com/file/famgz3>

On Thu, Aug 22, 2019 at 3:41 PM Frederico Faleiro <fvfaleiro at gmail.com>
wrote:

> Dear list,
>
> sorry about the file. The files from the CMIP5 are public, but need a
> registration first. I am sending the same file attached.
>
> In this meantime I will try the Mike' advices.
>
> Best regards,
>
> Frederico
>
>
>
>
>
> On Thu, Aug 22, 2019 at 5:03 AM Michael Sumner <mdsumner at gmail.com> wrote:
>
>> raster does the wrong thing here in my opinion, the right outcome is to
>> give a grid in index-extent (0, ncol, 0, nrow) and with no projection
>> metadata (crs). There will be coordinate arrays in this file, and they need
>> to be handled as though they are data (with local, x*y dependent values in
>> every cell).
>>
>> With brick() you can proceed to process the data with no problem (using
>> stopIfNotEqualSpaced = FALSE), but you can't rely on the extent being
>> relevant, or any function that works in geographic space to do the right
>> thing. To map a layer of these data you might try
>>
>> grd <- raster(yourfile, stopIfNotEqualSpaced = FALSE)
>> coords <- brick(raster(yourfile, varname = "lon"),
>>                          raster(yourfile, varname = "lat"))   ## but only
>> you will know the names of these variables values "lon", "lat" (might be
>> "TLON", "TLAT" ? )
>>
>> In quadmesh there is a way to plot in geographic space that's not
>> impossibly slow (possibly the coords will need a re-orientation transpose
>> ...):
>>
>> quadmesh::mesh_plot(grd, coords = coords)
>>
>> It's likely that will "map" it properly, but CMIP is likely to wrap
>> around an odd longitude (or something), and so cropping to your area and/or
>> choosing a good project for the crs argument to mesh_plot is probably
>> needed.  You can investigate with plot(coords[[1]]) and plot(coords[[2]])
>> to get a sense of their layout.
>>
>> In the stars package this is all internalized, with
>> stars::read_stars(yourfile) catching all the information required as much
>> as possible, and with plotting methods - but variable choice and actual
>> results vary widely, and depend a lot on very specific details.  (angstroms
>> package has similar helpers for the approach but is unlikely to help here
>> without access to the file to try)
>>
>> To help us guess further you can use the "ncdump" output, raster will
>> print this with
>>
>> print(raster("yourfile"))
>>
>> and from that we could provide better guesses at variable names and
>> subsetting etc.
>>
>> But, as Edzer asked, nothing is as good as having the file - any chance
>> you can share it?  (Personally I think the world rather needs more R
>> attention on climate model output.)
>>
>> Cheers, Mike.
>>
>> On Thu, Aug 22, 2019 at 1:53 PM Frederico Faleiro <fvfaleiro at gmail.com>
>> wrote:
>> >
>> > Dear list,
>> >
>> > I am using some  netCDF files from the CMIP5 climate models in raster
>> > package, but I am having some issues with one model.
>> > The netCDF file from the GFDL-ESM2G model (e.g.
>> >
>> http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
>> > )
>> > have the error message as in bellow example.
>> >
>> > #Example
>> > library(raster)
>> > s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
>> > Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...) :
>> >   cells are not equally spaced; you should extract values as points
>> >
>> > # I check some solutions that recomend force read the file with the
>> > argument "stopIfNotEqualSpaced = F" as bellow.
>> > sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
>> > *stopIfNotEqualSpaced
>> > = F*)
>> > bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
>> > *stopIfNotEqualSpaced
>> > = F*)
>> >
>> > I performed some tests and only "works" with brick. However I did not
>> find
>> > any solution to check where is the problem and fix it in the file.
>> >
>> > How can I check if it is really an issue and fix it?
>> >
>> > sessionInfo()
>> > R version 3.5.1 (2018-07-02)
>> > Platform: x86_64-w64-mingw32/x64 (64-bit)
>> > Running under: Windows 10 x64 (build 18362)
>> >
>> > Matrix products: default
>> >
>> > locale:
>> > [1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
>> > [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
>> > [5] LC_TIME=Portuguese_Brazil.1252
>> >
>> > attached base packages:
>> > [1] stats     graphics  grDevices utils     datasets  methods   base
>> >
>> > other attached packages:
>> > [1] raster_2.8-19 sp_1.3-1
>> >
>> > loaded via a namespace (and not attached):
>> > [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1       codetools_0.2-15
>> > ncdf4_1.16.1
>> > [6] grid_3.5.1       lattice_0.20-35
>> >
>> > Best regards,
>> >
>> > Frederico
>> >
>> >         [[alternative HTML version deleted]]
>> >
>> > _______________________________________________
>> > R-sig-Geo mailing list
>> > R-sig-Geo at r-project.org
>> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>>
>>
>> --
>> Michael Sumner
>> Software and Database Engineer
>> Australian Antarctic Division
>> Hobart, Australia
>> e-mail: mdsumner at gmail.com
>>
>

	[[alternative HTML version deleted]]


From pur@n|k@@m|th@ @end|ng |rom gm@||@com  Thu Aug 22 18:18:34 2019
From: pur@n|k@@m|th@ @end|ng |rom gm@||@com (Amitha Puranik)
Date: Thu, 22 Aug 2019 21:48:34 +0530
Subject: [R-sig-Geo] 
 Simulating variables with predefined correlation and autocorrelation
In-Reply-To: <8242C5E1DAAE5BEC.8ac4318a-d335-44d4-b592-f1df9cbf85ee@mail.outlook.com>
References: <CANcbSEi5GWbp=u88Jb+FHBKrKi4FQ-C=Q48kZ9ONkRFQm0fEDg@mail.gmail.com>
 <8242C5E1DAAE5BEC.8ac4318a-d335-44d4-b592-f1df9cbf85ee@mail.outlook.com>
Message-ID: <CANcbSEhqRN7S2Ge0RqMcMmVoXRP_Bg_mz+SbD_0YwV7_y1mfDg@mail.gmail.com>

Dear Prof. Bivand,



Thanks a lot for responding and providing the material to read. I will
definitely go through your paper and the references cited in it.

I am working on simulating various scenarios where autocorrelation exists
in Y or X or both and also in the residuals and compare the model
performances on these data. At present I have planned to assign same
weights (distance based) for both X and Y. I have found solution to
simulate autocorrelated Y based on your response in the link (
https://stat.ethz.ch/pipermail/r-sig-geo/2011-September/012728.html). But I
have not found a way to induce autocorrelation in even the independent
variables(s). Hence I posted this query. Thanks in advance.

Regards,

Amitha Puranik.















On Thu, Aug 22, 2019 at 7:06 PM Roger Bivand <Roger.Bivand at nhh.no> wrote:

> Could you please explain why you want to do this and whether you want to
> use the same weights for y and x? Maybe refer to
> https://doi.org/10.1111/j.1538-4632.1991.tb00235.x and work referred to
> there; I'll try to find other references later.
>
> Roger Bivand
> Norwegian School of Economics
> Bergen, Norway
>
>
>
> Fra: Amitha Puranik
> Sendt: torsdag 22. august, 12.41
> Emne: Re: [R-sig-Geo]  Simulating variables with predefined correlation
> and autocorrelation
> Til: c8a2375d-efb5-2ebe-7b3b-ac966d188f53 at cirad.fr
> Kopi: r-sig-geo at r-project.org
>
>
> Dear Prof Facundo Mu?oz, Thank you for a quick response. I am sorry for
> not phrasing my query clearly. I am interested to simulate 2 variables Y
> and X in such a way that the resultant variables should possess the
> correlation coefficient of 0.6 between Y and X and autocorrelation of 0.7
> in Y and 0.4 in X. The query posted in the link (
> https://stat.ethz.ch/pipermail/r-sig-geo/2011-September/012728.html)
> focussed on only the autocorrelation of Y (spatial lag model) whereas I
> would like to introduce some autocorrelation in X too (spatial durbin
> model). Is there a way to do this? Should a covariance structure defining
> both correlation and autocorrelation be specified while simulating
> variables? If so, how to define such covariance structure? I will be
> grateful for your assistance. Thanks in advance. Amitha Puranik
> [[alternative HTML version deleted]]
> _______________________________________________ R-sig-Geo mailing list
> R-sig-Geo at r-project.org https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
>

	[[alternative HTML version deleted]]


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Thu Aug 22 18:27:47 2019
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Thu, 22 Aug 2019 18:27:47 +0200
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <CAL+ycWn7jvHrmuih3y7-EGkDB9kPxBQQYLj-B1Ez-W69o-DofQ@mail.gmail.com>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
 <CAAcGz9-tG_FZE3Jm3-0in3oW4R6Y=ijy6ni4puSqwe0qrf3kFA@mail.gmail.com>
 <CAL+ycW=+OFiAfgS8sR0EwfN1f05qgkJz8NXewR-4mSK3JeUSzg@mail.gmail.com>
 <CAL+ycWn7jvHrmuih3y7-EGkDB9kPxBQQYLj-B1Ez-W69o-DofQ@mail.gmail.com>
Message-ID: <d67a197b-fabf-50a9-f9c9-040ebc719170@uni-muenster.de>

Thanks!

stars::read_stars (GDAL) won't read coordinates or coordinate reference
system from this file, confirmed by running gdalinfo on it.

stars::read_ncdf (installing stars from github) reads it like this:

library(stars)
# Loading required package: abind
# Loading required package: sf
# Linking to GEOS 3.7.1, GDAL 2.4.2, PROJ 5.2.0
(r0 = read_ncdf("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc"))
# no 'var' specified, using pr
# other available variables:
#  average_DT, average_T1, average_T2, lat, lon, bnds, time, time_bnds,
lat_bnds, lon_bnds
# No projection information found in nc file.
#  Coordinate variable units found to be degrees,
#  assuming WGS84 Lat/Lon.
# stars object with 3 dimensions and 1 attribute
# attribute(s):
#  pr [kg/m^2/s]
#  Min.   :0.000e+00
#  1st Qu.:6.035e-06
#  Median :1.700e-05
#  Mean   :2.799e-05
#  3rd Qu.:3.575e-05
#  Max.   :1.068e-03
# dimension(s):
#      from  to offset delta                       refsys point
# lon     1 144     NA    NA +proj=longlat +datum=WGS8...    NA
# lat     1  90     NA    NA +proj=longlat +datum=WGS8... FALSE
# time    1  60     NA    NA                        PCICt FALSE
#                                                   values
# lon                              [0,2.5),...,[357.5,360) [x]
# lat                    [-90,-88.98876),...,[88.98876,90) [y]
# time [2041-01-01,2041-02-01),...,[2045-12-01,2046-01-01)
st_get_dimension_values(r0, "lat") %>% diff %>% table
# .
# 1.51685393258427 2.02247191011234 2.02247191011236 2.02247191011237
#                2                1               74               12

where essentially only the first and last intervals differ from the rest.

So, yes, latitudes are not regular. Also, time is PCICt, and uses a 365
day calendar without leap years:

st_get_dimension_values(r0, "time") %>% diff %>% table
# .
# 28 30 31
#  5 20 34





On 8/22/19 8:55 PM, Frederico Faleiro wrote:
> Dear list,
> sorry about the file. The files from the CMIP5 are public, but need a
> registration first.
> You can access the same file in any of these links:
> https://www.sendspace.com/file/famgz3 and
> https://drive.google.com/file/d/1L1T03iQ6LU1yYRYeRypxwMB3E7fLjkJI/view?usp=sharing
> .
> 
> In this meantime I will try the Mike' advices.
> 
> Best regards,
> 
> Frederico <https://www.sendspace.com/file/famgz3>
> 
> On Thu, Aug 22, 2019 at 3:41 PM Frederico Faleiro <fvfaleiro at gmail.com>
> wrote:
> 
>> Dear list,
>>
>> sorry about the file. The files from the CMIP5 are public, but need a
>> registration first. I am sending the same file attached.
>>
>> In this meantime I will try the Mike' advices.
>>
>> Best regards,
>>
>> Frederico
>>
>>
>>
>>
>>
>> On Thu, Aug 22, 2019 at 5:03 AM Michael Sumner <mdsumner at gmail.com> wrote:
>>
>>> raster does the wrong thing here in my opinion, the right outcome is to
>>> give a grid in index-extent (0, ncol, 0, nrow) and with no projection
>>> metadata (crs). There will be coordinate arrays in this file, and they need
>>> to be handled as though they are data (with local, x*y dependent values in
>>> every cell).
>>>
>>> With brick() you can proceed to process the data with no problem (using
>>> stopIfNotEqualSpaced = FALSE), but you can't rely on the extent being
>>> relevant, or any function that works in geographic space to do the right
>>> thing. To map a layer of these data you might try
>>>
>>> grd <- raster(yourfile, stopIfNotEqualSpaced = FALSE)
>>> coords <- brick(raster(yourfile, varname = "lon"),
>>>                          raster(yourfile, varname = "lat"))   ## but only
>>> you will know the names of these variables values "lon", "lat" (might be
>>> "TLON", "TLAT" ? )
>>>
>>> In quadmesh there is a way to plot in geographic space that's not
>>> impossibly slow (possibly the coords will need a re-orientation transpose
>>> ...):
>>>
>>> quadmesh::mesh_plot(grd, coords = coords)
>>>
>>> It's likely that will "map" it properly, but CMIP is likely to wrap
>>> around an odd longitude (or something), and so cropping to your area and/or
>>> choosing a good project for the crs argument to mesh_plot is probably
>>> needed.  You can investigate with plot(coords[[1]]) and plot(coords[[2]])
>>> to get a sense of their layout.
>>>
>>> In the stars package this is all internalized, with
>>> stars::read_stars(yourfile) catching all the information required as much
>>> as possible, and with plotting methods - but variable choice and actual
>>> results vary widely, and depend a lot on very specific details.  (angstroms
>>> package has similar helpers for the approach but is unlikely to help here
>>> without access to the file to try)
>>>
>>> To help us guess further you can use the "ncdump" output, raster will
>>> print this with
>>>
>>> print(raster("yourfile"))
>>>
>>> and from that we could provide better guesses at variable names and
>>> subsetting etc.
>>>
>>> But, as Edzer asked, nothing is as good as having the file - any chance
>>> you can share it?  (Personally I think the world rather needs more R
>>> attention on climate model output.)
>>>
>>> Cheers, Mike.
>>>
>>> On Thu, Aug 22, 2019 at 1:53 PM Frederico Faleiro <fvfaleiro at gmail.com>
>>> wrote:
>>>>
>>>> Dear list,
>>>>
>>>> I am using some  netCDF files from the CMIP5 climate models in raster
>>>> package, but I am having some issues with one model.
>>>> The netCDF file from the GFDL-ESM2G model (e.g.
>>>>
>>> http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
>>>> )
>>>> have the error message as in bellow example.
>>>>
>>>> #Example
>>>> library(raster)
>>>> s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
>>>> Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...) :
>>>>   cells are not equally spaced; you should extract values as points
>>>>
>>>> # I check some solutions that recomend force read the file with the
>>>> argument "stopIfNotEqualSpaced = F" as bellow.
>>>> sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
>>>> *stopIfNotEqualSpaced
>>>> = F*)
>>>> bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
>>>> *stopIfNotEqualSpaced
>>>> = F*)
>>>>
>>>> I performed some tests and only "works" with brick. However I did not
>>> find
>>>> any solution to check where is the problem and fix it in the file.
>>>>
>>>> How can I check if it is really an issue and fix it?
>>>>
>>>> sessionInfo()
>>>> R version 3.5.1 (2018-07-02)
>>>> Platform: x86_64-w64-mingw32/x64 (64-bit)
>>>> Running under: Windows 10 x64 (build 18362)
>>>>
>>>> Matrix products: default
>>>>
>>>> locale:
>>>> [1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
>>>> [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
>>>> [5] LC_TIME=Portuguese_Brazil.1252
>>>>
>>>> attached base packages:
>>>> [1] stats     graphics  grDevices utils     datasets  methods   base
>>>>
>>>> other attached packages:
>>>> [1] raster_2.8-19 sp_1.3-1
>>>>
>>>> loaded via a namespace (and not attached):
>>>> [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1       codetools_0.2-15
>>>> ncdf4_1.16.1
>>>> [6] grid_3.5.1       lattice_0.20-35
>>>>
>>>> Best regards,
>>>>
>>>> Frederico
>>>>
>>>>         [[alternative HTML version deleted]]
>>>>
>>>> _______________________________________________
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org
>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>
>>>
>>>
>>> --
>>> Michael Sumner
>>> Software and Database Engineer
>>> Australian Antarctic Division
>>> Hobart, Australia
>>> e-mail: mdsumner at gmail.com
>>>
>>
> 
> 	[[alternative HTML version deleted]]
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

-------------- next part --------------
A non-text attachment was scrubbed...
Name: pEpkey.asc
Type: application/pgp-keys
Size: 2472 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20190822/3957cc46/attachment.bin>

From |v|@|e|ro @end|ng |rom gm@||@com  Thu Aug 22 23:32:50 2019
From: |v|@|e|ro @end|ng |rom gm@||@com (Frederico Faleiro)
Date: Thu, 22 Aug 2019 18:32:50 -0300
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <d67a197b-fabf-50a9-f9c9-040ebc719170@uni-muenster.de>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
 <CAAcGz9-tG_FZE3Jm3-0in3oW4R6Y=ijy6ni4puSqwe0qrf3kFA@mail.gmail.com>
 <CAL+ycW=+OFiAfgS8sR0EwfN1f05qgkJz8NXewR-4mSK3JeUSzg@mail.gmail.com>
 <CAL+ycWn7jvHrmuih3y7-EGkDB9kPxBQQYLj-B1Ez-W69o-DofQ@mail.gmail.com>
 <d67a197b-fabf-50a9-f9c9-040ebc719170@uni-muenster.de>
Message-ID: <CAL+ycW=c6kJQiWOObTkx2+083R5bAkhRwYKHkbCKXtVc_PO6_w@mail.gmail.com>

Dear list,

I do not understand why only this model have this issue. I can open many
other files from other models without any issue in raster package.

*Roy*, I test with different model (i.e GFDL-CM3) from NOAA (
https://drive.google.com/file/d/1GrfvbRSH_FpDmlRrqNGXqn6Tz13fjhB6/view?usp=sharing)
without any problem as you can check in the code below. I find the same
issue pointed by *Edzer* in the GFDL-ESM2G, but not in the GFDL-CM3.

Maybe the others can test with this file to figure out what is the problem
with first one.

If the problem is only the difference in the interval of the cells, Is
there any problem to use the raster in this case?
The ncdf4 package can read it better, but I can not do other simple
analysis like cell average, for example. Is it possible read it and make
some kind of transformation to better use it in raster package?

# example
library(ncdf4)
library(raster)
# open with ncdf4
x.n <- nc_open('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc')
z.n <- nc_open('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')
# open with raster
x.r <- brick('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc',
stopIfNotEqualSpaced = F)
z.r <- brick('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')

# get coordenates
lat.x <- ncvar_get(x.n,"lat")
lon.x <- ncvar_get(x.n,"lon")
coords.xn <- as.matrix(expand.grid(lon.x,lat.x))
coords.xr <- coordinates(x.r) # different order of the xy in netcdf4
lat.z <- ncvar_get(z.n,"lat")
lon.z <- ncvar_get(z.n,"lon")
coords.zn <- as.matrix(expand.grid(lon.z,lat.z))
coords.zr <- coordinates(z.r) # different order of the zz in netcdf4

# check the differences between the coordenates
diffLatLon <- function(x) {
  n <- length(x)-1
  v <- rep(NA, n)
  for(i in 1:n) {
    v[i] <- x[i] - x[i+1]
  }
return(v)
}

diffLatLon(lat.x)  # in this file only the first and last intervals differ
from the rest.
diffLatLon(lon.x) # the same interval in all longitudes
diffLatLon(lat.z)  # the same interval in all latitudes
diffLatLon(lon.z) # the same interval in all longitudes

# plot the average of the layers in raster
plot(mean(x.r))
plot(mean(z.r))

Best regards,

Frederico

On Thu, Aug 22, 2019 at 1:29 PM Edzer Pebesma <edzer.pebesma at uni-muenster.de>
wrote:

> Thanks!
>
> stars::read_stars (GDAL) won't read coordinates or coordinate reference
> system from this file, confirmed by running gdalinfo on it.
>
> stars::read_ncdf (installing stars from github) reads it like this:
>
> library(stars)
> # Loading required package: abind
> # Loading required package: sf
> # Linking to GEOS 3.7.1, GDAL 2.4.2, PROJ 5.2.0
> (r0 = read_ncdf("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc"))
> # no 'var' specified, using pr
> # other available variables:
> #  average_DT, average_T1, average_T2, lat, lon, bnds, time, time_bnds,
> lat_bnds, lon_bnds
> # No projection information found in nc file.
> #  Coordinate variable units found to be degrees,
> #  assuming WGS84 Lat/Lon.
> # stars object with 3 dimensions and 1 attribute
> # attribute(s):
> #  pr [kg/m^2/s]
> #  Min.   :0.000e+00
> #  1st Qu.:6.035e-06
> #  Median :1.700e-05
> #  Mean   :2.799e-05
> #  3rd Qu.:3.575e-05
> #  Max.   :1.068e-03
> # dimension(s):
> #      from  to offset delta                       refsys point
> # lon     1 144     NA    NA +proj=longlat +datum=WGS8...    NA
> # lat     1  90     NA    NA +proj=longlat +datum=WGS8... FALSE
> # time    1  60     NA    NA                        PCICt FALSE
> #                                                   values
> # lon                              [0,2.5),...,[357.5,360) [x]
> # lat                    [-90,-88.98876),...,[88.98876,90) [y]
> # time [2041-01-01,2041-02-01),...,[2045-12-01,2046-01-01)
> st_get_dimension_values(r0, "lat") %>% diff %>% table
> # .
> # 1.51685393258427 2.02247191011234 2.02247191011236 2.02247191011237
> #                2                1               74               12
>
> where essentially only the first and last intervals differ from the rest.
>
> So, yes, latitudes are not regular. Also, time is PCICt, and uses a 365
> day calendar without leap years:
>
> st_get_dimension_values(r0, "time") %>% diff %>% table
> # .
> # 28 30 31
> #  5 20 34
>
>
>
>
>
> On 8/22/19 8:55 PM, Frederico Faleiro wrote:
> > Dear list,
> > sorry about the file. The files from the CMIP5 are public, but need a
> > registration first.
> > You can access the same file in any of these links:
> > https://www.sendspace.com/file/famgz3 and
> >
> https://drive.google.com/file/d/1L1T03iQ6LU1yYRYeRypxwMB3E7fLjkJI/view?usp=sharing
> > .
> >
> > In this meantime I will try the Mike' advices.
> >
> > Best regards,
> >
> > Frederico <https://www.sendspace.com/file/famgz3>
> >
> > On Thu, Aug 22, 2019 at 3:41 PM Frederico Faleiro <fvfaleiro at gmail.com>
> > wrote:
> >
> >> Dear list,
> >>
> >> sorry about the file. The files from the CMIP5 are public, but need a
> >> registration first. I am sending the same file attached.
> >>
> >> In this meantime I will try the Mike' advices.
> >>
> >> Best regards,
> >>
> >> Frederico
> >>
> >>
> >>
> >>
> >>
> >> On Thu, Aug 22, 2019 at 5:03 AM Michael Sumner <mdsumner at gmail.com>
> wrote:
> >>
> >>> raster does the wrong thing here in my opinion, the right outcome is to
> >>> give a grid in index-extent (0, ncol, 0, nrow) and with no projection
> >>> metadata (crs). There will be coordinate arrays in this file, and they
> need
> >>> to be handled as though they are data (with local, x*y dependent
> values in
> >>> every cell).
> >>>
> >>> With brick() you can proceed to process the data with no problem (using
> >>> stopIfNotEqualSpaced = FALSE), but you can't rely on the extent being
> >>> relevant, or any function that works in geographic space to do the
> right
> >>> thing. To map a layer of these data you might try
> >>>
> >>> grd <- raster(yourfile, stopIfNotEqualSpaced = FALSE)
> >>> coords <- brick(raster(yourfile, varname = "lon"),
> >>>                          raster(yourfile, varname = "lat"))   ## but
> only
> >>> you will know the names of these variables values "lon", "lat" (might
> be
> >>> "TLON", "TLAT" ? )
> >>>
> >>> In quadmesh there is a way to plot in geographic space that's not
> >>> impossibly slow (possibly the coords will need a re-orientation
> transpose
> >>> ...):
> >>>
> >>> quadmesh::mesh_plot(grd, coords = coords)
> >>>
> >>> It's likely that will "map" it properly, but CMIP is likely to wrap
> >>> around an odd longitude (or something), and so cropping to your area
> and/or
> >>> choosing a good project for the crs argument to mesh_plot is probably
> >>> needed.  You can investigate with plot(coords[[1]]) and
> plot(coords[[2]])
> >>> to get a sense of their layout.
> >>>
> >>> In the stars package this is all internalized, with
> >>> stars::read_stars(yourfile) catching all the information required as
> much
> >>> as possible, and with plotting methods - but variable choice and actual
> >>> results vary widely, and depend a lot on very specific details.
> (angstroms
> >>> package has similar helpers for the approach but is unlikely to help
> here
> >>> without access to the file to try)
> >>>
> >>> To help us guess further you can use the "ncdump" output, raster will
> >>> print this with
> >>>
> >>> print(raster("yourfile"))
> >>>
> >>> and from that we could provide better guesses at variable names and
> >>> subsetting etc.
> >>>
> >>> But, as Edzer asked, nothing is as good as having the file - any chance
> >>> you can share it?  (Personally I think the world rather needs more R
> >>> attention on climate model output.)
> >>>
> >>> Cheers, Mike.
> >>>
> >>> On Thu, Aug 22, 2019 at 1:53 PM Frederico Faleiro <fvfaleiro at gmail.com
> >
> >>> wrote:
> >>>>
> >>>> Dear list,
> >>>>
> >>>> I am using some  netCDF files from the CMIP5 climate models in raster
> >>>> package, but I am having some issues with one model.
> >>>> The netCDF file from the GFDL-ESM2G model (e.g.
> >>>>
> >>>
> http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
> >>>> )
> >>>> have the error message as in bellow example.
> >>>>
> >>>> #Example
> >>>> library(raster)
> >>>> s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
> >>>> Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...)
> :
> >>>>   cells are not equally spaced; you should extract values as points
> >>>>
> >>>> # I check some solutions that recomend force read the file with the
> >>>> argument "stopIfNotEqualSpaced = F" as bellow.
> >>>> sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> >>>> *stopIfNotEqualSpaced
> >>>> = F*)
> >>>> bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> >>>> *stopIfNotEqualSpaced
> >>>> = F*)
> >>>>
> >>>> I performed some tests and only "works" with brick. However I did not
> >>> find
> >>>> any solution to check where is the problem and fix it in the file.
> >>>>
> >>>> How can I check if it is really an issue and fix it?
> >>>>
> >>>> sessionInfo()
> >>>> R version 3.5.1 (2018-07-02)
> >>>> Platform: x86_64-w64-mingw32/x64 (64-bit)
> >>>> Running under: Windows 10 x64 (build 18362)
> >>>>
> >>>> Matrix products: default
> >>>>
> >>>> locale:
> >>>> [1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
> >>>> [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
> >>>> [5] LC_TIME=Portuguese_Brazil.1252
> >>>>
> >>>> attached base packages:
> >>>> [1] stats     graphics  grDevices utils     datasets  methods   base
> >>>>
> >>>> other attached packages:
> >>>> [1] raster_2.8-19 sp_1.3-1
> >>>>
> >>>> loaded via a namespace (and not attached):
> >>>> [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1
>  codetools_0.2-15
> >>>> ncdf4_1.16.1
> >>>> [6] grid_3.5.1       lattice_0.20-35
> >>>>
> >>>> Best regards,
> >>>>
> >>>> Frederico
> >>>>
> >>>>         [[alternative HTML version deleted]]
> >>>>
> >>>> _______________________________________________
> >>>> R-sig-Geo mailing list
> >>>> R-sig-Geo at r-project.org
> >>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>>
> >>>
> >>>
> >>> --
> >>> Michael Sumner
> >>> Software and Database Engineer
> >>> Australian Antarctic Division
> >>> Hobart, Australia
> >>> e-mail: mdsumner at gmail.com
> >>>
> >>
> >
> >       [[alternative HTML version deleted]]
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >
>
> --
> Edzer Pebesma
> Institute for Geoinformatics
> Heisenbergstrasse 2, 48151 Muenster, Germany
> Phone: +49 251 8333081
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From roy@mende|@@ohn @end|ng |rom no@@@gov  Thu Aug 22 23:52:18 2019
From: roy@mende|@@ohn @end|ng |rom no@@@gov (Roy Mendelssohn - NOAA Federal)
Date: Thu, 22 Aug 2019 14:52:18 -0700
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <CAL+ycW=c6kJQiWOObTkx2+083R5bAkhRwYKHkbCKXtVc_PO6_w@mail.gmail.com>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
 <CAAcGz9-tG_FZE3Jm3-0in3oW4R6Y=ijy6ni4puSqwe0qrf3kFA@mail.gmail.com>
 <CAL+ycW=+OFiAfgS8sR0EwfN1f05qgkJz8NXewR-4mSK3JeUSzg@mail.gmail.com>
 <CAL+ycWn7jvHrmuih3y7-EGkDB9kPxBQQYLj-B1Ez-W69o-DofQ@mail.gmail.com>
 <d67a197b-fabf-50a9-f9c9-040ebc719170@uni-muenster.de>
 <CAL+ycW=c6kJQiWOObTkx2+083R5bAkhRwYKHkbCKXtVc_PO6_w@mail.gmail.com>
Message-ID: <5044D839-21D6-41F0-AE45-1A94F1E8A328@noaa.gov>

Hi  Frederico:

There are two separate issues here from my point of view.  The first is are both files CF compliant,  and as far as I can tell they both are, and applications like Panoply or ncdf4 that understand CF compliant files read them just fine.

The second issue is why can't raster or stars or gdal read them.  That is internal to those codes,  and people who know those packages better can probably answer that. And while I may appear to be beating a dead horse,  for better or worse CF compliant netcdf-3 or netcdf-4 files (and this includes files that follow the Discrete Sampling Geometry guidelines) are what all of the major satellite data centers,  the major climate and oceanographic and meteorological data centers, and most modeling efforts  (such as ROMS and IPCC) store their output.   These are standards in these communities,  and it would really benefit the R community if packages aimed at these types of data make certain they can read compliant datasets (of course this is easy for me to say because I won't be doing the work!).  Also the Python programs I have also read these files just fine, but that is probably because the Python codes have been developed more internal to the particular community around netcdf files and CF conventions.

I have found I get better results if I first read the file using ncdf4,  and then if I want to use the features of raster (or some other related program), I use one of the raster commands  to convert arrays to raster objects.

HTH,

-Roy



> On Aug 22, 2019, at 2:32 PM, Frederico Faleiro <fvfaleiro at gmail.com> wrote:
> 
> Dear list,
> 
> I do not understand why only this model have this issue. I can open many
> other files from other models without any issue in raster package.
> 
> *Roy*, I test with different model (i.e GFDL-CM3) from NOAA (
> https://drive.google.com/file/d/1GrfvbRSH_FpDmlRrqNGXqn6Tz13fjhB6/view?usp=sharing)
> without any problem as you can check in the code below. I find the same
> issue pointed by *Edzer* in the GFDL-ESM2G, but not in the GFDL-CM3.
> 
> Maybe the others can test with this file to figure out what is the problem
> with first one.
> 
> If the problem is only the difference in the interval of the cells, Is
> there any problem to use the raster in this case?
> The ncdf4 package can read it better, but I can not do other simple
> analysis like cell average, for example. Is it possible read it and make
> some kind of transformation to better use it in raster package?
> 
> # example
> library(ncdf4)
> library(raster)
> # open with ncdf4
> x.n <- nc_open('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc')
> z.n <- nc_open('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')
> # open with raster
> x.r <- brick('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc',
> stopIfNotEqualSpaced = F)
> z.r <- brick('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')
> 
> # get coordenates
> lat.x <- ncvar_get(x.n,"lat")
> lon.x <- ncvar_get(x.n,"lon")
> coords.xn <- as.matrix(expand.grid(lon.x,lat.x))
> coords.xr <- coordinates(x.r) # different order of the xy in netcdf4
> lat.z <- ncvar_get(z.n,"lat")
> lon.z <- ncvar_get(z.n,"lon")
> coords.zn <- as.matrix(expand.grid(lon.z,lat.z))
> coords.zr <- coordinates(z.r) # different order of the zz in netcdf4
> 
> # check the differences between the coordenates
> diffLatLon <- function(x) {
>  n <- length(x)-1
>  v <- rep(NA, n)
>  for(i in 1:n) {
>    v[i] <- x[i] - x[i+1]
>  }
> return(v)
> }
> 
> diffLatLon(lat.x)  # in this file only the first and last intervals differ
> from the rest.
> diffLatLon(lon.x) # the same interval in all longitudes
> diffLatLon(lat.z)  # the same interval in all latitudes
> diffLatLon(lon.z) # the same interval in all longitudes
> 
> # plot the average of the layers in raster
> plot(mean(x.r))
> plot(mean(z.r))
> 
> Best regards,
> 
> Frederico
> 
> On Thu, Aug 22, 2019 at 1:29 PM Edzer Pebesma <edzer.pebesma at uni-muenster.de>
> wrote:
> 
>> Thanks!
>> 
>> stars::read_stars (GDAL) won't read coordinates or coordinate reference
>> system from this file, confirmed by running gdalinfo on it.
>> 
>> stars::read_ncdf (installing stars from github) reads it like this:
>> 
>> library(stars)
>> # Loading required package: abind
>> # Loading required package: sf
>> # Linking to GEOS 3.7.1, GDAL 2.4.2, PROJ 5.2.0
>> (r0 = read_ncdf("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc"))
>> # no 'var' specified, using pr
>> # other available variables:
>> #  average_DT, average_T1, average_T2, lat, lon, bnds, time, time_bnds,
>> lat_bnds, lon_bnds
>> # No projection information found in nc file.
>> #  Coordinate variable units found to be degrees,
>> #  assuming WGS84 Lat/Lon.
>> # stars object with 3 dimensions and 1 attribute
>> # attribute(s):
>> #  pr [kg/m^2/s]
>> #  Min.   :0.000e+00
>> #  1st Qu.:6.035e-06
>> #  Median :1.700e-05
>> #  Mean   :2.799e-05
>> #  3rd Qu.:3.575e-05
>> #  Max.   :1.068e-03
>> # dimension(s):
>> #      from  to offset delta                       refsys point
>> # lon     1 144     NA    NA +proj=longlat +datum=WGS8...    NA
>> # lat     1  90     NA    NA +proj=longlat +datum=WGS8... FALSE
>> # time    1  60     NA    NA                        PCICt FALSE
>> #                                                   values
>> # lon                              [0,2.5),...,[357.5,360) [x]
>> # lat                    [-90,-88.98876),...,[88.98876,90) [y]
>> # time [2041-01-01,2041-02-01),...,[2045-12-01,2046-01-01)
>> st_get_dimension_values(r0, "lat") %>% diff %>% table
>> # .
>> # 1.51685393258427 2.02247191011234 2.02247191011236 2.02247191011237
>> #                2                1               74               12
>> 
>> where essentially only the first and last intervals differ from the rest.
>> 
>> So, yes, latitudes are not regular. Also, time is PCICt, and uses a 365
>> day calendar without leap years:
>> 
>> st_get_dimension_values(r0, "time") %>% diff %>% table
>> # .
>> # 28 30 31
>> #  5 20 34
>> 
>> 
>> 
>> 
>> 
>> On 8/22/19 8:55 PM, Frederico Faleiro wrote:
>>> Dear list,
>>> sorry about the file. The files from the CMIP5 are public, but need a
>>> registration first.
>>> You can access the same file in any of these links:
>>> https://www.sendspace.com/file/famgz3 and
>>> 
>> https://drive.google.com/file/d/1L1T03iQ6LU1yYRYeRypxwMB3E7fLjkJI/view?usp=sharing
>>> .
>>> 
>>> In this meantime I will try the Mike' advices.
>>> 
>>> Best regards,
>>> 
>>> Frederico <https://www.sendspace.com/file/famgz3>
>>> 
>>> On Thu, Aug 22, 2019 at 3:41 PM Frederico Faleiro <fvfaleiro at gmail.com>
>>> wrote:
>>> 
>>>> Dear list,
>>>> 
>>>> sorry about the file. The files from the CMIP5 are public, but need a
>>>> registration first. I am sending the same file attached.
>>>> 
>>>> In this meantime I will try the Mike' advices.
>>>> 
>>>> Best regards,
>>>> 
>>>> Frederico
>>>> 
>>>> 
>>>> 
>>>> 
>>>> 
>>>> On Thu, Aug 22, 2019 at 5:03 AM Michael Sumner <mdsumner at gmail.com>
>> wrote:
>>>> 
>>>>> raster does the wrong thing here in my opinion, the right outcome is to
>>>>> give a grid in index-extent (0, ncol, 0, nrow) and with no projection
>>>>> metadata (crs). There will be coordinate arrays in this file, and they
>> need
>>>>> to be handled as though they are data (with local, x*y dependent
>> values in
>>>>> every cell).
>>>>> 
>>>>> With brick() you can proceed to process the data with no problem (using
>>>>> stopIfNotEqualSpaced = FALSE), but you can't rely on the extent being
>>>>> relevant, or any function that works in geographic space to do the
>> right
>>>>> thing. To map a layer of these data you might try
>>>>> 
>>>>> grd <- raster(yourfile, stopIfNotEqualSpaced = FALSE)
>>>>> coords <- brick(raster(yourfile, varname = "lon"),
>>>>>                         raster(yourfile, varname = "lat"))   ## but
>> only
>>>>> you will know the names of these variables values "lon", "lat" (might
>> be
>>>>> "TLON", "TLAT" ? )
>>>>> 
>>>>> In quadmesh there is a way to plot in geographic space that's not
>>>>> impossibly slow (possibly the coords will need a re-orientation
>> transpose
>>>>> ...):
>>>>> 
>>>>> quadmesh::mesh_plot(grd, coords = coords)
>>>>> 
>>>>> It's likely that will "map" it properly, but CMIP is likely to wrap
>>>>> around an odd longitude (or something), and so cropping to your area
>> and/or
>>>>> choosing a good project for the crs argument to mesh_plot is probably
>>>>> needed.  You can investigate with plot(coords[[1]]) and
>> plot(coords[[2]])
>>>>> to get a sense of their layout.
>>>>> 
>>>>> In the stars package this is all internalized, with
>>>>> stars::read_stars(yourfile) catching all the information required as
>> much
>>>>> as possible, and with plotting methods - but variable choice and actual
>>>>> results vary widely, and depend a lot on very specific details.
>> (angstroms
>>>>> package has similar helpers for the approach but is unlikely to help
>> here
>>>>> without access to the file to try)
>>>>> 
>>>>> To help us guess further you can use the "ncdump" output, raster will
>>>>> print this with
>>>>> 
>>>>> print(raster("yourfile"))
>>>>> 
>>>>> and from that we could provide better guesses at variable names and
>>>>> subsetting etc.
>>>>> 
>>>>> But, as Edzer asked, nothing is as good as having the file - any chance
>>>>> you can share it?  (Personally I think the world rather needs more R
>>>>> attention on climate model output.)
>>>>> 
>>>>> Cheers, Mike.
>>>>> 
>>>>> On Thu, Aug 22, 2019 at 1:53 PM Frederico Faleiro <fvfaleiro at gmail.com
>>> 
>>>>> wrote:
>>>>>> 
>>>>>> Dear list,
>>>>>> 
>>>>>> I am using some  netCDF files from the CMIP5 climate models in raster
>>>>>> package, but I am having some issues with one model.
>>>>>> The netCDF file from the GFDL-ESM2G model (e.g.
>>>>>> 
>>>>> 
>> http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
>>>>>> )
>>>>>> have the error message as in bellow example.
>>>>>> 
>>>>>> #Example
>>>>>> library(raster)
>>>>>> s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
>>>>>> Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...)
>> :
>>>>>>  cells are not equally spaced; you should extract values as points
>>>>>> 
>>>>>> # I check some solutions that recomend force read the file with the
>>>>>> argument "stopIfNotEqualSpaced = F" as bellow.
>>>>>> sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
>>>>>> *stopIfNotEqualSpaced
>>>>>> = F*)
>>>>>> bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
>>>>>> *stopIfNotEqualSpaced
>>>>>> = F*)
>>>>>> 
>>>>>> I performed some tests and only "works" with brick. However I did not
>>>>> find
>>>>>> any solution to check where is the problem and fix it in the file.
>>>>>> 
>>>>>> How can I check if it is really an issue and fix it?
>>>>>> 
>>>>>> sessionInfo()
>>>>>> R version 3.5.1 (2018-07-02)
>>>>>> Platform: x86_64-w64-mingw32/x64 (64-bit)
>>>>>> Running under: Windows 10 x64 (build 18362)
>>>>>> 
>>>>>> Matrix products: default
>>>>>> 
>>>>>> locale:
>>>>>> [1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
>>>>>> [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
>>>>>> [5] LC_TIME=Portuguese_Brazil.1252
>>>>>> 
>>>>>> attached base packages:
>>>>>> [1] stats     graphics  grDevices utils     datasets  methods   base
>>>>>> 
>>>>>> other attached packages:
>>>>>> [1] raster_2.8-19 sp_1.3-1
>>>>>> 
>>>>>> loaded via a namespace (and not attached):
>>>>>> [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1
>> codetools_0.2-15
>>>>>> ncdf4_1.16.1
>>>>>> [6] grid_3.5.1       lattice_0.20-35
>>>>>> 
>>>>>> Best regards,
>>>>>> 
>>>>>> Frederico
>>>>>> 
>>>>>>        [[alternative HTML version deleted]]
>>>>>> 
>>>>>> _______________________________________________
>>>>>> R-sig-Geo mailing list
>>>>>> R-sig-Geo at r-project.org
>>>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>> 
>>>>> 
>>>>> 
>>>>> --
>>>>> Michael Sumner
>>>>> Software and Database Engineer
>>>>> Australian Antarctic Division
>>>>> Hobart, Australia
>>>>> e-mail: mdsumner at gmail.com
>>>>> 
>>>> 
>>> 
>>>      [[alternative HTML version deleted]]
>>> 
>>> _______________________________________________
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>> 
>> 
>> --
>> Edzer Pebesma
>> Institute for Geoinformatics
>> Heisenbergstrasse 2, 48151 Muenster, Germany
>> Phone: +49 251 8333081
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>> 
> 
> 	[[alternative HTML version deleted]]
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

**********************
"The contents of this message do not reflect any position of the U.S. Government or NOAA."
**********************
Roy Mendelssohn
Supervisory Operations Research Analyst
NOAA/NMFS
Environmental Research Division
Southwest Fisheries Science Center
***Note new street address***
110 McAllister Way
Santa Cruz, CA 95060
Phone: (831)-420-3666
Fax: (831) 420-3980
e-mail: Roy.Mendelssohn at noaa.gov www: https://www.pfeg.noaa.gov/

"Old age and treachery will overcome youth and skill."
"From those who have been given much, much will be expected" 
"the arc of the moral universe is long, but it bends toward justice" -MLK Jr.


From |v|@|e|ro @end|ng |rom gm@||@com  Fri Aug 23 00:49:49 2019
From: |v|@|e|ro @end|ng |rom gm@||@com (Frederico Faleiro)
Date: Thu, 22 Aug 2019 19:49:49 -0300
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <5044D839-21D6-41F0-AE45-1A94F1E8A328@noaa.gov>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
 <CAAcGz9-tG_FZE3Jm3-0in3oW4R6Y=ijy6ni4puSqwe0qrf3kFA@mail.gmail.com>
 <CAL+ycW=+OFiAfgS8sR0EwfN1f05qgkJz8NXewR-4mSK3JeUSzg@mail.gmail.com>
 <CAL+ycWn7jvHrmuih3y7-EGkDB9kPxBQQYLj-B1Ez-W69o-DofQ@mail.gmail.com>
 <d67a197b-fabf-50a9-f9c9-040ebc719170@uni-muenster.de>
 <CAL+ycW=c6kJQiWOObTkx2+083R5bAkhRwYKHkbCKXtVc_PO6_w@mail.gmail.com>
 <5044D839-21D6-41F0-AE45-1A94F1E8A328@noaa.gov>
Message-ID: <CAL+ycW=cK4aqwSdfDFWVa_VEGPbE8MactNFDLw5kx4d8xHY4MQ@mail.gmail.com>

I agree with you Roy. The problem is that the ncdf4 package is focused in
read and write netCDF files, but apparently it is difficult "communicate"
with the other packages.

Could you share an example code of your approach described in the last
paragraph?

Best regards,

Frederico

On Thu, Aug 22, 2019 at 6:52 PM Roy Mendelssohn - NOAA Federal <
roy.mendelssohn at noaa.gov> wrote:

> Hi  Frederico:
>
> There are two separate issues here from my point of view.  The first is
> are both files CF compliant,  and as far as I can tell they both are, and
> applications like Panoply or ncdf4 that understand CF compliant files read
> them just fine.
>
> The second issue is why can't raster or stars or gdal read them.  That is
> internal to those codes,  and people who know those packages better can
> probably answer that. And while I may appear to be beating a dead horse,
> for better or worse CF compliant netcdf-3 or netcdf-4 files (and this
> includes files that follow the Discrete Sampling Geometry guidelines) are
> what all of the major satellite data centers,  the major climate and
> oceanographic and meteorological data centers, and most modeling efforts
> (such as ROMS and IPCC) store their output.   These are standards in these
> communities,  and it would really benefit the R community if packages aimed
> at these types of data make certain they can read compliant datasets (of
> course this is easy for me to say because I won't be doing the work!).
> Also the Python programs I have also read these files just fine, but that
> is probably because the Python codes have been developed more internal to
> the particular community around netcdf files and CF conventions.
>
> I have found I get better results if I first read the file using ncdf4,
> and then if I want to use the features of raster (or some other related
> program), I use one of the raster commands  to convert arrays to raster
> objects.
>
> HTH,
>
> -Roy
>
>
>
> > On Aug 22, 2019, at 2:32 PM, Frederico Faleiro <fvfaleiro at gmail.com>
> wrote:
> >
> > Dear list,
> >
> > I do not understand why only this model have this issue. I can open many
> > other files from other models without any issue in raster package.
> >
> > *Roy*, I test with different model (i.e GFDL-CM3) from NOAA (
> >
> https://drive.google.com/file/d/1GrfvbRSH_FpDmlRrqNGXqn6Tz13fjhB6/view?usp=sharing
> )
> > without any problem as you can check in the code below. I find the same
> > issue pointed by *Edzer* in the GFDL-ESM2G, but not in the GFDL-CM3.
> >
> > Maybe the others can test with this file to figure out what is the
> problem
> > with first one.
> >
> > If the problem is only the difference in the interval of the cells, Is
> > there any problem to use the raster in this case?
> > The ncdf4 package can read it better, but I can not do other simple
> > analysis like cell average, for example. Is it possible read it and make
> > some kind of transformation to better use it in raster package?
> >
> > # example
> > library(ncdf4)
> > library(raster)
> > # open with ncdf4
> > x.n <- nc_open('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc')
> > z.n <- nc_open('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')
> > # open with raster
> > x.r <- brick('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc',
> > stopIfNotEqualSpaced = F)
> > z.r <- brick('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')
> >
> > # get coordenates
> > lat.x <- ncvar_get(x.n,"lat")
> > lon.x <- ncvar_get(x.n,"lon")
> > coords.xn <- as.matrix(expand.grid(lon.x,lat.x))
> > coords.xr <- coordinates(x.r) # different order of the xy in netcdf4
> > lat.z <- ncvar_get(z.n,"lat")
> > lon.z <- ncvar_get(z.n,"lon")
> > coords.zn <- as.matrix(expand.grid(lon.z,lat.z))
> > coords.zr <- coordinates(z.r) # different order of the zz in netcdf4
> >
> > # check the differences between the coordenates
> > diffLatLon <- function(x) {
> >  n <- length(x)-1
> >  v <- rep(NA, n)
> >  for(i in 1:n) {
> >    v[i] <- x[i] - x[i+1]
> >  }
> > return(v)
> > }
> >
> > diffLatLon(lat.x)  # in this file only the first and last intervals
> differ
> > from the rest.
> > diffLatLon(lon.x) # the same interval in all longitudes
> > diffLatLon(lat.z)  # the same interval in all latitudes
> > diffLatLon(lon.z) # the same interval in all longitudes
> >
> > # plot the average of the layers in raster
> > plot(mean(x.r))
> > plot(mean(z.r))
> >
> > Best regards,
> >
> > Frederico
> >
> > On Thu, Aug 22, 2019 at 1:29 PM Edzer Pebesma <
> edzer.pebesma at uni-muenster.de>
> > wrote:
> >
> >> Thanks!
> >>
> >> stars::read_stars (GDAL) won't read coordinates or coordinate reference
> >> system from this file, confirmed by running gdalinfo on it.
> >>
> >> stars::read_ncdf (installing stars from github) reads it like this:
> >>
> >> library(stars)
> >> # Loading required package: abind
> >> # Loading required package: sf
> >> # Linking to GEOS 3.7.1, GDAL 2.4.2, PROJ 5.2.0
> >> (r0 = read_ncdf("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc"))
> >> # no 'var' specified, using pr
> >> # other available variables:
> >> #  average_DT, average_T1, average_T2, lat, lon, bnds, time, time_bnds,
> >> lat_bnds, lon_bnds
> >> # No projection information found in nc file.
> >> #  Coordinate variable units found to be degrees,
> >> #  assuming WGS84 Lat/Lon.
> >> # stars object with 3 dimensions and 1 attribute
> >> # attribute(s):
> >> #  pr [kg/m^2/s]
> >> #  Min.   :0.000e+00
> >> #  1st Qu.:6.035e-06
> >> #  Median :1.700e-05
> >> #  Mean   :2.799e-05
> >> #  3rd Qu.:3.575e-05
> >> #  Max.   :1.068e-03
> >> # dimension(s):
> >> #      from  to offset delta                       refsys point
> >> # lon     1 144     NA    NA +proj=longlat +datum=WGS8...    NA
> >> # lat     1  90     NA    NA +proj=longlat +datum=WGS8... FALSE
> >> # time    1  60     NA    NA                        PCICt FALSE
> >> #                                                   values
> >> # lon                              [0,2.5),...,[357.5,360) [x]
> >> # lat                    [-90,-88.98876),...,[88.98876,90) [y]
> >> # time [2041-01-01,2041-02-01),...,[2045-12-01,2046-01-01)
> >> st_get_dimension_values(r0, "lat") %>% diff %>% table
> >> # .
> >> # 1.51685393258427 2.02247191011234 2.02247191011236 2.02247191011237
> >> #                2                1               74               12
> >>
> >> where essentially only the first and last intervals differ from the
> rest.
> >>
> >> So, yes, latitudes are not regular. Also, time is PCICt, and uses a 365
> >> day calendar without leap years:
> >>
> >> st_get_dimension_values(r0, "time") %>% diff %>% table
> >> # .
> >> # 28 30 31
> >> #  5 20 34
> >>
> >>
> >>
> >>
> >>
> >> On 8/22/19 8:55 PM, Frederico Faleiro wrote:
> >>> Dear list,
> >>> sorry about the file. The files from the CMIP5 are public, but need a
> >>> registration first.
> >>> You can access the same file in any of these links:
> >>> https://www.sendspace.com/file/famgz3 and
> >>>
> >>
> https://drive.google.com/file/d/1L1T03iQ6LU1yYRYeRypxwMB3E7fLjkJI/view?usp=sharing
> >>> .
> >>>
> >>> In this meantime I will try the Mike' advices.
> >>>
> >>> Best regards,
> >>>
> >>> Frederico <https://www.sendspace.com/file/famgz3>
> >>>
> >>> On Thu, Aug 22, 2019 at 3:41 PM Frederico Faleiro <fvfaleiro at gmail.com
> >
> >>> wrote:
> >>>
> >>>> Dear list,
> >>>>
> >>>> sorry about the file. The files from the CMIP5 are public, but need a
> >>>> registration first. I am sending the same file attached.
> >>>>
> >>>> In this meantime I will try the Mike' advices.
> >>>>
> >>>> Best regards,
> >>>>
> >>>> Frederico
> >>>>
> >>>>
> >>>>
> >>>>
> >>>>
> >>>> On Thu, Aug 22, 2019 at 5:03 AM Michael Sumner <mdsumner at gmail.com>
> >> wrote:
> >>>>
> >>>>> raster does the wrong thing here in my opinion, the right outcome is
> to
> >>>>> give a grid in index-extent (0, ncol, 0, nrow) and with no projection
> >>>>> metadata (crs). There will be coordinate arrays in this file, and
> they
> >> need
> >>>>> to be handled as though they are data (with local, x*y dependent
> >> values in
> >>>>> every cell).
> >>>>>
> >>>>> With brick() you can proceed to process the data with no problem
> (using
> >>>>> stopIfNotEqualSpaced = FALSE), but you can't rely on the extent being
> >>>>> relevant, or any function that works in geographic space to do the
> >> right
> >>>>> thing. To map a layer of these data you might try
> >>>>>
> >>>>> grd <- raster(yourfile, stopIfNotEqualSpaced = FALSE)
> >>>>> coords <- brick(raster(yourfile, varname = "lon"),
> >>>>>                         raster(yourfile, varname = "lat"))   ## but
> >> only
> >>>>> you will know the names of these variables values "lon", "lat" (might
> >> be
> >>>>> "TLON", "TLAT" ? )
> >>>>>
> >>>>> In quadmesh there is a way to plot in geographic space that's not
> >>>>> impossibly slow (possibly the coords will need a re-orientation
> >> transpose
> >>>>> ...):
> >>>>>
> >>>>> quadmesh::mesh_plot(grd, coords = coords)
> >>>>>
> >>>>> It's likely that will "map" it properly, but CMIP is likely to wrap
> >>>>> around an odd longitude (or something), and so cropping to your area
> >> and/or
> >>>>> choosing a good project for the crs argument to mesh_plot is probably
> >>>>> needed.  You can investigate with plot(coords[[1]]) and
> >> plot(coords[[2]])
> >>>>> to get a sense of their layout.
> >>>>>
> >>>>> In the stars package this is all internalized, with
> >>>>> stars::read_stars(yourfile) catching all the information required as
> >> much
> >>>>> as possible, and with plotting methods - but variable choice and
> actual
> >>>>> results vary widely, and depend a lot on very specific details.
> >> (angstroms
> >>>>> package has similar helpers for the approach but is unlikely to help
> >> here
> >>>>> without access to the file to try)
> >>>>>
> >>>>> To help us guess further you can use the "ncdump" output, raster will
> >>>>> print this with
> >>>>>
> >>>>> print(raster("yourfile"))
> >>>>>
> >>>>> and from that we could provide better guesses at variable names and
> >>>>> subsetting etc.
> >>>>>
> >>>>> But, as Edzer asked, nothing is as good as having the file - any
> chance
> >>>>> you can share it?  (Personally I think the world rather needs more R
> >>>>> attention on climate model output.)
> >>>>>
> >>>>> Cheers, Mike.
> >>>>>
> >>>>> On Thu, Aug 22, 2019 at 1:53 PM Frederico Faleiro <
> fvfaleiro at gmail.com
> >>>
> >>>>> wrote:
> >>>>>>
> >>>>>> Dear list,
> >>>>>>
> >>>>>> I am using some  netCDF files from the CMIP5 climate models in
> raster
> >>>>>> package, but I am having some issues with one model.
> >>>>>> The netCDF file from the GFDL-ESM2G model (e.g.
> >>>>>>
> >>>>>
> >>
> http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
> >>>>>> )
> >>>>>> have the error message as in bellow example.
> >>>>>>
> >>>>>> #Example
> >>>>>> library(raster)
> >>>>>> s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
> >>>>>> Error in .rasterObjectFromCDF(x, type = objecttype, band = band,
> ...)
> >> :
> >>>>>>  cells are not equally spaced; you should extract values as points
> >>>>>>
> >>>>>> # I check some solutions that recomend force read the file with the
> >>>>>> argument "stopIfNotEqualSpaced = F" as bellow.
> >>>>>> sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> >>>>>> *stopIfNotEqualSpaced
> >>>>>> = F*)
> >>>>>> bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> >>>>>> *stopIfNotEqualSpaced
> >>>>>> = F*)
> >>>>>>
> >>>>>> I performed some tests and only "works" with brick. However I did
> not
> >>>>> find
> >>>>>> any solution to check where is the problem and fix it in the file.
> >>>>>>
> >>>>>> How can I check if it is really an issue and fix it?
> >>>>>>
> >>>>>> sessionInfo()
> >>>>>> R version 3.5.1 (2018-07-02)
> >>>>>> Platform: x86_64-w64-mingw32/x64 (64-bit)
> >>>>>> Running under: Windows 10 x64 (build 18362)
> >>>>>>
> >>>>>> Matrix products: default
> >>>>>>
> >>>>>> locale:
> >>>>>> [1] LC_COLLATE=Portuguese_Brazil.1252
> LC_CTYPE=Portuguese_Brazil.1252
> >>>>>> [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
> >>>>>> [5] LC_TIME=Portuguese_Brazil.1252
> >>>>>>
> >>>>>> attached base packages:
> >>>>>> [1] stats     graphics  grDevices utils     datasets  methods   base
> >>>>>>
> >>>>>> other attached packages:
> >>>>>> [1] raster_2.8-19 sp_1.3-1
> >>>>>>
> >>>>>> loaded via a namespace (and not attached):
> >>>>>> [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1
> >> codetools_0.2-15
> >>>>>> ncdf4_1.16.1
> >>>>>> [6] grid_3.5.1       lattice_0.20-35
> >>>>>>
> >>>>>> Best regards,
> >>>>>>
> >>>>>> Frederico
> >>>>>>
> >>>>>>        [[alternative HTML version deleted]]
> >>>>>>
> >>>>>> _______________________________________________
> >>>>>> R-sig-Geo mailing list
> >>>>>> R-sig-Geo at r-project.org
> >>>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>>>>
> >>>>>
> >>>>>
> >>>>> --
> >>>>> Michael Sumner
> >>>>> Software and Database Engineer
> >>>>> Australian Antarctic Division
> >>>>> Hobart, Australia
> >>>>> e-mail: mdsumner at gmail.com
> >>>>>
> >>>>
> >>>
> >>>      [[alternative HTML version deleted]]
> >>>
> >>> _______________________________________________
> >>> R-sig-Geo mailing list
> >>> R-sig-Geo at r-project.org
> >>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>>
> >>
> >> --
> >> Edzer Pebesma
> >> Institute for Geoinformatics
> >> Heisenbergstrasse 2, 48151 Muenster, Germany
> >> Phone: +49 251 8333081
> >> _______________________________________________
> >> R-sig-Geo mailing list
> >> R-sig-Geo at r-project.org
> >> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>
> >
> >       [[alternative HTML version deleted]]
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
> **********************
> "The contents of this message do not reflect any position of the U.S.
> Government or NOAA."
> **********************
> Roy Mendelssohn
> Supervisory Operations Research Analyst
> NOAA/NMFS
> Environmental Research Division
> Southwest Fisheries Science Center
> ***Note new street address***
> 110 McAllister Way
> Santa Cruz, CA 95060
> Phone: (831)-420-3666
> Fax: (831) 420-3980
> e-mail: Roy.Mendelssohn at noaa.gov www: https://www.pfeg.noaa.gov/
>
> "Old age and treachery will overcome youth and skill."
> "From those who have been given much, much will be expected"
> "the arc of the moral universe is long, but it bends toward justice" -MLK
> Jr.
>
>

	[[alternative HTML version deleted]]


From roy@mende|@@ohn @end|ng |rom no@@@gov  Fri Aug 23 01:01:09 2019
From: roy@mende|@@ohn @end|ng |rom no@@@gov (Roy Mendelssohn - NOAA Federal)
Date: Thu, 22 Aug 2019 16:01:09 -0700
Subject: [R-sig-Geo] Error in netCDF file: cells are not equally spaced
In-Reply-To: <CAL+ycW=cK4aqwSdfDFWVa_VEGPbE8MactNFDLw5kx4d8xHY4MQ@mail.gmail.com>
References: <CAL+ycWmSkN2evP_p9p2h=72yPt=vK-BqvoL=-Yz-X=4tVouXHQ@mail.gmail.com>
 <CAAcGz9-tG_FZE3Jm3-0in3oW4R6Y=ijy6ni4puSqwe0qrf3kFA@mail.gmail.com>
 <CAL+ycW=+OFiAfgS8sR0EwfN1f05qgkJz8NXewR-4mSK3JeUSzg@mail.gmail.com>
 <CAL+ycWn7jvHrmuih3y7-EGkDB9kPxBQQYLj-B1Ez-W69o-DofQ@mail.gmail.com>
 <d67a197b-fabf-50a9-f9c9-040ebc719170@uni-muenster.de>
 <CAL+ycW=c6kJQiWOObTkx2+083R5bAkhRwYKHkbCKXtVc_PO6_w@mail.gmail.com>
 <5044D839-21D6-41F0-AE45-1A94F1E8A328@noaa.gov>
 <CAL+ycW=cK4aqwSdfDFWVa_VEGPbE8MactNFDLw5kx4d8xHY4MQ@mail.gmail.com>
Message-ID: <3157AD96-C4CC-4B22-BD1F-8528FF7579B3@noaa.gov>

If you do:

?raster

for example  (or ?brick) you will see both commands are for want of a better term "overloaded"  and have methods for objects  of type matrix or type array,  with optionally the coordinates given.  Extract the data and coordinate using ncdf4,  pass to raster() or brick().  I believe some of the other packages have similar ability to convert matrices or arrays.

-Roy


> On Aug 22, 2019, at 3:49 PM, Frederico Faleiro <fvfaleiro at gmail.com> wrote:
> 
> I agree with you Roy. The problem is that the ncdf4 package is focused in read and write netCDF files, but apparently it is difficult "communicate" with the other packages.
> 
> Could you share an example code of your approach described in the last paragraph?
> 
> Best regards,
> 
> Frederico
> 
> On Thu, Aug 22, 2019 at 6:52 PM Roy Mendelssohn - NOAA Federal <roy.mendelssohn at noaa.gov> wrote:
> Hi  Frederico:
> 
> There are two separate issues here from my point of view.  The first is are both files CF compliant,  and as far as I can tell they both are, and applications like Panoply or ncdf4 that understand CF compliant files read them just fine.
> 
> The second issue is why can't raster or stars or gdal read them.  That is internal to those codes,  and people who know those packages better can probably answer that. And while I may appear to be beating a dead horse,  for better or worse CF compliant netcdf-3 or netcdf-4 files (and this includes files that follow the Discrete Sampling Geometry guidelines) are what all of the major satellite data centers,  the major climate and oceanographic and meteorological data centers, and most modeling efforts  (such as ROMS and IPCC) store their output.   These are standards in these communities,  and it would really benefit the R community if packages aimed at these types of data make certain they can read compliant datasets (of course this is easy for me to say because I won't be doing the work!).  Also the Python programs I have also read these files just fine, but that is probably because the Python codes have been developed more internal to the particular community around netcdf files and CF conventions.
> 
> I have found I get better results if I first read the file using ncdf4,  and then if I want to use the features of raster (or some other related program), I use one of the raster commands  to convert arrays to raster objects.
> 
> HTH,
> 
> -Roy
> 
> 
> 
> > On Aug 22, 2019, at 2:32 PM, Frederico Faleiro <fvfaleiro at gmail.com> wrote:
> > 
> > Dear list,
> > 
> > I do not understand why only this model have this issue. I can open many
> > other files from other models without any issue in raster package.
> > 
> > *Roy*, I test with different model (i.e GFDL-CM3) from NOAA (
> > https://drive.google.com/file/d/1GrfvbRSH_FpDmlRrqNGXqn6Tz13fjhB6/view?usp=sharing)
> > without any problem as you can check in the code below. I find the same
> > issue pointed by *Edzer* in the GFDL-ESM2G, but not in the GFDL-CM3.
> > 
> > Maybe the others can test with this file to figure out what is the problem
> > with first one.
> > 
> > If the problem is only the difference in the interval of the cells, Is
> > there any problem to use the raster in this case?
> > The ncdf4 package can read it better, but I can not do other simple
> > analysis like cell average, for example. Is it possible read it and make
> > some kind of transformation to better use it in raster package?
> > 
> > # example
> > library(ncdf4)
> > library(raster)
> > # open with ncdf4
> > x.n <- nc_open('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc')
> > z.n <- nc_open('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')
> > # open with raster
> > x.r <- brick('pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc',
> > stopIfNotEqualSpaced = F)
> > z.r <- brick('pr_Amon_GFDL-CM3_rcp45_r1i1p1_204101-204512.nc')
> > 
> > # get coordenates
> > lat.x <- ncvar_get(x.n,"lat")
> > lon.x <- ncvar_get(x.n,"lon")
> > coords.xn <- as.matrix(expand.grid(lon.x,lat.x))
> > coords.xr <- coordinates(x.r) # different order of the xy in netcdf4
> > lat.z <- ncvar_get(z.n,"lat")
> > lon.z <- ncvar_get(z.n,"lon")
> > coords.zn <- as.matrix(expand.grid(lon.z,lat.z))
> > coords.zr <- coordinates(z.r) # different order of the zz in netcdf4
> > 
> > # check the differences between the coordenates
> > diffLatLon <- function(x) {
> >  n <- length(x)-1
> >  v <- rep(NA, n)
> >  for(i in 1:n) {
> >    v[i] <- x[i] - x[i+1]
> >  }
> > return(v)
> > }
> > 
> > diffLatLon(lat.x)  # in this file only the first and last intervals differ
> > from the rest.
> > diffLatLon(lon.x) # the same interval in all longitudes
> > diffLatLon(lat.z)  # the same interval in all latitudes
> > diffLatLon(lon.z) # the same interval in all longitudes
> > 
> > # plot the average of the layers in raster
> > plot(mean(x.r))
> > plot(mean(z.r))
> > 
> > Best regards,
> > 
> > Frederico
> > 
> > On Thu, Aug 22, 2019 at 1:29 PM Edzer Pebesma <edzer.pebesma at uni-muenster.de>
> > wrote:
> > 
> >> Thanks!
> >> 
> >> stars::read_stars (GDAL) won't read coordinates or coordinate reference
> >> system from this file, confirmed by running gdalinfo on it.
> >> 
> >> stars::read_ncdf (installing stars from github) reads it like this:
> >> 
> >> library(stars)
> >> # Loading required package: abind
> >> # Loading required package: sf
> >> # Linking to GEOS 3.7.1, GDAL 2.4.2, PROJ 5.2.0
> >> (r0 = read_ncdf("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc"))
> >> # no 'var' specified, using pr
> >> # other available variables:
> >> #  average_DT, average_T1, average_T2, lat, lon, bnds, time, time_bnds,
> >> lat_bnds, lon_bnds
> >> # No projection information found in nc file.
> >> #  Coordinate variable units found to be degrees,
> >> #  assuming WGS84 Lat/Lon.
> >> # stars object with 3 dimensions and 1 attribute
> >> # attribute(s):
> >> #  pr [kg/m^2/s]
> >> #  Min.   :0.000e+00
> >> #  1st Qu.:6.035e-06
> >> #  Median :1.700e-05
> >> #  Mean   :2.799e-05
> >> #  3rd Qu.:3.575e-05
> >> #  Max.   :1.068e-03
> >> # dimension(s):
> >> #      from  to offset delta                       refsys point
> >> # lon     1 144     NA    NA +proj=longlat +datum=WGS8...    NA
> >> # lat     1  90     NA    NA +proj=longlat +datum=WGS8... FALSE
> >> # time    1  60     NA    NA                        PCICt FALSE
> >> #                                                   values
> >> # lon                              [0,2.5),...,[357.5,360) [x]
> >> # lat                    [-90,-88.98876),...,[88.98876,90) [y]
> >> # time [2041-01-01,2041-02-01),...,[2045-12-01,2046-01-01)
> >> st_get_dimension_values(r0, "lat") %>% diff %>% table
> >> # .
> >> # 1.51685393258427 2.02247191011234 2.02247191011236 2.02247191011237
> >> #                2                1               74               12
> >> 
> >> where essentially only the first and last intervals differ from the rest.
> >> 
> >> So, yes, latitudes are not regular. Also, time is PCICt, and uses a 365
> >> day calendar without leap years:
> >> 
> >> st_get_dimension_values(r0, "time") %>% diff %>% table
> >> # .
> >> # 28 30 31
> >> #  5 20 34
> >> 
> >> 
> >> 
> >> 
> >> 
> >> On 8/22/19 8:55 PM, Frederico Faleiro wrote:
> >>> Dear list,
> >>> sorry about the file. The files from the CMIP5 are public, but need a
> >>> registration first.
> >>> You can access the same file in any of these links:
> >>> https://www.sendspace.com/file/famgz3 and
> >>> 
> >> https://drive.google.com/file/d/1L1T03iQ6LU1yYRYeRypxwMB3E7fLjkJI/view?usp=sharing
> >>> .
> >>> 
> >>> In this meantime I will try the Mike' advices.
> >>> 
> >>> Best regards,
> >>> 
> >>> Frederico <https://www.sendspace.com/file/famgz3>
> >>> 
> >>> On Thu, Aug 22, 2019 at 3:41 PM Frederico Faleiro <fvfaleiro at gmail.com>
> >>> wrote:
> >>> 
> >>>> Dear list,
> >>>> 
> >>>> sorry about the file. The files from the CMIP5 are public, but need a
> >>>> registration first. I am sending the same file attached.
> >>>> 
> >>>> In this meantime I will try the Mike' advices.
> >>>> 
> >>>> Best regards,
> >>>> 
> >>>> Frederico
> >>>> 
> >>>> 
> >>>> 
> >>>> 
> >>>> 
> >>>> On Thu, Aug 22, 2019 at 5:03 AM Michael Sumner <mdsumner at gmail.com>
> >> wrote:
> >>>> 
> >>>>> raster does the wrong thing here in my opinion, the right outcome is to
> >>>>> give a grid in index-extent (0, ncol, 0, nrow) and with no projection
> >>>>> metadata (crs). There will be coordinate arrays in this file, and they
> >> need
> >>>>> to be handled as though they are data (with local, x*y dependent
> >> values in
> >>>>> every cell).
> >>>>> 
> >>>>> With brick() you can proceed to process the data with no problem (using
> >>>>> stopIfNotEqualSpaced = FALSE), but you can't rely on the extent being
> >>>>> relevant, or any function that works in geographic space to do the
> >> right
> >>>>> thing. To map a layer of these data you might try
> >>>>> 
> >>>>> grd <- raster(yourfile, stopIfNotEqualSpaced = FALSE)
> >>>>> coords <- brick(raster(yourfile, varname = "lon"),
> >>>>>                         raster(yourfile, varname = "lat"))   ## but
> >> only
> >>>>> you will know the names of these variables values "lon", "lat" (might
> >> be
> >>>>> "TLON", "TLAT" ? )
> >>>>> 
> >>>>> In quadmesh there is a way to plot in geographic space that's not
> >>>>> impossibly slow (possibly the coords will need a re-orientation
> >> transpose
> >>>>> ...):
> >>>>> 
> >>>>> quadmesh::mesh_plot(grd, coords = coords)
> >>>>> 
> >>>>> It's likely that will "map" it properly, but CMIP is likely to wrap
> >>>>> around an odd longitude (or something), and so cropping to your area
> >> and/or
> >>>>> choosing a good project for the crs argument to mesh_plot is probably
> >>>>> needed.  You can investigate with plot(coords[[1]]) and
> >> plot(coords[[2]])
> >>>>> to get a sense of their layout.
> >>>>> 
> >>>>> In the stars package this is all internalized, with
> >>>>> stars::read_stars(yourfile) catching all the information required as
> >> much
> >>>>> as possible, and with plotting methods - but variable choice and actual
> >>>>> results vary widely, and depend a lot on very specific details.
> >> (angstroms
> >>>>> package has similar helpers for the approach but is unlikely to help
> >> here
> >>>>> without access to the file to try)
> >>>>> 
> >>>>> To help us guess further you can use the "ncdump" output, raster will
> >>>>> print this with
> >>>>> 
> >>>>> print(raster("yourfile"))
> >>>>> 
> >>>>> and from that we could provide better guesses at variable names and
> >>>>> subsetting etc.
> >>>>> 
> >>>>> But, as Edzer asked, nothing is as good as having the file - any chance
> >>>>> you can share it?  (Personally I think the world rather needs more R
> >>>>> attention on climate model output.)
> >>>>> 
> >>>>> Cheers, Mike.
> >>>>> 
> >>>>> On Thu, Aug 22, 2019 at 1:53 PM Frederico Faleiro <fvfaleiro at gmail.com
> >>> 
> >>>>> wrote:
> >>>>>> 
> >>>>>> Dear list,
> >>>>>> 
> >>>>>> I am using some  netCDF files from the CMIP5 climate models in raster
> >>>>>> package, but I am having some issues with one model.
> >>>>>> The netCDF file from the GFDL-ESM2G model (e.g.
> >>>>>> 
> >>>>> 
> >> http://aims3.llnl.gov/thredds/fileServer/css03_data/cmip5/output1/NOAA-GFDL/GFDL-ESM2G/rcp45/mon/atmos/Amon/r1i1p1/v20120412/pr/pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc
> >>>>>> )
> >>>>>> have the error message as in bellow example.
> >>>>>> 
> >>>>>> #Example
> >>>>>> library(raster)
> >>>>>> s1 <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc")
> >>>>>> Error in .rasterObjectFromCDF(x, type = objecttype, band = band, ...)
> >> :
> >>>>>>  cells are not equally spaced; you should extract values as points
> >>>>>> 
> >>>>>> # I check some solutions that recomend force read the file with the
> >>>>>> argument "stopIfNotEqualSpaced = F" as bellow.
> >>>>>> sf <- stack("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> >>>>>> *stopIfNotEqualSpaced
> >>>>>> = F*)
> >>>>>> bf <- brick("pr_Amon_GFDL-ESM2G_rcp45_r1i1p1_204101-204512.nc",
> >>>>>> *stopIfNotEqualSpaced
> >>>>>> = F*)
> >>>>>> 
> >>>>>> I performed some tests and only "works" with brick. However I did not
> >>>>> find
> >>>>>> any solution to check where is the problem and fix it in the file.
> >>>>>> 
> >>>>>> How can I check if it is really an issue and fix it?
> >>>>>> 
> >>>>>> sessionInfo()
> >>>>>> R version 3.5.1 (2018-07-02)
> >>>>>> Platform: x86_64-w64-mingw32/x64 (64-bit)
> >>>>>> Running under: Windows 10 x64 (build 18362)
> >>>>>> 
> >>>>>> Matrix products: default
> >>>>>> 
> >>>>>> locale:
> >>>>>> [1] LC_COLLATE=Portuguese_Brazil.1252  LC_CTYPE=Portuguese_Brazil.1252
> >>>>>> [3] LC_MONETARY=Portuguese_Brazil.1252 LC_NUMERIC=C
> >>>>>> [5] LC_TIME=Portuguese_Brazil.1252
> >>>>>> 
> >>>>>> attached base packages:
> >>>>>> [1] stats     graphics  grDevices utils     datasets  methods   base
> >>>>>> 
> >>>>>> other attached packages:
> >>>>>> [1] raster_2.8-19 sp_1.3-1
> >>>>>> 
> >>>>>> loaded via a namespace (and not attached):
> >>>>>> [1] compiler_3.5.1   rgdal_1.4-3      Rcpp_1.0.1
> >> codetools_0.2-15
> >>>>>> ncdf4_1.16.1
> >>>>>> [6] grid_3.5.1       lattice_0.20-35
> >>>>>> 
> >>>>>> Best regards,
> >>>>>> 
> >>>>>> Frederico
> >>>>>> 
> >>>>>>        [[alternative HTML version deleted]]
> >>>>>> 
> >>>>>> _______________________________________________
> >>>>>> R-sig-Geo mailing list
> >>>>>> R-sig-Geo at r-project.org
> >>>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>>>> 
> >>>>> 
> >>>>> 
> >>>>> --
> >>>>> Michael Sumner
> >>>>> Software and Database Engineer
> >>>>> Australian Antarctic Division
> >>>>> Hobart, Australia
> >>>>> e-mail: mdsumner at gmail.com
> >>>>> 
> >>>> 
> >>> 
> >>>      [[alternative HTML version deleted]]
> >>> 
> >>> _______________________________________________
> >>> R-sig-Geo mailing list
> >>> R-sig-Geo at r-project.org
> >>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>> 
> >> 
> >> --
> >> Edzer Pebesma
> >> Institute for Geoinformatics
> >> Heisenbergstrasse 2, 48151 Muenster, Germany
> >> Phone: +49 251 8333081
> >> _______________________________________________
> >> R-sig-Geo mailing list
> >> R-sig-Geo at r-project.org
> >> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >> 
> > 
> >       [[alternative HTML version deleted]]
> > 
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> 
> **********************
> "The contents of this message do not reflect any position of the U.S. Government or NOAA."
> **********************
> Roy Mendelssohn
> Supervisory Operations Research Analyst
> NOAA/NMFS
> Environmental Research Division
> Southwest Fisheries Science Center
> ***Note new street address***
> 110 McAllister Way
> Santa Cruz, CA 95060
> Phone: (831)-420-3666
> Fax: (831) 420-3980
> e-mail: Roy.Mendelssohn at noaa.gov www: https://www.pfeg.noaa.gov/
> 
> "Old age and treachery will overcome youth and skill."
> "From those who have been given much, much will be expected" 
> "the arc of the moral universe is long, but it bends toward justice" -MLK Jr.
> 

**********************
"The contents of this message do not reflect any position of the U.S. Government or NOAA."
**********************
Roy Mendelssohn
Supervisory Operations Research Analyst
NOAA/NMFS
Environmental Research Division
Southwest Fisheries Science Center
***Note new street address***
110 McAllister Way
Santa Cruz, CA 95060
Phone: (831)-420-3666
Fax: (831) 420-3980
e-mail: Roy.Mendelssohn at noaa.gov www: https://www.pfeg.noaa.gov/

"Old age and treachery will overcome youth and skill."
"From those who have been given much, much will be expected" 
"the arc of the moral universe is long, but it bends toward justice" -MLK Jr.


From eg@mp@du @end|ng |rom gm@||@com  Fri Aug 23 12:17:26 2019
From: eg@mp@du @end|ng |rom gm@||@com (Enoch Gyamfi Ampadu)
Date: Fri, 23 Aug 2019 12:17:26 +0200
Subject: [R-sig-Geo] Splitting polygon dataset
Message-ID: <CAC4+n+yWN-+cX1AO6jgKFZLcoXXJqM0r4SV5tLZPLdMWHbZL0Q@mail.gmail.com>

Dear List,

Please I have been implementing Random Forest in R for the to classify
forest cover. I am doing it for 4 main classes. I Have extracted the pixel
values of the bands with that of the training polygons. In all I had 226
observations and the 8 bands as the response variables.

I tried to split it into 70% for training set and 30% for as testing set
sing the codes below;

#setting training and testing samples
set.seed(999)

id <- sample(2, nrow(dfTrainshape), prob = C(0.7, 0.3), replace = TRUE)
dfTrainshape_train <- dfTrainshape[id==1,]
dfTrainshape_test <- dfTrainshape[id==2,]

I had the error below;

set.seed(999)
> id <- sample(2, nrow(dfTrainshape), prob = C(0.7, 0.3), replace = TRUE)
Error in C(0.7, 0.3) : object not interpretable as a factor
> dfTrainshape_train <- dfTrainshape[id==1,]
Error in `[.data.frame`(dfTrainshape, id == 1, ) : object 'id' not found

I will be glad to have some advice and probable some code to assist me.

Secondly,

Please I also want to create a separate testing polygons for the validation
in ArcMap. I want to know how I will be able to use the 226 observations of
the earlier set of polygons for the training and the new polygons for
validation. I will be glad to have some codes which I can change to suite
what I want to do.

Hope to hear from you.

Best regards,

Enoch


-- 
*Enoch Gyamfi - Ampadu*

*Geography & Environmental Sciences*

*College of Agriculture, Engineering & Science*

*University of KwaZulu-Natal, Westville Campus*

*Private Bag X54001*
*Durban, South Africa **? 4000**.*
*Phone: +27 835 828255*

*email: egampadu at gmail.com <egampadu at gmail.com>*


*skype: enoch.ampadu*
*The highest evidence of nobility is self-control*.

*A simple act of kindness creates an endless ripple*.

	[[alternative HTML version deleted]]


From b|@|ev||@t @end|ng |rom gm@||@com  Fri Aug 23 12:26:22 2019
From: b|@|ev||@t @end|ng |rom gm@||@com (=?UTF-8?Q?Bede-Fazekas_=c3=81kos?=)
Date: Fri, 23 Aug 2019 12:26:22 +0200
Subject: [R-sig-Geo] Splitting polygon dataset
In-Reply-To: <CAC4+n+yWN-+cX1AO6jgKFZLcoXXJqM0r4SV5tLZPLdMWHbZL0Q@mail.gmail.com>
References: <CAC4+n+yWN-+cX1AO6jgKFZLcoXXJqM0r4SV5tLZPLdMWHbZL0Q@mail.gmail.com>
Message-ID: <ca1db3fb-5c3d-368a-35e1-b8e070dd6a57@gmail.com>

Dear Enoch,

There is a typo in your code that causes the error: function c() is not 
equivalent of C().
Solution:
id <- sample(2, nrow(dfTrainshape), prob = c(0.7, 0.3), replace = TRUE)

HTH,
?kos Bede-Fazekas
Hungarian Academy of Sciences

2019.08.23. 12:17 keltez?ssel, Enoch Gyamfi Ampadu ?rta:
> Dear List,
>
> Please I have been implementing Random Forest in R for the to classify
> forest cover. I am doing it for 4 main classes. I Have extracted the pixel
> values of the bands with that of the training polygons. In all I had 226
> observations and the 8 bands as the response variables.
>
> I tried to split it into 70% for training set and 30% for as testing set
> sing the codes below;
>
> #setting training and testing samples
> set.seed(999)
>
> id <- sample(2, nrow(dfTrainshape), prob = C(0.7, 0.3), replace = TRUE)
> dfTrainshape_train <- dfTrainshape[id==1,]
> dfTrainshape_test <- dfTrainshape[id==2,]
>
> I had the error below;
>
> set.seed(999)
>> id <- sample(2, nrow(dfTrainshape), prob = C(0.7, 0.3), replace = TRUE)
> Error in C(0.7, 0.3) : object not interpretable as a factor
>> dfTrainshape_train <- dfTrainshape[id==1,]
> Error in `[.data.frame`(dfTrainshape, id == 1, ) : object 'id' not found
>
> I will be glad to have some advice and probable some code to assist me.
>
> Secondly,
>
> Please I also want to create a separate testing polygons for the validation
> in ArcMap. I want to know how I will be able to use the 226 observations of
> the earlier set of polygons for the training and the new polygons for
> validation. I will be glad to have some codes which I can change to suite
> what I want to do.
>
> Hope to hear from you.
>
> Best regards,
>
> Enoch
>
>


From m@|k@r@ @end|ng |rom y@ndex@com  Tue Aug 27 21:45:46 2019
From: m@|k@r@ @end|ng |rom y@ndex@com (Fatih Kara)
Date: Tue, 27 Aug 2019 20:45:46 +0100
Subject: [R-sig-Geo] Data conversion
Message-ID: <32040021566935146@sas1-02732547ccc0.qloud-c.yandex.net>

Hi, 

I have a very simple problem which I couldn't solve nowadays: I can't convert '.hdf' files to '.tif' files.

I use this code: 

install.packages("raster",dependencies = TRUE)
install.packages("rgdal",dependencies = TRUE)
install.packages("rgeos",dependencies = TRUE)
install.packages("sp",dependencies = TRUE)
install.packages("lwgeom", dependencies = TRUE)
library(raster)
library(lwgeom)
library(maptools)
library(rgdal)
library(gdalUtils)

subsets <- gdalUtils::get_subdatasets("modisndvi.hdf"[1])
gdalUtils::gdal_translate(src_dataset = subsets[1], dst_dataset = "modisndvi.tiff")

NULL

What can I do?

-- 
Fatih Kara


From @@r@h@go@|ee @end|ng |rom gm@||@com  Wed Aug 28 15:15:00 2019
From: @@r@h@go@|ee @end|ng |rom gm@||@com (Sarah Goslee)
Date: Wed, 28 Aug 2019 09:15:00 -0400
Subject: [R-sig-Geo] Data conversion
In-Reply-To: <32040021566935146@sas1-02732547ccc0.qloud-c.yandex.net>
References: <32040021566935146@sas1-02732547ccc0.qloud-c.yandex.net>
Message-ID: <CAM_vjumXzmXsN_CaeDpAzpHnrmaWAf51fO801SyR+fLG0Srj9A@mail.gmail.com>

Hi,

gdal_translate() by default returns NULL, but also writes your
destination tiff to the specified location, in this case
modisndvi.tiff in your working directory. Is that file not created?

>From ?gdal_translate:

Value:
     NULL or if(output_Raster), a RasterBrick.

So what you're seeing is exactly what I'd expect if everything worked
perfectly. Your commands don't load anything into R. If that's your
goal, you could set output_Raster=TRUE.

Here's an actual reproducible example.

library(rgdal)
library(gdalUtils)

hdf4_dataset <- system.file("external/test_modis.hdf", package="gdalUtils")
all.subsets <- get_subdatasets(hdf4_dataset)

# returns NULL as expected
gdalUtils::gdal_translate(src_dataset = all.subsets[1], dst_dataset =
"testfile.tiff")

# shows testfile.tiff in the working directory, as expected
list.files(pattern=".tiff")


If that reproducible example does not work on your system, and
testfile.tiff is not created, then we need more information, like the
output of sessionInfo(), and confirmation that you have a correctly
installed GDAL.

Sarah

On Tue, Aug 27, 2019 at 3:46 PM Fatih Kara <msfkara at yandex.com> wrote:
>
> Hi,
>
> I have a very simple problem which I couldn't solve nowadays: I can't convert '.hdf' files to '.tif' files.
>
> I use this code:
>
> install.packages("raster",dependencies = TRUE)
> install.packages("rgdal",dependencies = TRUE)
> install.packages("rgeos",dependencies = TRUE)
> install.packages("sp",dependencies = TRUE)
> install.packages("lwgeom", dependencies = TRUE)
> library(raster)
> library(lwgeom)
> library(maptools)
> library(rgdal)
> library(gdalUtils)
>
> subsets <- gdalUtils::get_subdatasets("modisndvi.hdf"[1])
> gdalUtils::gdal_translate(src_dataset = subsets[1], dst_dataset = "modisndvi.tiff")
>
> NULL
>
> What can I do?
>
> --
> Fatih Kara
>

-- 
Sarah Goslee (she/her)
http://www.numberwright.com


