From @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br  Wed May  8 01:49:21 2024
From: @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br (Alexandre Santos)
Date: Tue, 7 May 2024 23:49:21 +0000 (UTC)
Subject: [R-sig-Geo] as.im in spatstat::ppm not working as before
References: <1909033753.55613.1715125761625.ref@mail.yahoo.com>
Message-ID: <1909033753.55613.1715125761625@mail.yahoo.com>

Dear Members,

I'll calculate some old codes for a paper review, and I'm astonished that as.im() for fitting the Poisson model is not working as before. In my example:

library(raster)
library(spatstat)


# Elevation
r.grid.world <- raster('https://raw.githubusercontent.com/Leprechault/trash/main/wc2.1_10m_elev.tif')
proj4string(r.grid.world) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
r.grid.world.SGDF.F <- as(r.grid.world, "SpatialGridDataFrame")


#Fitting Poisson model
fit.c <- ppm(nztrees, ~ elev,
covariates=list(elev=as.im(r.grid.world.SGDF.F[[1]])))
#
# Error in as.im.default(r.grid.world.SGDF.F[[1]]) : 
# ? Can't convert X to a pixel image

I tried as matrix and rotate, and the final real-valued pixel image didn't work as a covariate in the model.?

Please, any help with it?

Thanks in advance

Alexandre


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Wed May  8 09:21:31 2024
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Wed, 8 May 2024 09:21:31 +0200
Subject: [R-sig-Geo] as.im in spatstat::ppm not working as before
In-Reply-To: <1909033753.55613.1715125761625@mail.yahoo.com>
References: <1909033753.55613.1715125761625.ref@mail.yahoo.com>
 <1909033753.55613.1715125761625@mail.yahoo.com>
Message-ID: <d02c9618-2922-414b-8999-434a158967fb@uni-muenster.de>

r.grid.world.SGDF.F[[1]] is a numerical vector, not even a matrix, so 
clearly as.im.default doesn't know what it should do with it.

Maybe there was once a method as.im for r.grid.world.SGDF.F, which is of 
class SpatialGridDataFrame, but no longer - software evolves.

A way you could approach this is converting that object to a stars object:

 > library(stars)
Loading required package: abind
Loading required package: sf
Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
 > as.im(st_as_stars(r.grid.world.SGDF.F))
Error: Only projected coordinates may be converted to spatstat class objects

and that points you to another issue you have: spatstat works with data 
in Cartesian coordiantes (R2), not with geodetic coordinates (S2). So 
that's a helpful error message.


On 08/05/2024 01:49, Alexandre Santos via R-sig-Geo wrote:
> Dear Members,
> 
> I'll calculate some old codes for a paper review, and I'm astonished that as.im() for fitting the Poisson model is not working as before. In my example:
> 
> library(raster)
> library(spatstat)
> 
> 
> # Elevation
> r.grid.world <- raster('https://raw.githubusercontent.com/Leprechault/trash/main/wc2.1_10m_elev.tif')
> proj4string(r.grid.world) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
> r.grid.world.SGDF.F <- as(r.grid.world, "SpatialGridDataFrame")
> 
> 
> #Fitting Poisson model
> fit.c <- ppm(nztrees, ~ elev,
> covariates=list(elev=as.im(r.grid.world.SGDF.F[[1]])))
> #
> # Error in as.im.default(r.grid.world.SGDF.F[[1]]) :
> # ? Can't convert X to a pixel image
> 
> I tried as matrix and rotate, and the final real-valued pixel image didn't work as a covariate in the model.
> 
> Please, any help with it?
> 
> Thanks in advance
> 
> Alexandre
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Edzer Pebesma (he/him)
Universit?t M?nster, Institute for Geoinformatics
Heisenbergstrasse 2, 48149 M?nster, Germany
Phone: +49 251 8333081


From Roger@B|v@nd @end|ng |rom nhh@no  Wed May  8 11:40:39 2024
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Wed, 8 May 2024 09:40:39 +0000
Subject: [R-sig-Geo] as.im in spatstat::ppm not working as before
In-Reply-To: <d02c9618-2922-414b-8999-434a158967fb@uni-muenster.de>
References: <1909033753.55613.1715125761625.ref@mail.yahoo.com>
 <1909033753.55613.1715125761625@mail.yahoo.com>
 <d02c9618-2922-414b-8999-434a158967fb@uni-muenster.de>
Message-ID: <SV0P279MB0475C3977CE38395318EBC8AEEE52@SV0P279MB0475.NORP279.PROD.OUTLOOK.COM>

as.im() was in maptools, which was retired last year. If you need to recreate old work, install maptools from source from the CRAN package archive
https://cran.r-project.org/src/contrib/Archive/maptools/.

For non-archival work, update the workflow. See also https://github.com/r-spatial/evolution/issues/8.

Hope this clarifies,

Roger

---
Roger Bivand
Emeritus Professor
Department of Economics
Norwegian School of Economics, Bergen, Norway

________________________________
Fra: R-sig-Geo <r-sig-geo-bounces at r-project.org> p? vegne av Edzer Pebesma <edzer.pebesma at uni-muenster.de>
Sendt: onsdag, mai 8, 2024 9:28:54 a.m.
Til: r-sig-geo at r-project.org <r-sig-geo at r-project.org>
Emne: Re: [R-sig-Geo] as.im in spatstat::ppm not working as before

r.grid.world.SGDF.F[[1]] is a numerical vector, not even a matrix, so
clearly as.im.default doesn't know what it should do with it.

Maybe there was once a method as.im for r.grid.world.SGDF.F, which is of
class SpatialGridDataFrame, but no longer - software evolves.

A way you could approach this is converting that object to a stars object:

 > library(stars)
Loading required package: abind
Loading required package: sf
Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
 > as.im(st_as_stars(r.grid.world.SGDF.F))
Error: Only projected coordinates may be converted to spatstat class objects

and that points you to another issue you have: spatstat works with data
in Cartesian coordiantes (R2), not with geodetic coordinates (S2). So
that's a helpful error message.


On 08/05/2024 01:49, Alexandre Santos via R-sig-Geo wrote:
> Dear Members,
>
> I'll calculate some old codes for a paper review, and I'm astonished that as.im() for fitting the Poisson model is not working as before. In my example:
>
> library(raster)
> library(spatstat)
>
>
> # Elevation
> r.grid.world <- raster('https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fraw.githubusercontent.com%2FLeprechault%2Ftrash%2Fmain%2Fwc2.1_10m_elev.tif&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339842669%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=cyducyKF16yIdtfuykXUSifCR8clFtxDhiG1eY4waFU%3D&reserved=0<https://raw.githubusercontent.com/Leprechault/trash/main/wc2.1_10m_elev.tif>')
> proj4string(r.grid.world) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
> r.grid.world.SGDF.F <- as(r.grid.world, "SpatialGridDataFrame")
>
>
> #Fitting Poisson model
> fit.c <- ppm(nztrees, ~ elev,
> covariates=list(elev=as.im(r.grid.world.SGDF.F[[1]])))
> #
> # Error in as.im.default(r.grid.world.SGDF.F[[1]]) :
> #   Can't convert X to a pixel image
>
> I tried as matrix and rotate, and the final real-valued pixel image didn't work as a covariate in the model.
>
> Please, any help with it?
>
> Thanks in advance
>
> Alexandre
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339851113%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=LeMCUv%2F8%2FJCZFGehLYaPgDEGRfsPeZZbkV5aCia8l60%3D&reserved=0<https://stat.ethz.ch/mailman/listinfo/r-sig-geo>

--
Edzer Pebesma (he/him)
Universit?t M?nster, Institute for Geoinformatics
Heisenbergstrasse 2, 48149 M?nster, Germany
Phone: +49 251 8333081

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339856786%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=6H%2F9HQ%2BV1nyf2AdWabq0eoG3b8zqCQEC3ZC%2BFoRYvUI%3D&reserved=0<https://stat.ethz.ch/mailman/listinfo/r-sig-geo>


	[[alternative HTML version deleted]]


From v@|@v|@r @end|ng |rom gm@||@com  Sat May 11 10:21:34 2024
From: v@|@v|@r @end|ng |rom gm@||@com (Roozbeh Valavi)
Date: Sat, 11 May 2024 18:21:34 +1000
Subject: [R-sig-Geo] as.im in spatstat::ppm not working as before
In-Reply-To: <SV0P279MB0475C3977CE38395318EBC8AEEE52@SV0P279MB0475.NORP279.PROD.OUTLOOK.COM>
References: <1909033753.55613.1715125761625.ref@mail.yahoo.com>
 <1909033753.55613.1715125761625@mail.yahoo.com>
 <d02c9618-2922-414b-8999-434a158967fb@uni-muenster.de>
 <SV0P279MB0475C3977CE38395318EBC8AEEE52@SV0P279MB0475.NORP279.PROD.OUTLOOK.COM>
Message-ID: <CA+H-716wZ6Q1oWhmRpy=aK8MbEkgTucrFYcmZxeh4dCviuiAyA@mail.gmail.com>

This might also help:

library(spatstat)
library(terra)

.raster_to_im <- function(x){
        r <- as.data.frame(x, xy = TRUE)
         im <- spatstat.geom::as.im(r) return(im)
}

 # to generalise the spatstat.geom::as.im to SpatRaster and RasterLayer
as.im.SpatRaster <- function(x){ .raster_to_im(x) } as.im.RasterLayer <-
function(x){ .raster_to_im(x) }


I haven?t used it in a while so there might be a direct support in the
spatstat.geom now!


Roozbeh Valavi,
Biodiversity Modeller & Spatial Ecologist
Senior Research Scientist | CSIRO Environment, VIC, Australia
*Twitter*: @ValaviRoozbeh | ResearchGate
<https://www.researchgate.net/profile/Roozbeh-Valavi> | Google Scholar
<https://scholar.google.co.uk/citations?user=3m0jCHwAAAAJ&hl=en&oi=ao>


On Wed, 8 May 2024 at 7:41?PM, Roger Bivand <Roger.Bivand at nhh.no> wrote:

> as.im() was in maptools, which was retired last year. If you need to
> recreate old work, install maptools from source from the CRAN package
> archive
> https://cran.r-project.org/src/contrib/Archive/maptools/.
>
> For non-archival work, update the workflow. See also
> https://github.com/r-spatial/evolution/issues/8.
>
> Hope this clarifies,
>
> Roger
>
> ---
> Roger Bivand
> Emeritus Professor
> Department of Economics
> Norwegian School of Economics, Bergen, Norway
>
> ________________________________
> Fra: R-sig-Geo <r-sig-geo-bounces at r-project.org> p? vegne av Edzer
> Pebesma <edzer.pebesma at uni-muenster.de>
> Sendt: onsdag, mai 8, 2024 9:28:54 a.m.
> Til: r-sig-geo at r-project.org <r-sig-geo at r-project.org>
> Emne: Re: [R-sig-Geo] as.im in spatstat::ppm not working as before
>
> r.grid.world.SGDF.F[[1]] is a numerical vector, not even a matrix, so
> clearly as.im.default doesn't know what it should do with it.
>
> Maybe there was once a method as.im for r.grid.world.SGDF.F, which is of
> class SpatialGridDataFrame, but no longer - software evolves.
>
> A way you could approach this is converting that object to a stars object:
>
>  > library(stars)
> Loading required package: abind
> Loading required package: sf
> Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
>  > as.im(st_as_stars(r.grid.world.SGDF.F))
> Error: Only projected coordinates may be converted to spatstat class
> objects
>
> and that points you to another issue you have: spatstat works with data
> in Cartesian coordiantes (R2), not with geodetic coordinates (S2). So
> that's a helpful error message.
>
>
> On 08/05/2024 01:49, Alexandre Santos via R-sig-Geo wrote:
> > Dear Members,
> >
> > I'll calculate some old codes for a paper review, and I'm astonished
> that as.im() for fitting the Poisson model is not working as before. In
> my example:
> >
> > library(raster)
> > library(spatstat)
> >
> >
> > # Elevation
> > r.grid.world <- raster('
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fraw.githubusercontent.com%2FLeprechault%2Ftrash%2Fmain%2Fwc2.1_10m_elev.tif&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339842669%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=cyducyKF16yIdtfuykXUSifCR8clFtxDhiG1eY4waFU%3D&reserved=0
> <
> https://raw.githubusercontent.com/Leprechault/trash/main/wc2.1_10m_elev.tif
> >')
> > proj4string(r.grid.world) <- CRS("+proj=longlat +datum=WGS84 +no_defs
> +ellps=WGS84 +towgs84=0,0,0")
> > r.grid.world.SGDF.F <- as(r.grid.world, "SpatialGridDataFrame")
> >
> >
> > #Fitting Poisson model
> > fit.c <- ppm(nztrees, ~ elev,
> > covariates=list(elev=as.im(r.grid.world.SGDF.F[[1]])))
> > #
> > # Error in as.im.default(r.grid.world.SGDF.F[[1]]) :
> > #   Can't convert X to a pixel image
> >
> > I tried as matrix and rotate, and the final real-valued pixel image
> didn't work as a covariate in the model.
> >
> > Please, any help with it?
> >
> > Thanks in advance
> >
> > Alexandre
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> >
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339851113%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=LeMCUv%2F8%2FJCZFGehLYaPgDEGRfsPeZZbkV5aCia8l60%3D&reserved=0
> <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>
>
> --
> Edzer Pebesma (he/him)
> Universit?t M?nster, Institute for Geoinforma
> <https://www.google.com/maps/search/versit%C3%A4t+M%C3%BCnster,+Institute+for+Geoinforma?entry=gmail&source=g>
> tics
> Heisenbergstrasse 2, 48149 M?nster, Germany
> Phone: +49 251 8333081
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339856786%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=6H%2F9HQ%2BV1nyf2AdWabq0eoG3b8zqCQEC3ZC%2BFoRYvUI%3D&reserved=0
> <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>
>
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From kwekeu@ym@rd|o|c @end|ng |rom gm@||@com  Sat May 11 13:47:30 2024
From: kwekeu@ym@rd|o|c @end|ng |rom gm@||@com (=?UTF-8?Q?Aymard_Lo=C3=AFc_KWEKEU_KWEKEU?=)
Date: Sat, 11 May 2024 13:47:30 +0200
Subject: [R-sig-Geo] Dimensions problem when extracting latitude and
 longitude from shapefiles in multipolygon format in lambert 93 format
Message-ID: <CAL_d4CX-5_6TjR4Mn9YEEusCCkNCX-2GxoOW8z_ieo3yXM1SzQ@mail.gmail.com>

I want to extract the latitude and longitude from the shapefile and by
doing this I get a table with more lines than my shapefile.
Below is the corresponding code:
Sincerely :
> library(sf)> geo <-  sf::st_read("IRIS.shp")

Reading layer `IRIS' from data source

  `C:\M2_MAS_True\Stage_EHESP\QGIS\Shapefiles\IRIS.shp' using driver `ESRI
Shapefile'

Simple feature collection with 752 features and 127 fields

Geometry type: MULTIPOLYGON

Dimension:     XY

Bounding box:  xmin: 796251.5 ymin: 6485414 xmax: 868032.2 ymax: 6579885

Projected CRS: RGF93 v1 / Lambert-93

> hos <- geo[!sf::st_is_empty(geo), ]

> santrau <-cbind(hos, st_coordinates(st_centroid(hos$geometry)))

> sontrau <- subset(santrau, select=c(1:40))

> sentrau <- na.omit(sontrau)

sentrau$geometry

Geometry set for 728 features

Geometry type: MULTIPOLYGON

Dimension:     XY

Bounding box:  xmin: 796251.5 ymin: 6485414 xmax: 868032.2 ymax: 6579885

Projected CRS: RGF93 v1 / Lambert-93

First 5 geometries:

MULTIPOLYGON (((843189.6 6521551, 843200.6 6521...

MULTIPOLYGON (((844086.2 6514697, 844097.4 6514...

MULTIPOLYGON (((836376.1 6508104, 836377.4 6508...

MULTIPOLYGON (((847197.7 6510818, 847203.6 6510...

MULTIPOLYGON (((850244.7 6517918, 850248 651792...

> sentrau_wgs84 <- st_transform(sentrau, "+proj=longlat +datum=WGS84")

> coordinates <- st_coordinates(sentrau_wgs84)

> nrow(sentrau)

[1] 728

> nrow(coordinates)

[1] 239649

	[[alternative HTML version deleted]]


From z|v@n@k@r@m@n @end|ng |rom gm@||@com  Sat May 11 15:00:14 2024
From: z|v@n@k@r@m@n @end|ng |rom gm@||@com (Zivan Karaman)
Date: Sat, 11 May 2024 15:00:14 +0200
Subject: [R-sig-Geo] Dimensions problem when extracting latitude and
 longitude from shapefiles in multipolygon format in lambert 93 format
In-Reply-To: <CAL_d4CX-5_6TjR4Mn9YEEusCCkNCX-2GxoOW8z_ieo3yXM1SzQ@mail.gmail.com>
References: <CAL_d4CX-5_6TjR4Mn9YEEusCCkNCX-2GxoOW8z_ieo3yXM1SzQ@mail.gmail.com>
Message-ID: <FFF307A0-5CC7-4C2B-8801-788F77C30499@gmail.com>

Hi,

What you probably want is 
nrow(st_coordinates(st_centroid(sentrau))) 
which is equal to now(sentrau)

nrow(st_coordinates(sentrau))  is equal to sum(sapply(1:nrow(sentrau), FUN = function(i) nrow(st_coordinates(sentrau[i, ]))))
as sentrau is MULTIPOLYGON

Hope this helps.


> On 11 May 2024, at 13:47, Aymard Lo?c KWEKEU KWEKEU <kwekeuaymardloic at gmail.com> wrote:
> 
>> hos <- geo[!sf::st_is_empty(geo), ]
> 
>> santrau <-cbind(hos, st_coordinates(st_centroid(hos$geometry)))
> 
>> sontrau <- subset(santrau, select=c(1:40))
> 
>> sentrau <- na.omit(sontrau)
> 


	[[alternative HTML version deleted]]


From g||berto@c@m@r@ @end|ng |rom |npe@br  Sat May 11 16:12:35 2024
From: g||berto@c@m@r@ @end|ng |rom |npe@br (Gilberto Camara)
Date: Sat, 11 May 2024 11:12:35 -0300
Subject: [R-sig-Geo] SITS version 1.5.0
Message-ID: <075C6325-B4B4-4F3D-8FBA-361E654E9D2E@inpe.br>

Dear R-SIG-GEO 

We would like to inform you that version 1.5.0 of `sits` package in now on CRAN.

`sits` is an end-to-end, TRL 9, operationally-tested package for big Earth observation data analytics using satellite image time series and machine learning. Noteworthy upgrades in version 1.5.0 include:

(a) Support for Sentinel-1 and Sentinel-2 collections in Copernicus Data Space Ecosystem;
(b) Support for Sentinel-1-GRD and Sentinel-1-RTC collections in Microsoft Planetary Computer;
(c) Support for Digital Earth Africa products SENTINEL-1-RTC, LS5-SR, LS7-SR, LS9-SR, ALOS-PALSAR-MOSAIC, NDVI ANOMALY, DAILY CHIRPS, MONTHLY CHIRPS and DEM-30;
(d) Improved performance on GPU-based classification of deep learning models;
(e) Merging Sentinel-1 and Sentinel-2 data cubes;
(f) Include DTW distance when building self-organized maps (SOM) for training data quality control;
(g) New `sits_reduce()` function for multi-temporal statistics;
(h) New functions `sits_sampling_design()` and `sits_stratified_sampling()` to implement best practices for classification assessment based on the best practices proposed by Olofsson et al. (2014).

Documentation is available as an on-line book, available at https://e-sensing.github.io/sitsbook/. 

`sits` relies on the strong community spirit of the R community and in particular the r-spatial team. We acknowledge our debt to Edzer Pebesma (`sf/stars`), Marius Appel (`gdalcubes`), Robert Hijmans (`terra`), Tim Appelhans (`leafem`), Jakub Nowosad (`supercells`), and Martijn Tennekes (`tmap`). We are grateful for the work of Dirk Eddelbuettel (`Rcpp/RcppArmadillo`) and Ron Wehrens (`kohonen`). We are much indebted to Hadley Wickham for the tidyverse, Daniel Falbel for the `torch` and `luz` packages, and the RStudio team for package `leaflet`.  The CRAN team (Uwe Ligges and prof Ripley) has been very supportive.  We also thank Roger Bivand for his benign influence.

Without the commitment of the r-spatial community, development of `sits` would have been impossible. It is amazing and impressive how the packages of the r-spatial community fit seamlessly like LEGO blocks. Arguably, this is due to amazing consistency and capabilities of the `sf` package. It has become a sound basis for most other r-spatial packages, including `sits`. Kudos to Edzer and all contributors! 

Best regards
Gilberto
============================
Prof Dr Gilberto Camara
Senior Researcher
National Institute for Space Research (INPE), Brazil
https://gilbertocamara.org/
=============================


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Sat May 11 18:03:18 2024
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Sat, 11 May 2024 18:03:18 +0200
Subject: [R-sig-Geo] as.im in spatstat::ppm not working as before
In-Reply-To: <CA+H-716wZ6Q1oWhmRpy=aK8MbEkgTucrFYcmZxeh4dCviuiAyA@mail.gmail.com>
References: <1909033753.55613.1715125761625.ref@mail.yahoo.com>
 <1909033753.55613.1715125761625@mail.yahoo.com>
 <d02c9618-2922-414b-8999-434a158967fb@uni-muenster.de>
 <SV0P279MB0475C3977CE38395318EBC8AEEE52@SV0P279MB0475.NORP279.PROD.OUTLOOK.COM>
 <CA+H-716wZ6Q1oWhmRpy=aK8MbEkgTucrFYcmZxeh4dCviuiAyA@mail.gmail.com>
Message-ID: <c222101c-2da3-45d3-bb15-e7f0e8decbbe@uni-muenster.de>



On 11/05/2024 10:21, Roozbeh Valavi wrote:
> This might also help:

the solution below will not raise the error if x has geographic 
(unprojected) coordinates, a case for which you should not use spatstat.

> 
> library(spatstat)
> library(terra)
> 
> .raster_to_im <- function(x){
>  ? ? ? ? r <- as.data.frame(x, xy = TRUE)
>  ? ? ? ? ?im <- spatstat.geom::as.im <http://as.im>(r) return(im)
> }
> 
>  ?# to generalise the spatstat.geom::as.im <http://as.im> to SpatRaster 
> and RasterLayer
> as.im.SpatRaster <- function(x){ .raster_to_im(x) } as.im.RasterLayer <- 
> function(x){ .raster_to_im(x) }
> 
> 
> I haven?t used it in a while so there might be a direct support in the 
> spatstat.geom now!
> 
> 
> Roozbeh Valavi,
> Biodiversity Modeller & Spatial Ecologist
> Senior Research Scientist | CSIRO Environment, VIC, Australia
> *Twitter*:@ValaviRoozbeh | ResearchGate 
> <https://www.researchgate.net/profile/Roozbeh-Valavi> | Google Scholar 
> <https://scholar.google.co.uk/citations?user=3m0jCHwAAAAJ&hl=en&oi=ao>
> 
> 
> On Wed, 8 May 2024 at 7:41?PM, Roger Bivand <Roger.Bivand at nhh.no 
> <mailto:Roger.Bivand at nhh.no>> wrote:
> 
>     as.im <http://as.im>() was in maptools, which was retired last year.
>     If you need to recreate old work, install maptools from source from
>     the CRAN package archive
>     https://cran.r-project.org/src/contrib/Archive/maptools/
>     <https://cran.r-project.org/src/contrib/Archive/maptools/>.
> 
>     For non-archival work, update the workflow. See also
>     https://github.com/r-spatial/evolution/issues/8
>     <https://github.com/r-spatial/evolution/issues/8>.
> 
>     Hope this clarifies,
> 
>     Roger
> 
>     ---
>     Roger Bivand
>     Emeritus Professor
>     Department of Economics
>     Norwegian School of Economics, Bergen, Norway
> 
>     ________________________________
>     Fra: R-sig-Geo <r-sig-geo-bounces at r-project.org
>     <mailto:r-sig-geo-bounces at r-project.org>> p? vegne av Edzer Pebesma
>     <edzer.pebesma at uni-muenster.de <mailto:edzer.pebesma at uni-muenster.de>>
>     Sendt: onsdag, mai 8, 2024 9:28:54 a.m.
>     Til: r-sig-geo at r-project.org <mailto:r-sig-geo at r-project.org>
>     <r-sig-geo at r-project.org <mailto:r-sig-geo at r-project.org>>
>     Emne: Re: [R-sig-Geo] as.im <http://as.im> in spatstat::ppm not
>     working as before
> 
>     r.grid.world.SGDF.F[[1]] is a numerical vector, not even a matrix, so
>     clearly as.im.default doesn't know what it should do with it.
> 
>     Maybe there was once a method as.im <http://as.im> for
>     r.grid.world.SGDF.F, which is of
>     class SpatialGridDataFrame, but no longer - software evolves.
> 
>     A way you could approach this is converting that object to a stars
>     object:
> 
>      ?> library(stars)
>     Loading required package: abind
>     Loading required package: sf
>     Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
>      ?> as.im <http://as.im>(st_as_stars(r.grid.world.SGDF.F))
>     Error: Only projected coordinates may be converted to spatstat class
>     objects
> 
>     and that points you to another issue you have: spatstat works with data
>     in Cartesian coordiantes (R2), not with geodetic coordinates (S2). So
>     that's a helpful error message.
> 
> 
>     On 08/05/2024 01:49, Alexandre Santos via R-sig-Geo wrote:
>      > Dear Members,
>      >
>      > I'll calculate some old codes for a paper review, and I'm
>     astonished that as.im <http://as.im>() for fitting the Poisson model
>     is not working as before. In my example:
>      >
>      > library(raster)
>      > library(spatstat)
>      >
>      >
>      > # Elevation
>      > r.grid.world <-
>     raster('https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fraw.githubusercontent.com%2FLeprechault%2Ftrash%2Fmain%2Fwc2.1_10m_elev.tif&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339842669%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=cyducyKF16yIdtfuykXUSifCR8clFtxDhiG1eY4waFU%3D&reserved=0 <https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fraw.githubusercontent.com%2FLeprechault%2Ftrash%2Fmain%2Fwc2.1_10m_elev.tif&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339842669%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=cyducyKF16yIdtfuykXUSifCR8clFtxDhiG1eY4waFU%3D&reserved=0><https://raw.githubusercontent.com/Leprechault/trash/main/wc2.1_10m_elev.tif <https://raw.githubusercontent.com/Leprechault/trash/main/wc2.1_10m_elev.tif>>')
>      > proj4string(r.grid.world) <- CRS("+proj=longlat +datum=WGS84
>     +no_defs +ellps=WGS84 +towgs84=0,0,0")
>      > r.grid.world.SGDF.F <- as(r.grid.world, "SpatialGridDataFrame")
>      >
>      >
>      > #Fitting Poisson model
>      > fit.c <- ppm(nztrees, ~ elev,
>      > covariates=list(elev=as.im <http://as.im>(r.grid.world.SGDF.F[[1]])))
>      > #
>      > # Error in as.im.default(r.grid.world.SGDF.F[[1]]) :
>      > #? ?Can't convert X to a pixel image
>      >
>      > I tried as matrix and rotate, and the final real-valued pixel
>     image didn't work as a covariate in the model.
>      >
>      > Please, any help with it?
>      >
>      > Thanks in advance
>      >
>      > Alexandre
>      >
>      > _______________________________________________
>      > R-sig-Geo mailing list
>      > R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
>      >
>     https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339851113%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=LeMCUv%2F8%2FJCZFGehLYaPgDEGRfsPeZZbkV5aCia8l60%3D&reserved=0 <https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339851113%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=LeMCUv%2F8%2FJCZFGehLYaPgDEGRfsPeZZbkV5aCia8l60%3D&reserved=0><https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>>
> 
>     --
>     Edzer Pebesma (he/him)
>     Universit?t M?nster, Institute for Geoinforma
>     <https://www.google.com/maps/search/versit%C3%A4t+M%C3%BCnster,+Institute+for+Geoinforma?entry=gmail&source=g>tics
>     Heisenbergstrasse 2, 48149 M?nster, Germany
>     Phone: +49 251 8333081
> 
>     _______________________________________________
>     R-sig-Geo mailing list
>     R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
>     https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339856786%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=6H%2F9HQ%2BV1nyf2AdWabq0eoG3b8zqCQEC3ZC%2BFoRYvUI%3D&reserved=0 <https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C02%7CRoger.Bivand%40nhh.no%7Cd2a2b64634a7462f860708dc6f3082d5%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638507501339856786%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=6H%2F9HQ%2BV1nyf2AdWabq0eoG3b8zqCQEC3ZC%2BFoRYvUI%3D&reserved=0><https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>>
> 
> 
>      ? ? ? ? [[alternative HTML version deleted]]
> 
>     _______________________________________________
>     R-sig-Geo mailing list
>     R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
>     https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>     <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>
> 

-- 
Edzer Pebesma (he/him)
Universit?t M?nster, Institute for Geoinformatics
Heisenbergstrasse 2, 48149 M?nster, Germany
Phone: +49 251 8333081

From m@p|no|@10 @end|ng |rom gm@||@com  Sat May 11 18:44:23 2024
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Sat, 11 May 2024 10:44:23 -0600
Subject: [R-sig-Geo] Modelling land use/land cover under climate change
 scenarios
Message-ID: <CABkCotRhgk12J7QF6P6WCLY521otMKDN8GY7aEAOsfr8THJSpw@mail.gmail.com>

Dear list members,

Is there a way in R or an R example code to model land use/land cover under
climate change scenario.



*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Sitio web institucional: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Sitio web personal: Sitio personal <https://mspinola-sitioweb.netlify.app>
Blog sobre Ciencia de Datos: Blog de Ciencia de Datos
<https://mspinola-ciencia-de-datos.netlify.app>

	[[alternative HTML version deleted]]


From n|ko@@tz|ok@@ @end|ng |rom gm@||@com  Sat May 11 19:25:54 2024
From: n|ko@@tz|ok@@ @end|ng |rom gm@||@com (Nikolaos Tziokas)
Date: Sat, 11 May 2024 20:25:54 +0300
Subject: [R-sig-Geo] Find the optimal model using step wise linear regression
Message-ID: <CAGg5H0YYxxf-pt0t5NW_rcMUn2Um3GUp8toKeTgXAfBO+L50Vg@mail.gmail.com>

I have a sf object with 2 columns, named fclass and geometry. I am
interested in the fclass column. The fclass has several unique values. I
convert this sf object to spatraster, I resample it and I perform a linear
regression where I use another spatraster, called ntl, as my response
(lm(ntl ~ road)).

My goal is to find which unique values give the largest r-squared in the lm
model using stepwise linear regression whith backward elimination. My
initial try was:

library(pacman)
pacman::p_load(terra, sf, dplyr)

ntl <- rast("path/ntl.tif") # response

v <- st_read("path/road17.shp") # sf object

# baseline r2
vterra <- vect(v)

ref <- rast("path/pop.tif") # get ext and pixel size

r <- rast(v, res = res(ref), ext = ext(ref))

x <- rasterizeGeom(vterra, r, "length", "m")

x_res <- resample(x, ntl, "average")

s <- c(ntl, x_res)
names(s) <- c("ntl", "road")

m <- lm(ntl ~ road, s, na.action = na.exclude)
baseline <- sqrt(summary(m)$adj.r.squared)
orig_baseline <- sqrt(summary(m)$adj.r.squared)

classes <- unique(v$fclass)
inclasses <- unique(v$fclass)

i <- 1
while (i <= length(classes)) {
  class <- classes[i]
  print(paste0("current class ", class))
  print(paste0("orig baseline: ", orig_baseline, " - baseline: ", baseline))
  print(classes)

  v_filtered <- v[v$fclass != class, ]
  vterra <- vect(v_filtered)
  r <- rast(v, res = res(ref), ext = ext(ref))
  x <- rasterizeGeom(vterra, r, "length", "m")

  x_res <- resample(x, ntl, "average")

  s <- c(ntl, x_res)
  names(s) <- c("ntl", "road")

  m <- lm(ntl ~ road, s, na.action = na.exclude)
  class_r2 <- sqrt(summary(m)$adj.r.squared)

  if (class_r2 > baseline) {
    classes <- classes[-i]
    baseline <- class_r2
  } else {
    print("class_r2 is less than baseline")
    print(paste0("class_r2: ", class_r2, " - baseline: ", baseline))
    i <- i + 1
  }
}
but it's not efficient (it takes ~ 5 minutes).

I have found the MASS package which has the lmStepAIC function but I am not
sure how to select the unique values from the fclass column to use as
predictiors.

head(v, 6)
Simple feature collection with 6 features and 1 field
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: 598675.9 ymin: 7111459 xmax: 609432.8 ymax: 7118729
Projected CRS: WGS 84 / UTM zone 35S
         fclass                       geometry
1     secondary MULTILINESTRING ((598675.9 ...
2     secondary MULTILINESTRING ((600641.7 ...
3   residential MULTILINESTRING ((601734.8 ...
4   residential MULTILINESTRING ((601163.9 ...
5   residential MULTILINESTRING ((601104.2 ...
6 motorway_link MULTILINESTRING ((609432.8 ...

The unique values in the fclass column:

unique(v$fclass)
 [1] "secondary"      "residential"    "motorway_link"  "service"
 "primary"        "unclassified"   "motorway"
 [8] "tertiary"       "trunk"          "primary_link"   "footway"
 "track"          "secondary_link" "unknown"
[15] "living_street"  "pedestrian"     "path"           "bridleway"
 "steps"          "trunk_link"     "track_grade1"
[22] "track_grade3"   "track_grade5"   "cycleway"       "track_grade4"
"tertiary_lin

The dataset can be downloaded from my GoogleDrive
<https://drive.google.com/drive/folders/1a0Khhej4koA0uhYTrQmqmMg02qfRWbjt?usp=drive_link>
.

Thank you.

-- 
Tziokas Nikolaos
Cartographer

Tel:(+44)07561120302
LinkedIn <http://linkedin.com/in/nikolaos-tziokas-896081130>

	[[alternative HTML version deleted]]


From m@rt@@m@ru||no @end|ng |rom gm@||@com  Mon May 13 12:56:16 2024
From: m@rt@@m@ru||no @end|ng |rom gm@||@com (Marta Rufino)
Date: Mon, 13 May 2024 11:56:16 +0100
Subject: [R-sig-Geo] add spatraster layers by matching a dataframe column
 and make spatio-temporal rast
Message-ID: <CAKSASLCNE1rtZTQn7SZ780SLG8NxjbGqnXUCu-5sMm9_yXDU4g@mail.gmail.com>

Hi,

I would like to add layers to a spatraster (terra), by matching (joining) a
column in a data frame with the values of the raster layer (A).
Then, I would like to make it a spatio-temporal terra spatraster and/or a
stars (B).

Any help will be strongly appreciated,
Kind regards,
M.
________________________________________
 require(terra)

# A)

# runnable example
# Make an example raster:
  r = terra::rast(ncols=10, nrows=10)
  values(r) <- 1:100
  names(r)="ID"
  # add some missing values (to make it real)
  r[c(2,43,60,94)]=NA
  plot(r)

  # Make an example data frame (note both have an ID col to match)
  d <- data.frame(
    ID=100:1,
    k=c("aa","bb"),
    e=rnorm(100,2),
    year=sample(2001:2002, 100, replace = TRUE),
    date= as.Date(rep(c("2010-01-01", "2012-02-01",
"2010-03-01","2010-04-01"), l=100)))
  head(d)

# My tries:

  # 1. This works, but only for one col and it is not so nice:
  r$year2 <- d$year[match(as.vector(r$ID), d$ID)]
  plot(r)

  # 2. try it using app function: I could not make it work
  kk1 <- function(i,j=d) {
      j[match(as.vector(i$ID), j$ID),]
    }
  app(r, fun = kk1)

  # 3. try it using classify function
  # works with numeric (not characters) but it is not perfect
  terra::classify(r, d) # error
  # two numeric cols: works, but add the second col as the first raster
col. Not ok.
  terra::classify(r, d[,c(1,3)])
  # excluding the character col: gives an error
  terra::classify(r, d[,-c(2)])

  # 4. try it using merge function
  terra::merge(r, d) %>% head() #not sure what he did and in which order :(
but clearly not match/join working properly

  # 5. only (not elegant) way I managed:
  rast(
    left_join(
      as_tibble(r, xy=TRUE), d, by="ID"), type="xyz", crs = "EPSG:4326")
%>% plot()

# B) Make terra r raster a spatiotemporal cube

# 1.
#
https://stackoverflow.com/questions/74079441/group-raster-files-by-week-month
terra::time(r, tstep="years") <- d$year
# gives an error...
# Error: [time<-] length(value) != nlyr(x)

# 2.
#
https://stackoverflow.com/questions/74934891/specifying-layers-when-using-rast-type-xyz-to-convert-data-frame-to-spatra
# but I think this is not really a spatio-temporal rast...
d2 <- left_join(as_tibble(r, xy=TRUE), d, by=c("ID"))
w <- reshape(d2, timevar="year", idvar=c("x", "y"), direction="wide")
x <- rast(w, type="xyz")

# by year
d3 <- split(d2[,-7], d2$year)
r2 <- lapply(d3, \(i) rast(i, type="xyz"))
(r2 <- rast(r2))
time(r2) <- as.Date(names(r2))
plot(r2)

# plot with rasterVis
require(rasterVis)
levelplot(r2)


# 2. using stars (aternative)
# sources:
https://stackoverflow.com/questions/77368957/how-to-transform-a-sf-table-to-a-stars-cube-with-starsst-as-stars-function
# (
https://gis.stackexchange.com/questions/353741/generate-a-stars-object-from-tabular-spatial-temporal-data
):

s <- st_as_stars(as.data.frame(r, xy = TRUE, na.rm = TRUE), dims = c("x",
"y", "year"), crs = 4326)
s %>% plot(axes=TRUE)
# but the from and to of the year are wrong
# How to change to spatrast again?

	[[alternative HTML version deleted]]


From jo@|@h@p@rry @end|ng |rom gm@||@com  Mon May 13 17:12:30 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Mon, 13 May 2024 11:12:30 -0400
Subject: [R-sig-Geo] Maximum sparsity for spatial regression
Message-ID: <CAL3ufU+sOZygxdaqMks5oNnoveZ8sdhtR6MG6MBF=0+xmAFESw@mail.gmail.com>

As I'm reading through Modern Spatial Econometrics in Practice, we assume
the spatial weights matrix to be sparse. At one point they note that the
contiguity matrix  for the US counties is 0.18% non-zero. But what %
non-zero is too dense?

I am wondering if there is any research or papers that document what a
recommended upper bound of sparsity should be for one of these models? Is
10% non-zero too much or sufficient? I suspect the answer is, like most
things, "it depends."

But, thinking of a situation where someone might use a distance band to
specify neighbors they might create a bandwidth that can encompass 50% or
more of points if using max(knn=1) to specify the distance. I suspect using
a kernel or IDW could reduce the weights close to zero making the impact
minimal.

Nonetheless, I'm curious if others have thought about this or written about
it!

Thanks,

Josiah

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Mon May 13 18:11:04 2024
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Mon, 13 May 2024 16:11:04 +0000
Subject: [R-sig-Geo] Maximum sparsity for spatial regression
In-Reply-To: <CAL3ufU+sOZygxdaqMks5oNnoveZ8sdhtR6MG6MBF=0+xmAFESw@mail.gmail.com>
References: <CAL3ufU+sOZygxdaqMks5oNnoveZ8sdhtR6MG6MBF=0+xmAFESw@mail.gmail.com>
Message-ID: <SV0P279MB047598031CCECDE5F6CAF8C7EEE22@SV0P279MB0475.NORP279.PROD.OUTLOOK.COM>

Is Tony Smith's "Estimation Bias in Spatial Models with Strongly Connected Weight Matrices" at https://doi.org/10.1111/j.1538-4632.2009.00758.x helpful?

Roger

--
Roger Bivand
Emeritus Professor
Norwegian School of Economics
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway
Roger.Bivand at nhh.no

________________________________________
From: R-sig-Geo <r-sig-geo-bounces at r-project.org> on behalf of Josiah Parry <josiah.parry at gmail.com>
Sent: 13 May 2024 17:12
To: r-sig-Geo at r-project.org
Subject: [R-sig-Geo] Maximum sparsity for spatial regression

As I'm reading through Modern Spatial Econometrics in Practice, we assume
the spatial weights matrix to be sparse. At one point they note that the
contiguity matrix  for the US counties is 0.18% non-zero. But what %
non-zero is too dense?

I am wondering if there is any research or papers that document what a
recommended upper bound of sparsity should be for one of these models? Is
10% non-zero too much or sufficient? I suspect the answer is, like most
things, "it depends."

But, thinking of a situation where someone might use a distance band to
specify neighbors they might create a bandwidth that can encompass 50% or
more of points if using max(knn=1) to specify the distance. I suspect using
a kernel or IDW could reduce the weights close to zero making the impact
minimal.

Nonetheless, I'm curious if others have thought about this or written about
it!

Thanks,

Josiah

        [[alternative HTML version deleted]]

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://stat.ethz.ch/mailman/listinfo/r-sig-geo


From ju||enrodr|guez@@rd@@pm @end|ng |rom gm@||@com  Mon May 13 18:35:11 2024
From: ju||enrodr|guez@@rd@@pm @end|ng |rom gm@||@com (Julien Rodriguez)
Date: Mon, 13 May 2024 18:35:11 +0200
Subject: [R-sig-Geo] 
 add spatraster layers by matching a dataframe column
 and make spatio-temporal rast
In-Reply-To: <CAKSASLCNE1rtZTQn7SZ780SLG8NxjbGqnXUCu-5sMm9_yXDU4g@mail.gmail.com>
References: <CAKSASLCNE1rtZTQn7SZ780SLG8NxjbGqnXUCu-5sMm9_yXDU4g@mail.gmail.com>
Message-ID: <CACEJfCrNxehVDxeJFT82Yfo7DaCeYR+jQs1jSdueuzKKogC29g@mail.gmail.com>

 Dear Marta,


I hope I've understood properly what you're expecting.

Provided your vector values are ordered properly, you can add it as a new
layer in an existing SpatRaster using "$" as for a data.frame.
The terra::merge method may be used for different SpatRasters or between
SpatVector and data.frames but you could prepare new layers from the
original raster values using base::merge with your "ID" column.
Regarding the temporal aspect, it would mean, as I understood it, that you
should have two data.frames containing the features to be included instead
of one (for years 2001 and 2002).
Surely not the most elegant way to do it below with base R functions but it
should work.
If anyone has a more appropriate solution, I'd be greatly interested too!


# runnable example
# Make an example raster:
require(terra)
set.seed(240513)

r <- terra::rast(ncols=10, nrows=10)
values(r) <- 1:100
names(r)="ID"
# add some missing values (to make it real)
r[c(2,43,60,94)]=NA
plot(r)

# Make an example data frame (note both have an ID col to match)
d <- data.frame(
  ID=100:1,
  k=c("aa","bb"),
  e=rnorm(100,2),
  year=sample(2001:2002, 100, replace = TRUE),
  date= as.Date(rep(c("2010-01-01", "2012-02-01",
                      "2010-03-01","2010-04-01"), l=100)))
head(d)

# the terra::time is used to describe different layers of the raster which
is not appropriated in this case (one layer = one feature for one year)
# Here the values to be included in the raster are associated to different
dates so the data frame has to be splitted by year
# A different year means actually a missing value for the pixel
# the raster time index to be then defined as:
ras.time.index <- 2001:2002

col2sel <- colnames(d)[ !colnames(d) %in% c("ID", "year")]

timed.d <- do.call(merge,
              lapply(ras.time.index , function(y){
                      new.d <- d
                      new.d [!d$year %in% y, col2sel] <- NA
                      colnames(new.d)[ colnames(new.d) %in% col2sel] <-
paste(col2sel, y, sep = "_")
                      new.d <- new.d[ order(new.d$ID), !colnames(new.d)
%in% "year"]
                      return(new.d)}))

head(timed.d)


# Extract the values from the raster and make a unique index to identify
the pixel values order from original raster
ras.vals <- terra::values(r, dataframe = TRUE)
ras.val.0 <- cbind(ras.vals, index = 1:nrow(ras.val))

# Merge with d (values with missing IDs will be lost from d) while keeping
every values from original raster
ras.val.1 <- merge(ras.val.0,  timed.d, by = "ID", all.x = TRUE)
summary(ras.val.1)

# Reorder features values properly
ras.val.1 <- ras.val.1[ order(ras.val.1$index), ]

# Add these new values to the initial raster iteratively
features <- colnames(timed.d)[ !colnames(timed.d) %in% colnames(ras.val.0)]
features

for(i in 1:length(features)){

  new.values <- ras.val.1 [, features[i]]
  if(inherits(new.values, "Date")){
    new.values <- as.character(new.values)
  }
  r$new.val <- new.values
  names(r)[ names(r) %in% "new.val"] <- features[i]

}

plot(r)

# At last, define the temporal component of different layers
# To do that, distinguishing the different features seems appropriated
# Example for feature "e" layers
ras.e <-  r[[substr(names(r), 1,2) %in% "e_"]]
terra::time(ras.e, tstep="years") <- ras.time.index

plot(ras.e)

I hope this might be useful

 Best regards

Julien Rodriguez







Le lun. 13 mai 2024 ? 12:55, Marta Rufino <marta.m.rufino at gmail.com> a
?crit :

> Hi,
>
> I would like to add layers to a spatraster (terra), by matching (joining) a
> column in a data frame with the values of the raster layer (A).
> Then, I would like to make it a spatio-temporal terra spatraster and/or a
> stars (B).
>
> Any help will be strongly appreciated,
> Kind regards,
> M.
> ________________________________________
>  require(terra)
>
> # A)
>
> # runnable example
> # Make an example raster:
>   r = terra::rast(ncols=10, nrows=10)
>   values(r) <- 1:100
>   names(r)="ID"
>   # add some missing values (to make it real)
>   r[c(2,43,60,94)]=NA
>   plot(r)
>
>   # Make an example data frame (note both have an ID col to match)
>   d <- data.frame(
>     ID=100:1,
>     k=c("aa","bb"),
>     e=rnorm(100,2),
>     year=sample(2001:2002, 100, replace = TRUE),
>     date= as.Date(rep(c("2010-01-01", "2012-02-01",
> "2010-03-01","2010-04-01"), l=100)))
>   head(d)
>
> # My tries:
>
>   # 1. This works, but only for one col and it is not so nice:
>   r$year2 <- d$year[match(as.vector(r$ID), d$ID)]
>   plot(r)
>
>   # 2. try it using app function: I could not make it work
>   kk1 <- function(i,j=d) {
>       j[match(as.vector(i$ID), j$ID),]
>     }
>   app(r, fun = kk1)
>
>   # 3. try it using classify function
>   # works with numeric (not characters) but it is not perfect
>   terra::classify(r, d) # error
>   # two numeric cols: works, but add the second col as the first raster
> col. Not ok.
>   terra::classify(r, d[,c(1,3)])
>   # excluding the character col: gives an error
>   terra::classify(r, d[,-c(2)])
>
>   # 4. try it using merge function
>   terra::merge(r, d) %>% head() #not sure what he did and in which order :(
> but clearly not match/join working properly
>
>   # 5. only (not elegant) way I managed:
>   rast(
>     left_join(
>       as_tibble(r, xy=TRUE), d, by="ID"), type="xyz", crs = "EPSG:4326")
> %>% plot()
>
> # B) Make terra r raster a spatiotemporal cube
>
> # 1.
> #
>
> https://stackoverflow.com/questions/74079441/group-raster-files-by-week-month
> terra::time(r, tstep="years") <- d$year
> # gives an error...
> # Error: [time<-] length(value) != nlyr(x)
>
> # 2.
> #
>
> https://stackoverflow.com/questions/74934891/specifying-layers-when-using-rast-type-xyz-to-convert-data-frame-to-spatra
> # but I think this is not really a spatio-temporal rast...
> d2 <- left_join(as_tibble(r, xy=TRUE), d, by=c("ID"))
> w <- reshape(d2, timevar="year", idvar=c("x", "y"), direction="wide")
> x <- rast(w, type="xyz")
>
> # by year
> d3 <- split(d2[,-7], d2$year)
> r2 <- lapply(d3, \(i) rast(i, type="xyz"))
> (r2 <- rast(r2))
> time(r2) <- as.Date(names(r2))
> plot(r2)
>
> # plot with rasterVis
> require(rasterVis)
> levelplot(r2)
>
>
> # 2. using stars (aternative)
> # sources:
>
> https://stackoverflow.com/questions/77368957/how-to-transform-a-sf-table-to-a-stars-cube-with-starsst-as-stars-function
> # (
>
> https://gis.stackexchange.com/questions/353741/generate-a-stars-object-from-tabular-spatial-temporal-data
> ):
>
> s <- st_as_stars(as.data.frame(r, xy = TRUE, na.rm = TRUE), dims = c("x",
> "y", "year"), crs = 4326)
> s %>% plot(axes=TRUE)
> # but the from and to of the year are wrong
> # How to change to spatrast again?
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From jo@|@h@p@rry @end|ng |rom gm@||@com  Mon May 13 18:39:50 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Mon, 13 May 2024 12:39:50 -0400
Subject: [R-sig-Geo] Maximum sparsity for spatial regression
In-Reply-To: <SV0P279MB047598031CCECDE5F6CAF8C7EEE22@SV0P279MB0475.NORP279.PROD.OUTLOOK.COM>
References: <CAL3ufU+sOZygxdaqMks5oNnoveZ8sdhtR6MG6MBF=0+xmAFESw@mail.gmail.com>
 <SV0P279MB047598031CCECDE5F6CAF8C7EEE22@SV0P279MB0475.NORP279.PROD.OUTLOOK.COM>
Message-ID: <CAL3ufULLEo+5-xQZYVBGYqCH+h=15U3vOW5h5onqxSBGqowJCw@mail.gmail.com>

Yes! This is perfect. Thank you so much.

On Mon, May 13, 2024 at 12:11 Roger Bivand <Roger.Bivand at nhh.no> wrote:

> Is Tony Smith's "Estimation Bias in Spatial Models with Strongly Connected
> Weight Matrices" at https://doi.org/10.1111/j.1538-4632.2009.00758.x
> helpful?
>
> Roger
>
> --
> Roger Bivand
> Emeritus Professor
> Norwegian School of Economics
> Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway
> Roger.Bivand at nhh.no
>
> ________________________________________
> From: R-sig-Geo <r-sig-geo-bounces at r-project.org> on behalf of Josiah
> Parry <josiah.parry at gmail.com>
> Sent: 13 May 2024 17:12
> To: r-sig-Geo at r-project.org
> Subject: [R-sig-Geo] Maximum sparsity for spatial regression
>
> As I'm reading through Modern Spatial Econometrics in Practice, we assume
> the spatial weights matrix to be sparse. At one point they note that the
> contiguity matrix  for the US counties is 0.18% non-zero. But what %
> non-zero is too dense?
>
> I am wondering if there is any research or papers that document what a
> recommended upper bound of sparsity should be for one of these models? Is
> 10% non-zero too much or sufficient? I suspect the answer is, like most
> things, "it depends."
>
> But, thinking of a situation where someone might use a distance band to
> specify neighbors they might create a bandwidth that can encompass 50% or
> more of points if using max(knn=1) to specify the distance. I suspect using
> a kernel or IDW could reduce the weights close to zero making the impact
> minimal.
>
> Nonetheless, I'm curious if others have thought about this or written about
> it!
>
> Thanks,
>
> Josiah
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From m@rt@@m@ru||no @end|ng |rom gm@||@com  Tue May 14 18:40:20 2024
From: m@rt@@m@ru||no @end|ng |rom gm@||@com (Marta Rufino)
Date: Tue, 14 May 2024 17:40:20 +0100
Subject: [R-sig-Geo] 
 add spatraster layers by matching a dataframe column
 and make spatio-temporal rast
In-Reply-To: <CACEJfCrNxehVDxeJFT82Yfo7DaCeYR+jQs1jSdueuzKKogC29g@mail.gmail.com>
References: <CAKSASLCNE1rtZTQn7SZ780SLG8NxjbGqnXUCu-5sMm9_yXDU4g@mail.gmail.com>
 <CACEJfCrNxehVDxeJFT82Yfo7DaCeYR+jQs1jSdueuzKKogC29g@mail.gmail.com>
Message-ID: <CAKSASLBRsnz6oKcFTLjuzWxJu5mvtP-npP8UW_bQ4fZjqzT76g@mail.gmail.com>

Hi Julien,

Hope you are very well.
Thank you so much for the reply!

I hope I've understood properly what you're expecting.
>
Sorry :( I made the question several times to try to make it clear lol

Provided your vector values are ordered properly, you can add it as a new
> layer in an existing SpatRaster using "$" as for a data.frame.
>
They have different orders in fact and they have missing values in the rast
to make it more interesting lol


> The terra::merge method may be used for different SpatRasters or between
> SpatVector and data.frames but you could prepare new layers from the
> original raster values using base::merge with your "ID" column.
>
Yes, but it returns a data frame (point 4 of the example above) and I
wanted to get a raster with additional layers as output (one for each data
frame col).



> Regarding the temporal aspect, it would mean, as I understood it, that you
> should have two data.frames containing the features to be included instead
> of one (for years 2001 and 2002).
> Surely not the most elegant way to do it below with base R functions but
> it should work.
> If anyone has a more appropriate solution, I'd be greatly interested too!
>

Super elaborated and detailed code Julien! Thank you so much and indeed, it
works well!

Cheers,
M.

	[[alternative HTML version deleted]]


