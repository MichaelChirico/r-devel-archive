From |uc@@c@nde|oro @end|ng |rom gm@||@com  Wed Feb  1 11:06:15 2023
From: |uc@@c@nde|oro @end|ng |rom gm@||@com (Luca Candeloro)
Date: Wed, 1 Feb 2023 11:06:15 +0100
Subject: [R-sig-Geo] Geovet 2023 Conference
Message-ID: <CAHF6Ynn_DGsBG3hM=yqi-_4WkeuHobMa55+qLvvTf3a0-TJsCA@mail.gmail.com>

Dear All,


from September 19th to 21st 2023, Italy will host the GeoVet 2023
International Conference, bringing together experts in the fields of
spatial epidemiology, spatial statistics, veterinary medicine, public
health, and food safety, as well as representatives from international
organizations.


Under the theme "Expanding Boundaries: Interdisciplinary Geospatial
Research for the One Health Era", GeoVet 2023 aims to promote
interdisciplinary approaches and strengthen communication between different
sectors in addressing health concerns at the intersection of human, animal,
plant, and environment.

You can visit the Geovet 2023 website at https://geovet2023.izs.it/ for
further information.


Looking forward to welcoming you to Italy


Luca Candeloro, on the behalf of the GeoVet 2023 Organising Committee

	[[alternative HTML version deleted]]


From n|ko@@tz|ok@@ @end|ng |rom gm@||@com  Sun Feb  5 18:14:08 2023
From: n|ko@@tz|ok@@ @end|ng |rom gm@||@com (Nikolaos Tziokas)
Date: Sun, 5 Feb 2023 17:14:08 +0000
Subject: [R-sig-Geo] Error when running multiscale GWR: Error in
 gw_weight_vec: Not compatible > with requested type: [type=NULL;
 target=double]
Message-ID: <CAGg5H0ag_CxjUv1_b+Ug9VF4_vgzY-Q7ah9Q8D_i+VP7V=D98w@mail.gmail.com>

I am trying to run multiscale geographically weighted regression (MGWR)
using the GWmodel package in R. When running the function gwr.multiscale
this error is shown:

Error in gw_weight_vec(vdist, bw, kernel, adaptive): Not compatible with
requested type: [type=NULL; target=double].

An example:

library(GWmodel)

data(LondonHP)

dist <- gw.dist(coordinates(londonhp))

ab_gwr <- gwr.multiscale(PURCHASE ~ FLOORSZ + PROF,
                         data = londonhp,
                         criterion = "dCVR",
                         kernel = "gaussian",
                         adaptive = FALSE,
                         var.dMat.indx = 2,
                         bws0 = c(100,
                                  100,
                                  100),
                         bw.seled = rep(T, 3),
                         dMats = list(dist,
                                      dist,
                                      dist),
                         parallel.method = "omp",
                         parallel.arg = "omp")

I am following the example from the package's PDF. Also, I tried with my
dataset and many different combinations (different number of covariates,
the dMats parameter, adaptive bandwidths etc etc).

-- 
Tziokas Nikolaos
Cartographer

Tel:(+44)07561120302
LinkedIn <http://linkedin.com/in/nikolaos-tziokas-896081130>

	[[alternative HTML version deleted]]


From bi@bi@iu m@iii@g oii whu@edu@c@  Tue Feb  7 04:28:40 2023
From: bi@bi@iu m@iii@g oii whu@edu@c@ (bi@bi@iu m@iii@g oii whu@edu@c@)
Date: Tue, 7 Feb 2023 11:28:40 +0800
Subject: [R-sig-Geo] Error when running multiscale GWR: Error in
 gw_weight_vec: Not compatible > with requested type: [type=NULL;
 target=double]
References: <CAGg5H0ag_CxjUv1_b+Ug9VF4_vgzY-Q7ah9Q8D_i+VP7V=D98w@mail.gmail.com>
Message-ID: <202302071128403588395@whu.edu.cn>

The parameter  var.dMat.indx  is defined for the usage of distance matrix for each variable, and was used wrongly in your code. Try this:

 ab_gwr <- gwr.multiscale(PURCHASE ~ FLOORSZ + PROF,
                         data = londonhp,
                         criterion = "dCVR",
                         kernel = "gaussian",
                         adaptive = FALSE,
                         var.dMat.indx = 1:3,
                         bws0 = c(100,
                                  100,
                                  100),
                         bw.seled = rep(T, 3),
                         dMats = list(dist,
                                      dist,
                                      dist),
                         parallel.method = "omp",
                         parallel.arg = "omp")
It should work now.


binbinlu at whu.edu.cn
 
From: Nikolaos Tziokas
Date: 2023-02-06 01:14
To: r-sig-geo
Subject: [R-sig-Geo] Error when running multiscale GWR: Error in gw_weight_vec: Not compatible > with requested type: [type=NULL; target=double]
I am trying to run multiscale geographically weighted regression (MGWR)
using the GWmodel package in R. When running the function gwr.multiscale
this error is shown:
 
Error in gw_weight_vec(vdist, bw, kernel, adaptive): Not compatible with
requested type: [type=NULL; target=double].
 
An example:
 
library(GWmodel)
 
data(LondonHP)
 
dist <- gw.dist(coordinates(londonhp))
 
ab_gwr <- gwr.multiscale(PURCHASE ~ FLOORSZ + PROF,
                         data = londonhp,
                         criterion = "dCVR",
                         kernel = "gaussian",
                         adaptive = FALSE,
                         var.dMat.indx = 2,
                         bws0 = c(100,
                                  100,
                                  100),
                         bw.seled = rep(T, 3),
                         dMats = list(dist,
                                      dist,
                                      dist),
                         parallel.method = "omp",
                         parallel.arg = "omp")
 
I am following the example from the package's PDF. Also, I tried with my
dataset and many different combinations (different number of covariates,
the dMats parameter, adaptive bandwidths etc etc).
 
-- 
Tziokas Nikolaos
Cartographer
 
Tel:(+44)07561120302
LinkedIn <http://linkedin.com/in/nikolaos-tziokas-896081130>
 
[[alternative HTML version deleted]]
 
_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://stat.ethz.ch/mailman/listinfo/r-sig-geo

	[[alternative HTML version deleted]]


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 00:21:42 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Thu, 9 Feb 2023 17:21:42 -0600
Subject: [R-sig-Geo] Spatial nested grid in R
Message-ID: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>

Dear list members,

Is it possible to generate a spatial nested grid in R?

For example, a grid of several 8km x 8km tiles, and within that grid, I
want 4 tiles of 4km x 4km, and in each of those I want 4 tiles of 2km x
2km, and in each of those I want 4 tiles of 1km x 1km.

Manuel

-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From m@rce||no@de|@cruz @end|ng |rom urjc@e@  Fri Feb 10 10:09:29 2023
From: m@rce||no@de|@cruz @end|ng |rom urjc@e@ (Marcelino de la Cruz Rot)
Date: Fri, 10 Feb 2023 10:09:29 +0100
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
Message-ID: <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>

Dear Manuel,
This is R. There is no "it is possible". Only "how" ;-).

For example, with spatstat.geom,

A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))

Cheers,
Marcelino


El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
> Dear list members,
>
> Is it possible to generate a spatial nested grid in R?
>
> For example, a grid of several 8km x 8km tiles, and within that grid, I
> want 4 tiles of 4km x 4km, and in each of those I want 4 tiles of 2km x
> 2km, and in each of those I want 4 tiles of 1km x 1km.
>
> Manuel
>

-- 
Marcelino de la Cruz Rot
Coordinador funcional de Biolog?a
Depto. de Biolog?a y Geolog?a
F?sica y Qu?mica Inorg?nica
Universidad Rey Juan Carlos
M?stoles Espa?a


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 13:29:41 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 06:29:41 -0600
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
Message-ID: <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>

Thank you very much Marcelino.

And how can overimpose those grids to a spatial polygon?

Manuel

On Fri, 10 Feb 2023 at 03:09 Marcelino de la Cruz Rot <
marcelino.delacruz at urjc.es> wrote:

> Dear Manuel,
> This is R. There is no "it is possible". Only "how" ;-).
>
> For example, with spatstat.geom,
>
> A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
> B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
> C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
> D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))
>
> Cheers,
> Marcelino
>
>
> El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
> > Dear list members,
> >
> > Is it possible to generate a spatial nested grid in R?
> >
> > For example, a grid of several 8km x 8km tiles, and within that grid, I
> > want 4 tiles of 4km x 4km, and in each of those I want 4 tiles of 2km x
> > 2km, and in each of those I want 4 tiles of 1km x 1km.
> >
> > Manuel
> >
>
> --
> Marcelino de la Cruz Rot
> Coordinador funcional de Biolog?a
> Depto. de Biolog?a y Geolog?a
> F?sica y Qu?mica Inorg?nica
> Universidad Rey Juan Carlos
> M?stoles Espa?a
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From m@rce||no@de|@cruz @end|ng |rom urjc@e@  Fri Feb 10 14:29:06 2023
From: m@rce||no@de|@cruz @end|ng |rom urjc@e@ (Marcelino de la Cruz Rot)
Date: Fri, 10 Feb 2023 14:29:06 +0100
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
 <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>
Message-ID: <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>

It depends on what you mean by "overimpose".

Maybe this way?

# some spatial polygon
library(maptools)
R <- as(affine(letterR, mat=diag(c(20,20))), "SpatialPolygons")
plot(R, border="blue")

# "overimpose" grids A to C on R:
plot(C, border="green", add=T)
plot(B, border="red", add=T)
plot(A, add=T)

Cheers,
Marcelino



El 10/02/2023 a las 13:29, Manuel Sp?nola escribi?:
> Thank you very much Marcelino.
>
> And how can overimpose those grids to a spatial polygon?
>
> Manuel
>
> On Fri, 10 Feb 2023 at 03:09 Marcelino de la Cruz Rot 
> <marcelino.delacruz at urjc.es> wrote:
>
>     Dear Manuel,
>     This is R. There is no "it is possible". Only "how" ;-).
>
>     For example, with spatstat.geom,
>
>     A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
>     B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
>     C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
>     D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))
>
>     Cheers,
>     Marcelino
>
>
>     El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
>     > Dear list members,
>     >
>     > Is it possible to generate a spatial nested grid in R?
>     >
>     > For example, a grid of several 8km x 8km tiles, and within that
>     grid, I
>     > want 4 tiles of 4km x 4km, and in each of those I want 4 tiles
>     of 2km x
>     > 2km, and in each of those I want 4 tiles of 1km x 1km.
>     >
>     > Manuel
>     >
>
>     -- 
>     Marcelino de la Cruz Rot
>     Coordinador funcional de Biolog?a
>     Depto. de Biolog?a y Geolog?a
>     F?sica y Qu?mica Inorg?nica
>     Universidad Rey Juan Carlos
>     M?stoles Espa?a
>
>     _______________________________________________
>     R-sig-Geo mailing list
>     R-sig-Geo at r-project.org
>     https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
> -- 
> *Manuel Sp?nola, Ph.D.*
> Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
> Universidad Nacional
> Apartado 1350-3000
> Heredia
> COSTA RICA
> mspinola at una.cr <mailto:mspinola at una.ac.cr>
> mspinola10 at gmail.com
> Tel?fono: (506) 8706 - 4662
> Institutional website: ICOMVIS 
> <http://www.icomvis.una.ac.cr/index.php/manuel>
> Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app


-- 
Marcelino de la Cruz Rot
Coordinador funcional de Biolog?a
Depto. de Biolog?a y Geolog?a
F?sica y Qu?mica Inorg?nica
Universidad Rey Juan Carlos
M?stoles Espa?a


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 14:33:03 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 07:33:03 -0600
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
 <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>
 <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>
Message-ID: <CABkCotRW7SNmfa=hsKMdgQHRWmJ1Z3Z+iNgmC4-vsoFw5deeCw@mail.gmail.com>

Thank you very much Marcelino.

Manuel

El vie, 10 feb 2023 a las 7:29, Marcelino de la Cruz Rot (<
marcelino.delacruz at urjc.es>) escribi?:

> It depends on what you mean by "overimpose".
>
> Maybe this way?
>
> # some spatial polygon
> library(maptools)
> R <- as(affine(letterR, mat=diag(c(20,20))), "SpatialPolygons")
> plot(R, border="blue")
>
> # "overimpose" grids A to C on R:
> plot(C, border="green", add=T)
> plot(B, border="red", add=T)
> plot(A, add=T)
>
> Cheers,
> Marcelino
>
>
>
> El 10/02/2023 a las 13:29, Manuel Sp?nola escribi?:
> > Thank you very much Marcelino.
> >
> > And how can overimpose those grids to a spatial polygon?
> >
> > Manuel
> >
> > On Fri, 10 Feb 2023 at 03:09 Marcelino de la Cruz Rot
> > <marcelino.delacruz at urjc.es> wrote:
> >
> >     Dear Manuel,
> >     This is R. There is no "it is possible". Only "how" ;-).
> >
> >     For example, with spatstat.geom,
> >
> >     A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
> >     B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
> >     C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
> >     D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))
> >
> >     Cheers,
> >     Marcelino
> >
> >
> >     El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
> >     > Dear list members,
> >     >
> >     > Is it possible to generate a spatial nested grid in R?
> >     >
> >     > For example, a grid of several 8km x 8km tiles, and within that
> >     grid, I
> >     > want 4 tiles of 4km x 4km, and in each of those I want 4 tiles
> >     of 2km x
> >     > 2km, and in each of those I want 4 tiles of 1km x 1km.
> >     >
> >     > Manuel
> >     >
> >
> >     --
> >     Marcelino de la Cruz Rot
> >     Coordinador funcional de Biolog?a
> >     Depto. de Biolog?a y Geolog?a
> >     F?sica y Qu?mica Inorg?nica
> >     Universidad Rey Juan Carlos
> >     M?stoles Espa?a
> >
> >     _______________________________________________
> >     R-sig-Geo mailing list
> >     R-sig-Geo at r-project.org
> >     https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >
> > --
> > *Manuel Sp?nola, Ph.D.*
> > Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
> > Universidad Nacional
> > Apartado 1350-3000
> > Heredia
> > COSTA RICA
> > mspinola at una.cr <mailto:mspinola at una.ac.cr>
> > mspinola10 at gmail.com
> > Tel?fono: (506) 8706 - 4662
> > Institutional website: ICOMVIS
> > <http://www.icomvis.una.ac.cr/index.php/manuel>
> > Blog sobre Ciencia de Datos:
> https://mspinola-ciencia-de-datos.netlify.app
>
>
> --
> Marcelino de la Cruz Rot
> Coordinador funcional de Biolog?a
> Depto. de Biolog?a y Geolog?a
> F?sica y Qu?mica Inorg?nica
> Universidad Rey Juan Carlos
> M?stoles Espa?a
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Fri Feb 10 15:13:16 2023
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Fri, 10 Feb 2023 15:13:16 +0100 (CET)
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
 <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>
 <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>
Message-ID: <f7abe29-99d5-1866-3f3a-3d44c08d4feb@reclus2.nhh.no>

On Fri, 10 Feb 2023, Marcelino de la Cruz Rot wrote:

> It depends on what you mean by "overimpose".
>
> Maybe this way?
>
> # some spatial polygon

Please, in the spirit of the evolving r-spatial package ecosystem 
(maptools will retire during 2023):

library(sf)
R <- st_as_sf(affine(letterR, mat=diag(c(20,20))))
plot(R, border="blue")

See https://r-spatial.org/r/2022/12/14/evolution2.html, maybe 
https://rsbivand.github.io/csds_jan23/bivand_csds_ssg_230117.pdf and 
https://www.youtube.com/watch?v=TlpjIqTPMCA&list=PLzREt6r1NenmWEidssmLm-VO_YmAh4pq9&index=1

Roger

> library(maptools)
> R <- as(affine(letterR, mat=diag(c(20,20))), "SpatialPolygons")
> plot(R, border="blue")
>
> # "overimpose" grids A to C on R:
> plot(C, border="green", add=T)
> plot(B, border="red", add=T)
> plot(A, add=T)
>
> Cheers,
> Marcelino
>
>
>
> El 10/02/2023 a las 13:29, Manuel Sp?nola escribi?:
>>  Thank you very much Marcelino.
>>
>>  And how can overimpose those grids to a spatial polygon?
>>
>>  Manuel
>>
>>  On Fri, 10 Feb 2023 at 03:09 Marcelino de la Cruz Rot
>>  <marcelino.delacruz at urjc.es> wrote:
>>
>>      Dear Manuel,
>>      This is R. There is no "it is possible". Only "how" ;-).
>>
>>      For example, with spatstat.geom,
>>
>>      A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
>>      B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
>>      C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
>>      D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))
>>
>>      Cheers,
>>      Marcelino
>> 
>>
>>      El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
>>     >  Dear list members,
>>     >
>>     >  Is it possible to generate a spatial nested grid in R?
>>     >
>>     >  For example, a grid of several 8km x 8km tiles, and within that
>>      grid, I
>>     >  want 4 tiles of 4km x 4km, and in each of those I want 4 tiles
>>      of 2km x
>>     >  2km, and in each of those I want 4 tiles of 1km x 1km.
>>     >
>>     >  Manuel
>>     > 
>>
>>      --
>>      Marcelino de la Cruz Rot
>>      Coordinador funcional de Biolog?a
>>      Depto. de Biolog?a y Geolog?a
>>      F?sica y Qu?mica Inorg?nica
>>      Universidad Rey Juan Carlos
>>      M?stoles Espa?a
>>
>>      _______________________________________________
>>      R-sig-Geo mailing list
>>      R-sig-Geo at r-project.org
>>      https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Ngv4yEcnP6JM4zq5rpVgzcYgRHAFwPPS8JRFhMaRA58%3D&reserved=0
>>
>>  --
>>  *Manuel Sp?nola, Ph.D.*
>>  Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
>>  Universidad Nacional
>>  Apartado 1350-3000
>>  Heredia
>>  COSTA RICA
>>  mspinola at una.cr <mailto:mspinola at una.ac.cr>
>>  mspinola10 at gmail.com
>>  Tel?fono: (506) 8706 - 4662
>>  Institutional website: ICOMVIS
>>  <https://eur02.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.icomvis.una.ac.cr%2Findex.php%2Fmanuel&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=fCKSKsYuj7JXD5CbsQDKFUkeAVpqekVl%2BbTYM2dpuzU%3D&reserved=0>
>>  Blog sobre Ciencia de Datos:
>>  https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmspinola-ciencia-de-datos.netlify.app%2F&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=cVcjfP2hgnbfK%2BZCrCGFi4HhnQjGEWtx8zeJ%2BjBZDtE%3D&reserved=0
>
>
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 15:37:43 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 08:37:43 -0600
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <f7abe29-99d5-1866-3f3a-3d44c08d4feb@reclus2.nhh.no>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
 <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>
 <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>
 <f7abe29-99d5-1866-3f3a-3d44c08d4feb@reclus2.nhh.no>
Message-ID: <CABkCotRr2LjNdA2R_BpUH-gTVkB5R81qSfd5710N3T0L4SS+cw@mail.gmail.com>

Thank you very much Roger.

Manuel

El vie, 10 feb 2023 a las 8:13, Roger Bivand (<Roger.Bivand at nhh.no>)
escribi?:

> On Fri, 10 Feb 2023, Marcelino de la Cruz Rot wrote:
>
> > It depends on what you mean by "overimpose".
> >
> > Maybe this way?
> >
> > # some spatial polygon
>
> Please, in the spirit of the evolving r-spatial package ecosystem
> (maptools will retire during 2023):
>
> library(sf)
> R <- st_as_sf(affine(letterR, mat=diag(c(20,20))))
> plot(R, border="blue")
>
> See https://r-spatial.org/r/2022/12/14/evolution2.html, maybe
> https://rsbivand.github.io/csds_jan23/bivand_csds_ssg_230117.pdf and
>
> https://www.youtube.com/watch?v=TlpjIqTPMCA&list=PLzREt6r1NenmWEidssmLm-VO_YmAh4pq9&index=1
>
> Roger
>
> > library(maptools)
> > R <- as(affine(letterR, mat=diag(c(20,20))), "SpatialPolygons")
> > plot(R, border="blue")
> >
> > # "overimpose" grids A to C on R:
> > plot(C, border="green", add=T)
> > plot(B, border="red", add=T)
> > plot(A, add=T)
> >
> > Cheers,
> > Marcelino
> >
> >
> >
> > El 10/02/2023 a las 13:29, Manuel Sp?nola escribi?:
> >>  Thank you very much Marcelino.
> >>
> >>  And how can overimpose those grids to a spatial polygon?
> >>
> >>  Manuel
> >>
> >>  On Fri, 10 Feb 2023 at 03:09 Marcelino de la Cruz Rot
> >>  <marcelino.delacruz at urjc.es> wrote:
> >>
> >>      Dear Manuel,
> >>      This is R. There is no "it is possible". Only "how" ;-).
> >>
> >>      For example, with spatstat.geom,
> >>
> >>      A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
> >>      B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
> >>      C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
> >>      D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))
> >>
> >>      Cheers,
> >>      Marcelino
> >>
> >>
> >>      El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
> >>     >  Dear list members,
> >>     >
> >>     >  Is it possible to generate a spatial nested grid in R?
> >>     >
> >>     >  For example, a grid of several 8km x 8km tiles, and within that
> >>      grid, I
> >>     >  want 4 tiles of 4km x 4km, and in each of those I want 4 tiles
> >>      of 2km x
> >>     >  2km, and in each of those I want 4 tiles of 1km x 1km.
> >>     >
> >>     >  Manuel
> >>     >
> >>
> >>      --
> >>      Marcelino de la Cruz Rot
> >>      Coordinador funcional de Biolog?a
> >>      Depto. de Biolog?a y Geolog?a
> >>      F?sica y Qu?mica Inorg?nica
> >>      Universidad Rey Juan Carlos
> >>      M?stoles Espa?a
> >>
> >>      _______________________________________________
> >>      R-sig-Geo mailing list
> >>      R-sig-Geo at r-project.org
> >>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Ngv4yEcnP6JM4zq5rpVgzcYgRHAFwPPS8JRFhMaRA58%3D&reserved=0
> >>
> >>  --
> >>  *Manuel Sp?nola, Ph.D.*
> >>  Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
> >>  Universidad Nacional
> >>  Apartado 1350-3000
> >>  Heredia
> >>  COSTA RICA
> >>  mspinola at una.cr <mailto:mspinola at una.ac.cr>
> >>  mspinola10 at gmail.com
> >>  Tel?fono: (506) 8706 - 4662
> >>  Institutional website: ICOMVIS
> >>  <
> https://eur02.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.icomvis.una.ac.cr%2Findex.php%2Fmanuel&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=fCKSKsYuj7JXD5CbsQDKFUkeAVpqekVl%2BbTYM2dpuzU%3D&reserved=0
> >
> >>  Blog sobre Ciencia de Datos:
> >>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmspinola-ciencia-de-datos.netlify.app%2F&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=cVcjfP2hgnbfK%2BZCrCGFi4HhnQjGEWtx8zeJ%2BjBZDtE%3D&reserved=0
> >
> >
> >
>
> --
> Roger Bivand
> Emeritus Professor
> Department of Economics, Norwegian School of Economics,
> Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
> e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 18:32:38 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 11:32:38 -0600
Subject: [R-sig-Geo] st_intersection produce Geometry type: GEOMETRY instead
 of Geometry type: POLYGON
Message-ID: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>

Dear list members,

I am trying to "crop" a polygon (grid) with a polygon, but the result is an
sf object Geometry type: GEOMETRY, instead of an sf object Geometry type:
POLYGON.

How can I obtain an sf POLYGON?

nc = st_read(system.file("shape/nc.shp", package="sf"))



nc <- st_transform(nc, 3857)



g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()



g_50000 <- g_50000[nc, ]



g_50000_d <- st_union(g_50000)



g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()



g_25000 # Geometry type: POLYGON



g_25000_c <- st_intersection(g_25000, g_50000_d)



g_25000_c # Geometry type: GEOMETRY




-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From b|@|ev||@t @end|ng |rom gm@||@com  Fri Feb 10 18:53:01 2023
From: b|@|ev||@t @end|ng |rom gm@||@com (=?UTF-8?Q?Bede-Fazekas_=c3=81kos?=)
Date: Fri, 10 Feb 2023 18:53:01 +0100
Subject: [R-sig-Geo] 
 st_intersection produce Geometry type: GEOMETRY instead
 of Geometry type: POLYGON
In-Reply-To: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>
References: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>
Message-ID: <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>

Dear Manuel,

technically, the result of st_intersection(x, y), where both x and y are 
POLYGONs, can be POINT, LINESTRING, POLGYON and GEOMETRY as well. The 
result is GEOMETRY if the type of the different features is not the same 
(e.g. POLYGON+POINT).
You can subset the result in this way:
g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type = "POLYGON")]

HTH,
?kos
___________
?kos Bede-Fazekas
Centre for Ecological Research, Hungary

2023.02.10. 18:32 keltez?ssel, Manuel Sp?nola ?rta:
> Dear list members,
>
> I am trying to "crop" a polygon (grid) with a polygon, but the result is an
> sf object Geometry type: GEOMETRY, instead of an sf object Geometry type:
> POLYGON.
>
> How can I obtain an sf POLYGON?
>
> nc = st_read(system.file("shape/nc.shp", package="sf"))
>
>
>
> nc <- st_transform(nc, 3857)
>
>
>
> g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
>
>
>
> g_50000 <- g_50000[nc, ]
>
>
>
> g_50000_d <- st_union(g_50000)
>
>
>
> g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
>
>
>
> g_25000 # Geometry type: POLYGON
>
>
>
> g_25000_c <- st_intersection(g_25000, g_50000_d)
>
>
>
> g_25000_c # Geometry type: GEOMETRY
>
>
>
>


From jo@|@h@p@rry @end|ng |rom gm@||@com  Fri Feb 10 19:09:25 2023
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Fri, 10 Feb 2023 13:09:25 -0500
Subject: [R-sig-Geo] 
 st_intersection produce Geometry type: GEOMETRY instead
 of Geometry type: POLYGON
In-Reply-To: <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>
References: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>
 <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>
Message-ID: <CAL3ufUKLd1V7KPS1ryC-8KboMvtn-fvCy1YPpr8tvrU3R76Www@mail.gmail.com>

Manuel, I think you're looking for an intersect*s* rather than the
intersection. Is the following what you're after?


nc = st_read(system.file("shape/nc.shp", package="sf"))
nc <- st_transform(nc, 3857)
g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
g_50000 <- g_50000[nc, ]
g_50000_d <- st_union(g_50000)
g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
g_25000 # Geometry type: POLYGON

index <- which(lengths(st_intersects(g_50000, nc)) > 0)
plot(st_union(g_50000[index,]))

On Fri, Feb 10, 2023 at 12:53 PM Bede-Fazekas ?kos <bfalevlist at gmail.com>
wrote:

> Dear Manuel,
>
> technically, the result of st_intersection(x, y), where both x and y are
> POLYGONs, can be POINT, LINESTRING, POLGYON and GEOMETRY as well. The
> result is GEOMETRY if the type of the different features is not the same
> (e.g. POLYGON+POINT).
> You can subset the result in this way:
> g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type =
> "POLYGON")]
>
> HTH,
> ?kos
> ___________
> ?kos Bede-Fazekas
> Centre for Ecological Research, Hungary
>
> 2023.02.10. 18:32 keltez?ssel, Manuel Sp?nola ?rta:
> > Dear list members,
> >
> > I am trying to "crop" a polygon (grid) with a polygon, but the result is
> an
> > sf object Geometry type: GEOMETRY, instead of an sf object Geometry type:
> > POLYGON.
> >
> > How can I obtain an sf POLYGON?
> >
> > nc = st_read(system.file("shape/nc.shp", package="sf"))
> >
> >
> >
> > nc <- st_transform(nc, 3857)
> >
> >
> >
> > g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
> >
> >
> >
> > g_50000 <- g_50000[nc, ]
> >
> >
> >
> > g_50000_d <- st_union(g_50000)
> >
> >
> >
> > g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
> >
> >
> >
> > g_25000 # Geometry type: POLYGON
> >
> >
> >
> > g_25000_c <- st_intersection(g_25000, g_50000_d)
> >
> >
> >
> > g_25000_c # Geometry type: GEOMETRY
> >
> >
> >
> >
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From m@rce||no@de|@cruz @end|ng |rom urjc@e@  Fri Feb 10 20:00:19 2023
From: m@rce||no@de|@cruz @end|ng |rom urjc@e@ (Marcelino de la Cruz Rot)
Date: Fri, 10 Feb 2023 20:00:19 +0100
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <f7abe29-99d5-1866-3f3a-3d44c08d4feb@reclus2.nhh.no>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
 <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>
 <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>
 <f7abe29-99d5-1866-3f3a-3d44c08d4feb@reclus2.nhh.no>
Message-ID: <a6078809-7a43-9e98-620c-95d527f6b023@urjc.es>

El 10/02/2023 a las 15:13, Roger Bivand escribi?:
> On Fri, 10 Feb 2023, Marcelino de la Cruz Rot wrote:
>
>> It depends on what you mean by "overimpose".
>>
>> Maybe this way?
>>
>> # some spatial polygon
>
> Please, in the spirit of the evolving r-spatial package ecosystem 
> (maptools will retire during 2023):
>
> library(sf)
> R <- st_as_sf(affine(letterR, mat=diag(c(20,20))))
> plot(R, border="blue")
>
> See https://r-spatial.org/r/2022/12/14/evolution2.html, maybe 
> https://rsbivand.github.io/csds_jan23/bivand_csds_ssg_230117.pdf and 
> https://www.youtube.com/watch?v=TlpjIqTPMCA&list=PLzREt6r1NenmWEidssmLm-VO_YmAh4pq9&index=1
>
> Roger

Thank you Roger!

In the spirit of the evolving, I then suggest this to Manuel:

# define this function (if it is not in your? version of sf)

st_as_sf.tess <- sf:::st_as_sf.owin

# transform tesselations in sf's

Dsf <-? st_as_sf(D)
Csf <-? st_as_sf(C)
Bsf <- st_as_sf(B)
Asf <- st_as_sf(A)

# crop tesselations with spatial polygon

RDsf <- Dsf[R,]
RCsf <- Csf[R,]
RBsf <- Bsf[R,]
RAsf <- Asf[R,]

#overimpose cropped grids
plot(RAsf)
plot(RDsf, border="green", add=T)
plot(RCsf, border="blue", add=T)
plot(RBsf, border="red", add=T)
plot(RAsf, add=T)

Cheers,

Marcelino







>
>> library(maptools)
>> R <- as(affine(letterR, mat=diag(c(20,20))), "SpatialPolygons")
>> plot(R, border="blue")
>>
>> # "overimpose" grids A to C on R:
>> plot(C, border="green", add=T)
>> plot(B, border="red", add=T)
>> plot(A, add=T)
>>
>> Cheers,
>> Marcelino
>>
>>
>>
>> El 10/02/2023 a las 13:29, Manuel Sp?nola escribi?:
>>> ?Thank you very much Marcelino.
>>>
>>> ?And how can overimpose those grids to a spatial polygon?
>>>
>>> ?Manuel
>>>
>>> ?On Fri, 10 Feb 2023 at 03:09 Marcelino de la Cruz Rot
>>> ?<marcelino.delacruz at urjc.es> wrote:
>>>
>>> ???? Dear Manuel,
>>> ???? This is R. There is no "it is possible". Only "how" ;-).
>>>
>>> ???? For example, with spatstat.geom,
>>>
>>> ???? A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
>>> ???? B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
>>> ???? C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
>>> ???? D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))
>>>
>>> ???? Cheers,
>>> ???? Marcelino
>>>
>>>
>>> ???? El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
>>> ??? >? Dear list members,
>>> ??? >
>>> ??? >? Is it possible to generate a spatial nested grid in R?
>>> ??? >
>>> ??? >? For example, a grid of several 8km x 8km tiles, and within that
>>> ???? grid, I
>>> ??? >? want 4 tiles of 4km x 4km, and in each of those I want 4 tiles
>>> ???? of 2km x
>>> ??? >? 2km, and in each of those I want 4 tiles of 1km x 1km.
>>> ??? >
>>> ??? >? Manuel
>>> ??? >
>>> ???? --
>>> ???? Marcelino de la Cruz Rot
>>> ???? Coordinador funcional de Biolog?a
>>> ???? Depto. de Biolog?a y Geolog?a
>>> ???? F?sica y Qu?mica Inorg?nica
>>> ???? Universidad Rey Juan Carlos
>>> ???? M?stoles Espa?a
>>>
>>> ???? _______________________________________________
>>> ???? R-sig-Geo mailing list
>>> ???? R-sig-Geo at r-project.org
>>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Ngv4yEcnP6JM4zq5rpVgzcYgRHAFwPPS8JRFhMaRA58%3D&reserved=0
>>>
>>> ?--
>>> ?*Manuel Sp?nola, Ph.D.*
>>> ?Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
>>> ?Universidad Nacional
>>> ?Apartado 1350-3000
>>> ?Heredia
>>> ?COSTA RICA
>>> ?mspinola at una.cr <mailto:mspinola at una.ac.cr>
>>> ?mspinola10 at gmail.com
>>> ?Tel?fono: (506) 8706 - 4662
>>> ?Institutional website: ICOMVIS
>>> ?<https://eur02.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.icomvis.una.ac.cr%2Findex.php%2Fmanuel&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=fCKSKsYuj7JXD5CbsQDKFUkeAVpqekVl%2BbTYM2dpuzU%3D&reserved=0> 
>>>
>>> ?Blog sobre Ciencia de Datos:
>>> ?https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmspinola-ciencia-de-datos.netlify.app%2F&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=cVcjfP2hgnbfK%2BZCrCGFi4HhnQjGEWtx8zeJ%2BjBZDtE%3D&reserved=0 
>>>
>>
>>
>>
>

-- 
Marcelino de la Cruz Rot
Coordinador funcional de Biolog?a
Depto. de Biolog?a y Geolog?a
F?sica y Qu?mica Inorg?nica
Universidad Rey Juan Carlos
M?stoles Espa?a


From on||ne445934 @end|ng |rom te|kom@@@net  Fri Feb 10 20:55:21 2023
From: on||ne445934 @end|ng |rom te|kom@@@net (dave furniss)
Date: Fri, 10 Feb 2023 21:55:21 +0200 (SAST)
Subject: [R-sig-Geo] Lo Cape projections in sf and terra
Message-ID: <90562685.2562219.1676058921763.JavaMail.zimbra@telkomsa.net>

Hello all

I'm struggling with a projection system used by miners in South Africa, the Lo Cape system. I've put together some commented dummy code that I hope illustrates the issues. If someone could give me some guidance on how to convert between this and other crs's, that would be much appreciated.

### I have lidar collected in an old South African coordinate system,
### the Lo Cape system, which I believe is EPSG 22289 for my site. I've made
### some dummy data to illustrate the problems I'm having in converting 
### data to this projection system or from this to another crs. 

library(sf)
library(terra)

### Make a point from GoogleEarth coordinates and set projection to wgs84
### and then convert to Lo 29 Cape projection (EPSG 22289)

(bridge <- st_sf(st_sfc(st_point(c(29.472945, -25.982804)), crs = 4326)))

(bridgest <- st_transform(bridge, crs = 22289))

### Notice the coordinates have their signs reversed. So the point is 
### now northern and western hemisphere when it should be in the 
### southern and eastern hemisphere. For a set of points I can 
### correct this by dividing the goemetry by -1 as below

(bridgeT <- st_set_geometry(bridgest, st_geometry(bridgest)/-1))

### However, the crs is now lost but the signs on the
### coordinates are switched to what they should be

st_crs(bridgeT) <- 22289
bridgeT

### Lidar data was collected in the Lo 29 cape dataum. I've made
### a dummy raster of this data from the original data:

dumrast <- rast(ncol = 7, nrow = 6, xmin = 47382, xmax = 47389, 
	ymin = -2874721, ymax = -2874715, crs = "EPSG:22289")
values(dumrast) <- c(1562.78, 1562.58, 1562.50, 1562.99, 1563.27, 1563.81, 1564.33, 1562.81,
	1562.66, 1562.61, 1563.35, 1563.57, 1563.96, 1564.38, 1562.87, 1562.72,
	1563.57, 1563.59, 1563.78, 1564.01, 1564.27, 1562.92, 1562.81, 1563.85,
	1563.76, 1563.83, 1564.26, 1564.24, 1562.73, 1562.62, 1562.89, 1563.11,
	1563.21, 1563.47, 1564.38, 1562.69, 1562.55, 1562.47, 1562.80, 1563.05,
	1563.76, 1563.98)
dumrast

### If we plot the DEM and the point, they match

plot(dumrast)
plot(bridgeT, add = TRUE, col = 'red')

### If I try and convert the point crs from Lo Cape to wgs 84, 
### the negative is lost and now instead of being in the southern
### and eastern hemisphere, the point is in the northern and eastern
### hemisphere

bridgeT
(pnt <- st_transform(bridgeT, 4326))

### I derived a drainage from the DEM in ArcGIS. ArcGIS doesn't seem to 
### recognize the crs when the tif is saved in r. Nonetheless I've used
### a portion of the drainage to create a line segment which should match
### another known point built from Google Earth coordinates: 

(seep <- st_sf(st_sfc(st_point(c(29.459556, -26.004615)), crs = 4326)))

### As before, converting the crs from wgs 84 to Lo Cape again switches 
### the positive and negative values

(seept <- st_transform(seep, 22289))
(seepT <- st_set_geometry(seept, st_geometry(seept)/-1))
st_crs(seepT) <- 22289
seepT

### Now I make a short section of the drainage line derived from the
### lidar DEM 

m <- matrix(c(46056.5,-2877155, 46048.5,-2877146, 46046.5,-2877142, 
	46043.5,-2877140, 46037.5,-2877133, 46037.5,-2877131, 46042.5,-2877126, 
	46045.5,-2877118, 46054.5,-2877108, 46057.5,-2877099, 46060.5,-2877097),
	ncol=2, byrow = TRUE)

(ditch <- st_sf(st_sfc(st_linestring(m)), crs = 22289))

plot(ditch, axes = TRUE)
plot(seepT, add = TRUE, col = 'red')

### They match close enough for now.

### If I try and transform the linestring to wgs coordinates, 
### I again lose the negative in the coordinates

(ditch_wgs <- st_transform(ditch, 4326))

### reprojecting a dem

(demWgs <- project(dumrast, "epsg:4326"))

### The crs for the raster also loses its negative values and is rotated.

### So please can someone provide guidance on how best to do these
### transformations or suggest references that may help me find better
### solutions than my hacks. 

> sessionInfo()
R version 4.2.2 (2022-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19044)

Matrix products: default

locale:
[1] LC_COLLATE=English_South Africa.utf8  LC_CTYPE=English_South Africa.utf8  
[3] LC_MONETARY=English_South Africa.utf8 LC_NUMERIC=C                        
[5] LC_TIME=English_South Africa.utf8    

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base    

other attached packages:
[1] terra_1.6-47 sf_1.0-9    

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.9         magrittr_2.0.3     units_0.8-1        tidyselect_1.2.0  
 [5] R6_2.5.1           rlang_1.0.6        fansi_1.0.3        dplyr_1.0.10      
 [9] tools_4.2.2        grid_4.2.2         KernSmooth_2.23-20 utf8_1.2.2        
[13] cli_3.5.0          e1071_1.7-12       DBI_1.1.3          class_7.3-20      
[17] assertthat_0.2.1   tibble_3.1.8       lifecycle_1.0.3    codetools_0.2-18  
[21] vctrs_0.5.1        glue_1.6.2         proxy_0.4-27       compiler_4.2.2    
[25] pillar_1.8.1       generics_0.1.3     classInt_0.4-8     pkgconfig_2.0.3  
>

Thank you

Dr David Furniss, Wits University.


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 21:33:05 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 14:33:05 -0600
Subject: [R-sig-Geo] 
 st_intersection produce Geometry type: GEOMETRY instead
 of Geometry type: POLYGON
In-Reply-To: <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>
References: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>
 <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>
Message-ID: <CABkCotSFHKkf4VPDkFGXFwT52VtGzW3xTU3Y-bHYmL6JbUxa0A@mail.gmail.com>

Thnak you very much Bede-Fazekas.

I got the following error:

g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type = "POLYGON")]

Error in `[.data.frame`(x, i) : undefined columns selected

El vie, 10 feb 2023 a las 11:53, Bede-Fazekas ?kos (<bfalevlist at gmail.com>)
escribi?:

> Dear Manuel,
>
> technically, the result of st_intersection(x, y), where both x and y are
> POLYGONs, can be POINT, LINESTRING, POLGYON and GEOMETRY as well. The
> result is GEOMETRY if the type of the different features is not the same
> (e.g. POLYGON+POINT).
> You can subset the result in this way:
> g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type =
> "POLYGON")]
>
> HTH,
> ?kos
> ___________
> ?kos Bede-Fazekas
> Centre for Ecological Research, Hungary
>
> 2023.02.10. 18:32 keltez?ssel, Manuel Sp?nola ?rta:
> > Dear list members,
> >
> > I am trying to "crop" a polygon (grid) with a polygon, but the result is
> an
> > sf object Geometry type: GEOMETRY, instead of an sf object Geometry type:
> > POLYGON.
> >
> > How can I obtain an sf POLYGON?
> >
> > nc = st_read(system.file("shape/nc.shp", package="sf"))
> >
> >
> >
> > nc <- st_transform(nc, 3857)
> >
> >
> >
> > g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
> >
> >
> >
> > g_50000 <- g_50000[nc, ]
> >
> >
> >
> > g_50000_d <- st_union(g_50000)
> >
> >
> >
> > g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
> >
> >
> >
> > g_25000 # Geometry type: POLYGON
> >
> >
> >
> > g_25000_c <- st_intersection(g_25000, g_50000_d)
> >
> >
> >
> > g_25000_c # Geometry type: GEOMETRY
> >
> >
> >
> >
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 21:36:31 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 14:36:31 -0600
Subject: [R-sig-Geo] 
 st_intersection produce Geometry type: GEOMETRY instead
 of Geometry type: POLYGON
In-Reply-To: <CAL3ufUKLd1V7KPS1ryC-8KboMvtn-fvCy1YPpr8tvrU3R76Www@mail.gmail.com>
References: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>
 <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>
 <CAL3ufUKLd1V7KPS1ryC-8KboMvtn-fvCy1YPpr8tvrU3R76Www@mail.gmail.com>
Message-ID: <CABkCotS3oRs0Sa5y3vRpx4d8ALpY5DNRVmC2_CfLOraHnTYYMA@mail.gmail.com>

Thank you very much Josiah.

If I ran the code you suggested me, How I get the g_25000 object (a grid)?

index <- which(lengths(st_intersects(g_50000, nc)) > 0)
plot(st_union(g_50000[index,]))



El vie, 10 feb 2023 a las 12:10, Josiah Parry (<josiah.parry at gmail.com>)
escribi?:

> Manuel, I think you're looking for an intersect*s* rather than the
> intersection. Is the following what you're after?
>
>
> nc = st_read(system.file("shape/nc.shp", package="sf"))
> nc <- st_transform(nc, 3857)
> g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
> g_50000 <- g_50000[nc, ]
> g_50000_d <- st_union(g_50000)
> g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
> g_25000 # Geometry type: POLYGON
>
> index <- which(lengths(st_intersects(g_50000, nc)) > 0)
> plot(st_union(g_50000[index,]))
>
> On Fri, Feb 10, 2023 at 12:53 PM Bede-Fazekas ?kos <bfalevlist at gmail.com>
> wrote:
>
> > Dear Manuel,
> >
> > technically, the result of st_intersection(x, y), where both x and y are
> > POLYGONs, can be POINT, LINESTRING, POLGYON and GEOMETRY as well. The
> > result is GEOMETRY if the type of the different features is not the same
> > (e.g. POLYGON+POINT).
> > You can subset the result in this way:
> > g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type =
> > "POLYGON")]
> >
> > HTH,
> > ?kos
> > ___________
> > ?kos Bede-Fazekas
> > Centre for Ecological Research, Hungary
> >
> > 2023.02.10. 18:32 keltez?ssel, Manuel Sp?nola ?rta:
> > > Dear list members,
> > >
> > > I am trying to "crop" a polygon (grid) with a polygon, but the result
> is
> > an
> > > sf object Geometry type: GEOMETRY, instead of an sf object Geometry
> type:
> > > POLYGON.
> > >
> > > How can I obtain an sf POLYGON?
> > >
> > > nc = st_read(system.file("shape/nc.shp", package="sf"))
> > >
> > >
> > >
> > > nc <- st_transform(nc, 3857)
> > >
> > >
> > >
> > > g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
> > >
> > >
> > >
> > > g_50000 <- g_50000[nc, ]
> > >
> > >
> > >
> > > g_50000_d <- st_union(g_50000)
> > >
> > >
> > >
> > > g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
> > >
> > >
> > >
> > > g_25000 # Geometry type: POLYGON
> > >
> > >
> > >
> > > g_25000_c <- st_intersection(g_25000, g_50000_d)
> > >
> > >
> > >
> > > g_25000_c # Geometry type: GEOMETRY
> > >
> > >
> > >
> > >
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 21:40:01 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 14:40:01 -0600
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <a6078809-7a43-9e98-620c-95d527f6b023@urjc.es>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <abd947dc-f39e-0808-ad9f-8fe6e123735a@urjc.es>
 <CABkCotQ-fiTGAtNcZk3Hj7Z0CKW0ycqo54Yb=+X8Qzh2_H+Whg@mail.gmail.com>
 <14b42ded-b7ce-28f3-3286-268ef453511f@urjc.es>
 <f7abe29-99d5-1866-3f3a-3d44c08d4feb@reclus2.nhh.no>
 <a6078809-7a43-9e98-620c-95d527f6b023@urjc.es>
Message-ID: <CABkCotTLJ-gE9KhpNN6LWyE5QrS3T-v9amnUbDxGfQ6msF5pCQ@mail.gmail.com>

Thank you very much Marcelino.

Manuel

El vie, 10 feb 2023 a las 13:00, Marcelino de la Cruz Rot (<
marcelino.delacruz at urjc.es>) escribi?:

> El 10/02/2023 a las 15:13, Roger Bivand escribi?:
> > On Fri, 10 Feb 2023, Marcelino de la Cruz Rot wrote:
> >
> >> It depends on what you mean by "overimpose".
> >>
> >> Maybe this way?
> >>
> >> # some spatial polygon
> >
> > Please, in the spirit of the evolving r-spatial package ecosystem
> > (maptools will retire during 2023):
> >
> > library(sf)
> > R <- st_as_sf(affine(letterR, mat=diag(c(20,20))))
> > plot(R, border="blue")
> >
> > See https://r-spatial.org/r/2022/12/14/evolution2.html, maybe
> > https://rsbivand.github.io/csds_jan23/bivand_csds_ssg_230117.pdf and
> >
> https://www.youtube.com/watch?v=TlpjIqTPMCA&list=PLzREt6r1NenmWEidssmLm-VO_YmAh4pq9&index=1
> >
> > Roger
>
> Thank you Roger!
>
> In the spirit of the evolving, I then suggest this to Manuel:
>
> # define this function (if it is not in your  version of sf)
>
> st_as_sf.tess <- sf:::st_as_sf.owin
>
> # transform tesselations in sf's
>
> Dsf <-  st_as_sf(D)
> Csf <-  st_as_sf(C)
> Bsf <- st_as_sf(B)
> Asf <- st_as_sf(A)
>
> # crop tesselations with spatial polygon
>
> RDsf <- Dsf[R,]
> RCsf <- Csf[R,]
> RBsf <- Bsf[R,]
> RAsf <- Asf[R,]
>
> #overimpose cropped grids
> plot(RAsf)
> plot(RDsf, border="green", add=T)
> plot(RCsf, border="blue", add=T)
> plot(RBsf, border="red", add=T)
> plot(RAsf, add=T)
>
> Cheers,
>
> Marcelino
>
>
>
>
>
>
>
> >
> >> library(maptools)
> >> R <- as(affine(letterR, mat=diag(c(20,20))), "SpatialPolygons")
> >> plot(R, border="blue")
> >>
> >> # "overimpose" grids A to C on R:
> >> plot(C, border="green", add=T)
> >> plot(B, border="red", add=T)
> >> plot(A, add=T)
> >>
> >> Cheers,
> >> Marcelino
> >>
> >>
> >>
> >> El 10/02/2023 a las 13:29, Manuel Sp?nola escribi?:
> >>>  Thank you very much Marcelino.
> >>>
> >>>  And how can overimpose those grids to a spatial polygon?
> >>>
> >>>  Manuel
> >>>
> >>>  On Fri, 10 Feb 2023 at 03:09 Marcelino de la Cruz Rot
> >>>  <marcelino.delacruz at urjc.es> wrote:
> >>>
> >>>      Dear Manuel,
> >>>      This is R. There is no "it is possible". Only "how" ;-).
> >>>
> >>>      For example, with spatstat.geom,
> >>>
> >>>      A <- tess(xgrid=seq(0,80, by=8),ygrid=seq(0,80, by=8))
> >>>      B <- tess(xgrid=seq(0,80, by=4),ygrid=seq(0,80, by=4))
> >>>      C <- tess(xgrid=seq(0,80, by=2),ygrid=seq(0,80, by=2))
> >>>      D <- tess(xgrid=seq(0,80, by=1),ygrid=seq(0,80, by=1))
> >>>
> >>>      Cheers,
> >>>      Marcelino
> >>>
> >>>
> >>>      El 10/02/2023 a las 0:21, Manuel Sp?nola escribi?:
> >>>     >  Dear list members,
> >>>     >
> >>>     >  Is it possible to generate a spatial nested grid in R?
> >>>     >
> >>>     >  For example, a grid of several 8km x 8km tiles, and within that
> >>>      grid, I
> >>>     >  want 4 tiles of 4km x 4km, and in each of those I want 4 tiles
> >>>      of 2km x
> >>>     >  2km, and in each of those I want 4 tiles of 1km x 1km.
> >>>     >
> >>>     >  Manuel
> >>>     >
> >>>      --
> >>>      Marcelino de la Cruz Rot
> >>>      Coordinador funcional de Biolog?a
> >>>      Depto. de Biolog?a y Geolog?a
> >>>      F?sica y Qu?mica Inorg?nica
> >>>      Universidad Rey Juan Carlos
> >>>      M?stoles Espa?a
> >>>
> >>>      _______________________________________________
> >>>      R-sig-Geo mailing list
> >>>      R-sig-Geo at r-project.org
> >>>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Ngv4yEcnP6JM4zq5rpVgzcYgRHAFwPPS8JRFhMaRA58%3D&reserved=0
> >>>
> >>>  --
> >>>  *Manuel Sp?nola, Ph.D.*
> >>>  Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
> >>>  Universidad Nacional
> >>>  Apartado 1350-3000
> >>>  Heredia
> >>>  COSTA RICA
> >>>  mspinola at una.cr <mailto:mspinola at una.ac.cr>
> >>>  mspinola10 at gmail.com
> >>>  Tel?fono: (506) 8706 - 4662
> >>>  Institutional website: ICOMVIS
> >>>  <
> https://eur02.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.icomvis.una.ac.cr%2Findex.php%2Fmanuel&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=fCKSKsYuj7JXD5CbsQDKFUkeAVpqekVl%2BbTYM2dpuzU%3D&reserved=0>
>
> >>>
> >>>  Blog sobre Ciencia de Datos:
> >>>
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmspinola-ciencia-de-datos.netlify.app%2F&data=05%7C01%7CRoger.Bivand%40nhh.no%7C0b29de36aca54242ddf008db0b6ade31%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638116325854200214%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=cVcjfP2hgnbfK%2BZCrCGFi4HhnQjGEWtx8zeJ%2BjBZDtE%3D&reserved=0
> >>>
> >>
> >>
> >>
> >
>
> --
> Marcelino de la Cruz Rot
> Coordinador funcional de Biolog?a
> Depto. de Biolog?a y Geolog?a
> F?sica y Qu?mica Inorg?nica
> Universidad Rey Juan Carlos
> M?stoles Espa?a
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From m@rce||no@de|@cruz @end|ng |rom urjc@e@  Fri Feb 10 22:06:11 2023
From: m@rce||no@de|@cruz @end|ng |rom urjc@e@ (Marcelino de la Cruz Rot)
Date: Fri, 10 Feb 2023 22:06:11 +0100
Subject: [R-sig-Geo] 
 st_intersection produce Geometry type: GEOMETRY instead
 of Geometry type: POLYGON
In-Reply-To: <CABkCotSFHKkf4VPDkFGXFwT52VtGzW3xTU3Y-bHYmL6JbUxa0A@mail.gmail.com>
References: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>
 <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>
 <CABkCotSFHKkf4VPDkFGXFwT52VtGzW3xTU3Y-bHYmL6JbUxa0A@mail.gmail.com>
Message-ID: <8b6e4af8-0fd0-8e33-c352-506d868c8e4c@urjc.es>


g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type = "POLYGON"),] # with a comma


El 10/02/2023 a las 21:33, Manuel Sp?nola escribi?:
> Thnak you very much Bede-Fazekas.
>
> I got the following error:
>
> g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type = "POLYGON")]
>
> Error in `[.data.frame`(x, i) : undefined columns selected
>
> El vie, 10 feb 2023 a las 11:53, Bede-Fazekas ?kos (<bfalevlist at gmail.com>)
> escribi?:
>
>> Dear Manuel,
>>
>> technically, the result of st_intersection(x, y), where both x and y are
>> POLYGONs, can be POINT, LINESTRING, POLGYON and GEOMETRY as well. The
>> result is GEOMETRY if the type of the different features is not the same
>> (e.g. POLYGON+POINT).
>> You can subset the result in this way:
>> g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type =
>> "POLYGON")]
>>
>> HTH,
>> ?kos
>> ___________
>> ?kos Bede-Fazekas
>> Centre for Ecological Research, Hungary
>>
>> 2023.02.10. 18:32 keltez?ssel, Manuel Sp?nola ?rta:
>>> Dear list members,
>>>
>>> I am trying to "crop" a polygon (grid) with a polygon, but the result is
>> an
>>> sf object Geometry type: GEOMETRY, instead of an sf object Geometry type:
>>> POLYGON.
>>>
>>> How can I obtain an sf POLYGON?
>>>
>>> nc = st_read(system.file("shape/nc.shp", package="sf"))
>>>
>>>
>>>
>>> nc <- st_transform(nc, 3857)
>>>
>>>
>>>
>>> g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
>>>
>>>
>>>
>>> g_50000 <- g_50000[nc, ]
>>>
>>>
>>>
>>> g_50000_d <- st_union(g_50000)
>>>
>>>
>>>
>>> g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
>>>
>>>
>>>
>>> g_25000 # Geometry type: POLYGON
>>>
>>>
>>>
>>> g_25000_c <- st_intersection(g_25000, g_50000_d)
>>>
>>>
>>>
>>> g_25000_c # Geometry type: GEOMETRY
>>>
>>>
>>>
>>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>

-- 
Marcelino de la Cruz Rot
Coordinador funcional de Biolog?a
Depto. de Biolog?a y Geolog?a
F?sica y Qu?mica Inorg?nica
Universidad Rey Juan Carlos
M?stoles Espa?a


From m@p|no|@10 @end|ng |rom gm@||@com  Fri Feb 10 22:17:40 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 15:17:40 -0600
Subject: [R-sig-Geo] 
 st_intersection produce Geometry type: GEOMETRY instead
 of Geometry type: POLYGON
In-Reply-To: <8b6e4af8-0fd0-8e33-c352-506d868c8e4c@urjc.es>
References: <CABkCotRQ9hChmU-tNEXAX4XOBMXeg04v=EbyJujYfoitbik1ZQ@mail.gmail.com>
 <563816b4-2d1a-d156-59f8-a65445b4bbb6@gmail.com>
 <CABkCotSFHKkf4VPDkFGXFwT52VtGzW3xTU3Y-bHYmL6JbUxa0A@mail.gmail.com>
 <8b6e4af8-0fd0-8e33-c352-506d868c8e4c@urjc.es>
Message-ID: <CABkCotRqNx3X8C2x=znQm7yX67=0dwn6LogZ8ttDzZyWUPtUbg@mail.gmail.com>

Thank you very much Marcelino.

That works.

I also find that this works (with terra):

g_25000_c <- crop(vect(g_25000), vect(g_50000_d))

g_25000_c <- st_as_sf(g_25000_c)


El vie, 10 feb 2023 a las 15:06, Marcelino de la Cruz Rot (<
marcelino.delacruz at urjc.es>) escribi?:

>
> g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type =
> "POLYGON"),] # with a comma
>
>
> El 10/02/2023 a las 21:33, Manuel Sp?nola escribi?:
> > Thnak you very much Bede-Fazekas.
> >
> > I got the following error:
> >
> > g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type =
> "POLYGON")]
> >
> > Error in `[.data.frame`(x, i) : undefined columns selected
> >
> > El vie, 10 feb 2023 a las 11:53, Bede-Fazekas ?kos (<
> bfalevlist at gmail.com>)
> > escribi?:
> >
> >> Dear Manuel,
> >>
> >> technically, the result of st_intersection(x, y), where both x and y are
> >> POLYGONs, can be POINT, LINESTRING, POLGYON and GEOMETRY as well. The
> >> result is GEOMETRY if the type of the different features is not the same
> >> (e.g. POLYGON+POINT).
> >> You can subset the result in this way:
> >> g_25000_c_polygons_only <- g_25000_c[st_is(x = g_25000_c, type =
> >> "POLYGON")]
> >>
> >> HTH,
> >> ?kos
> >> ___________
> >> ?kos Bede-Fazekas
> >> Centre for Ecological Research, Hungary
> >>
> >> 2023.02.10. 18:32 keltez?ssel, Manuel Sp?nola ?rta:
> >>> Dear list members,
> >>>
> >>> I am trying to "crop" a polygon (grid) with a polygon, but the result
> is
> >> an
> >>> sf object Geometry type: GEOMETRY, instead of an sf object Geometry
> type:
> >>> POLYGON.
> >>>
> >>> How can I obtain an sf POLYGON?
> >>>
> >>> nc = st_read(system.file("shape/nc.shp", package="sf"))
> >>>
> >>>
> >>>
> >>> nc <- st_transform(nc, 3857)
> >>>
> >>>
> >>>
> >>> g_50000 <- st_make_grid(nc, cellsize = 50000) |> st_as_sf()
> >>>
> >>>
> >>>
> >>> g_50000 <- g_50000[nc, ]
> >>>
> >>>
> >>>
> >>> g_50000_d <- st_union(g_50000)
> >>>
> >>>
> >>>
> >>> g_25000 = st_make_grid(g_50000_d, cellsize = 25000) |> st_as_sf()
> >>>
> >>>
> >>>
> >>> g_25000 # Geometry type: POLYGON
> >>>
> >>>
> >>>
> >>> g_25000_c <- st_intersection(g_25000, g_50000_d)
> >>>
> >>>
> >>>
> >>> g_25000_c # Geometry type: GEOMETRY
> >>>
> >>>
> >>>
> >>>
> >> _______________________________________________
> >> R-sig-Geo mailing list
> >> R-sig-Geo at r-project.org
> >> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>
> >
>
> --
> Marcelino de la Cruz Rot
> Coordinador funcional de Biolog?a
> Depto. de Biolog?a y Geolog?a
> F?sica y Qu?mica Inorg?nica
> Universidad Rey Juan Carlos
> M?stoles Espa?a
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From md@umner @end|ng |rom gm@||@com  Fri Feb 10 23:36:12 2023
From: md@umner @end|ng |rom gm@||@com (Michael Sumner)
Date: Sat, 11 Feb 2023 09:36:12 +1100
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
Message-ID: <CAAcGz9_e9qDhm2p9pkC_ytm6unj2mnjN-BWhMj8jw0YMUFobVw@mail.gmail.com>

One way is to write it to a (COG) GeoTIFF with overviews ("pyramid", or
zoom levels) - these are pre-calculated copies of the highest resolution
data saved as lower resolution versions.

Do you want this to generate a set of nested data, or is it more about
working with the nested logic?

I'm not sure what version of GDAL is required to write one directly with
terra or raster, but i'll explore. In terms of the nesting logic , you can
read a particular zoom level (or model it with an data-empty object) and
determine cell index using the cells tools in terra (or raster). I think
you would need to generate xyFromCell and use that to cellFromXY between
layers (the arithmetic is not onerous but doesn't exist for reuse anywhere
in R afaik).

I'm interested in this generally for workflows I'm using so might come back
with an example, happy to follow up related questions.

At the command line with COG format you can do
gdalinfo in.tif overviews.if -of COG -co OVERVIEW_COUNT=3  ## 3, for example

or

gdal_translate in.tif overviews.tif
gdaladdo overviews.tif 2 4 8

but, of course there are implications with tile pattern and potential
overlap for a given size. You'd probably also want tiling enabled and
choose a particular tile size (perhaps to match the next resolution down).
And I'd definitely want to make sure my extent was clean whole numbers and
choose sensible sized zoom and tile levels.

Cheers, Mike


On Fri, Feb 10, 2023 at 10:22 AM Manuel Sp?nola <mspinola10 at gmail.com>
wrote:

> Dear list members,
>
> Is it possible to generate a spatial nested grid in R?
>
> For example, a grid of several 8km x 8km tiles, and within that grid, I
> want 4 tiles of 4km x 4km, and in each of those I want 4 tiles of 2km x
> 2km, and in each of those I want 4 tiles of 1km x 1km.
>
> Manuel
>
> --
> *Manuel Sp?nola, Ph.D.*
> Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
> Universidad Nacional
> Apartado 1350-3000
> Heredia
> COSTA RICA
> mspinola at una.cr <mspinola at una.ac.cr>
> mspinola10 at gmail.com
> Tel?fono: (506) 8706 - 4662
> Institutional website: ICOMVIS
> <http://www.icomvis.una.ac.cr/index.php/manuel>
> Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com

	[[alternative HTML version deleted]]


From md@umner @end|ng |rom gm@||@com  Fri Feb 10 23:37:50 2023
From: md@umner @end|ng |rom gm@||@com (Michael Sumner)
Date: Sat, 11 Feb 2023 09:37:50 +1100
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <CAAcGz9_e9qDhm2p9pkC_ytm6unj2mnjN-BWhMj8jw0YMUFobVw@mail.gmail.com>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <CAAcGz9_e9qDhm2p9pkC_ytm6unj2mnjN-BWhMj8jw0YMUFobVw@mail.gmail.com>
Message-ID: <CAAcGz9-2DRT-+dYchOsYbH865_FbMoN4QUY58g7ZZzrgJXE44A@mail.gmail.com>

Oh, with a COG you'd also want control over reading a particular level -
I'm not sure how well that's supported in the "R spatial" realm but I'll
include it in my example, you can always generate VRT to get exactly what
you want from terra and friends.

Cheers, Mike


On Sat, Feb 11, 2023 at 9:36 AM Michael Sumner <mdsumner at gmail.com> wrote:

> One way is to write it to a (COG) GeoTIFF with overviews ("pyramid", or
> zoom levels) - these are pre-calculated copies of the highest resolution
> data saved as lower resolution versions.
>
> Do you want this to generate a set of nested data, or is it more about
> working with the nested logic?
>
> I'm not sure what version of GDAL is required to write one directly with
> terra or raster, but i'll explore. In terms of the nesting logic , you can
> read a particular zoom level (or model it with an data-empty object) and
> determine cell index using the cells tools in terra (or raster). I think
> you would need to generate xyFromCell and use that to cellFromXY between
> layers (the arithmetic is not onerous but doesn't exist for reuse anywhere
> in R afaik).
>
> I'm interested in this generally for workflows I'm using so might come
> back with an example, happy to follow up related questions.
>
> At the command line with COG format you can do
> gdalinfo in.tif overviews.if -of COG -co OVERVIEW_COUNT=3  ## 3, for
> example
>
> or
>
> gdal_translate in.tif overviews.tif
> gdaladdo overviews.tif 2 4 8
>
> but, of course there are implications with tile pattern and potential
> overlap for a given size. You'd probably also want tiling enabled and
> choose a particular tile size (perhaps to match the next resolution down).
> And I'd definitely want to make sure my extent was clean whole numbers and
> choose sensible sized zoom and tile levels.
>
> Cheers, Mike
>
>
> On Fri, Feb 10, 2023 at 10:22 AM Manuel Sp?nola <mspinola10 at gmail.com>
> wrote:
>
>> Dear list members,
>>
>> Is it possible to generate a spatial nested grid in R?
>>
>> For example, a grid of several 8km x 8km tiles, and within that grid, I
>> want 4 tiles of 4km x 4km, and in each of those I want 4 tiles of 2km x
>> 2km, and in each of those I want 4 tiles of 1km x 1km.
>>
>> Manuel
>>
>> --
>> *Manuel Sp?nola, Ph.D.*
>> Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
>> Universidad Nacional
>> Apartado 1350-3000
>> Heredia
>> COSTA RICA
>> mspinola at una.cr <mspinola at una.ac.cr>
>> mspinola10 at gmail.com
>> Tel?fono: (506) 8706 - 4662
>> Institutional website: ICOMVIS
>> <http://www.icomvis.una.ac.cr/index.php/manuel>
>> Blog sobre Ciencia de Datos:
>> https://mspinola-ciencia-de-datos.netlify.app
>>
>>         [[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>
>
> --
> Michael Sumner
> Software and Database Engineer
> Australian Antarctic Division
> Hobart, Australia
> e-mail: mdsumner at gmail.com
>


-- 
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com

	[[alternative HTML version deleted]]


From edzer@pebe@m@ @end|ng |rom un|-muen@ter@de  Fri Feb 10 23:43:15 2023
From: edzer@pebe@m@ @end|ng |rom un|-muen@ter@de (Edzer Pebesma)
Date: Fri, 10 Feb 2023 23:43:15 +0100
Subject: [R-sig-Geo] Lo Cape projections in sf and terra
In-Reply-To: <90562685.2562219.1676058921763.JavaMail.zimbra@telkomsa.net>
References: <90562685.2562219.1676058921763.JavaMail.zimbra@telkomsa.net>
Message-ID: <46b64cfd-8566-d77a-bae8-6e8ccd7572e4@uni-muenster.de>

I ran into this a few months ago while preparing for a workshop I gave 
(online) to SASA22 participants in South Africa: 
https://edzer.github.io/SASA22/workshop.html

If you divide the geometry by -1 (or multiply it by -1) I don't think 
you can simply set back the CRS to the old value (EPSG:22289) as that 
really assumes westing/southing; the relevant part of the WKT2 
representation is:

     CS[Cartesian,2],
         AXIS["westing (Y)",west,
             ORDER[1],
             LENGTHUNIT["metre",1]],
         AXIS["southing (X)",south,
             ORDER[2],
             LENGTHUNIT["metre",1]],

It is intentional that the CRS disappears after you do math operations 
on the coordinates.

But indeed, most of the plotting mechanism in R for spatial data simply 
assume the first axis to be easting, the second to be northing.

On 10/02/2023 20:55, dave furniss wrote:
> Hello all
> 
> I'm struggling with a projection system used by miners in South Africa, the Lo Cape system. I've put together some commented dummy code that I hope illustrates the issues. If someone could give me some guidance on how to convert between this and other crs's, that would be much appreciated.
> 
> ### I have lidar collected in an old South African coordinate system,
> ### the Lo Cape system, which I believe is EPSG 22289 for my site. I've made
> ### some dummy data to illustrate the problems I'm having in converting
> ### data to this projection system or from this to another crs.
> 
> library(sf)
> library(terra)
> 
> ### Make a point from GoogleEarth coordinates and set projection to wgs84
> ### and then convert to Lo 29 Cape projection (EPSG 22289)
> 
> (bridge <- st_sf(st_sfc(st_point(c(29.472945, -25.982804)), crs = 4326)))
> 
> (bridgest <- st_transform(bridge, crs = 22289))
> 
> ### Notice the coordinates have their signs reversed. So the point is
> ### now northern and western hemisphere when it should be in the
> ### southern and eastern hemisphere. For a set of points I can
> ### correct this by dividing the goemetry by -1 as below
> 
> (bridgeT <- st_set_geometry(bridgest, st_geometry(bridgest)/-1))
> 
> ### However, the crs is now lost but the signs on the
> ### coordinates are switched to what they should be
> 
> st_crs(bridgeT) <- 22289
> bridgeT
> 
> ### Lidar data was collected in the Lo 29 cape dataum. I've made
> ### a dummy raster of this data from the original data:
> 
> dumrast <- rast(ncol = 7, nrow = 6, xmin = 47382, xmax = 47389,
> 	ymin = -2874721, ymax = -2874715, crs = "EPSG:22289")
> values(dumrast) <- c(1562.78, 1562.58, 1562.50, 1562.99, 1563.27, 1563.81, 1564.33, 1562.81,
> 	1562.66, 1562.61, 1563.35, 1563.57, 1563.96, 1564.38, 1562.87, 1562.72,
> 	1563.57, 1563.59, 1563.78, 1564.01, 1564.27, 1562.92, 1562.81, 1563.85,
> 	1563.76, 1563.83, 1564.26, 1564.24, 1562.73, 1562.62, 1562.89, 1563.11,
> 	1563.21, 1563.47, 1564.38, 1562.69, 1562.55, 1562.47, 1562.80, 1563.05,
> 	1563.76, 1563.98)
> dumrast
> 
> ### If we plot the DEM and the point, they match
> 
> plot(dumrast)
> plot(bridgeT, add = TRUE, col = 'red')
> 
> ### If I try and convert the point crs from Lo Cape to wgs 84,
> ### the negative is lost and now instead of being in the southern
> ### and eastern hemisphere, the point is in the northern and eastern
> ### hemisphere
> 
> bridgeT
> (pnt <- st_transform(bridgeT, 4326))
> 
> ### I derived a drainage from the DEM in ArcGIS. ArcGIS doesn't seem to
> ### recognize the crs when the tif is saved in r. Nonetheless I've used
> ### a portion of the drainage to create a line segment which should match
> ### another known point built from Google Earth coordinates:
> 
> (seep <- st_sf(st_sfc(st_point(c(29.459556, -26.004615)), crs = 4326)))
> 
> ### As before, converting the crs from wgs 84 to Lo Cape again switches
> ### the positive and negative values
> 
> (seept <- st_transform(seep, 22289))
> (seepT <- st_set_geometry(seept, st_geometry(seept)/-1))
> st_crs(seepT) <- 22289
> seepT
> 
> ### Now I make a short section of the drainage line derived from the
> ### lidar DEM
> 
> m <- matrix(c(46056.5,-2877155, 46048.5,-2877146, 46046.5,-2877142,
> 	46043.5,-2877140, 46037.5,-2877133, 46037.5,-2877131, 46042.5,-2877126,
> 	46045.5,-2877118, 46054.5,-2877108, 46057.5,-2877099, 46060.5,-2877097),
> 	ncol=2, byrow = TRUE)
> 
> (ditch <- st_sf(st_sfc(st_linestring(m)), crs = 22289))
> 
> plot(ditch, axes = TRUE)
> plot(seepT, add = TRUE, col = 'red')
> 
> ### They match close enough for now.
> 
> ### If I try and transform the linestring to wgs coordinates,
> ### I again lose the negative in the coordinates
> 
> (ditch_wgs <- st_transform(ditch, 4326))
> 
> ### reprojecting a dem
> 
> (demWgs <- project(dumrast, "epsg:4326"))
> 
> ### The crs for the raster also loses its negative values and is rotated.
> 
> ### So please can someone provide guidance on how best to do these
> ### transformations or suggest references that may help me find better
> ### solutions than my hacks.
> 
>> sessionInfo()
> R version 4.2.2 (2022-10-31 ucrt)
> Platform: x86_64-w64-mingw32/x64 (64-bit)
> Running under: Windows 10 x64 (build 19044)
> 
> Matrix products: default
> 
> locale:
> [1] LC_COLLATE=English_South Africa.utf8  LC_CTYPE=English_South Africa.utf8
> [3] LC_MONETARY=English_South Africa.utf8 LC_NUMERIC=C
> [5] LC_TIME=English_South Africa.utf8
> 
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
> 
> other attached packages:
> [1] terra_1.6-47 sf_1.0-9
> 
> loaded via a namespace (and not attached):
>   [1] Rcpp_1.0.9         magrittr_2.0.3     units_0.8-1        tidyselect_1.2.0
>   [5] R6_2.5.1           rlang_1.0.6        fansi_1.0.3        dplyr_1.0.10
>   [9] tools_4.2.2        grid_4.2.2         KernSmooth_2.23-20 utf8_1.2.2
> [13] cli_3.5.0          e1071_1.7-12       DBI_1.1.3          class_7.3-20
> [17] assertthat_0.2.1   tibble_3.1.8       lifecycle_1.0.3    codetools_0.2-18
> [21] vctrs_0.5.1        glue_1.6.2         proxy_0.4-27       compiler_4.2.2
> [25] pillar_1.8.1       generics_0.1.3     classInt_0.4-8     pkgconfig_2.0.3
>>
> 
> Thank you
> 
> Dr David Furniss, Wits University.
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081


From m@p|no|@10 @end|ng |rom gm@||@com  Sat Feb 11 00:12:49 2023
From: m@p|no|@10 @end|ng |rom gm@||@com (=?UTF-8?Q?Manuel_Sp=C3=ADnola?=)
Date: Fri, 10 Feb 2023 17:12:49 -0600
Subject: [R-sig-Geo] Spatial nested grid in R
In-Reply-To: <CAAcGz9_e9qDhm2p9pkC_ytm6unj2mnjN-BWhMj8jw0YMUFobVw@mail.gmail.com>
References: <CABkCotTKFDs8iWfqUWV9H+OPALm3L4ivntdwDa8yD23XAUM27g@mail.gmail.com>
 <CAAcGz9_e9qDhm2p9pkC_ytm6unj2mnjN-BWhMj8jw0YMUFobVw@mail.gmail.com>
Message-ID: <CABkCotSpcEq+mkxvi3igOtfauVPVk9ere5c9STN1Wr0+6-k-tQ@mail.gmail.com>

Thank you very much Michael.

My idea is to create a spatial nested grid to conduct spatial surveys for a
monitoring protocol.

I am thinking to create an 8km, 4km, 2km and 1km nested grids so you can
use different tiles according to the desired resolution of species
occurrences, landscape metrics, or other metrics.

 See this
https://gis.stackexchange.com/questions/386664/creating-nested-grid-in-qgis

Manuel




El vie, 10 feb 2023 a las 16:38, Michael Sumner (<mdsumner at gmail.com>)
escribi?:

> One way is to write it to a (COG) GeoTIFF with overviews ("pyramid", or
> zoom levels) - these are pre-calculated copies of the highest resolution
> data saved as lower resolution versions.
>
> Do you want this to generate a set of nested data, or is it more about
> working with the nested logic?
>
> I'm not sure what version of GDAL is required to write one directly with
> terra or raster, but i'll explore. In terms of the nesting logic , you can
> read a particular zoom level (or model it with an data-empty object) and
> determine cell index using the cells tools in terra (or raster). I think
> you would need to generate xyFromCell and use that to cellFromXY between
> layers (the arithmetic is not onerous but doesn't exist for reuse anywhere
> in R afaik).
>
> I'm interested in this generally for workflows I'm using so might come
> back with an example, happy to follow up related questions.
>
> At the command line with COG format you can do
> gdalinfo in.tif overviews.if -of COG -co OVERVIEW_COUNT=3  ## 3, for
> example
>
> or
>
> gdal_translate in.tif overviews.tif
> gdaladdo overviews.tif 2 4 8
>
> but, of course there are implications with tile pattern and potential
> overlap for a given size. You'd probably also want tiling enabled and
> choose a particular tile size (perhaps to match the next resolution down).
> And I'd definitely want to make sure my extent was clean whole numbers and
> choose sensible sized zoom and tile levels.
>
> Cheers, Mike
>
>
> On Fri, Feb 10, 2023 at 10:22 AM Manuel Sp?nola <mspinola10 at gmail.com>
> wrote:
>
>> Dear list members,
>>
>> Is it possible to generate a spatial nested grid in R?
>>
>> For example, a grid of several 8km x 8km tiles, and within that grid, I
>> want 4 tiles of 4km x 4km, and in each of those I want 4 tiles of 2km x
>> 2km, and in each of those I want 4 tiles of 1km x 1km.
>>
>> Manuel
>>
>> --
>> *Manuel Sp?nola, Ph.D.*
>> Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
>> Universidad Nacional
>> Apartado 1350-3000
>> Heredia
>> COSTA RICA
>> mspinola at una.cr <mspinola at una.ac.cr>
>> mspinola10 at gmail.com
>> Tel?fono: (506) 8706 - 4662
>> Institutional website: ICOMVIS
>> <http://www.icomvis.una.ac.cr/index.php/manuel>
>> Blog sobre Ciencia de Datos:
>> https://mspinola-ciencia-de-datos.netlify.app
>>
>>         [[alternative HTML version deleted]]
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>
>
> --
> Michael Sumner
> Software and Database Engineer
> Australian Antarctic Division
> Hobart, Australia
> e-mail: mdsumner at gmail.com
>


-- 
*Manuel Sp?nola, Ph.D.*
Instituto Internacional en Conservaci?n y Manejo de Vida Silvestre
Universidad Nacional
Apartado 1350-3000
Heredia
COSTA RICA
mspinola at una.cr <mspinola at una.ac.cr>
mspinola10 at gmail.com
Tel?fono: (506) 8706 - 4662
Institutional website: ICOMVIS
<http://www.icomvis.una.ac.cr/index.php/manuel>
Blog sobre Ciencia de Datos: https://mspinola-ciencia-de-datos.netlify.app

	[[alternative HTML version deleted]]


From on||ne445934 @end|ng |rom te|kom@@@net  Sat Feb 11 09:22:08 2023
From: on||ne445934 @end|ng |rom te|kom@@@net (dave furniss)
Date: Sat, 11 Feb 2023 10:22:08 +0200 (SAST)
Subject: [R-sig-Geo] Lo Cape projections in sf and terra
In-Reply-To: <46b64cfd-8566-d77a-bae8-6e8ccd7572e4@uni-muenster.de>
References: <90562685.2562219.1676058921763.JavaMail.zimbra@telkomsa.net>
 <46b64cfd-8566-d77a-bae8-6e8ccd7572e4@uni-muenster.de>
Message-ID: <69494763.2828370.1676103728817.JavaMail.zimbra@telkomsa.net>

Thank you for your rapid response, Edzer. 

I thought my maths on the coordinates was a bit dodgy and my understanding of the deep depths of crs's is rather superficial, so the explanation is appreciated. I shall dig through your workshop and see where I end up.

kind regards
dave

----- Original Message -----
From: "Edzer Pebesma" <edzer.pebesma at uni-muenster.de>
To: r-sig-geo at r-project.org
Sent: Saturday, February 11, 2023 12:43:15 AM
Subject: Re: [R-sig-Geo] Lo Cape projections in sf and terra

I ran into this a few months ago while preparing for a workshop I gave 
(online) to SASA22 participants in South Africa: 
https://edzer.github.io/SASA22/workshop.html

If you divide the geometry by -1 (or multiply it by -1) I don't think 
you can simply set back the CRS to the old value (EPSG:22289) as that 
really assumes westing/southing; the relevant part of the WKT2 
representation is:

     CS[Cartesian,2],
         AXIS["westing (Y)",west,
             ORDER[1],
             LENGTHUNIT["metre",1]],
         AXIS["southing (X)",south,
             ORDER[2],
             LENGTHUNIT["metre",1]],

It is intentional that the CRS disappears after you do math operations 
on the coordinates.

But indeed, most of the plotting mechanism in R for spatial data simply 
assume the first axis to be easting, the second to be northing.

On 10/02/2023 20:55, dave furniss wrote:
> Hello all
> 
> I'm struggling with a projection system used by miners in South Africa, the Lo Cape system. I've put together some commented dummy code that I hope illustrates the issues. If someone could give me some guidance on how to convert between this and other crs's, that would be much appreciated.
> 
> ### I have lidar collected in an old South African coordinate system,
> ### the Lo Cape system, which I believe is EPSG 22289 for my site. I've made
> ### some dummy data to illustrate the problems I'm having in converting
> ### data to this projection system or from this to another crs.
> 
> library(sf)
> library(terra)
> 
> ### Make a point from GoogleEarth coordinates and set projection to wgs84
> ### and then convert to Lo 29 Cape projection (EPSG 22289)
> 
> (bridge <- st_sf(st_sfc(st_point(c(29.472945, -25.982804)), crs = 4326)))
> 
> (bridgest <- st_transform(bridge, crs = 22289))
> 
> ### Notice the coordinates have their signs reversed. So the point is
> ### now northern and western hemisphere when it should be in the
> ### southern and eastern hemisphere. For a set of points I can
> ### correct this by dividing the goemetry by -1 as below
> 
> (bridgeT <- st_set_geometry(bridgest, st_geometry(bridgest)/-1))
> 
> ### However, the crs is now lost but the signs on the
> ### coordinates are switched to what they should be
> 
> st_crs(bridgeT) <- 22289
> bridgeT
> 
> ### Lidar data was collected in the Lo 29 cape dataum. I've made
> ### a dummy raster of this data from the original data:
> 
> dumrast <- rast(ncol = 7, nrow = 6, xmin = 47382, xmax = 47389,
> 	ymin = -2874721, ymax = -2874715, crs = "EPSG:22289")
> values(dumrast) <- c(1562.78, 1562.58, 1562.50, 1562.99, 1563.27, 1563.81, 1564.33, 1562.81,
> 	1562.66, 1562.61, 1563.35, 1563.57, 1563.96, 1564.38, 1562.87, 1562.72,
> 	1563.57, 1563.59, 1563.78, 1564.01, 1564.27, 1562.92, 1562.81, 1563.85,
> 	1563.76, 1563.83, 1564.26, 1564.24, 1562.73, 1562.62, 1562.89, 1563.11,
> 	1563.21, 1563.47, 1564.38, 1562.69, 1562.55, 1562.47, 1562.80, 1563.05,
> 	1563.76, 1563.98)
> dumrast
> 
> ### If we plot the DEM and the point, they match
> 
> plot(dumrast)
> plot(bridgeT, add = TRUE, col = 'red')
> 
> ### If I try and convert the point crs from Lo Cape to wgs 84,
> ### the negative is lost and now instead of being in the southern
> ### and eastern hemisphere, the point is in the northern and eastern
> ### hemisphere
> 
> bridgeT
> (pnt <- st_transform(bridgeT, 4326))
> 
> ### I derived a drainage from the DEM in ArcGIS. ArcGIS doesn't seem to
> ### recognize the crs when the tif is saved in r. Nonetheless I've used
> ### a portion of the drainage to create a line segment which should match
> ### another known point built from Google Earth coordinates:
> 
> (seep <- st_sf(st_sfc(st_point(c(29.459556, -26.004615)), crs = 4326)))
> 
> ### As before, converting the crs from wgs 84 to Lo Cape again switches
> ### the positive and negative values
> 
> (seept <- st_transform(seep, 22289))
> (seepT <- st_set_geometry(seept, st_geometry(seept)/-1))
> st_crs(seepT) <- 22289
> seepT
> 
> ### Now I make a short section of the drainage line derived from the
> ### lidar DEM
> 
> m <- matrix(c(46056.5,-2877155, 46048.5,-2877146, 46046.5,-2877142,
> 	46043.5,-2877140, 46037.5,-2877133, 46037.5,-2877131, 46042.5,-2877126,
> 	46045.5,-2877118, 46054.5,-2877108, 46057.5,-2877099, 46060.5,-2877097),
> 	ncol=2, byrow = TRUE)
> 
> (ditch <- st_sf(st_sfc(st_linestring(m)), crs = 22289))
> 
> plot(ditch, axes = TRUE)
> plot(seepT, add = TRUE, col = 'red')
> 
> ### They match close enough for now.
> 
> ### If I try and transform the linestring to wgs coordinates,
> ### I again lose the negative in the coordinates
> 
> (ditch_wgs <- st_transform(ditch, 4326))
> 
> ### reprojecting a dem
> 
> (demWgs <- project(dumrast, "epsg:4326"))
> 
> ### The crs for the raster also loses its negative values and is rotated.
> 
> ### So please can someone provide guidance on how best to do these
> ### transformations or suggest references that may help me find better
> ### solutions than my hacks.
> 
>> sessionInfo()
> R version 4.2.2 (2022-10-31 ucrt)
> Platform: x86_64-w64-mingw32/x64 (64-bit)
> Running under: Windows 10 x64 (build 19044)
> 
> Matrix products: default
> 
> locale:
> [1] LC_COLLATE=English_South Africa.utf8  LC_CTYPE=English_South Africa.utf8
> [3] LC_MONETARY=English_South Africa.utf8 LC_NUMERIC=C
> [5] LC_TIME=English_South Africa.utf8
> 
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
> 
> other attached packages:
> [1] terra_1.6-47 sf_1.0-9
> 
> loaded via a namespace (and not attached):
>   [1] Rcpp_1.0.9         magrittr_2.0.3     units_0.8-1        tidyselect_1.2.0
>   [5] R6_2.5.1           rlang_1.0.6        fansi_1.0.3        dplyr_1.0.10
>   [9] tools_4.2.2        grid_4.2.2         KernSmooth_2.23-20 utf8_1.2.2
> [13] cli_3.5.0          e1071_1.7-12       DBI_1.1.3          class_7.3-20
> [17] assertthat_0.2.1   tibble_3.1.8       lifecycle_1.0.3    codetools_0.2-18
> [21] vctrs_0.5.1        glue_1.6.2         proxy_0.4-27       compiler_4.2.2
> [25] pillar_1.8.1       generics_0.1.3     classInt_0.4-8     pkgconfig_2.0.3
>>
> 
> Thank you
> 
> Dr David Furniss, Wits University.
> 
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Edzer Pebesma
Institute for Geoinformatics
Heisenbergstrasse 2, 48151 Muenster, Germany
Phone: +49 251 8333081

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://stat.ethz.ch/mailman/listinfo/r-sig-geo


From r@i@1290 m@iii@g oii @im@com  Wed Feb 15 01:28:58 2023
From: r@i@1290 m@iii@g oii @im@com (r@i@1290 m@iii@g oii @im@com)
Date: Wed, 15 Feb 2023 00:28:58 +0000 (UTC)
Subject: [R-sig-Geo] Plotting probability exceedance
References: <1797064006.1810673.1676420938217.ref@mail.yahoo.com>
Message-ID: <1797064006.1810673.1676420938217@mail.yahoo.com>

Hi there,
I have climate data pertaining to extreme precipitation, as well as carbon emissions associated with those precipitation values in a dataframe.?
The goal of my analysis would be to determine the probability of exceeding specific thresholds of precipitation extremes, as well as showing this graphically (I am imagining this by placing extreme precipitation on the the x-axis and exceedance probabilities on the y-axis).
My question is if anyone has an idea how to approach this, or a good starting place? I have looked online, but there is nothing specific to really draw on.
Thank you for your time, and I look forward to your response!
	[[alternative HTML version deleted]]


From b|@|ev||@t @end|ng |rom gm@||@com  Wed Feb 15 07:59:27 2023
From: b|@|ev||@t @end|ng |rom gm@||@com (=?UTF-8?Q?Bede-Fazekas_=c3=81kos?=)
Date: Wed, 15 Feb 2023 07:59:27 +0100
Subject: [R-sig-Geo] Plotting probability exceedance
In-Reply-To: <1797064006.1810673.1676420938217@mail.yahoo.com>
References: <1797064006.1810673.1676420938217.ref@mail.yahoo.com>
 <1797064006.1810673.1676420938217@mail.yahoo.com>
Message-ID: <4943f1cb-402c-fe16-65af-5080254ed90b@gmail.com>

Hello,

You should know or make assumptions on the distribution of the 
precipitation. Let's say it is normally distributed (i.e. bell-shaped). 
Then you can calculate the probability of exceeding the quantile /q/ by
pnorm(q, mean, sd, lower.tail = FALSE).
If you have several spatial points and a lot of measurments (stored in 
columns of the sf/data.frame) for each of the points, then use
apply(X, MARGIN = 1, FUN = function(measurements) {return(pnorm(q, mean, 
sd, lower.tail = FALSE))})
and you can display the probabilities in a map.

HTH,
?kos
__________
?kos Bede-Fazekas
Centre for Ecological Research, Hungary

2023.02.15. 1:28 keltez?ssel, rain1290--- via R-sig-Geo ?rta:
> Hi there,
> I have climate data pertaining to extreme precipitation, as well as carbon emissions associated with those precipitation values in a dataframe.
> The goal of my analysis would be to determine the probability of exceeding specific thresholds of precipitation extremes, as well as showing this graphically (I am imagining this by placing extreme precipitation on the the x-axis and exceedance probabilities on the y-axis).
> My question is if anyone has an idea how to approach this, or a good starting place? I have looked online, but there is nothing specific to really draw on.
> Thank you for your time, and I look forward to your response!
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

	[[alternative HTML version deleted]]


From denn2duk @end|ng |rom y@hoo@com  Wed Feb 15 15:37:25 2023
From: denn2duk @end|ng |rom y@hoo@com (Denys Dukhovnov)
Date: Wed, 15 Feb 2023 14:37:25 +0000 (UTC)
Subject: [R-sig-Geo] Error in splm random effects ML model
References: <2061103156.2038556.1676471845403.ref@mail.yahoo.com>
Message-ID: <2061103156.2038556.1676471845403@mail.yahoo.com>

Dear community,

I am trying to run a spatial panel random effects SEM model using splm package on a balanced spatial panel of N = 2472 and T = 4, and weights are based on k = 6 nearest neighbors. I encounter this error, which I can't find anything about in the documentation or online.

spml(formula = mx.standard ~ I.score,?
? ? ? ? ? ? ? ? ? ? ? ? ?data = analysis.subset,
? ? ? ? ? ? ? ? ? ? ? ? ?listw = listw.wgts,
? ? ? ? ? ? ? ? ? ? ? ? ?effect = "individual",
? ? ? ? ? ? ? ? ? ? ? ? ?model = "random",?
? ? ? ? ? ? ? ? ? ? ? ? ?lag = FALSE,
? ? ? ? ? ? ? ? ? ? ? ? ?spatial.error = "b",
? ? ? ? ? ? ? ? ? ? ? ? ?index = c("Group", "Year"))

Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, "double",??: 
??NAs in argument 7 and 'NAOK = FALSE' (dotCall64)

Unlike the same specification but with fixed effects (with model = "within" argument), the one above takes a long while to run until it crashes.?As far as I can tell, there are no memory issues.

An alternative spatial random effects using spgm() command runs OK, as do non-spatial fixed and random effects models using plm(). For the one above I could use spgm(), but I would prefer to keep all my models in the maximum likelihood estimation for consistency.

Any clarifications as to the nature of the error are welcome.?

Thank you.


Denys Dukhovnov


From Roger@B|v@nd @end|ng |rom nhh@no  Wed Feb 15 17:12:27 2023
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Wed, 15 Feb 2023 17:12:27 +0100 (CET)
Subject: [R-sig-Geo] Error in splm random effects ML model
In-Reply-To: <2061103156.2038556.1676471845403@mail.yahoo.com>
References: <2061103156.2038556.1676471845403.ref@mail.yahoo.com>
 <2061103156.2038556.1676471845403@mail.yahoo.com>
Message-ID: <1914b4e-ed6-668f-7d25-39126b63df84@reclus2.nhh.no>

On Wed, 15 Feb 2023, Denys Dukhovnov via R-sig-Geo wrote:

> Dear community,
>
> I am trying to run a spatial panel random effects SEM model using splm 
> package on a balanced spatial panel of N = 2472 and T = 4, and weights 
> are based on k = 6 nearest neighbors. I encounter this error, which I 
> can't find anything about in the documentation or online.
>
> spml(formula = mx.standard ~ I.score,?
> ? ? ? ? ? ? ? ? ? ? ? ? ?data = analysis.subset,
> ? ? ? ? ? ? ? ? ? ? ? ? ?listw = listw.wgts,
> ? ? ? ? ? ? ? ? ? ? ? ? ?effect = "individual",
> ? ? ? ? ? ? ? ? ? ? ? ? ?model = "random",?
> ? ? ? ? ? ? ? ? ? ? ? ? ?lag = FALSE,
> ? ? ? ? ? ? ? ? ? ? ? ? ?spatial.error = "b",
> ? ? ? ? ? ? ? ? ? ? ? ? ?index = c("Group", "Year"))
>
> Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, 
> "double", :?NAs in argument 7 and 'NAOK = FALSE' (dotCall64)

Please at least provide the output of traceback() after the error (it does 
not crash, it error-exits correctly). Also provide the output of 
sessionInfo() - versions of underlying packages may matter (I'm thinking 
of dotCall64 and packages it uses). .C64() is not called by splm functions 
directly.

Does the error persist on a fully updated system on the same OS?

What happens on a different platform if available?

Ideally, provide a fully reproducible minimal example using built-in data, 
or provide your data and the code used to create analysis.subset and 
listw.wgts, so that the running the code creating the error can be 
reproduced exactly. The error message reports NAs, are the data complete?

Roger


>
> Unlike the same specification but with fixed effects (with model = 
> "within" argument), the one above takes a long while to run until it 
> crashes. As far as I can tell, there are no memory issues.
>
> An alternative spatial random effects using spgm() command runs OK, as 
> do non-spatial fixed and random effects models using plm(). For the one 
> above I could use spgm(), but I would prefer to keep all my models in 
> the maximum likelihood estimation for consistency.
>
> Any clarifications as to the nature of the error are welcome.?
>
> Thank you.
>
>
> Denys Dukhovnov
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7CRoger.Bivand%40nhh.no%7Cd4a3c3a836f44c598f9608db0f6250a2%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638120687160554379%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Oa5KOUxlzjHxBzBfAd12W9WrTRVBynr1bYdJlST%2F17g%3D&reserved=0
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From denn2duk @end|ng |rom y@hoo@com  Wed Feb 15 19:51:49 2023
From: denn2duk @end|ng |rom y@hoo@com (Denys Dukhovnov)
Date: Wed, 15 Feb 2023 18:51:49 +0000 (UTC)
Subject: [R-sig-Geo] Error in splm random effects ML model
In-Reply-To: <1914b4e-ed6-668f-7d25-39126b63df84@reclus2.nhh.no>
References: <2061103156.2038556.1676471845403.ref@mail.yahoo.com>
 <2061103156.2038556.1676471845403@mail.yahoo.com>
 <1914b4e-ed6-668f-7d25-39126b63df84@reclus2.nhh.no>
Message-ID: <1460857658.2198669.1676487109703@mail.yahoo.com>

Dear Roger,?

Yes, I am running R version 4.2.2 and Windows 10 OS x64, packages used updated to the latest version on CRAN. The panel data I am using is complete for all the variables and spatial weights, which made me wonder why the "within" specification runs perfectly fine, while the "random" one breaks down.

Here is the error traceback:


11: .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, "double",
? ? ? ? SS$signature, SS$signature, "double", "double", SS$signature,
? ? ? ? SS$signature, "double", SS$signature, SS$signature, SS$signature,
? ? ? ? SS$signature), nrow, ncol, A at entries, A at colindices, A at rowpointers,
? ? ? ? s, B at entries, B at colindices, B at rowpointers, entries = vector_dc("double",
? ? ? ? ? ? nzmax), colindices = vector_dc(SS$type, nzmax), rowpointers = vector_dc(SS$type,
? ? ? ? ? ? nrow + 1), nzmax + 1, ierr = vector_dc(SS$type, 1), INTENT = c("r",
? ? ? ? ? ? "r", "r", "r", "r", "r", "r", "r", "r", "w", "w", "w",
? ? ? ? ? ? "r", "w"), NAOK = getOption("spam.NAOK"), PACKAGE = SS$package)
10: spam_add(e1, e2, -1)
9: I - lambda * csrw
8: I - lambda * csrw
7: xprodB(lambda, w)
6: invSigma(philambda, n, t., w2)
5: objective(.par, ...)
4: nlminb(start = myparms0, objective = ll.c, gradient = NULL, hessian = NULL,
? ? ? ?y = y, X = X, n = n, t. = t., w = w, w2 = w2, scale = parscale,
? ? ? ?control = list(x.tol = x.tol, rel.tol = rel.tol, trace = trace),
? ? ? ?lower = lower.bounds, upper = upper.bounds)
3: est.fun(X, y, ind, tind, n, k, t, nT, w = w, w2 = w2, coef0 = coef0,
? ? ? ?hess = hess, trace = trace, x.tol = x.tol, rel.tol = rel.tol,
? ? ? ?...)
2: spreml(formula = formula, data = data, index = index, w = listw2mat(listw),
? ? ? ?w2 = listw2mat(listw2), lag = lag, errors = errors, cl = cl,
? ? ? ?...)
1: spml(formula = mx.standard ~ I.score, data = analysis.subset,
? ? ? ?listw = listw.wgts, effect = "individual", model = "random",
? ? ? ?lag = FALSE, spatial.error = "b", index = c("Group", "Year"))



My sessionInfo:

R version 4.2.2 (2022-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19044)


Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8? LC_CTYPE=English_United States.utf8? ? LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C? ? ? ? ? ? ? ? ? ? ? ? ? ?LC_TIME=English_United States.utf8? ??


attached base packages:
[1] stats? ? ?graphics? grDevices utils? ? ?datasets? methods? ?base? ? ?


other attached packages:
?[1] splm_1.6-2? ? ? plm_2.6-2? ? ? ?spdep_1.2-7? ? ?spData_2.2.1? ? sp_1.6-0? ? ? ? forcats_1.0.0? ?stringr_1.5.0? ?dplyr_1.1.0? ? ?purrr_1.0.1? ??
[10] readr_2.1.4? ? ?tidyr_1.3.0? ? ?tibble_3.1.8? ? ggplot2_3.4.1? ?tidyverse_1.3.2 sf_1.0-9? ? ? ?


loaded via a namespace (and not attached):
?[1] nlme_3.1-160? ? ? ? fs_1.6.1? ? ? ? ? ? spatialreg_1.2-6? ? lubridate_1.9.2? ? ?httr_1.4.4? ? ? ? ? tools_4.2.2? ? ? ? ?backports_1.4.1? ??
?[8] utf8_1.2.3? ? ? ? ? R6_2.5.1? ? ? ? ? ? KernSmooth_2.23-20? DBI_1.1.3? ? ? ? ? ?colorspace_2.1-0? ? withr_2.5.0? ? ? ? ?tidyselect_1.2.0? ?
[15] compiler_4.2.2? ? ? cli_3.6.0? ? ? ? ? ?rvest_1.0.3? ? ? ? ?expm_0.999-7? ? ? ? xml2_1.3.3? ? ? ? ? sandwich_3.0-2? ? ? scales_1.2.1? ? ? ?
[22] lmtest_0.9-40? ? ? ?classInt_0.4-8? ? ? proxy_0.4-27? ? ? ? digest_0.6.31? ? ? ?pkgconfig_2.0.3? ? ?dbplyr_2.3.0? ? ? ? collapse_1.9.2? ? ?
[29] ibdreg_0.3.8? ? ? ? rlang_1.0.6? ? ? ? ?readxl_1.4.2? ? ? ? rstudioapi_0.14? ? ?generics_0.1.3? ? ? zoo_1.8-11? ? ? ? ? jsonlite_1.8.4? ? ?
[36] googlesheets4_1.0.1 magrittr_2.0.3? ? ? Formula_1.2-4? ? ? ?s2_1.1.2? ? ? ? ? ? dotCall64_1.0-2? ? ?Matrix_1.5-3? ? ? ? Rcpp_1.0.10? ? ? ??
[43] munsell_0.5.0? ? ? ?fansi_1.0.4? ? ? ? ?lifecycle_1.0.3? ? ?stringi_1.7.8? ? ? ?MASS_7.3-58.1? ? ? ?grid_4.2.2? ? ? ? ? parallel_4.2.2? ? ?
[50] bdsmatrix_1.3-6? ? ?crayon_1.5.2? ? ? ? deldir_1.0-6? ? ? ? lattice_0.20-45? ? ?haven_2.5.1? ? ? ? ?splines_4.2.2? ? ? ?hms_1.1.2? ? ? ? ??
[57] pillar_1.8.1? ? ? ? boot_1.3-28? ? ? ? ?LearnBayes_2.15.1? ?wk_0.7.1? ? ? ? ? ? reprex_2.0.2? ? ? ? glue_1.6.2? ? ? ? ? modelr_0.1.10? ? ??
[64] vctrs_0.5.2? ? ? ? ?spam_2.9-1? ? ? ? ? tzdb_0.3.0? ? ? ? ? Rdpack_2.4? ? ? ? ? miscTools_0.6-26? ? cellranger_1.1.0? ? gtable_0.3.1? ? ? ?
[71] assertthat_0.2.1? ? rbibutils_2.2.13? ? broom_1.0.3? ? ? ? ?e1071_1.7-13? ? ? ? coda_0.19-4? ? ? ? ?class_7.3-20? ? ? ? googledrive_2.0.0??
[78] gargle_1.3.0? ? ? ? units_0.8-1? ? ? ? ?maxLik_1.5-2? ? ? ? timechange_0.2.0? ? ellipsis_0.3.2? ? ?



I tried running the same code on Linux x64 platform as well, with much the same end result.
R version 4.2.2 Patched (2022-11-10 r83330)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 18.04.6 LTS


Here is the link to the minimally reproducible example (code and the actual data):
https://www.dropbox.com/sh/s680xpvfdxowuor/AAAH5yF4JtrzWUgdbvQIF6LBa?dl=0


Thank you for your help.


Denys Dukhovnov



On Wednesday, February 15, 2023 at 11:12:31 AM EST, Roger Bivand <roger.bivand at nhh.no> wrote: 





On Wed, 15 Feb 2023, Denys Dukhovnov via R-sig-Geo wrote:

> Dear community,
>
> I am trying to run a spatial panel random effects SEM model using splm 
> package on a balanced spatial panel of N = 2472 and T = 4, and weights 
> are based on k = 6 nearest neighbors. I encounter this error, which I 
> can't find anything about in the documentation or online.
>
> spml(formula = mx.standard ~ I.score,?
> ? ? ? ? ? ? ? ? ? ? ? ? ?data = analysis.subset,
> ? ? ? ? ? ? ? ? ? ? ? ? ?listw = listw.wgts,
> ? ? ? ? ? ? ? ? ? ? ? ? ?effect = "individual",
> ? ? ? ? ? ? ? ? ? ? ? ? ?model = "random",?
> ? ? ? ? ? ? ? ? ? ? ? ? ?lag = FALSE,
> ? ? ? ? ? ? ? ? ? ? ? ? ?spatial.error = "b",
> ? ? ? ? ? ? ? ? ? ? ? ? ?index = c("Group", "Year"))
>
> Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, 
> "double", :?NAs in argument 7 and 'NAOK = FALSE' (dotCall64)

Please at least provide the output of traceback() after the error (it does 
not crash, it error-exits correctly). Also provide the output of 
sessionInfo() - versions of underlying packages may matter (I'm thinking 
of dotCall64 and packages it uses). .C64() is not called by splm functions 
directly.

Does the error persist on a fully updated system on the same OS?

What happens on a different platform if available?

Ideally, provide a fully reproducible minimal example using built-in data, 
or provide your data and the code used to create analysis.subset and 
listw.wgts, so that the running the code creating the error can be 
reproduced exactly. The error message reports NAs, are the data complete?

Roger


>
> Unlike the same specification but with fixed effects (with model = 
> "within" argument), the one above takes a long while to run until it 
> crashes. As far as I can tell, there are no memory issues.
>
> An alternative spatial random effects using spgm() command runs OK, as 
> do non-spatial fixed and random effects models using plm(). For the one 
> above I could use spgm(), but I would prefer to keep all my models in 
> the maximum likelihood estimation for consistency.
>
> Any clarifications as to the nature of the error are welcome.?
>
> Thank you.
>
>
> Denys Dukhovnov
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7CRoger.Bivand%40nhh.no%7Cd4a3c3a836f44c598f9608db0f6250a2%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638120687160554379%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Oa5KOUxlzjHxBzBfAd12W9WrTRVBynr1bYdJlST%2F17g%3D&reserved=0
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From r@i@1290 m@iii@g oii @im@com  Thu Feb 16 02:52:00 2023
From: r@i@1290 m@iii@g oii @im@com (r@i@1290 m@iii@g oii @im@com)
Date: Thu, 16 Feb 2023 01:52:00 +0000 (UTC)
Subject: [R-sig-Geo] Plotting probability exceedance
In-Reply-To: <4943f1cb-402c-fe16-65af-5080254ed90b@gmail.com>
References: <1797064006.1810673.1676420938217.ref@mail.yahoo.com>
 <1797064006.1810673.1676420938217@mail.yahoo.com>
 <4943f1cb-402c-fe16-65af-5080254ed90b@gmail.com>
Message-ID: <1702816698.2397838.1676512320184@mail.yahoo.com>

Hi Akos,
Thank you so much for this suggestion! Indeed, I have 25 data points in each column, and yes, the data are normally distributed. Using the pnorm function is actually quite useful, as well. To that end, could the values of exceedance probability from pnorm be somehow plotted against their associated precipitation thresholds on an xy plot, for example?
Another idea that came to mind is the use of Probability Density Functions, but can these really be used to graphically show exceedance probabilities?
Thanks, again!
-----Original Message-----
From: Bede-Fazekas ?kos <bfalevlist at gmail.com>
To: r-sig-geo at r-project.org
Sent: Wed, Feb 15, 2023 1:59 am
Subject: Re: [R-sig-Geo] Plotting probability exceedance

Hello,

You should know or make assumptions on the distribution of the 
precipitation. Let's say it is normally distributed (i.e. bell-shaped). 
Then you can calculate the probability of exceeding the quantile /q/ by
pnorm(q, mean, sd, lower.tail = FALSE).
If you have several spatial points and a lot of measurments (stored in 
columns of the sf/data.frame) for each of the points, then use
apply(X, MARGIN = 1, FUN = function(measurements) {return(pnorm(q, mean, 
sd, lower.tail = FALSE))})
and you can display the probabilities in a map.

HTH,
?kos
__________
?kos Bede-Fazekas
Centre for Ecological Research, Hungary

2023.02.15. 1:28 keltez?ssel, rain1290--- via R-sig-Geo ?rta:
> Hi there,
> I have climate data pertaining to extreme precipitation, as well as carbon emissions associated with those precipitation values in a dataframe.
> The goal of my analysis would be to determine the probability of exceeding specific thresholds of precipitation extremes, as well as showing this graphically (I am imagining this by placing extreme precipitation on the the x-axis and exceedance probabilities on the y-axis).
> My question is if anyone has an idea how to approach this, or a good starting place? I have looked online, but there is nothing specific to really draw on.
> Thank you for your time, and I look forward to your response!
> ??? [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

??? [[alternative HTML version deleted]]

_______________________________________________
R-sig-Geo mailing list
R-sig-Geo at r-project.org
https://stat.ethz.ch/mailman/listinfo/r-sig-geo

	[[alternative HTML version deleted]]


From b|@|ev||@t @end|ng |rom gm@||@com  Thu Feb 16 08:55:15 2023
From: b|@|ev||@t @end|ng |rom gm@||@com (=?UTF-8?Q?Bede-Fazekas_=c3=81kos?=)
Date: Thu, 16 Feb 2023 08:55:15 +0100
Subject: [R-sig-Geo] Plotting probability exceedance
In-Reply-To: <1702816698.2397838.1676512320184@mail.yahoo.com>
References: <1797064006.1810673.1676420938217.ref@mail.yahoo.com>
 <1797064006.1810673.1676420938217@mail.yahoo.com>
 <4943f1cb-402c-fe16-65af-5080254ed90b@gmail.com>
 <1702816698.2397838.1676512320184@mail.yahoo.com>
Message-ID: <0f9436cf-d246-5546-1ae1-3fec32b45cc1@gmail.com>

Hello,
As far as I understand, for one point (i.e., one row of the 
sf/data.frame) you have several precipitation values, but can calculate 
one exceedance probability from these values. So an xy-plot is not the 
best choice for visualization of this kind of data. Or you'll have the 
same y value (probability) for several x values (precipitation). If this 
is not a problem for you, then I suggest using tidyr::pivot_longer() to 
transfrom the precipitation values from the several columns to one. Then 
you can draw the xy-plot by ggplot or base plot or even lattice plot.
HTH,
?kos
__________
?kos Bede-Fazekas
Centre for Ecological Research, Hungary

2023.02.16. 2:52 keltez?ssel, rain1290 at aim.com ?rta:
> Hi Akos,
>
> Thank you so much for this suggestion! Indeed, I have 25 data points 
> in each column, and yes, the data are normally distributed. Using the 
> pnorm function is actually quite useful, as well. To that end, could 
> the values of exceedance probability from pnorm be somehow plotted 
> against their associated precipitation thresholds on an xy plot, for 
> example?
>
> Another idea that came to mind is the use of Probability Density 
> Functions, but can these really be used to graphically show exceedance 
> probabilities?
>
> Thanks, again!
>
> -----Original Message-----
> From: Bede-Fazekas ?kos <bfalevlist at gmail.com>
> To: r-sig-geo at r-project.org
> Sent: Wed, Feb 15, 2023 1:59 am
> Subject: Re: [R-sig-Geo] Plotting probability exceedance
>
> Hello,
>
> You should know or make assumptions on the distribution of the
> precipitation. Let's say it is normally distributed (i.e. bell-shaped).
> Then you can calculate the probability of exceeding the quantile /q/ by
> pnorm(q, mean, sd, lower.tail = FALSE).
> If you have several spatial points and a lot of measurments (stored in
> columns of the sf/data.frame) for each of the points, then use
> apply(X, MARGIN = 1, FUN = function(measurements) {return(pnorm(q, mean,
> sd, lower.tail = FALSE))})
> and you can display the probabilities in a map.
>
> HTH,
> ?kos
> __________
> ?kos Bede-Fazekas
> Centre for Ecological Research, Hungary
>
> 2023.02.15. 1:28 keltez?ssel, rain1290--- via R-sig-Geo ?rta:
> > Hi there,
> > I have climate data pertaining to extreme precipitation, as well as 
> carbon emissions associated with those precipitation values in a 
> dataframe.
> > The goal of my analysis would be to determine the probability of 
> exceeding specific thresholds of precipitation extremes, as well as 
> showing this graphically (I am imagining this by placing extreme 
> precipitation on the the x-axis and exceedance probabilities on the 
> y-axis).
> > My question is if anyone has an idea how to approach this, or a good 
> starting place? I have looked online, but there is nothing specific to 
> really draw on.
> > Thank you for your time, and I look forward to your response!
> > ??? [[alternative HTML version deleted]]
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
> ??? [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Feb 16 09:49:39 2023
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 16 Feb 2023 09:49:39 +0100 (CET)
Subject: [R-sig-Geo] Error in splm random effects ML model
In-Reply-To: <1460857658.2198669.1676487109703@mail.yahoo.com>
References: <2061103156.2038556.1676471845403.ref@mail.yahoo.com>
 <2061103156.2038556.1676471845403@mail.yahoo.com>
 <1914b4e-ed6-668f-7d25-39126b63df84@reclus2.nhh.no>
 <1460857658.2198669.1676487109703@mail.yahoo.com>
Message-ID: <289a5e2d-2496-bbb2-df77-d23b688431d6@reclus2.nhh.no>

On Wed, 15 Feb 2023, Denys Dukhovnov wrote:

> Dear Roger,?
>
> Yes, I am running R version 4.2.2 and Windows 10 OS x64, packages used 
> updated to the latest version on CRAN. The panel data I am using is 
> complete for all the variables and spatial weights, which made me wonder 
> why the "within" specification runs perfectly fine, while the "random" 
> one breaks down.
>
> Here is the error traceback:
>
>
> 11: .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, "double",
> ? ? ? ? SS$signature, SS$signature, "double", "double", SS$signature,
> ? ? ? ? SS$signature, "double", SS$signature, SS$signature, SS$signature,
> ? ? ? ? SS$signature), nrow, ncol, A at entries, A at colindices, A at rowpointers,
> ? ? ? ? s, B at entries, B at colindices, B at rowpointers, entries = vector_dc("double",
> ? ? ? ? ? ? nzmax), colindices = vector_dc(SS$type, nzmax), rowpointers = vector_dc(SS$type,
> ? ? ? ? ? ? nrow + 1), nzmax + 1, ierr = vector_dc(SS$type, 1), INTENT = c("r",
> ? ? ? ? ? ? "r", "r", "r", "r", "r", "r", "r", "r", "w", "w", "w",
> ? ? ? ? ? ? "r", "w"), NAOK = getOption("spam.NAOK"), PACKAGE = SS$package)
> 10: spam_add(e1, e2, -1)
> 9: I - lambda * csrw
> 8: I - lambda * csrw
> 7: xprodB(lambda, w)

This is where the problem lies:

library(spam)
csrw <- as.spam(wgts)
n <- nrow(wgts)
I <- diag.spam(1, n, n)
lambda <- 0
B <-  I - lambda * csrw

is OK. If lambda is NaN:

lambda <- NaN
B <-  I - lambda * csrw
Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, 
"double",  :
   NAs in argument 7 and 'NAOK = FALSE' (dotCall64)

If lambda is Inf:

lambda <- Inf
B <-  I - lambda * csrw
Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, 
"double",  :
   NAs in argument 7 and 'NAOK = FALSE' (dotCall64)

and so on. The default method="nlminb" can be changed to "BFGS":

> system.time(reg.splm.random <- spml(formula = mx.standard ~ I.score, 
data = analysis.subset, listw = listw.wgts, effect = "individual", model = 
"random", lag = FALSE, spatial.error = "b", index = c("Group", "Year"), 
method="BFGS")
+ )
     user   system  elapsed
4191.258  391.390 4597.724
> 4597.724/60
[1] 76.62873

taking just over 75 minutes to complete

> summary(reg.splm.random)
ML panel with , random effects, spatial error correlation

Call:
spreml(formula = formula, data = data, index = index, w = 
listw2mat(listw),
     w2 = listw2mat(listw2), lag = lag, errors = errors, cl = cl,
     method = "BFGS")

Residuals:
      Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
-5.75e-03 -1.08e-03  2.42e-05 -7.50e-06  1.07e-03  8.02e-03

Error variance parameters:
     Estimate Std. Error t-value Pr(>|t|)
phi 0.045798        NaN     NaN      NaN
rho 0.725055        NaN     NaN      NaN

Coefficients:
               Estimate Std. Error  t-value  Pr(>|t|)
(Intercept) 1.0284e-02 5.0441e-05 203.8892 < 2.2e-16 ***
I.score     5.2369e-03 1.0438e-03   5.0173 5.239e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

The code involves inversion of the nxn matrix I - \lambda W in each call 
to the log likelihood function, hence the long run time. I've added the 
splm maintainer to CC in case this thread didn't yet reach him. I think 
that checking that lambda is finite and returning an infinite ll value if 
not may work, but the documentation of maxLik() and nlminb would need 
checking to see how to signal an invalid lambda.

Hope this clarifies,

Roger

PS. With traceback, it is as simple as setting debug(splm:::semREmod) and 
then setting more debug()s - reading the code also helps; patience is 
however essential.


> 6: invSigma(philambda, n, t., w2)
> 5: objective(.par, ...)
> 4: nlminb(start = myparms0, objective = ll.c, gradient = NULL, hessian = NULL,
> ? ? ? ?y = y, X = X, n = n, t. = t., w = w, w2 = w2, scale = parscale,
> ? ? ? ?control = list(x.tol = x.tol, rel.tol = rel.tol, trace = trace),
> ? ? ? ?lower = lower.bounds, upper = upper.bounds)
> 3: est.fun(X, y, ind, tind, n, k, t, nT, w = w, w2 = w2, coef0 = coef0,
> ? ? ? ?hess = hess, trace = trace, x.tol = x.tol, rel.tol = rel.tol,
> ? ? ? ?...)
> 2: spreml(formula = formula, data = data, index = index, w = listw2mat(listw),
> ? ? ? ?w2 = listw2mat(listw2), lag = lag, errors = errors, cl = cl,
> ? ? ? ?...)
> 1: spml(formula = mx.standard ~ I.score, data = analysis.subset,
> ? ? ? ?listw = listw.wgts, effect = "individual", model = "random",
> ? ? ? ?lag = FALSE, spatial.error = "b", index = c("Group", "Year"))
>
>
>
> My sessionInfo:
>
> R version 4.2.2 (2022-10-31 ucrt)
> Platform: x86_64-w64-mingw32/x64 (64-bit)
> Running under: Windows 10 x64 (build 19044)
>
>
> Matrix products: default
>
>
> locale:
> [1] LC_COLLATE=English_United States.utf8? LC_CTYPE=English_United States.utf8? ? LC_MONETARY=English_United States.utf8
> [4] LC_NUMERIC=C? ? ? ? ? ? ? ? ? ? ? ? ? ?LC_TIME=English_United States.utf8? ??
>
>
> attached base packages:
> [1] stats? ? ?graphics? grDevices utils? ? ?datasets? methods? ?base? ? ?
>
>
> other attached packages:
> ?[1] splm_1.6-2? ? ? plm_2.6-2? ? ? ?spdep_1.2-7? ? ?spData_2.2.1? ? sp_1.6-0? ? ? ? forcats_1.0.0? ?stringr_1.5.0? ?dplyr_1.1.0? ? ?purrr_1.0.1? ??
> [10] readr_2.1.4? ? ?tidyr_1.3.0? ? ?tibble_3.1.8? ? ggplot2_3.4.1? ?tidyverse_1.3.2 sf_1.0-9? ? ? ?
>
>
> loaded via a namespace (and not attached):
> ?[1] nlme_3.1-160? ? ? ? fs_1.6.1? ? ? ? ? ? spatialreg_1.2-6? ? lubridate_1.9.2? ? ?httr_1.4.4? ? ? ? ? tools_4.2.2? ? ? ? ?backports_1.4.1? ??
> ?[8] utf8_1.2.3? ? ? ? ? R6_2.5.1? ? ? ? ? ? KernSmooth_2.23-20? DBI_1.1.3? ? ? ? ? ?colorspace_2.1-0? ? withr_2.5.0? ? ? ? ?tidyselect_1.2.0? ?
> [15] compiler_4.2.2? ? ? cli_3.6.0? ? ? ? ? ?rvest_1.0.3? ? ? ? ?expm_0.999-7? ? ? ? xml2_1.3.3? ? ? ? ? sandwich_3.0-2? ? ? scales_1.2.1? ? ? ?
> [22] lmtest_0.9-40? ? ? ?classInt_0.4-8? ? ? proxy_0.4-27? ? ? ? digest_0.6.31? ? ? ?pkgconfig_2.0.3? ? ?dbplyr_2.3.0? ? ? ? collapse_1.9.2? ? ?
> [29] ibdreg_0.3.8? ? ? ? rlang_1.0.6? ? ? ? ?readxl_1.4.2? ? ? ? rstudioapi_0.14? ? ?generics_0.1.3? ? ? zoo_1.8-11? ? ? ? ? jsonlite_1.8.4? ? ?
> [36] googlesheets4_1.0.1 magrittr_2.0.3? ? ? Formula_1.2-4? ? ? ?s2_1.1.2? ? ? ? ? ? dotCall64_1.0-2? ? ?Matrix_1.5-3? ? ? ? Rcpp_1.0.10? ? ? ??
> [43] munsell_0.5.0? ? ? ?fansi_1.0.4? ? ? ? ?lifecycle_1.0.3? ? ?stringi_1.7.8? ? ? ?MASS_7.3-58.1? ? ? ?grid_4.2.2? ? ? ? ? parallel_4.2.2? ? ?
> [50] bdsmatrix_1.3-6? ? ?crayon_1.5.2? ? ? ? deldir_1.0-6? ? ? ? lattice_0.20-45? ? ?haven_2.5.1? ? ? ? ?splines_4.2.2? ? ? ?hms_1.1.2? ? ? ? ??
> [57] pillar_1.8.1? ? ? ? boot_1.3-28? ? ? ? ?LearnBayes_2.15.1? ?wk_0.7.1? ? ? ? ? ? reprex_2.0.2? ? ? ? glue_1.6.2? ? ? ? ? modelr_0.1.10? ? ??
> [64] vctrs_0.5.2? ? ? ? ?spam_2.9-1? ? ? ? ? tzdb_0.3.0? ? ? ? ? Rdpack_2.4? ? ? ? ? miscTools_0.6-26? ? cellranger_1.1.0? ? gtable_0.3.1? ? ? ?
> [71] assertthat_0.2.1? ? rbibutils_2.2.13? ? broom_1.0.3? ? ? ? ?e1071_1.7-13? ? ? ? coda_0.19-4? ? ? ? ?class_7.3-20? ? ? ? googledrive_2.0.0??
> [78] gargle_1.3.0? ? ? ? units_0.8-1? ? ? ? ?maxLik_1.5-2? ? ? ? timechange_0.2.0? ? ellipsis_0.3.2? ? ?
>
>
>
> I tried running the same code on Linux x64 platform as well, with much the same end result.
> R version 4.2.2 Patched (2022-11-10 r83330)
> Platform: x86_64-pc-linux-gnu (64-bit)
> Running under: Ubuntu 18.04.6 LTS
>
>
> Here is the link to the minimally reproducible example (code and the actual data):
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.dropbox.com%2Fsh%2Fs680xpvfdxowuor%2FAAAH5yF4JtrzWUgdbvQIF6LBa%3Fdl%3D0&data=05%7C01%7Croger.bivand%40nhh.no%7C7b2114f83ed64bb06aad08db0f85b68f%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638120839199952772%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=QX%2BWBZkxcnNypTVT%2FmJTZJC1aUmDluawNH3LGOVosTE%3D&reserved=0
>
>
> Thank you for your help.
>
>
> Denys Dukhovnov
>
>
>
> On Wednesday, February 15, 2023 at 11:12:31 AM EST, Roger Bivand <roger.bivand at nhh.no> wrote:
>
>
>
>
>
> On Wed, 15 Feb 2023, Denys Dukhovnov via R-sig-Geo wrote:
>
>> Dear community,
>>
>> I am trying to run a spatial panel random effects SEM model using splm
>> package on a balanced spatial panel of N = 2472 and T = 4, and weights
>> are based on k = 6 nearest neighbors. I encounter this error, which I
>> can't find anything about in the documentation or online.
>>
>> spml(formula = mx.standard ~ I.score,?
>> ? ? ? ? ? ? ? ? ? ? ? ? ?data = analysis.subset,
>> ? ? ? ? ? ? ? ? ? ? ? ? ?listw = listw.wgts,
>> ? ? ? ? ? ? ? ? ? ? ? ? ?effect = "individual",
>> ? ? ? ? ? ? ? ? ? ? ? ? ?model = "random",?
>> ? ? ? ? ? ? ? ? ? ? ? ? ?lag = FALSE,
>> ? ? ? ? ? ? ? ? ? ? ? ? ?spatial.error = "b",
>> ? ? ? ? ? ? ? ? ? ? ? ? ?index = c("Group", "Year"))
>>
>> Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature,
>> "double", :?NAs in argument 7 and 'NAOK = FALSE' (dotCall64)
>
> Please at least provide the output of traceback() after the error (it does
> not crash, it error-exits correctly). Also provide the output of
> sessionInfo() - versions of underlying packages may matter (I'm thinking
> of dotCall64 and packages it uses). .C64() is not called by splm functions
> directly.
>
> Does the error persist on a fully updated system on the same OS?
>
> What happens on a different platform if available?
>
> Ideally, provide a fully reproducible minimal example using built-in data,
> or provide your data and the code used to create analysis.subset and
> listw.wgts, so that the running the code creating the error can be
> reproduced exactly. The error message reports NAs, are the data complete?
>
> Roger
>
>
>>
>> Unlike the same specification but with fixed effects (with model =
>> "within" argument), the one above takes a long while to run until it
>> crashes. As far as I can tell, there are no memory issues.
>>
>> An alternative spatial random effects using spgm() command runs OK, as
>> do non-spatial fixed and random effects models using plm(). For the one
>> above I could use spgm(), but I would prefer to keep all my models in
>> the maximum likelihood estimation for consistency.
>>
>> Any clarifications as to the nature of the error are welcome.?
>>
>> Thank you.
>>
>>
>> Denys Dukhovnov
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7Croger.bivand%40nhh.no%7C7b2114f83ed64bb06aad08db0f85b68f%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638120839199952772%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=XEUJSidD5%2FFjLSMxlLy%2BX%2FOijPwhkBOyY0C2KnKl3DI%3D&reserved=0
>>
>
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From denn2duk @end|ng |rom y@hoo@com  Thu Feb 16 17:31:56 2023
From: denn2duk @end|ng |rom y@hoo@com (Denys Dukhovnov)
Date: Thu, 16 Feb 2023 16:31:56 +0000 (UTC)
Subject: [R-sig-Geo] Error in splm random effects ML model
In-Reply-To: <289a5e2d-2496-bbb2-df77-d23b688431d6@reclus2.nhh.no>
References: <2061103156.2038556.1676471845403.ref@mail.yahoo.com>
 <2061103156.2038556.1676471845403@mail.yahoo.com>
 <1914b4e-ed6-668f-7d25-39126b63df84@reclus2.nhh.no>
 <1460857658.2198669.1676487109703@mail.yahoo.com>
 <289a5e2d-2496-bbb2-df77-d23b688431d6@reclus2.nhh.no>
Message-ID: <1072773940.2670763.1676565116282@mail.yahoo.com>

Dear Roger,

This is incredibly helpful and much appreciated! I re-ran the model using the method = "BFGS" argument and I can confirm that it worked.?

Best regards,
Denys




On Thursday, February 16, 2023 at 03:49:45 AM EST, Roger Bivand <roger.bivand at nhh.no> wrote: 





On Wed, 15 Feb 2023, Denys Dukhovnov wrote:

> Dear Roger,?
>
> Yes, I am running R version 4.2.2 and Windows 10 OS x64, packages used 
> updated to the latest version on CRAN. The panel data I am using is 
> complete for all the variables and spatial weights, which made me wonder 
> why the "within" specification runs perfectly fine, while the "random" 
> one breaks down.
>
> Here is the error traceback:
>
>
> 11: .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, "double",
> ? ? ? ? SS$signature, SS$signature, "double", "double", SS$signature,
> ? ? ? ? SS$signature, "double", SS$signature, SS$signature, SS$signature,
> ? ? ? ? SS$signature), nrow, ncol, A at entries, A at colindices, A at rowpointers,
> ? ? ? ? s, B at entries, B at colindices, B at rowpointers, entries = vector_dc("double",
> ? ? ? ? ? ? nzmax), colindices = vector_dc(SS$type, nzmax), rowpointers = vector_dc(SS$type,
> ? ? ? ? ? ? nrow + 1), nzmax + 1, ierr = vector_dc(SS$type, 1), INTENT = c("r",
> ? ? ? ? ? ? "r", "r", "r", "r", "r", "r", "r", "r", "w", "w", "w",
> ? ? ? ? ? ? "r", "w"), NAOK = getOption("spam.NAOK"), PACKAGE = SS$package)
> 10: spam_add(e1, e2, -1)
> 9: I - lambda * csrw
> 8: I - lambda * csrw
> 7: xprodB(lambda, w)

This is where the problem lies:

library(spam)
csrw <- as.spam(wgts)
n <- nrow(wgts)
I <- diag.spam(1, n, n)
lambda <- 0
B <-? I - lambda * csrw

is OK. If lambda is NaN:

lambda <- NaN
B <-? I - lambda * csrw
Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, 
"double",? :
? NAs in argument 7 and 'NAOK = FALSE' (dotCall64)

If lambda is Inf:

lambda <- Inf
B <-? I - lambda * csrw
Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature, 
"double",? :
? NAs in argument 7 and 'NAOK = FALSE' (dotCall64)

and so on. The default method="nlminb" can be changed to "BFGS":

> system.time(reg.splm.random <- spml(formula = mx.standard ~ I.score, 
data = analysis.subset, listw = listw.wgts, effect = "individual", model = 
"random", lag = FALSE, spatial.error = "b", index = c("Group", "Year"), 
method="BFGS")
+ )
? ? user? system? elapsed
4191.258? 391.390 4597.724
> 4597.724/60
[1] 76.62873

taking just over 75 minutes to complete

> summary(reg.splm.random)
ML panel with , random effects, spatial error correlation

Call:
spreml(formula = formula, data = data, index = index, w = 
listw2mat(listw),
? ? w2 = listw2mat(listw2), lag = lag, errors = errors, cl = cl,
? ? method = "BFGS")

Residuals:
? ? ? Min.? 1st Qu.? ? Median? ? ? Mean? 3rd Qu.? ? ? Max.
-5.75e-03 -1.08e-03? 2.42e-05 -7.50e-06? 1.07e-03? 8.02e-03

Error variance parameters:
? ? Estimate Std. Error t-value Pr(>|t|)
phi 0.045798? ? ? ? NaN? ? NaN? ? ? NaN
rho 0.725055? ? ? ? NaN? ? NaN? ? ? NaN

Coefficients:
? ? ? ? ? ? ? Estimate Std. Error? t-value? Pr(>|t|)
(Intercept) 1.0284e-02 5.0441e-05 203.8892 < 2.2e-16 ***
I.score? ? 5.2369e-03 1.0438e-03? 5.0173 5.239e-07 ***
---
Signif. codes:? 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

The code involves inversion of the nxn matrix I - \lambda W in each call 
to the log likelihood function, hence the long run time. I've added the 
splm maintainer to CC in case this thread didn't yet reach him. I think 
that checking that lambda is finite and returning an infinite ll value if 
not may work, but the documentation of maxLik() and nlminb would need 
checking to see how to signal an invalid lambda.

Hope this clarifies,

Roger

PS. With traceback, it is as simple as setting debug(splm:::semREmod) and 
then setting more debug()s - reading the code also helps; patience is 
however essential.


> 6: invSigma(philambda, n, t., w2)
> 5: objective(.par, ...)
> 4: nlminb(start = myparms0, objective = ll.c, gradient = NULL, hessian = NULL,
> ? ? ? ?y = y, X = X, n = n, t. = t., w = w, w2 = w2, scale = parscale,
> ? ? ? ?control = list(x.tol = x.tol, rel.tol = rel.tol, trace = trace),
> ? ? ? ?lower = lower.bounds, upper = upper.bounds)
> 3: est.fun(X, y, ind, tind, n, k, t, nT, w = w, w2 = w2, coef0 = coef0,
> ? ? ? ?hess = hess, trace = trace, x.tol = x.tol, rel.tol = rel.tol,
> ? ? ? ?...)
> 2: spreml(formula = formula, data = data, index = index, w = listw2mat(listw),
> ? ? ? ?w2 = listw2mat(listw2), lag = lag, errors = errors, cl = cl,
> ? ? ? ?...)
> 1: spml(formula = mx.standard ~ I.score, data = analysis.subset,
> ? ? ? ?listw = listw.wgts, effect = "individual", model = "random",
> ? ? ? ?lag = FALSE, spatial.error = "b", index = c("Group", "Year"))
>
>
>
> My sessionInfo:
>
> R version 4.2.2 (2022-10-31 ucrt)
> Platform: x86_64-w64-mingw32/x64 (64-bit)
> Running under: Windows 10 x64 (build 19044)
>
>
> Matrix products: default
>
>
> locale:
> [1] LC_COLLATE=English_United States.utf8? LC_CTYPE=English_United States.utf8? ? LC_MONETARY=English_United States.utf8
> [4] LC_NUMERIC=C? ? ? ? ? ? ? ? ? ? ? ? ? ?LC_TIME=English_United States.utf8? ??
>
>
> attached base packages:
> [1] stats? ? ?graphics? grDevices utils? ? ?datasets? methods? ?base? ? ?
>
>
> other attached packages:
> ?[1] splm_1.6-2? ? ? plm_2.6-2? ? ? ?spdep_1.2-7? ? ?spData_2.2.1? ? sp_1.6-0? ? ? ? forcats_1.0.0? ?stringr_1.5.0? ?dplyr_1.1.0? ? ?purrr_1.0.1? ??
> [10] readr_2.1.4? ? ?tidyr_1.3.0? ? ?tibble_3.1.8? ? ggplot2_3.4.1? ?tidyverse_1.3.2 sf_1.0-9? ? ? ?
>
>
> loaded via a namespace (and not attached):
> ?[1] nlme_3.1-160? ? ? ? fs_1.6.1? ? ? ? ? ? spatialreg_1.2-6? ? lubridate_1.9.2? ? ?httr_1.4.4? ? ? ? ? tools_4.2.2? ? ? ? ?backports_1.4.1? ??
> ?[8] utf8_1.2.3? ? ? ? ? R6_2.5.1? ? ? ? ? ? KernSmooth_2.23-20? DBI_1.1.3? ? ? ? ? ?colorspace_2.1-0? ? withr_2.5.0? ? ? ? ?tidyselect_1.2.0? ?
> [15] compiler_4.2.2? ? ? cli_3.6.0? ? ? ? ? ?rvest_1.0.3? ? ? ? ?expm_0.999-7? ? ? ? xml2_1.3.3? ? ? ? ? sandwich_3.0-2? ? ? scales_1.2.1? ? ? ?
> [22] lmtest_0.9-40? ? ? ?classInt_0.4-8? ? ? proxy_0.4-27? ? ? ? digest_0.6.31? ? ? ?pkgconfig_2.0.3? ? ?dbplyr_2.3.0? ? ? ? collapse_1.9.2? ? ?
> [29] ibdreg_0.3.8? ? ? ? rlang_1.0.6? ? ? ? ?readxl_1.4.2? ? ? ? rstudioapi_0.14? ? ?generics_0.1.3? ? ? zoo_1.8-11? ? ? ? ? jsonlite_1.8.4? ? ?
> [36] googlesheets4_1.0.1 magrittr_2.0.3? ? ? Formula_1.2-4? ? ? ?s2_1.1.2? ? ? ? ? ? dotCall64_1.0-2? ? ?Matrix_1.5-3? ? ? ? Rcpp_1.0.10? ? ? ??
> [43] munsell_0.5.0? ? ? ?fansi_1.0.4? ? ? ? ?lifecycle_1.0.3? ? ?stringi_1.7.8? ? ? ?MASS_7.3-58.1? ? ? ?grid_4.2.2? ? ? ? ? parallel_4.2.2? ? ?
> [50] bdsmatrix_1.3-6? ? ?crayon_1.5.2? ? ? ? deldir_1.0-6? ? ? ? lattice_0.20-45? ? ?haven_2.5.1? ? ? ? ?splines_4.2.2? ? ? ?hms_1.1.2? ? ? ? ??
> [57] pillar_1.8.1? ? ? ? boot_1.3-28? ? ? ? ?LearnBayes_2.15.1? ?wk_0.7.1? ? ? ? ? ? reprex_2.0.2? ? ? ? glue_1.6.2? ? ? ? ? modelr_0.1.10? ? ??
> [64] vctrs_0.5.2? ? ? ? ?spam_2.9-1? ? ? ? ? tzdb_0.3.0? ? ? ? ? Rdpack_2.4? ? ? ? ? miscTools_0.6-26? ? cellranger_1.1.0? ? gtable_0.3.1? ? ? ?
> [71] assertthat_0.2.1? ? rbibutils_2.2.13? ? broom_1.0.3? ? ? ? ?e1071_1.7-13? ? ? ? coda_0.19-4? ? ? ? ?class_7.3-20? ? ? ? googledrive_2.0.0??
> [78] gargle_1.3.0? ? ? ? units_0.8-1? ? ? ? ?maxLik_1.5-2? ? ? ? timechange_0.2.0? ? ellipsis_0.3.2? ? ?
>
>
>
> I tried running the same code on Linux x64 platform as well, with much the same end result.
> R version 4.2.2 Patched (2022-11-10 r83330)
> Platform: x86_64-pc-linux-gnu (64-bit)
> Running under: Ubuntu 18.04.6 LTS
>
>
> Here is the link to the minimally reproducible example (code and the actual data):
> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.dropbox.com%2Fsh%2Fs680xpvfdxowuor%2FAAAH5yF4JtrzWUgdbvQIF6LBa%3Fdl%3D0&data=05%7C01%7Croger.bivand%40nhh.no%7C7b2114f83ed64bb06aad08db0f85b68f%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638120839199952772%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=QX%2BWBZkxcnNypTVT%2FmJTZJC1aUmDluawNH3LGOVosTE%3D&reserved=0
>
>
> Thank you for your help.
>
>
> Denys Dukhovnov
>
>
>
> On Wednesday, February 15, 2023 at 11:12:31 AM EST, Roger Bivand <roger.bivand at nhh.no> wrote:
>
>
>
>
>
> On Wed, 15 Feb 2023, Denys Dukhovnov via R-sig-Geo wrote:
>
>> Dear community,
>>
>> I am trying to run a spatial panel random effects SEM model using splm
>> package on a balanced spatial panel of N = 2472 and T = 4, and weights
>> are based on k = 6 nearest neighbors. I encounter this error, which I
>> can't find anything about in the documentation or online.
>>
>> spml(formula = mx.standard ~ I.score,?
>> ? ? ? ? ? ? ? ? ? ? ? ? ?data = analysis.subset,
>> ? ? ? ? ? ? ? ? ? ? ? ? ?listw = listw.wgts,
>> ? ? ? ? ? ? ? ? ? ? ? ? ?effect = "individual",
>> ? ? ? ? ? ? ? ? ? ? ? ? ?model = "random",?
>> ? ? ? ? ? ? ? ? ? ? ? ? ?lag = FALSE,
>> ? ? ? ? ? ? ? ? ? ? ? ? ?spatial.error = "b",
>> ? ? ? ? ? ? ? ? ? ? ? ? ?index = c("Group", "Year"))
>>
>> Error in .C64("aplsb1", SIGNATURE = c(SS$signature, SS$signature,
>> "double", :?NAs in argument 7 and 'NAOK = FALSE' (dotCall64)
>
> Please at least provide the output of traceback() after the error (it does
> not crash, it error-exits correctly). Also provide the output of
> sessionInfo() - versions of underlying packages may matter (I'm thinking
> of dotCall64 and packages it uses). .C64() is not called by splm functions
> directly.
>
> Does the error persist on a fully updated system on the same OS?
>
> What happens on a different platform if available?
>
> Ideally, provide a fully reproducible minimal example using built-in data,
> or provide your data and the code used to create analysis.subset and
> listw.wgts, so that the running the code creating the error can be
> reproduced exactly. The error message reports NAs, are the data complete?
>
> Roger
>
>
>>
>> Unlike the same specification but with fixed effects (with model =
>> "within" argument), the one above takes a long while to run until it
>> crashes. As far as I can tell, there are no memory issues.
>>
>> An alternative spatial random effects using spgm() command runs OK, as
>> do non-spatial fixed and random effects models using plm(). For the one
>> above I could use spgm(), but I would prefer to keep all my models in
>> the maximum likelihood estimation for consistency.
>>
>> Any clarifications as to the nature of the error are welcome.?
>>
>> Thank you.
>>
>>
>> Denys Dukhovnov
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstat.ethz.ch%2Fmailman%2Flistinfo%2Fr-sig-geo&data=05%7C01%7Croger.bivand%40nhh.no%7C7b2114f83ed64bb06aad08db0f85b68f%7C33a15b2f849941998d56f20b5aa91af2%7C0%7C0%7C638120839199952772%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=XEUJSidD5%2FFjLSMxlLy%2BX%2FOijPwhkBOyY0C2KnKl3DI%3D&reserved=0
>>
>
>

-- 
Roger Bivand
Emeritus Professor
Department of Economics, Norwegian School of Economics,
Postboks 3490 Ytre Sandviken, 5045 Bergen, Norway.
e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From n|ko@@tz|ok@@ @end|ng |rom gm@||@com  Fri Feb 17 18:33:12 2023
From: n|ko@@tz|ok@@ @end|ng |rom gm@||@com (Nikolaos Tziokas)
Date: Fri, 17 Feb 2023 17:33:12 +0000
Subject: [R-sig-Geo] Extract residuals from an XGBoost regression as a
 single raster
Message-ID: <CAGg5H0bceOrBCjTVb32y1XQ8Mzv3AvU_RpruZrLBt94ky8X4gg@mail.gmail.com>

Using the caret and xgboost packages and this (
https://www.kaggle.com/code/pelkoja/visual-xgboost-tuning-with-caret)
tutorial, I am running an XGBoost regression (XGBR) and I want to extract
the residuals of the XGBR. I hyper-tuned the model using the caret package
and then, using the 'best' model parameters I used the xgboost package to
perform the regression.

My dataset has the ntl, pop, tirs, agbh variables stored in data.frame (ntl
is the dependent variable while the other three are the independent).
Assuming that my XGBR model is called m and my data.frame is called
block.data, I did:

library(caret)
library(terra)
library(xgboost)
library(doParallel)
library(dplyr)
library(ggplot2)
library(glue)
library(ModelMetrics)
library(readr)

wd = "path/"

block.data = read.csv(paste0(wd, "block.data.csv"))

block.data = subset(block.data, select = c(ntl, tirs, pop, agbh))

set.seed(1123)

samp <- sample(nrow(block.data), 0.80 * nrow(block.data))

train <- block.data[samp, ]
train_x <- as.matrix(select(train, -ntl))
train_y <- train$ntl

test <- block.data[-samp, ]
test_x <- select(test, -ntl)
test_y <- test$ntl

no_cores <- detectCores() - 1
cl = makePSOCKcluster(no_cores)
registerDoParallel(cl)

# default model
grid_default <- expand.grid(
  nrounds = 100,
  max_depth = 6,
  eta = 0.3,
  gamma = 0,
  colsample_bytree = 1,
  min_child_weight = 1,
  subsample = 1
)

train_control <- caret::trainControl(
  method = "none",
  verboseIter = FALSE, # no training log
  allowParallel = TRUE # FALSE for reproducible results
)

xgb_base <- caret::train(
  x = train_x,
  y = train_y,
  trControl = train_control,
  tuneGrid = grid_default,
  method = "xgbTree",
  verbose = TRUE
)

# hyperparameter tuning
# setting up the maximum number of trees
nrounds <- 1000

# note to start nrounds from 200, as smaller learning rates result in
errors so
# big with lower starting points that they'll mess the scales
tune_grid <- expand.grid(
  nrounds = seq(from = 200, to = nrounds, by = 50),
  eta = c(0.025, 0.05, 0.1, 0.3),
  max_depth = c(2, 3, 4, 5, 6),
  gamma = 0,
  colsample_bytree = 1,
  min_child_weight = 1,
  subsample = 1
)

tune_control <- caret::trainControl(
  method = "cv", # cross-validation
  number = 3, # with n folds
  #index = createFolds(tr_treated$Id_clean), # fix the folds
  verboseIter = FALSE, # no training log
  allowParallel = TRUE # FALSE for reproducible results
)

xgb_tune <- caret::train(
  x = train_x,
  y = train_y,
  trControl = tune_control,
  tuneGrid = tune_grid,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot <- function(x, probs = .90) {
  ggplot(x) +
    coord_cartesian(ylim = c(quantile(x$results$RMSE, probs = probs),
min(x$results$RMSE))) +
    theme_bw()
}

tuneplot(xgb_tune)

xgb_tune$bestTune

# find maximum depth
tune_grid2 <- expand.grid(
  nrounds = seq(from = 50, to = nrounds, by = 50),
  eta = xgb_tune$bestTune$eta,
  max_depth = ifelse(xgb_tune$bestTune$max_depth == 2,
                     c(xgb_tune$bestTune$max_depth:4),
                     xgb_tune$bestTune$max_depth -
1:xgb_tune$bestTune$max_depth + 1),
  gamma = 0,
  colsample_bytree = 1,
  min_child_weight = c(1, 2, 3),
  subsample = 1
)

xgb_tune2 <- caret::train(
  x = train_x,
  y = train_y,
  trControl = tune_control,
  tuneGrid = tune_grid2,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune2)

xgb_tune2$bestTune

# different values for row and column sampling
tune_grid3 <- expand.grid(
  nrounds = seq(from = 50, to = nrounds, by = 50),
  eta = xgb_tune$bestTune$eta,
  max_depth = xgb_tune2$bestTune$max_depth,
  gamma = 0,
  colsample_bytree = c(0.4, 0.6, 0.8, 1.0),
  min_child_weight = xgb_tune2$bestTune$min_child_weight,
  subsample = c(0.5, 0.75, 1.0)
)

xgb_tune3 <- caret::train(
  x = train_x,
  y = train_y,
  trControl = tune_control,
  tuneGrid = tune_grid3,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune3, probs = .95)

xgb_tune3$bestTune

set.seed(57)
omp_set_num_threads(2) # caret parallel processing threads

# gamma
tune_grid4 <- expand.grid(
  nrounds = seq(from = 50, to = nrounds, by = 50),
  eta = xgb_tune$bestTune$eta,
  max_depth = xgb_tune2$bestTune$max_depth,
  gamma = c(0, 0.05, 0.1, 0.5, 0.7, 0.9, 1.0),
  colsample_bytree = xgb_tune3$bestTune$colsample_bytree,
  min_child_weight = xgb_tune2$bestTune$min_child_weight,
  subsample = xgb_tune3$bestTune$subsample
)

xgb_tune4 <- caret::train(
  x = train_x,
  y = train_y,
  trControl = tune_control,
  tuneGrid = tune_grid4,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune4)

xgb_tune4$bestTune

# Reducing the Learning Rate
tune_grid5 <- expand.grid(
  nrounds = seq(from = 100, to = 10000, by = 100),
  eta = c(0.01, 0.015, 0.025, 0.05, 0.1),
  max_depth = xgb_tune2$bestTune$max_depth,
  gamma = xgb_tune4$bestTune$gamma,
  colsample_bytree = xgb_tune3$bestTune$colsample_bytree,
  min_child_weight = xgb_tune2$bestTune$min_child_weight,
  subsample = xgb_tune3$bestTune$subsample
)

xgb_tune5 <- caret::train(
  x = train_x,
  y = train_y,
  trControl = tune_control,
  tuneGrid = tune_grid5,
  method = "xgbTree",
  verbose = TRUE
)

tuneplot(xgb_tune5)

xgb_tune5$bestTune

# Fitting the Model
(final_grid <- expand.grid(
  nrounds = xgb_tune5$bestTune$nrounds,
  eta = xgb_tune5$bestTune$eta,
  max_depth = xgb_tune5$bestTune$max_depth,
  gamma = xgb_tune5$bestTune$gamma,
  colsample_bytree = xgb_tune5$bestTune$colsample_bytree,
  min_child_weight = xgb_tune5$bestTune$min_child_weight,
  subsample = xgb_tune5$bestTune$subsample
))

(xgb_model <- caret::train(
  x = train_x,
  y = train_y,
  trControl = train_control,
  tuneGrid = final_grid,
  method = "xgbTree",
  verbose = TRUE
))

stopCluster(cl)

# apply model to the whole data set using xgboost
xgb_m <- xgb.DMatrix(data = data.matrix(block.data), label = block.data$ntl)

m = xgb.train(data = xgb_m,
            max.depth = xgb_tune5$bestTune$max_depth,
            # watchlist = watchlist,
            nrounds = xgb_tune5$bestTune$nrounds,
            min_child_weight = xgb_tune5$bestTune$min_child_weight,
            subsample = xgb_tune5$bestTune$subsample,
            eta = xgb_tune5$bestTune$eta,
            gamma = xgb_tune5$bestTune$gamma,
            colsample_bytree = xgb_tune5$bestTune$colsample_bytree,
            objective = "reg:squarederror")

m

# export xgb residuals
xgb_resids = predict(m, xgb_m, na.rm = TRUE)

sb = c(ntl, pop_res, tirs_res, agbh_res)

xgb_resids = sb$ntl - xgb_resids
plot(xgb_resids) # the plot is raster stack with many layers

Obviously, I am doing something very wrong. How can I export the residuals
of an XGBR as a single raster?

Here is a very small sample of my dataset:

block.data = structure(list(x = c(11880750L, 11879250L, 11879750L,
11880250L,
11880750L, 11881250L, 11879250L, 11879750L, 11880250L, 11880750L,
11881250L, 11878750L, 11879250L, 11879750L, 11880250L, 11880750L,
11881250L, 11879250L, 11879750L, 11880250L, 11880750L, 11881250L,
11881750L, 11882250L, 11879250L, 11879750L, 11880250L, 11880750L,
11881250L, 11881750L, 11882250L, 11882750L, 11879250L, 11879750L
), y = c(1802250L, 1801750L, 1801750L, 1801750L, 1801750L, 1801750L,
1801250L, 1801250L, 1801250L, 1801250L, 1801250L, 1800750L, 1800750L,
1800750L, 1800750L, 1800750L, 1800750L, 1800250L, 1800250L, 1800250L,
1800250L, 1800250L, 1800250L, 1800250L, 1799750L, 1799750L, 1799750L,
1799750L, 1799750L, 1799750L, 1799750L, 1799750L, 1799250L, 1799250L
), ntl = c(18.7969169616699, 25.7222957611084, 23.4188251495361,
25.4322757720947, 16.4593601226807, 12.7868213653564, 30.9337253570557,
29.865758895874, 30.4080600738525, 29.5479888916016, 24.3493347167969,
35.2427635192871, 38.989933013916, 34.6536979675293, 29.4607238769531,
30.7469024658203, 34.3946380615234, 42.8660278320312, 34.7930717468262,
30.9516315460205, 32.20654296875, 39.999755859375, 46.6002235412598,
38.6480979919434, 60.5214920043945, 33.1799964904785, 31.8498134613037,
30.9209423065186, 32.2269744873047, 53.7062034606934, 45.5225944519043,
38.3570976257324, 123.040382385254, 73.0528182983398), pop =
c(19.6407718658447,
610.009216308594, 654.812622070312, 426.475830078125, 66.3839492797852,
10.6471328735352, 443.848846435547, 602.677429199219, 488.478454589844,
387.470947265625, 58.2341117858887, 413.888488769531, 315.057678222656,
354.082946777344, 602.827758789062, 463.518829345703, 296.713928222656,
923.920593261719, 434.436645507812, 799.562927246094, 404.709564208984,
265.043304443359, 366.697235107422, 399.851684570312, 952.2314453125,
870.356994628906, 673.406616210938, 493.521606445312, 273.841888427734,
371.428619384766, 383.057830810547, 320.986755371094, 991.131225585938,
1148.87768554688), tirs = c(39.7242431640625, 44.9583969116211,
41.4048385620117, 42.6056709289551, 40.0976028442383, 38.7490005493164,
44.2747650146484, 43.5645370483398, 41.6180191040039, 40.3799781799316,
38.8664817810059, 44.9089202880859, 44.414306640625, 44.560977935791,
43.1288986206055, 40.9315185546875, 38.8918418884277, 46.3063850402832,
45.5805702209473, 44.9196586608887, 42.2495613098145, 39.3051452636719,
38.7914810180664, 38.6069412231445, 44.6782455444336, 46.4024772644043,
44.4720573425293, 41.7361183166504, 42.3378067016602, 41.0018348693848,
39.3579216003418, 41.6303863525391, 43.8207550048828, 46.0460357666016
), agbh = c(3.32185006141663, 4.98925733566284, 4.35699367523193,
4.94798421859741, 3.14325952529907, 2.93211793899536, 4.52736520767212,
4.99723243713379, 5.13944292068481, 3.92965626716614, 3.43465113639832,
3.55617475509644, 3.4659411907196, 5.24469566345215, 5.36995029449463,
4.61549234390259, 4.82002925872803, 4.20452928543091, 4.71502685546875,
5.20452785491943, 5.05676746368408, 5.9952244758606, 6.16778612136841,
4.69053316116333, 2.62325501441956, 4.74775457382202, 4.93133020401001,
5.02366256713867, 5.74016952514648, 6.28353786468506, 4.67424774169922,
4.56812858581543, 1.88153350353241, 4.31531000137329)), class =
"data.frame", row.names = c(NA,
-34L))
My raster layer:

r = new("RasterBrick", file = new(".RasterFile", name = "", datanotation =
"FLT4S",
    byteorder = "little", nodatavalue = -Inf, NAchanged = FALSE,
    nbands = 1L, bandorder = "BIL", offset = 0L, toptobottom = TRUE,
    blockrows = 0L, blockcols = 0L, driver = "", open = FALSE),
    data = new(".MultipleRasterData", values = structure(c(NA,
    NA, NA, NA, 18.7969169616699, NA, NA, NA, NA, NA, 25.7222957611084,
    23.4188251495361, 25.4322757720947, 16.4593601226807, 12.7868213653564,
    NA, NA, NA, NA, 30.9337253570557, 29.865758895874, 30.4080600738525,
    29.5479888916016, 24.3493347167969, NA, NA, NA, 35.2427635192871,
    38.989933013916, 34.6536979675293, 29.4607238769531, 30.7469024658203,
    34.3946380615234, NA, NA, NA, NA, 42.8660278320312, 34.7930717468262,
    30.9516315460205, 32.20654296875, 39.999755859375, 46.6002235412598,
    38.6480979919434, NA, NA, 60.5214920043945, 33.1799964904785,
    31.8498134613037, 30.9209423065186, 32.2269744873047, 53.7062034606934,
    45.5225944519043, 38.3570976257324, NA, 123.040382385254,
    73.0528182983398, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
    19.6407718658447, NA, NA, NA, NA, NA, 610.009216308594,
654.812622070312,
    426.475830078125, 66.3839492797852, 10.6471328735352, NA,
    NA, NA, NA, 443.848846435547, 602.677429199219, 488.478454589844,
    387.470947265625, 58.2341117858887, NA, NA, NA, 413.888488769531,
    315.057678222656, 354.082946777344, 602.827758789062, 463.518829345703,
    296.713928222656, NA, NA, NA, NA, 923.920593261719, 434.436645507812,
    799.562927246094, 404.709564208984, 265.043304443359, 366.697235107422,
    399.851684570312, NA, NA, 952.2314453125, 870.356994628906,
    673.406616210938, 493.521606445312, 273.841888427734, 371.428619384766,
    383.057830810547, 320.986755371094, NA, 991.131225585938,
    1148.87768554688, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
    39.7242431640625, NA, NA, NA, NA, NA, 44.9583969116211,
41.4048385620117,
    42.6056709289551, 40.0976028442383, 38.7490005493164, NA,
    NA, NA, NA, 44.2747650146484, 43.5645370483398, 41.6180191040039,
    40.3799781799316, 38.8664817810059, NA, NA, NA, 44.9089202880859,
    44.414306640625, 44.560977935791, 43.1288986206055, 40.9315185546875,
    38.8918418884277, NA, NA, NA, NA, 46.3063850402832, 45.5805702209473,
    44.9196586608887, 42.2495613098145, 39.3051452636719, 38.7914810180664,
    38.6069412231445, NA, NA, 44.6782455444336, 46.4024772644043,
    44.4720573425293, 41.7361183166504, 42.3378067016602, 41.0018348693848,
    39.3579216003418, 41.6303863525391, NA, 43.8207550048828,
    46.0460357666016, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
    3.32185006141663, NA, NA, NA, NA, NA, 4.98925733566284,
4.35699367523193,
    4.94798421859741, 3.14325952529907, 2.93211793899536, NA,
    NA, NA, NA, 4.52736520767212, 4.99723243713379, 5.13944292068481,
    3.92965626716614, 3.43465113639832, NA, NA, NA, 3.55617475509644,
    3.4659411907196, 5.24469566345215, 5.36995029449463, 4.61549234390259,
    4.82002925872803, NA, NA, NA, NA, 4.20452928543091, 4.71502685546875,
    5.20452785491943, 5.05676746368408, 5.9952244758606, 6.16778612136841,
    4.69053316116333, NA, NA, 2.62325501441956, 4.74775457382202,
    4.93133020401001, 5.02366256713867, 5.74016952514648, 6.28353786468506,
    4.67424774169922, 4.56812858581543, NA, 1.88153350353241,
    4.31531000137329, NA, NA, NA, NA, NA, NA), .Dim = c(63L,
    4L)), offset = 0, gain = 1, inmemory = TRUE, fromdisk = FALSE,
        nlayers = 4L, dropped = NULL, isfactor = c(FALSE, FALSE,
        FALSE, FALSE), attributes = list(), haveminmax = TRUE,
        min = c(12.7868213653564, 10.6471328735352, 38.6069412231445,
        1.88153350353241), max = c(123.040382385254, 1148.87768554688,
        46.4024772644043, 6.28353786468506), unit = "", names = c("ntl",
        "pop", "tirs", "agbh")), legend = new(".RasterLegend",
        type = character(0), values = logical(0), color = logical(0),
        names = logical(0), colortable = logical(0)), title = character(0),
    extent = new("Extent", xmin = 11878500, xmax = 11883000,
        ymin = 1799000, ymax = 1802500), rotated = FALSE, rotation =
new(".Rotation",
        geotrans = numeric(0), transfun = function ()
        NULL), ncols = 9L, nrows = 7L, crs = new("CRS", projargs =
NA_character_),
    srs = character(0), history = list(), z = list())


-- 
Tziokas Nikolaos
Cartographer

Tel:(+44)07561120302
LinkedIn <http://linkedin.com/in/nikolaos-tziokas-896081130>

	[[alternative HTML version deleted]]


From n|ko@@tz|ok@@ @end|ng |rom gm@||@com  Wed Feb 22 21:36:21 2023
From: n|ko@@tz|ok@@ @end|ng |rom gm@||@com (Nikolaos Tziokas)
Date: Wed, 22 Feb 2023 20:36:21 +0000
Subject: [R-sig-Geo] Spatial random forest prediction: Error when predicting
 at unseen locations at finer spatial scale
Message-ID: <CAGg5H0bxF7ToarmBWvUDTVR70QFBx6oSeqr-j+GPN0xPtp2aGQ@mail.gmail.com>

I am using the package spatialRF in R for a spatial random forest
regression (SRFR) task. I have one response variable and 4 predictors and I
am performing SRFR at a coarse spatial scale. My goal is to take the model
parameters and apply them to a finer spatial resolution in order to predict
the response variable at the finer spatial scale.

When I run

p <- stats::predict(object = model.spatial,           #name of the
spatialRF model
                    data = s,                         # data.frame
containing the predictors at the fine spatial scale (without NaN values)
                    type = "response")$predictions
I am getting this error: Error in predict.ranger.forest(forest, data,
predict.all, num.trees, type,: Error: One or more independent variables not
found in data.

I have checked the column names of s and my original data.frame (the one I
used to build the model at the coarse scale) and they are the same. How can
I use the model i created at the coarse scale to predict the response
variable at a finer spatial scale?

Here is the code:

library(spatialRF)
library(stats)

wd = "path/"

block.data = read.csv(paste0(wd, "block.data.csv")) # coarse resolution

#names of the response variable and the predictors
dependent.variable.name <- "ntl"
predictor.variable.names <- colnames(block.data)[4:7]

#coordinates of the cases
xy <- block.data[, c("x", "y")]

block.data$x <- NULL
block.data$y <- NULL

#distance matrix
distance.matrix <- as.matrix(dist(block.data))
min(distance.matrix)
max(distance.matrix)

#distance thresholds (same units as distance_matrix)
distance.thresholds <- c(0, 20, 50, 100, 200, 500)

#random seed for reproducibility
random.seed <- 456

#creating and registering the cluster
    local.cluster <- parallel::makeCluster(
      parallel::detectCores() - 1,
      type = "PSOCK")
    doParallel::registerDoParallel(cl = local.cluster)

# fitting a non-spatial Random Forest
model.non.spatial <- spatialRF::rf(
data = block.data,
dependent.variable.name = dependent.variable.name,
predictor.variable.names = predictor.variable.names,
distance.matrix = distance.matrix,
distance.thresholds = distance.thresholds,
xy = xy,
seed = random.seed,
verbose = FALSE)

# Fitting a spatial model with rf_spatial()
model.spatial <- spatialRF::rf_spatial(
  model = model.non.spatial,
  method = "mem.moran.sequential",
  verbose = FALSE,
  seed = random.seed)

#stopping the cluster
parallel::stopCluster(cl = local.cluster)

# prediction at a finer spatial scale
s = read.csv(paste0(wd, "s.csv")) # df containg the predictors at fine
scale

p <- stats::predict(object = model.spatial,
                    data = s,
                    type = "response")$predictions

I tried solutions like:

levels(s$lc) <- levels(block.data$lc)

in case I had missing land cover types in the lc column between the spatial
scales, but it didn't work.

>From here
<https://drive.google.com/drive/folders/1KhnQEajpSKh59XuWkxTZcc_2YxPcxYW7?usp=sharing>
you can download the two data.frames.

	[[alternative HTML version deleted]]


From m@rce||no@de|@cruz @end|ng |rom urjc@e@  Thu Feb 23 08:39:38 2023
From: m@rce||no@de|@cruz @end|ng |rom urjc@e@ (Marcelino de la Cruz Rot)
Date: Thu, 23 Feb 2023 08:39:38 +0100
Subject: [R-sig-Geo] 
 Spatial random forest prediction: Error when predicting
 at unseen locations at finer spatial scale
In-Reply-To: <CAGg5H0bxF7ToarmBWvUDTVR70QFBx6oSeqr-j+GPN0xPtp2aGQ@mail.gmail.com>
References: <CAGg5H0bxF7ToarmBWvUDTVR70QFBx6oSeqr-j+GPN0xPtp2aGQ@mail.gmail.com>
Message-ID: <90394a54-3af9-2a34-db9d-4fe9062bd7d8@urjc.es>

Hi Nikolaos:

As you can read in the github page of the package 
(https://blasbenito.github.io/spatialRF/),

*"there are many things this package cannot do*:

  *

    Predict model results over raster data.

  *

    Predict a model result over another region with a different spatial
    structure.

  * ..."

More specifically, the error you report is probably related to a lot of 
spatial predictors derived from the distance matrix (that are included 
in the fitted model) that you are not passing to "predict" the model.


Cheers,
Marcelino


El 22/02/2023 a las 21:36, Nikolaos Tziokas escribi?:
> I am using the package spatialRF in R for a spatial random forest
> regression (SRFR) task. I have one response variable and 4 predictors and I
> am performing SRFR at a coarse spatial scale. My goal is to take the model
> parameters and apply them to a finer spatial resolution in order to predict
> the response variable at the finer spatial scale.
>
> When I run
>
> p <- stats::predict(object = model.spatial,           #name of the
> spatialRF model
>                      data = s,                         # data.frame
> containing the predictors at the fine spatial scale (without NaN values)
>                      type = "response")$predictions
> I am getting this error: Error in predict.ranger.forest(forest, data,
> predict.all, num.trees, type,: Error: One or more independent variables not
> found in data.
>
> I have checked the column names of s and my original data.frame (the one I
> used to build the model at the coarse scale) and they are the same. How can
> I use the model i created at the coarse scale to predict the response
> variable at a finer spatial scale?
>
> Here is the code:
>
> library(spatialRF)
> library(stats)
>
> wd = "path/"
>
> block.data = read.csv(paste0(wd, "block.data.csv")) # coarse resolution
>
> #names of the response variable and the predictors
> dependent.variable.name <- "ntl"
> predictor.variable.names <- colnames(block.data)[4:7]
>
> #coordinates of the cases
> xy <- block.data[, c("x", "y")]
>
> block.data$x <- NULL
> block.data$y <- NULL
>
> #distance matrix
> distance.matrix <- as.matrix(dist(block.data))
> min(distance.matrix)
> max(distance.matrix)
>
> #distance thresholds (same units as distance_matrix)
> distance.thresholds <- c(0, 20, 50, 100, 200, 500)
>
> #random seed for reproducibility
> random.seed <- 456
>
> #creating and registering the cluster
>      local.cluster <- parallel::makeCluster(
>        parallel::detectCores() - 1,
>        type = "PSOCK")
>      doParallel::registerDoParallel(cl = local.cluster)
>
> # fitting a non-spatial Random Forest
> model.non.spatial <- spatialRF::rf(
> data = block.data,
> dependent.variable.name = dependent.variable.name,
> predictor.variable.names = predictor.variable.names,
> distance.matrix = distance.matrix,
> distance.thresholds = distance.thresholds,
> xy = xy,
> seed = random.seed,
> verbose = FALSE)
>
> # Fitting a spatial model with rf_spatial()
> model.spatial <- spatialRF::rf_spatial(
>    model = model.non.spatial,
>    method = "mem.moran.sequential",
>    verbose = FALSE,
>    seed = random.seed)
>
> #stopping the cluster
> parallel::stopCluster(cl = local.cluster)
>
> # prediction at a finer spatial scale
> s = read.csv(paste0(wd, "s.csv")) # df containg the predictors at fine
> scale
>
> p <- stats::predict(object = model.spatial,
>                      data = s,
>                      type = "response")$predictions
>
> I tried solutions like:
>
> levels(s$lc) <- levels(block.data$lc)
>
> in case I had missing land cover types in the lc column between the spatial
> scales, but it didn't work.
>
> >From here
> <https://drive.google.com/drive/folders/1KhnQEajpSKh59XuWkxTZcc_2YxPcxYW7?usp=sharing>
> you can download the two data.frames.
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo


-- 
Marcelino de la Cruz Rot
Depto. de Biolog?a y Geolog?a
F?sica y Qu?mica Inorg?nica
Universidad Rey Juan Carlos
M?stoles Espa?a


