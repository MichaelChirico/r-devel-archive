From nev||@@mo@ @end|ng |rom gm@||@com  Sun Nov  1 00:01:57 2020
From: nev||@@mo@ @end|ng |rom gm@||@com (nevil amos)
Date: Sun, 1 Nov 2020 10:01:57 +1100
Subject: [R-sig-Geo] raster::levels() not working in packaged function.
In-Reply-To: <312c6bc4-9d77-9521-71a2-1aad75b9ed6d@urjc.es>
References: <CAN9eD7=C3jeZu9yiv4u_=FpQiaihmp3puH8n86RMKyBgXZDWtA@mail.gmail.com>
 <312c6bc4-9d77-9521-71a2-1aad75b9ed6d@urjc.es>
Message-ID: <CAN9eD7=2AuQmaM5MO5EMrxJUJJBRU1+En7GYHTWOYCBg1wYT5w@mail.gmail.com>

Many thanks,

That worked, since the NAMESPACE file incudes a warning about editing it
directly I ysed the reoygen tag in the fucntion script
#' @import raster.

On Sun, 1 Nov 2020 at 00:18, Marcelino de la Cruz Rot <
marcelino.delacruz at urjc.es> wrote:

> Maybe including
>
> import(raster)
>
> or
>
> importFrom("raster", "levels")
>
> in the package NAMESPACE would help.
>
> Cheers,
>
> Marcelino
>
> El 31/10/2020 a las 13:24, nevil amos escribi?:
> > Apologies, I cannot see how to make a rero for this issue.
> >
> > I have a function that uses levels(r) tor return the RAT of a raster "r"
> > when the function is sourced from a script
> > source(".\R\function.r")
> > it works fine.
> > when the function is built into a package and sourced from there
> > library(mypackage) using the same script file to make the package
> > levels(r)[[1]]
> > the same line throws an error, as levels(myraster returns NULL
> >
> > If I modify the script to include the raster namespace:
> > raster::levels(r)[[1]]
> > Then I get the error
> >   Error: 'levels<-' is not an exported object from 'namespace:raster'
> >
> >
> > I have also tried just using levels(r) and putting raster as a depends
> > rather than an import in the DESCRIPTION file for the package, this does
> > not solve the error.
> >
> >
> > Any suggestions on how to overcome the problem?
> >
> > many thanks
> >
> > Nevil Amos
> >
> >       [[alternative HTML version deleted]]
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> > .
>
>
> --
> Marcelino de la Cruz Rot
> Depto. de Biolog?a y Geolog?a
> F?sica y Qu?mica Inorg?nica
> Universidad Rey Juan Carlos
> M?stoles Espa?a
>
>

	[[alternative HTML version deleted]]


From P|etro_te|@to @end|ng |rom hotm@||@com  Wed Nov  4 14:30:29 2020
From: P|etro_te|@to @end|ng |rom hotm@||@com (Pietro Andre Telatin Paschoalino)
Date: Wed, 4 Nov 2020 13:30:29 +0000
Subject: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
Message-ID: <BN8PR17MB2980F349FB8C6B9D23AFACB482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>

Hello everyone.

Could anyone help with a small question about the coordinates in sp package function?

I want to retrieve the geographic coordinates of polygons (shape file), and reading the documentation, I did not find out if these coordinates refer to the centroid of polygon.

So, in fact, do such coordinates refer to the centroid of each polygon?

Thanks.

Pietro Andre Telatin Paschoalino
Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Wed Nov  4 14:38:16 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Wed, 4 Nov 2020 14:38:16 +0100
Subject: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
In-Reply-To: <BN8PR17MB2980F349FB8C6B9D23AFACB482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>
References: <BN8PR17MB2980F349FB8C6B9D23AFACB482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>
Message-ID: <edfe9bb5-6546-93a2-74f-782cf833dd8@reclus.nhh.no>

On Wed, 4 Nov 2020, Pietro Andre Telatin Paschoalino wrote:

> Hello everyone.
>
> Could anyone help with a small question about the coordinates in sp 
> package function?
>
> I want to retrieve the geographic coordinates of polygons (shape file), 
> and reading the documentation, I did not find out if these coordinates 
> refer to the centroid of polygon.
>
> So, in fact, do such coordinates refer to the centroid of each polygon?

Yes, they report the centroid of the largest polygon, but may not handle 
holes correctly. Why do you need to retreive the complete set of 
coordinates? That would be much easier using the sf package, but is seldom 
needed.

Roger

>
> Thanks.
>
> Pietro Andre Telatin Paschoalino
> Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.
>
> 	[[alternative HTML version deleted]]
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From p|etro_te|@to @end|ng |rom hotm@||@com  Wed Nov  4 14:59:45 2020
From: p|etro_te|@to @end|ng |rom hotm@||@com (Pietro Andre Telatin Paschoalino)
Date: Wed, 4 Nov 2020 13:59:45 +0000
Subject: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
In-Reply-To: <edfe9bb5-6546-93a2-74f-782cf833dd8@reclus.nhh.no>
References: <BN8PR17MB2980F349FB8C6B9D23AFACB482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>,
 <edfe9bb5-6546-93a2-74f-782cf833dd8@reclus.nhh.no>
Message-ID: <BN8PR17MB298098F48C1A5E70D093B0B382EF0@BN8PR17MB2980.namprd17.prod.outlook.com>

Hi Roger,

What do you mean by hole? Non-contiguous regions? If so, I don't think it's a problem, because I don't have any non-contiguous regions. I have a blank polygon that is not computed because it is a lake (it is blank).

I am using coordinates to build spatial weight matrices to use in spatial regression / geographically weighted regressions.

Pietro Andre Telatin Paschoalino
Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.

________________________________
De: Roger Bivand <Roger.Bivand at nhh.no>
Enviado: quarta-feira, 4 de novembro de 2020 10:38
Para: Pietro Andre Telatin Paschoalino <Pietro_telato at hotmail.com>
Cc: r-sig-geo at r-project.org <r-sig-geo at r-project.org>
Assunto: Re: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE

On Wed, 4 Nov 2020, Pietro Andre Telatin Paschoalino wrote:

> Hello everyone.
>
> Could anyone help with a small question about the coordinates in sp
> package function?
>
> I want to retrieve the geographic coordinates of polygons (shape file),
> and reading the documentation, I did not find out if these coordinates
> refer to the centroid of polygon.
>
> So, in fact, do such coordinates refer to the centroid of each polygon?

Yes, they report the centroid of the largest polygon, but may not handle
holes correctly. Why do you need to retreive the complete set of
coordinates? That would be much easier using the sf package, but is seldom
needed.

Roger

>
> Thanks.
>
> Pietro Andre Telatin Paschoalino
> Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.
>
>        [[alternative HTML version deleted]]
>
>

--
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Wed Nov  4 15:09:36 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Wed, 4 Nov 2020 15:09:36 +0100
Subject: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
In-Reply-To: <BN8PR17MB298098F48C1A5E70D093B0B382EF0@BN8PR17MB2980.namprd17.prod.outlook.com>
References: <BN8PR17MB2980F349FB8C6B9D23AFACB482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>,
 <edfe9bb5-6546-93a2-74f-782cf833dd8@reclus.nhh.no>
 <BN8PR17MB298098F48C1A5E70D093B0B382EF0@BN8PR17MB2980.namprd17.prod.outlook.com>
Message-ID: <3a4c389f-623b-672b-c5b2-87d4664a3650@reclus.nhh.no>

On Wed, 4 Nov 2020, Pietro Andre Telatin Paschoalino wrote:

> Hi Roger,
>
> What do you mean by hole? Non-contiguous regions? If so, I don't think 
> it's a problem, because I don't have any non-contiguous regions. I have 
> a blank polygon that is not computed because it is a lake (it is blank).

An interior ring within a polygon (like a lake, or another region 
fully within another, which then has its own exterior ring).

>
> I am using coordinates to build spatial weight matrices to use in 
> spatial regression / geographically weighted regressions.

Please do not try to do this by hand. You can use topological predicates 
(in rgeos or sf), or simply use spdep::poly2nb(), which does this. Avoid 
GWR whenever possible, please.

Roger

>
> Pietro Andre Telatin Paschoalino
> Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.
>
> ________________________________
> De: Roger Bivand <Roger.Bivand at nhh.no>
> Enviado: quarta-feira, 4 de novembro de 2020 10:38
> Para: Pietro Andre Telatin Paschoalino <Pietro_telato at hotmail.com>
> Cc: r-sig-geo at r-project.org <r-sig-geo at r-project.org>
> Assunto: Re: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
>
> On Wed, 4 Nov 2020, Pietro Andre Telatin Paschoalino wrote:
>
>> Hello everyone.
>>
>> Could anyone help with a small question about the coordinates in sp
>> package function?
>>
>> I want to retrieve the geographic coordinates of polygons (shape file),
>> and reading the documentation, I did not find out if these coordinates
>> refer to the centroid of polygon.
>>
>> So, in fact, do such coordinates refer to the centroid of each polygon?
>
> Yes, they report the centroid of the largest polygon, but may not handle
> holes correctly. Why do you need to retreive the complete set of
> coordinates? That would be much easier using the sf package, but is seldom
> needed.
>
> Roger
>
>>
>> Thanks.
>>
>> Pietro Andre Telatin Paschoalino
>> Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.
>>
>>        [[alternative HTML version deleted]]
>>
>>
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From p|etro_te|@to @end|ng |rom hotm@||@com  Wed Nov  4 15:35:55 2020
From: p|etro_te|@to @end|ng |rom hotm@||@com (Pietro Andre Telatin Paschoalino)
Date: Wed, 4 Nov 2020 14:35:55 +0000
Subject: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
In-Reply-To: <3a4c389f-623b-672b-c5b2-87d4664a3650@reclus.nhh.no>
References: <BN8PR17MB2980F349FB8C6B9D23AFACB482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>,
 <edfe9bb5-6546-93a2-74f-782cf833dd8@reclus.nhh.no>
 <BN8PR17MB298098F48C1A5E70D093B0B382EF0@BN8PR17MB2980.namprd17.prod.outlook.com>,
 <3a4c389f-623b-672b-c5b2-87d4664a3650@reclus.nhh.no>
Message-ID: <BN8PR17MB2980C804D5232EAE01E5B78482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>

Hello Roger,

Yes, I'm using spdep package to construct the matrices.

I used the knearneigh function (in which I entered the coordinates), as well as the poly2nb function.

I think that I only have one of these rings but the size of the polygons is relatively large (they are political divisions) of a country. In that case, can I keep extracting coordinates by the coordinates function?

I didn't understand why you suggested avoiding GWR. Are you commenting on the methodology itself?

Pietro Andre Telatin Paschoalino
Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.



	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Wed Nov  4 20:32:59 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Wed, 4 Nov 2020 20:32:59 +0100
Subject: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
In-Reply-To: <BN8PR17MB2980C804D5232EAE01E5B78482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>
References: <BN8PR17MB2980F349FB8C6B9D23AFACB482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>,
 <edfe9bb5-6546-93a2-74f-782cf833dd8@reclus.nhh.no>
 <BN8PR17MB298098F48C1A5E70D093B0B382EF0@BN8PR17MB2980.namprd17.prod.outlook.com>,
 <3a4c389f-623b-672b-c5b2-87d4664a3650@reclus.nhh.no>
 <BN8PR17MB2980C804D5232EAE01E5B78482EF0@BN8PR17MB2980.namprd17.prod.outlook.com>
Message-ID: <d81a60d4-994a-6883-ae81-a24e4f51b8d@reclus.nhh.no>

On Wed, 4 Nov 2020, Pietro Andre Telatin Paschoalino wrote:

> Hello Roger,
>
> Yes, I'm using spdep package to construct the matrices.
>

Do not use matrices, use neighbour or weights objects. Dense matrices with 
mostly zero values are a waste of space.

> I used the knearneigh function (in which I entered the coordinates), as 
> well as the poly2nb function.

Yes, however, you change the support of the aggregated data units by doing 
this, so knn is less well supported than contiguity in general.

>
> I think that I only have one of these rings but the size of the polygons 
> is relatively large (they are political divisions) of a country. In that 
> case, can I keep extracting coordinates by the coordinates function?
>

The centroids are more dependent (and so the distances between point 
representations) on the boundary geometries than are simple contiguities. 
Change of support is always something of a problem. Practically, yes, you 
can do it, but whether it makes sense or not in terms of the data is a 
different question.

> I didn't understand why you suggested avoiding GWR. Are you commenting 
> on the methodology itself?

Yes, it may be used for exploring to detect possible omitted covariates 
but should not be used for modelling unless that is definitely the data 
generating process. Random data generates patterned (insignificant) 
coefficient maps.

Roger

>
> Pietro Andre Telatin Paschoalino
> Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.
>
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From pietro_tei@to m@iii@g oii hotm@ii@com  Thu Nov  5 01:35:09 2020
From: pietro_tei@to m@iii@g oii hotm@ii@com (pietro_tei@to m@iii@g oii hotm@ii@com)
Date: Wed, 04 Nov 2020 22:35:09 -0200
Subject: [R-sig-Geo] Question about function COORDINATES in SP PACKAGE
In-Reply-To: <d81a60d4-994a-6883-ae81-a24e4f51b8d@reclus.nhh.no>
Message-ID: <BN8PR17MB2980FD6939DEF4B6369E5E7682EE0@BN8PR17MB2980.namprd17.prod.outlook.com>

An HTML attachment was scrubbed...
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20201104/eb09dd85/attachment.html>

From P|etro_te|@to @end|ng |rom hotm@||@com  Fri Nov  6 02:11:21 2020
From: P|etro_te|@to @end|ng |rom hotm@||@com (Pietro Andre Telatin Paschoalino)
Date: Fri, 6 Nov 2020 01:11:21 +0000
Subject: [R-sig-Geo] Reprojection doubt
Message-ID: <BN8PR17MB2980FF76B7719BFBEA0AA3F982ED0@BN8PR17MB2980.namprd17.prod.outlook.com>

Dear,

I have a question that is possibly extremely easy for you.

I'm extracting data from layers of grid to a shape file.

To do this, first, I know that I need to reproject the coordinates reference system of my shape to the same CRS as my grid. The code for this is:

library(ncdf4)

fn<-file.path(path of my data)

ncfile <- nc_open(fn)

rasbrick <- stack(fn)

rasbrick <- brick[[70:81]] (the layers that I want)

shape2<- spTransform(shape, crs(rasbrick)) in lowercase, right?  It is my first question.

The rest of the extraction code works without any problems. If I open this file in qgis the CRS is:

OGC:CRS84 - WGS 84 (CRS84) - Geographic

The problem is that if I write a raster of a layer using:

rasbrick <- brick[[70]]

writeRaster(rasbrick, "test.tif", format="GTiff")

and open the raster in qgis the CRS is:

EPSG:4326 - WGS 84 - Geographic

So, my second question is why on the raster it looks like EPSG and on the shape it looks like OGC? And could this cause any problems in extracting data from layers for the shape? If yes, what I need to change to reproject the shape for the correct CRS?

Thanks.

Pietro Andre Telatin Paschoalino
Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.

	[[alternative HTML version deleted]]


From md@umner @end|ng |rom gm@||@com  Fri Nov  6 02:30:48 2020
From: md@umner @end|ng |rom gm@||@com (Michael Sumner)
Date: Fri, 6 Nov 2020 12:30:48 +1100
Subject: [R-sig-Geo] Reprojection doubt
In-Reply-To: <BN8PR17MB2980FF76B7719BFBEA0AA3F982ED0@BN8PR17MB2980.namprd17.prod.outlook.com>
References: <BN8PR17MB2980FF76B7719BFBEA0AA3F982ED0@BN8PR17MB2980.namprd17.prod.outlook.com>
Message-ID: <CAAcGz9-1kW4y-MLAqY8iFBd_zb+F_eqc0DbsXTKTWcYmcU9P4A@mail.gmail.com>

It probably doesn't matter at all. Your data is longitude,latitude on datum
WGS84? Those strings are equivalent (some softwares will flip the order of
lon,lat as that's what the standard dictates but easy to spot that
usually).

raster::projection(), raster::crs(), sp::proj4string() all are fairly
equivalent functions, they just get the projection metadata - they are just
overlapping and inconsistent because of historical vagarie, they differ in
ideological stance and how much checking and churn they do to the metadata
and in efforts to interpret your intentions. But on the face of it I don't
think you need to worry about your code here.

Just keep an eye on whether your data looks right, before and after
reprojection. It takes care, but the details are yours alone for checking
unless you can pin down a reproducible example that raises questions.

Good luck.

fwiw you seem to not be doing anything with ncdf4 (or ncdf4::nc_open) here.
the raster package *uses* ncdf4 on your behalf via raster()/stack()/brick()
functions.

Cheers, Mike.



On Fri, Nov 6, 2020 at 12:11 PM Pietro Andre Telatin Paschoalino <
Pietro_telato at hotmail.com> wrote:

> Dear,
>
> I have a question that is possibly extremely easy for you.
>
> I'm extracting data from layers of grid to a shape file.
>
> To do this, first, I know that I need to reproject the coordinates
> reference system of my shape to the same CRS as my grid. The code for this
> is:
>
> library(ncdf4)
>
> fn<-file.path(path of my data)
>
> ncfile <- nc_open(fn)
>
> rasbrick <- stack(fn)
>
> rasbrick <- brick[[70:81]] (the layers that I want)
>
> shape2<- spTransform(shape, crs(rasbrick)) in lowercase, right?  It is my
> first question.
>
> The rest of the extraction code works without any problems. If I open this
> file in qgis the CRS is:
>
> OGC:CRS84 - WGS 84 (CRS84) - Geographic
>
> The problem is that if I write a raster of a layer using:
>
> rasbrick <- brick[[70]]
>
> writeRaster(rasbrick, "test.tif", format="GTiff")
>
> and open the raster in qgis the CRS is:
>
> EPSG:4326 - WGS 84 - Geographic
>
> So, my second question is why on the raster it looks like EPSG and on the
> shape it looks like OGC? And could this cause any problems in extracting
> data from layers for the shape? If yes, what I need to change to reproject
> the shape for the correct CRS?
>
> Thanks.
>
> Pietro Andre Telatin Paschoalino
> Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? -
> PCE.
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com

	[[alternative HTML version deleted]]


From pietro_tei@to m@iii@g oii hotm@ii@com  Fri Nov  6 01:50:12 2020
From: pietro_tei@to m@iii@g oii hotm@ii@com (pietro_tei@to m@iii@g oii hotm@ii@com)
Date: Thu, 05 Nov 2020 22:50:12 -0200
Subject: [R-sig-Geo] Reprojection doubt
In-Reply-To: <CAAcGz9-1kW4y-MLAqY8iFBd_zb+F_eqc0DbsXTKTWcYmcU9P4A@mail.gmail.com>
Message-ID: <BN8PR17MB298096EECD5256FB75158BA982ED0@BN8PR17MB2980.namprd17.prod.outlook.com>

An HTML attachment was scrubbed...
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20201105/a2646e34/attachment.html>

From @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br  Mon Nov  9 18:45:56 2020
From: @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br (ASANTOS)
Date: Mon, 9 Nov 2020 13:45:56 -0400
Subject: [R-sig-Geo] Create pixels neighborhood in a raster
References: <234bbf04-8739-0002-2554-6a231f83d551.ref@yahoo.com.br>
Message-ID: <234bbf04-8739-0002-2554-6a231f83d551@yahoo.com.br>

Dear r-sig-geo Members,

I'd like to find any way to create 1 (total 9 pixels) and 2 pixels 
(total 25 pixels) surrounding the neighborhood of each pixel (ant) in my 
plot image (antscount).

In my example:

#Packages
library(spatstat)
library(raster)

#Selection of ants data set
data(ants)
geo.form<-cbind(x=ants$x,y=ants$y)

#Definition of raster resolution - 10 units
ants.w<-as.owin(ants)
ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
coordinates(ants.res) <- ~ x + y
# coerce to SpatialPixelsDataFrame
gridded(ants.res) <- TRUE

#Rasterize
antscount<- rasterize(geo.form, raster(ants.res), fun='count', background=0)
values(antscount)[values(antscount) > 0] = 1

#Vizualize
plot(antscounts)

Now, the selection of neighborhood pixels sounds easy, something like:

# For 1 pixel neighborhood
neigh1 <- matrix(1L, nrow=3, ncol=3)
e1<-adjacent(antscounts, cells , directions=neigh1, pairs=FALSE)
ng_coords1 <- xyFromCell(antscounts, e1)

# For 2 pixel neighborhood
neigh2 <- matrix(1L, nrow=5, ncol=5)
e2<-adjacent(antscounts, cells , directions=neigh2, pairs=FALSE)
ng_coords5 <- xyFromCell(antscounts, e2)

But for the combination of all the information (0 and 1 new pixel 
values) and the new raster representation (antscounts) I don't have 
success. Please, any ideas?

Thanks in advanced,

Alexandre

-- 
Alexandre dos Santos
Geotechnologies and Spatial Statistics applied to Forest Entomology
Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
Caixa Postal 244 (PO Box)
Avenida dos Ramires, s/n - Vila Real
Caceres - MT - CEP 78201-380 (ZIP code)
Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
Lattes CV: http://lattes.cnpq.br/1360403201088680
OrcID: orcid.org/0000-0001-8232-6722
ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
--


From btupper @end|ng |rom b|ge|ow@org  Tue Nov 10 00:41:20 2020
From: btupper @end|ng |rom b|ge|ow@org (Ben Tupper)
Date: Mon, 9 Nov 2020 18:41:20 -0500
Subject: [R-sig-Geo] Create pixels neighborhood in a raster
In-Reply-To: <234bbf04-8739-0002-2554-6a231f83d551@yahoo.com.br>
References: <234bbf04-8739-0002-2554-6a231f83d551.ref@yahoo.com.br>
 <234bbf04-8739-0002-2554-6a231f83d551@yahoo.com.br>
Message-ID: <CALrbzg3vS9tk4Azs5SvRJusba04Xp596xzLvL=k5OUwnLJ4HtA@mail.gmail.com>

Hi,

Your example isn't fully reproducible.  Or maybe it just has some little
errors.  I can't get past this spot...

ants.w<-as.owin(ants)
> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
> coordinates(ants.res) <- ~ x + y
>

You have requested that raster::rasterToPoints() return a spatial points
object, so there shouldn't be a need for sp::coordinates() to cast to a
spatial object.

Also, I think you are invoking "antscounts" and "antscount" as the same
variable.  Maybe?  It's not clear to me.

Finally, when you call raster::adjacent() you haven't defined the value for
the cells argument when computing e1 and e2.  What do you want them to be?

I wish I could be more helpful.

Cheers,
Ben

On Mon, Nov 9, 2020 at 12:46 PM ASANTOS via R-sig-Geo <
r-sig-geo at r-project.org> wrote:

> Dear r-sig-geo Members,
>
> I'd like to find any way to create 1 (total 9 pixels) and 2 pixels
> (total 25 pixels) surrounding the neighborhood of each pixel (ant) in my
> plot image (antscount).
>
> In my example:
>
> #Packages
> library(spatstat)
> library(raster)
>
> #Selection of ants data set
> data(ants)
> geo.form<-cbind(x=ants$x,y=ants$y)
>
> #Definition of raster resolution - 10 units
> ants.w<-as.owin(ants)
> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
> coordinates(ants.res) <- ~ x + y
> # coerce to SpatialPixelsDataFrame
> gridded(ants.res) <- TRUE
>
> #Rasterize
> antscount<- rasterize(geo.form, raster(ants.res), fun='count',
> background=0)
> values(antscount)[values(antscount) > 0] = 1
>
> #Vizualize
> plot(antscounts)
>
> Now, the selection of neighborhood pixels sounds easy, something like:
>
> # For 1 pixel neighborhood
> neigh1 <- matrix(1L, nrow=3, ncol=3)
> e1<-adjacent(antscounts, cells , directions=neigh1, pairs=FALSE)
> ng_coords1 <- xyFromCell(antscounts, e1)
>
> # For 2 pixel neighborhood
> neigh2 <- matrix(1L, nrow=5, ncol=5)
> e2<-adjacent(antscounts, cells , directions=neigh2, pairs=FALSE)
> ng_coords5 <- xyFromCell(antscounts, e2)
>
> But for the combination of all the information (0 and 1 new pixel
> values) and the new raster representation (antscounts) I don't have
> success. Please, any ideas?
>
> Thanks in advanced,
>
> Alexandre
>
> --
> Alexandre dos Santos
> Geotechnologies and Spatial Statistics applied to Forest Entomology
> Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
> Caixa Postal 244 (PO Box)
> Avenida dos Ramires, s/n - Vila Real
> Caceres - MT - CEP 78201-380 (ZIP code)
> Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
> Lattes CV: http://lattes.cnpq.br/1360403201088680
> OrcID: orcid.org/0000-0001-8232-6722
> ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
> Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
> --
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>


-- 
Ben Tupper
Bigelow Laboratory for Ocean Science
East Boothbay, Maine
http://www.bigelow.org/
https://eco.bigelow.org

	[[alternative HTML version deleted]]


From @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br  Tue Nov 10 01:47:48 2020
From: @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br (ASANTOS)
Date: Mon, 9 Nov 2020 20:47:48 -0400
Subject: [R-sig-Geo] Create pixels neighborhood in a raster
In-Reply-To: <CALrbzg3vS9tk4Azs5SvRJusba04Xp596xzLvL=k5OUwnLJ4HtA@mail.gmail.com>
References: <234bbf04-8739-0002-2554-6a231f83d551.ref@yahoo.com.br>
 <234bbf04-8739-0002-2554-6a231f83d551@yahoo.com.br>
 <CALrbzg3vS9tk4Azs5SvRJusba04Xp596xzLvL=k5OUwnLJ4HtA@mail.gmail.com>
Message-ID: <7b1ed60d-fc15-a0ad-c2ce-30f9fd3ee0f1@yahoo.com.br>

Dear Ben,

Sorry about of lot of mistakes, you are sure some part of code are 
confusing and/or with errors. I'll try again with some corrections:

First, I have the rasterization process of ants presence (0 is absence) 
in a 10x10 units raster:

#Packages
library(spatstat)
library(raster)

#Selection of ants data set
data(ants)
geo.form<-cbind(x=ants$x,y=ants$y)

#Definition of raster resolution - 10 units
ants.w<-as.owin(ants)
ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
# coerce to SpatialPixelsDataFrame
gridded(ants.res) <- TRUE

#Rasterize
antscount<- rasterize(geo.form, raster(ants.res), fun='count', background=0)
values(antscount)[values(antscount) > 0] = 1

#Vizualize
plot(antscount)

Now, I'd like to create 1 pixels around each pixel of ant presence 
(Total of 9 pixels in each ant presence in antscount raster):

# For 1 pixel neighborhood
neigh1 <- matrix(1L, nrow=3, ncol=3); neigh1[2,2] <- 0L
ants1<-which(values(antscount)> 0)
cells<- xyFromCell(antscount, ants1)
e1<-adjacent(antscount, cells, directions=neigh1, pairs=FALSE)
ng_coords1 <- xyFromCell(antscount, e1)
points(ng_coords1, col="red")

I need that's this new create pixels has 1 as value too.

#Rasterize for 1 pixel neighborhood
antscount.9<- rasterize(ng_coords1 , raster(ants.res), fun='count', 
background=0)
plot(antscount.9)

The problem is my ng_coords1 coordinates is wrong and just only in the 
top of the antscount raster, despite xyFromCell(antscount, ants1) 
condition. My goal is a new ant presence raster with 8 pixels 
surrounding the neigourhood of each pixel (ant) in the original 
antscount raster.

Any ideas?

Thanks in advanced,

Alexandre


-- 
Alexandre dos Santos
Geotechnologies and Spatial Statistics applied to Forest Entomology
Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
Caixa Postal 244 (PO Box)
Avenida dos Ramires, s/n - Vila Real
Caceres - MT - CEP 78201-380 (ZIP code)
Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
Lattes CV: http://lattes.cnpq.br/1360403201088680
OrcID: orcid.org/0000-0001-8232-6722
ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
--

Em 09/11/2020 19:41, Ben Tupper escreveu:
> Hi,
>
> Your example isn't fully reproducible.  Or maybe it just has some little
> errors.  I can't get past this spot...
>
> ants.w<-as.owin(ants)
>> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
>> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
>> coordinates(ants.res) <- ~ x + y
>>
> You have requested that raster::rasterToPoints() return a spatial points
> object, so there shouldn't be a need for sp::coordinates() to cast to a
> spatial object.
>
> Also, I think you are invoking "antscounts" and "antscount" as the same
> variable.  Maybe?  It's not clear to me.
>
> Finally, when you call raster::adjacent() you haven't defined the value for
> the cells argument when computing e1 and e2.  What do you want them to be?
>
> I wish I could be more helpful.
>
> Cheers,
> Ben
>
> On Mon, Nov 9, 2020 at 12:46 PM ASANTOS via R-sig-Geo <
> r-sig-geo at r-project.org> wrote:
>
>> Dear r-sig-geo Members,
>>
>> I'd like to find any way to create 1 (total 9 pixels) and 2 pixels
>> (total 25 pixels) surrounding the neighborhood of each pixel (ant) in my
>> plot image (antscount).
>>
>> In my example:
>>
>> #Packages
>> library(spatstat)
>> library(raster)
>>
>> #Selection of ants data set
>> data(ants)
>> geo.form<-cbind(x=ants$x,y=ants$y)
>>
>> #Definition of raster resolution - 10 units
>> ants.w<-as.owin(ants)
>> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
>> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
>> coordinates(ants.res) <- ~ x + y
>> # coerce to SpatialPixelsDataFrame
>> gridded(ants.res) <- TRUE
>>
>> #Rasterize
>> antscount<- rasterize(geo.form, raster(ants.res), fun='count',
>> background=0)
>> values(antscount)[values(antscount) > 0] = 1
>>
>> #Vizualize
>> plot(antscounts)
>>
>> Now, the selection of neighborhood pixels sounds easy, something like:
>>
>> # For 1 pixel neighborhood
>> neigh1 <- matrix(1L, nrow=3, ncol=3)
>> e1<-adjacent(antscounts, cells , directions=neigh1, pairs=FALSE)
>> ng_coords1 <- xyFromCell(antscounts, e1)
>>
>> # For 2 pixel neighborhood
>> neigh2 <- matrix(1L, nrow=5, ncol=5)
>> e2<-adjacent(antscounts, cells , directions=neigh2, pairs=FALSE)
>> ng_coords5 <- xyFromCell(antscounts, e2)
>>
>> But for the combination of all the information (0 and 1 new pixel
>> values) and the new raster representation (antscounts) I don't have
>> success. Please, any ideas?
>>
>> Thanks in advanced,
>>
>> Alexandre
>>
>> --
>> Alexandre dos Santos
>> Geotechnologies and Spatial Statistics applied to Forest Entomology
>> Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
>> Caixa Postal 244 (PO Box)
>> Avenida dos Ramires, s/n - Vila Real
>> Caceres - MT - CEP 78201-380 (ZIP code)
>> Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
>> Lattes CV: http://lattes.cnpq.br/1360403201088680
>> OrcID: orcid.org/0000-0001-8232-6722
>> ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
>> Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
>> --
>>
>> _______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>
>


From btupper @end|ng |rom b|ge|ow@org  Tue Nov 10 14:24:08 2020
From: btupper @end|ng |rom b|ge|ow@org (Ben Tupper)
Date: Tue, 10 Nov 2020 08:24:08 -0500
Subject: [R-sig-Geo] Create pixels neighborhood in a raster
In-Reply-To: <7b1ed60d-fc15-a0ad-c2ce-30f9fd3ee0f1@yahoo.com.br>
References: <234bbf04-8739-0002-2554-6a231f83d551.ref@yahoo.com.br>
 <234bbf04-8739-0002-2554-6a231f83d551@yahoo.com.br>
 <CALrbzg3vS9tk4Azs5SvRJusba04Xp596xzLvL=k5OUwnLJ4HtA@mail.gmail.com>
 <7b1ed60d-fc15-a0ad-c2ce-30f9fd3ee0f1@yahoo.com.br>
Message-ID: <CALrbzg0G4EtPqqgvVTHD7WtUup2OnPEyWpEB7Hk3Qbd4tctvSg@mail.gmail.com>

Hi,

Thanks for updating the example - it is much easier.  I'm still not
sure of exactly what you are after, but my day is young and there is
still coffee to be had.

One thing I suggest is that you modify your computation of cells.  As
you have it, you are computing a matrix of x and y locations.

> cells<- xyFromCell(antscount, ants1)


But I really think you want to compute the cell numbers (1,2,3,...
left-to-right, top-to-bottom) from your original data locations (your
geo.form). Also, if I have followed correctly, I think you are looking
for a list of occupied cells regardless of how many ants in each cell.

> cells <- unique(cellFromXY(antscount, geo.form))

Then I get a series of plots that "look" right to me with little
squares across the plot.

Cheers,
Ben


On Mon, Nov 9, 2020 at 7:48 PM ASANTOS <alexandresantosbr at yahoo.com.br> wrote:
>
> Dear Ben,
>
> Sorry about of lot of mistakes, you are sure some part of code are
> confusing and/or with errors. I'll try again with some corrections:
>
> First, I have the rasterization process of ants presence (0 is absence)
> in a 10x10 units raster:
>
> #Packages
> library(spatstat)
> library(raster)
>
> #Selection of ants data set
> data(ants)
> geo.form<-cbind(x=ants$x,y=ants$y)
>
> #Definition of raster resolution - 10 units
> ants.w<-as.owin(ants)
> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
> # coerce to SpatialPixelsDataFrame
> gridded(ants.res) <- TRUE
>
> #Rasterize
> antscount<- rasterize(geo.form, raster(ants.res), fun='count', background=0)
> values(antscount)[values(antscount) > 0] = 1
>
> #Vizualize
> plot(antscount)
>
> Now, I'd like to create 1 pixels around each pixel of ant presence
> (Total of 9 pixels in each ant presence in antscount raster):
>
> # For 1 pixel neighborhood
> neigh1 <- matrix(1L, nrow=3, ncol=3); neigh1[2,2] <- 0L
> ants1<-which(values(antscount)> 0)
> cells<- xyFromCell(antscount, ants1)
> e1<-adjacent(antscount, cells, directions=neigh1, pairs=FALSE)
> ng_coords1 <- xyFromCell(antscount, e1)
> points(ng_coords1, col="red")
>
> I need that's this new create pixels has 1 as value too.
>
> #Rasterize for 1 pixel neighborhood
> antscount.9<- rasterize(ng_coords1 , raster(ants.res), fun='count',
> background=0)
> plot(antscount.9)
>
> The problem is my ng_coords1 coordinates is wrong and just only in the
> top of the antscount raster, despite xyFromCell(antscount, ants1)
> condition. My goal is a new ant presence raster with 8 pixels
> surrounding the neigourhood of each pixel (ant) in the original
> antscount raster.
>
> Any ideas?
>
> Thanks in advanced,
>
> Alexandre
>
>
> --
> Alexandre dos Santos
> Geotechnologies and Spatial Statistics applied to Forest Entomology
> Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
> Caixa Postal 244 (PO Box)
> Avenida dos Ramires, s/n - Vila Real
> Caceres - MT - CEP 78201-380 (ZIP code)
> Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
> Lattes CV: http://lattes.cnpq.br/1360403201088680
> OrcID: orcid.org/0000-0001-8232-6722
> ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
> Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
> --
>
> Em 09/11/2020 19:41, Ben Tupper escreveu:
> > Hi,
> >
> > Your example isn't fully reproducible.  Or maybe it just has some little
> > errors.  I can't get past this spot...
> >
> > ants.w<-as.owin(ants)
> >> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
> >> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
> >> coordinates(ants.res) <- ~ x + y
> >>
> > You have requested that raster::rasterToPoints() return a spatial points
> > object, so there shouldn't be a need for sp::coordinates() to cast to a
> > spatial object.
> >
> > Also, I think you are invoking "antscounts" and "antscount" as the same
> > variable.  Maybe?  It's not clear to me.
> >
> > Finally, when you call raster::adjacent() you haven't defined the value for
> > the cells argument when computing e1 and e2.  What do you want them to be?
> >
> > I wish I could be more helpful.
> >
> > Cheers,
> > Ben
> >
> > On Mon, Nov 9, 2020 at 12:46 PM ASANTOS via R-sig-Geo <
> > r-sig-geo at r-project.org> wrote:
> >
> >> Dear r-sig-geo Members,
> >>
> >> I'd like to find any way to create 1 (total 9 pixels) and 2 pixels
> >> (total 25 pixels) surrounding the neighborhood of each pixel (ant) in my
> >> plot image (antscount).
> >>
> >> In my example:
> >>
> >> #Packages
> >> library(spatstat)
> >> library(raster)
> >>
> >> #Selection of ants data set
> >> data(ants)
> >> geo.form<-cbind(x=ants$x,y=ants$y)
> >>
> >> #Definition of raster resolution - 10 units
> >> ants.w<-as.owin(ants)
> >> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
> >> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
> >> coordinates(ants.res) <- ~ x + y
> >> # coerce to SpatialPixelsDataFrame
> >> gridded(ants.res) <- TRUE
> >>
> >> #Rasterize
> >> antscount<- rasterize(geo.form, raster(ants.res), fun='count',
> >> background=0)
> >> values(antscount)[values(antscount) > 0] = 1
> >>
> >> #Vizualize
> >> plot(antscounts)
> >>
> >> Now, the selection of neighborhood pixels sounds easy, something like:
> >>
> >> # For 1 pixel neighborhood
> >> neigh1 <- matrix(1L, nrow=3, ncol=3)
> >> e1<-adjacent(antscounts, cells , directions=neigh1, pairs=FALSE)
> >> ng_coords1 <- xyFromCell(antscounts, e1)
> >>
> >> # For 2 pixel neighborhood
> >> neigh2 <- matrix(1L, nrow=5, ncol=5)
> >> e2<-adjacent(antscounts, cells , directions=neigh2, pairs=FALSE)
> >> ng_coords5 <- xyFromCell(antscounts, e2)
> >>
> >> But for the combination of all the information (0 and 1 new pixel
> >> values) and the new raster representation (antscounts) I don't have
> >> success. Please, any ideas?
> >>
> >> Thanks in advanced,
> >>
> >> Alexandre
> >>
> >> --
> >> Alexandre dos Santos
> >> Geotechnologies and Spatial Statistics applied to Forest Entomology
> >> Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
> >> Caixa Postal 244 (PO Box)
> >> Avenida dos Ramires, s/n - Vila Real
> >> Caceres - MT - CEP 78201-380 (ZIP code)
> >> Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
> >> Lattes CV: http://lattes.cnpq.br/1360403201088680
> >> OrcID: orcid.org/0000-0001-8232-6722
> >> ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
> >> Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
> >> --
> >>
> >> _______________________________________________
> >> R-sig-Geo mailing list
> >> R-sig-Geo at r-project.org
> >> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >>
> >



-- 
Ben Tupper
Bigelow Laboratory for Ocean Science
East Boothbay, Maine
http://www.bigelow.org/
https://eco.bigelow.org


From @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br  Tue Nov 10 15:19:53 2020
From: @|ex@ndre@@nto@br @end|ng |rom y@hoo@com@br (ASANTOS)
Date: Tue, 10 Nov 2020 10:19:53 -0400
Subject: [R-sig-Geo] Create pixels neighborhood in a raster [solved]
In-Reply-To: <CALrbzg0G4EtPqqgvVTHD7WtUup2OnPEyWpEB7Hk3Qbd4tctvSg@mail.gmail.com>
References: <234bbf04-8739-0002-2554-6a231f83d551.ref@yahoo.com.br>
 <234bbf04-8739-0002-2554-6a231f83d551@yahoo.com.br>
 <CALrbzg3vS9tk4Azs5SvRJusba04Xp596xzLvL=k5OUwnLJ4HtA@mail.gmail.com>
 <7b1ed60d-fc15-a0ad-c2ce-30f9fd3ee0f1@yahoo.com.br>
 <CALrbzg0G4EtPqqgvVTHD7WtUup2OnPEyWpEB7Hk3Qbd4tctvSg@mail.gmail.com>
Message-ID: <117847a1-643b-5065-0c3f-2e76c1361c19@yahoo.com.br>

Thanks Ben,

Little things do matter, I changed cells<- xyFromCell(antscount, ants1) 
by cells <- unique(cellFromXY(antscount, geo.form)) and works!!

Final solution:

#Packages
library(spatstat)
library(raster)

#Selection of ants data set
data(ants)
geo.form<-cbind(x=ants$x,y=ants$y)

#Definition of raster resolution - 10 units
ants.w<-as.owin(ants)
ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
# coerce to SpatialPixelsDataFrame
gridded(ants.res) <- TRUE

#Rasterize
antscount<- rasterize(geo.form, raster(ants.res), fun='count', background=0)
values(antscount)[values(antscount) > 0] = 1

#Vizualize
plot(antscount)

# For 1 pixel neighborhood
neigh1 <- matrix(1L, nrow=3, ncol=3); neigh1[2,2] <- 0L
ants1<-which(values(antscount)> 0)
cells <- unique(cellFromXY(antscount, geo.form))
e1<-adjacent(antscount, cells, directions=neigh1, pairs=FALSE)
ng_coords1 <- xyFromCell(antscount, e1)
points(ng_coords1, col="red")


#Rasterize for 1 pixel neighborhood
ng_coords2<-rbind(ng_coords1,geo.form)
antscount.9<- rasterize(ng_coords2, raster(ants.res), fun='count', 
background=0)
values(antscount.9)[values(antscount.9) > 0] = 1
plot(antscount.9)

-- 
Alexandre dos Santos
Geotechnologies and Spatial Statistics applied to Forest Entomology
Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
Caixa Postal 244 (PO Box)
Avenida dos Ramires, s/n - Vila Real
Caceres - MT - CEP 78201-380 (ZIP code)
Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
Lattes CV: http://lattes.cnpq.br/1360403201088680
OrcID: orcid.org/0000-0001-8232-6722
ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
--

Em 10/11/2020 09:24, Ben Tupper escreveu:
> Hi,
>
> Thanks for updating the example - it is much easier.  I'm still not
> sure of exactly what you are after, but my day is young and there is
> still coffee to be had.
>
> One thing I suggest is that you modify your computation of cells.  As
> you have it, you are computing a matrix of x and y locations.
>
>> cells<- xyFromCell(antscount, ants1)
>
> But I really think you want to compute the cell numbers (1,2,3,...
> left-to-right, top-to-bottom) from your original data locations (your
> geo.form). Also, if I have followed correctly, I think you are looking
> for a list of occupied cells regardless of how many ants in each cell.
>
>> cells <- unique(cellFromXY(antscount, geo.form))
> Then I get a series of plots that "look" right to me with little
> squares across the plot.
>
> Cheers,
> Ben
>
>
> On Mon, Nov 9, 2020 at 7:48 PM ASANTOS <alexandresantosbr at yahoo.com.br> wrote:
>> Dear Ben,
>>
>> Sorry about of lot of mistakes, you are sure some part of code are
>> confusing and/or with errors. I'll try again with some corrections:
>>
>> First, I have the rasterization process of ants presence (0 is absence)
>> in a 10x10 units raster:
>>
>> #Packages
>> library(spatstat)
>> library(raster)
>>
>> #Selection of ants data set
>> data(ants)
>> geo.form<-cbind(x=ants$x,y=ants$y)
>>
>> #Definition of raster resolution - 10 units
>> ants.w<-as.owin(ants)
>> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
>> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
>> # coerce to SpatialPixelsDataFrame
>> gridded(ants.res) <- TRUE
>>
>> #Rasterize
>> antscount<- rasterize(geo.form, raster(ants.res), fun='count', background=0)
>> values(antscount)[values(antscount) > 0] = 1
>>
>> #Vizualize
>> plot(antscount)
>>
>> Now, I'd like to create 1 pixels around each pixel of ant presence
>> (Total of 9 pixels in each ant presence in antscount raster):
>>
>> # For 1 pixel neighborhood
>> neigh1 <- matrix(1L, nrow=3, ncol=3); neigh1[2,2] <- 0L
>> ants1<-which(values(antscount)> 0)
>> cells<- xyFromCell(antscount, ants1)
>> e1<-adjacent(antscount, cells, directions=neigh1, pairs=FALSE)
>> ng_coords1 <- xyFromCell(antscount, e1)
>> points(ng_coords1, col="red")
>>
>> I need that's this new create pixels has 1 as value too.
>>
>> #Rasterize for 1 pixel neighborhood
>> antscount.9<- rasterize(ng_coords1 , raster(ants.res), fun='count',
>> background=0)
>> plot(antscount.9)
>>
>> The problem is my ng_coords1 coordinates is wrong and just only in the
>> top of the antscount raster, despite xyFromCell(antscount, ants1)
>> condition. My goal is a new ant presence raster with 8 pixels
>> surrounding the neigourhood of each pixel (ant) in the original
>> antscount raster.
>>
>> Any ideas?
>>
>> Thanks in advanced,
>>
>> Alexandre
>>
>>
>> --
>> Alexandre dos Santos
>> Geotechnologies and Spatial Statistics applied to Forest Entomology
>> Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
>> Caixa Postal 244 (PO Box)
>> Avenida dos Ramires, s/n - Vila Real
>> Caceres - MT - CEP 78201-380 (ZIP code)
>> Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
>> Lattes CV: http://lattes.cnpq.br/1360403201088680
>> OrcID: orcid.org/0000-0001-8232-6722
>> ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
>> Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
>> --
>>
>> Em 09/11/2020 19:41, Ben Tupper escreveu:
>>> Hi,
>>>
>>> Your example isn't fully reproducible.  Or maybe it just has some little
>>> errors.  I can't get past this spot...
>>>
>>> ants.w<-as.owin(ants)
>>>> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
>>>> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
>>>> coordinates(ants.res) <- ~ x + y
>>>>
>>> You have requested that raster::rasterToPoints() return a spatial points
>>> object, so there shouldn't be a need for sp::coordinates() to cast to a
>>> spatial object.
>>>
>>> Also, I think you are invoking "antscounts" and "antscount" as the same
>>> variable.  Maybe?  It's not clear to me.
>>>
>>> Finally, when you call raster::adjacent() you haven't defined the value for
>>> the cells argument when computing e1 and e2.  What do you want them to be?
>>>
>>> I wish I could be more helpful.
>>>
>>> Cheers,
>>> Ben
>>>
>>> On Mon, Nov 9, 2020 at 12:46 PM ASANTOS via R-sig-Geo <
>>> r-sig-geo at r-project.org> wrote:
>>>
>>>> Dear r-sig-geo Members,
>>>>
>>>> I'd like to find any way to create 1 (total 9 pixels) and 2 pixels
>>>> (total 25 pixels) surrounding the neighborhood of each pixel (ant) in my
>>>> plot image (antscount).
>>>>
>>>> In my example:
>>>>
>>>> #Packages
>>>> library(spatstat)
>>>> library(raster)
>>>>
>>>> #Selection of ants data set
>>>> data(ants)
>>>> geo.form<-cbind(x=ants$x,y=ants$y)
>>>>
>>>> #Definition of raster resolution - 10 units
>>>> ants.w<-as.owin(ants)
>>>> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
>>>> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial = TRUE)
>>>> coordinates(ants.res) <- ~ x + y
>>>> # coerce to SpatialPixelsDataFrame
>>>> gridded(ants.res) <- TRUE
>>>>
>>>> #Rasterize
>>>> antscount<- rasterize(geo.form, raster(ants.res), fun='count',
>>>> background=0)
>>>> values(antscount)[values(antscount) > 0] = 1
>>>>
>>>> #Vizualize
>>>> plot(antscounts)
>>>>
>>>> Now, the selection of neighborhood pixels sounds easy, something like:
>>>>
>>>> # For 1 pixel neighborhood
>>>> neigh1 <- matrix(1L, nrow=3, ncol=3)
>>>> e1<-adjacent(antscounts, cells , directions=neigh1, pairs=FALSE)
>>>> ng_coords1 <- xyFromCell(antscounts, e1)
>>>>
>>>> # For 2 pixel neighborhood
>>>> neigh2 <- matrix(1L, nrow=5, ncol=5)
>>>> e2<-adjacent(antscounts, cells , directions=neigh2, pairs=FALSE)
>>>> ng_coords5 <- xyFromCell(antscounts, e2)
>>>>
>>>> But for the combination of all the information (0 and 1 new pixel
>>>> values) and the new raster representation (antscounts) I don't have
>>>> success. Please, any ideas?
>>>>
>>>> Thanks in advanced,
>>>>
>>>> Alexandre
>>>>
>>>> --
>>>> Alexandre dos Santos
>>>> Geotechnologies and Spatial Statistics applied to Forest Entomology
>>>> Instituto Federal de Mato Grosso (IFMT) - Campus Caceres
>>>> Caixa Postal 244 (PO Box)
>>>> Avenida dos Ramires, s/n - Vila Real
>>>> Caceres - MT - CEP 78201-380 (ZIP code)
>>>> Phone: (+55) 65 99686-6970 / (+55) 65 3221-2674
>>>> Lattes CV: http://lattes.cnpq.br/1360403201088680
>>>> OrcID: orcid.org/0000-0001-8232-6722
>>>> ResearchGate: www.researchgate.net/profile/Alexandre_Santos10
>>>> Publons: https://publons.com/researcher/3085587/alexandre-dos-santos/
>>>> --
>>>>
>>>> _______________________________________________
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org
>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>>>>
>
>


From rub@k @end|ng |rom m@th@@@u@dk  Wed Nov 11 00:14:55 2020
From: rub@k @end|ng |rom m@th@@@u@dk (Ege Rubak)
Date: Tue, 10 Nov 2020 23:14:55 +0000
Subject: [R-sig-Geo] Create pixels neighborhood in a raster [solved]
In-Reply-To: <117847a1-643b-5065-0c3f-2e76c1361c19@yahoo.com.br>
References: <234bbf04-8739-0002-2554-6a231f83d551.ref@yahoo.com.br>
 <234bbf04-8739-0002-2554-6a231f83d551@yahoo.com.br>
 <CALrbzg3vS9tk4Azs5SvRJusba04Xp596xzLvL=k5OUwnLJ4HtA@mail.gmail.com>
 <7b1ed60d-fc15-a0ad-c2ce-30f9fd3ee0f1@yahoo.com.br>
 <CALrbzg0G4EtPqqgvVTHD7WtUup2OnPEyWpEB7Hk3Qbd4tctvSg@mail.gmail.com>
 <117847a1-643b-5065-0c3f-2e76c1361c19@yahoo.com.br>
Message-ID: <c20f949e613b51f3f255a77abc87bc1138cd5468.camel@math.aau.dk>

A quick-and-dirty all spatstat solution:

library(spatstat)
eps <- 10
x <- pixellate(ants, eps = eps)
x[x>0] <- 1
y <- 0*x
s <- eps*c(-1,0,1)
for(i in s){
  for(j in s){
    y <- y + shift.im(x, vec = c(i,j))
  }
}
z <- y
z[z>0] <- 1
plot(solist(x, y, z), main = "")

/Ege

On Tue, 2020-11-10 at 10:19 -0400, ASANTOS via R-sig-Geo wrote:
> Thanks Ben,
> 
> Little things do matter, I changed cells<- xyFromCell(antscount,
> ants1) 
> by cells <- unique(cellFromXY(antscount, geo.form)) and works!!
> 
> Final solution:
> 
> #Packages
> library(spatstat)
> library(raster)
> 
> #Selection of ants data set
> data(ants)
> geo.form<-cbind(x=ants$x,y=ants$y)
> 
> #Definition of raster resolution - 10 units
> ants.w<-as.owin(ants)
> ext <- as(extent(c(ants.w$xrange,ants.w$yrange)), "SpatialPolygons")
> ants.res<-rasterToPoints(raster(ext, resolution = 10), spatial =
> TRUE)
> # coerce to SpatialPixelsDataFrame
> gridded(ants.res) <- TRUE
> 
> #Rasterize
> antscount<- rasterize(geo.form, raster(ants.res), fun='count',
> background=0)
> values(antscount)[values(antscount) > 0] = 1
> 
> #Vizualize
> plot(antscount)
> 
> # For 1 pixel neighborhood
> neigh1 <- matrix(1L, nrow=3, ncol=3); neigh1[2,2] <- 0L
> ants1<-which(values(antscount)> 0)
> cells <- unique(cellFromXY(antscount, geo.form))
> e1<-adjacent(antscount, cells, directions=neigh1, pairs=FALSE)
> ng_coords1 <- xyFromCell(antscount, e1)
> points(ng_coords1, col="red")
> 
> 
> #Rasterize for 1 pixel neighborhood
> ng_coords2<-rbind(ng_coords1,geo.form)
> antscount.9<- rasterize(ng_coords2, raster(ants.res), fun='count', 
> background=0)
> values(antscount.9)[values(antscount.9) > 0] = 1
> plot(antscount.9)
> 

From tke|tt @end|ng |rom gm@||@com  Sat Nov 14 00:12:54 2020
From: tke|tt @end|ng |rom gm@||@com (Tim Keitt)
Date: Fri, 13 Nov 2020 17:12:54 -0600
Subject: [R-sig-Geo] Problem with st_union
Message-ID: <CANnL8gr4unCzutBSpV=rJ+a9iFEKe3ba9DOXKbKeMEB6K+PN+g@mail.gmail.com>

When I run the following code:

library(sf)
library(tidyverse)
library(tidycensus)

key <- "your key goes here (see tidycensus docs)"

census_api_key(key)

states <- get_estimates("state", "population", geometry = TRUE) %>%
  st_transform(2163) %>%
  spread(variable, value) %>%
  st_simplify(TRUE, 1e3) %>%
  st_buffer(1e3) %>%
  rename(id = GEOID, name = NAME, population = POP, density = DENSITY)

st_is_valid(states)
st_is_simple(states)

merge_states <- function(x) {
  i <- which.min(x[["population"]])
  j <- st_intersects(x[i, ], x[-i, ])[[1]]
  k <- j[which.min(x[["population"]][j])]
  if (length(k) < 1) {
    l <- seq.int(1, nrow(x))[-i]
    m <- which.min(st_distance(x[i, ], x[l, ]))
    k <- l[m]
  }
  x$geometry[k] <- st_union(x$geometry[k], x$geometry[i])
  x$population[k] <- x$population[k] + x$population[i]
  x <- x[-i, ]
  return(x)
}

zones <- states

while (nrow(zones) > 20) zones <- merge_states(zones)

#plot(zones[, "id"], key.pos = NULL)

ggplot(zones) + geom_sf(aes(fill = id)) +
  geom_sf(data = states, fill = NA, linetype = "dotted") +
  guides(fill = FALSE)

I find that some of the polygons get dropped from the result. Is this an
issue with the GEOS union code or did I just set it up wrong?

Thanks.

THK

	[[alternative HTML version deleted]]


From e@v@k@@||ov@ @end|ng |rom gm@||@com  Mon Nov 16 11:36:02 2020
From: e@v@k@@||ov@ @end|ng |rom gm@||@com (=?UTF-8?B?0JXQutCw0YLQtdGA0LjQvdCwINCk0LXQtNC+0YLQvtCy0LAgKNCa0LDRgdC40LvQvtCy0LAp?=)
Date: Mon, 16 Nov 2020 13:36:02 +0300
Subject: [R-sig-Geo] workshop on climate data use in energy modeling
Message-ID: <CALqc8cLgxszy0+Hb_D57O_AgQdemkHqzZC1BTPXnhCoKFvajRA@mail.gmail.com>

 Dear R Geo-folk,

See below for a free and open workshop dedicated to an emerging data
science direction on the intersection between the climate and energy.

The accumulated amount of climate data is getting critically important to
support the energy transition. Development of data processing tools may
give a missed link in this data transfer process. A one?day online workshop
gives a unique opportunity to dive into the climate-energy modeling problem
and explore the role of subseasonal and seasonal (S2S) climate forecasts in
energy system models and allied decision?making.

The event is being organized under the S2S4E project: https://s2s4e.eu
The afternoon session is co?hosted by the Open Energy Modelling Initiative
(openmod) to provide an energy modeling and analysis perspective.

Further information:
openmod forum: https://forum.openmod-initiative.org/t/2330
event webpage:
https://s2s4e.eu/newsroom/climate-forecasting-for-energy-event
Registration is necessary, any of the above contain the required URL.

Best regards,
Ekaterina

	[[alternative HTML version deleted]]


From |r@nc|@coomcborge@ @end|ng |rom gm@||@com  Mon Nov 16 12:44:25 2020
From: |r@nc|@coomcborge@ @end|ng |rom gm@||@com (Francisco Borges)
Date: Mon, 16 Nov 2020 11:44:25 +0000
Subject: [R-sig-Geo] Restricting geographical space for SDM analyses in R
Message-ID: <CA+BtNgpjZuEs6DmMXv1306ySG8_c4OZ7DuNKU0P4ZK3fF0Yjyw@mail.gmail.com>

I am conducting SDM analysis in R, and would like to restrict my
predictions in the geographical space. I am aware of how to do it by
cropping the world space with latitude and longitude, but my case is a
little bit trickier.

I want to restrict my analysis to only the coastal area (i.e. from ocean
to, let's say a certain distance inland). I have yet to find a solution
online to this question, but I am aware that using a shapefile it could
work.

I have zero knowledge of GIS, unfortunately, as I understand that this
could be one of the solutions.

I appreciate any info or suggestion you can provide me

Best,

*Francisco Borges*

MARE ? Marine and Environmental Sciences Centre

Laborat?rio Mar?timo da Guia - Faculdade de Ci?ncias da Universidade de
Lisboa


Av. Nossa Senhora do Cabo, 939

2750-374 Cascais, Portugal

Tel: +351 214 869 211




publons.com/a/1504585/
orcid.org/0000-0002-3911-0421
http://www.mare-centre.pt/pt/user/8232

	[[alternative HTML version deleted]]


From P|etro_te|@to @end|ng |rom hotm@||@com  Mon Nov 16 16:50:13 2020
From: P|etro_te|@to @end|ng |rom hotm@||@com (Pietro Andre Telatin Paschoalino)
Date: Mon, 16 Nov 2020 15:50:13 +0000
Subject: [R-sig-Geo] Doubt in SPREG funtion of sphet package
Message-ID: <BN8PR17MB2980C4E3E2A360ABDA4BF3E182E30@BN8PR17MB2980.namprd17.prod.outlook.com>

Hello everyone.

I read the article Comparing Implementations of Estimation Methods for Spatial Econometrics, by Bivand and Piras, and I'm keep a little doubt about the matrix of instruments in case of aditional endogenous variables.

I believe that in this case the default of the lag.instr argument of the spreg function is false, that is, the lag of external instruments should not be included in the instrument matrix.

My question is, with the option lag.instr = TRUE, Wy would use the lag of the external instrument as an instrument, correct? And in case of my endogenous variable, would it also include, in addition to the external instrument, its lag (of external instrument)? Is the instrument matrix the same for both Wy and the other endogenous variable?

Thanks.

Pietro Andre Telatin Paschoalino
Doutorando em Ci?ncias Econ?micas da Universidade Estadual de Maring? - PCE.

[https://ipmcdn.avast.com/images/icons/icon-envelope-tick-round-orange-animated-no-repeat-v1.gif]<https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail&utm_term=icon>    Virus-free. www.avast.com<https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail&utm_term=link>

	[[alternative HTML version deleted]]


From btupper @end|ng |rom b|ge|ow@org  Mon Nov 16 21:11:57 2020
From: btupper @end|ng |rom b|ge|ow@org (Ben Tupper)
Date: Mon, 16 Nov 2020 15:11:57 -0500
Subject: [R-sig-Geo] 
 Restricting geographical space for SDM analyses in R
In-Reply-To: <CA+BtNgpjZuEs6DmMXv1306ySG8_c4OZ7DuNKU0P4ZK3fF0Yjyw@mail.gmail.com>
References: <CA+BtNgpjZuEs6DmMXv1306ySG8_c4OZ7DuNKU0P4ZK3fF0Yjyw@mail.gmail.com>
Message-ID: <CALrbzg3=+dBfWGDmgaxjb2i9Nb8gqWYQ_VhsEDJ=_pimWCuadw@mail.gmail.com>

Hi,

You can limit the domain of your modeling to irregular polygons such
as a coastline buffered to some +/- distance inshore/offshore, but the
ease of doing so depends upon your data and covariates. You haven't
provided much detail (well, none actually) so it's a challenge to
suggest anything.  For the vector/point data take a look at the sf
package (https://CRAN.R-project.org/package=sf) or sp
(https://CRAN.R-project.org/package=sp) packages, and for rasterized
data you could try raster (https://CRAN.R-project.org/package=raster),
terra (https://CRAN.R-project.org/package=terra) or stars
(https://CRAN.R-project.org/package=stars) packages.

Cheers,
Ben

On Mon, Nov 16, 2020 at 6:44 AM Francisco Borges
<franciscoomcborges at gmail.com> wrote:
>
> I am conducting SDM analysis in R, and would like to restrict my
> predictions in the geographical space. I am aware of how to do it by
> cropping the world space with latitude and longitude, but my case is a
> little bit trickier.
>
> I want to restrict my analysis to only the coastal area (i.e. from ocean
> to, let's say a certain distance inland). I have yet to find a solution
> online to this question, but I am aware that using a shapefile it could
> work.
>
> I have zero knowledge of GIS, unfortunately, as I understand that this
> could be one of the solutions.
>
> I appreciate any info or suggestion you can provide me
>
> Best,
>
> *Francisco Borges*
>
> MARE ? Marine and Environmental Sciences Centre
>
> Laborat?rio Mar?timo da Guia - Faculdade de Ci?ncias da Universidade de
> Lisboa
>
>
> Av. Nossa Senhora do Cabo, 939
>
> 2750-374 Cascais, Portugal
>
> Tel: +351 214 869 211
>
>
>
>
> publons.com/a/1504585/
> orcid.org/0000-0002-3911-0421
> http://www.mare-centre.pt/pt/user/8232
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo



-- 
Ben Tupper
Bigelow Laboratory for Ocean Science
East Boothbay, Maine
http://www.bigelow.org/
https://eco.bigelow.org


From t|m@how@rd @end|ng |rom dec@ny@gov  Tue Nov 17 13:23:59 2020
From: t|m@how@rd @end|ng |rom dec@ny@gov (Howard, Tim G (DEC))
Date: Tue, 17 Nov 2020 12:23:59 +0000
Subject: [R-sig-Geo] Restricting geographical space for SDM analyses
Message-ID: <SA0PR09MB6585C434D8E9DA65C82709DCA8E20@SA0PR09MB6585.namprd09.prod.outlook.com>

Francisco,
That's right, instead of cropping by longitude and latitude, you'll need to define the model output area by another spatial layer that represents the coastline and the certain distance inland. 

To get that (your targeted modeling area), you need a spatial representation of the coastline and then you'll need to create a raster or vector representation of your modeling area based on that. 

Hope that helps,
Tim Howard
New York Natural Heritage Program

>>>>>>>>>>>>>>>>>>>>>>>
Date: Mon, 16 Nov 2020 11:44:25 +0000
From: Francisco Borges <franciscoomcborges at gmail.com>
To: R-sig-Geo at r-project.org
Subject: [R-sig-Geo] Restricting geographical space for SDM analyses
        in R
Message-ID:
        <CA+BtNgpjZuEs6DmMXv1306ySG8_c4OZ7DuNKU0P4ZK3fF0Yjyw at mail.gmail.com>
Content-Type: text/plain; charset="utf-8"

I am conducting SDM analysis in R, and would like to restrict my predictions in the geographical space. I am aware of how to do it by cropping the world space with latitude and longitude, but my case is a little bit trickier.

I want to restrict my analysis to only the coastal area (i.e. from ocean to, let's say a certain distance inland). I have yet to find a solution online to this question, but I am aware that using a shapefile it could work.

I have zero knowledge of GIS, unfortunately, as I understand that this could be one of the solutions.

I appreciate any info or suggestion you can provide me

Best,

*Francisco Borges*

MARE ? Marine and Environmental Sciences Centre

Laborat?rio Mar?timo da Guia - Faculdade de Ci?ncias da Universidade de Lisboa


Av. Nossa Senhora do Cabo, 939

2750-374 Cascais, Portugal

Tel: +351 214 869 211




From t@v|b@r @end|ng |rom gm@||@com  Tue Nov 17 18:49:02 2020
From: t@v|b@r @end|ng |rom gm@||@com (Micha Silver)
Date: Tue, 17 Nov 2020 19:49:02 +0200
Subject: [R-sig-Geo] 
 Restricting geographical space for SDM analyses in R
In-Reply-To: <CA+BtNgpjZuEs6DmMXv1306ySG8_c4OZ7DuNKU0P4ZK3fF0Yjyw@mail.gmail.com>
References: <CA+BtNgpjZuEs6DmMXv1306ySG8_c4OZ7DuNKU0P4ZK3fF0Yjyw@mail.gmail.com>
Message-ID: <74555395-d9c9-02c7-3546-d55e2dffba81@gmail.com>

I would approach this as follows:

Get a polygon of the country boundary where your study area is located, 
then buffer it inside, (using a negative buffer distance). Now you can 
"difference" the full country boundary and the inner buffer to get just 
the coastal strip.


Here's an example:


library(sf)
library(maptools)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())

data("wrld_simpl") # From maptools package
# Example for Egypt
egypt = st_as_sf(wrld_simpl[wrld_simpl$NAME == "Egypt",])
# Transform to Spherical Mercator for correct buffering in meters
egypt = st_transform(egypt, 3857)

# Inside buffer size 50 kilometers
d = 50000

# Setup polygon to crop only coast region
coast_corners = matrix(c(26,32,34,32,34,30,26,30,26,32),
 ????????????????????? ncol=2, byrow=TRUE)
coast_region = st_sf(st_sfc(st_polygon(list(coast_corners))))
st_crs(coast_region) = st_crs(4326)
# But transform this region also to Spherical Mercator
coast_region = st_transform(coast_region, 3857)

# Use negative buffer distance to get inner buffer
egypt_buffer =? st_buffer(egypt, -d)

# Now Difference the full country and buffer polygons,
# then Crop out only coast region
coastal_strip = st_difference(egypt, egypt_buffer) %>%
 ? st_crop(., coast_region)

# Plot result
ggplot(data = egypt) +
 ? geom_sf() +
 ? geom_sf(data = coastal_strip, fill="red")



HTH,

Micha


On 11/16/20 1:44 PM, Francisco Borges wrote:
> I am conducting SDM analysis in R, and would like to restrict my
> predictions in the geographical space. I am aware of how to do it by
> cropping the world space with latitude and longitude, but my case is a
> little bit trickier.
>
> I want to restrict my analysis to only the coastal area (i.e. from ocean
> to, let's say a certain distance inland). I have yet to find a solution
> online to this question, but I am aware that using a shapefile it could
> work.
>
> I have zero knowledge of GIS, unfortunately, as I understand that this
> could be one of the solutions.
>
> I appreciate any info or suggestion you can provide me
>
> Best,
>
> *Francisco Borges*
>
> MARE ? Marine and Environmental Sciences Centre
>
> Laborat?rio Mar?timo da Guia - Faculdade de Ci?ncias da Universidade de
> Lisboa
>
>
> Av. Nossa Senhora do Cabo, 939
>
> 2750-374 Cascais, Portugal
>
> Tel: +351 214 869 211
>
>
>
>
> publons.com/a/1504585/
> orcid.org/0000-0002-3911-0421
> http://www.mare-centre.pt/pt/user/8232
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo

-- 
Micha Silver
Ben Gurion Univ.
Sde Boker, Remote Sensing Lab
cell: +972-523-665918


-------------- next part --------------
A non-text attachment was scrubbed...
Name: buffer_example.pdf
Type: application/pdf
Size: 9320 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-sig-geo/attachments/20201117/872ec8bd/attachment.pdf>

From pere|r@d|@@@@ @end|ng |rom gm@||@com  Wed Nov 18 19:30:51 2020
From: pere|r@d|@@@@ @end|ng |rom gm@||@com (samuel pereira-dias)
Date: Wed, 18 Nov 2020 19:30:51 +0100
Subject: [R-sig-Geo] Liker brownian analysis - probleme to find a sig1 -
In-Reply-To: <mailman.28474.1359.1605722576.1502.r-sig-geo@r-project.org>
References: <mailman.28474.1359.1605722576.1502.r-sig-geo@r-project.org>
Message-ID: <CAEoHQED5Kp_MufD7kTGgfUq=-cwP3QuMH=rpY_qGrXpFw6CXRw@mail.gmail.com>

Hi everyone,
I would like to run a kernel brownian bridge analysis with kernelbb and
liker function on adehabitatHR.
I've some problems with the liker output with my ltrj object below:

My ltraj object:
> tr

*********** List of class ltraj ***********

Type of the traject: Type II (time recorded)
* Time zone unspecified: dates printed in user time zone *
Irregular traject. Variable time lag between two locs

Characteristics of the bursts:
    id burst nb.reloc NAs          date.begin            date.end
1 5778  5778      116   0 2017-08-08 09:00:45 2018-05-16 12:00:01
2 5779  5779       94   0 2017-08-02 02:00:41 2018-07-17 16:00:01
3 5780  5780       43   0 2018-05-01 04:00:01 2018-05-29 16:00:01
4 5781  5781       83   0 2018-05-01 04:00:01 2018-06-17 04:00:01
5 6539  6539      194   0 2018-07-11 12:00:01 2018-08-31 16:00:01
6 6540  6540      572   0 2018-07-25 12:00:15 2019-08-21 08:00:01

and
> liker(tr, sig2 = 80, rangesig1 = c(1, 100))
*****************************************

Maximization of the log-likelihood for parameter
sig1 of brownian bridge

5778 : Sig1 = 1 Sig2 = 80
5779 : Sig1 = 1 Sig2 = 80
5780 : Sig1 = 1 Sig2 = 80
5781 : Sig1 = 1 Sig2 = 80
6539 : Sig1 = 1 Sig2 = 80
6540 : Sig1 = 1 Sig2 = 80

Why do I get a maximum of 1 for each of my individuals with the liker
function of adehabitatHR ?

Despite the huge documentation on internet, i am blocked.
Hope someone can help,
In advance thanks!

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Nov 19 14:28:35 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 19 Nov 2020 14:28:35 +0100
Subject: [R-sig-Geo] sf installation problem under Mac OS 11 - Big Sur (fwd)
Message-ID: <5a8f8a77-ebdb-6ba3-c295-9c6190c6c62a@reclus.nhh.no>

Forwarded to list.

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

---------- Forwarded message ----------
Date: Thu, 19 Nov 2020 12:23:48 +0100
From: GilbertoCamara <gcamara at geosec.org>
To: r-sig-geo-owner at r-project.org
Subject: sf installation problem under Mac OS 11 - Big Sur

Dear all

I am a Mac user.  When I upgraded to Mac OS 11 BigSur, I started having 
problems with ?rgdal? and ?sf?.

I managed to get "sf" to run on MacOS 11.0.1 by recompiling most of the 
required packages. Here's the recipe:

1. Remove all spatial software from brew (if you installed it). Rgdal does
    not like "brewed" stuff (I believe Roger prefers wine). Seriously, it
    appears that rgdal looks for libraries in their default places and not
    in the "Cellar" libraries used by "brew".

2. Install Xcode 12.3beta (downloaded from Apple Developers). This is the
    latest version of XCode which is compatible with MacOS BigSur.

3. Install "wget" using brew:

"brew install wget".

4. Download the libraries below from their sources:

(a) sqlite-autoconf-3330000.tar.gz from "https://www.sqlite.org/download.html".
(b) tiff-4.1.0.tar.gz from "https://download.osgeo.org/libtiff/"
(c) proj-7.2.0.tar.gz from "https://proj.org/download.html#current-release"
(d) libgeotiff-1.6.0.tar.gz from "https://download.osgeo.org/geotiff/libgeotiff/"
(e) geos-3.8.1.tar.bz2 from "https://trac.osgeo.org/geos"
(f) gdal-3.2.0.tar.gz from "https://gdal.org/download.html"

5. In the order given above, unpack each library and then execute the
    following commands:
% ./configure
% make
% sudo make install

6. Now you are ready to compile "rgdal" and "sf" from source. Using the R
    console,do:

> install.packages("rgdal", type = "source?)
> install.packages("sf", type = "source")

7. After those steps, both "rgdal" and "sf" are working on MacOS BigSur.

Hope this helps Mac users.

Best
Gilberto
===========================
Prof Dr Gilberto Camara
Secretariat Director
GEO - Group on Earth Observations
7 bis, Avenue de La Paix
CH-1211 Geneva - Switzerland
Tel: +41227308480
Web: www.earthobservations.org




From Roger@B|v@nd @end|ng |rom nhh@no  Thu Nov 19 23:42:50 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 19 Nov 2020 22:42:50 +0000
Subject: [R-sig-Geo] 
 sf installation problem under Mac OS 11 - Big Sur (fwd)
In-Reply-To: <5a8f8a77-ebdb-6ba3-c295-9c6190c6c62a@reclus.nhh.no>
References: <5a8f8a77-ebdb-6ba3-c295-9c6190c6c62a@reclus.nhh.no>
Message-ID: <DB9PR10MB4428ABD04DFA0117F9ED35F9A3E00@DB9PR10MB4428.EURPRD10.PROD.OUTLOOK.COM>

For completeness, note that the issues were resolved for CRAN binaries for Big Sur:  https://stat.ethz.ch/pipermail/r-sig-mac/2020-November/013783.html

---
Roger Bivand
Department of Economics
Norwegian School of Economics
Bergen, Norway
roger.bivand at nhh.no
________________________________
From: R-sig-Geo <r-sig-geo-bounces at r-project.org> on behalf of Roger Bivand <Roger.Bivand at nhh.no>
Sent: Thursday, November 19, 2020 2:28:35 PM
To: r-sig-geo at r-project.org <r-sig-geo at r-project.org>
Cc: GilbertoCamara <gcamara at geosec.org>
Subject: [R-sig-Geo] sf installation problem under Mac OS 11 - Big Sur (fwd)

Forwarded to list.

--
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

---------- Forwarded message ----------
Date: Thu, 19 Nov 2020 12:23:48 +0100
From: GilbertoCamara <gcamara at geosec.org>
To: r-sig-geo-owner at r-project.org
Subject: sf installation problem under Mac OS 11 - Big Sur

Dear all

I am a Mac user.  When I upgraded to Mac OS 11 BigSur, I started having
problems with ?rgdal? and ?sf?.

I managed to get "sf" to run on MacOS 11.0.1 by recompiling most of the
required packages. Here's the recipe:

1. Remove all spatial software from brew (if you installed it). Rgdal does
    not like "brewed" stuff (I believe Roger prefers wine). Seriously, it
    appears that rgdal looks for libraries in their default places and not
    in the "Cellar" libraries used by "brew".

2. Install Xcode 12.3beta (downloaded from Apple Developers). This is the
    latest version of XCode which is compatible with MacOS BigSur.

3. Install "wget" using brew:

"brew install wget".

4. Download the libraries below from their sources:

(a) sqlite-autoconf-3330000.tar.gz from "https://www.sqlite.org/download.html".
(b) tiff-4.1.0.tar.gz from "https://download.osgeo.org/libtiff/"
(c) proj-7.2.0.tar.gz from "https://proj.org/download.html#current-release"
(d) libgeotiff-1.6.0.tar.gz from "https://download.osgeo.org/geotiff/libgeotiff/"
(e) geos-3.8.1.tar.bz2 from "https://trac.osgeo.org/geos"
(f) gdal-3.2.0.tar.gz from "https://gdal.org/download.html"

5. In the order given above, unpack each library and then execute the
    following commands:
% ./configure
% make
% sudo make install

6. Now you are ready to compile "rgdal" and "sf" from source. Using the R
    console,do:

> install.packages("rgdal", type = "source?)
> install.packages("sf", type = "source")

7. After those steps, both "rgdal" and "sf" are working on MacOS BigSur.

Hope this helps Mac users.

Best
Gilberto
===========================
Prof Dr Gilberto Camara
Secretariat Director
GEO - Group on Earth Observations
7 bis, Avenue de La Paix
CH-1211 Geneva - Switzerland
Tel: +41227308480
Web: www.earthobservations.org<http://www.earthobservations.org>




	[[alternative HTML version deleted]]


From k@n@n009 @end|ng |rom umn@edu  Sun Nov 22 19:25:05 2020
From: k@n@n009 @end|ng |rom umn@edu (Kaushi Kanankege)
Date: Sun, 22 Nov 2020 12:25:05 -0600
Subject: [R-sig-Geo] Offset for spautolm function in Spatialreg package
Message-ID: <CANaVsNqr31_MSEZZfYrbapN6h5VcjNyKsSR3JKZP=eQR0v+1hQ@mail.gmail.com>

 Dear members of the R-sig-Geo,
Is there a way to set an 'offset' when running a Poisson regression using
the spautolm function offered in the Spatialreg package?

I have count data of disease at administrative levels and I am trying to
use CAR model to account for the spatial dependence between the admin
levels. I would appreciate suggestions of setting the offset (the log of a
total number of animals in each admin level) or ways to work around this
using spautolm function.

Thank you very much.

Kaushi

Further details below:

# Unit of analysis is ?Districts? i.e. administrative divisions

# Count_disease = number of animals with the disease

# Var 1 and 2 are selected independent variables

# We have the count of animals per each district and I am trying to set
this as the ?offset?



 # The same model was run as a zero inflated Poisson regression using the
following

offset = log(Ani_pop)

ZIP.D <- zeroinfl(formula_Red, data = Data, dist = "poisson", EM = TRUE,
link = "logit", offset = offset)



 #Formula

formula <-  Count_disease ~  Variable 1 + Variable2

 # CAR fit

CAR.D <- spautolm(formula_Red, data= Thai.D.shp2, listw=ThaiD.listw,
family="CAR",zero.policy = TRUE, method="eigen")



How to set the offset?

Or suggestions to work around this?



-- 

Kaushi Kanankege (DVM, MS, PhD)
Postdoctoral Associate
Center for Animal Health and Food Safety
University of Minnesota Twin Cities
kanan009 at umn.edu,;+1 848-480-9250;
linkedin.com/in/kaushi-kanankege
<https://www.linkedin.com/in/kaushi-kanankege>

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Mon Nov 23 12:28:59 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Mon, 23 Nov 2020 12:28:59 +0100
Subject: [R-sig-Geo] Offset for spautolm function in Spatialreg package
In-Reply-To: <CANaVsNqr31_MSEZZfYrbapN6h5VcjNyKsSR3JKZP=eQR0v+1hQ@mail.gmail.com>
References: <CANaVsNqr31_MSEZZfYrbapN6h5VcjNyKsSR3JKZP=eQR0v+1hQ@mail.gmail.com>
Message-ID: <2831cc12-10d8-48cb-b5d6-3c31af1aca34@reclus.nhh.no>

On Sun, 22 Nov 2020, Kaushi Kanankege via R-sig-Geo wrote:

> Dear members of the R-sig-Geo,
> Is there a way to set an 'offset' when running a Poisson regression using
> the spautolm function offered in the Spatialreg package?

The spautolm function in spatialreg only supports Gaussian dependent 
variables. Perhaps the family= argument misled you to think otherwise, it 
takes the values c("SAR", "CAR, "SMA"), not distribution names. It was 
written as its help page describes to support the spatial regression 
chapter in Waller & Gotway (2004).

For Poisson CAR, see the hglm package, CARBayes, INLA, R2BayesX and many 
others (also mgcv gam() with an "mrf" smooth).

Hope this clarifies,

Roger

>
> I have count data of disease at administrative levels and I am trying to
> use CAR model to account for the spatial dependence between the admin
> levels. I would appreciate suggestions of setting the offset (the log of a
> total number of animals in each admin level) or ways to work around this
> using spautolm function.
>
> Thank you very much.
>
> Kaushi
>
> Further details below:
>
> # Unit of analysis is ?Districts? i.e. administrative divisions
>
> # Count_disease = number of animals with the disease
>
> # Var 1 and 2 are selected independent variables
>
> # We have the count of animals per each district and I am trying to set
> this as the ?offset?
>
>
>
> # The same model was run as a zero inflated Poisson regression using the
> following
>
> offset = log(Ani_pop)
>
> ZIP.D <- zeroinfl(formula_Red, data = Data, dist = "poisson", EM = TRUE,
> link = "logit", offset = offset)
>
>
>
> #Formula
>
> formula <-  Count_disease ~  Variable 1 + Variable2
>
> # CAR fit
>
> CAR.D <- spautolm(formula_Red, data= Thai.D.shp2, listw=ThaiD.listw,
> family="CAR",zero.policy = TRUE, method="eigen")
>
>
>
> How to set the offset?
>
> Or suggestions to work around this?
>
>
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From k@n@n009 @end|ng |rom umn@edu  Mon Nov 23 14:44:03 2020
From: k@n@n009 @end|ng |rom umn@edu (Kaushi Kanankege)
Date: Mon, 23 Nov 2020 07:44:03 -0600
Subject: [R-sig-Geo] Offset for spautolm function in Spatialreg package
In-Reply-To: <2831cc12-10d8-48cb-b5d6-3c31af1aca34@reclus.nhh.no>
References: <CANaVsNqr31_MSEZZfYrbapN6h5VcjNyKsSR3JKZP=eQR0v+1hQ@mail.gmail.com>
 <2831cc12-10d8-48cb-b5d6-3c31af1aca34@reclus.nhh.no>
Message-ID: <CANaVsNp_bAtdabta0GAZx7t059cHdiyxLMs29i1_dxQHMSWHzQ@mail.gmail.com>

Hi Dr. Bivand,
Thank you for the reply. That makes sense. I was hoping there'd be a way to
set an offset like in glm function even though it's Gaussian dependent.
But, of course as you've brought up I'm running a Poisson model here.
I ended up using CARBayes package for the purpose eventually. Thank you
very much again for the prompt reply and the suggestions.

Have a good day!
Best,
Kaushi



On Mon, Nov 23, 2020 at 5:30 AM Roger Bivand <Roger.Bivand at nhh.no> wrote:

> On Sun, 22 Nov 2020, Kaushi Kanankege via R-sig-Geo wrote:
>
> > Dear members of the R-sig-Geo,
> > Is there a way to set an 'offset' when running a Poisson regression using
> > the spautolm function offered in the Spatialreg package?
>
> The spautolm function in spatialreg only supports Gaussian dependent
> variables. Perhaps the family= argument misled you to think otherwise, it
> takes the values c("SAR", "CAR, "SMA"), not distribution names. It was
> written as its help page describes to support the spatial regression
> chapter in Waller & Gotway (2004).
>
> For Poisson CAR, see the hglm package, CARBayes, INLA, R2BayesX and many
> others (also mgcv gam() with an "mrf" smooth).
>
> Hope this clarifies,
>
> Roger
>
> >
> > I have count data of disease at administrative levels and I am trying to
> > use CAR model to account for the spatial dependence between the admin
> > levels. I would appreciate suggestions of setting the offset (the log of
> a
> > total number of animals in each admin level) or ways to work around this
> > using spautolm function.
> >
> > Thank you very much.
> >
> > Kaushi
> >
> > Further details below:
> >
> > # Unit of analysis is ?Districts? i.e. administrative divisions
> >
> > # Count_disease = number of animals with the disease
> >
> > # Var 1 and 2 are selected independent variables
> >
> > # We have the count of animals per each district and I am trying to set
> > this as the ?offset?
> >
> >
> >
> > # The same model was run as a zero inflated Poisson regression using the
> > following
> >
> > offset = log(Ani_pop)
> >
> > ZIP.D <- zeroinfl(formula_Red, data = Data, dist = "poisson", EM = TRUE,
> > link = "logit", offset = offset)
> >
> >
> >
> > #Formula
> >
> > formula <-  Count_disease ~  Variable 1 + Variable2
> >
> > # CAR fit
> >
> > CAR.D <- spautolm(formula_Red, data= Thai.D.shp2, listw=ThaiD.listw,
> > family="CAR",zero.policy = TRUE, method="eigen")
> >
> >
> >
> > How to set the offset?
> >
> > Or suggestions to work around this?
> >
> >
> >
> >
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en



-- 

Kaushi Kanankege (DVM, MS, PhD)
Postdoctoral Associate
Center for Animal Health and Food Safety
University of Minnesota Twin Cities
kanan009 at umn.edu,;+1 848-480-9250;
linkedin.com/in/kaushi-kanankege
<https://www.linkedin.com/in/kaushi-kanankege>

	[[alternative HTML version deleted]]


From dexter@|ocke @end|ng |rom gm@||@com  Tue Nov 24 18:56:33 2020
From: dexter@|ocke @end|ng |rom gm@||@com (Dexter Locke)
Date: Tue, 24 Nov 2020 12:56:33 -0500
Subject: [R-sig-Geo] crop or mask large raster on inport
Message-ID: <CAA=SVwFWaa77Vb2yNJHfsNJ_-+bNR+M1AeD1syyMqwL00D_5fA@mail.gmail.com>

Dear list,

Is there a way to reduce the spatial extent of an impractically-large
raster (~50Gb) on import? Can a crop or mask be applied as the large raster
is read into R to create a more manageable subset?

I've looked at raster and rgdal helpfiles, but have not found this
functionality. This would be akin to the sf::st_read() 's new "query"
argument that takes SQL statements for filtering records while reading data
into R.

The ultimate use case is to summarize a large categorical raster into many
thousands of polygons, and I thought reading small subsets in at a time
could be looped through or parallelized for summarizing smaller pieces of
the data. If there are other approaches to zonal functions (like
equivalents of ArcMap's Tabulate Area) that could also work.

Thanks for your consideration, Dexter

	[[alternative HTML version deleted]]


From z|v@n@k@r@m@n @end|ng |rom gm@||@com  Tue Nov 24 19:51:11 2020
From: z|v@n@k@r@m@n @end|ng |rom gm@||@com (Zivan Karaman)
Date: Tue, 24 Nov 2020 19:51:11 +0100
Subject: [R-sig-Geo] crop or mask large raster on inport
In-Reply-To: <CAA=SVwFWaa77Vb2yNJHfsNJ_-+bNR+M1AeD1syyMqwL00D_5fA@mail.gmail.com>
References: <CAA=SVwFWaa77Vb2yNJHfsNJ_-+bNR+M1AeD1syyMqwL00D_5fA@mail.gmail.com>
Message-ID: <CAKtE6yPnKjPzSraaiVk2=h5uMHSbVSLKg8s5F5JY3hWJjB5P-A@mail.gmail.com>

Hello Dexter,

I think this could be done with command-line gdal (see, for example,
https://joeyklee.github.io/broc-cli-geo/guide/XX_raster_cropping_and_clipping.html),
but I don't know how to do it in R.

Best regards,
Zivan


Le mar. 24 nov. 2020 ? 18:57, Dexter Locke <dexter.locke at gmail.com> a
?crit :

> Dear list,
>
> Is there a way to reduce the spatial extent of an impractically-large
> raster (~50Gb) on import? Can a crop or mask be applied as the large raster
> is read into R to create a more manageable subset?
>
> I've looked at raster and rgdal helpfiles, but have not found this
> functionality. This would be akin to the sf::st_read() 's new "query"
> argument that takes SQL statements for filtering records while reading data
> into R.
>
> The ultimate use case is to summarize a large categorical raster into many
> thousands of polygons, and I thought reading small subsets in at a time
> could be looped through or parallelized for summarizing smaller pieces of
> the data. If there are other approaches to zonal functions (like
> equivalents of ArcMap's Tabulate Area) that could also work.
>
> Thanks for your consideration, Dexter
>
>         [[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Wed Nov 25 10:12:56 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Wed, 25 Nov 2020 10:12:56 +0100
Subject: [R-sig-Geo] crop or mask large raster on inport
In-Reply-To: <CAA=SVwFWaa77Vb2yNJHfsNJ_-+bNR+M1AeD1syyMqwL00D_5fA@mail.gmail.com>
References: <CAA=SVwFWaa77Vb2yNJHfsNJ_-+bNR+M1AeD1syyMqwL00D_5fA@mail.gmail.com>
Message-ID: <47ef5023-dec4-631d-1316-8bb03aec9365@reclus.nhh.no>

On Tue, 24 Nov 2020, Dexter Locke wrote:

> Dear list,
>
> Is there a way to reduce the spatial extent of an impractically-large
> raster (~50Gb) on import? Can a crop or mask be applied as the large raster
> is read into R to create a more manageable subset?

rgdal::GDAL.open() simply opens the data source but does not read it, 
returning an object with a handle to the open file - close with 
rgdal::GDAL.close(). rgdal::getRasterData() has a complete set of 
arguments for the kinds of things you mention, see: 
https://rgdal.r-forge.r-project.org/reference/GDALRasterBand-class.html

The same arguments are used by rgdal::readGDAL(): offset, region.dim, 
output.dim, band. These all permit rectangular cropping, and output.dim= 
can decimate/resample/aggregate input cells to coarser output cells. These 
are the same mechanisms that GDAL utility programs use. They are also used 
by raster internally.

The example in rgdal::readGDAL() includes:

SP27GTIF <- readGDAL(system.file("pictures/SP27GTIF.TIF",
  package = "rgdal")[1], output.dim=c(100,100))

doing resampling on-the-fly. Lower down,

fn <- system.file("pictures/erdas_spnad83.tif", package = "rgdal")[1]
erdas_spnad83 <- readGDAL(fn, offset=c(50, 100), region.dim=c(400, 400),
  output.dim=c(100,100))

uses all of offset=, region.dim= and output.dim=. The example files are 
tiny, but the same GDAL code applies to larger files. Note that the axis 
ordering of the argument vectors is often counter-intuitive and needs some 
patience.

The GDAL utilities can be run file-to-file using the gdalUtils package, 
in addition to being run from the command line.

Otherwise, see the stars package and its proxy=TRUE read functionality, 
which leaves the data on disk until required in possibly subsetted and 
resampled form.

Hope this helps,

Roger

>
> I've looked at raster and rgdal helpfiles, but have not found this
> functionality. This would be akin to the sf::st_read() 's new "query"
> argument that takes SQL statements for filtering records while reading data
> into R.
>
> The ultimate use case is to summarize a large categorical raster into many
> thousands of polygons, and I thought reading small subsets in at a time
> could be looped through or parallelized for summarizing smaller pieces of
> the data. If there are other approaches to zonal functions (like
> equivalents of ArcMap's Tabulate Area) that could also work.
>
> Thanks for your consideration, Dexter
>
> 	[[alternative HTML version deleted]]
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


From dexter@|ocke @end|ng |rom gm@||@com  Wed Nov 25 14:32:49 2020
From: dexter@|ocke @end|ng |rom gm@||@com (Dexter Locke)
Date: Wed, 25 Nov 2020 08:32:49 -0500
Subject: [R-sig-Geo] crop or mask large raster on inport
In-Reply-To: <47ef5023-dec4-631d-1316-8bb03aec9365@reclus.nhh.no>
References: <CAA=SVwFWaa77Vb2yNJHfsNJ_-+bNR+M1AeD1syyMqwL00D_5fA@mail.gmail.com>
 <47ef5023-dec4-631d-1316-8bb03aec9365@reclus.nhh.no>
Message-ID: <CAA=SVwFJoFMktH02_av=_w6OsCres8VWXaBkjV-P4zKxnZyjxQ@mail.gmail.com>

Thanks all.

Best, Dexter


On Wed, Nov 25, 2020 at 4:13 AM Roger Bivand <Roger.Bivand at nhh.no> wrote:

> On Tue, 24 Nov 2020, Dexter Locke wrote:
>
> > Dear list,
> >
> > Is there a way to reduce the spatial extent of an impractically-large
> > raster (~50Gb) on import? Can a crop or mask be applied as the large
> raster
> > is read into R to create a more manageable subset?
>
> rgdal::GDAL.open() simply opens the data source but does not read it,
> returning an object with a handle to the open file - close with
> rgdal::GDAL.close(). rgdal::getRasterData() has a complete set of
> arguments for the kinds of things you mention, see:
> https://rgdal.r-forge.r-project.org/reference/GDALRasterBand-class.html
>
> The same arguments are used by rgdal::readGDAL(): offset, region.dim,
> output.dim, band. These all permit rectangular cropping, and output.dim=
> can decimate/resample/aggregate input cells to coarser output cells. These
> are the same mechanisms that GDAL utility programs use. They are also used
> by raster internally.
>
> The example in rgdal::readGDAL() includes:
>
> SP27GTIF <- readGDAL(system.file("pictures/SP27GTIF.TIF",
>   package = "rgdal")[1], output.dim=c(100,100))
>
> doing resampling on-the-fly. Lower down,
>
> fn <- system.file("pictures/erdas_spnad83.tif", package = "rgdal")[1]
> erdas_spnad83 <- readGDAL(fn, offset=c(50, 100), region.dim=c(400, 400),
>   output.dim=c(100,100))
>
> uses all of offset=, region.dim= and output.dim=. The example files are
> tiny, but the same GDAL code applies to larger files. Note that the axis
> ordering of the argument vectors is often counter-intuitive and needs some
> patience.
>
> The GDAL utilities can be run file-to-file using the gdalUtils package,
> in addition to being run from the command line.
>
> Otherwise, see the stars package and its proxy=TRUE read functionality,
> which leaves the data on disk until required in possibly subsetted and
> resampled form.
>
> Hope this helps,
>
> Roger
>
> >
> > I've looked at raster and rgdal helpfiles, but have not found this
> > functionality. This would be akin to the sf::st_read() 's new "query"
> > argument that takes SQL statements for filtering records while reading
> data
> > into R.
> >
> > The ultimate use case is to summarize a large categorical raster into
> many
> > thousands of polygons, and I thought reading small subsets in at a time
> > could be looped through or parallelized for summarizing smaller pieces of
> > the data. If there are other approaches to zonal functions (like
> > equivalents of ArcMap's Tabulate Area) that could also work.
> >
> > Thanks for your consideration, Dexter
> >
> >       [[alternative HTML version deleted]]
> >
> > _______________________________________________
> > R-sig-Geo mailing list
> > R-sig-Geo at r-project.org
> > https://stat.ethz.ch/mailman/listinfo/r-sig-geo
> >
>
> --
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>

	[[alternative HTML version deleted]]


From g||berto@c@m@r@@|npe @end|ng |rom gm@||@com  Thu Nov 26 15:11:08 2020
From: g||berto@c@m@r@@|npe @end|ng |rom gm@||@com (GilbertoCamara)
Date: Thu, 26 Nov 2020 15:11:08 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
Message-ID: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>

Dear R-SIG-GEO and Roger

I am developing an R package (https://github.com/e-sensing/sits <https://github.com/e-sensing/sits>) to analyse satellite image time series (SITS) which is heavily dependent on ?rgdal?. 

I would like to report an issue with rgdal in the new macOS BigSur. While I agree with Roger that it is not wise to install a new OS until it is stable, I hope the information below will be useful. 

For starters, let me praise Roger, Edzer and all those involved in ?rgdal?. I did some debugging on the source code and was humbled by the effort involved in making the code an operational software many of us rely on. Chapeau bas!

That said, please allow me to report on three issues: 

1. Installation 

I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. When installing the binary version of rgdal-1.5-18 (SVN revision 1082) from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is is using GDAL-3.1.1, which is not installed. The actual message is:
"Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.  

When installing from source, rgdal recognises GDAL-3.2.0, if the Homebrew libraries are on the path. The message changes to:
"Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26."

It is odd that the binary version would report using a runtime that is not there.

2. Errors in /vsis3 file access 

In earlier versions of macOS, rgdal had no problems with accessing files in AWS with commands such as:

> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
> rgdal::GDALinfo(s3_file)

In BigSur, it produces an error. Debugging the rgdal code, I found the error to arise from line 723 of the ?gdal-bindings.cpp? file. This is one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as follows:

  GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
    papszAllowedDrivers, papszOpenOptions, NULL);

The function call returns a NULL pointer. Since calling gdalinfo externally or using gdalUtils::gdalinfo works, it seems there is a problem with the return parameters which are provided to rgdal by GDAL. 

To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer wish to have a go at this issue, I can provide a temporary credential for doing so. 

3. Errors in TIFF Decoding 

Running devtools::check() produces a strange error on TIFF decoding on a very small file. The error is odd:

"TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."

The call stack is as follows:

   1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
   2: .local(.Object, ...)
   3: initialize(value, ...)
   4: initialize(value, ...)
   5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
   6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
   7: rgdal::GDALinfo(file, silent = FALSE)

The error appears to be in the same place as the one reported above. However, it is hard to reproduce, because when running on the console, rgdal works.

> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
> rgdal::GDALinfo(ndvi_file, silent = FALSE)

However, given that the place on the ?rgdal? code where the error occurs is the same, it might be worthwhile to look into the RGDAL-GDAL interface in more detail. 

I know it?s my responsibility to have moved to macOS BigSur too soon. Thus, I do not expect that you address the issue. That said, any help would be much appreciated.

Best regards
Gilberto
===========================
Prof Dr Gilberto Camara
Secretariat Director
GEO - Group on Earth Observations
7 bis, Avenue de La Paix
CH-1211 Geneva - Switzerland
Tel: +41227308480
Web: www.earthobservations.org <http://www.earthobservations.org/>




	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Thu Nov 26 15:40:38 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Thu, 26 Nov 2020 15:40:38 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
In-Reply-To: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
References: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
Message-ID: <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>

Dear Gilberto,

On Thu, 26 Nov 2020, GilbertoCamara wrote:

> Dear R-SIG-GEO and Roger
>
> I am developing an R package (https://github.com/e-sensing/sits 
> <https://github.com/e-sensing/sits>) to analyse satellite image time 
> series (SITS) which is heavily dependent on ?rgdal?.
>
> I would like to report an issue with rgdal in the new macOS BigSur. 
> While I agree with Roger that it is not wise to install a new OS until 
> it is stable, I hope the information below will be useful.
>
> For starters, let me praise Roger, Edzer and all those involved in 
> ?rgdal?. I did some debugging on the source code and was humbled by the 
> effort involved in making the code an operational software many of us 
> rely on. Chapeau bas!
>
> That said, please allow me to report on three issues:
>
> 1. Installation
>
> I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. 
> When installing the binary version of rgdal-1.5-18 (SVN revision 1082) 
> from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is 
> is using GDAL-3.1.1, which is not installed. The actual message is: 
> "Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.
>
> When installing from source, rgdal recognises GDAL-3.2.0, if the 
> Homebrew libraries are on the path. The message changes to: "Loaded GDAL 
> runtime: GDAL 3.2.0, released 2020/10/26."
>
> It is odd that the binary version would report using a runtime that is 
> not there.

On MacOS and Windows, CRAN binary packages are built using static linking, 
for a number of reasons.  One is to limit installation difficulties, 
another to make support easier, as all users of a updated package/R 
version will be using the same set of external software components (of 
course, locales will vary, but most variables are fixed).

>
> 2. Errors in /vsis3 file access
>
> In earlier versions of macOS, rgdal had no problems with accessing files 
> in AWS with commands such as:
>
>> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
>> rgdal::GDALinfo(s3_file)
>
> In BigSur, it produces an error. Debugging the rgdal code, I found the 
> error to arise from line 723 of the ?gdal-bindings.cpp? file. This is 
> one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as 
> follows:

Please first check on running systems with pre-Big Sur and Big Sur that 
the returned lists of drivers match. Crucially, jp2 (Jpeg 2000) needs GDAL 
built against openjpeg. If one of the systems has GDAL built with the 
driver, and the other without, this outcome would be expected. I suspect 
that the Big Sur GDAL (or the CRAN MacOS rgdal binary) has 
missing/defective drivers.

For my Fedora 33 system with GDAL installed from source, I have:

drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
## [1] "JP2OpenJPEG"

There are other JP2* drivers, but they need closed source libraries when 
GDAL itself is built, and cannot be redistributed from CRAN.

>
>  GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
>    papszAllowedDrivers, papszOpenOptions, NULL);
>
> The function call returns a NULL pointer. Since calling gdalinfo 
> externally or using gdalUtils::gdalinfo works, it seems there is a 
> problem with the return parameters which are provided to rgdal by GDAL.
>
> To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer 
> wish to have a go at this issue, I can provide a temporary credential 
> for doing so.

First, we need to be sure that the driver is present, then present and 
working.

>
> 3. Errors in TIFF Decoding
>
> Running devtools::check() produces a strange error on TIFF decoding on a 
> very small file. The error is odd:
>
> "TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."
>
> The call stack is as follows:
>
>   1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
>   2: .local(.Object, ...)
>   3: initialize(value, ...)
>   4: initialize(value, ...)
>   5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>   6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>   7: rgdal::GDALinfo(file, silent = FALSE)
>
> The error appears to be in the same place as the one reported above. 
> However, it is hard to reproduce, because when running on the console, 
> rgdal works.

This feels again like a driver mismatch. Please try with the CRAN MacOS 
binary package, for which 
https://cran.r-project.org/web/checks/check_results_rgdal.html looks 
clean. The examples for rgdal::readGDAL() include reading TIFF files, so 
are run in CRAN daily checks.

I have no access to any MacOS platform, so cannot do more than arm's 
length debug. My clear suspicion is that the GDAL you are using has 
drivers missing/defective. A small JP2 raster could be added to the 
examples to trap driver malfunction.

Best wishes,

Roger

>
>> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
>> rgdal::GDALinfo(ndvi_file, silent = FALSE)
>
> However, given that the place on the ?rgdal? code where the error occurs 
> is the same, it might be worthwhile to look into the RGDAL-GDAL 
> interface in more detail.
>
> I know it?s my responsibility to have moved to macOS BigSur too soon. 
> Thus, I do not expect that you address the issue. That said, any help 
> would be much appreciated.
>
> Best regards
> Gilberto
> ===========================
> Prof Dr Gilberto Camara
> Secretariat Director
> GEO - Group on Earth Observations
> 7 bis, Avenue de La Paix
> CH-1211 Geneva - Switzerland
> Tel: +41227308480
> Web: www.earthobservations.org <http://www.earthobservations.org/>
>
>
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From d@g@r@| @end|ng |rom ugr@e@  Fri Nov 27 12:58:44 2020
From: d@g@r@| @end|ng |rom ugr@e@ (=?UTF-8?Q?David_Garc=c3=ada_=c3=81lvarez?=)
Date: Fri, 27 Nov 2020 12:58:44 +0100
Subject: [R-sig-Geo] Crossing multiple raster to obtain a list of available
 values for each cell - LULCC package
Message-ID: <0af4a73a-fcfa-2916-9d9f-15b1d27fe63d@ugr.es>

Dear list,

I want to cross multiple rasters with the same spatial resolution and 
extent and obtain as a result a summary raster or table that tells me 
which are the values that each cell acquires in the different rasters. 
That is, if I cross three rasters of one cell, with values 0, 1, 0, I 
would like to obtain a result that would tell me that the values of that 
cell are: 0, 1, 0.

I have checked that the crosstab function of the raster packages allows 
to cross multiple rasters (by using a rasterstack). However, I do not 
know how to obtain the result I explained above.

The LULCC package includes different functions to do that. However, in 
my experience, it is not really efficient and does not work well for 
rasters that are not very simple. The basic function of the package 
(Threemapcomparison) did not work for me or took for ages to run.

Therefore, I would like to ask the community for help about: 1. ways to 
do the operation I described above, 2. to effectively work with the 
LULCC package in case I am doing something wrong or my issues with 
processing time / errors are not normal.

Best,
David


From g||berto@c@m@r@@|npe @end|ng |rom gm@||@com  Fri Nov 27 19:44:42 2020
From: g||berto@c@m@r@@|npe @end|ng |rom gm@||@com (Gilberto Camara)
Date: Fri, 27 Nov 2020 19:44:42 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
In-Reply-To: <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>
References: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
 <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>
Message-ID: <F989848B-3D5C-4D28-ABB8-EA8A8C20AD95@gmail.com>

Dear Roger 

Many thanks for your support. I built GDAL from scratch and now it supports the JPEG-2000 driver using the ?openjpeg? library. The reported problems are now solved. 

The whole exercise gave me some lessons on RGDAL and GDAL for users of MacOS BigSur:

1. The usual ways of installing GDAL in macOS (using Homebrew or the Frameworks provided by KingChaos) do not provide support for JPEG-2000. So, one has to install GDAL and RGDAL from source.

2. One has to use Apple?s C/C++ clang compiler version 12.0, following the advice given in Stack Overflow:

https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target <https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target> 

3. For GDAL to compile properly, it is necessary to install first ?pkg-config?, and then the libraries ?proj?, ?geo?, ?tiff?, ?jpeg?, ?openjpeg?, and ?zstd?. 

Thus, if other users of ?gdal? find problems with BigSur, I can volunteer to support them. 

Best regards
Gilberto

===========================
Prof Dr Gilberto Camara
Secretariat Director
GEO - Group on Earth Observations
7 bis, Avenue de La Paix
CH-1211 Geneva - Switzerland
Tel: +41227308480
Web: www.earthobservations.org


> On 26 Nov 2020, at 15:40, Roger Bivand <Roger.Bivand at nhh.no> wrote:
> 
> Dear Gilberto,
> 
> On Thu, 26 Nov 2020, GilbertoCamara wrote:
> 
>> Dear R-SIG-GEO and Roger
>> 
>> I am developing an R package (https://github.com/e-sensing/sits <https://github.com/e-sensing/sits>) to analyse satellite image time series (SITS) which is heavily dependent on ?rgdal?.
>> 
>> I would like to report an issue with rgdal in the new macOS BigSur. While I agree with Roger that it is not wise to install a new OS until it is stable, I hope the information below will be useful.
>> 
>> For starters, let me praise Roger, Edzer and all those involved in ?rgdal?. I did some debugging on the source code and was humbled by the effort involved in making the code an operational software many of us rely on. Chapeau bas!
>> 
>> That said, please allow me to report on three issues:
>> 
>> 1. Installation
>> 
>> I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. When installing the binary version of rgdal-1.5-18 (SVN revision 1082) from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is is using GDAL-3.1.1, which is not installed. The actual message is: "Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.
>> 
>> When installing from source, rgdal recognises GDAL-3.2.0, if the Homebrew libraries are on the path. The message changes to: "Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26."
>> 
>> It is odd that the binary version would report using a runtime that is not there.
> 
> On MacOS and Windows, CRAN binary packages are built using static linking, for a number of reasons.  One is to limit installation difficulties, another to make support easier, as all users of a updated package/R version will be using the same set of external software components (of course, locales will vary, but most variables are fixed).
> 
>> 
>> 2. Errors in /vsis3 file access
>> 
>> In earlier versions of macOS, rgdal had no problems with accessing files in AWS with commands such as:
>> 
>>> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
>>> rgdal::GDALinfo(s3_file)
>> 
>> In BigSur, it produces an error. Debugging the rgdal code, I found the error to arise from line 723 of the ?gdal-bindings.cpp? file. This is one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as follows:
> 
> Please first check on running systems with pre-Big Sur and Big Sur that the returned lists of drivers match. Crucially, jp2 (Jpeg 2000) needs GDAL built against openjpeg. If one of the systems has GDAL built with the driver, and the other without, this outcome would be expected. I suspect that the Big Sur GDAL (or the CRAN MacOS rgdal binary) has missing/defective drivers.
> 
> For my Fedora 33 system with GDAL installed from source, I have:
> 
> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
> ## [1] "JP2OpenJPEG"
> 
> There are other JP2* drivers, but they need closed source libraries when GDAL itself is built, and cannot be redistributed from CRAN.
> 
>> 
>> GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
>>   papszAllowedDrivers, papszOpenOptions, NULL);
>> 
>> The function call returns a NULL pointer. Since calling gdalinfo externally or using gdalUtils::gdalinfo works, it seems there is a problem with the return parameters which are provided to rgdal by GDAL.
>> 
>> To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer wish to have a go at this issue, I can provide a temporary credential for doing so.
> 
> First, we need to be sure that the driver is present, then present and working.
> 
>> 
>> 3. Errors in TIFF Decoding
>> 
>> Running devtools::check() produces a strange error on TIFF decoding on a very small file. The error is odd:
>> 
>> "TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."
>> 
>> The call stack is as follows:
>> 
>>  1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
>>  2: .local(.Object, ...)
>>  3: initialize(value, ...)
>>  4: initialize(value, ...)
>>  5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>  6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>  7: rgdal::GDALinfo(file, silent = FALSE)
>> 
>> The error appears to be in the same place as the one reported above. However, it is hard to reproduce, because when running on the console, rgdal works.
> 
> This feels again like a driver mismatch. Please try with the CRAN MacOS binary package, for which https://cran.r-project.org/web/checks/check_results_rgdal.html looks clean. The examples for rgdal::readGDAL() include reading TIFF files, so are run in CRAN daily checks.
> 
> I have no access to any MacOS platform, so cannot do more than arm's length debug. My clear suspicion is that the GDAL you are using has drivers missing/defective. A small JP2 raster could be added to the examples to trap driver malfunction.
> 
> Best wishes,
> 
> Roger
> 
>> 
>>> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
>>> rgdal::GDALinfo(ndvi_file, silent = FALSE)
>> 
>> However, given that the place on the ?rgdal? code where the error occurs is the same, it might be worthwhile to look into the RGDAL-GDAL interface in more detail.
>> 
>> I know it?s my responsibility to have moved to macOS BigSur too soon. Thus, I do not expect that you address the issue. That said, any help would be much appreciated.
>> 
>> Best regards
>> Gilberto
>> ===========================
>> Prof Dr Gilberto Camara
>> Secretariat Director
>> GEO - Group on Earth Observations
>> 7 bis, Avenue de La Paix
>> CH-1211 Geneva - Switzerland
>> Tel: +41227308480
>> Web: www.earthobservations.org <http://www.earthobservations.org/>
>> 
>> 
>> 
>> 
> 
> -- 
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en


	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Fri Nov 27 22:23:29 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Fri, 27 Nov 2020 22:23:29 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
In-Reply-To: <F989848B-3D5C-4D28-ABB8-EA8A8C20AD95@gmail.com>
References: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
 <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>
 <F989848B-3D5C-4D28-ABB8-EA8A8C20AD95@gmail.com>
Message-ID: <4d6af8a-383c-d1cc-8c17-94635ae3a89@reclus.nhh.no>

Dear Gilberto,

The easiest way to deploy the JP2OpenJPEG driver is to check whether it is 
in the CRAN MacOS rgdal or sf binary packages, as I described before. If 
it is not there, then we need to post an issue or PR on 
https://github.com/R-macos/recipes, I think.

Could any MacOS user with rgdal installed binary from CRAN please run:

drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
rgdal::extSoftVersion()

and the R and rgdal versions? The equivalent for sf is:

drvs <- sf::st_drivers("raster")$name; drvs[grep("JP2", drvs)]
sf::sf_extSoftVersion()

This is just to check whether the recent change to the automated recipes 
system perhaps missed the openjpeg library which is used automatically if 
present.

If it went missing, we should be able to reinstate it (or if never 
available - provide it - the CRAN Windows binary does have this driver), 
then all users of CRAM MacOS binary packages built against GDAL will be 
able to use the driver without having to build from source.

Best wishes,

Roger

On Fri, 27 Nov 2020, Gilberto Camara wrote:

> Dear Roger
>
> Many thanks for your support. I built GDAL from scratch and now it 
> supports the JPEG-2000 driver using the ?openjpeg? library. The reported 
> problems are now solved.
>
> The whole exercise gave me some lessons on RGDAL and GDAL for users of 
> MacOS BigSur:
>
> 1. The usual ways of installing GDAL in macOS (using Homebrew or the
>    Frameworks provided by KingChaos) do not provide support for
>    JPEG-2000. So, one has to install GDAL and RGDAL from source.
>
> 2. One has to use Apple?s C/C++ clang compiler version 12.0, following
>    the advice given in Stack Overflow:
>
> https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target 
> <https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target>
>
> 3. For GDAL to compile properly, it is necessary to install first
>    ?pkg-config?, and then the libraries ?proj?, ?geo?, ?tiff?, ?jpeg?,
>    ?openjpeg?, and ?zstd?.
>
> Thus, if other users of ?gdal? find problems with BigSur, I can 
> volunteer to support them.
>
> Best regards
> Gilberto
>
> ===========================
> Prof Dr Gilberto Camara
> Secretariat Director
> GEO - Group on Earth Observations
> 7 bis, Avenue de La Paix
> CH-1211 Geneva - Switzerland
> Tel: +41227308480
> Web: www.earthobservations.org
>
>
>> On 26 Nov 2020, at 15:40, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>
>> Dear Gilberto,
>>
>> On Thu, 26 Nov 2020, GilbertoCamara wrote:
>>
>>> Dear R-SIG-GEO and Roger
>>>
>>> I am developing an R package (https://github.com/e-sensing/sits <https://github.com/e-sensing/sits>) to analyse satellite image time series (SITS) which is heavily dependent on ?rgdal?.
>>>
>>> I would like to report an issue with rgdal in the new macOS BigSur. While I agree with Roger that it is not wise to install a new OS until it is stable, I hope the information below will be useful.
>>>
>>> For starters, let me praise Roger, Edzer and all those involved in ?rgdal?. I did some debugging on the source code and was humbled by the effort involved in making the code an operational software many of us rely on. Chapeau bas!
>>>
>>> That said, please allow me to report on three issues:
>>>
>>> 1. Installation
>>>
>>> I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. When installing the binary version of rgdal-1.5-18 (SVN revision 1082) from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is is using GDAL-3.1.1, which is not installed. The actual message is: "Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.
>>>
>>> When installing from source, rgdal recognises GDAL-3.2.0, if the Homebrew libraries are on the path. The message changes to: "Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26."
>>>
>>> It is odd that the binary version would report using a runtime that is not there.
>>
>> On MacOS and Windows, CRAN binary packages are built using static linking, for a number of reasons.  One is to limit installation difficulties, another to make support easier, as all users of a updated package/R version will be using the same set of external software components (of course, locales will vary, but most variables are fixed).
>>
>>>
>>> 2. Errors in /vsis3 file access
>>>
>>> In earlier versions of macOS, rgdal had no problems with accessing files in AWS with commands such as:
>>>
>>>> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
>>>> rgdal::GDALinfo(s3_file)
>>>
>>> In BigSur, it produces an error. Debugging the rgdal code, I found the error to arise from line 723 of the ?gdal-bindings.cpp? file. This is one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as follows:
>>
>> Please first check on running systems with pre-Big Sur and Big Sur that the returned lists of drivers match. Crucially, jp2 (Jpeg 2000) needs GDAL built against openjpeg. If one of the systems has GDAL built with the driver, and the other without, this outcome would be expected. I suspect that the Big Sur GDAL (or the CRAN MacOS rgdal binary) has missing/defective drivers.
>>
>> For my Fedora 33 system with GDAL installed from source, I have:
>>
>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>> ## [1] "JP2OpenJPEG"
>>
>> There are other JP2* drivers, but they need closed source libraries when GDAL itself is built, and cannot be redistributed from CRAN.
>>
>>>
>>> GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
>>>   papszAllowedDrivers, papszOpenOptions, NULL);
>>>
>>> The function call returns a NULL pointer. Since calling gdalinfo externally or using gdalUtils::gdalinfo works, it seems there is a problem with the return parameters which are provided to rgdal by GDAL.
>>>
>>> To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer wish to have a go at this issue, I can provide a temporary credential for doing so.
>>
>> First, we need to be sure that the driver is present, then present and working.
>>
>>>
>>> 3. Errors in TIFF Decoding
>>>
>>> Running devtools::check() produces a strange error on TIFF decoding on a very small file. The error is odd:
>>>
>>> "TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."
>>>
>>> The call stack is as follows:
>>>
>>>  1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
>>>  2: .local(.Object, ...)
>>>  3: initialize(value, ...)
>>>  4: initialize(value, ...)
>>>  5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>  6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>  7: rgdal::GDALinfo(file, silent = FALSE)
>>>
>>> The error appears to be in the same place as the one reported above. However, it is hard to reproduce, because when running on the console, rgdal works.
>>
>> This feels again like a driver mismatch. Please try with the CRAN MacOS binary package, for which https://cran.r-project.org/web/checks/check_results_rgdal.html looks clean. The examples for rgdal::readGDAL() include reading TIFF files, so are run in CRAN daily checks.
>>
>> I have no access to any MacOS platform, so cannot do more than arm's length debug. My clear suspicion is that the GDAL you are using has drivers missing/defective. A small JP2 raster could be added to the examples to trap driver malfunction.
>>
>> Best wishes,
>>
>> Roger
>>
>>>
>>>> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
>>>> rgdal::GDALinfo(ndvi_file, silent = FALSE)
>>>
>>> However, given that the place on the ?rgdal? code where the error occurs is the same, it might be worthwhile to look into the RGDAL-GDAL interface in more detail.
>>>
>>> I know it?s my responsibility to have moved to macOS BigSur too soon. Thus, I do not expect that you address the issue. That said, any help would be much appreciated.
>>>
>>> Best regards
>>> Gilberto
>>> ===========================
>>> Prof Dr Gilberto Camara
>>> Secretariat Director
>>> GEO - Group on Earth Observations
>>> 7 bis, Avenue de La Paix
>>> CH-1211 Geneva - Switzerland
>>> Tel: +41227308480
>>> Web: www.earthobservations.org <http://www.earthobservations.org/>
>>>
>>>
>>>
>>>
>>
>> --
>> Roger Bivand
>> Department of Economics, Norwegian School of Economics,
>> Helleveien 30, N-5045 Bergen, Norway.
>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>> https://orcid.org/0000-0003-2392-6140
>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From g||berto@c@m@r@@|npe @end|ng |rom gm@||@com  Sat Nov 28 12:15:45 2020
From: g||berto@c@m@r@@|npe @end|ng |rom gm@||@com (Gilberto Camara)
Date: Sat, 28 Nov 2020 12:15:45 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
In-Reply-To: <4d6af8a-383c-d1cc-8c17-94635ae3a89@reclus.nhh.no>
References: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
 <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>
 <F989848B-3D5C-4D28-ABB8-EA8A8C20AD95@gmail.com>
 <4d6af8a-383c-d1cc-8c17-94635ae3a89@reclus.nhh.no>
Message-ID: <3D97AA10-F0D0-43CB-8D25-328B749110D0@gmail.com>

Dear Roger

Many thanks for your patience and your guidance.

I installed the rgdal binary from CRAN and it gives errors in both commands, as follows:

> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
character(0)

> rgdal::extSoftVersion()

Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?

After installing rgdal from source the first command works:

> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
?JP2OpenJPEG"

but the second does not:

> rgdal::extSoftVersion()

Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?

I am using R version 4.0.3 Patched (2020-11-25 r79505), the latest one available on CRAN. The rgdal version is 1.5-18 (SVN revision 1082). 

More details on rgdal: 

> library(rgdal)
Loading required package: sp
rgdal: version: 1.5-18, (SVN revision 1082)
Geospatial Data Abstraction Library extensions to R successfully loaded
Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26
Path to GDAL shared files: /Users/gilbertocamara/Library/R/4.0/library/sf/gdal
GDAL binary built with GEOS: TRUE 
Loaded PROJ runtime: Rel. 7.1.1, September 1st, 2020, [PJ_VERSION: 711]
Path to PROJ shared files: /Users/gilbertocamara/Library/Application Support/proj:/usr/local/share/proj:/usr/local/share/proj
PROJ CDN enabled: FALSE
Linking to sp version:1.4-4

As for sf, it also has to be installed from source. The binary version of sf also fails to recognise the JP2 driver, while the one built from source does. 

> sf::sf_extSoftVersion() works and gives:
GEOS     GDAL         proj.4    GDAL_with_GEOS     USE_PROJ_H 
"3.8.1"  "3.2.0"      "7.1.1"         "true"         "true? 

So, it appears that the automated recipes system missed the openjpeg library.

Best regards
Gilberto
===========================
Prof Dr Gilberto Camara
Secretariat Director
GEO - Group on Earth Observations
7 bis, Avenue de La Paix
CH-1211 Geneva - Switzerland
Tel: +41227308480
Web: www.earthobservations.org


> On 27 Nov 2020, at 22:23, Roger Bivand <Roger.Bivand at nhh.no> wrote:
> 
> Dear Gilberto,
> 
> The easiest way to deploy the JP2OpenJPEG driver is to check whether it is in the CRAN MacOS rgdal or sf binary packages, as I described before. If it is not there, then we need to post an issue or PR on https://github.com/R-macos/recipes <https://github.com/R-macos/recipes>, I think.
> 
> Could any MacOS user with rgdal installed binary from CRAN please run:
> 
> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
> rgdal::extSoftVersion()
> 
> and the R and rgdal versions? The equivalent for sf is:
> 
> drvs <- sf::st_drivers("raster")$name; drvs[grep("JP2", drvs)]
> sf::sf_extSoftVersion()
> 
> This is just to check whether the recent change to the automated recipes system perhaps missed the openjpeg library which is used automatically if present.
> 
> If it went missing, we should be able to reinstate it (or if never available - provide it - the CRAN Windows binary does have this driver), then all users of CRAM MacOS binary packages built against GDAL will be able to use the driver without having to build from source.
> 
> Best wishes,
> 
> Roger
> 
> On Fri, 27 Nov 2020, Gilberto Camara wrote:
> 
>> Dear Roger
>> 
>> Many thanks for your support. I built GDAL from scratch and now it supports the JPEG-2000 driver using the ?openjpeg? library. The reported problems are now solved.
>> 
>> The whole exercise gave me some lessons on RGDAL and GDAL for users of MacOS BigSur:
>> 
>> 1. The usual ways of installing GDAL in macOS (using Homebrew or the
>>   Frameworks provided by KingChaos) do not provide support for
>>   JPEG-2000. So, one has to install GDAL and RGDAL from source.
>> 
>> 2. One has to use Apple?s C/C++ clang compiler version 12.0, following
>>   the advice given in Stack Overflow:
>> 
>> https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target <https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target>
>> 
>> 3. For GDAL to compile properly, it is necessary to install first
>>   ?pkg-config?, and then the libraries ?proj?, ?geo?, ?tiff?, ?jpeg?,
>>   ?openjpeg?, and ?zstd?.
>> 
>> Thus, if other users of ?gdal? find problems with BigSur, I can volunteer to support them.
>> 
>> Best regards
>> Gilberto
>> 
>> ===========================
>> Prof Dr Gilberto Camara
>> Secretariat Director
>> GEO - Group on Earth Observations
>> 7 bis, Avenue de La Paix
>> CH-1211 Geneva - Switzerland
>> Tel: +41227308480
>> Web: www.earthobservations.org
>> 
>> 
>>> On 26 Nov 2020, at 15:40, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>> 
>>> Dear Gilberto,
>>> 
>>> On Thu, 26 Nov 2020, GilbertoCamara wrote:
>>> 
>>>> Dear R-SIG-GEO and Roger
>>>> 
>>>> I am developing an R package (https://github.com/e-sensing/sits <https://github.com/e-sensing/sits>) to analyse satellite image time series (SITS) which is heavily dependent on ?rgdal?.
>>>> 
>>>> I would like to report an issue with rgdal in the new macOS BigSur. While I agree with Roger that it is not wise to install a new OS until it is stable, I hope the information below will be useful.
>>>> 
>>>> For starters, let me praise Roger, Edzer and all those involved in ?rgdal?. I did some debugging on the source code and was humbled by the effort involved in making the code an operational software many of us rely on. Chapeau bas!
>>>> 
>>>> That said, please allow me to report on three issues:
>>>> 
>>>> 1. Installation
>>>> 
>>>> I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. When installing the binary version of rgdal-1.5-18 (SVN revision 1082) from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is is using GDAL-3.1.1, which is not installed. The actual message is: "Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.
>>>> 
>>>> When installing from source, rgdal recognises GDAL-3.2.0, if the Homebrew libraries are on the path. The message changes to: "Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26."
>>>> 
>>>> It is odd that the binary version would report using a runtime that is not there.
>>> 
>>> On MacOS and Windows, CRAN binary packages are built using static linking, for a number of reasons.  One is to limit installation difficulties, another to make support easier, as all users of a updated package/R version will be using the same set of external software components (of course, locales will vary, but most variables are fixed).
>>> 
>>>> 
>>>> 2. Errors in /vsis3 file access
>>>> 
>>>> In earlier versions of macOS, rgdal had no problems with accessing files in AWS with commands such as:
>>>> 
>>>>> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
>>>>> rgdal::GDALinfo(s3_file)
>>>> 
>>>> In BigSur, it produces an error. Debugging the rgdal code, I found the error to arise from line 723 of the ?gdal-bindings.cpp? file. This is one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as follows:
>>> 
>>> Please first check on running systems with pre-Big Sur and Big Sur that the returned lists of drivers match. Crucially, jp2 (Jpeg 2000) needs GDAL built against openjpeg. If one of the systems has GDAL built with the driver, and the other without, this outcome would be expected. I suspect that the Big Sur GDAL (or the CRAN MacOS rgdal binary) has missing/defective drivers.
>>> 
>>> For my Fedora 33 system with GDAL installed from source, I have:
>>> 
>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>> ## [1] "JP2OpenJPEG"
>>> 
>>> There are other JP2* drivers, but they need closed source libraries when GDAL itself is built, and cannot be redistributed from CRAN.
>>> 
>>>> 
>>>> GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
>>>>  papszAllowedDrivers, papszOpenOptions, NULL);
>>>> 
>>>> The function call returns a NULL pointer. Since calling gdalinfo externally or using gdalUtils::gdalinfo works, it seems there is a problem with the return parameters which are provided to rgdal by GDAL.
>>>> 
>>>> To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer wish to have a go at this issue, I can provide a temporary credential for doing so.
>>> 
>>> First, we need to be sure that the driver is present, then present and working.
>>> 
>>>> 
>>>> 3. Errors in TIFF Decoding
>>>> 
>>>> Running devtools::check() produces a strange error on TIFF decoding on a very small file. The error is odd:
>>>> 
>>>> "TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."
>>>> 
>>>> The call stack is as follows:
>>>> 
>>>> 1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
>>>> 2: .local(.Object, ...)
>>>> 3: initialize(value, ...)
>>>> 4: initialize(value, ...)
>>>> 5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>> 6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>> 7: rgdal::GDALinfo(file, silent = FALSE)
>>>> 
>>>> The error appears to be in the same place as the one reported above. However, it is hard to reproduce, because when running on the console, rgdal works.
>>> 
>>> This feels again like a driver mismatch. Please try with the CRAN MacOS binary package, for which https://cran.r-project.org/web/checks/check_results_rgdal.html looks clean. The examples for rgdal::readGDAL() include reading TIFF files, so are run in CRAN daily checks.
>>> 
>>> I have no access to any MacOS platform, so cannot do more than arm's length debug. My clear suspicion is that the GDAL you are using has drivers missing/defective. A small JP2 raster could be added to the examples to trap driver malfunction.
>>> 
>>> Best wishes,
>>> 
>>> Roger
>>> 
>>>> 
>>>>> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
>>>>> rgdal::GDALinfo(ndvi_file, silent = FALSE)
>>>> 
>>>> However, given that the place on the ?rgdal? code where the error occurs is the same, it might be worthwhile to look into the RGDAL-GDAL interface in more detail.
>>>> 
>>>> I know it?s my responsibility to have moved to macOS BigSur too soon. Thus, I do not expect that you address the issue. That said, any help would be much appreciated.
>>>> 
>>>> Best regards
>>>> Gilberto
>>>> ===========================
>>>> Prof Dr Gilberto Camara
>>>> Secretariat Director
>>>> GEO - Group on Earth Observations
>>>> 7 bis, Avenue de La Paix
>>>> CH-1211 Geneva - Switzerland
>>>> Tel: +41227308480
>>>> Web: www.earthobservations.org <http://www.earthobservations.org/>
>>>> 
>>>> 
>>>> 
>>>> 
>>> 
>>> --
>>> Roger Bivand
>>> Department of Economics, Norwegian School of Economics,
>>> Helleveien 30, N-5045 Bergen, Norway.
>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>>> https://orcid.org/0000-0003-2392-6140
>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>> 
>> 
> 
> -- 
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no <mailto:Roger.Bivand at nhh.no>
> https://orcid.org/0000-0003-2392-6140 <https://orcid.org/0000-0003-2392-6140>
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________ <https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________>
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>

	[[alternative HTML version deleted]]


From btupper @end|ng |rom b|ge|ow@org  Sat Nov 28 15:28:24 2020
From: btupper @end|ng |rom b|ge|ow@org (Ben Tupper)
Date: Sat, 28 Nov 2020 09:28:24 -0500
Subject: [R-sig-Geo] 
 Crossing multiple raster to obtain a list of available
 values for each cell - LULCC package
In-Reply-To: <0af4a73a-fcfa-2916-9d9f-15b1d27fe63d@ugr.es>
References: <0af4a73a-fcfa-2916-9d9f-15b1d27fe63d@ugr.es>
Message-ID: <CALrbzg3xDfLWSSXB=5v2riAvCpNUrHBsHBiSGdp-odYoWJ2HXw@mail.gmail.com>

Hello,

I am unfamiliar with the LULCC package, but what you describe sounds
to me like a simple extraction at one or more cell locations. At
least, that is what I think you describe here...

> That is, if I cross three rasters of one cell, with values 0, 1, 0, I
> would like to obtain a result that would tell me that the values of that
> cell are: 0, 1, 0.

I think that is a simple matter of raster::extract().

###
library(raster)

nr <- 3
nc <- 4
ncell <- nr * nc
m <- matrix(seq_len(ncell), nc = nc, nr = nr)

one <- raster(m)
two <- raster(m * 2)
three <- raster(m * 3)

S <- stack(one, two, three)

extract(S, c(1, 3, ncell))
#      layer.1 layer.2 layer.3
# [1,]       1       2       3
# [2,]       7      14      21
# [3,]      12      24      36
###

Have I understood the issue?

Ben

On Fri, Nov 27, 2020 at 6:59 AM David Garc?a ?lvarez <dagaral at ugr.es> wrote:
>
> Dear list,
>
> I want to cross multiple rasters with the same spatial resolution and
> extent and obtain as a result a summary raster or table that tells me
> which are the values that each cell acquires in the different rasters.
> That is, if I cross three rasters of one cell, with values 0, 1, 0, I
> would like to obtain a result that would tell me that the values of that
> cell are: 0, 1, 0.
>
> I have checked that the crosstab function of the raster packages allows
> to cross multiple rasters (by using a rasterstack). However, I do not
> know how to obtain the result I explained above.
>
> The LULCC package includes different functions to do that. However, in
> my experience, it is not really efficient and does not work well for
> rasters that are not very simple. The basic function of the package
> (Threemapcomparison) did not work for me or took for ages to run.
>
> Therefore, I would like to ask the community for help about: 1. ways to
> do the operation I described above, 2. to effectively work with the
> LULCC package in case I am doing something wrong or my issues with
> processing time / errors are not normal.
>
> Best,
> David
>
> _______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo



-- 
Ben Tupper
Bigelow Laboratory for Ocean Science
East Boothbay, Maine
http://www.bigelow.org/
https://eco.bigelow.org


From Roger@B|v@nd @end|ng |rom nhh@no  Sat Nov 28 18:08:52 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Sat, 28 Nov 2020 18:08:52 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
In-Reply-To: <3D97AA10-F0D0-43CB-8D25-328B749110D0@gmail.com>
References: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
 <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>
 <F989848B-3D5C-4D28-ABB8-EA8A8C20AD95@gmail.com>
 <4d6af8a-383c-d1cc-8c17-94635ae3a89@reclus.nhh.no>
 <3D97AA10-F0D0-43CB-8D25-328B749110D0@gmail.com>
Message-ID: <d67b4649-a5c0-14e6-ca90-2d235b48fb2@reclus.nhh.no>

For completeness, I've put up a skeleton package on 
https://github.com/rsbivand/checkGDALDrivers, with Github Actions to check 
the package on macOS-latest as well as ubuntu-20.04 (latest and devel) and 
Windows-latest. The MacOS platform opens a GTiff file, but does not open a 
JP2 file (using rgdal::GDAL.open()):

https://github.com/rsbivand/checkGDALDrivers/runs/1467699832

I've replicated this on R-hub for MacOS using CRAN and brew (the GDAL from 
brew in that workflow also misses openjpeg it seems):

CRAN: 
https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-64d505798f4b251d1c801ea5dbe6aa33/
brew
https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-5dfcf72469d1effc742710d53d167caf/

On Winbuilder the GA results are replicated (success with both GTiff and 
JP2 on all platforms - there is no guarantee that Debian or Fedora 
packaged GDAL will include this or any other optional driver).

The skeleton package might easily be forked, and could also simply check 
the driver listings rather than actually trying to read a GTiff and a JP2 
file (PRs very welcome).

So we have now a two-threaded way to check for JP2 absence, using this 
package's GA, and through R-hub.

Next step to work out how to get openjpeg into the recipes listings so 
that GDAL there is built using it.

On Sat, 28 Nov 2020, Gilberto Camara wrote:

> Dear Roger
>
> Many thanks for your patience and your guidance.
>
> I installed the rgdal binary from CRAN and it gives errors in both commands, as follows:
>
>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
> character(0)
>

Sorry, should have been:

rgdal::rgdal_extSoftVersion()

Best wishes,

Roger


>> rgdal::extSoftVersion()
>
> Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?
>
> After installing rgdal from source the first command works:
>
>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
> ?JP2OpenJPEG"
>
> but the second does not:
>
>> rgdal::extSoftVersion()
>
> Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?
>
> I am using R version 4.0.3 Patched (2020-11-25 r79505), the latest one available on CRAN. The rgdal version is 1.5-18 (SVN revision 1082).
>
> More details on rgdal:
>
>> library(rgdal)
> Loading required package: sp
> rgdal: version: 1.5-18, (SVN revision 1082)
> Geospatial Data Abstraction Library extensions to R successfully loaded
> Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26
> Path to GDAL shared files: /Users/gilbertocamara/Library/R/4.0/library/sf/gdal
> GDAL binary built with GEOS: TRUE
> Loaded PROJ runtime: Rel. 7.1.1, September 1st, 2020, [PJ_VERSION: 711]
> Path to PROJ shared files: /Users/gilbertocamara/Library/Application Support/proj:/usr/local/share/proj:/usr/local/share/proj
> PROJ CDN enabled: FALSE
> Linking to sp version:1.4-4
>
> As for sf, it also has to be installed from source. The binary version of sf also fails to recognise the JP2 driver, while the one built from source does.
>
>> sf::sf_extSoftVersion() works and gives:
> GEOS     GDAL         proj.4    GDAL_with_GEOS     USE_PROJ_H
> "3.8.1"  "3.2.0"      "7.1.1"         "true"         "true?
>
> So, it appears that the automated recipes system missed the openjpeg library.
>
> Best regards
> Gilberto
> ===========================
> Prof Dr Gilberto Camara
> Secretariat Director
> GEO - Group on Earth Observations
> 7 bis, Avenue de La Paix
> CH-1211 Geneva - Switzerland
> Tel: +41227308480
> Web: www.earthobservations.org
>
>
>> On 27 Nov 2020, at 22:23, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>
>> Dear Gilberto,
>>
>> The easiest way to deploy the JP2OpenJPEG driver is to check whether it is in the CRAN MacOS rgdal or sf binary packages, as I described before. If it is not there, then we need to post an issue or PR on https://github.com/R-macos/recipes <https://github.com/R-macos/recipes>, I think.
>>
>> Could any MacOS user with rgdal installed binary from CRAN please run:
>>
>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>> rgdal::extSoftVersion()
>>
>> and the R and rgdal versions? The equivalent for sf is:
>>
>> drvs <- sf::st_drivers("raster")$name; drvs[grep("JP2", drvs)]
>> sf::sf_extSoftVersion()
>>
>> This is just to check whether the recent change to the automated recipes system perhaps missed the openjpeg library which is used automatically if present.
>>
>> If it went missing, we should be able to reinstate it (or if never available - provide it - the CRAN Windows binary does have this driver), then all users of CRAM MacOS binary packages built against GDAL will be able to use the driver without having to build from source.
>>
>> Best wishes,
>>
>> Roger
>>
>> On Fri, 27 Nov 2020, Gilberto Camara wrote:
>>
>>> Dear Roger
>>>
>>> Many thanks for your support. I built GDAL from scratch and now it supports the JPEG-2000 driver using the ?openjpeg? library. The reported problems are now solved.
>>>
>>> The whole exercise gave me some lessons on RGDAL and GDAL for users of MacOS BigSur:
>>>
>>> 1. The usual ways of installing GDAL in macOS (using Homebrew or the
>>>   Frameworks provided by KingChaos) do not provide support for
>>>   JPEG-2000. So, one has to install GDAL and RGDAL from source.
>>>
>>> 2. One has to use Apple?s C/C++ clang compiler version 12.0, following
>>>   the advice given in Stack Overflow:
>>>
>>> https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target <https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target>
>>>
>>> 3. For GDAL to compile properly, it is necessary to install first
>>>   ?pkg-config?, and then the libraries ?proj?, ?geo?, ?tiff?, ?jpeg?,
>>>   ?openjpeg?, and ?zstd?.
>>>
>>> Thus, if other users of ?gdal? find problems with BigSur, I can volunteer to support them.
>>>
>>> Best regards
>>> Gilberto
>>>
>>> ===========================
>>> Prof Dr Gilberto Camara
>>> Secretariat Director
>>> GEO - Group on Earth Observations
>>> 7 bis, Avenue de La Paix
>>> CH-1211 Geneva - Switzerland
>>> Tel: +41227308480
>>> Web: www.earthobservations.org
>>>
>>>
>>>> On 26 Nov 2020, at 15:40, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>>>
>>>> Dear Gilberto,
>>>>
>>>> On Thu, 26 Nov 2020, GilbertoCamara wrote:
>>>>
>>>>> Dear R-SIG-GEO and Roger
>>>>>
>>>>> I am developing an R package (https://github.com/e-sensing/sits <https://github.com/e-sensing/sits>) to analyse satellite image time series (SITS) which is heavily dependent on ?rgdal?.
>>>>>
>>>>> I would like to report an issue with rgdal in the new macOS BigSur. While I agree with Roger that it is not wise to install a new OS until it is stable, I hope the information below will be useful.
>>>>>
>>>>> For starters, let me praise Roger, Edzer and all those involved in ?rgdal?. I did some debugging on the source code and was humbled by the effort involved in making the code an operational software many of us rely on. Chapeau bas!
>>>>>
>>>>> That said, please allow me to report on three issues:
>>>>>
>>>>> 1. Installation
>>>>>
>>>>> I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. When installing the binary version of rgdal-1.5-18 (SVN revision 1082) from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is is using GDAL-3.1.1, which is not installed. The actual message is: "Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.
>>>>>
>>>>> When installing from source, rgdal recognises GDAL-3.2.0, if the Homebrew libraries are on the path. The message changes to: "Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26."
>>>>>
>>>>> It is odd that the binary version would report using a runtime that is not there.
>>>>
>>>> On MacOS and Windows, CRAN binary packages are built using static linking, for a number of reasons.  One is to limit installation difficulties, another to make support easier, as all users of a updated package/R version will be using the same set of external software components (of course, locales will vary, but most variables are fixed).
>>>>
>>>>>
>>>>> 2. Errors in /vsis3 file access
>>>>>
>>>>> In earlier versions of macOS, rgdal had no problems with accessing files in AWS with commands such as:
>>>>>
>>>>>> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
>>>>>> rgdal::GDALinfo(s3_file)
>>>>>
>>>>> In BigSur, it produces an error. Debugging the rgdal code, I found the error to arise from line 723 of the ?gdal-bindings.cpp? file. This is one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as follows:
>>>>
>>>> Please first check on running systems with pre-Big Sur and Big Sur that the returned lists of drivers match. Crucially, jp2 (Jpeg 2000) needs GDAL built against openjpeg. If one of the systems has GDAL built with the driver, and the other without, this outcome would be expected. I suspect that the Big Sur GDAL (or the CRAN MacOS rgdal binary) has missing/defective drivers.
>>>>
>>>> For my Fedora 33 system with GDAL installed from source, I have:
>>>>
>>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>>> ## [1] "JP2OpenJPEG"
>>>>
>>>> There are other JP2* drivers, but they need closed source libraries when GDAL itself is built, and cannot be redistributed from CRAN.
>>>>
>>>>>
>>>>> GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
>>>>>  papszAllowedDrivers, papszOpenOptions, NULL);
>>>>>
>>>>> The function call returns a NULL pointer. Since calling gdalinfo externally or using gdalUtils::gdalinfo works, it seems there is a problem with the return parameters which are provided to rgdal by GDAL.
>>>>>
>>>>> To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer wish to have a go at this issue, I can provide a temporary credential for doing so.
>>>>
>>>> First, we need to be sure that the driver is present, then present and working.
>>>>
>>>>>
>>>>> 3. Errors in TIFF Decoding
>>>>>
>>>>> Running devtools::check() produces a strange error on TIFF decoding on a very small file. The error is odd:
>>>>>
>>>>> "TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."
>>>>>
>>>>> The call stack is as follows:
>>>>>
>>>>> 1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
>>>>> 2: .local(.Object, ...)
>>>>> 3: initialize(value, ...)
>>>>> 4: initialize(value, ...)
>>>>> 5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>>> 6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>>> 7: rgdal::GDALinfo(file, silent = FALSE)
>>>>>
>>>>> The error appears to be in the same place as the one reported above. However, it is hard to reproduce, because when running on the console, rgdal works.
>>>>
>>>> This feels again like a driver mismatch. Please try with the CRAN MacOS binary package, for which https://cran.r-project.org/web/checks/check_results_rgdal.html looks clean. The examples for rgdal::readGDAL() include reading TIFF files, so are run in CRAN daily checks.
>>>>
>>>> I have no access to any MacOS platform, so cannot do more than arm's length debug. My clear suspicion is that the GDAL you are using has drivers missing/defective. A small JP2 raster could be added to the examples to trap driver malfunction.
>>>>
>>>> Best wishes,
>>>>
>>>> Roger
>>>>
>>>>>
>>>>>> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
>>>>>> rgdal::GDALinfo(ndvi_file, silent = FALSE)
>>>>>
>>>>> However, given that the place on the ?rgdal? code where the error occurs is the same, it might be worthwhile to look into the RGDAL-GDAL interface in more detail.
>>>>>
>>>>> I know it?s my responsibility to have moved to macOS BigSur too soon. Thus, I do not expect that you address the issue. That said, any help would be much appreciated.
>>>>>
>>>>> Best regards
>>>>> Gilberto
>>>>> ===========================
>>>>> Prof Dr Gilberto Camara
>>>>> Secretariat Director
>>>>> GEO - Group on Earth Observations
>>>>> 7 bis, Avenue de La Paix
>>>>> CH-1211 Geneva - Switzerland
>>>>> Tel: +41227308480
>>>>> Web: www.earthobservations.org <http://www.earthobservations.org/>
>>>>>
>>>>>
>>>>>
>>>>>
>>>>
>>>> --
>>>> Roger Bivand
>>>> Department of Economics, Norwegian School of Economics,
>>>> Helleveien 30, N-5045 Bergen, Norway.
>>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>>>> https://orcid.org/0000-0003-2392-6140
>>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>>>
>>>
>>
>> --
>> Roger Bivand
>> Department of Economics, Norwegian School of Economics,
>> Helleveien 30, N-5045 Bergen, Norway.
>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no <mailto:Roger.Bivand at nhh.no>
>> https://orcid.org/0000-0003-2392-6140 <https://orcid.org/0000-0003-2392-6140>
>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________ <https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________>
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

From g||berto@c@m@r@@|npe @end|ng |rom gm@||@com  Sat Nov 28 18:11:09 2020
From: g||berto@c@m@r@@|npe @end|ng |rom gm@||@com (Gilberto Camara)
Date: Sat, 28 Nov 2020 18:11:09 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
In-Reply-To: <d67b4649-a5c0-14e6-ca90-2d235b48fb2@reclus.nhh.no>
References: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
 <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>
 <F989848B-3D5C-4D28-ABB8-EA8A8C20AD95@gmail.com>
 <4d6af8a-383c-d1cc-8c17-94635ae3a89@reclus.nhh.no>
 <3D97AA10-F0D0-43CB-8D25-328B749110D0@gmail.com>
 <d67b4649-a5c0-14e6-ca90-2d235b48fb2@reclus.nhh.no>
Message-ID: <791E6823-3F37-4961-AB16-EE4B2992B6B6@gmail.com>

Dear Roger,

Let me know if I can help you in any way.

Best
Gilberto

> On 28 Nov 2020, at 18:08, Roger Bivand <Roger.Bivand at nhh.no> wrote:
> 
> For completeness, I've put up a skeleton package on https://github.com/rsbivand/checkGDALDrivers <https://github.com/rsbivand/checkGDALDrivers>, with Github Actions to check the package on macOS-latest as well as ubuntu-20.04 (latest and devel) and Windows-latest. The MacOS platform opens a GTiff file, but does not open a JP2 file (using rgdal::GDAL.open()):
> 
> https://github.com/rsbivand/checkGDALDrivers/runs/1467699832 <https://github.com/rsbivand/checkGDALDrivers/runs/1467699832>
> 
> I've replicated this on R-hub for MacOS using CRAN and brew (the GDAL from brew in that workflow also misses openjpeg it seems):
> 
> CRAN: https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-64d505798f4b251d1c801ea5dbe6aa33/ <https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-64d505798f4b251d1c801ea5dbe6aa33/>
> brew
> https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-5dfcf72469d1effc742710d53d167caf/ <https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-5dfcf72469d1effc742710d53d167caf/>
> 
> On Winbuilder the GA results are replicated (success with both GTiff and JP2 on all platforms - there is no guarantee that Debian or Fedora packaged GDAL will include this or any other optional driver).
> 
> The skeleton package might easily be forked, and could also simply check the driver listings rather than actually trying to read a GTiff and a JP2 file (PRs very welcome).
> 
> So we have now a two-threaded way to check for JP2 absence, using this package's GA, and through R-hub.
> 
> Next step to work out how to get openjpeg into the recipes listings so that GDAL there is built using it.
> 
> On Sat, 28 Nov 2020, Gilberto Camara wrote:
> 
>> Dear Roger
>> 
>> Many thanks for your patience and your guidance.
>> 
>> I installed the rgdal binary from CRAN and it gives errors in both commands, as follows:
>> 
>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>> character(0)
>> 
> 
> Sorry, should have been:
> 
> rgdal::rgdal_extSoftVersion()
> 
> Best wishes,
> 
> Roger
> 
> 
>>> rgdal::extSoftVersion()
>> 
>> Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?
>> 
>> After installing rgdal from source the first command works:
>> 
>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>> ?JP2OpenJPEG"
>> 
>> but the second does not:
>> 
>>> rgdal::extSoftVersion()
>> 
>> Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?
>> 
>> I am using R version 4.0.3 Patched (2020-11-25 r79505), the latest one available on CRAN. The rgdal version is 1.5-18 (SVN revision 1082).
>> 
>> More details on rgdal:
>> 
>>> library(rgdal)
>> Loading required package: sp
>> rgdal: version: 1.5-18, (SVN revision 1082)
>> Geospatial Data Abstraction Library extensions to R successfully loaded
>> Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26
>> Path to GDAL shared files: /Users/gilbertocamara/Library/R/4.0/library/sf/gdal
>> GDAL binary built with GEOS: TRUE
>> Loaded PROJ runtime: Rel. 7.1.1, September 1st, 2020, [PJ_VERSION: 711]
>> Path to PROJ shared files: /Users/gilbertocamara/Library/Application Support/proj:/usr/local/share/proj:/usr/local/share/proj
>> PROJ CDN enabled: FALSE
>> Linking to sp version:1.4-4
>> 
>> As for sf, it also has to be installed from source. The binary version of sf also fails to recognise the JP2 driver, while the one built from source does.
>> 
>>> sf::sf_extSoftVersion() works and gives:
>> GEOS     GDAL         proj.4    GDAL_with_GEOS     USE_PROJ_H
>> "3.8.1"  "3.2.0"      "7.1.1"         "true"         "true?
>> 
>> So, it appears that the automated recipes system missed the openjpeg library.
>> 
>> Best regards
>> Gilberto
>> ===========================
>> Prof Dr Gilberto Camara
>> Secretariat Director
>> GEO - Group on Earth Observations
>> 7 bis, Avenue de La Paix
>> CH-1211 Geneva - Switzerland
>> Tel: +41227308480
>> Web: www.earthobservations.org
>> 
>> 
>>> On 27 Nov 2020, at 22:23, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>> 
>>> Dear Gilberto,
>>> 
>>> The easiest way to deploy the JP2OpenJPEG driver is to check whether it is in the CRAN MacOS rgdal or sf binary packages, as I described before. If it is not there, then we need to post an issue or PR on https://github.com/R-macos/recipes <https://github.com/R-macos/recipes> <https://github.com/R-macos/recipes <https://github.com/R-macos/recipes>>, I think.
>>> 
>>> Could any MacOS user with rgdal installed binary from CRAN please run:
>>> 
>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>> rgdal::extSoftVersion()
>>> 
>>> and the R and rgdal versions? The equivalent for sf is:
>>> 
>>> drvs <- sf::st_drivers("raster")$name; drvs[grep("JP2", drvs)]
>>> sf::sf_extSoftVersion()
>>> 
>>> This is just to check whether the recent change to the automated recipes system perhaps missed the openjpeg library which is used automatically if present.
>>> 
>>> If it went missing, we should be able to reinstate it (or if never available - provide it - the CRAN Windows binary does have this driver), then all users of CRAM MacOS binary packages built against GDAL will be able to use the driver without having to build from source.
>>> 
>>> Best wishes,
>>> 
>>> Roger
>>> 
>>> On Fri, 27 Nov 2020, Gilberto Camara wrote:
>>> 
>>>> Dear Roger
>>>> 
>>>> Many thanks for your support. I built GDAL from scratch and now it supports the JPEG-2000 driver using the ?openjpeg? library. The reported problems are now solved.
>>>> 
>>>> The whole exercise gave me some lessons on RGDAL and GDAL for users of MacOS BigSur:
>>>> 
>>>> 1. The usual ways of installing GDAL in macOS (using Homebrew or the
>>>>  Frameworks provided by KingChaos) do not provide support for
>>>>  JPEG-2000. So, one has to install GDAL and RGDAL from source.
>>>> 
>>>> 2. One has to use Apple?s C/C++ clang compiler version 12.0, following
>>>>  the advice given in Stack Overflow:
>>>> 
>>>> https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target <https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target>
>>>> 
>>>> 3. For GDAL to compile properly, it is necessary to install first
>>>>  ?pkg-config?, and then the libraries ?proj?, ?geo?, ?tiff?, ?jpeg?,
>>>>  ?openjpeg?, and ?zstd?.
>>>> 
>>>> Thus, if other users of ?gdal? find problems with BigSur, I can volunteer to support them.
>>>> 
>>>> Best regards
>>>> Gilberto
>>>> 
>>>> ===========================
>>>> Prof Dr Gilberto Camara
>>>> Secretariat Director
>>>> GEO - Group on Earth Observations
>>>> 7 bis, Avenue de La Paix
>>>> CH-1211 Geneva - Switzerland
>>>> Tel: +41227308480
>>>> Web: www.earthobservations.org
>>>> 
>>>> 
>>>>> On 26 Nov 2020, at 15:40, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>>>> 
>>>>> Dear Gilberto,
>>>>> 
>>>>> On Thu, 26 Nov 2020, GilbertoCamara wrote:
>>>>> 
>>>>>> Dear R-SIG-GEO and Roger
>>>>>> 
>>>>>> I am developing an R package (https://github.com/e-sensing/sits <https://github.com/e-sensing/sits>) to analyse satellite image time series (SITS) which is heavily dependent on ?rgdal?.
>>>>>> 
>>>>>> I would like to report an issue with rgdal in the new macOS BigSur. While I agree with Roger that it is not wise to install a new OS until it is stable, I hope the information below will be useful.
>>>>>> 
>>>>>> For starters, let me praise Roger, Edzer and all those involved in ?rgdal?. I did some debugging on the source code and was humbled by the effort involved in making the code an operational software many of us rely on. Chapeau bas!
>>>>>> 
>>>>>> That said, please allow me to report on three issues:
>>>>>> 
>>>>>> 1. Installation
>>>>>> 
>>>>>> I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. When installing the binary version of rgdal-1.5-18 (SVN revision 1082) from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is is using GDAL-3.1.1, which is not installed. The actual message is: "Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.
>>>>>> 
>>>>>> When installing from source, rgdal recognises GDAL-3.2.0, if the Homebrew libraries are on the path. The message changes to: "Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26."
>>>>>> 
>>>>>> It is odd that the binary version would report using a runtime that is not there.
>>>>> 
>>>>> On MacOS and Windows, CRAN binary packages are built using static linking, for a number of reasons.  One is to limit installation difficulties, another to make support easier, as all users of a updated package/R version will be using the same set of external software components (of course, locales will vary, but most variables are fixed).
>>>>> 
>>>>>> 
>>>>>> 2. Errors in /vsis3 file access
>>>>>> 
>>>>>> In earlier versions of macOS, rgdal had no problems with accessing files in AWS with commands such as:
>>>>>> 
>>>>>>> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
>>>>>>> rgdal::GDALinfo(s3_file)
>>>>>> 
>>>>>> In BigSur, it produces an error. Debugging the rgdal code, I found the error to arise from line 723 of the ?gdal-bindings.cpp? file. This is one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as follows:
>>>>> 
>>>>> Please first check on running systems with pre-Big Sur and Big Sur that the returned lists of drivers match. Crucially, jp2 (Jpeg 2000) needs GDAL built against openjpeg. If one of the systems has GDAL built with the driver, and the other without, this outcome would be expected. I suspect that the Big Sur GDAL (or the CRAN MacOS rgdal binary) has missing/defective drivers.
>>>>> 
>>>>> For my Fedora 33 system with GDAL installed from source, I have:
>>>>> 
>>>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>>>> ## [1] "JP2OpenJPEG"
>>>>> 
>>>>> There are other JP2* drivers, but they need closed source libraries when GDAL itself is built, and cannot be redistributed from CRAN.
>>>>> 
>>>>>> 
>>>>>> GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
>>>>>> papszAllowedDrivers, papszOpenOptions, NULL);
>>>>>> 
>>>>>> The function call returns a NULL pointer. Since calling gdalinfo externally or using gdalUtils::gdalinfo works, it seems there is a problem with the return parameters which are provided to rgdal by GDAL.
>>>>>> 
>>>>>> To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer wish to have a go at this issue, I can provide a temporary credential for doing so.
>>>>> 
>>>>> First, we need to be sure that the driver is present, then present and working.
>>>>> 
>>>>>> 
>>>>>> 3. Errors in TIFF Decoding
>>>>>> 
>>>>>> Running devtools::check() produces a strange error on TIFF decoding on a very small file. The error is odd:
>>>>>> 
>>>>>> "TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."
>>>>>> 
>>>>>> The call stack is as follows:
>>>>>> 
>>>>>> 1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
>>>>>> 2: .local(.Object, ...)
>>>>>> 3: initialize(value, ...)
>>>>>> 4: initialize(value, ...)
>>>>>> 5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>>>> 6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>>>> 7: rgdal::GDALinfo(file, silent = FALSE)
>>>>>> 
>>>>>> The error appears to be in the same place as the one reported above. However, it is hard to reproduce, because when running on the console, rgdal works.
>>>>> 
>>>>> This feels again like a driver mismatch. Please try with the CRAN MacOS binary package, for which https://cran.r-project.org/web/checks/check_results_rgdal.html looks clean. The examples for rgdal::readGDAL() include reading TIFF files, so are run in CRAN daily checks.
>>>>> 
>>>>> I have no access to any MacOS platform, so cannot do more than arm's length debug. My clear suspicion is that the GDAL you are using has drivers missing/defective. A small JP2 raster could be added to the examples to trap driver malfunction.
>>>>> 
>>>>> Best wishes,
>>>>> 
>>>>> Roger
>>>>> 
>>>>>> 
>>>>>>> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
>>>>>>> rgdal::GDALinfo(ndvi_file, silent = FALSE)
>>>>>> 
>>>>>> However, given that the place on the ?rgdal? code where the error occurs is the same, it might be worthwhile to look into the RGDAL-GDAL interface in more detail.
>>>>>> 
>>>>>> I know it?s my responsibility to have moved to macOS BigSur too soon. Thus, I do not expect that you address the issue. That said, any help would be much appreciated.
>>>>>> 
>>>>>> Best regards
>>>>>> Gilberto
>>>>>> ===========================
>>>>>> Prof Dr Gilberto Camara
>>>>>> Secretariat Director
>>>>>> GEO - Group on Earth Observations
>>>>>> 7 bis, Avenue de La Paix
>>>>>> CH-1211 Geneva - Switzerland
>>>>>> Tel: +41227308480
>>>>>> Web: www.earthobservations.org <http://www.earthobservations.org/>
>>>>>> 
>>>>>> 
>>>>>> 
>>>>>> 
>>>>> 
>>>>> --
>>>>> Roger Bivand
>>>>> Department of Economics, Norwegian School of Economics,
>>>>> Helleveien 30, N-5045 Bergen, Norway.
>>>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>>>>> https://orcid.org/0000-0003-2392-6140
>>>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>>>> 
>>>> 
>>> 
>>> --
>>> Roger Bivand
>>> Department of Economics, Norwegian School of Economics,
>>> Helleveien 30, N-5045 Bergen, Norway.
>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no <mailto:Roger.Bivand at nhh.no> <mailto:Roger.Bivand at nhh.no <mailto:Roger.Bivand at nhh.no>>
>>> https://orcid.org/0000-0003-2392-6140 <https://orcid.org/0000-0003-2392-6140> <https://orcid.org/0000-0003-2392-6140 <https://orcid.org/0000-0003-2392-6140>>
>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________ <https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________><https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________ <https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________>>
>>> R-sig-Geo mailing list
>>> R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org> <mailto:R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>>
>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo> <https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>>
>> 
> 
> -- 
> Roger Bivand
> Department of Economics, Norwegian School of Economics,
> Helleveien 30, N-5045 Bergen, Norway.
> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
> https://orcid.org/0000-0003-2392-6140
> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________
> R-sig-Geo mailing list
> R-sig-Geo at r-project.org
> https://stat.ethz.ch/mailman/listinfo/r-sig-geo


	[[alternative HTML version deleted]]


From Roger@B|v@nd @end|ng |rom nhh@no  Mon Nov 30 15:46:18 2020
From: Roger@B|v@nd @end|ng |rom nhh@no (Roger Bivand)
Date: Mon, 30 Nov 2020 15:46:18 +0100
Subject: [R-sig-Geo] Reporting an issue with rgdal in macOS BigSur
In-Reply-To: <791E6823-3F37-4961-AB16-EE4B2992B6B6@gmail.com>
References: <60306E46-2B52-478C-A8B4-EA6088D42A3C@inpe.br>
 <8b4e967-1df8-f742-4743-c94344bb4fd3@reclus.nhh.no>
 <F989848B-3D5C-4D28-ABB8-EA8A8C20AD95@gmail.com>
 <4d6af8a-383c-d1cc-8c17-94635ae3a89@reclus.nhh.no>
 <3D97AA10-F0D0-43CB-8D25-328B749110D0@gmail.com>
 <d67b4649-a5c0-14e6-ca90-2d235b48fb2@reclus.nhh.no>
 <791E6823-3F37-4961-AB16-EE4B2992B6B6@gmail.com>
Message-ID: <3a75fc96-1be2-cffa-eca1-d24c31e0e4b7@reclus.nhh.no>

On Sat, 28 Nov 2020, Gilberto Camara wrote:

> Dear Roger,
>
> Let me know if I can help you in any way.

Thanks. We'd need someone with access to a MacOS machine, and an 
understanding of how recipes (https://github.com/R-macos/recipes) work, to 
write recipes for the following libraries and headers, then to check that 
a GDAL built via recipes does incorporate the drivers that are missing 
in CRAN OSX binaries but are present in CRAN Windows binaries:

JP2OpenJPEG, all ODBC, WEBP and XLS

I'm posting this for reference with at least most of the source 
information:

-------------------------------------

JP2OpenJPEG: openjpeg >= 2.1 https://github.com/uclouvain/openjpeg 
https://github.com/uclouvain/openjpeg/archive/v2.3.1.tar.gz The copyright
in this software is being made available under the 2-clauses BSD License.
/* All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
  *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS `AS
IS'
  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
THE
  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR 
PURPOSE
  * ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
BE
  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR 
BUSINESS
  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
THE
  * POSSIBILITY OF SUCH DAMAGE.
  */

Geomedia (ODBC)

MSSQLSpatial (ODBC)

ODBC (ODBC) http://www.unixodbc.org/download.html 
http://www.unixodbc.org/unixODBC-2.3.9.tar.gz 
http://www.unixodbc.org/unixODBC-2.3.9.tar.gz.md5 GNU LESSER GENERAL 
PUBLIC LICENSE Version 2.1. ./configure --enable-gui=no

PGeo (ODBC)

Walk (ODBC)

XLS: libfreexl http://www.gaia-gis.it/gaia-sins/freexl-1.0.6.tar.gz FreeXL
is licensed under the MPL tri-license terms; you are free to choose the 
best-fit license between:

     the MPL 1.1
     the GPL v2.0 or any subsequent version
     the LGPL v2.1 or any subsequent version


WEBP: libwebp https://developers.google.com/speed/webp/download (can be 
used by Rasterlite) 
https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-2.1.0.tar.gz 
Copyright (c) 2010, Google Inc. All rights reserved. Redistribution and 
use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

   * Redistributions of source code must retain the above copyright
     notice, this list of conditions and the following disclaimer.

   * Redistributions in binary form must reproduce the above copyright
     notice, this list of conditions and the following disclaimer in
     the documentation and/or other materials provided with the
     distribution.

   * Neither the name of Google nor the names of its contributors may
     be used to endorse or promote products derived from this software
     without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

----------------------------

Best wishes,

Roger

>
> Best
> Gilberto
>
>> On 28 Nov 2020, at 18:08, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>
>> For completeness, I've put up a skeleton package on https://github.com/rsbivand/checkGDALDrivers <https://github.com/rsbivand/checkGDALDrivers>, with Github Actions to check the package on macOS-latest as well as ubuntu-20.04 (latest and devel) and Windows-latest. The MacOS platform opens a GTiff file, but does not open a JP2 file (using rgdal::GDAL.open()):
>>
>> https://github.com/rsbivand/checkGDALDrivers/runs/1467699832 <https://github.com/rsbivand/checkGDALDrivers/runs/1467699832>
>>
>> I've replicated this on R-hub for MacOS using CRAN and brew (the GDAL from brew in that workflow also misses openjpeg it seems):
>>
>> CRAN: https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-64d505798f4b251d1c801ea5dbe6aa33/ <https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-64d505798f4b251d1c801ea5dbe6aa33/>
>> brew
>> https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-5dfcf72469d1effc742710d53d167caf/ <https://artifacts.r-hub.io/checkGDALDrivers_0.0-1.tar.gz-5dfcf72469d1effc742710d53d167caf/>
>>
>> On Winbuilder the GA results are replicated (success with both GTiff and JP2 on all platforms - there is no guarantee that Debian or Fedora packaged GDAL will include this or any other optional driver).
>>
>> The skeleton package might easily be forked, and could also simply check the driver listings rather than actually trying to read a GTiff and a JP2 file (PRs very welcome).
>>
>> So we have now a two-threaded way to check for JP2 absence, using this package's GA, and through R-hub.
>>
>> Next step to work out how to get openjpeg into the recipes listings so that GDAL there is built using it.
>>
>> On Sat, 28 Nov 2020, Gilberto Camara wrote:
>>
>>> Dear Roger
>>>
>>> Many thanks for your patience and your guidance.
>>>
>>> I installed the rgdal binary from CRAN and it gives errors in both commands, as follows:
>>>
>>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>> character(0)
>>>
>>
>> Sorry, should have been:
>>
>> rgdal::rgdal_extSoftVersion()
>>
>> Best wishes,
>>
>> Roger
>>
>>
>>>> rgdal::extSoftVersion()
>>>
>>> Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?
>>>
>>> After installing rgdal from source the first command works:
>>>
>>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>> ?JP2OpenJPEG"
>>>
>>> but the second does not:
>>>
>>>> rgdal::extSoftVersion()
>>>
>>> Error: 'extSoftVersion' is not an exported object from 'namespace:rgdal?
>>>
>>> I am using R version 4.0.3 Patched (2020-11-25 r79505), the latest one available on CRAN. The rgdal version is 1.5-18 (SVN revision 1082).
>>>
>>> More details on rgdal:
>>>
>>>> library(rgdal)
>>> Loading required package: sp
>>> rgdal: version: 1.5-18, (SVN revision 1082)
>>> Geospatial Data Abstraction Library extensions to R successfully loaded
>>> Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26
>>> Path to GDAL shared files: /Users/gilbertocamara/Library/R/4.0/library/sf/gdal
>>> GDAL binary built with GEOS: TRUE
>>> Loaded PROJ runtime: Rel. 7.1.1, September 1st, 2020, [PJ_VERSION: 711]
>>> Path to PROJ shared files: /Users/gilbertocamara/Library/Application Support/proj:/usr/local/share/proj:/usr/local/share/proj
>>> PROJ CDN enabled: FALSE
>>> Linking to sp version:1.4-4
>>>
>>> As for sf, it also has to be installed from source. The binary version of sf also fails to recognise the JP2 driver, while the one built from source does.
>>>
>>>> sf::sf_extSoftVersion() works and gives:
>>> GEOS     GDAL         proj.4    GDAL_with_GEOS     USE_PROJ_H
>>> "3.8.1"  "3.2.0"      "7.1.1"         "true"         "true?
>>>
>>> So, it appears that the automated recipes system missed the openjpeg library.
>>>
>>> Best regards
>>> Gilberto
>>> ===========================
>>> Prof Dr Gilberto Camara
>>> Secretariat Director
>>> GEO - Group on Earth Observations
>>> 7 bis, Avenue de La Paix
>>> CH-1211 Geneva - Switzerland
>>> Tel: +41227308480
>>> Web: www.earthobservations.org
>>>
>>>
>>>> On 27 Nov 2020, at 22:23, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>>>
>>>> Dear Gilberto,
>>>>
>>>> The easiest way to deploy the JP2OpenJPEG driver is to check whether it is in the CRAN MacOS rgdal or sf binary packages, as I described before. If it is not there, then we need to post an issue or PR on https://github.com/R-macos/recipes <https://github.com/R-macos/recipes> <https://github.com/R-macos/recipes <https://github.com/R-macos/recipes>>, I think.
>>>>
>>>> Could any MacOS user with rgdal installed binary from CRAN please run:
>>>>
>>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>>> rgdal::extSoftVersion()
>>>>
>>>> and the R and rgdal versions? The equivalent for sf is:
>>>>
>>>> drvs <- sf::st_drivers("raster")$name; drvs[grep("JP2", drvs)]
>>>> sf::sf_extSoftVersion()
>>>>
>>>> This is just to check whether the recent change to the automated recipes system perhaps missed the openjpeg library which is used automatically if present.
>>>>
>>>> If it went missing, we should be able to reinstate it (or if never available - provide it - the CRAN Windows binary does have this driver), then all users of CRAM MacOS binary packages built against GDAL will be able to use the driver without having to build from source.
>>>>
>>>> Best wishes,
>>>>
>>>> Roger
>>>>
>>>> On Fri, 27 Nov 2020, Gilberto Camara wrote:
>>>>
>>>>> Dear Roger
>>>>>
>>>>> Many thanks for your support. I built GDAL from scratch and now it supports the JPEG-2000 driver using the ?openjpeg? library. The reported problems are now solved.
>>>>>
>>>>> The whole exercise gave me some lessons on RGDAL and GDAL for users of MacOS BigSur:
>>>>>
>>>>> 1. The usual ways of installing GDAL in macOS (using Homebrew or the
>>>>>  Frameworks provided by KingChaos) do not provide support for
>>>>>  JPEG-2000. So, one has to install GDAL and RGDAL from source.
>>>>>
>>>>> 2. One has to use Apple?s C/C++ clang compiler version 12.0, following
>>>>>  the advice given in Stack Overflow:
>>>>>
>>>>> https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target <https://stackoverflow.com/questions/63972113/big-sur-clang-invalid-version-error-due-to-macosx-deployment-target>
>>>>>
>>>>> 3. For GDAL to compile properly, it is necessary to install first
>>>>>  ?pkg-config?, and then the libraries ?proj?, ?geo?, ?tiff?, ?jpeg?,
>>>>>  ?openjpeg?, and ?zstd?.
>>>>>
>>>>> Thus, if other users of ?gdal? find problems with BigSur, I can volunteer to support them.
>>>>>
>>>>> Best regards
>>>>> Gilberto
>>>>>
>>>>> ===========================
>>>>> Prof Dr Gilberto Camara
>>>>> Secretariat Director
>>>>> GEO - Group on Earth Observations
>>>>> 7 bis, Avenue de La Paix
>>>>> CH-1211 Geneva - Switzerland
>>>>> Tel: +41227308480
>>>>> Web: www.earthobservations.org
>>>>>
>>>>>
>>>>>> On 26 Nov 2020, at 15:40, Roger Bivand <Roger.Bivand at nhh.no> wrote:
>>>>>>
>>>>>> Dear Gilberto,
>>>>>>
>>>>>> On Thu, 26 Nov 2020, GilbertoCamara wrote:
>>>>>>
>>>>>>> Dear R-SIG-GEO and Roger
>>>>>>>
>>>>>>> I am developing an R package (https://github.com/e-sensing/sits <https://github.com/e-sensing/sits>) to analyse satellite image time series (SITS) which is heavily dependent on ?rgdal?.
>>>>>>>
>>>>>>> I would like to report an issue with rgdal in the new macOS BigSur. While I agree with Roger that it is not wise to install a new OS until it is stable, I hope the information below will be useful.
>>>>>>>
>>>>>>> For starters, let me praise Roger, Edzer and all those involved in ?rgdal?. I did some debugging on the source code and was humbled by the effort involved in making the code an operational software many of us rely on. Chapeau bas!
>>>>>>>
>>>>>>> That said, please allow me to report on three issues:
>>>>>>>
>>>>>>> 1. Installation
>>>>>>>
>>>>>>> I have installed GDAL-3.2.0 using Homebrew on BigSur; it works fine. When installing the binary version of rgdal-1.5-18 (SVN revision 1082) from CRAN, recently released by Simon Urbanek, ?rgdal" reports that is is using GDAL-3.1.1, which is not installed. The actual message is: "Loaded GDAL runtime: GDAL 3.1.1, released 2020/06/22?.
>>>>>>>
>>>>>>> When installing from source, rgdal recognises GDAL-3.2.0, if the Homebrew libraries are on the path. The message changes to: "Loaded GDAL runtime: GDAL 3.2.0, released 2020/10/26."
>>>>>>>
>>>>>>> It is odd that the binary version would report using a runtime that is not there.
>>>>>>
>>>>>> On MacOS and Windows, CRAN binary packages are built using static linking, for a number of reasons.  One is to limit installation difficulties, another to make support easier, as all users of a updated package/R version will be using the same set of external software components (of course, locales will vary, but most variables are fixed).
>>>>>>
>>>>>>>
>>>>>>> 2. Errors in /vsis3 file access
>>>>>>>
>>>>>>> In earlier versions of macOS, rgdal had no problems with accessing files in AWS with commands such as:
>>>>>>>
>>>>>>>> s3_file <- "/vsis3/sentinel-s2-l2a/tiles/20/L/KP/2018/8/17/0/R20m/B02.jp2?
>>>>>>>> rgdal::GDALinfo(s3_file)
>>>>>>>
>>>>>>> In BigSur, it produces an error. Debugging the rgdal code, I found the error to arise from line 723 of the ?gdal-bindings.cpp? file. This is one of the places where rgdal calls the GDAL function ?GDALOpenEx?, as follows:
>>>>>>
>>>>>> Please first check on running systems with pre-Big Sur and Big Sur that the returned lists of drivers match. Crucially, jp2 (Jpeg 2000) needs GDAL built against openjpeg. If one of the systems has GDAL built with the driver, and the other without, this outcome would be expected. I suspect that the Big Sur GDAL (or the CRAN MacOS rgdal binary) has missing/defective drivers.
>>>>>>
>>>>>> For my Fedora 33 system with GDAL installed from source, I have:
>>>>>>
>>>>>> drvs <- rgdal::gdalDrivers()$name; drvs[grep("JP2", drvs)]
>>>>>> ## [1] "JP2OpenJPEG"
>>>>>>
>>>>>> There are other JP2* drivers, but they need closed source libraries when GDAL itself is built, and cannot be redistributed from CRAN.
>>>>>>
>>>>>>>
>>>>>>> GDALDataset *pDataset = (GDALDataset *) GDALOpenEx(fn, RWFlag,
>>>>>>> papszAllowedDrivers, papszOpenOptions, NULL);
>>>>>>>
>>>>>>> The function call returns a NULL pointer. Since calling gdalinfo externally or using gdalUtils::gdalinfo works, it seems there is a problem with the return parameters which are provided to rgdal by GDAL.
>>>>>>>
>>>>>>> To reproduce the issue, one needs AWS credentials. If Roger and/or Edzer wish to have a go at this issue, I can provide a temporary credential for doing so.
>>>>>>
>>>>>> First, we need to be sure that the driver is present, then present and working.
>>>>>>
>>>>>>>
>>>>>>> 3. Errors in TIFF Decoding
>>>>>>>
>>>>>>> Running devtools::check() produces a strange error on TIFF decoding on a very small file. The error is odd:
>>>>>>>
>>>>>>> "TIFFReadDirectory: Warning, Unknown field with tag 42112 (0xa480) encountered."
>>>>>>>
>>>>>>> The call stack is as follows:
>>>>>>>
>>>>>>> 1: .Call("RGDAL_OpenDataset", .normalize_if_path(filename, mustWork = NA),     TRUE, silent, allowedDrivers, options, PACKAGE = "rgdal")
>>>>>>> 2: .local(.Object, ...)
>>>>>>> 3: initialize(value, ...)
>>>>>>> 4: initialize(value, ...)
>>>>>>> 5: new("GDALReadOnlyDataset", filename, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>>>>> 6: GDAL.open(fname, silent = silent, allowedDrivers = allowedDrivers,     options = options)
>>>>>>> 7: rgdal::GDALinfo(file, silent = FALSE)
>>>>>>>
>>>>>>> The error appears to be in the same place as the one reported above. However, it is hard to reproduce, because when running on the console, rgdal works.
>>>>>>
>>>>>> This feels again like a driver mismatch. Please try with the CRAN MacOS binary package, for which https://cran.r-project.org/web/checks/check_results_rgdal.html looks clean. The examples for rgdal::readGDAL() include reading TIFF files, so are run in CRAN daily checks.
>>>>>>
>>>>>> I have no access to any MacOS platform, so cannot do more than arm's length debug. My clear suspicion is that the GDAL you are using has drivers missing/defective. A small JP2 raster could be added to the examples to trap driver malfunction.
>>>>>>
>>>>>> Best wishes,
>>>>>>
>>>>>> Roger
>>>>>>
>>>>>>>
>>>>>>>> ndvi_file <- c(system.file("extdata/raster/mod13q1/sinop-ndvi-2014.tif", package = "sits?))
>>>>>>>> rgdal::GDALinfo(ndvi_file, silent = FALSE)
>>>>>>>
>>>>>>> However, given that the place on the ?rgdal? code where the error occurs is the same, it might be worthwhile to look into the RGDAL-GDAL interface in more detail.
>>>>>>>
>>>>>>> I know it?s my responsibility to have moved to macOS BigSur too soon. Thus, I do not expect that you address the issue. That said, any help would be much appreciated.
>>>>>>>
>>>>>>> Best regards
>>>>>>> Gilberto
>>>>>>> ===========================
>>>>>>> Prof Dr Gilberto Camara
>>>>>>> Secretariat Director
>>>>>>> GEO - Group on Earth Observations
>>>>>>> 7 bis, Avenue de La Paix
>>>>>>> CH-1211 Geneva - Switzerland
>>>>>>> Tel: +41227308480
>>>>>>> Web: www.earthobservations.org <http://www.earthobservations.org/>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>
>>>>>> --
>>>>>> Roger Bivand
>>>>>> Department of Economics, Norwegian School of Economics,
>>>>>> Helleveien 30, N-5045 Bergen, Norway.
>>>>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>>>>>> https://orcid.org/0000-0003-2392-6140
>>>>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en
>>>>>
>>>>>
>>>>
>>>> --
>>>> Roger Bivand
>>>> Department of Economics, Norwegian School of Economics,
>>>> Helleveien 30, N-5045 Bergen, Norway.
>>>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no <mailto:Roger.Bivand at nhh.no> <mailto:Roger.Bivand at nhh.no <mailto:Roger.Bivand at nhh.no>>
>>>> https://orcid.org/0000-0003-2392-6140 <https://orcid.org/0000-0003-2392-6140> <https://orcid.org/0000-0003-2392-6140 <https://orcid.org/0000-0003-2392-6140>>
>>>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________ <https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________><https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________ <https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________>>
>>>> R-sig-Geo mailing list
>>>> R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org> <mailto:R-sig-Geo at r-project.org <mailto:R-sig-Geo at r-project.org>>
>>>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo> <https://stat.ethz.ch/mailman/listinfo/r-sig-geo <https://stat.ethz.ch/mailman/listinfo/r-sig-geo>>
>>>
>>
>> --
>> Roger Bivand
>> Department of Economics, Norwegian School of Economics,
>> Helleveien 30, N-5045 Bergen, Norway.
>> voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
>> https://orcid.org/0000-0003-2392-6140
>> https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en_______________________________________________
>> R-sig-Geo mailing list
>> R-sig-Geo at r-project.org
>> https://stat.ethz.ch/mailman/listinfo/r-sig-geo
>
>

-- 
Roger Bivand
Department of Economics, Norwegian School of Economics,
Helleveien 30, N-5045 Bergen, Norway.
voice: +47 55 95 93 55; e-mail: Roger.Bivand at nhh.no
https://orcid.org/0000-0003-2392-6140
https://scholar.google.no/citations?user=AWeghB0AAAAJ&hl=en

